"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[15],[,,,,function(e,t,n){n.d(t,"d",(function(){return I})),n.d(t,"e",(function(){return w})),n.d(t,"k",(function(){return T})),n.d(t,"n",(function(){return O})),n.d(t,"v",(function(){return M})),n.d(t,"o",(function(){return C})),n.d(t,"u",(function(){return R})),n.d(t,"q",(function(){return N})),n.d(t,"p",(function(){return D})),n.d(t,"t",(function(){return K})),n.d(t,"s",(function(){return H})),n.d(t,"r",(function(){return $})),n.d(t,"j",(function(){return q})),n.d(t,"l",(function(){return z})),n.d(t,"g",(function(){return J})),n.d(t,"m",(function(){return Y})),n.d(t,"c",(function(){return W})),n.d(t,"b",(function(){return Z})),n.d(t,"i",(function(){return Q})),n.d(t,"f",(function(){return X})),n.d(t,"h",(function(){return ee})),n.d(t,"a",(function(){return te}));var r,a,i=n(9),s=n.n(i),o=(n(31),n(25)),u=n(11),d=n(106),c=n(213),l=n(72),p=n(34),h=u.f.replace("@",""),f=u.j.replace("@",""),m=u.d.replace("@",""),v=[236,237,238,239],g=248,_=249,E=["0","1","2","3","4","5","6","7","8","9","-",".","�","�","�","�"],b=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],y="",S=1,I={sentinel:"DROP_ATTR"},w=l.c.create(null,"g.us"),T=l.c.create(null,u.i),A=(l.c.create("status","broadcast"),{}),O=class{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:A,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.tag=e,this.attrs=t,this.content=n}toString(){var e="<"+this.tag;e+=(function(e){for(var t=Object.keys(e),n="",r=0;r<t.length;r++){var a=t[r];n+=` ${a}="${e[a].toString()}"`}return n})(this.attrs);var t=this.content;return Array.isArray(t)?e+=`>${t.map(String).join("")}</${this.tag}>`:e+=t?`>${(function(e){return 0===e.length?"\x3c!-- empty binary --\x3e":e.length<50?(0,p.c)(e):`\x3c!-- ${e.length} bytes --\x3e`})(t)}</${this.tag}>`:" />",e}},M=function(e,t,n){var r=null;if(t&&null!=t.children)throw new Error('Children should not be passed via props (see eslint check "react/no-children-props")');if(Array.isArray(n))r=n.filter(Boolean);else if("string"==typeof n)r=o.a.build(n).readByteArray();else if(n instanceof ArrayBuffer)r=new Uint8Array(n);else if(n instanceof Uint8Array)r=n;else{for(var a=[],i=2;i<arguments.length;i++){var s=arguments[i];s&&a.push(s)}r=a}Array.isArray(r)&&0===r.length&&(r=null);var u={};if(t){var d=t;Object.keys(d).forEach(t=>{var n=d[t];if(null==n)throw new Error(`Attr ${t} in <${e}> is null`);n!==I&&(u[t]=n)})}return new O(e,u,r)};function C(e){return e instanceof l.c?e.toString():e}function R(e){var t=e.content;return Array.isArray(t)?t=t.map(R):"string"==typeof t&&(t=o.a.build(t).readByteArray()),new O(e.tag,e.attrs||A,t)}function N(e){var t=e instanceof O?e:R(e),n=new o.a;(function e(t,n){if(null==t)n.writeUint8(0);else if(t instanceof O)(function t(n,r){if(void 0===n.tag)return r.writeUint8(g),void r.writeUint8(0);var a=1;n.attrs&&(a+=2*Object.keys(n.attrs).length),n.content&&a++,a<256?(r.writeUint8(g),r.writeUint8(a)):a<65536&&(r.writeUint8(_),r.writeUint16(a)),e(n.tag,r),n.attrs&&Object.keys(n.attrs).forEach(t=>{P(t,r),e(n.attrs[t],r)});var i=n.content;if(Array.isArray(i)){i.length<256?(r.writeUint8(g),r.writeUint8(i.length)):i.length<65536&&(r.writeUint8(_),r.writeUint16(i.length));for(var s=0;s<i.length;s++)t(i[s],r)}else i&&e(i,r)})(t,n);else if(t instanceof l.c)(function(t,n){var r=t.getInnerJid();if(r.type===l.b.JID_U){var a=r.user,i=r.device,s=r.domainType;n.writeUint8(247),n.writeUint8(s),n.writeUint8(i),e(a,n)}else if(r.type===l.b.JID_FB){var o=r.user,u=r.device;n.writeUint8(246),e(o,n),n.writeUint16(u),e(f,n)}else{var d=r.user,c=r.server;n.writeUint8(250),null!=d?e(d,n):n.writeUint8(0),e(c,n)}})(t,n);else if("string"==typeof t)P(t,n);else{if(!(t instanceof Uint8Array))throw new Error("Invalid payload type "+typeof t);(function(e,t){L(e.length,t),t.writeByteArray(e)})(t,n)}})(t,n);var r=n.readByteArray(),a=new Uint8Array(1+r.length);return a[0]=0,a.set(r,1),a}function k(e){for(var t=new Map,n=0;n<e.length;n++)t.set(e[n],n);return t}function P(e,t){if(""===e)return t.writeUint8(252),void t.writeUint8(0);null==r&&(r=k(c.c));var n=r.get(e);if(null==n){if(null==a){a=[];for(var i=0;i<c.a.length;++i)a.push(k(c.a[i]))}for(var s=0;s<a.length;++s){var u=a[s].get(e);if(null!=u)return t.writeUint8(v[s]),void t.writeUint8(u)}var d=(0,o.c)(e);if(d<128){if(!/[^0-9.-]+?/.exec(e))return void G(e,255,t);if(!/[^0-9A-F]+?/.exec(e))return void G(e,251,t)}L(d,t),t.writeString(e)}else t.writeUint8(n+1)}function G(e,t,n){var r=e.length%2==1;n.writeUint8(t);var a=Math.ceil(e.length/2);r&&(a|=128),n.writeUint8(a);for(var i=0,s=0;s<e.length;s++){var o=e.charCodeAt(s),u=null;if(48<=o&&o<=57?u=o-48:255===t?45===o?u=10:46===o&&(u=11):251===t&&65<=o&&o<=70&&(u=o-55),null==u)throw new Error("Cannot nibble encode "+o);s%2==0?(i=u<<4,s===e.length-1&&(i|=15,n.writeUint8(i))):(i|=u,n.writeUint8(i))}}function L(e,t){if(e<256)t.writeUint8(252),t.writeUint8(e);else if(e<1048576)t.writeUint8(253),t.writeUint8(e>>>16&255),t.writeUint8(e>>>8&255),t.writeUint8(255&e);else{if(!(e<4294967296))throw new Error(`Binary with length ${e} is too big for WAP protocol`);t.writeUint8(254),t.writeUint32(e)}}function D(e,t){var n=new o.a(e);return 2&n.readUint8()?(__LOG__(2)`Decoding compressed stanza`,t(n.readByteArray()).then(e=>F(new o.a(e)))):Promise.resolve(F(n))}function x(e,t){var n,r,a,i=e.readUint8();if(0===i)return null;if(i===g)return U(e,e.readUint8());if(i===_)return U(e,e.readUint16());if(252===i){var s=e.readUint8();return j(e,s,t)}if(253===i){var o=e.readUint8(),u=e.readUint8(),d=e.readUint8();return j(e,((15&o)<<16)+(u<<8)+d,t)}if(254===i){var p=e.readUint32();return j(e,p,t)}if(250===i)return r=(function(e){var t=x(e,!0);if(null!=t&&"string"!=typeof t)throw new Error(`Decode string got invalid value ${String(t)}, string expected`);return t})(n=e),a=B(n),l.c.create(r,a);if(246===i)return(function(e){var t=B(e),n=e.readUint16();return B(e),l.c.createFbJid(t,n)})(e);if(247===i)return(function(e){var t=null,n=e.readUint8();if(0===n)t=l.a.WHATSAPP;else{if(1!==n)throw new Error("decodeJidU - Invalid domain type encoding "+n);t=l.a.LID}var r=e.readUint8(),a=B(e);return l.c.createJidU(a,t,r)})(e);if(255===i){var h=e.readUint8();return V(e,E,h>>>7,127&h)}if(251===i){var f=e.readUint8();return V(e,b,f>>>7,127&f)}if(i<=0||i>=240)throw new Error("Unable to decode WAP buffer");if(i>=236&&i<=239){var m=i-236,v=c.a[m];if(void 0===v)throw new Error("Missing WAP dictionary "+m);var y=e.readUint8(),S=v[y];if(void 0===S)throw new Error(`Invalid value index ${y} in dict ${m}`);return S}var I=c.c[i-1];if(void 0===I)throw new Error("Undefined token with index "+i);return I}function U(e,t){for(var n=[],r=0;r<t;r++)n.push(F(e));return n}function F(e){var t,n=e.readUint8();if(n===g)t=e.readUint8();else{if(n!==_)throw new Error(`Failed to decode node since type byte ${String(n)} is invalid`);t=e.readUint16()}var r=void 0,a=null;if(0===t)throw new Error("Failed to decode node, list cannot be empty");var i=B(e);for(t-=1;t>1;){r||(r={});var s=B(e),o=x(e,!0);r[s]=o,t-=2}return 1===t&&(a=x(e,!1))instanceof l.c&&(a=String(a)),new O(i,r,a)}function B(e){var t=x(e,!0);if("string"!=typeof t)throw new Error(`Decode string got invalid value ${String(t)}, string expected`);return t}function j(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return n?e.readString(t):e.readByteArray(t)}function V(e,t,n,r){for(var a=new Array(2*r-n),i=0;i<a.length-1;i+=2){var s=e.readUint8();a[i]=t[s>>>4],a[i+1]=t[15&s]}if(n){var o=e.readUint8();a[a.length-1]=t[o>>>4]}return a.join("")}function K(){if(!y){var e=new Uint16Array(2);self.crypto.getRandomValues(e),y=`${String(e[0])}.${String(e[1])}-`}return`${y}${S++}`}function H(e){switch(e.type){case"group":return e.groupJid;case"status":return u.h;case"device":return e.deviceJid;default:return e.type,e.broadcastJid}}function $(e){switch(e.type){case"group":case"status":case"broadcast":return e.author;default:return e.type,null}}function q(e){return"status"===e.type||"group"===e.type||"broadcast"===e.type?J(e.author):I}function z(e){return J(H(e))}function J(e){var t=e.split("@"),n=s()(t,2),r=n[0],a=n[1],i=null;if((a===f||a===h||a===m)&&-1!==r.indexOf(":")){var o=r.split(":"),u=s()(o,2);r=u[0],i=u[1],i=parseInt(i,10)}if(a===h)return l.c.createFbJid(r,i);var d=a===m?l.a.LID:l.a.WHATSAPP;return null!=i&&0!==i?l.c.createJidU(r,d,i):l.c.create(r,a)}function Y(e){return J(e)}function W(e){return J(e)}function Z(e){return e}function Q(e){return null==e?I:e}function X(e){return e.toString()}function ee(e){return(0,d.c)(e)}function te(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,n=e,r=new Uint8Array(t),a=t-1;a>=0;a--)r[a]=255&n,n>>>=8;return r}},,,,function(e,t,n){n.d(t,"d",(function(){return l})),n.d(t,"c",(function(){return p})),n.d(t,"e",(function(){return h})),n.d(t,"f",(function(){return f})),n.d(t,"g",(function(){return m})),n.d(t,"b",(function(){return v})),n.d(t,"a",(function(){return g}));var r=n(5),a=n(71),i=n(105),s=n(12),o=n(30),u=null,d=null;function c(e){if(u)return u;throw new Error(`Storage::${e} called before startStorage`)}function l(e,t){var n=c("onMsgProcessingThread");return n.AS.enqueue(()=>n.AT.enqueue(e,t))}function p(e,t,n){return c(e).runThenUpdate(t,e=>n(e,(0,o.b)(),s.a))}function h(e,t){return t(c(e).AQ)}function f(e,t){return t(c(e).AQ.table)}function m(e){if(d)return d;var t=new class{constructor(e){this.AR=new a.a,this.AS=new a.a(5e3),this.AT=new a.b(5e3),this.AQ=e}runThenUpdate(e,t){return this.AR.enqueueHandlers(e(this.AQ),t)}}(new e);return u=t,d=t.AQ.verifyRegisteredUser().then(t=>{if(!t)return v().then(()=>(d=null,m(e)))})}function v(){var e=u;return e?(u=null,(0,r.i)((0,r.c)([e.AQ.table.stores.delete(),(0,i.getChunkTable)().stores.delete()]))):Promise.resolve()}function g(){var e=u;e&&(u=null,e.AQ.table.close(),(0,i.getChunkTable)().close())}},,,,function(e,t,n){n.d(t,"c",(function(){return o})),n.d(t,"e",(function(){return u})),n.d(t,"f",(function(){return d})),n.d(t,"b",(function(){return c})),n.d(t,"g",(function(){return l})),n.d(t,"d",(function(){return p})),n.d(t,"h",(function(){return h})),n.d(t,"i",(function(){return f})),n.d(t,"j",(function(){return m})),n.d(t,"a",(function(){return v}));var r=null,a=!1,i=null,s=null,o=(e,t,n)=>{if(!r)throw new Error("fireAndForget called before setApi!");r.fireAndForget(e,t,n)},u=(e,t,n)=>{if(!r)throw new Error("sendAndReceive called before setApi!");return r.sendAndReceive(e,t,n)};function d(e){r=e}function c(){p()||null==s||s()}function l(e){s=e}function p(){return a}function h(e){a=e}function f(e){i=e}function m(){if(null==i)throw new Error("Called shutdown without having a shutdown function assigned");i()}var v={fireAndForget:o,sendAndReceive:u}},,,,,function(e,t,n){n.d(t,"s",(function(){return oe.e})),n.d(t,"w",(function(){return ue})),n.d(t,"L",(function(){return de})),n.d(t,"p",(function(){return ce})),n.d(t,"Ab",(function(){return le})),n.d(t,"yb",(function(){return he})),n.d(t,"wb",(function(){return fe})),n.d(t,"zb",(function(){return me})),n.d(t,"i",(function(){return ge})),n.d(t,"gd",(function(){return _e})),n.d(t,"jd",(function(){return Ee})),n.d(t,"fd",(function(){return ye})),n.d(t,"B",(function(){return Se})),n.d(t,"C",(function(){return Ie})),n.d(t,"bb",(function(){return we})),n.d(t,"K",(function(){return Te})),n.d(t,"H",(function(){return Ae})),n.d(t,"Jb",(function(){return Oe})),n.d(t,"Kc",(function(){return Me})),n.d(t,"Kb",(function(){return Ce})),n.d(t,"Hb",(function(){return Re})),n.d(t,"Xb",(function(){return Ne})),n.d(t,"Q",(function(){return ke})),n.d(t,"O",(function(){return Pe})),n.d(t,"Z",(function(){return Ge})),n.d(t,"mc",(function(){return Le})),n.d(t,"Wb",(function(){return De})),n.d(t,"sb",(function(){return xe})),n.d(t,"rb",(function(){return Ue})),n.d(t,"F",(function(){return Fe})),n.d(t,"y",(function(){return Be})),n.d(t,"A",(function(){return je})),n.d(t,"z",(function(){return Ve})),n.d(t,"qc",(function(){return Ke})),n.d(t,"rc",(function(){return He})),n.d(t,"b",(function(){return $e})),n.d(t,"ec",(function(){return qe})),n.d(t,"cb",(function(){return ze})),n.d(t,"U",(function(){return Je})),n.d(t,"Vb",(function(){return Ye})),n.d(t,"sc",(function(){return We})),n.d(t,"Ib",(function(){return Ze})),n.d(t,"dc",(function(){return Qe})),n.d(t,"Gc",(function(){return Xe})),n.d(t,"Lc",(function(){return et})),n.d(t,"T",(function(){return tt})),n.d(t,"S",(function(){return nt})),n.d(t,"v",(function(){return rt})),n.d(t,"E",(function(){return at})),n.d(t,"P",(function(){return it})),n.d(t,"D",(function(){return st})),n.d(t,"c",(function(){return ot})),n.d(t,"Zc",(function(){return ut})),n.d(t,"Wc",(function(){return dt})),n.d(t,"gc",(function(){return ct})),n.d(t,"Xc",(function(){return lt})),n.d(t,"Yc",(function(){return pt})),n.d(t,"d",(function(){return ht})),n.d(t,"Ac",(function(){return ft})),n.d(t,"Fc",(function(){return mt})),n.d(t,"Bc",(function(){return vt})),n.d(t,"Ob",(function(){return _t})),n.d(t,"oc",(function(){return Et})),n.d(t,"vc",(function(){return bt})),n.d(t,"Nb",(function(){return yt})),n.d(t,"t",(function(){return St})),n.d(t,"wc",(function(){return It})),n.d(t,"yc",(function(){return wt})),n.d(t,"xc",(function(){return Tt})),n.d(t,"J",(function(){return At})),n.d(t,"db",(function(){return Ot})),n.d(t,"ed",(function(){return Mt})),n.d(t,"Mc",(function(){return Ct})),n.d(t,"V",(function(){return Rt})),n.d(t,"R",(function(){return Nt})),n.d(t,"zc",(function(){return kt})),n.d(t,"cc",(function(){return Pt})),n.d(t,"Rb",(function(){return Gt})),n.d(t,"Sc",(function(){return Lt})),n.d(t,"m",(function(){return Dt})),n.d(t,"o",(function(){return xt})),n.d(t,"j",(function(){return Ut})),n.d(t,"ub",(function(){return Ft})),n.d(t,"Eb",(function(){return Bt})),n.d(t,"lb",(function(){return jt})),n.d(t,"mb",(function(){return Vt})),n.d(t,"x",(function(){return Kt})),n.d(t,"vb",(function(){return Ht})),n.d(t,"Cb",(function(){return $t})),n.d(t,"Qc",(function(){return qt})),n.d(t,"kb",(function(){return zt})),n.d(t,"Mb",(function(){return Jt})),n.d(t,"bd",(function(){return Yt})),n.d(t,"Nc",(function(){return Wt})),n.d(t,"k",(function(){return Zt})),n.d(t,"pb",(function(){return Qt})),n.d(t,"N",(function(){return Xt})),n.d(t,"W",(function(){return en})),n.d(t,"pc",(function(){return tn})),n.d(t,"Cc",(function(){return nn})),n.d(t,"Yb",(function(){return rn})),n.d(t,"fc",(function(){return an})),n.d(t,"jc",(function(){return sn})),n.d(t,"ob",(function(){return on})),n.d(t,"q",(function(){return un})),n.d(t,"Rc",(function(){return dn})),n.d(t,"ad",(function(){return cn})),n.d(t,"eb",(function(){return ln})),n.d(t,"qb",(function(){return pn})),n.d(t,"h",(function(){return hn})),n.d(t,"u",(function(){return fn})),n.d(t,"l",(function(){return mn})),n.d(t,"f",(function(){return vn})),n.d(t,"nc",(function(){return gn})),n.d(t,"hc",(function(){return _n})),n.d(t,"dd",(function(){return En})),n.d(t,"Pb",(function(){return bn})),n.d(t,"Qb",(function(){return yn})),n.d(t,"Sb",(function(){return Sn})),n.d(t,"Oc",(function(){return In})),n.d(t,"Pc",(function(){return wn})),n.d(t,"Fb",(function(){return On})),n.d(t,"fb",(function(){return Mn})),n.d(t,"xb",(function(){return Cn})),n.d(t,"Db",(function(){return Rn})),n.d(t,"ib",(function(){return Nn})),n.d(t,"tb",(function(){return kn})),n.d(t,"hb",(function(){return Pn})),n.d(t,"Bb",(function(){return Gn})),n.d(t,"gb",(function(){return Ln})),n.d(t,"jb",(function(){return Dn})),n.d(t,"uc",(function(){return xn})),n.d(t,"Ec",(function(){return Un})),n.d(t,"Tb",(function(){return Fn})),n.d(t,"nb",(function(){return Bn})),n.d(t,"hd",(function(){return jn})),n.d(t,"id",(function(){return Vn})),n.d(t,"lc",(function(){return qn})),n.d(t,"kc",(function(){return zn})),n.d(t,"kd",(function(){return Jn})),n.d(t,"Zb",(function(){return Wn})),n.d(t,"Ub",(function(){return Zn})),n.d(t,"Jc",(function(){return Qn})),n.d(t,"X",(function(){return Xn})),n.d(t,"M",(function(){return er})),n.d(t,"r",(function(){return tr})),n.d(t,"Y",(function(){return nr})),n.d(t,"Ic",(function(){return rr})),n.d(t,"e",(function(){return ar})),n.d(t,"Lb",(function(){return ir})),n.d(t,"tc",(function(){return sr})),n.d(t,"ic",(function(){return or})),n.d(t,"bc",(function(){return ur})),n.d(t,"ab",(function(){return dr})),n.d(t,"Dc",(function(){return cr})),n.d(t,"Uc",(function(){return lr})),n.d(t,"Tc",(function(){return pr})),n.d(t,"G",(function(){return hr})),n.d(t,"Gb",(function(){return fr})),n.d(t,"a",(function(){return mr})),n.d(t,"Hc",(function(){return vr})),n.d(t,"ac",(function(){return gr})),n.d(t,"cd",(function(){return _r})),n.d(t,"n",(function(){return Er})),n.d(t,"g",(function(){return br})),n.d(t,"Vc",(function(){return yr})),n.d(t,"I",(function(){return Sr}));var r=n(9),a=n.n(r),i=n(8),s=n(53),o=n(2),u=n(21),d=n(15),c=n(11),l=n(7),p=n(3),h=n(5),f=n(12),m=n(10),v=n(58),g=n(81),_=n(49),E=n(30),b=n(16),y=n(74),S=n(42),I=n(64),w=n(51),T=n(65),A=n(77),O=n(24),M=n(79),C=n(144),R=n(39),N=n(134);function k(e,t){return e.where("id").equals(t).first().then(t=>{if(!t)return __LOG__(2)`_resetToClock on non existing message`,null;if(t.author!==o.b)return __LOG__(4)`_resetToClock on incoming message`,null;if((0,R.k)(t.ack))return __LOG__(2)`_resetToClock on sent message`,null;var n=(0,m.j)(t,{ack:o.a.CLOCK,resendCount:null!=t.resendCount?t.resendCount+1:1});return e.put(n).then(()=>n)})}function P(e,t,n){var r=(0,d.w)(t);return(0,h.c)([e.table.stores.chats.get(r),G(e.table.stores.msgs,t,n)]).then(n=>{var i=a()(n,2),s=i[0],o=i[1];if(!s||!o)return __LOG__(2)`updateSystemAck on non-existing chat ${r} or msg ${t}`,null;var u=(0,I.g)(s,o)?e.table.updateChat(s).then(()=>s):(0,h.e)(s),d=(0,l.p)(s.jid);return(0,h.c)([u,d?e.table.getGroupInfoWithParticipantsInTransaction(d):null]).then(e=>{var t=a()(e,2),n=t[0],r=t[1];return{chat:(0,w.a)(n,r),dbMsg:o}})})}function G(e,t,n){return e.where("id").equals(t).first().then(t=>t?t.author!==o.b?(__LOG__(4)`_updateSystemAck on incoming message`,null):(0,R.k)(t.ack)?(__LOG__(2)`_updateSystemAck on sent message`,null):(t.ack=n,n===o.a.SENT&&delete t.resendCount,e.put(t).then(()=>t)):(__LOG__(2)`_updateSystemAck on non existing message`,null))}function L(e,t){var n=t.id;return e.table.stores.receipts.where("msgId").between((0,d.u)(n),(0,d.x)(n)).toArray().then(e=>{var t={};return e.forEach(e=>{var n=(0,d.s)(e.msgId),r=(0,A.j)(e);n&&r&&(t[n]=(0,A.c)(r))}),t})}function D(e,t,n,r,a,i){return(0,h.c)(t.map(t=>x(e,t,i,n,[{participant:r,ts:a}]))).then(e=>e.filter(Boolean))}function x(e,t,n,r,a){var i=t.id;return e.table.stores.receipts.get(i).then(A.j).then(s=>{if(s)if(s.chat===r){var u=(0,A.b)(t.ack,n,s,a);if(u){var d=u.updatedAck,c=u.updatedReceipt,l=null,p=null,f=(0,h.e)();if(null!=d){__LOG__(2)`Updating ack for ${t.id} to ${d}`;var v=(0,m.j)(t,{ack:d});(0,R.g)(d)&&!(0,O.k)(v)&&(v.type===o.f.PTT?v.played=!0:(0,M.b)(v)&&null!=v.viewOnceState&&(v.viewOnceState="viewed",f=(0,S.L)(e.table.stores,[{id:v.id,media:v.media}],!1),delete v.viewOnceExpiration,delete v.media)),l=e.table.putCommonMsg(v),p={msg:v,ack:d}}var g=e.table.stores.receipts.put((0,A.i)(c));return(0,h.c)([l,g,f]).then(()=>p)}__LOG__(2)`updateReceiptInTransaction ack for ${i} irrelevant`}else __LOG__(3)`updateReceiptInTransaction wrong chat for ${i} - ${s.chat} != ${r}`;else __LOG__(3)`updateReceiptInTransaction no receipt for msg ${i}`})}function U(e,t,n){return null==n||0===n.size?(0,h.e)():e.table.stores.receipts.get(t).then(A.j).then(r=>{if(r){var a=(0,A.a)(r,n);if(a)return e.table.stores.receipts.put((0,A.i)(a)).then(()=>{});__LOG__(2)`updateReceiptInTransaction ack for ${t} irrelevant`}else __LOG__(3)`updateReceiptInTransaction no receipt for msg ${t}`})}var F=n(37),B=n(104),j=n(189),V=n(60),K=n(202),H=n(23);function $(e,t,n){return e.table.markChatAsBizRoleChanged(t).then(()=>e.addSystemMsgToChatInTransaction(t,n))}var q=n(14),z=n(291),J=n(250),Y=n(26);n(6);var W=n(86),Z=n(239);function Q(e,t,n){return e.getOrphanedMsgsInTransaction(t.externalId,t.author,n).then(r=>{if(!r.revoke)return e.deleteOrphanedMsgsInTransaction(t.externalId,t.author,n).then(()=>{var n=t.ts,r=t.chatJid,a=t.externalId,i=t.author;if("@system"===i)return __LOG__(4)`maybeStoreOrphanRevokeMsgInTransaction unexpected system msg`,(0,h.e)();var s={type:"revoke",ts:n,chatJid:r,externalId:a,content:t,author:i};return e.stores.orphanedStanzas.add(s)});if(t.ts>r.revoke.ts){var a=Object.assign({},r.revoke,{ts:t.ts});return e.stores.orphanedStanzas.put(a)}})}var X=n(206);function ee(e,t,n){return e.table.transact("rw",["contacts","groups","groupParticipantsInfo","chats","msgs","receipts","media","previews","meta","status","orphanedStanzas","reactions"],()=>(function(e,t,n){return null==t.outgoingTo?(function(e,t){var n=t.content,r=n.msg.quoted;if(null==r)return(0,h.e)(t);var a=r.remoteJid,i=r.externalId,s=r.author;return null==i?(0,h.e)(t):e.table.getCommonMsgFromExternalId(null!=a?a:t.jid,s,i).then(e=>null==e?t:(0,m.j)(t,{content:(0,m.j)(n,{msg:(0,m.j)(n.msg,{quoted:(0,m.j)(r,{id:e.id,ts:e.ts})})})}))})(e,t):null==n?(0,h.e)(t):(function(e,t,n){return(function(e,t,n){return e.table.getCommonMsg(t).then(t=>{if(null==t)return null;if("@system"===t.author||"@psa"===t.author)return null;var r,i,s=t.author;return(0,O.e)(t)&&t.media&&(r=S.l(e,t.media)),(0,O.j)(t)&&t.hasPreview&&(i=S.i(e,t)),(0,h.c)([r,i]).then(e=>{var r,i,u,d=a()(e,2),c=d[0],l=d[1];if(c){var p=c.mediaEntries[t.id];c.plaintextHash&&p&&("mms3"===p.version||"mms4"===p.version)&&(i={plaintextHash:c.plaintextHash,mediaEntry:p})}switch(l&&(u={quotedMediaPreview:l}),t.type){case o.f.TEXT:r={type:o.f.TEXT,text:t.text,linkPreview:t.linkPreview,bg:t.bg};break;case o.f.VCARD:r={type:o.f.VCARD,contacts:t.contacts};break;case o.f.LOCATION:r={type:o.f.LOCATION,degreesLatitude:t.degreesLatitude,degreesLongitude:t.degreesLongitude,name:t.name,address:t.address,url:t.url,bg:t.bg};break;case o.f.STICKER:r={type:o.f.STICKER,size:t.size,width:t.width,height:t.height,media:i};break;case o.f.IMAGE:r={type:o.f.IMAGE,size:t.size,text:t.text,width:t.width,height:t.height,bg:t.bg,media:i},null!=t.viewOnceState&&(r.viewOnceState=t.viewOnceState);break;case o.f.PTT:r={type:o.f.PTT,size:t.size,duration:t.duration,mimetype:t.mimetype,media:i};break;case o.f.AUDIO:r={type:o.f.AUDIO,size:t.size,duration:t.duration,mimetype:t.mimetype,media:i};break;case o.f.VIDEO:r={type:o.f.VIDEO,size:t.size,duration:t.duration,width:t.width,height:t.height,mimetype:t.mimetype,text:t.text,rotation:t.rotation,frame:t.frame,bg:t.bg,media:i},null!=t.viewOnceState&&(r.viewOnceState=t.viewOnceState);break;case o.f.GIF:r={type:o.f.GIF,size:t.size,duration:t.duration,width:t.width,height:t.height,mimetype:t.mimetype,text:t.text,rotation:t.rotation,frame:t.frame,bg:t.bg,gifAttribution:t.gifAttribution,media:i};break;case o.f.GROUP_INVITE:r={type:o.f.GROUP_INVITE,groupJid:t.groupJid,inviteCode:t.inviteCode,inviteExpiration:t.inviteExpiration,groupName:t.groupName,caption:t.caption,bg:t.bg};break;case o.f.RICH_HSM:r={type:o.f.RICH_HSM,title:t.title,content:t.content,footer:t.footer,richContent:t.richContent,buttons:t.buttons,bg:t.bg,media:i};break;case o.f.HSM_BUTTON_REPLY:r={type:o.f.HSM_BUTTON_REPLY,selectedDisplayText:t.selectedDisplayText,payload:t.payload,selectedButtonIndex:t.selectedButtonIndex};break;case o.f.DOCUMENT:r=t.isVCard?{type:o.f.DOCUMENT,mimetype:"text/vcard",isVCard:!0,size:t.size,fileName:t.fileName,contactsCount:t.contactsCount,uiVCards:t.uiVCards,media:i}:{type:o.f.DOCUMENT,mimetype:t.mimetype,size:t.size,fileName:t.fileName,pages:t.pages,bg:t.bg,media:i};break;default:return t.type!==o.f.REVOKED&&(__LOG__(4)`Cannot quote msg type ${t.type}`,SEND_LOGS("quote-wrong-msg-type")),null}return{quoted:{externalId:t.externalId,id:t.id,ts:t.ts,remoteJid:n,author:s,content:r,hasPreview:t.hasPreview?"quoted":void 0,mentionedJids:t.mentionedJids},quotedData:u}})})})(e,n.msgId,n.remoteJid).then(e=>{if(null==e)return t;var n=t.content,r=e.quoted,a=e.quotedData;return(0,m.j)(t,{content:(0,m.j)(n,{msg:(0,m.j)(n.msg,{quoted:r}),quotedData:a})})})})(e,t,n)})(e,t,n).then(t=>ne(e,t)))}function te(e,t,n){return e.table.transact("rw",["groups","groupParticipantsInfo","contacts","msgs","receipts","chats","media","previews","status","orphanedStanzas","reactions"],()=>{var r=n.map(e=>e.msgId),a=n.length>1;return e.table.getMsgsToForward(r).then(r=>{var i=[];return n.reduce((n,s)=>n.then(()=>{var n=r[s.msgId];if(!n)return null;var i=(0,z.c)(n,s.externalId,t,a);if(!i)return null;var o=s.jid,u=s.outgoingTo;return ne(e,{jid:o,outgoingTo:u,content:i})}).then(e=>{e&&i.push(e)}),(0,h.e)()).then(()=>i)})})}function ne(e,t){return(0,l.x)(t.jid,{user:n=>(function(e,t,n){var r,i=n.outgoingTo,u=n.content,d=!!i;return e.table.getContact(t).then(n=>{var c=n;!d&&u.isHsm&&(c=(0,s.r)(c,n,t)),d&&(c=(0,s.p)(c,n,t)),!d&&u.pushname&&(c=(0,s.q)(c,n,t,u.pushname));var l,f=(0,J.c)(c,n,t,d,u.msg);if(f.dropMsg)return null!=f.contact?(__LOG__(2)`maybeUpdateEphemeralSetting ephemeralSettingTimestamp only`,e.table.stores.contacts.put(f.contact).then(()=>null)):null;if(c=f.contact,n&&n.chatId)l=(function(e,t,n,r,a){var i,s=null==(i=r.ephemeral)?void 0:i.expiration;if(!a.changedByMsg||null==s)return(0,h.e)([n,r,[]]);__LOG__(2)`Ephemeral settings changed by incoming msg`;var u=(0,p.E)(),d={type:o.f.EPHEMERAL,subtype:"setting",externalId:"/ephemeral/"+u,ts:u,author:t,ack:o.a.RECEIVED,ephemeralExpiration:s,altIndex:""};return e.addSystemMsgWithResult(n,d).then(e=>[n,r,[e]])})(e,t,n.chatId,c,f);else{if(u.msg.type===o.f.REVOKED)return Q(e.table,u.msg,u.msg.chatJid).then(e=>null);r=null==c.phonebookPhone,l=e.createUserChatInTransaction(t,c).then(e=>{var t=a()(e,3),n=t[0],r=t[1],i=t[2];return[n.id,r,i]})}return l.then(t=>{var d=a()(t,3),c=d[0],l=d[1],p=d[2],h=(0,C.f)(l,null!=i,u);return re(e,i,c,h,null,!0,f).then(e=>{if(e){l&&e.dbMsg.type===o.f.EPHEMERAL&&"fail"===e.dbMsg.subtype&&(l.ephemeral=null==n?void 0:n.ephemeral);var t=(0,s.x)(e,l);return t.notifications=[...t.notifications||[],...p||[]].filter(Boolean),r&&(t.newSidelistChat=r),t}return(0,s.s)(p||[])})})})})(e,n,t),group:n=>(function(e,t,n){var r=n.content,i=n.outgoingTo,o=!!i,u=_.i(r.msg.author);return(0,h.c)([u?e.table.getContact(u):null,e.table.getGroupInfoWithParticipantsInTransaction(t)]).then(t=>{var n,d=a()(t,2),c=d[0],l=d[1];if(!l)return null;u&&r.pushname&&(n=(0,s.q)(n,c,u,r.pushname));var p=null;o&&!l.groupInfo.messaged&&(l.groupInfo.messaged=!0,p=e.table.setGroupInfo(l.groupInfo));var f=l.groupInfo.chatId;return(0,h.c)([re(e,i,f,r,l,!0,null),p]).then(e=>{var t=a()(e,1)[0];if(t)return(0,s.x)(t,n||void 0)})})})(e,n,t)}).then(t=>t&&t.updatedContact?e.table.stores.contacts.put(t.updatedContact).then(()=>t):t).then(n=>n&&"new"===n.result?(function(e,t,n,r){return(0,Y.d)(e.table.stores.meta,Y.a.WAM_CHATS_CACHE).then(a=>{var i=(0,s.m)(a),o=i.startTs,u=i.chats,d=u.get(t);d||(d={sent:0,received:0,starred:0,ephemeralSent:0,ephemeralReceived:0,viewOnceOpened:0,viewOnceReceived:0,viewOnceSent:0});var c=null!=r.expiration&&r.expiration>q.i,l=r&&(0,O.o)(r);return"sent"===n?(d.sent+=1,d.ephemeralSent+=c?1:0,d.viewOnceSent=(d.viewOnceSent||0)+l?1:0):(d.received+=1,d.ephemeralReceived+=c?1:0,d.viewOnceReceived=(d.viewOnceReceived||0)+l?1:0),u.set(t,d),e.table.stores.meta.put({key:Y.a.WAM_CHATS_CACHE,value:{startTs:o,chats:u}}).then(()=>{})})})(e,t.jid,null==t.outgoingTo?"received":"sent",n.dbMsg).then(()=>n):n)}function re(e,t,n,r,i,u,c){var m=r.msg,v=r.media,g=r.quotedData,_=!!t,E=m,b=null;return u&&(b=null!=E.placeholderId?e.table.getMsgFromExternalId(n,{author:E.author,externalId:E.placeholderId}).then(t=>t||e.table.getMsgFromExternalId(n,E)):e.table.getMsgFromExternalId(n,E)),(0,h.c)([e.table.getChatInTransaction(n),b]).then(n=>{var r=a()(n,2),u=r[0],b=r[1];if(E.type===o.f.REVOKED&&b&&b.type!==o.f.REVOKED)return __LOG__(2)`_addMsgToChatInTransaction revoking msg ${b.id}`,(0,X.d)(e,u,i,b,E);if(b&&((0,O.i)(b)||b.type===o.f.FUTUREPROOF)&&b.type!==E.type)return __LOG__(2)`_addMsgToChatInTransaction clearing placeholder ${b.id}`,(function(e,t,n,r,i,s,u,c){(0,O.i)(r)&&WAM.log("regular",1980,void 0,[2,0,3,3,0,null==n?1:2,4,0,(0,p.B)(r.ts),1,0,r.type===o.f.CIPHERTEXT?1:3]);var l,f=ie(!1,t.jid,i,n,c,r),m=Object.assign({},f,{rowId:r.rowId,id:r.id,ts:r.ts,author:r.author,chat:r.chat,altIndex:f.altIndex||r.altIndex}),v=S.v(e,(0,d.F)(r.id),u&&u.quotedMediaPreview||null),g=(0,I.g)(t,m)?e.table.updateChat(t).then(()=>t):(0,h.e)(t);return l=s?S.q(e,r.id,m,s).then(t=>{var n=t.toStore;return e.table.stores.msgs.put(n)}):e.table.stores.msgs.put(m),(0,h.c)([g,l,v]).then(t=>{var r=a()(t,1)[0];return ae(e,{result:"modified",dbChat:r,dbGroup:n,dbMsg:m,outgoingTo:null})})})(e,u,i,b,E,v,g,c);if(b){var y=b;return(0,h.e)().then(()=>_?e.table.getReceipt(b.id):null).then(t=>ae(e,{result:"deduped",dbChat:u,dbGroup:i,dbMsg:y,outgoingTo:t&&(0,A.d)(t)}))}return null==E.viewOnceState||(0,M.b)(E)?E.type===o.f.REVOKED?Q(e.table,E,u.jid).then(e=>null):(function(e,t,n,r,i){return e.table.getOrphanedMsgsInTransaction(r.externalId,r.author,t.jid).then(s=>{if(s.revoke){var u=s.revoke,d=u.id;return e.nextMsgChecker(t).then(i=>{var s={type:o.f.REVOKED,altIndex:(0,I.b)("revoked",i),deviceId:u.content.deviceId,chatJid:u.chatJid,ts:r.ts,author:u.author,externalId:u.externalId,revokedExternalId:u.externalId,ack:o.a.RECEIVED,id:i,chat:t.id};return(0,h.c)([e.table.stores.msgs.add(s),e.table.stores.orphanedStanzas.delete(d)]).then(r=>{var i=a()(r,1)[0],o=Object.assign({},s,{rowId:i});return e.mutateChatAttributesOnNewMsg(t,o),e.table.updateChat(t).then(()=>({result:"new",dbChat:t,dbGroup:n,outgoingTo:null,shouldDownloadMmsThumb:!1,dbMsg:o}))})})}var c=s.reactions;return 0===c.size?i():i().then(t=>{var n=t.dbMsg;return(0,Z.a)(e.table,n.id,c).then(n=>e.table.stores.orphanedStanzas.bulkDelete(Array.from(c.values()).map(e=>e.id)).then(()=>Object.assign({},t,{dbMsg:n})))})})})(e,u,i,E,()=>(function(e){var t=e.db,n=e.unstoredContent,r=n.msg,i=n.media,u=n.quotedData,c=e.group,m=e.chat,v=e.outgoingTo,g=e.ephemeralInfo,_=!!v,E=r;return E=(function(e){if(!(0,M.b)(e)||"active"!==e.viewOnceState||null!=e.viewOnceExpiration)return e;__LOG__(2)`maybeUpdateViewOnceMsgInTransaction Setting expiration`;var t=q.h,n=(0,p.l)(t,e.author===o.b?(0,p.E)():e.ts);return e.viewOnceExpiration=n,(0,f.c)("backend","viewOnceTimestamp",{validUntil:n}),e})(E=ie(_,m.jid,E,c,g,null)),(0,O.i)(E)&&(0,s.b)(E,null!=c),t.nextMsgChecker(m).then(e=>(function(e,t,n,r,i,s){var o,u;if(s&&s.quotedMediaPreview){var c=s.quotedMediaPreview;r.quoted?(r.quoted.hasPreview="quoted",o=S.v(e,(0,d.F)(t),c)):__LOG__(3)`Quoted preview received without quoted content`}return u=i?S.q(e,t,r,i).then(r=>{var a=r.toStore;return e.table.addMsg(t,n,a)}):e.table.addMsg(t,n,r),(0,h.c)([u,o]).then(e=>a()(e,1)[0])})(t,e,m.id,E,i,u)).then(e=>{t.mutateChatAttributesOnNewMsg(m,e);var n=null;return v&&(n=t.table.stores.receipts.add((0,A.i)((0,A.f)(e.id,m.jid,E.ts,(0,O.p)(E,_),v)))),null!=m.notStarted&&(__LOG__(2)`chat ${m.id} conversation has started`,delete m.notStarted),(0,h.c)([t.table.updateChat(m),n]).then(()=>{var n,r=(0,l.q)(m.jid);return e.type===o.f.GROUP_INVITE&&r&&(_?(__LOG__(2)`_addMsgToChatInTransaction: adding invitation for ${e.groupJid}`,n=t.table.addInvitationToGroupInTransaction(e.groupJid,{jid:r,expiration:e.inviteExpiration,code:e.inviteCode}).then(t=>{var n=[];if(t){n.push({result:"updated_chat",chat:(0,w.a)(t.dbChat,t.dbGroup)});var r=t.revokes;r&&n.push({result:"revoked_group_invites",groupJid:e.groupJid,outgoing:_,revokes:r})}return{notifications:n}})):(__LOG__(2)`_addMsgToChatInTransaction: received invitation for ${e.groupJid}`,n=t.table.revokeGroupInvitesInTransaction(e.groupJid,!1,[{user:r,expiresBefore:(0,p.x)(1,e.inviteExpiration)}]).then(t=>({notifications:[{result:"revoked_group_invites",groupJid:e.groupJid,outgoing:_,revokes:t}]})))),n}).then(n=>{var r;return n&&(r=n.notifications),ae(t,{result:"new",dbChat:m,dbGroup:c,dbMsg:e,outgoingTo:v,notifications:r})})})})({chat:u,db:e,ephemeralInfo:c,group:i,outgoingTo:t,unstoredContent:{msg:m,media:v,quotedData:g}})):null})}function ae(e,t){var n=t.dbMsg;return(0,W.c)(n)&&n.media?S.l(e,n.media).then(e=>Object.assign({},t,{shouldDownloadMmsThumb:null!=e&&(0,W.b)(e,t.dbMsg.id)})):Object.assign({},t,{shouldDownloadMmsThumb:!1})}function ie(e,t,n,r,a,i){if(n.type===o.f.EPHEMERAL&&"setting"===n.subtype&&null!=i){var s=(null==a?void 0:a.overrideExpiration)||n.ephemeralExpiration||0;return{type:o.f.EPHEMERAL,subtype:"fail",expiration:s,ts:i.ts,externalId:i.externalId,author:i.author,deviceId:i.deviceId,ack:o.a.RECEIVED,altIndex:i.altIndex}}if(r){__LOG__(2)`_maybeUpdateEphemeralMsgInTransaction group`;var u=(0,J.a)(e,n,r);if(u)return(0,m.j)(n,u)}else if(__LOG__(2)`_maybeUpdateEphemeralMsgInTransaction contacts`,(0,l.q)(t)&&a&&!a.dropMsg){var d=(0,J.b)(e,n,a.contact,null==a?void 0:a.overrideExpiration);if(d)return(0,m.j)(n,d)}return n}var se=n(68),oe=n(36);function ue(){return(0,i.e)("getAddressbookWhatsAppSize",e=>e.getAddressbookWhatsAppSize())}function de(){return(0,i.e)("getEverything",e=>e.getEverything())}function ce(e){return(0,i.e)("doesMsgExist",t=>t.doesMsgExist(e))}function le(e,t,n){return(0,i.e)("loadMsgRange",r=>r.loadMsgRange(e,t,n))}function pe(e,t,n){if(n||t){var r,a=null==n?void 0:n.mediaEntries[e],i=a&&"mms4"===a.version?a:null,s=null==n?void 0:n.plaintextHash,o=(null==n?void 0:n.progressiveJpegScanNumber)?null==n?void 0:n.partialPlaintextHash:null,u=null==n||null==(r=n.mmsThumb)?void 0:r.thumbPlaintextHash;return t?(0,m.h)(t).then(e=>({preview:e,mediaEntry:i,plaintextHash:s,partialPlaintextHash:o,thumbPlaintextHash:u})):Promise.resolve({preview:null,mediaEntry:i,plaintextHash:s,partialPlaintextHash:o,thumbPlaintextHash:u})}return Promise.resolve(null)}function he(e){return(0,i.e)("loadMsgContentVCards",t=>t.loadMsgContentVCards(e))}function fe(e,t){return(0,i.e)("loadLastChatMsgs",n=>n.loadLastMsgsInChatForSpamReport(e,t).then(e=>Promise.all(e.filter(Boolean).map(ve))))}function me(e){return(0,i.e)("loadLastChatMsgs",t=>t.loadMsgForSpamReport(e).then(e=>null==e?Promise.resolve(null):ve(e)))}function ve(e){var t=e.dbMsg,n=e.preview,r=e.dbMedia,i=e.quotePreview;return Promise.all([pe(t.id,n,r),i&&(0,m.h)(i)]).then(e=>{var n=a()(e,2),r=n[0],i=n[1];return{msg:t,mediaInfo:r,quotePreview:i}})}function ge(e){return(0,i.c)("createUserChat",t=>t.createUserChat(e).then(e=>{if("new"===e.type){var t=e.chat,n=e.contact;if("ONE_TO_ONE"===t.type&&null==n.phonebookPhone){var r=t.jid;return(0,E.b)().waitUntilPersisted(b.e.addContactToSidelist(r)).then(()=>e)}}return e}),se.b)}function _e(e,t){return __LOG__(2)`writeIncomingMsg ${(0,N.a)(t.msg.externalId)}`,(0,i.c)("writeIncomingMsg",n=>ee(n,{jid:e,outgoingTo:null,content:t}).then(be),t=>{if(t){var n=t.msg,r=t.dbMsg,a=t.chat,i=t.updatedContact;(function(e){var t;((t=e.dbMsg.type)===o.f.IMAGE||t===o.f.STICKER||t===o.f.AUDIO||t===o.f.PTT||t===o.f.VIDEO||t===o.f.GIF||t===o.f.DOCUMENT)&&(0,E.b)().fireAndForget(b.e.downloadMedia(e.dbMsg.id,"autodownload")),e.shouldDownloadMmsThumb&&(0,E.b)().fireAndForget(b.e.downloadMediaThumb(e.dbMsg.id,e.dbMsg.media))})(t),(function(e){"revoked"===e.result&&(0,E.b)().fireAndForget(b.e.removeDeadMediaContent("remote-revoke-msg"))})(t),(0,se.c)(t),We(a.id,!1),(function(e){var t=e.content,n=t.type;("image"===n||"video"===n||"gif"===n||"document"===n&&null!=t.preview||"text"===n&&t.linkPreview||e.quoted&&e.quoted.preview)&&(0,E.b)().fireAndForget(b.e.setMsgBg(e.id))})(n),(0,B.n)(r,e,i),"ONE_TO_ONE"===a.type&&i&&(0,B.q)(i)}})}function Ee(e,t,n,r){return __LOG__(2)`writeOutgoingMsg jid ${e}`,(0,i.c)("writeOutgoingMsg",a=>ee(a,{jid:e,outgoingTo:r,content:t},n).then(be),e=>{if(e)return(0,se.c)(e),We(e.chat.id,!1),e})}function be(e){if(e){if(e.newSidelistChat&&"ONE_TO_ONE"===e.chat.type){var t=e.chat.jid;return(0,E.b)().waitUntilPersisted(b.e.addContactToSidelist(t)).then(()=>e)}return Promise.resolve(e)}}function ye(e,t,n){return(0,i.c)("writeForwardedMsgs",r=>Promise.all([t.length>0?te(r,e,t):[],n.length>0?T.z(r,e,n):null]),e=>{var t=a()(e,2),n=t[0],r=t[1],i=[];return i.push(...n),(0,se.d)(n),r&&(i.push(...r.results),(0,f.c)("event","statusAuthorMeUpdated",{author:(0,g.b)(r.author,(0,p.E)())})),i})}function Se(e){return(0,i.e)("getChatJid",t=>t.getChatWithGroup(e).then(e=>{if(e){var t=e.dbChat,n=e.dbGroup;return(0,w.a)(t,n)}}))}function Ie(e){return(0,i.e)("getChatJid",t=>t.getChatJid(e))}function we(e){return(0,i.e)("getRecipientsForJid",t=>t.getRecipientsForJid(e))}function Te(e){return(0,i.f)("getDevices",t=>(0,h.i)(t.getDevicesInTransaction(e)).then(e=>(0,u.m)(Array.from(e))))}function Ae(){return(0,i.e)("getDeadMedia",e=>(0,h.i)(S.g(e)))}function Oe(e){return __LOG__(2)`markDeadMediaPurged for media ${e}`,(0,i.e)("markDeadMediaPurged",t=>(0,h.i)(S.r(t,e)))}function Me(e,t,n){return(0,i.e)("unreadMsgs",r=>r.msgsInRangeInclusive(t,n).then(t=>{if(0===t.length)return null;for(var n=null,r=t[0],a=r.id,i=r.chat,s=(0,l.x)(e,{user:e=>({type:"user",userJid:e,unread:[],broadcast:{},upTo:a,chatId:i}),group:e=>({type:"group",groupJid:e,unread:{},upTo:a,chatId:i})}),u=0;u<t.length;u++){var d=t[u],c=(0,_.i)(d.author);if(c&&!(0,R.h)(d.ack)&&((!n||d.id>n)&&(n=d.id),d.type!==o.f.GROUP_NOTIFICATION&&d.type!==o.f.BUSINESS_NOTIFICATION&&d.type!==o.f.FUTUREPROOF&&d.type!==o.f.IDENTITY_CHANGE&&d.type!==o.f.PRIVACY_CHANGE&&d.type!==o.f.CIPHERTEXT&&d.type!==o.f.MD_PLACEHOLDER&&d.type!==o.f.HSM_BUTTON_REPLY&&d.type!==o.f.EPHEMERAL&&d.type!==o.f.CONTACT_BLOCK_CHANGE)){var p=d.externalId;if("group"===s.type)s.unread.hasOwnProperty(c)?s.unread[c].push(p):s.unread[c]=[p];else if("user"===s.type)if(d.broadcastJid){var h=d.broadcastJid;s.broadcast.hasOwnProperty(h)?s.broadcast[h].push(p):s.broadcast[h]=[p]}else s.unread.push(p)}}return n?(s.upTo=n,s):null}))}function Ce(e,t){return(0,i.e)("markGroupAsMessaged",n=>n.markGroupAsMessaged(e,t))}function Re(e,t){return(0,i.c)("markChatAsRead",n=>n.markChatAsRead(e,t),e=>{e&&(0,f.c)("event","chatRead",{chatId:e.id,oldestUnread:e.oldestUnread,unreadMsgCount:e.unreadMsgCount})})}function Ne(){return(0,i.e)("purgeContactsLastKnownName",e=>e.purgeContactsLastKnownName())}function ke(e,t,n){return(0,i.e)("getMediaMsgFromExternalId",r=>S.m(r,e,t,n))}function Pe(e){return(0,i.e)("getGroup",t=>t.getGroupInfoWithParticipants(e).then(e=>e?(0,_.e)(e):null))}function Ge(e){return(0,i.e)("getParticipantsInfo",t=>t.getParticipantsInfo(e))}function Le(e){return(0,i.e)("rotateSenderKey",t=>t.rotateSenderKey(e))}function De(e,t){return(0,i.e)("participantForgotKey",n=>n.participantForgotKey(e,t))}function xe(e,t){return(0,i.e)("instantiateParentGroup",t=>t.instantiateParentGroup(e))}function Ue(e,t){return(0,i.c)("instantiateGroupChat",t=>t.instantiateGroupChat(e),n=>{n&&(0,se.d)(n),(0,y.getProfilePicTable)().deleteRecord(e.jid).then(()=>{(0,f.c)("event","avatarsUpdated",{cleared:[e.jid]}),t&&(0,f.c)("event","openChatWithGroup",{group:e.jid})});var r=e.participants.map(e=>e.jid);(0,E.b)().fireAndForget(b.e.syncDeviceList((0,u.m)(r)))})}function Fe(e){return(0,i.e)("getCommunityInfo",t=>t.getCommunityInfo(e))}function Be(){return(0,i.e)("getBlocklist",e=>e.getBlocklist())}function je(){return(0,i.f)("getBlocklistDHash",e=>(0,h.i)(e.getBlocklistDHash()))}function Ve(){return(0,i.f)("getBlocklistAndDHash",e=>e.getBlocklistAndDHash())}function Ke(e){return(0,i.c)("setBlocklist",t=>(0,h.i)(t.setBlocklist(e)),()=>{(0,f.c)("event","blockList",{blocked:e})})}function He(e,t,n){return(0,i.c)("setBlocklistAndDHash",r=>r.table.setBlocklistAndDHash(e,t,n),t=>{"success"===t?(__LOG__(2)`setBlocklistAndDHash blocklist info updated`,(0,f.c)("event","blockList",{blocked:e})):(__LOG__(2)`setBlocklistAndDHash hash mismatched, firing new getBlocklistV2 job`,(0,E.b)().fireAndForget(b.e.getBlocklistV2()))})}function $e(e){return(0,i.c)("addToBlocklist",t=>t.addToBlocklist(e),e=>{var t=a()(e,2),n=t[0],r=t[1];(0,f.c)("event","blockList",{blocked:n}),r&&(0,se.d)([r])})}function qe(e){return(0,i.c)("removeFromBlocklist",t=>t.removeFromBlocklist(e),e=>{var t=a()(e,2),n=t[0],r=t[1];(0,f.c)("event","blockList",{blocked:n}),r&&(0,se.d)([r])})}function ze(e,t){return(0,i.e)("getSentGroupInvitations",n=>n.getSentGroupInvitations(e,t))}function Je(e,t,n,r){return(0,i.e)("getMsgIfAuthorized",a=>{var i=(0,l.b)(t);return i?a.getMsgIfAuthorized(e,i,r,n):T.f(a,e,r,n).then(e=>null==e?{error:"message-not-found"}:{dbMsg:e})})}function Ye(e,t){return(0,i.c)("muteChat",n=>n.muteChat(e,t),e=>{e&&(0,f.c)("event","chatModified",{chat:e})})}function We(e,t){return(0,i.c)("setChatArchivedState",n=>n.setChatArchivedState(e,t),e=>{e&&(0,f.c)("event","chatModified",{chat:e})})}function Ze(e){return(0,i.c)("markChatAsUnread",t=>t.markChatAsUnread(e),e=>{e&&(0,f.c)("event","chatModified",{chat:e})})}function Qe(e){return(0,i.c)("removeChatUnreadMark",t=>t.removeChatUnreadMark(e),e=>{e&&(0,f.c)("event","chatModified",{chat:e})})}function Xe(e,t){return(0,i.c)("starMessagesFromChat",n=>n.starMessagesFromChat(e,t),e=>{if(e){var t=e.msgs,n=e.chat;if((0,f.c)("event","msgsReceived",{changedMsgs:t.map(e=>({msg:e,recent:!1})),affectedChats:[n],newMsgs:[]}),(0,H.a)("gif_search_enabled")&&t.length>0){var r=t.map(e=>e.id);(0,E.b)().fireAndForget(b.e.addFavoriteGifsFromChat(r))}}})}function et(e,t){return(0,i.c)("unstarMessagesFromChat",n=>n.unstarMessagesFromChat(e,t),e=>{if(e){var t=e.msgs,n=e.chat;(0,f.c)("event","msgsReceived",{changedMsgs:t.map(e=>({msg:e,recent:!1})),affectedChats:[n],newMsgs:[]})}})}function tt(e,t){return(0,i.e)("getMsgFromRowId",n=>{var r=(0,l.b)(e);return r?n.getWrittenMsgFromRowId(t).then(e=>{if(e){var t=e.dbMsg,n=e.dbMedia,i=e.preview,s=e.quotePreview,o=null;(n||i)&&(o=pe(t.id,i,n));var u=null;return s&&(u=(0,m.h)(s)),Promise.all([o,u]).then(e=>{var n=a()(e,2),i=n[0],s=n[1];return{type:"chat",jid:r,dbMsg:t,mediaInfo:i,quotePreview:s}})}}):T.m(n,t).then(e=>{if(e){var t=e.dbMsg,n=e.dbMedia,r=e.preview;return n||r?pe(t.id,r,n).then(e=>({type:"status",jid:c.h,dbMsg:t,mediaInfo:e})):Promise.resolve({type:"status",jid:c.h,dbMsg:t,mediaInfo:null})}})})}function nt(e,t){return tt(e,t).then(e=>null==e?null:(0,i.f)("getMsgAndReceiptFromRowId",t=>(0,h.i)(t.getReceipt(e.dbMsg.id)).then(t=>({msgInfo:e,receipt:t}))))}function rt(e){return(0,i.e)("fullMediaMsgInfo",t=>S.f(t,e))}function at(e){return(0,i.f)("getCommonMsgInfo",t=>t.getCommonMessageWithJid(e))}function it(e){return(0,i.e)("getMediaById",t=>(0,h.i)(S.j(t,e)))}function st(e){return(0,i.e)("getChatWithGroup",t=>t.getChatWithGroup(e))}function ot(e,t,n){return(0,i.c)("attachHashToMsgMedia",r=>S.b(r,e,t,n).then(e=>{if(e){if((0,O.k)(e.dbMsg)){var t=e.dbMsg,n=e.dbMedia;return T.w(r).then(e=>({type:"status",dbMsg:t,dbMedia:n,dbAuthor:e}))}return{type:"chat",dbMsg:e.dbMsg,dbMedia:e.dbMedia}}}),e=>{if(e)return"status"===e.type?((0,f.c)("event","statusAuthorMeUpdated",{author:(0,g.b)(e.dbAuthor,(0,p.E)())}),(0,f.c)("event","mediaUpdated",{chatMsgs:[],statusMsgs:[(0,g.d)(e.dbMsg)],deleted:!1})):(0,f.c)("event","mediaUpdated",{chatMsgs:[(0,v.c)(e.dbMsg)],statusMsgs:[],deleted:!1}),{dbMsg:e.dbMsg,dbMedia:e.dbMedia}})}function ut(e){return(0,i.c)("updateMmsThumbLastDownloadAttempt",t=>S.P(t,e),e=>{if(e)return gt(e.dbMsgs),e.dbMedia})}function dt(e){return(0,i.e)("updateLastDownloadAttempt",t=>S.M(t,e))}function ct(e,t){return(0,i.e)("resetMediaDirectPath",n=>S.w(n,e,t))}function lt(e){return(0,i.e)("updateLastUploadAttempt",t=>S.N(t,e))}function pt(e,t){return(0,i.c)("updateMediaPlaintext",n=>S.O(n,e,t),gt)}function ht(e){return(0,i.c)("attachMediaPlaintext",t=>S.c(t,e),e=>e?gt(e):void 0)}function ft(e,t,n){return(0,i.c)("setMediaPlaintext",r=>S.G(r,e,t,n),e=>{if(e){var t=e.dbMedia;return gt(e.dbMsgs),t}})}function mt(e,t){return(0,i.c)("setUndefinedMediaFields",n=>S.J(n,e,t),gt)}function vt(e,t){return(0,i.e)("setMediaProgressiveDetails",n=>S.H(n,e,t))}function gt(e){for(var t=[],n=[],r=0;r<e.length;r++){var a=e[r];void 0!==a.chat?t.push((0,v.c)(a)):n.push((0,g.d)(a))}(0,f.c)("event","mediaUpdated",{chatMsgs:t,statusMsgs:n,deleted:!1})}function _t(e){return(0,i.c)("markMmsMediaPreviewForMsg",t=>S.u(t,e),e=>{e&&gt([e])})}function Et(e,t,n){return(0,i.c)("saveDownloadedMediaMMSPreview",r=>S.y(r,e,t,n),e=>{var t=e.dbMsgs,n=e.dbAuthors;if(n&&n.length>0){var r=(0,p.E)();(0,f.c)("event","statusAuthorsUpdated",{authors:n.map(e=>(0,g.c)(e,r)).filter(Boolean)})}0!==t.length&&gt(t)})}function bt(e,t,n){return(0,i.e)("setMediaEntry",r=>S.B(r,e,t,n))}function yt(e,t,n){return(0,i.e)("markMediaEntryValid",r=>S.t(r,e,t,n))}function St(e){return(0,i.f)("filterParticipantsInGroup",t=>(0,h.i)(t.filterParticipantsInGroup(e)))}function It(e,t,n,r,a){return(0,i.e)("setMediaEntryDirectPath",i=>S.C(i,e,t,n,r,a))}function wt(e,t,n){return(0,i.e)("setMediaEntryThumbDirectPath",r=>S.E(r,e,t,n))}function Tt(e,t,n){return(0,i.e)("setMediaEntryMmsThumbInfo",r=>S.D(r,e,t,n))}function At(e){return(0,i.e)("getDeleteExpiredJobInfoAndContact",t=>t.getDeleteExpiredJobInfoAndContact(e))}function Ot(){return(0,i.e)("getSidelistJids",e=>e.getSidelistJids())}function Mt(e,t){return(0,i.c)("verifyUser",n=>(function(e,t,n){return __LOG__(2)`verifyUser ${t}`,e.table.transact("rw",["contacts","chats","msgs"],()=>e.table.getContact(t).then(r=>{var i=r||{jid:t},o=i.chatId,u=[];if(null!=o){var d=(0,C.b)(i,n);d&&u.push(()=>$(e,o,d));var c=(0,C.e)(i,n);c&&u.push(()=>e.addSystemMsgToChatInTransaction(o,c))}var l=Object.assign({},i,{verifiedInfo:n});return(0,h.c)([(0,h.f)(u),e.table.stores.contacts.put(l)]).then(e=>{var t=a()(e,1)[0];return{contact:l,msgs:t.map(e=>(0,s.w)(e,l))}})}))})(n,e,t),e=>{var t=e.contact,n=e.msgs;t&&((0,f.c)("event","contactsModified",{changed:[t]}),(0,se.d)(n))})}function Ct(e){return(0,i.c)("unverifyUser",t=>(function(e,t){return __LOG__(2)`unverifyUser ${t}`,e.table.transact("rw",["contacts","chats","msgs"],()=>e.table.getContact(t).then(t=>{if(null!=t&&null!=t.verifiedInfo){var n=null,r=Object.assign({},t,{verifiedInfo:void 0}),i=t.chatId;if(null!=i){var o=(0,C.a)(t);o&&(n=$(e,i,o))}return(0,h.c)([n,e.table.stores.contacts.put(r)]).then(e=>{var t=a()(e,1)[0];return{updatedContact:r,msgs:t?[(0,s.w)(t,r)]:[]}})}}))})(t,e),e=>{if(e){var t=e.updatedContact,n=e.msgs;t&&(0,f.c)("event","contactsModified",{changed:[t]}),n&&(0,se.d)(n)}})}function Rt(e){return(0,i.e)("getMsgInfo",t=>t.getMsgInfo(e))}function Nt(e){return(0,i.e)("getMediaMsglikelyOnServerFrom",t=>S.n(t,e))}function kt(e,t){return(0,i.e)("setMediaFilesystemPath",n=>S.F(n,e,t))}function Pt(e,t){return(0,i.c)("recordKeyChange",n=>n.recordKeyChange(e,t),e=>{if(e){var t=e.newMsgs,n=e.updatedContact;n&&(0,f.c)("event","contactsModified",{changed:[n]}),(0,se.d)(t)}})}function Gt(e){return(0,i.c)("markPlayed",t=>t.markPlayed(e),e=>{var t=e.msg,n=e.updatedChat;return t&&"viewed"===t.content.viewOnceState&&(0,f.c)("event","msgsReceived",{newMsgs:[],changedMsgs:[{msg:t,recent:!1}],affectedChats:n?[n]:[]}),t&&t.content&&t.content.mediaStatus&&(0,f.c)("event","msgMediaStatusUpdated",{msgId:t.id,mediaStatus:t.content.mediaStatus}),e})}function Lt(e,t,n){return(0,i.c)("updateContactEphemeralSettings",r=>r.updateContactEphemeralSettings(e,t,n),e=>{e&&(0,f.c)("event","contactsModified",{changed:[e]})})}function Dt(e,t,n){return(0,i.c)("deleteChatMsgs",n=>(0,X.a)(n,e,t),e=>{var t=e.chat,r=e.msgIds,a=e.deletedMediaStats;r.length>0&&((0,f.c)("event","msgsDeleted",{chat:t,msgIds:r,reason:n}),a.numFiles>0&&(0,E.b)().fireAndForget(b.e.removeDeadMediaContent("delete-msgs")))})}function xt(e,t){return(0,i.c)("deleteMsgsFromStorageSetting",t=>(0,X.b)(t,e),e=>{(0,f.c)("event","msgsDeletedFromManyChats",{chats:e.filter(e=>(e.chat,e.msgIds.length>0)).map(e=>({chat:e.chat,msgIds:e.msgIds,reason:t}))}),(0,E.b)().fireAndForget(b.e.removeDeadMediaContent("delete-msgs"));var n={size:0,numFiles:0};return e.forEach(e=>{n.size+=e.deletedMediaStats.size,n.numFiles+=e.deletedMediaStats.numFiles}),{deletedMediaStats:n}})}function Ut(e){return(0,i.e)("deleteAllExpiredMsgsForChat",t=>t.deleteAllExpiredMsgsForChat(e))}function Ft(e){return(0,i.e)("loadChatMedias",t=>t.getChatMediaMsgs(e).then(e=>({msgs:e.map(v.c)})))}function Bt(e){return(0,i.e)("loadStorageSettingMediaMsgs",t=>t.getStorageSettingMediaMsgs(e).then(e=>({msgs:e.map(v.c)})))}function jt(){return(0,i.e)("getStorageSettingChatsMediaSizes",e=>e.getStorageSettingChatsMediaSizes())}function Vt(){return(0,i.e)("getStorageSettingTotalMediaSize",e=>e.getStorageSettingTotalMediaSize())}function Kt(e){return(0,i.e)("getAllMediaMsgIds",t=>t.getAllMediaMsgIds(e))}function Ht(e,t,n){return(0,i.e)("loadChatStarredMsgs",r=>r.loadChatStarredMsgs(e,t,n).then(e=>({msgs:e.map(v.c)})))}function $t(e,t){return(0,i.e)("loadStarredMsgs",n=>n.loadStarredMsgs(e,t).then(e=>({msgs:e.map(v.c)})))}function qt(e,t){return(0,i.e)("updateChatLastNotified",n=>n.updateChatLastNotified(e,t))}function zt(e){return(0,i.e)("getStickerMsgMediaRefs",t=>(0,h.i)(S.k(t,e)).then(t=>t&&t.plaintext?{frame:t.frame,plaintext:t.plaintext}:(__LOG__(2)`getMsgMedia: non-existent media for msg ${e}`,null)))}function Jt(e){return(0,i.c)("markMediaContentAsDeleted",t=>S.s(t,e),e=>{if(0!==e.length){for(var t=[],n=[],r=0;r<e.length;r++){var a=e[r];void 0!==a.chat?t.push((0,v.c)(a)):n.push((0,g.d)(a))}(0,f.c)("event","mediaUpdated",{chatMsgs:t,statusMsgs:n,deleted:!0})}})}function Yt(e,t){return(0,i.c)("updatePushname",n=>n.updatePushname(e,t),e=>{e&&(0,f.c)("event","contactsModified",{changed:[e]})})}function Wt(e,t){return(0,i.c)("updateAbout",n=>n.updateAbout(e,t),e=>{e&&(0,f.c)("event","contactsModified",{changed:[e]})})}function Zt(e){return(0,i.e)("deleteAllMedia",t=>S.e(t,e).then(()=>(0,E.b)().waitUntilPersisted(b.e.removeDeadMediaContent("delete-all-media"))))}function Qt(e){return(0,i.e)("hasMediaMmsPreview",t=>S.p(t,e))}function Xt(e){return(0,i.e)("getFullMsgPreview",t=>S.h(t,e))}function en(e){return(0,i.e)("getMsgPreviews",t=>S.o(t,e))}function tn(e,t,n,r){return(0,i.e)("saveMediaThumbs",a=>S.z(a,e,t,n,r))}function nn(e,t,n){var r=(0,d.z)(e);return"chat"===r.type?(0,i.c)("setMsgBgs",e=>S.A(e,r.msgId,t,n),e=>{e&&(0,f.c)("event","msgBgUpdated",{msg:(0,v.c)(e.updatedMsg)})}):(0,i.c)("setMsgBgs",e=>S.I(e,r.msgId,t),e=>{e&&Hn(e.updatedAuthor,[e.updatedMsg])})}function rn(e){return(0,i.c)("purgeExpiredInvitations",t=>t.purgeExpiredInvitations(e),e=>{e&&(0,f.c)("event","chatModified",{chat:e})})}function an(e,t){return(0,i.c)("removeGroupInvitations",n=>n.removeGroupInvitations(e,t),e=>{if(e){var t=e.updatedGroup,n=e.revokedInvites;t&&(0,f.c)("event","chatModified",{chat:t}),(0,se.a)(n)}})}function sn(e,t,n){return(0,i.c)("revokeReceivedGroupInvites",r=>r.revokeGroupInvites(e,t,n),e=>{var t=e.updatedGroup,n=e.revokeResult;t&&(0,f.c)("event","chatModified",{chat:t}),(0,se.a)(n)})}function on(e,t,n){return(0,i.c)("handleDevicesInfo",r=>r.handleDevicesInfo(e,t).then(a=>{var i=(0,V.d)(a.updatedContact);return a.contactWasUpdated?((0,f.c)("event","identityVerificationChanged",{jid:e}),t.identity&&i.includes(t.identity.deviceId)?(0,E.b)().waitUntilPersisted(b.e.syncDeviceList((0,u.l)(e))).then(()=>a.notificationMsgs):(0,j.b)(e,i).then(t=>n&&n!==t?(0,E.b)().waitUntilPersisted(b.e.syncDeviceList((0,u.l)(e))):r.updatePHashIfMatches(e,i,t).then(()=>{if(a.requestDeviceSync)return(0,E.b)().waitUntilPersisted(b.e.syncDeviceList((0,u.l)(e)))})).then(()=>a.notificationMsgs)):(a.requestDeviceSync&&(0,E.b)().fireAndForget(b.e.syncDeviceList((0,u.l)(e))),a.updatedContact.phash?a.notificationMsgs:(0,j.b)(e,i).then(t=>r.updatePHashIfMatches(e,i,t)))}),se.d)}function un(e){return(0,i.c)("expireContacts",t=>t.expireContacts(e),e=>{var t=e.updatedJids,n=e.notificationMsgs;t.forEach(e=>{(0,f.c)("event","identityVerificationChanged",{jid:e})}),(0,se.d)(n)})}function dn(e,t,n,r){return(0,i.e)("updateContactADVTimestamps",a=>a.updateContactADVTimestamps(e,t,n,r))}function cn(e,t,n){return(0,i.e)("removeContactDevices",r=>r.updatePHashIfMatches(e,t,n))}function ln(){return(0,i.e)("getSortedCallLogs",e=>e.getSortedCallLogs())}function pn(e,t){return(0,i.e)("initializeCallLog",n=>n.initializeCallLog(e,t))}function hn(e,t){return(0,i.e)("createMissedCallLog",n=>n.createMissedCallLog(e,t))}function fn(e,t,n,r){return(0,i.e)("finalizeCallLog",a=>a.finalizeCallLog(e,t,n,r))}function mn(e){return(0,i.e)("deleteCallLogs",t=>t.deleteCallLogs(e))}function vn(){return(0,i.e)("clearAllCallLogs",e=>e.clearAllCallLogs())}function gn(e,t){return(0,i.c)("saveDocumentMediaVCards",n=>S.x(n,e,t),e=>{if(e){var t=e.updatedChats,n=e.updatedMsgs;(0,f.c)("event","msgsReceived",{newMsgs:[],changedMsgs:n.map(e=>({msg:(0,v.c)(e),recent:!1})),affectedChats:t.map(e=>{var t=e.dbChat,n=e.dbGroup;return(0,w.a)(t,n)})})}})}function _n(e){var t=(0,d.z)(e);return"chat"===t.type?(0,i.c)("resetToClockMsg",e=>(function(e,t){return e.table.transact("rw",["groups","groupParticipantsInfo","chats","msgs","receipts"],()=>{var n=(0,d.w)(t);return(0,h.c)([e.table.stores.chats.get(n),k(e.table.stores.msgs,t)]).then(r=>{var i=a()(r,2),s=i[0],o=i[1];if(!s||!o)return __LOG__(2)`resetToClock on non-existing chat ${n} or msg ${t}`,null;var u=(0,l.p)(s.jid),d=u?e.table.getGroupInfoWithParticipantsInTransaction(u):null,c=(0,I.g)(s,o)?e.table.updateChat(s).then(()=>s):(0,h.e)(s);return(0,h.c)([c,d,e.table.getReceipt(t)]).then(e=>{var t=a()(e,3),n=t[0],r=t[1],i=t[2];return{result:"reset_ack",chat:(0,w.a)(n,r),msg:(0,v.c)(o),dbMsg:o,outgoingTo:i&&(0,A.d)(i)}})})})})(e,t.msgId),e=>{if(!e)return null;var t=e.dbMsg,n=e.chat,r=e.msg,a=e.outgoingTo;return(0,f.c)("event","msgAcked",{chat:n,msg:r}),a?{type:"chat",jid:n.jid,dbMsg:t,outgoingTo:a}:(__LOG__(3)`resetToClockChatMsg returned empty outgoingTo`,null)}):(0,i.c)("resetToClockMsg",e=>(function(e,t){return e.table.transact("rw",["status","authors","receipts"],()=>k(e.table.stores.status,t).then(n=>n?(0,h.c)([(0,T.x)(e),e.table.getReceipt(t)]).then(e=>{var t=a()(e,2),r=t[0],i=t[1];return{result:"reset_ack",author:r,dbMsg:n,to:i&&i.to||(0,u.f)()}}):(__LOG__(2)`resetToClock on deleted message`,null)))})(e,t.msgId),e=>{if(!e)return null;Tn(e);var t=e.dbMsg,n=e.to;return{type:"status",jid:c.h,dbMsg:t,outgoingTo:{to:n,identityIds:new Map}}})}function En(e,t){var n=(0,d.z)(e);return"chat"===n.type?(0,i.c)("updateSystemAck",e=>(function(e,t,n){return e.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo"],()=>P(e,t,n))})(e,n.msgId,t),e=>(Ir(e),null==e?void 0:e.dbMsg)):(0,i.c)("updateSystemAck",e=>(function(e,t,n){return e.table.transact("rw",["status","authors"],()=>G(e.table.stores.status,t,n).then(t=>t?(0,T.x)(e).then(e=>({result:"ack_changed",author:e,dbMsg:t})):null))})(e,n.msgId,t),e=>(Tn(e),null==e?void 0:e.dbMsg))}function bn(e,t,n,r,s,u,c){var l=(0,d.z)(e);return"chat"===l.type?(0,i.c)("markMulticastMessageAsSent",e=>(function(e,t,n,r,i,s,u,d){return e.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo","receipts"],()=>(0,h.c)([!r&&n&&e.markParticipantsAsUpToDateInTransaction(n.jid,i,n.keyIncrement||0),s?e.setMsgValidUntilInTransaction(t,s,u):null]).then(()=>(0,h.c)([P(e,t,o.a.SENT),U(e,t,d)]).then(e=>a()(e,1)[0])))})(e,l.msgId,t,n,r,s,u||void 0,c),Ir):(0,i.c)("markMulticastMessageAsSent",e=>(function(e,t,n,r,i,s,o){return e.table.transact("rw",["authors","status","groupParticipantsInfo","receipts"],()=>(0,h.c)([(0,T.o)(e,t,s),U(e,t,o),!r&&n&&e.markParticipantsAsUpToDateInTransaction(n.jid,i,n.keyIncrement||0)]).then(e=>a()(e,1)[0]))})(e,l.msgId,t,n,r,u,c),e=>{e&&(0,f.c)("event","statusAuthorMeUpdated",{author:(0,g.b)(e.dbAuthor,(0,p.E)())})})}function yn(e,t,n,r){return(0,i.c)("markOneToOneMessageAsSent",i=>(function(e,t,n,r,i){return e.table.transact("rw",["msgs","chats","receipts"],()=>(n?e.setMsgValidUntilInTransaction(t,n,r):(0,h.e)()).then(()=>(0,h.c)([P(e,t,o.a.SENT),U(e,t,i)]).then(e=>a()(e,1)[0])))})(i,e,t,n,r),Ir)}function Sn(e,t,n,r){return wn(e,t,Array.from(n).map(e=>({participant:e,ts:r})),R.a.SENDER_BACKFILL_SENT)}function In(e,t,n,r,a,s){var o=(0,l.b)(t);return o?(0,i.c)("updateAck",t=>(function(e,t,n,r,a,i,s){return e.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo","receipts","media","previews"],()=>e.table.getChatAndGroupInTransaction(n).then(o=>{if(!o)return __LOG__(3)`Ignoring acks for non-existent chat ${n}`,{ackChanges:[],validateBusinessCertificate:!1};var u=o.dbChat,d=o.dbGroup;return e.table.stores.msgs.where("externalId").anyOf(t).toArray().then(t=>D(e,t,n,r,a,i).then(t=>{var n=t.map(e=>e.msg);return((0,I.h)(u,n)?e.table.updateChat(u).then(()=>u):(0,h.e)(u)).then(n=>{var r=[],a=[],i=!1;t.forEach(e=>{var t=e.msg;if(null!=s){var o=(0,C.c)(e.msg.bizInfo,s);o.validateBusinessCertificate&&(i=!0,o.bizConflict&&(t=(0,m.j)(e.msg,{bizConflict:!0,bizInfo:o.msgBizInfo}),r.push(t)))}a.push({chat:(0,w.a)(n,d),dbMsg:t})});var o={ackChanges:a,validateBusinessCertificate:i};return r.length>0?e.table.stores.msgs.bulkPut(r).then(()=>o):o})}))}))})(t,e,o,n,r,a,s).then(e=>{var t=e.ackChanges;if(e.validateBusinessCertificate){var r=(0,l.h)(n);return(0,E.b)().waitUntilPersisted(b.e.validateBusinessCertificate(r)).then(()=>t)}return t}),e=>{e.forEach(Ir)}):(0,i.c)("updateAck",t=>(function(e,t,n,r,a){return e.table.transact("rw",["status","authors","receipts","media","previews"],()=>e.table.stores.status.where("externalId").anyOf(t).toArray().then(t=>D(e,t,c.h,n,r,a).then(()=>(0,T.x)(e)).then(t=>L(e,t).then(e=>({result:"receipts_changed",author:t,receipts:e})))))})(t,e,n,r,a),e=>{An(e)})}function wn(e,t,n,r){var a=(0,l.b)(t);return a?(0,i.c)("updateAckForParticipants",t=>(function(e,t,n,r,a){return e.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo","receipts","media","previews"],()=>e.table.getChatAndGroupInTransaction(n).then(i=>i?e.table.stores.msgs.where("externalId").equals(t).filter(e=>e.author===o.b&&e.chat===i.dbChat.id).first().then(t=>t?x(e,t,a,n,r):null).then(t=>{if(!t)return null;var n=i.dbChat;return((0,I.h)(n,[t.msg])?e.table.updateChat(n).then(()=>n):(0,h.e)(n)).then(e=>({chat:(0,w.a)(e,i.dbGroup),dbMsg:t.msg}))}):(__LOG__(3)`Ignoring acks for non-existent chat ${n}`,null)))})(t,e,a,n,r),e=>{Ir(e)}):(0,i.c)("updateAckForParticipants",t=>(function(e,t,n,r){return e.table.transact("rw",["status","authors","receipts","media","previews"],()=>e.table.stores.status.where("externalId").equals(t).filter(e=>e.author===o.b).first().then(a=>a?x(e,a,r,c.h,n).then(t=>{if(t)return(0,T.x)(e).then(t=>L(e,t).then(e=>({result:"receipts_changed",author:t,receipts:e})))}):(__LOG__(2)`updateAckForStatusParticipants msg ${(0,N.a)(t)} is gone`,null)))})(t,e,n,r),e=>{An(e)})}function Tn(e){if(e){var t=e.author;t.jid===o.b?(0,f.c)("event","statusAuthorMeUpdated",{author:(0,g.b)(t,(0,p.E)())}):__LOG__(3)`maybeFireAckUpdated: trying to update ack from different author`}}function An(e){if(e){var t=e.author;t.jid===o.b?(0,f.c)("event","statusReceiptsUpdated",{author:(0,g.b)(t,(0,p.E)()),receipts:e.receipts}):__LOG__(3)`maybeFireAckUpdated: trying to update ack from different author`}}function On(){return(0,i.e)("logChatMessageCountsCacheAndPurge",e=>(0,s.o)(e))}function Mn(){return(0,i.e)("getStatusDailyStats",e=>T.g(e))}function Cn(){return(0,i.c)("loadLastUnreadStatusMsg",e=>T.d(e),e=>{if(e){var t={msgId:e.id,ts:e.ts,campaignDuration:e.campaignDuration};(0,f.c)("event","statusLastUnreadMsgLoaded",{lastUnreadMsg:t})}})}function Rn(){return(0,i.c)("loadStatusPrivacySettings",e=>T.j(e),e=>{e?(0,f.c)("event","statusSettingsUpdated",{settings:e}):(0,E.b)().fireAndForget(b.e.initLocalSettingsFromServer())})}function Nn(){return(0,i.e)("getStatusPrivacySettings",e=>T.j(e))}function kn(){return(0,i.c)("loadAllAuthors",e=>T.c(e),e=>{var t=e.authors,n=e.me,r=e.psa,a=(0,p.E)(),i=[];if(t.forEach(e=>{var t=(0,g.c)(e,a);t&&i.push(t)}),r){var s=(0,g.c)(r,a);s&&i.push(s)}(0,f.c)("event","statusAuthorsLoaded",{authors:i,me:n&&(0,g.b)(n,a)})})}function Pn(){return(0,i.e)("getStatusMmsThumbnailsToDownload",e=>T.i(e).then(e=>{if(e)return{previewMsgIds:e.previewMsgIds,otherMmsThumbnails:e.otherMmsThumbnails}}))}function Gn(){return(0,i.e)("loadSentStatusInfo",e=>T.e(e))}function Ln(e){return(0,i.e)("getStatusFromIds",t=>(0,h.i)(T.h(t,e)).then(e=>e.map(e=>(0,g.d)(e))))}function Dn(e){return(0,i.c)("getStatusWithAuthorFromId",t=>T.k(t,e),e=>{if(null!=e){var t=e.dbStatus,n=e.dbStatusAuthor,r="@me"===n.jid?(0,g.b)(n,(0,p.E)()):(0,g.c)(n,(0,p.E)());if(null!=r)return{author:r,status:(0,g.d)(t)}}})}function xn(e){return(0,i.c)("setInitialStatusPrivacy",t=>T.t(t,e),e=>((0,f.c)("event","statusSettingsUpdated",{settings:e}),e))}function Un(e){return(0,i.c)("setStatusPrivacy",t=>T.u(t,e),e=>(e&&(0,f.c)("event","statusSettingsUpdated",{settings:e}),e))}function Fn(e,t,n){return(0,i.c)("markStatusAsSeen",r=>T.n(r,e,t,n),e=>{e&&Hn(e.updatedAuthor,e.updatedMsgs)})}function Bn(e,t){return(0,i.e)("getUnreadStatusExternalIdUpTo",n=>T.l(n,e,t).then(e=>e.map(e=>({msgId:e.id,externalId:e.externalId}))))}function jn(e){return(0,i.c)("writeIncomingPSAStatusMsg",t=>T.A(t,e),e=>(e.forEach(e=>{if(e){var t=e.dbMsg;Yn(t),Kn(e),(0,B.p)(t,c.h)}}),e))}function Vn(e,t){return(0,i.c)("writeIncomingStatusMsg",n=>T.B(n,e,t),e=>{if(e){var t=e.dbMsg,n=e.author;__LOG__(2)`Received status from author ${n.jid}`,Kn(e),"revoked"===e.result&&(0,E.b)().fireAndForget(b.e.removeDeadMediaContent("remote-revoke-msg")),$n(n),Yn(t),(0,B.p)(t,c.h)}})}function Kn(e){e.shouldAutodownload&&(0,E.b)().fireAndForget(b.e.downloadMedia(e.dbMsg.id,"autodownload")),e.shouldDownloadMmsThumb&&(0,E.b)().fireAndForget(b.e.downloadMediaThumb(e.dbMsg.id,e.dbMsg.media))}function Hn(e,t){var n=(0,g.c)(e,(0,p.E)());if(n)(0,f.c)("event","statusMsgsUpdated",{msgs:t.map(g.d),author:n});else{var r=e.jid===F.b?F.b:(0,_.i)(e.jid);r&&(0,f.c)("event","statusAuthorsCleared",{authors:[r]})}}function $n(e){if(e){var t=(0,g.c)(e,(0,p.E)());if(t)(0,f.c)("event","statusAuthorUpdated",{author:t});else{var n=e.jid===F.b?F.b:(0,_.i)(e.jid);n&&(0,f.c)("event","statusAuthorsCleared",{authors:[n]})}}}function qn(e){return(0,i.c)("revokeStatusPSACampaign",t=>T.s(t,e),e=>{e&&($n(e.author),(0,E.b)().fireAndForget(b.e.removeDeadMediaContent("revoke-status-psa")))})}function zn(e){return(0,i.c)("revokeStatusMsg",t=>T.r(t,e),e=>{if(e)return(0,f.c)("event","statusMsgRemoved",{statusMsgId:e.dbMsg.id,author:(0,g.b)(e.author,(0,p.E)())}),(0,E.b)().fireAndForget(b.e.removeDeadMediaContent("revoke-status-msgs")),e})}function Jn(e){return(0,i.c)("writeOutgoingStatusMsg",t=>T.C(t,e),e=>{if(e)return(0,f.c)("event","statusAuthorMeUpdated",{author:(0,g.b)(e.author,(0,p.E)())}),e})}function Yn(e){var t=e.type;t!==o.f.IMAGE&&t!==o.f.VIDEO&&t!==o.f.GIF||(0,E.b)().fireAndForget(b.e.setMsgBg(e.id))}function Wn(){return(0,i.c)("purgeExpiredStatusMsgs",e=>T.q(e),e=>{})}function Zn(e){return(0,i.c)("muteAuthor",t=>T.p(t,e),e=>$n(e))}function Qn(e){return(0,i.c)("unmuteAuthor",t=>T.v(t,e),e=>$n(e))}function Xn(){return(0,i.e)("getNextExpirationTimestamp",e=>(0,h.i)(e.getNextExpirationTimestamp()))}function er(){return(0,i.e)("getExpiredMessages",e=>(0,h.i)(e.getExpiredMessages()))}function tr(){return(0,i.e)("expireViewOnceMessages",e=>(0,h.i)(e.expireViewOnceMessages()))}function nr(){return(0,i.e)("getNextViewOnceExpirationTimestamp",e=>(0,h.i)(e.getNextViewOnceExpirationTimestamp()))}function rr(e){return(0,i.c)("unlinkViewOnceMsgsMedia",t=>(0,h.i)(t.unlinkViewOnceMsgsMedia(e)),e=>((0,E.b)().fireAndForget(b.e.removeDeadMediaContent("viewonce-unlink")),e))}function ar(){return(0,i.e)("cleanViewOnceMessages",e=>(0,h.i)(e.cleanViewOnceMessages()))}function ir(e,t){return(0,i.c)("markHsmButtonPressed",n=>n.markHsmButtonPressed(e,t),e=>{if(e)return(0,f.c)("event","hsmButtonPressed",{msg:e}),e})}function sr(e,t){return(0,i.c)("setChatWallpaper",n=>n.setChatWallpaper(e,t),e=>{e&&(0,se.e)(e)})}function or(){return(0,i.c)("resetWallpaperInAllChats",e=>e.resetWallpaperInAllChats(),e=>{(0,se.f)(e)})}function ur(e){return(0,i.c)("recomputeSuspiciousCharacters",t=>t.recomputeSuspiciousCharacters(e),e=>{null!=e&&"updated"===e.type&&(0,f.c)("event","msgsReceived",{newMsgs:[],changedMsgs:[{msg:e.msg,recent:!1}],affectedChats:[e.chat]})})}function dr(){return(0,i.e)("getRecentEmojis",e=>e.getRecentEmojis())}function cr(e){return(0,i.e)("setRecentEmojis",t=>t.setRecentEmojis(e))}function lr(e){return(0,i.e)("updateCurrentUserNotice",t=>t.updateCurrentUserNotice(e).then(e=>{if(e){if(null!=e.needsSendAccept){var t=e.needsSendAccept.version;return(0,E.b)().waitUntilPersisted(b.e.syncUserNoticeState(e.id,d.q.EXPIRED,t))}if(e.needsDownload)return(0,E.b)().waitUntilPersisted(b.e.downloadUserNoticeContent(e.id))}}))}function pr(e,t){return(0,i.e)("updateContentForUserNotice",n=>n.updateContentForUserNotice(e,t).then(t=>{var n;return t&&t.currentState===d.q.FETCHED?(0,E.b)().waitUntilPersisted(b.e.syncUserNoticeState(e,t.currentState,null==(n=t.content)?void 0:n.version)).then(()=>t):t}).then(e=>{if(e)return vr()}))}function hr(){return(0,i.e)("getDbUserNotice",e=>e.getDbUserNotice())}function fr(e,t){return(0,i.e)("logUserNoticeDisplayed",n=>n.logUserNoticeDisplayed(e,t))}function mr(e,t,n,r){return(0,i.e)("acceptUserNotice",a=>"deep-link-modal"===r?e===q.S?(WAM.log("regular",2472,void 0,[3,0,6,1,0,e,2,0,t]),(0,E.b)().waitUntilPersisted(b.e.syncUserNoticeState(e,d.q.EXPIRED,t))):(__LOG__(4)`acceptUserNotice: unexpected attempt to accept ToS Deep Link for id: ${e}`,SEND_LOGS("accept-user-notice-deep-link-modal-unexpected-id"),Promise.resolve()):a.acceptUserNotice(e,t,n,r).then(n=>{if(n)return(0,E.b)().waitUntilPersisted(b.e.syncUserNoticeState(e,d.q.EXPIRED,t))}))}function vr(){return(0,K.b)()?(0,i.e)("timeTransitionUserNotice",e=>e.timeTransitionUserNotice().then(e=>{if(e)return(0,E.b)().waitUntilPersisted(b.e.syncUserNoticeState(e.id,e.state,e.version))})):(__LOG__(2)`timeTransitionUserNotice: User Notice Framework is disabled`,Promise.resolve())}function gr(e){return(0,i.e)("purgeUserNotice",t=>t.purgeUserNotice(e))}function _r(e,t,n){return(0,i.e)("updateStaleUserNotice",r=>r.updateStaleUserNotice(e,t,n))}function Er(){return(0,i.e)("deleteExpiredOrphanedStanzas",e=>e.deleteExpiredOrphanedStanzas())}function br(e){return __LOG__(2)`convertFutureproofMessage ${e}`,(0,i.c)("convertFutureproofMessage",t=>t.convertFutureproofMessage(e),e=>{null!=e&&("updated"===e.type?(0,f.c)("event","msgsReceived",{newMsgs:[],changedMsgs:[{msg:e.msg,recent:!1}],affectedChats:[e.chat]}):(e.type,(0,f.c)("event","msgsDeleted",{chat:e.chat,msgIds:[e.msgId],reason:"futureproof-broken"})))})}function yr(e){return(0,i.e)("updateDeleteExpiredDevicesJobInfo",t=>t.updateDeleteExpiredDevicesJobInfo(e))}function Sr(){return(0,i.e)("getDeleteExpiredDevicesJobInfo",e=>e.getDeleteExpiredDevicesJobInfo())}function Ir(e){e&&(0,f.c)("event","msgAcked",{chat:e.chat,msg:(0,v.c)(e.dbMsg)})}},,,,,,,,,,,function(e,t,n){n.d(t,"m",(function(){return _})),n.d(t,"o",(function(){return E})),n.d(t,"c",(function(){return y})),n.d(t,"b",(function(){return S})),n.d(t,"d",(function(){return w})),n.d(t,"p",(function(){return T})),n.d(t,"l",(function(){return A})),n.d(t,"k",(function(){return O})),n.d(t,"a",(function(){return M})),n.d(t,"e",(function(){return R})),n.d(t,"f",(function(){return N})),n.d(t,"j",(function(){return k})),n.d(t,"g",(function(){return P})),n.d(t,"h",(function(){return G})),n.d(t,"i",(function(){return L})),n.d(t,"n",(function(){return x}));var r=n(27),a=n.n(r),i=n(11),s=new(n(46).a)("ack",e=>(e.assertTag("ack"),{id:e.attrString("id"),ts:e.maybeAttrString("t"),class:e.attrString("class"),type:e.maybeAttrString("type"),from:e.attrJidWithType(),participant:e.hasAttr("participant")?e.attrDeviceJid("participant"):null}));function o(e,t){var n=e.pop();t<e.length&&(e[t]=n)}var u=n(109),d=n(4);function c(e,t,n){var r=e.content;if(r&&Array.isArray(r)&&r[0]){var a=r[0];if("error"===a.tag){var i,s=a.attrs||{};n&&(i="function"==typeof n?n(e):n.parseOrThrow(a));var o=i;return{success:!1,errorCode:parseInt(s.code,10),errorText:(0,d.o)(s.text)||"",errorType:(0,d.o)(s.type)||"",errorBackoff:parseInt(s.backoff,10),toString:l,customError:o}}}return"function"==typeof t?{success:!0,result:t(e)}:{success:!0,result:t.parseOrThrow(e)}}function l(){return`IqError ${this.errorCode}: ${this.errorText}`}var p=n(235),h=n(61),f=n(70),m=null,v=new h.a,g=1;function _(e,t,n,r){m||(m=new class{constructor(e,t,n,r){var a,i;this.nextSocketId=1,this.pendingIqs=new Map,this.ackHandlers=[],this.U=new h.a,this.activePing=null,this.V=new Set,this.socketId=0,this.socket=null,this.softCloseSocket=null,this.handleStanza=(e,t,n)=>{var r=F(e);if(null!=r){var a=this.pendingIqs.get(r);a?(this.pendingIqs.delete(r),a.resolve(e),this.maybeScheduleHealthCheck()):__LOG__(4)`handleIq no handler for iq with id ${r}`}else{if("ack"!==e.tag)return"failure"===e.tag&&this.config.shouldBlockReceivingUntilSuccess?this.T(e,t,n):this.U.promise.then(()=>this.T(e,t,n));this.handleAck(e)}return"NO_ACK"},this.healthCheckTimer=new f.a(()=>{__LOG__(2)`Comms: testing socket`,this.socketId&&this.sendPing()}),this.deadSocketTimer=new f.a(e=>{__LOG__(2)`Comms: Socket ${e} expired`,e===this.socketId&&this.softCloseSocket&&this.softCloseSocket()}),this.T=e,this.sendPing=t,this.onConnectionChange=(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:15e3,r={timeoutID:null,connectionStatus:"disconnected",optimismLevel:"optimist"},a=()=>{var e=r.optimismLevel,a=r.connectionStatus;"optimist"===e?r.timeoutID=setTimeout(()=>{r.optimismLevel="realist",t(a)},n):t(a)};return n=>{r.connectionStatus=n,"disconnected"===n||"in_handshake"===n?a():(null!=r.timeoutID&&(clearTimeout(r.timeoutID),r.timeoutID=null),t(n)),e(n)}})(null!=(a=n.handlers.onConnectionChange)?a:()=>{},null!=(i=n.handlers.onOptimisticConnectionChange)?i:()=>{}),this.gzipInflate=r,this.config=n,this.socketLoop=new p.a({name:"MainSocketLoop",code:I,timer:{jitter:.1,max:n.maxSocketLoopWaitTime,algo:{type:"fibonacci",first:1e4,second:1e4},relativeDelay:!0},resetDelay:3e4})}filterPending(e){var t=[];function n(n){e(n)&&t.push(n)}return this.pendingIqs.forEach(n),this.ackHandlers.forEach(n),t}sendPendingIq(e){var t=e.timeoutId;null!=t&&(clearTimeout(t),e.timeoutId=void 0),this.callStanza(e.stanza)}callStanza(e){this.castStanza(e),this.deadSocketTimer.onOrBefore(this.config.deadSocketTime,this.socketId),this.healthCheckTimer.cancel()}castStanza(e){var t=this.socketOrThrow("castStanza");try{var n,r;null==(n=(r=this.config.handlers).onCastStanza)||n.call(r,e),t.sendFrame((0,d.q)(e))}catch(e){__LOG__(4)`castStanza error ${e}`}}socketOrThrow(e){var t=this.socket;if(t)return t;throw new Error(`Comms.${e} called while no socket`)}startHandlingRequests(){return __LOG__(2)`Comms.startHandlingRequests`,this.U.resolve(),this.U.promise.then(()=>{})}parseAndHandleStanza(e,t){e===this.socketId&&(this.deadSocketTimer.cancel(),v.resolveWasCalled()||v.resolve());var n=(0,d.p)(t,this.gzipInflate).catch(e=>{throw __LOG__(4)`Failure parsing stanza!`,e}).then(n=>{var r,a;null==(r=(a=this.config.handlers).onHandleStanza)||r.call(a,n,e,t.byteLength);var i=this.activePing;return i&&i.socketId===e&&i.stanzaId===F(n)?(this.activePing=null,i.handler.resolve(n),this.maybeScheduleHealthCheck(),"NO_ACK"):this.handleStanza(n,e,t.byteLength)}).then(t=>{if(e===this.socketId){if("CLOSE_SOCKET"===t){__LOG__(2)`Comms: job response is CLOSE_SOCKET`;var n=this.socket;n&&n.close()}else"NO_ACK"===t?__LOG__(2)`Comms: job response is NO_ACK`:this.castStanza(t);return"NO_ACK"}});this.V.add(n),n.finally(()=>{this.V.delete(n)})}handleAck(e){for(var t=this.ackHandlers,n=-1,r=null;!r&&++n<t.length;)r=t[n].parseAndTest(e);if(r){var a,i,s=t[n];o(t,n),null==(a=(i=this.config.handlers).onHandleAck)||a.call(i,e),s.resolve(r),this.maybeScheduleHealthCheck()}else __LOG__(3)`handleAck: unrecognized ${e}`}removeHandler(e){if("iq"===e.type){var t=e.stanza.attrs.id;if(!t||"string"!=typeof t)return;if(!this.pendingIqs.delete(t))return}else{e.type;var n=this.ackHandlers.indexOf(e);if(-1===n)return;o(this.ackHandlers,n)}e.resolve(Promise.reject(new u.a))}maybeScheduleHealthCheck(){if(!this.healthCheckTimer.isScheduled()&&!(this.activePing||this.ackHandlers.length||this.pendingIqs.size)){var e=this.config.healthCheckInterval,t=Math.ceil(1e3*e*(1+Math.random()));this.healthCheckTimer.onOrBefore(t)}}}(e,t,n,r),setTimeout(b,0))}function E(){var e=U("stopComms");e.socketLoop.endWithValue(),e.socket&&e.socket.close()}function b(){U("openSocketLoop").socketLoop.start()}function y(){S()||U("maybeResetSocketLoop").socketLoop.reset()}function S(){var e;return!!(null==(e=m)?void 0:e.socket)}function I(){var e=U("socketLoopIteration"),t=e.nextSocketId++;return __LOG__(2)`Comms: Socket ${t} opening`,null==e.config.handlers.onSocketLoopIteration||e.config.handlers.onSocketLoopIteration(),e.config.openChatSocket(()=>{e.onConnectionChange("in_handshake")}).then(n=>{null==e.config.handlers.onSocketOpen||e.config.handlers.onSocketOpen();var r=new h.a;return __LOG__(2)`Comms: Socket ${t} opened`,e.socketId=t,e.socket=n,e.softCloseSocket=()=>{e.softCloseSocket=null,e.socket&&e.config.shouldCloseStaleSocket&&(e.socket.close(),e.socket=null),r.resolve()},e.socketLoop.resetTimeoutAfter(1e4),e.deadSocketTimer.cancel(),e.maybeScheduleHealthCheck(),n.setOnFrame(n=>e.parseAndHandleStanza(t,n)),n.setOnClose(()=>{__LOG__(2)`Comms: Socket ${t} closed`,e.activePing&&t===e.activePing.socketId&&(e.activePing.handler.resolve(),e.activePing=null),e.filterPending(e=>e.attachedToSocketId===t).forEach(t=>{e.removeHandler(t)}),t===e.socketId&&(e.socketId=0,e.socket=null,e.onConnectionChange("disconnected"),null==e.config.handlers.onDisconnect||e.config.handlers.onDisconnect(),r.resolve(),v=new h.a)}),e.onConnectionChange("connected"),null==e.config.handlers.onConnect||e.config.handlers.onConnect(),e.filterPending(e=>!e.attachedToSocketId).sort((e,t)=>e.orderedId-t.orderedId).forEach(t=>{"iq"===t.type?e.sendPendingIq(t):e.callStanza(t.stanza)}),r.promise}).catch(e=>{e instanceof u.a?__LOG__(2)`socketLoopIteration socket closed while in noise handshake`:__LOG__(4)`socketLoopIteration failed ${e}`})}function w(){U("onStreamErrorReceived").socketLoop.cancelReset()}function T(){return U("waitForConnection").sendPing(),v.promise}function A(e,t){return O(e,t).then(()=>{})}function O(e,t){return new Promise(n=>{var r=U("sendStanzaAndWaitForAck");r.ackHandlers.push({type:"ack",parseAndTest:e=>{var n,r,a=s.parse(e);return a.error||(n=a.success,r=t,n.id!==r.id||void 0!==r.class&&n.class!==r.class||void 0!==r.type&&n.type!==r.type||void 0!==r.from&&!(function(e,t){if((0,i.t)(e)===t)return!0;if(null!=e.userJid)return(0,i.p)(e.userJid)===t;if(null!=e.deviceJid){var n=e.deviceJid;return 0===(0,i.s)(n)&&(0,i.w)(n)===t}return!1})(n.from,r.from)||void 0!==r.participant&&n.participant!==r.participant||void 0!==r.ts&&n.ts!==r.ts)?null:e},resolve:n,stanza:e,attachedToSocketId:0,orderedId:g++}),r.socket?r.callStanza(e):__LOG__(2)`Comms has no open socket, will send stanza when socket opens`})}function M(e){var t=U("castStanza");t.socket?t.castStanza(e):__LOG__(2)`Comms has no open socket`}function C(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return new Promise(r=>{var a=U("sendIq"),i=e.attrs.id;if(!i||"string"!=typeof i)throw new Error("Comms:sendIq given iq without id: "+String(e));var s=a.socketId;if(!t||s){var o;n>0&&(o=setTimeout(()=>{var e=a.pendingIqs.get(i);e?a.removeHandler(e):r(Promise.reject(new Error("Comms:_sendIq unexisting stanza to be cancelled: "+i)))},1e3*n));var d={type:"iq",resolve:r,stanza:e,attachedToSocketId:t?s:0,orderedId:g++,timeoutId:o};a.pendingIqs.set(i,d),null==a.config.handlers.onSendIq||a.config.handlers.onSendIq(e),a.socket?a.sendPendingIq(d):__LOG__(2)`Comms has no open socket, will resend iq when socket opens`}else r(Promise.reject(new u.b))})}function R(e,t){return C(e,!1).then(e=>c(e,t))}function N(e,t,n){return C(e,!1).then(e=>c(e,t,n))}function k(e){return C(e,!1)}function P(e,t,n){return C(e,!1,n).then(e=>c(e,t))}function G(e,t){return C(e,!0).then(e=>c(e,t))}function L(e,t){return D.apply(this,arguments)}function D(){return(D=a()((function*(e,t){var n=U("sendPing"),r=e.attrs.id;if(!r||"string"!=typeof r)return Promise.reject(new Error("Comms:sendPing given iq without id: "+String(e)));if(!n.socketId)return __LOG__(2)`sendPing when socket dead`,Promise.resolve();if(n.activePing&&n.activePing.socketId===n.socketId)return __LOG__(2)`sendPing ping still pending`,Promise.resolve();n.activePing&&n.activePing.handler.resolve();var a=new h.a;n.activePing={socketId:n.socketId,stanzaId:r,handler:a},n.callStanza(e);var i=yield a.promise;return i&&c(i,t)}))).apply(this,arguments)}function x(){return U("startHandlingRequests").startHandlingRequests()}function U(e){if(m)return m;throw new Error(`Comms::${e} called before startComms`)}function F(e){if("iq"===e.tag){var t=e.attrs.type;if("result"===t||"error"===t)return(0,d.o)(e.attrs.id)||null}return null}},function(e,t,n){n.d(t,"C",(function(){return T})),n.d(t,"a",(function(){return O})),n.d(t,"O",(function(){return M})),n.d(t,"E",(function(){return R})),n.d(t,"d",(function(){return N})),n.d(t,"B",(function(){return k})),n.d(t,"m",(function(){return P})),n.d(t,"P",(function(){return G})),n.d(t,"r",(function(){return L})),n.d(t,"b",(function(){return D})),n.d(t,"D",(function(){return x})),n.d(t,"A",(function(){return U})),n.d(t,"q",(function(){return F})),n.d(t,"l",(function(){return B})),n.d(t,"k",(function(){return j})),n.d(t,"y",(function(){return V})),n.d(t,"I",(function(){return K})),n.d(t,"J",(function(){return H})),n.d(t,"G",(function(){return $})),n.d(t,"z",(function(){return z})),n.d(t,"N",(function(){return J})),n.d(t,"M",(function(){return Y})),n.d(t,"v",(function(){return W})),n.d(t,"j",(function(){return Z})),n.d(t,"f",(function(){return Q})),n.d(t,"g",(function(){return X})),n.d(t,"L",(function(){return ee})),n.d(t,"K",(function(){return te})),n.d(t,"i",(function(){return ne})),n.d(t,"H",(function(){return re})),n.d(t,"F",(function(){return ae})),n.d(t,"w",(function(){return ie})),n.d(t,"u",(function(){return se})),n.d(t,"x",(function(){return oe})),n.d(t,"t",(function(){return ue})),n.d(t,"s",(function(){return de})),n.d(t,"c",(function(){return ce})),n.d(t,"n",(function(){return le})),n.d(t,"h",(function(){return pe})),n.d(t,"e",(function(){return he})),n.d(t,"p",(function(){return fe})),n.d(t,"o",(function(){return me}));var r=n(27),a=n.n(r),i=n(9),s=n.n(i),o=n(267),u=n(5),d=n(52),c=n(6),l=n(3),p=n(71),h=n(61),f=n(7),m=n(11),v=n(152),g=n(157);function _(e){return e.reduce((e,t)=>(t.deviceId!==m.c&&e.push(t.address),e),[])}var E=n(47),b=null,y=new h.a,S=new h.a;(0,g.f)(y.promise,S.promise);var I=new p.a,w=new Set;function T(e){return y.promise.then(()=>w.has(e))}function A(e){if(!w.has(e))throw new Error(`Feature "${e}" is not supported by daemon`)}var O={generateIdentityKeyPair:g.b,calculateAgreement:g.a};function M(){__LOG__(2)`startSignal::startSignal`,b||(b=(0,v.a)("signal",{onConnect:C,onDisconnect(){y=new h.a,S=new h.a,w=new Set,(0,g.f)(y.promise,S.promise)}}))}function C(e){var t=new class{constructor(){this.Av=new Map,this.Aw=new Map,this.Ax=new p.b}Ay(e){var t=this.Av.get(e);if(t)return t;var n=null,r=this.Au.session_cipher(Ee(e),this.At,e=>{if(!n)return __LOG__(4)`Signal.sessionCipher no decrypt callback`,Promise.resolve();var t=n;return n=null,t(e)}).then(t=>{var r=this.Ax,a=(0,f.h)(e),i=this.Ao,s=e=>(i,s)=>r.enqueue(a,()=>(function(e,r,a){var i,s=r.ciphertext;return n=e=>(i=(0,o.a)(a,null,e)).then(()=>{}),("pkmsg"===r.type?t.decrypt_pre_key_message(s):t.decrypt_message(s)).then(()=>i,e=>i||Promise.reject(e))})(0,{type:e,ciphertext:i},s));return{decrypt_pre_key_message:s("pkmsg"),decrypt_message:s("msg"),remote_registration_id:()=>r.enqueue(a,()=>t.remote_registration_id()),encrypt:n=>r.enqueue(a,()=>i.getIdentityId(Ee(e)).then(e=>(function(e){return t.encrypt(e).then(e=>({type:3===e.messageType?"pkmsg":"msg",ciphertext:e.serialized}))})(n).then(t=>Object.assign({},t,{identityId:e})))),encryptIfIdentityIdMatches:(n,s,o)=>r.enqueue(a,()=>i.getIdentityId(Ee(o?(0,f.e)((0,f.h)(e)):e)).then(e=>e!==s?null:t.encrypt(n).then(e=>Object.assign({},e,{identityId:s})))),create_signal_session:t=>r.enqueue(a,()=>(0,g.g)(e,t.info).then(e=>{if(!e.success)throw ye(e.error)}))}});return this.Av.set(e,r),r}Az(e,t){var n=JSON.stringify([e,t]),r=this.Aw.get(n);if(r)return r;var a=null,i=this.Au.group_cipher(this.At,be(e,t),e=>{if(!a)return __LOG__(4)`Signal.groupCipher no decrypt callback`,Promise.resolve();var t=a;return a=null,t(e)}).then(e=>{var t=new p.a;return{decrypt:(n,r)=>t.enqueue(()=>{var t;return a=e=>(t=(0,o.a)(r,null,e)).then(()=>{}),e.decrypt(n).then(()=>t,e=>t||Promise.reject(e))}),encrypt:n=>t.enqueue(()=>e.encrypt(n))}});return this.Aw.set(n,i),i}BA(){return this.Au.group_session_builder(this.At)}BB(e){return this.BA().then(t=>t.create_session(be(e,(0,f.e)(c.r.get()))))}deleteSignalInfoForDevices(e,t){return this.Ax.enqueue(e,()=>{var n=[],r=[];return t.forEach(t=>{var a=(0,d.encodeAddress)({name:e,deviceId:t});n.push(a),t!==m.c&&r.push(a)}),this.An.transact("rw",["sessions","identities"],()=>(0,u.c)([this.An.stores.sessions.bulkDelete(n),this.An.stores.identities.bulkDelete(r)]))}).then(()=>{})}handleADVInfo(e,t){return this.Ax.enqueue(e,()=>this.An.transact("rw",["identities","sessions"],()=>this.An.stores.identities.where("jid").equals(e).toArray().then(e=>{var n=(function(e,t){switch(t.type){case"adv_list":case"device_added_notification":return(function(e,t){var n=t.rawId,r=t.validIndexes,a=t.currentIndex,i=new Set(r),s=[];return e.forEach(e=>{if(e.deviceId!==m.c)if(e.rawId===n){var t=e.keyIndex;null!=t?!i.has(e.keyIndex)&&t<=a&&s.push(e.address):s.push(e.address)}else s.push(e.address)}),s})(e,t.adv);case"adv_list_and_devices":return(function(e,t,n){var r=t.rawId,a=t.validIndexes,i=t.currentIndex,s=new Set(a),o=n.filter(e=>{var t=e.index;return s.has(t)||t>i}),u=[];return e.forEach(e=>{var t=e.keyIndex,n=e.deviceId;n!==m.c&&(e.rawId===r&&null!=t?t>i||!o.some(e=>{var r=e.id,a=e.index;return r===n&&t===a})&&u.push(e.address):u.push(e.address))}),u})(e,t.adv,t.devices);case"device_removed_notification":return(function(e,t){var n=[];return e.forEach(e=>{var r=e.address,a=e.deviceId,i=e.keyIndex;t.some(e=>{var t=e.id,n=e.index;return t===a&&i===n})&&n.push(r)}),n})(e,t.devicesToRemove);case"adv_devices_reset":return _(e);default:return t.type,_(e)}})(e.map(e=>({deviceId:e.deviceId,address:e.address,rawId:e.rawId,keyIndex:e.keyIndex})),t);if(0!==n.length)return(0,u.c)([this.An.stores.identities.bulkDelete(n),this.An.stores.sessions.bulkDelete(n)]).then(()=>{})})))}saveSignalIdentities(e){return Promise.all(e.map(e=>{var t=s()(e,2),n=t[0],r=t[1];return this.Ax.enqueue(n,()=>this.Ao.save_identity(Ee((0,f.e)(n)),r))})).then(()=>{})}saveIdentityForCompanionDevice(e,t,n,r){return this.Ax.enqueue(e,()=>this.Ao.save_identity(Ee(e),t,{rawId:n,keyIndex:r}))}createSignalSessionForCompanionDevice(e,t){var n=(0,f.h)(e.jid);return this.Ax.enqueue(n,()=>this.Ao.save_identity(Ee(e.jid),e.info.identity.subarray(1),t).then(()=>(0,g.g)(e.jid,e.info)).then(e=>{if(!e.success)throw ye(e.error)}))}signalContexts(){return{context:this.Au,storeContext:this.At}}};__LOG__(2)`Signal::onSessionConnected invoked`,y.resolve(lib_libsignal.libsignal.get(e).then(e=>((function(e){"function"==typeof e.start_hmac_sha256&&w.add("hmacSha256"),"function"==typeof e.download_and_decrypt&&w.add("downloadAndDecrypt")})(e),e)));var r=y.promise.then(e=>(__LOG__(2)`Signal::onSessionConnected got server #${e.id}`,e.new_global_context())).then(e=>(__LOG__(2)`Signal::onSessionConnected got context`,t.Au=e,e.new_store_context())).then(e=>{__LOG__(2)`Signal::onSessionConnected got store context`,t.At=e;var r=t.Au,a=r.session,i=(0,d.getSignalTable)();function s(t){var n,s,o=(n=i,s=new t(a.next_id,a,n),a.track(s),s);return o.set_ids(r.service_id,e.id),o}return t.An=i,t.Ao=s(n(446).default),t.Ap=s(n(437).default),t.Aq=s(n(438).default),t.Ar=s(n(439).default),t.As=s(n(440).default),Promise.all([e.set_identity_key_store(t.Ao),e.set_session_store(t.Ap),e.set_pre_key_store(t.Aq),e.set_signed_pre_key_store(t.Ar),e.set_sender_key_store(t.As)])}).then(()=>(__LOG__(2)`Signal::onSessionConnected completed`,t));S.promise.catch(e=>{__LOG__(4)`Signal::onSessionConnected error ${e}`}),S.resolve(r)}function R(){return(0,u.i)((0,d.getSignalTable)().stores.delete())}function N(){var e=(0,d.getSignalTableIfInitialized)();e&&e.close()}function k(e,t){return ge("hmacSha256",n=>(A("hmacSha256"),n.start_hmac_sha256(e).then(e=>{var n=t.map(t=>e.update(t));return n.unshift(e.finalize()),Promise.all(n).then(e=>s()(e,1)[0])})))}function P(e,t,n,r,a,i,s){return y.promise.then(o=>(A("downloadAndDecrypt"),o.download_and_decrypt(e,t,n,r,a,i,s)))}function G(e,t,n){return ge("verifySignature",r=>r.curve_verify_signature(e,t,n))}function L(){var e=c.E.get().maxKeys;ve("generatePreKeys",t=>t.Aq.generatePreKeys(e))}function D(){return ve("allRemainingPreKeys",e=>e.Aq.allRemainingPreKeys())}function x(e){return ve("markUploadedUpToKey",t=>t.Aq.markUploadedUpToKey(e))}function U(e){return ve("hasSignalSession",t=>t.Ap.contains({name:(0,f.h)(e),deviceId:(0,f.f)(e)}))}function F(e){var t=e.map(e=>({name:(0,f.h)(e),deviceId:(0,f.f)(e)}));return ve("filterJidsWithSession",(function(){var e=a()((function*(e){return yield(0,u.i)(e.Ap.bulkGetJidsWithSessions(t))}));return function(t){return e.apply(this,arguments)}})())}function B(e,t){return ve("deleteSignalInfoForDevices",n=>n.deleteSignalInfoForDevices(e,t))}function j(e){return B((0,f.h)(e),[(0,f.f)(e)])}function V(e,t){return ve("handleADVInfo",n=>n.handleADVInfo(e,t))}function K(){return ve("resetSignal",e=>{var t=(0,g.d)().then(t=>e.An.setRegistrationInfo(t)).then(()=>H());return t.then(()=>{L()}),t})}function H(){return _e("rotateSignedPreKey",e=>e.An.transact("r",["meta"],()=>(0,u.c)([e.An.getMyStaticKeyPair(),e.Ar.nextSignedPreKeyId()])).then(e=>{var t=s()(e,2),n=t[0],r=t[1];return(0,g.e)(r,(0,l.F)(),n)}).then(t=>{var n=t.plainObject,r=t.record,a={id:n.id,keyPair:n.keyPair,signature:n.signature,timestamp:n.ts,record:r};return e.Ar.putAll([a]).then(()=>a)}))}function $(){return _e("publicSignalInfo",e=>q(e))}function q(e){return e.An.transact("r",["meta","signedPreKeys"],()=>(0,u.c)([e.An.getMyRegId(),e.An.getMyStaticKeyPair(),e.Ar.loadLatestSignedPreKeyInTransaction()]).then(e=>{var t=s()(e,3),n=t[0],r=t[1],a=t[2];return{regId:n,staticPublicKey:r.publicKey,signedPreKey:a}}))}function z(){return _e("publicSignalInfo",e=>e.An.transact("r",["meta","signedPreKeys"],()=>(0,u.c)([e.An.maybeRegId(),e.An.maybeStaticKeyPair(),e.Ar.hasSignedPreKeys()]).then(e=>{var t=s()(e,3),n=t[0],r=t[1],a=t[2];return null!=n&&null!=r&&a})))}function J(){return _e("signalInfoForRetry",e=>Promise.all([e.Aq.unusedPreKey(),q(e)]).then(e=>{var t=s()(e,2),n=t[0],r=t[1];return Object.assign({},r,{preKey:n})}))}function Y(e){return _e("signalInfoForPreKeyDigest",t=>Promise.all([q(t),(0,u.i)(t.Aq.loadFullKeys(e))]).then(e=>{var t=s()(e,2),n=t[0],r=t[1];return Object.assign({},n,{preKeys:r})}))}function W(){return ve("getPreKeyGenerations",e=>e.Aq.getAllPreKeyGenerations())}function Z(e){return ve("getPreKeyGenerations",t=>t.Aq.deletePreKeysBelowOrEqual(e)).then(()=>{})}function Q(e){return(0,f.r)(e.jid)?ve("createSignalSession",t=>t.Ay(e.jid).then(t=>t.create_signal_session(e))):(__LOG__(2)`Signal::createSignalSession was called for companion device ${e.jid}`,Promise.reject(new Error("createSignalSession was called for companion device "+e.jid)))}function X(e,t){return ve("createSignalSession",n=>n.createSignalSessionForCompanionDevice(e,t))}function ee(e){return ve("saveSignalIdentities",t=>t.saveSignalIdentities(e))}function te(e,t,n){var r=n.rawId,a=n.keyIndex;return ve("saveIdentityForCompanionDevice",n=>n.saveIdentityForCompanionDevice(e,t,r,a))}function ne(e,t,n,r){return ve("decryptSignalProto",a=>a.Ay(e).then(e=>{switch(t){case"pkmsg":return e.decrypt_pre_key_message(n,r.onSuccess);case"msg":return e.decrypt_message(n,r.onSuccess);default:throw new Error("Received unsupported msg type: "+t)}}).catch(e=>e&&"call_failure"===e.reason&&e.value&&"number"==typeof e.value.result?(__LOG__(2)`decryptSignalProto error code ${e.value.result}`,r.onDecryptFailure(e.value.result)):(__LOG__(4)`decryptSignalProto js error ${e}`,Promise.reject(e))))}function re(){return ve("regId",e=>e.An.getMyRegId())}function ae(e){return ve("otherRegId",t=>t.Ay(e).then(e=>e.remote_registration_id()))}function ie(e){return ve("getPublicKey",t=>t.Ao.getPublicKey(Ee(e)))}function se(){return ve("getMyStaticKeyPair",e=>e.Ao.get_key_pair())}function oe(e){return ve("getPublicKeys",t=>t.Ao.getPublicKeys(e.map(Ee)).then(e=>{var t=new Map;return e.forEach(e=>{var n=e.jid,r=e.deviceId,a=e.publicKey;t.set((0,f.A)(n,r),a)}),t}))}function ue(e){return ve("getKnownIdentityIds",t=>t.Ao.getKnownIdentityIds(e.map(Ee)).then(e=>{var t=new Map;return e.forEach(e=>{var n=e.jid,r=e.deviceId,a=e.identityId;t.set((0,f.A)(n,r),a)}),t}))}function de(e){return ve("getGroupSenderKeyInfo",t=>t.BB(e).then(e=>e.serialized))}function ce(e){return ve("clearGroupSenderKey",t=>t.As.delete(be(e,(0,f.e)(c.r.get())))).then(()=>{})}function le(e,t){return ve("encryptGroupSignalProto",n=>n.Az(e,(0,f.e)(c.r.get())).then(e=>e.encrypt(t)).then(e=>({type:"skmsg",ciphertext:e})))}function pe(e,t,n,r){return ve("decryptGroupSignalProto",a=>a.Az(e,t).then(e=>e.decrypt(n,r.onSuccess)).catch(e=>e&&"call_failure"===e.reason&&e.value&&"number"==typeof e.value.result?(__LOG__(2)`decryptGroupSignalProto error code ${e.value.result}`,r.onDecryptFailure(e.value.result)):(__LOG__(4)`decryptGroupSignalProto js error ${e}`,Promise.reject(e))))}function he(e){var t=e.group,n=e.sender,r=e.skdist;return ve("createGroupSenderSignalSession",e=>e.BA().then(e=>e.process_session(be(t,n),{serialized:new Uint8Array(r)}))).finally(()=>{__LOG__(2)`createGroupSenderSignalSession finished ${t}/${n}`})}function fe(e,t,n,r){return ve("encryptSignalProtoIfIdentityIdMatches",a=>a.Ay(e).then(e=>{var a=n;return e.encryptIfIdentityIdMatches(t,a,r)}).then(e=>e?{type:3===e.messageType?"pkmsg":"msg",ciphertext:e.serialized,identityId:e.identityId}:null))}function me(e,t){return ve("encryptSignalProto",n=>n.Ay(e).then(e=>e.encrypt(t)))}function ve(e,t){return S.promise.then(t).catch(n=>n&&"session_closed"===n.reason?(__LOG__(2)`Signal::run retrying ${e}`,ve(e,t)):Promise.reject(n))}function ge(e,t){return y.promise.then(t).catch(n=>n&&"session_closed"===n.reason?(__LOG__(2)`Signal::run retrying ${e}`,ge(e,t)):Promise.reject(n))}function _e(e,t){return I.enqueue(()=>ve(e,t))}function Ee(e){return lib_libsignal.protos.Address.create({name:(0,f.h)(e),deviceId:(0,f.f)(e)})}function be(e,t){return lib_libsignal.protos.SenderKeyName.create({groupId:e,sender:Ee(t)})}function ye(e){var t=E.a[e];return null!=t?{reason:"call_failure",value:{result:t}}:new Error(e)}},function(e,t,n){n.d(t,"d",(function(){return p})),n.d(t,"c",(function(){return f})),n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return v}));var r=n(16),a=n(119),i=n(12),s=n(91),o=new Promise(()=>{}),u=!1,d=null;function c(e,t,n){var a=(0,r.c)(t,n);a&&(0,i.c)("event","uiJobUpdated",{jobName:t,key:a,status:{status:"running"}})}function l(e,t,n,a){var s=(0,r.c)(t,n);return s&&(0,i.c)("event","uiJobUpdated",{jobName:t,key:s,status:{status:"finished",result:a}}),(0,r.f)(t,a)}function p(e){d=new a.c({isRestartAfterCrash:e,accessors:{readPersistedJob:e=>(0,s.jobsTable)().loadBookmark(e),updatePersistedJob:e=>u?o:(0,i.d)()?(0,s.jobsTable)().saveBookmarkAsPage(e):(0,s.jobsTable)().saveBookmarkIfNoPage(e).then(e=>{if(e)return u=!0,__LOG__(2)`saveBookmark shutdown system`,(0,i.j)(),o}),deletePersistedJob:e=>(0,s.jobsTable)().removeJob(e),maybeCreateJob:h},unfinishedJobEntries:(0,s.jobsTable)().loadAllBookmarks(),listeners:{onJobStarted:c,onJobFinished:l},deprecatedJobs:(0,r.b)()})}function h(e){return(0,s.jobsTable)().maybeCreateJob(e).then(t=>{var n=t.newlyCreated,a=t.jobId;return n&&(0,r.d)(e.type)&&(0,i.c)("event","uiJobScheduled",{jobId:a,jobInfo:e}),{id:a,newlyCreated:n}})}function f(e){return v().loadAndRunJobFromId(e)}function m(e){return(0,s.jobsTable)().removeFinishedJob(e)}function v(){if(null==d)throw new Error("jobs manager has not been initialized");return d}},,,function(e,t,n){n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return i}));var r={IMAGE:1,STICKER:2,PTT:4,AUDIO:8,DOCUMENT:16,VIDEO:32,GIF:64,RICH_HSM:128,MD_HISTORY:256,THUMBNAIL_IMAGE:512,THUMBNAIL_VIDEO:1024,THUMBNAIL_GIF:2048,THUMBNAIL_DOCUMENT:4096,THUMBNAIL_LINK:8192,MD_APP_STATE:16384},a=-1,i=7},,,,,function(e,t,n){function r(e){return{success:!1,error:e}}function a(e){return{success:!0,value:e}}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}))},,,,function(e,t,n){n.d(t,"a",(function(){return T})),n.d(t,"f",(function(){return A})),n.d(t,"m",(function(){return M})),n.d(t,"e",(function(){return C})),n.d(t,"B",(function(){return R})),n.d(t,"t",(function(){return N})),n.d(t,"C",(function(){return k})),n.d(t,"D",(function(){return P})),n.d(t,"E",(function(){return G})),n.d(t,"O",(function(){return L})),n.d(t,"c",(function(){return D})),n.d(t,"J",(function(){return x})),n.d(t,"H",(function(){return U})),n.d(t,"G",(function(){return F})),n.d(t,"s",(function(){return B})),n.d(t,"k",(function(){return j})),n.d(t,"M",(function(){return V})),n.d(t,"N",(function(){return K})),n.d(t,"w",(function(){return H})),n.d(t,"F",(function(){return $})),n.d(t,"b",(function(){return q})),n.d(t,"L",(function(){return z})),n.d(t,"K",(function(){return J})),n.d(t,"q",(function(){return Z})),n.d(t,"v",(function(){return X})),n.d(t,"u",(function(){return ee})),n.d(t,"p",(function(){return te})),n.d(t,"o",(function(){return ne})),n.d(t,"h",(function(){return re})),n.d(t,"i",(function(){return ae})),n.d(t,"z",(function(){return ie})),n.d(t,"P",(function(){return se})),n.d(t,"y",(function(){return oe})),n.d(t,"g",(function(){return ue})),n.d(t,"r",(function(){return de})),n.d(t,"I",(function(){return ce})),n.d(t,"A",(function(){return le})),n.d(t,"x",(function(){return pe})),n.d(t,"n",(function(){return he})),n.d(t,"j",(function(){return fe})),n.d(t,"l",(function(){return me})),n.d(t,"d",(function(){return ye}));var r=n(9),a=n.n(r),i=n(2),s=n(95),o=n(24),u=n(86),d=n(217),c=n(7),l=n(5),p=n(15),h=n(21),f=n(228),m=n(10),v=n(64),g=n(94),_=n(45),E=n(3),b=n(105),y=n(26),S=n(80),I=n(134),w=n(6),T=50;function A(e,t){return e.table.transact("r",["msgs","media","receipts","chats","status","groups","contacts"],()=>(0,l.c)([O(e,t),e.table.getReceipt(t)]).then(e=>{var n=a()(e,2),r=n[0],i=n[1];if(!r)return __LOG__(3)`fullMediaMsgInfo: Tried to retrieve non-media msg ${t}`,null;var s=!1;if(i&&(s=(0,c.y)(i.chat,{user:e=>e!==w.r.get(),group:()=>!i.to||i.to.length>0,status:()=>!i.to||i.to.length>0})),"chat"===r.type){var o=r.msg;return{type:r.type,jid:r.jid,media:r.media,msg:o,leavesSystem:s,fromEphemeralChat:r.fromEphemeralChat}}var u=r.msg;return{type:r.type,media:r.media,msg:u,leavesSystem:s}}))}function O(e,t){return e.table.getCommonMsg(t).then(t=>{if(t&&(0,o.e)(t)&&t.media)return(0,l.c)([fe(e,t.media),!(0,o.k)(t)&&e.table.getChatInTransaction(t.chat),!(0,o.k)(t)&&e.table.isChatEphemeral(t.chat)]).then(e=>{var n=a()(e,3),r=n[0],i=n[1],s=n[2];if(r){if((0,o.k)(t))return{type:"status",msg:t,media:r};if(i)return{type:"chat",jid:i.jid,msg:t,media:r,fromEphemeralChat:s};__LOG__(2)`getMsgWithMedia: No chat ${t.chat} found`}else __LOG__(2)`getMsgWithMedia: No media ${t.media} found`})})}function M(e,t,n,r){var a;return a=(0,c.b)(t)?["msgs","chats","media","receipts"]:["status","media","receipts"],e.table.transact("r",a,()=>e.table.getCommonMsgFromExternalId(t,n,r).then(t=>{if(t){if((0,o.e)(t)&&t.media)return fe(e,t.media).then(e=>e?{msg:t,media:e}:(__LOG__(3)`getMediaMsgFromExternalId: no media found dbMsg.media`,null));__LOG__(3)`getMediaMsgFromExternalId: msg is not media ${t.id}`}else __LOG__(3)`getMediaMsgFromExternalId: msg was not found ${n}-${(0,I.a)(r)}`}))}function C(e,t){var n=0,r=0,a=(i,o)=>(o.length>0?(0,l.l)(e.table.stores.media,"msgIds").noneOf(o).offset(n).limit(T).toArray():e.table.stores.media.offset(n).limit(T).toArray()).then(n=>{var r=[],a=[];return n.forEach(n=>{null!=t&&(null==n.lastDownloadAttempt||n.lastDownloadAttempt>t)||null==n.frame&&null==n.plaintext||(r.push((0,b.getChunkTable)().dexieDeleteAllByMedia(n.mediaId)),a.push((function(e,t){var n=!1;if(null!=t.frame&&(t.frame=void 0,n=!0),null!=t.plaintext&&(t.plaintext=void 0,n=!0),n)return e.table.transact("rw",["msgs","media","status"],()=>{var n=ge(e,t.msgIds,e=>{ye(e)});return(0,l.c)([n,ve(e,t)]).then(()=>{})})})(e,n)))}),(0,l.c)(r).then(()=>({resultLength:n.length,unlinkPromises:a}))}).then(e=>{var t=e.resultLength,n=e.unlinkPromises;return r+=n.length,Promise.all(n).then(()=>t)}).then(e=>{if(e===T)return n+=T,a(25,o)}).catch(e=>{if(!e||"QuotaExceededError"!==e.name&&"AbortError"!==e.name)throw e;if(i>0)return(0,s.a)(1e3).then(()=>a(i-1,o))});return(0,l.i)(e.table.getAllStarredMsgIdsInTransaction().then(e=>a(25,e).then(()=>{if(0===r)return __LOG__(2)`deleteAllMedia removing starred media to free storage space`,n=0,a(25,[])})).then(()=>(function(e){return(0,y.d)(e.table.stores.meta,y.a.RECENT_GIFS).then(t=>{if(t){var n=t.value,r=n.recentGifs,a=n.toDelete;return r.forEach(e=>{var t=e.plaintextHash;null!=e.contentPath&&a.push(e.contentPath),r.set(t,(0,m.j)(e,{contentPath:void 0,info:void 0}))}),e.table.stores.meta.put({key:y.a.RECENT_GIFS,value:{recentGifs:r,toDelete:a}}).then(()=>{})}})})(e)))}function R(e,t,n,r){return e.table.transact("rw",["media"],()=>fe(e,t).then(a=>{if(a){if(a.msgIds.includes(n))return a.mediaEntries[n]=r,ve(e,a).then(()=>{});__LOG__(3)`setMediaEntry: msg ${n} is not linked with media ${t}`}else __LOG__(3)`setMediaEntry: Media ${t} does no longer exist`}))}function N(e,t,n,r){return e.table.transact("rw",["media"],()=>fe(e,t).then(a=>{if(a)if(a.msgIds.includes(n)){var i=a.mediaEntries[n];if(i)if("mms4"===i.version){if(null!=i.uploadToken)return i.validatedTs=r,ve(e,a).then(()=>{});__LOG__(4)`markMediaEntryValid: ${n} entry is not an upload`}else __LOG__(4)`markMediaEntryValid: msg ${n} entry is not mms4`;else __LOG__(3)`markMediaEntryValid: msg ${n} has no entry for media ${t}`}else __LOG__(3)`markMediaEntryValid: msg ${n} is not linked with media ${t}`;else __LOG__(3)`markMediaEntryValid: Media ${t} does no longer exist`}))}function k(e,t,n,r,a,i){return e.table.transact("rw",["media"],()=>fe(e,t).then(s=>{if(s)if(s.msgIds.includes(n)){var o=s.mediaEntries[n];if(o)if("mms4"===o.version){if(void 0!==o.uploadToken)return r&&!o.directPath&&(o.directPath=r),a&&!o.url&&(o.url=a),i&&(o.validatedTs=i),ve(e,s).then(()=>{});__LOG__(4)`Msg ${n} entry is not upload`}else __LOG__(4)`Msg ${n} entry is not mms4`;else __LOG__(3)`Msg ${n} has no entry for media ${t}`}else __LOG__(3)`Msg ${n} is not linked with media ${t}`;else __LOG__(3)`Media ${t} does no longer exist`}))}function P(e,t,n,r){return e.table.transact("rw",["media"],()=>fe(e,t).then(a=>{if(a)if(a.msgIds.includes(n)){var i=a.mediaEntries[n];if(i)if("mms4"===i.version)if(void 0!==i.uploadToken){if(void 0===i.mmsThumb)return i.mmsThumb={ciphertextHash:r},ve(e,a).then(()=>{});__LOG__(3)`Entry for ${n} already have mmsThumb info`}else __LOG__(4)`Msg ${n} entry is not upload`;else __LOG__(4)`Msg ${n} entry is not mms4`;else __LOG__(3)`Msg ${n} has no entry for media ${t}`}else __LOG__(3)`Msg ${n} is not linked with media ${t}`;else __LOG__(3)`Media ${t} does no longer exist`}))}function G(e,t,n,r){return e.table.transact("rw",["media"],()=>fe(e,t).then(a=>{if(a)if(a.msgIds.includes(n)){var i=a.mediaEntries[n];if(i)if("mms4"===i.version)if(void 0!==i.uploadToken){if(void 0!==i.mmsThumb)return i.mmsThumb.directPath=r,ve(e,a).then(()=>{});__LOG__(4)`Tried to set mms thumb path without hash`}else __LOG__(4)`Msg ${n} entry is not upload`;else __LOG__(4)`Msg ${n} entry is not mms4`;else __LOG__(3)`Msg ${n} has no entry for media ${t}`}else __LOG__(3)`Msg ${n} is not linked with media ${t}`;else __LOG__(3)`Media ${t} does no longer exist`}))}function L(e,t,n){return __LOG__(2)`updateMediaPlaintext(mediaId=${t}, plaintext=${n})`,e.table.transact("rw",["msgs","media","meta","status"],()=>fe(e,t).then(r=>{if(!r)return __LOG__(2)`updateMediaPlaintext: non-existent id ${t}`,[];if(r.plaintext===n)return __LOG__(3)`updateMediaPlaintext: Tried to update to same plaintext`,[];r.plaintext=n;var i=ge(e,r.msgIds,e=>{e.plaintext&&r.plaintext&&(e.plaintext=(0,_.d)(r.plaintext,(0,g.g)(e)))});return(0,l.c)([i,ve(e,r)]).then(e=>a()(e,1)[0])}))}function D(e,t){return e.table.transact("rw",["msgs","media","meta","chats","status","groups","contacts"],()=>O(e,t).then(n=>{if(n){var r=n.media,a=n.msg,i=r.plaintext;if(i){var s=(0,_.d)(i,(0,g.g)(a));return a.plaintext&&(__LOG__(2)`attachMediaPlaintext msg already have plaintext ref ${a.plaintext}`,a.plaintext!==s&&(__LOG__(4)`attachMediaPlaintext msg plaintext is different than media ${a.plaintext} - ${s}`,SEND_LOGS("msg-media-plaintext-mismatch"))),ge(e,r.msgIds,e=>{e.plaintext=s})}__LOG__(3)`attachMediaPlaintext media have no plaintext ref`}else __LOG__(3)`attachMediaPlaintext media for msg is gone ${t}`}))}function x(e,t,n){return __LOG__(2)`setUndefinedMediaFields(mediaId=${t}, fieldsToSet=${n})`,e.table.transact("rw",["msgs","media","meta","status"],()=>fe(e,t).then(r=>{if(!r)return __LOG__(2)`setUndefinedMediaFields: non-existent id ${t}`,e.table.stores.meta.put(W(t,null)).then(()=>[]);if(!(0,m.f)(r,n))return __LOG__(2)`setUndefinedMediaFields: mediaId ${t} nothing changed/nothing to set`,[];var i=ge(e,r.msgIds,e=>{be(e,r)});return(0,l.c)([i,ve(e,r)]).then(e=>a()(e,1)[0])}))}function U(e,t,n){return __LOG__(2)`setMediaProgressiveDetails(mediaId=${t}, progressiveDetails: ${!!n})`,e.table.transact("rw",["media"],()=>fe(e,t).then(r=>{if(r)return n?(r.partialPlaintextHash=n.partialPlaintextHash,r.partialSize=n.partialSize,r.progressiveJpegScanNumber=n.progressiveJpegScanNumber,ve(e,r).then(()=>{})):(delete r.partialPlaintextHash,delete r.partialSize,delete r.progressiveJpegScanNumber,ve(e,r).then(()=>{}));__LOG__(3)`setMediaProgressiveDetails media ${t} not found`}))}function F(e,t,n,r){return __LOG__(2)`setMediaPlaintext(mediaId=${t}, plaintext=${n})`,e.table.transact("rw",["msgs","media","meta","status"],()=>fe(e,t).then(i=>{if(!i)return __LOG__(2)`setMediaPlaintext: non-existent id ${t}`,e.table.stores.meta.put(W(t,null)).then(()=>{});if(!i.plaintext){i.plaintext=n;var s=ge(e,i.msgIds,e=>{"save"===r&&(e.plaintext=(0,_.d)(n,(0,g.g)(e)))});return(0,l.c)([s,ve(e,i)]).then(e=>{var t=a()(e,1)[0];return{dbMedia:i,dbMsgs:t}})}__LOG__(2)`setMediaPlaintext: mediaId ${t} already have plaintext ${i.plaintext}`}))}function B(e,t){return e.table.transact("rw",["msgs","media","status"],()=>j(e,t).then(n=>{if(!n)return __LOG__(2)`markMediaContentAsDeleted: non-existent media for msg ${t}`,[];if(!n.plaintext)return[];delete n.plaintext;var r=ge(e,n.msgIds,e=>{delete e.plaintext});return(0,l.c)([r,ve(e,n)]).then(e=>a()(e,1)[0])}))}function j(e,t){return e.table.getCommonMsg(t).then(n=>n&&(0,o.e)(n)&&n.media?fe(e,n.media):(__LOG__(2)`getMediaFromMsgId: message ${t} is not valid media message`,null))}function V(e,t){return __LOG__(2)`updateLastDownloadAttempt(mediaId=${t})`,e.table.transact("rw",["media"],()=>fe(e,t).then(t=>t?(t.lastDownloadAttempt=(0,E.E)(),ve(e,t).then(e=>t)):(__LOG__(3)`Tried to update download attempt for non-existing media`,null)))}function K(e,t){return __LOG__(2)`updateLastUploadAttempt(mediaId=${t})`,e.table.transact("rw",["media"],()=>fe(e,t).then(n=>n?(n.lastUploadAttempt=(0,E.E)(),ve(e,n).then(e=>n)):(__LOG__(4)`Tried to update upload attempt for non-existing media ${t}`,null)))}function H(e,t,n){return __LOG__(2)`resetMediaDirectPath(mediaId=${n})`,e.table.transact("rw",["media"],()=>fe(e,n).then(r=>{if(r){var a=r.mediaEntries[t];if(a){if("mms3"!==a.version){var i=(0,m.u)(a);return delete i.directPath,r.mediaEntries[t]=i,ve(e,r).then(()=>{})}__LOG__(4)`reset media msg ${t} entry is not upload`}else __LOG__(3)`Media ${n} does not have media entry for message ${t}`}else __LOG__(4)`Tried to reset media direct path for non-existing media ${n}`}))}function $(e,t,n){return e.table.transact("rw",["msgs","media"],()=>fe(e,t).then(r=>r?n===r.filesystemPath?(__LOG__(3)`setMediaFilesystemPath: path unchanged ${n}`,n):ve(e,Object.assign({},r,{filesystemPath:n})).then(()=>n):(__LOG__(2)`setMediaFilesystemPath non-existent media id ${t}`,null)))}function q(e,t,n,r){return e.table.transact("rw",["status","msgs","media","previews"],()=>e.table.getCommonMsg(t).then(t=>{if(t&&(0,o.e)(t))return null!=t.media?me(e,t.media).then(e=>({dbMsg:t,dbMedia:e})):Q(e,t.id,t.type,n,null,r,null).then(n=>{var r,a=n.dbMedia,i=n.hasPreview;return null==a.uiVCards&&(0,o.d)(t)&&void 0!==t.uiVCards&&(a.uiVCards=t.uiVCards,a.contactsCount=t.contactsCount,r=ve(e,a)),be(t,a),i&&(0,o.f)(t)&&("mms"===i&&(0,u.g)(t)?t.hasPreview="mms":"media"===i&&(t.hasPreview="media")),(0,l.c)([r,e.table.putCommonMsg(t)]).then(()=>a?{dbMsg:t,dbMedia:a}:null)});__LOG__(2)`attachHashToMsgMedia msg deleted or changed away from media`}))}function z(e,t,n){var r=[],a=new Set;return t.forEach(e=>{null!=e.media&&(r.push(e.media),a.add(e.id))}),__LOG__(2)`unlinkMsgsMediaInTransaction: msgs ${t.map(e=>e.id)}`,(function(e,t){return e.media.where("mediaId").anyOf(t).toArray()})(e,r).then(t=>J(e,t,e=>a.has(e),n))}function J(e,t,n,r){__LOG__(2)`unlinkMediaInTransaction: media ids ${t.map(e=>e.mediaId)}`;var a=[],i=[];t.forEach(e=>{var t=(0,h.f)(),r={};if(e.msgIds.forEach(a=>{if(!n(a)){t.push(a);var i=e.mediaEntries[a];i&&(r[a]=i)}}),(0,h.i)(t))a.push(e);else{var s=(0,m.j)(e,{msgIds:t,mediaEntries:r});i.push(s)}});var s={size:0,numFiles:0};return r||a.forEach(e=>{e.filesystemPath&&(s.size+=(0,v.f)(e),s.numFiles++)}),(0,l.c)([a.length>0?Y(e,a,r):null,i.length>0?e.media.bulkPut(i):null]).then(()=>s)}function Y(e,t,n){var r=t.map(e=>{var t;return!e.filesystemPath||!(0,S.k)(e.filesystemPath)&&n||(t=e.filesystemPath),W(e.mediaId,t)}),a=[],i=[];return t.forEach(e=>{i.push(e.mediaId),a.push((0,p.C)(e.mediaId),(0,p.B)(e.mediaId))}),(0,l.c)([e.media.bulkDelete(i),e.previews.bulkDelete(a),e.meta.bulkPut(r)])}function W(e,t){return{key:(0,y.b)(e),value:{id:e,fsPath:t}}}function Z(e,t,n,r){var a=(0,m.u)(n);if((0,o.e)(a)){var i=r.plaintextHash;return null==i?(0,l.e)({toStore:a}):Q(e,t,a.type,i,r.entry,r.preview,r.mmsThumbInfo,r.stickerInfo).then(e=>{var t=e.dbMedia,n=e.hasPreview;return be(a,t),t.plaintext&&(a.plaintext=(0,_.d)(t.plaintext,(0,g.g)(a))),n&&(0,o.f)(a)&&("mms"===n&&(0,u.g)(a)?a.hasPreview="mms":"media"===n&&(a.hasPreview="media")),{toStore:a}})}return r.preview&&(0,o.h)(a)?X(e,t,r.preview).then(()=>(a.hasPreview="msg",{toStore:a})):(0,l.e)({toStore:a})}function Q(e,t,n,r,a,i,s,o){return(function(e,t){return e.table.stores.media.where("plaintextHash").equals(t).toArray().then(e=>e.length?e[0]:null)})(e,r).then(u=>{if(u){__LOG__(2)`linkMediaAndPreview: link ${t} with stored media ${u.mediaId} with entry ${!!a}`;var d,c,f=t,m=a?Object.assign({},u.mediaEntries,{[f]:a}):u.mediaEntries,v=Object.assign({},u,{msgIds:(0,h.a)(u.msgIds,t),mediaEntries:m,types:u.types|(0,g.h)(n)});if(s&&null==u.mmsThumb){var _={thumbPlaintextHash:s.hash};if(s.blob){var E=s.blob;d=X(e,(0,p.B)(u.mediaId),E),_.hasPreview="mms"}v.mmsThumb=_}return null!=o&&(null==v.stickerInfo&&(v.stickerInfo={}),null!=o.firstFrameLength&&(null==(c=u.stickerInfo)?void 0:c.firstFrameLength)!==o.firstFrameLength&&(v.stickerInfo.firstFrameLength=o.firstFrameLength),null!=o.firstFrameSidecar&&(v.stickerInfo.firstFrameSidecar=o.firstFrameSidecar)),(0,l.c)([e.table.stores.media.put(v),d]).then(()=>{var e;return(null==(e=v.mmsThumb)?void 0:e.hasPreview)?{dbMedia:v,hasPreview:"mms"}:{dbMedia:v,hasPreview:null!=i?"media":void 0}})}__LOG__(2)`linkMediaAndPreview: creating new media for ${t} with entry ${!!a}`;var b={};a&&(b[t]=a);var y={plaintextHash:r,msgIds:(0,h.l)(t),mediaEntries:b,types:(0,g.h)(n)};if(s){var S={thumbPlaintextHash:s.hash};s.blob&&(S.hasPreview="mms"),y.mmsThumb=S}return null!=o&&(y.stickerInfo={},null!=o.firstFrameLength&&(y.stickerInfo.firstFrameLength=o.firstFrameLength),null!=o.firstFrameSidecar&&(y.stickerInfo.firstFrameSidecar=o.firstFrameSidecar)),e.table.stores.media.add(y).then(t=>{var n,r,a,o=Object.assign({},y,{mediaId:t});if(i&&(__LOG__(2)`linkMediaAndPreview: new media ${o.mediaId} comes with preview, storing.`,n=X(e,(0,p.C)(t),i),a="media"),s&&s.blob){var u=s.blob;r=X(e,(0,p.B)(t),u),a="mms"}return(0,l.c)([n,r]).then(()=>({dbMedia:o,hasPreview:a}))})})}function X(e,t,n){return n?e.table.stores.previews.put({previewId:t,preview:new Blob([n],{type:"image/jpeg"})}).then(()=>!0):e.table.stores.previews.delete(t).then(()=>!1)}function ee(e,t){__LOG__(2)`markMmsMediaPreviewForMsg for ${t}`;var n="chat"===(0,p.z)(t).type?["msgs"]:["status"];return e.table.transact("rw",n,()=>e.table.getCommonMsg(t).then(t=>{if(t&&(0,o.j)(t)&&(0,o.e)(t)&&(0,u.g)(t))return t.hasPreview="mms",e.table.putCommonMsg(t)}))}function te(e,t){return(0,l.i)(e.table.stores.previews.get((0,p.B)(t)).then(e=>null!=e))}function ne(e,t){return e.table.transact("r",["msgs","previews","status"],()=>{var n=(0,p.z)(t);return(0,l.c)([e.table.getCommonMsg(t).then(t=>t?ae(e,t):null),"chat"===n.type?e.table.stores.previews.get((0,p.F)(n.msgId)).then(e=>null==e?void 0:e.preview):null]).then(e=>{var t=a()(e,2);return{msg:t[0],quote:t[1]}})})}function re(e,t){return e.table.transact("r",["msgs","status","previews"],()=>e.table.getCommonMsg(t).then(n=>{if(n)return ae(e,n);__LOG__(3)`getMsgPreview no msg found ${t}`}))}function ae(e,t){return t.hasPreview?((0,o.f)(t)?n=(0,o.b)(t):(0,o.h)(t)&&(n=(0,o.c)(t)),n?e.table.stores.previews.get(n).then(e=>null==e?void 0:e.preview):(0,l.e)()):(0,l.e)();var n}function ie(e,t,n,r,a){return e.table.transact("rw",["msgs","media","status","previews"],()=>e.table.getCommonMsg(t).then(i=>{if(i&&"media"===i.hasPreview){var s=i.media;if(s)return fe(e,s).then(t=>{if(t)return t.mmsThumb={thumbPlaintextHash:n,hasPreview:"mms"},(0,l.c)([ve(e,t),X(e,(0,p.B)(s),a.blob),"skip"!==r?X(e,(0,p.C)(s),r):null]).then(()=>(0,l.c)(ge(e,t.msgIds,e=>{(0,u.g)(e)&&(e.hasPreview="mms",(0,u.a)(e)&&null!=a.height&&null!=a.width&&(e.mmsThumb={height:a.height,width:a.width}))}))).then(()=>{});__LOG__(3)`saveMediaThumbs no media found ${s}`});__LOG__(3)`saveMediaThumbs invalid non-media msg ${t}`}else __LOG__(3)`saveMediaThumbs no msg with 'media' preview found ${t}`}))}function se(e,t){return e.table.transact("rw",["msgs","status","media"],()=>fe(e,t).then(n=>{if(n){var r=(0,E.E)();n.lastThumbDownloadAttempt=r;var i=ge(e,n.msgIds,e=>{(0,u.a)(e)&&e.mmsThumb&&(e.mmsThumb.lastThumbDownloadAttempt=r)});return(0,l.c)([i,ve(e,n)]).then(e=>{var t=a()(e,1)[0];return{dbMedia:n,dbMsgs:t}})}__LOG__(2)`updateMmsThumbLastDownloadAttempt non-existent media id ${t}`}))}function oe(e,t,n,r){return e.table.transact("rw",["msgs","media","previews","status","authors"],()=>fe(e,t).then(i=>{if(!i)return __LOG__(2)`saveDownloadedMediaMMSPreview non-existent media id ${t}`,{dbMsgs:[]};if(i.mmsThumb&&i.mmsThumb.thumbPlaintextHash!==r)return __LOG__(4)`saveDownloadedMediaMMSPreview: unexpected thumb plaintext hash changed`,{dbMsgs:[]};var s=null!=i.mmsThumb?i.mmsThumb:{thumbPlaintextHash:r};i.mmsThumb=Object.assign({},s,{hasPreview:"mms"});var d=ge(e,i.msgIds,e=>{(0,u.g)(e)&&(e.hasPreview="mms")});return(0,l.c)([d,ve(e,i),X(e,(0,p.B)(t),n)]).then(t=>{var n=a()(t,1)[0],r=new Set,i={};return n.forEach(e=>{(0,o.k)(e)&&(r.add((0,p.t)(e.id)),i[e.id]=e)}),0===r.size?{dbMsgs:n}:e.table.stores.authors.where("id").anyOf(Array.from(r)).toArray().then(t=>{var r=[];return t.forEach(e=>{var t,n=null==(t=e.previewMsg)?void 0:t.id;if(n){var a=i[n];a&&(e.previewMsg=(0,f.a)(a)||void 0,r.push(e))}}),r.length>0?e.table.stores.authors.bulkPut(r).then(()=>({dbMsgs:n,dbAuthors:t})):{dbMsgs:n,dbAuthors:t}})})}))}function ue(e){return(0,y.c)(e.table.stores.meta,10).then(e=>({media:e.map(e=>"object"==typeof e.value?e.value:{id:e.value,fsPath:null}),maybeMore:10===e.length}))}function de(e,t){return e.table.stores.meta.delete((0,y.b)(t))}function ce(e,t,n){return n?e.table.transact("rw",["status","authors"],()=>(0,l.c)([e.table.stores.status.where("id").equals(t).first(),e.table.stores.authors.get((0,p.t)(t))]).then(r=>{var i=a()(r,2),s=i[0],u=i[1];if(s)if(u){var d=!1;if((0,o.j)(s)&&n&&(s.bg=n,d=!0),d)return e.table.stores.status.put(s).then(()=>{var t=(function(e,t){if(e.previewMsg&&e.previewMsg.id===t.id){var n=(0,f.a)(t)||void 0;return Object.assign({},e,{previewMsg:n})}return e})(u,s);return e.table.stores.authors.put(t).then(()=>({updatedMsg:s,updatedAuthor:t}))});__LOG__(2)`setStatusMsgBg: No update required for ${t}`}else __LOG__(3)`setStatusMsgBg: no author for ${t}`;else __LOG__(3)`setStatusMsgBg: No status msg found ${t}`})):Promise.resolve()}function le(e,t,n,r){return n||r?e.table.transact("rw",["msgs"],()=>e.table.getMsgFromId(t).then(a=>{if(a){var i=!1;if((0,o.j)(a)&&n&&(a.bg=n,i=!0),r&&a.quoted&&a.quoted.hasPreview&&(a.quoted.bg=r,i=!0),i)return e.table.stores.msgs.put(a).then(()=>({updatedMsg:a}));__LOG__(2)`setChatMsgBgs: No update required for ${t}`}else __LOG__(3)`setChatMsgBgs: No chat msg found ${t}`})):Promise.resolve()}function pe(e,t,n){return e.table.transact("rw",["msgs","media","chats","groups","groupParticipantsInfo"],()=>fe(e,t).then(r=>{if(r){var s=(0,d.e)(n),u=n.length;r.uiVCards=s,r.contactsCount=u;var c=ge(e,r.msgIds,e=>{e.type===i.f.DOCUMENT&&e.isVCard&&(e.uiVCards=s,e.contactsCount=u)});return(0,l.c)([c,ve(e,r)]).then(n=>{var r=a()(n,1)[0],i=[],s=[];return r.forEach(n=>{(0,o.k)(n)?__LOG__(4)`saveDocumentMediaVCards non media message found ${t}: ${n.id}`:(s.push(n),i.push(e.table.getChatAndGroupFromId(n.chat).then(t=>{if(t){var r=t.dbChat,a=t.dbGroup;return(0,v.g)(r,n)?e.table.updateChat(r).then(()=>({dbChat:r,dbGroup:a})):t}})))}),(0,l.c)(i).then(e=>({updatedChats:e.filter(Boolean),updatedMsgs:s}))})}__LOG__(2)`saveDocumentVCards: media ${t} gone`}))}function he(e,t){return e.table.transact("r",["msgs","status","media"],()=>e.table.getCommonMsg(t).then(n=>{if(n&&n.media)return fe(e,n.media).then(e=>{if(e){var n=e.mediaEntries[t];if(n&&"mms4"===n.version&&null!=n.mediaKeyTs)return{mediaId:e.mediaId,likelyOnServerFrom:n.validatedTs||n.mediaKeyTs}}})}))}function fe(e,t){return e.table.stores.media.get(t)}function me(e,t){return e.table.stores.media.get(t).then(e=>{if(!e)throw __LOG__(4)`Media ${t} is not in db`,new Error("The media is not in db");return e})}function ve(e,t){return e.table.stores.media.put(t)}function ge(e,t,n){var r=[],i=[];return t.forEach(e=>{var t=(0,p.z)(e);"chat"===t.type?r.push(t.msgId):i.push(t.msgId)}),(0,l.c)([_e(e,r,n),Ee(e,i,n)]).then(e=>{var t=a()(e,2),n=t[0],r=t[1];return n.concat(r)})}function _e(e,t,n){return 0===t.length?(0,l.e)([]):e.table.getAllMsgsFromIds(t).then(t=>{var r=[];return t.forEach(e=>{(0,o.e)(e)&&(n(e),r.push(e))}),e.table.stores.msgs.bulkPut(r).then(()=>r)})}function Ee(e,t,n){return 0===t.length?(0,l.e)([]):e.table.stores.status.where("id").anyOf(t).toArray().then(t=>{var r=[];return t.forEach(e=>{(0,o.e)(e)&&(n(e),r.push(e))}),e.table.stores.status.bulkPut(r).then(()=>r)})}function be(e,t){e.media=t.mediaId,(0,o.m)(e)&&null!=t.frame&&(e.frame=t.frame),(0,o.n)(e)&&(null!=t.frame&&(e.frame=t.frame),null!=t.rotation&&(e.rotation=t.rotation)),(0,o.d)(e)&&(null!=t.uiVCards&&(e.uiVCards=t.uiVCards),null!=t.contactsCount&&(e.contactsCount=t.contactsCount))}function ye(e){null!=e.plaintext&&(e.plaintext=void 0),(0,o.n)(e)&&null!=e.frame&&(e.frame=void 0)}},,,,function(e,t,n){n.d(t,"a",(function(){return a}));var r=n(244),a=class{constructor(e,t){this.BG=e,this.BH=t}parse(e){var t=new r.a(this.BG,e);try{return{success:this.BH(t)}}catch(e){if(e instanceof r.b)return{error:e};throw e}}parseOrThrow(e){var t=this.parse(e);if(t.error)throw new Error(String(t.error));return t.success}}},function(e,t,n){n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var r={SUCCESS:0,ERR_NOMEM:-12,ERR_INVAL:-22,ERR_UNKNOWN:-1e3,ERR_DUPLICATE_MESSAGE:-1001,ERR_INVALID_KEY:-1002,ERR_INVALID_KEY_ID:-1003,ERR_INVALID_MAC:-1004,ERR_INVALID_MESSAGE:-1005,ERR_INVALID_VERSION:-1006,ERR_LEGACY_MESSAGE:-1007,ERR_NO_SESSION:-1008,ERR_STALE_KEY_EXCHANGE:-1009,ERR_UNTRUSTED_IDENTITY:-1010,ERR_VRF_SIG_VERIF_FAILED:-1011,ERR_INVALID_PROTO_BUF:-1100,ERR_FP_VERSION_MISMATCH:-1200,ERR_FP_IDENT_MISMATCH:-1201,ERR_INVALID_SIGNED_PRE_KEY:-1300,ERR_SIGNED_PRE_KEY_ID_MISMATCH:-1301,ERR_INVALID_ONE_TIME_KEY:-1302,ERR_SIGNED_PRE_KEY_DESERIALIZATION:-1303,ERR_ONE_TIME_KEY_ID_MISMATCH:-1304,ERR_ONE_TIME_KEY_DESERIALIZATION:-1305,ERR_DECRYPTION_FAILED:-1306,ERR_DESERIALIZE_INVALID_PROTO_FORMAT:-1307,ERR_DESERIALIZE_RATCHET_KEY_BAD_FORMAT:-1308,ERR_DESERIALIZE_PK_INVALID_PROTO_FORMAT:-1309,ERR_DESERIALZE_PK_KEY_BAD_FORMAT:-1310,ERR_TOO_MANY_MESSAGES_IN_FUTURE:-1311,ERR_EMPTY_VERSION_CONTENT_SUFFIX:-1312,ERR_CONTENT_EXCEEDED_EXPECTED_LENGTH:-1313,ERR_GRP_INVALID_PROTO_FORMAT:-1314,ERR_GRP_INVALID_KEY_FORMAT:-1315,ERR_GRP_VERSION_CONTENT_EMPTY:-1316,ERR_GRP_INVALID_VERSION_CONTENT_LENGTH:-1317,ERR_GRP_SENDER_KEY_INVALID_PROTO_FORMAT:-1318,ERR_GRP_SENDER_KEY_PROTO_ERROR:-1319,ERR_GRP_TOO_MANY_MESSAGES_IN_FUTURE:-1320},a={errSignalNoSession:r.ERR_NO_SESSION,errSignalInvalidMsg:r.ERR_INVALID_MESSAGE,errSignalInvalidVersion:r.ERR_INVALID_VERSION,errSignalLegacyMsg:r.ERR_LEGACY_MESSAGE,errDuplicateMsg:r.ERR_DUPLICATE_MESSAGE,errSignalInvalidKey:r.ERR_INVALID_KEY,errSignalInvalidKeyId:r.ERR_INVALID_KEY_ID,errSignalInvalidSignedPreKey:r.ERR_INVALID_SIGNED_PRE_KEY,errSignalSignedPreKeyIdMismatch:r.ERR_SIGNED_PRE_KEY_ID_MISMATCH,errSignalSignedPreKeyDeserialization:r.ERR_SIGNED_PRE_KEY_DESERIALIZATION,errSignalInvalidOneTimeKey:r.ERR_INVALID_ONE_TIME_KEY,errSignalOneTimeKeyMismatch:r.ERR_ONE_TIME_KEY_ID_MISMATCH,errSignalOneTimeKeyDeserialization:r.ERR_ONE_TIME_KEY_DESERIALIZATION,errInvalidMac:r.ERR_INVALID_MAC,errRequestKeysNoKeys:r.ERR_NO_SESSION,errRequestKeysParsingFailed:r.ERR_UNKNOWN,errSignalDecryptionFailed:r.ERR_DECRYPTION_FAILED,errSignalDeserializeInvalidProtoFormat:r.ERR_DESERIALIZE_INVALID_PROTO_FORMAT,errSignalDeserializeRatchetKeyBadFormat:r.ERR_DESERIALIZE_RATCHET_KEY_BAD_FORMAT,errSignalDeserializePkInvalidProtoFormat:r.ERR_DESERIALIZE_PK_INVALID_PROTO_FORMAT,errSignalDeserializePkKeyBadFormat:r.ERR_DESERIALZE_PK_KEY_BAD_FORMAT,errSignalTooManyMessagesInFuture:r.ERR_TOO_MANY_MESSAGES_IN_FUTURE,errSignalEmptyVersionContentSuffix:r.ERR_EMPTY_VERSION_CONTENT_SUFFIX,errSignalContentExceededExpectedLength:r.ERR_CONTENT_EXCEEDED_EXPECTED_LENGTH,errSignalGrpInvalidProtoFormat:r.ERR_GRP_INVALID_PROTO_FORMAT,errSignalGrpInvalidKeyFormat:r.ERR_GRP_INVALID_KEY_FORMAT,errSignalGrpVersionContentEmpty:r.ERR_GRP_VERSION_CONTENT_EMPTY,errSignalGrpInvalidVersionContentLength:r.ERR_GRP_INVALID_VERSION_CONTENT_LENGTH,errSignalGrpSenderKeyInvalidProtoFormat:r.ERR_GRP_SENDER_KEY_INVALID_PROTO_FORMAT,errSignalGrpSenderKeyProtoError:r.ERR_GRP_SENDER_KEY_PROTO_ERROR,errSignalGrpTooManyMessagesInFuture:r.ERR_GRP_TOO_MANY_MESSAGES_IN_FUTURE,errTooManySessionSaveRetries:r.ERR_NO_SESSION,errCryptoDeserialization:r.ERR_DECRYPTION_FAILED,errLoadSenderKeySession:r.ERR_NO_SESSION}},,,,,,function(e,t,n){n.d(t,"a",(function(){return C})),n.d(t,"v",(function(){return R})),n.d(t,"k",(function(){return N})),n.d(t,"t",(function(){return P})),n.d(t,"i",(function(){return G})),n.d(t,"q",(function(){return L})),n.d(t,"p",(function(){return D})),n.d(t,"r",(function(){return x})),n.d(t,"e",(function(){return U})),n.d(t,"b",(function(){return F})),n.d(t,"o",(function(){return B})),n.d(t,"c",(function(){return j})),n.d(t,"m",(function(){return V})),n.d(t,"d",(function(){return K})),n.d(t,"s",(function(){return $})),n.d(t,"f",(function(){return z})),n.d(t,"h",(function(){return J})),n.d(t,"g",(function(){return Y})),n.d(t,"j",(function(){return Z})),n.d(t,"u",(function(){return Q})),n.d(t,"x",(function(){return X})),n.d(t,"w",(function(){return ee})),n.d(t,"l",(function(){return te})),n.d(t,"n",(function(){return ne}));var r=n(27),a=n.n(r),i=n(9),s=n.n(i),o=n(34),u=n(59),d=n(10),c=n(51),l=n(5),p=n(7),h=n(2),f=n(6),m=n(58),v=n(31),g=n.n(v),_=n(3),E=n(24),b=n(36),y=n(40),S=n(26),I=n(141),w=n(39),T=n(97),A=n(23),O=n(104),M=n(14),C={PRECIOUS:4,SIGNIFICANT:3,NOTEWORTHY:2,UNINTERESTING:1,GARBAGE:0};function R(e,t){return e.type!==h.f.BUSINESS_NOTIFICATION}function N(e){return e.type===h.f.GROUP_NOTIFICATION?(function(e,t,n){switch(e){case"add":return t&&!n?C.SIGNIFICANT:C.UNINTERESTING;case"remove":return t&&!n?C.NOTEWORTHY:C.UNINTERESTING;case"subject":return C.NOTEWORTHY;case"create":return n?C.NOTEWORTHY:C.SIGNIFICANT;case"announcement":case"not_announcement":case"promote":case"demote":case"invite":case"accept":case"leave":case"modify":case"description":case"description_remove":case"revoke_invite":case"delete":case"closed":case"picture":case"picture_remove":case"restrict":case"locked":case"unlocked":case"growth_locked":case"growth_unlocked":case"ephemeral":case"ephemeral_authorless":return C.UNINTERESTING;default:return(0,g.a)(e)}})(e.subtype,!!e.involvesMe,e.author===h.b):k(e.author===h.b,e.type)}function k(e,t){switch(t){case h.f.TEXT:case h.f.IMAGE:case h.f.STICKER:case h.f.PTT:case h.f.AUDIO:case h.f.VIDEO:case h.f.GIF:case h.f.VCARD:case h.f.LOCATION:case h.f.EXTENDED_TEXT:case h.f.RICH_HSM:case h.f.HSM_BUTTON_REPLY:case h.f.DOCUMENT:return C.PRECIOUS;case h.f.FUTUREPROOF:case h.f.REVOKED:case h.f.CIPHERTEXT:case h.f.MD_PLACEHOLDER:case h.f.EPHEMERAL:return C.NOTEWORTHY;case h.f.IDENTITY_CHANGE:case h.f.PRIVACY_CHANGE:case h.f.CONTACT_BLOCK_CHANGE:return C.GARBAGE;case h.f.GROUP_NOTIFICATION:throw new Error("getWorthFromType should not be given notifications");case h.f.GROUP_INVITE:return e?C.UNINTERESTING:C.PRECIOUS;case h.f.BUSINESS_NOTIFICATION:return C.UNINTERESTING;default:return __LOG__(4)`getWorthFromType no worth assigned to ${t}`,C.GARBAGE}}function P(){return(0,b.e)((0,o.l)(7))}function G(e,t){return e.author!==h.b&&e.author!==h.c&&e.type!==h.f.GROUP_NOTIFICATION&&(null==t?k(!1,e.type):t)>=C.PRECIOUS}function L(e,t,n,r){return t&&t.pushname===r?e:e?Object.assign({},e,{pushname:r}):t?Object.assign({},t,{pushname:r}):{jid:n,pushname:r}}function D(e,t,n){return t&&t.messaged?e:e?Object.assign({},e,{messaged:!0}):t?Object.assign({},t,{messaged:!0}):{jid:n,messaged:!0}}function x(e,t,n){return t&&t.sentHsm?e:e?Object.assign({},e,{sentHsm:!0}):t?Object.assign({},t,{sentHsm:!0}):{jid:n,sentHsm:!0}}function U(e){for(var t=[],n=0;n<e.length;n++){var r=e[n];r&&(0,E.e)(r)&&t.push(r)}return t}function F(e,t){WAM.log("regular",1980,void 0,[2,0,1,3,0,t?2:1,4,0,(0,_.B)(e.ts),1,0,e.type===h.f.CIPHERTEXT?1:3])}function B(e){return e.table.transact("rw",["meta","chats","groups","contacts","groupParticipantsInfo"],()=>(0,S.d)(e.table.stores.meta,S.a.WAM_CHATS_CACHE).then(t=>{if(null==t)return __LOG__(2)`logChatMessageCountsAndPurge: Cache does not exist`,[];var n=t.value.chats,r=t.value.startTs;if(0===n.size)return __LOG__(2)`logChatMessageCountsAndPurge: no chats to log`,[];var a=[],i=[];return n.forEach((e,t)=>{i.push(t),a.push([t,e])}),e.table.getAllChatsAndGroupInfosInTransaction(i).then(t=>{var n=t.chats,o=t.groupInfos,u=new Set;return i.forEach(e=>{var t=(0,p.q)(e);t&&u.add(t)}),(0,d.x)(o).forEach(e=>{null!=e.creatorJid&&u.add(e.creatorJid)}),e.table.stores.contacts.where("jid").anyOf(Array.from(u)).toArray().then(e=>{var t=(0,d.s)(e,e=>e.jid);return a.map(e=>{var a,i,u,d,c,l,h,f,m,v,g,_=s()(e,2),E=_[0],b=_[1],S=b.sent,I=b.received,w=b.starred,T=b.ephemeralSent,M=b.ephemeralReceived,C=b.viewOnceOpened,R=b.viewOnceReceived,N=b.viewOnceSent,k=n[E];return k&&(a=null==k.mutedUntil?1:2,i=k.archived,u=k.unreadMsgCount),(0,p.x)(E,{user:e=>{var n=t[e];if(n){var r=n.ephemeral,a=n.phonebookPhone;if(d=(null==r?void 0:r.expiration)||null,c=(0,y.e)(n),l=null!=a,(0,A.a)("disappearing_mode")){var i=(0,O.b)(n,"sender-me");null!=i&&(m=i.disappearingChatInitiator,v=i.senderDefaultDisappearingDuration,g=i.receiverDefaultDisappearingDuration)}}},group:e=>{h=!0;var n=o[e];if(n){var r=n.creatorJid,a=t[r];d=n.expiration,f=n.groupSize,a&&(c=(0,y.e)(a),l=null!=a.phonebookPhone)}}}),{chatEphemeralityDuration:d,chatTypeInd:c,chatMuted:a,ephemeralMessagesSent:T,ephemeralMessagesReceived:M,isAContact:l,isAGroup:h,isArchived:i,messagesStarred:w,messagesUnread:u,messagesReceived:I,messagesSent:S,startTime:r,viewOnceMessagesOpened:C||0,viewOnceMessagesReceived:R||0,viewOnceMessagesSent:N||0,disappearingChatInitiator:m,senderDefaultDisappearingDuration:v,receiverDefaultDisappearingDuration:g,groupSize:f}})})})}).then(t=>(__LOG__(2)`logChatMessageCountsAndPurge: logging ${t.length}`,t.forEach(e=>{WAM.log("regular",1644,void 0,[56,0,e.awayMsgsSent,60,0,e.bizCatalogType,65,0,e.bizConversationDepth,33,0,e.blockReason,30,0,e.broadcastMsgsReceived,29,0,e.broadcastMsgsSent,27,0,e.callOffersReceived,26,0,e.callOffersSent,70,0,e.callsResultBusy,71,0,e.callsResultCancelled,72,0,e.callsResultConnected,78,0,e.callsResultError,73,0,e.callsResultMissed,74,0,e.callsResultRejected,15,0,e.chatEphemeralityDuration,8,0,e.chatMuted,79,0,e.chatOverflowClicks,2,0,e.chatTypeInd,44,0,e.collectionInquiriesSent,41,0,e.commerceMsgsReceived,40,0,e.commerceMsgsSent,59,0,e.disappearingChatInitiator,47,2,e.entryPointConversionApp,46,2,e.entryPointConversionSource,14,0,e.ephemeralMessagesReceived,13,0,e.ephemeralMessagesSent,69,0,e.ephemeralMessagesUnreadExpired,45,0,e.fbCtaInquiriesSent,25,0,e.firstResponseTime,22,0,e.gaStatus,57,0,e.greetingMsgsSent,75,1,e.groupContainsBiz,51,0,e.groupMembershipReplies,52,0,e.groupPrivateReplies,19,0,e.groupSize,6,1,e.isAContact,5,1,e.isAGroup,10,1,e.isArchived,32,1,e.isBlocked,36,1,e.isCartAddClicked,35,1,e.isCommerceViewed,37,1,e.isCtaOnPdpClicked,54,1,e.isLabelled,62,1,e.isOppositePartyInitiated,9,1,e.isPinned,55,0,e.labelledMsgs,4,0,e.messagesReceived,3,0,e.messagesSent,12,0,e.messagesStarred,11,0,e.messagesUnread,68,1,e.newThread,38,0,e.ordersSent,39,0,e.paymentsSent,42,0,e.pdpInquiriesSent,61,0,e.pdpViews,64,0,e.profileReplies,63,0,e.profileViews,58,0,e.quickRepliesSent,21,0,e.receiverDefaultDisappearingDuration,80,0,e.repliesSent,20,0,e.senderDefaultDisappearingDuration,31,0,e.spamReports,7,0,e.startTime,50,0,e.statusReplies,49,0,e.statusViews,43,0,e.storefrontInquiriesSent,66,2,e.threadDs,67,2,e.threadId,28,0,e.totalCallDuration,76,0,e.videoCallsOffered,18,0,e.viewOnceMessagesOpened,17,0,e.viewOnceMessagesReceived,16,0,e.viewOnceMessagesSent,77,0,e.voiceCallsOffered])}),e.table.stores.meta.put({key:S.a.WAM_CHATS_CACHE,value:{startTs:(0,_.E)(),chats:new Map}}).then(()=>t.length))))}function j(e,t,n){return(0,S.d)(e.table.stores.meta,S.a.WAM_CHATS_CACHE).then(r=>{var a=V(r),i=a.startTs,s=a.chats,o=s.get(t);return o||(o={sent:0,received:0,starred:0,ephemeralSent:0,ephemeralReceived:0,viewOnceOpened:0,viewOnceReceived:0,viewOnceSent:0}),o.starred+=n,s.set(t,o),e.table.stores.meta.put({key:S.a.WAM_CHATS_CACHE,value:{startTs:i,chats:s}}).then(()=>{})})}function V(e){return e?e.value:{startTs:(0,_.E)(),chats:new Map}}function K(e,t){return H.apply(this,arguments)}function H(){return(H=a()((function*(e,t){var n=V(yield(0,l.i)((0,S.d)(e.stores.meta,S.a.WAM_CHATS_CACHE))),r=n.startTs,a=n.chats,i=yield(0,l.i)(e.getChatInTransaction(t)),s=a.get(i.jid);return s||(s={sent:0,received:0,starred:0,ephemeralSent:0,ephemeralReceived:0,viewOnceOpened:0,viewOnceReceived:0,viewOnceSent:0}),s.viewOnceOpened=(s.viewOnceOpened||0)+1,a.set(i.jid,s),e.stores.meta.put({key:S.a.WAM_CHATS_CACHE,value:{startTs:r,chats:a}}).then(()=>{})}))).apply(this,arguments)}function $(e){if(e){var t=e.filter(Boolean);if(0!==t.length){if(1===t.length)return t[0];var n=t.sort((e,t)=>t.msg.id.localeCompare(e.msg.id)),r=n[0],a=n.slice(1);return r.notifications=r.notifications?r.notifications.concat(a):[...a],r}}}function q(e,t,n,r){return(0,l.e)().then(()=>(function(e,t,n,r){var a,i,s,o,d,c=t.id;!r||"group"!==n.type&&t.bizRoleChanged||(a=(0,u.m)(t.id),i=r.oldestStarredTs),s="group"===n.type||(0,I.b)(n.dbContact)?"e2ee":(null==(o=n.dbContact.verifiedInfo)||null==(d=o.bsp)?void 0:d.host)===I.a.FB?"fb":"bsp";var l={externalId:"/privacy/"+c,ts:i||(0,_.E)(),author:h.c,ack:h.a.RECEIVED,type:h.f.PRIVACY_CHANGE,subtype:s,altIndex:""};return e.addSystemMsgToChatInTransaction(c,l,a).then(e=>[e.dbChat,e.dbMsg])})(e,n,t,r).then(e=>{var t=s()(e,2);return[t[0],[t[1]]]})).then(n=>{var r=s()(n,2),a=r[0],i=r[1];return(function(e,t,n){var r,a,i=(0,_.E)();if("group"===n.type){var s=n.initialExpiration;if("persisted"===s)return(0,l.e)([t,void 0,null]);r={type:h.f.GROUP_NOTIFICATION,subtype:"ephemeral",externalId:"/ephemeral/"+i,ts:i,author:h.c,ack:h.a.RECEIVED,expiration:s,altIndex:""}}else{n.type;var o=n.initialExpiration;if(a=n.dbContact,"persisted"===o)return(0,l.e)([t,a,null]);var u=o.expiration,d=o.initiator;a.ephemeral={expiration:u,ts:i,initiator:d};var c=d===T.a.INITIATED_BY_ME?T.a.INITIATED_BY_ME:d===T.a.INITIATED_BY_OTHER?T.a.INITIATED_BY_OTHER:void 0;r=null==c?{type:h.f.EPHEMERAL,subtype:"setting",externalId:"/ephemeral/"+i,ts:i,author:h.c,ack:h.a.RECEIVED,ephemeralExpiration:u,altIndex:""}:{type:h.f.EPHEMERAL,subtype:"default-disappearing-mode",externalId:"/ephemeral-ddm/"+i,ts:i,author:h.c,ack:h.a.RECEIVED,ephemeralExpiration:u,initiator:c,altIndex:""}}return e.addSystemMsgToChatInTransaction(t.id,r).then(e=>[e.dbChat,a,e.dbMsg])})(e,a,t).then(e=>{var t=s()(e,3),n=t[0],r=t[1],a=t[2];return[n,r,null!=a?[...i,a]:i]})})}function z(e,t,n,r){var a={jid:t.jid,msgCount:0,unreadMsgCount:0,lastNotified:null,sortBy:t.sortBy,increment:t.increment};return t.mutedUntil&&(a.mutedUntil=t.mutedUntil),t.archived&&(a.archived=!0),t.lastNotified&&(a.lastNotified=t.lastNotified),t.chatBackgroundSettings&&(a.chatBackgroundSettings=t.chatBackgroundSettings),t.notStarted&&(a.notStarted=t.notStarted),t.bizRoleChanged&&(a.bizRoleChanged=t.bizRoleChanged),e.table.stores.chats.delete(t.id).then(()=>e.table.stores.chats.add(a).then(e=>Object.assign({id:e},a)).then(t=>q(e,n,t,{oldestStarredTs:r})))}function J(e,t,n,r){return W(e,t,{type:"one-to-one",dbContact:n,initialExpiration:r}).then(e=>{var t=s()(e,3);return[t[0],t[1],t[2]]})}function Y(e,t,n){return W(e,t,{type:"group",initialExpiration:null!=n&&n>0?n:"persisted"}).then(e=>{var t=s()(e,3),n=t[0];return t[1],[n,t[2]]})}function W(e,t,n){var r={jid:t,mutedUntil:"group"===n.type?null:n.dbContact.lastMutedUntil,archived:!1,increment:0,sortBy:0,msgCount:0,unreadMsgCount:0,lastNotified:null};return(0,p.q)(t)&&(r.notStarted=!0),e.table.stores.chats.add(r).then(e=>Object.assign({id:e},r)).then(t=>q(e,n,t))}function Z(e){var t,n;if((0,y.i)(e))return"persisted";var r=f.j.get().disappearingMsgsDefaultTimer||M.i,a=null==(t=e.ephemeral)?void 0:t.expiration;if(null!=a&&a>M.i){var i,s=null==(i=e.ephemeral)?void 0:i.initiator;return{expiration:a,initiator:r===M.i&&s===T.a.INITIATED_BY_ME?T.a.CHANGED_IN_CHAT:null!=s?s:T.a.CHANGED_IN_CHAT}}if(!(0,A.a)("disappearing_mode"))return"persisted";var o=(null==(n=e.defaultDisappearingMode)?void 0:n.expiration)||M.i;return o===M.i&&r===M.i?"persisted":o===M.i?{expiration:r,initiator:T.a.INITIATED_BY_ME}:r===M.i||o<r?{expiration:o,initiator:T.a.INITIATED_BY_OTHER}:{expiration:r,initiator:T.a.INITIATED_BY_ME}}function Q(e,t,n){return{result:"new",chat:(0,c.a)(t,n),msg:(0,m.c)(e),dbMsg:e,outgoingTo:null,updatedContact:null,shouldDownloadMmsThumb:!1}}function X(e,t){var n=e.result,r=e.dbChat,a=e.dbGroup,i=e.dbMsg,s=e.notifications,o=e.outgoingTo,u=e.shouldDownloadMmsThumb;return{result:n,chat:(0,c.a)(r,a),dbMsg:i,msg:(0,m.c)(i),outgoingTo:o,notifications:s,updatedContact:t,shouldDownloadMmsThumb:u}}function ee(e,t){return{result:"new",dbMsg:e.dbMsg,chat:(0,c.a)(e.dbChat),msg:(0,m.c)(e.dbMsg),updatedContact:t,outgoingTo:null,shouldDownloadMmsThumb:!1}}function te(e,t){return{result:"new",dbMsg:e.dbMsg,chat:(0,c.a)(e.dbChat,e.dbGroup),msg:(0,m.c)(e.dbMsg),updatedContact:t,outgoingTo:null,shouldDownloadMmsThumb:!1}}function ne(e,t){return t.type!==h.f.REVOKED&&!(0,w.h)(t.ack)&&null!=(0,p.p)(e.jid)&&(null!=t.quoted&&t.quoted.author===h.b||null!=t.mentionedJids&&t.mentionedJids.includes(f.r.get()))}},,,,,,,,,function(e,t,n){n.d(t,"c",(function(){return i})),n.d(t,"d",(function(){return s})),n.d(t,"a",(function(){return u})),n.d(t,"g",(function(){return d})),n.d(t,"f",(function(){return c})),n.d(t,"e",(function(){return ee})),n.d(t,"h",(function(){return We})),n.d(t,"b",(function(){return Xe}));var r=n(0),a=n(139),i={REVOKE:0,EPHEMERAL_SETTING:3,EPHEMERAL_SYNC_RESPONSE:4,HISTORY_SYNC_NOTIFICATION:5,APP_STATE_SYNC_KEY_SHARE:6,APP_STATE_SYNC_KEY_REQUEST:7,MSG_FANOUT_BACKFILL_REQUEST:8,INITIAL_SECURITY_NOTIFICATION_SETTING_SYNC:9,APP_STATE_FATAL_EXCEPTION_NOTIFICATION:10},s={NONE:0,GIPHY:1,TENOR:2},o={DEFAULT:0,PARENT:1},u={CHANGED_IN_CHAT:0,INITIATED_BY_ME:1,INITIATED_BY_OTHER:2},d={},c={},l={},p={},h={},f={},m={},v={},g={},_={},E={},b={},y={},S={},I={},w={},T={},A={},O={},M={},C={},R={},N={},k={},P={},G={},L={},D={},x={},U={},F={},B={},j={},V={},K={},H={},$={},q={},z={},J={},Y={},W={},Z={},Q={},X={},ee={},te={},ne={},re={},ae={},ie={},se={},oe={},ue={},de={},ce={},le={},pe={},he={},fe={},me={},ve={},ge={},_e={},Ee={},be={},ye={},Se={},Ie={},we={},Te={},Ae={},Oe={},Me={},Ce={},Re={},Ne={},ke={},Pe={},Ge={},Le={},De={},xe={},Ue={},Fe={},Be={},je={},Ve={},Ke={},He={},$e={},qe={},ze={},Je={},Ye={},We={},Ze={},Qe={},Xe={},et={};d.internalSpec={conversation:[1,r.d.STRING],senderKeyDistributionMessage:[2,r.d.MESSAGE,Pe],imageMessage:[3,r.d.MESSAGE,ke],contactMessage:[4,r.d.MESSAGE,Re],locationMessage:[5,r.d.MESSAGE,Ce],extendedTextMessage:[6,r.d.MESSAGE,Me],documentMessage:[7,r.d.MESSAGE,Oe],audioMessage:[8,r.d.MESSAGE,Ae],videoMessage:[9,r.d.MESSAGE,Te],call:[10,r.d.MESSAGE,we],chat:[11,r.d.MESSAGE,Ie],protocolMessage:[12,r.d.MESSAGE,Se],contactsArrayMessage:[13,r.d.MESSAGE,pe],highlyStructuredMessage:[14,r.d.MESSAGE,se],fastRatchetKeySenderKeyDistributionMessage:[15,r.d.MESSAGE,Pe],sendPaymentMessage:[16,r.d.MESSAGE,ie],liveLocationMessage:[18,r.d.MESSAGE,ee],requestPaymentMessage:[22,r.d.MESSAGE,ae],declinePaymentRequestMessage:[23,r.d.MESSAGE,re],cancelPaymentRequestMessage:[24,r.d.MESSAGE,ne],templateMessage:[25,r.d.MESSAGE,W],stickerMessage:[26,r.d.MESSAGE,X],groupInviteMessage:[28,r.d.MESSAGE,w],templateButtonReplyMessage:[29,r.d.MESSAGE,Y],productMessage:[30,r.d.MESSAGE,q],deviceSentMessage:[31,r.d.MESSAGE,I],messageContextInfo:[35,r.d.MESSAGE,xe],listMessage:[36,r.d.MESSAGE,U],viewOnceMessage:[37,r.d.MESSAGE,S],orderMessage:[38,r.d.MESSAGE,$],listResponseMessage:[39,r.d.MESSAGE,D],ephemeralMessage:[40,r.d.MESSAGE,S],invoiceMessage:[41,r.d.MESSAGE,Ne],buttonsMessage:[42,r.d.MESSAGE,_],buttonsResponseMessage:[43,r.d.MESSAGE,g],paymentInviteMessage:[44,r.d.MESSAGE,te],interactiveMessage:[45,r.d.MESSAGE,M],reactionMessage:[46,r.d.MESSAGE,v],stickerSyncRmrMessage:[47,r.d.MESSAGE,m],interactiveResponseMessage:[48,r.d.MESSAGE,T],pollCreationMessage:[49,r.d.MESSAGE,h],pollUpdateMessage:[50,r.d.MESSAGE,p]},c.internalSpec={selectedOptions:[1,r.b.REPEATED|r.d.BYTES],senderTimestampMs:[2,r.d.INT64]},l.internalSpec={encPayload:[1,r.d.BYTES],encIv:[2,r.d.BYTES]},p.internalSpec={pollCreationMessageKey:[1,r.d.MESSAGE,a.a],vote:[2,r.d.MESSAGE,l]},h.internalSpec={encKey:[1,r.d.BYTES],name:[2,r.d.STRING],options:[3,r.b.REPEATED|r.d.MESSAGE,f],selectableOptionsCount:[4,r.d.UINT32],contextInfo:[5,r.d.MESSAGE,Ge]},f.internalSpec={optionName:[1,r.d.STRING]},m.internalSpec={filehash:[1,r.b.REPEATED|r.d.STRING],rmrSource:[2,r.d.STRING],requestTimestamp:[3,r.d.INT64]},v.internalSpec={key:[1,r.d.MESSAGE,a.a],text:[2,r.d.STRING],groupingKey:[3,r.d.STRING],senderTimestampMs:[4,r.d.INT64]},g.internalSpec={selectedButtonId:[1,r.d.STRING],selectedDisplayText:[2,r.d.STRING],contextInfo:[3,r.d.MESSAGE,Ge],type:[4,r.d.ENUM,{UNKNOWN:0,DISPLAY_TEXT:1}],__oneofs__:{response:["selectedDisplayText"]}},_.internalSpec={text:[1,r.d.STRING],documentMessage:[2,r.d.MESSAGE,Oe],imageMessage:[3,r.d.MESSAGE,ke],videoMessage:[4,r.d.MESSAGE,Te],locationMessage:[5,r.d.MESSAGE,Ce],contentText:[6,r.d.STRING],footerText:[7,r.d.STRING],contextInfo:[8,r.d.MESSAGE,Ge],buttons:[9,r.b.REPEATED|r.d.MESSAGE,E],headerType:[10,r.d.ENUM,{UNKNOWN:0,EMPTY:1,TEXT:2,DOCUMENT:3,IMAGE:4,VIDEO:5,LOCATION:6}],__oneofs__:{header:["text","documentMessage","imageMessage","videoMessage","locationMessage"]}},E.internalSpec={buttonId:[1,r.d.STRING],buttonText:[2,r.d.MESSAGE,y],type:[3,r.d.ENUM,{UNKNOWN:0,RESPONSE:1,NATIVE_FLOW:2}],nativeFlowInfo:[4,r.d.MESSAGE,b]},b.internalSpec={name:[1,r.d.STRING],paramsJson:[2,r.d.STRING]},y.internalSpec={displayText:[1,r.d.STRING]},S.internalSpec={message:[1,r.d.MESSAGE,d]},I.internalSpec={destinationJid:[1,r.d.STRING],message:[2,r.d.MESSAGE,d],phash:[3,r.d.STRING]},w.internalSpec={groupJid:[1,r.d.STRING],inviteCode:[2,r.d.STRING],inviteExpiration:[3,r.d.INT64],groupName:[4,r.d.STRING],jpegThumbnail:[5,r.d.BYTES],caption:[6,r.d.STRING],contextInfo:[7,r.d.MESSAGE,Ge],groupType:[8,r.d.ENUM,{DEFAULT:0,PARENT:1}]},T.internalSpec={body:[1,r.d.MESSAGE,O],nativeFlowResponseMessage:[2,r.d.MESSAGE,A],contextInfo:[15,r.d.MESSAGE,Ge],__oneofs__:{interactiveResponseMessage:["nativeFlowResponseMessage"]}},A.internalDefaults={version:1},A.internalSpec={name:[1,r.d.STRING],paramsJson:[2,r.d.STRING],version:[3,r.d.INT32]},O.internalSpec={text:[1,r.d.STRING]},M.internalSpec={header:[1,r.d.MESSAGE,L],body:[2,r.d.MESSAGE,G],footer:[3,r.d.MESSAGE,P],shopStorefrontMessage:[4,r.d.MESSAGE,k],collectionMessage:[5,r.d.MESSAGE,N],nativeFlowMessage:[6,r.d.MESSAGE,C],contextInfo:[15,r.d.MESSAGE,Ge],__oneofs__:{interactiveMessage:["shopStorefrontMessage","collectionMessage","nativeFlowMessage"]}},C.internalDefaults={messageVersion:1},C.internalSpec={buttons:[1,r.b.REPEATED|r.d.MESSAGE,R],messageParamsJson:[2,r.d.STRING],messageVersion:[3,r.d.INT32]},R.internalSpec={name:[1,r.d.STRING],buttonParamsJson:[2,r.d.STRING]},N.internalDefaults={messageVersion:1},N.internalSpec={bizJid:[1,r.d.STRING],id:[2,r.d.STRING],messageVersion:[3,r.d.INT32]},k.internalDefaults={messageVersion:1},k.internalSpec={id:[1,r.d.STRING],surface:[2,r.d.ENUM,{UNKNOWN_SURFACE:0,FB:1,IG:2,WA:3}],messageVersion:[3,r.d.INT32]},P.internalSpec={text:[1,r.d.STRING]},G.internalSpec={text:[1,r.d.STRING]},L.internalSpec={title:[1,r.d.STRING],subtitle:[2,r.d.STRING],documentMessage:[3,r.d.MESSAGE,Oe],imageMessage:[4,r.d.MESSAGE,ke],jpegThumbnail:[6,r.d.BYTES],videoMessage:[7,r.d.MESSAGE,Te],hasMediaAttachment:[5,r.d.BOOL],__oneofs__:{media:["documentMessage","imageMessage","jpegThumbnail","videoMessage"]}},D.internalSpec={title:[1,r.d.STRING],listType:[2,r.d.ENUM,{UNKNOWN:0,SINGLE_SELECT:1}],singleSelectReply:[3,r.d.MESSAGE,x],contextInfo:[4,r.d.MESSAGE,Ge],description:[5,r.d.STRING]},x.internalSpec={selectedRowId:[1,r.d.STRING]},U.internalSpec={title:[1,r.d.STRING],description:[2,r.d.STRING],buttonText:[3,r.d.STRING],listType:[4,r.d.ENUM,{UNKNOWN:0,SINGLE_SELECT:1,PRODUCT_LIST:2}],sections:[5,r.b.REPEATED|r.d.MESSAGE,K],productListInfo:[6,r.d.MESSAGE,F],footerText:[7,r.d.STRING],contextInfo:[8,r.d.MESSAGE,Ge]},F.internalSpec={productSections:[1,r.b.REPEATED|r.d.MESSAGE,j],headerImage:[2,r.d.MESSAGE,B],businessOwnerJid:[3,r.d.STRING]},B.internalSpec={productId:[1,r.d.STRING],jpegThumbnail:[2,r.d.BYTES]},j.internalSpec={title:[1,r.d.STRING],products:[2,r.b.REPEATED|r.d.MESSAGE,V]},V.internalSpec={productId:[1,r.d.STRING]},K.internalSpec={title:[1,r.d.STRING],rows:[2,r.b.REPEATED|r.d.MESSAGE,H]},H.internalSpec={title:[1,r.d.STRING],description:[2,r.d.STRING],rowId:[3,r.d.STRING]},$.internalSpec={orderId:[1,r.d.STRING],thumbnail:[2,r.d.BYTES],itemCount:[3,r.d.INT32],status:[4,r.d.ENUM,{INQUIRY:1}],surface:[5,r.d.ENUM,{CATALOG:1}],message:[6,r.d.STRING],orderTitle:[7,r.d.STRING],sellerJid:[8,r.d.STRING],token:[9,r.d.STRING],totalAmount1000:[10,r.d.INT64],totalCurrencyCode:[11,r.d.STRING],contextInfo:[17,r.d.MESSAGE,Ge]},q.internalSpec={product:[1,r.d.MESSAGE,z],businessOwnerJid:[2,r.d.STRING],catalog:[4,r.d.MESSAGE,J],body:[5,r.d.STRING],footer:[6,r.d.STRING],contextInfo:[17,r.d.MESSAGE,Ge]},z.internalSpec={productImage:[1,r.d.MESSAGE,ke],productId:[2,r.d.STRING],title:[3,r.d.STRING],description:[4,r.d.STRING],currencyCode:[5,r.d.STRING],priceAmount1000:[6,r.d.INT64],retailerId:[7,r.d.STRING],url:[8,r.d.STRING],productImageCount:[9,r.d.UINT32],firstImageId:[11,r.d.STRING],salePriceAmount1000:[12,r.d.INT64]},J.internalSpec={catalogImage:[1,r.d.MESSAGE,ke],title:[2,r.d.STRING],description:[3,r.d.STRING]},Y.internalSpec={selectedId:[1,r.d.STRING],selectedDisplayText:[2,r.d.STRING],contextInfo:[3,r.d.MESSAGE,Ge],selectedIndex:[4,r.d.UINT32]},W.internalSpec={fourRowTemplate:[1,r.d.MESSAGE,Q],hydratedFourRowTemplate:[2,r.d.MESSAGE,Z],contextInfo:[3,r.d.MESSAGE,Ge],hydratedTemplate:[4,r.d.MESSAGE,Z],__oneofs__:{format:["fourRowTemplate","hydratedFourRowTemplate"]}},Z.internalSpec={documentMessage:[1,r.d.MESSAGE,Oe],hydratedTitleText:[2,r.d.STRING],imageMessage:[3,r.d.MESSAGE,ke],videoMessage:[4,r.d.MESSAGE,Te],locationMessage:[5,r.d.MESSAGE,Ce],hydratedContentText:[6,r.d.STRING],hydratedFooterText:[7,r.d.STRING],hydratedButtons:[8,r.b.REPEATED|r.d.MESSAGE,qe],templateId:[9,r.d.STRING],__oneofs__:{title:["documentMessage","hydratedTitleText","imageMessage","videoMessage","locationMessage"]}},Q.internalSpec={documentMessage:[1,r.d.MESSAGE,Oe],highlyStructuredMessage:[2,r.d.MESSAGE,se],imageMessage:[3,r.d.MESSAGE,ke],videoMessage:[4,r.d.MESSAGE,Te],locationMessage:[5,r.d.MESSAGE,Ce],content:[6,r.d.MESSAGE,se],footer:[7,r.d.MESSAGE,se],buttons:[8,r.b.REPEATED|r.d.MESSAGE,Ve],__oneofs__:{title:["documentMessage","highlyStructuredMessage","imageMessage","videoMessage","locationMessage"]}},X.internalSpec={url:[1,r.d.STRING],fileSha256:[2,r.d.BYTES],fileEncSha256:[3,r.d.BYTES],mediaKey:[4,r.d.BYTES],mimetype:[5,r.d.STRING],height:[6,r.d.UINT32],width:[7,r.d.UINT32],directPath:[8,r.d.STRING],fileLength:[9,r.d.UINT64],mediaKeyTimestamp:[10,r.d.INT64],firstFrameLength:[11,r.d.UINT32],firstFrameSidecar:[12,r.d.BYTES],isAnimated:[13,r.d.BOOL],pngThumbnail:[16,r.d.BYTES],contextInfo:[17,r.d.MESSAGE,Ge]},ee.internalSpec={degreesLatitude:[1,r.d.DOUBLE],degreesLongitude:[2,r.d.DOUBLE],accuracyInMeters:[3,r.d.UINT32],speedInMps:[4,r.d.FLOAT],degreesClockwiseFromMagneticNorth:[5,r.d.UINT32],caption:[6,r.d.STRING],sequenceNumber:[7,r.d.INT64],timeOffset:[8,r.d.UINT32],jpegThumbnail:[16,r.d.BYTES],contextInfo:[17,r.d.MESSAGE,Ge]},te.internalSpec={serviceType:[1,r.d.ENUM,{UNKNOWN:0,FBPAY:1,NOVI:2,UPI:3}],expiryTimestamp:[2,r.d.INT64]},ne.internalSpec={key:[1,r.d.MESSAGE,a.a]},re.internalSpec={key:[1,r.d.MESSAGE,a.a]},ae.internalSpec={noteMessage:[4,r.d.MESSAGE,d],currencyCodeIso4217:[1,r.d.STRING],amount1000:[2,r.d.UINT64],requestFrom:[3,r.d.STRING],expiryTimestamp:[5,r.d.INT64],amount:[6,r.d.MESSAGE,We],background:[7,r.d.MESSAGE,Ze]},ie.internalSpec={noteMessage:[2,r.d.MESSAGE,d],requestMessageKey:[3,r.d.MESSAGE,a.a],background:[4,r.d.MESSAGE,Ze]},se.internalSpec={namespace:[1,r.d.STRING],elementName:[2,r.d.STRING],params:[3,r.b.REPEATED|r.d.STRING],fallbackLg:[4,r.d.STRING],fallbackLc:[5,r.d.STRING],localizableParams:[6,r.b.REPEATED|r.d.MESSAGE,oe],deterministicLg:[7,r.d.STRING],deterministicLc:[8,r.d.STRING],hydratedHsm:[9,r.d.MESSAGE,W]},oe.internalSpec={default:[1,r.d.STRING],currency:[2,r.d.MESSAGE,le],dateTime:[3,r.d.MESSAGE,ue],__oneofs__:{paramOneof:["currency","dateTime"]}},ue.internalSpec={component:[1,r.d.MESSAGE,ce],unixEpoch:[2,r.d.MESSAGE,de],__oneofs__:{datetimeOneof:["component","unixEpoch"]}},de.internalSpec={timestamp:[1,r.d.INT64]},ce.internalSpec={dayOfWeek:[1,r.d.ENUM,{MONDAY:1,TUESDAY:2,WEDNESDAY:3,THURSDAY:4,FRIDAY:5,SATURDAY:6,SUNDAY:7}],year:[2,r.d.UINT32],month:[3,r.d.UINT32],dayOfMonth:[4,r.d.UINT32],hour:[5,r.d.UINT32],minute:[6,r.d.UINT32],calendar:[7,r.d.ENUM,{GREGORIAN:1,SOLAR_HIJRI:2}]},le.internalSpec={currencyCode:[1,r.d.STRING],amount1000:[2,r.d.INT64]},pe.internalSpec={displayName:[1,r.d.STRING],contacts:[2,r.b.REPEATED|r.d.MESSAGE,Re],contextInfo:[17,r.d.MESSAGE,Ge]},he.internalSpec={securityNotificationEnabled:[1,r.d.BOOL]},fe.internalSpec={collectionNames:[1,r.b.REPEATED|r.d.STRING],timestamp:[2,r.d.INT64]},me.internalSpec={keyIds:[1,r.b.REPEATED|r.d.MESSAGE,Ee]},ve.internalSpec={keys:[1,r.b.REPEATED|r.d.MESSAGE,be]},ge.internalSpec={keyData:[1,r.d.BYTES],fingerprint:[2,r.d.MESSAGE,_e],timestamp:[3,r.d.INT64]},_e.internalSpec={rawId:[1,r.d.UINT32],currentIndex:[2,r.d.UINT32],deviceIndexes:[3,r.b.REPEATED|r.b.PACKED|r.d.UINT32]},Ee.internalSpec={keyId:[1,r.d.BYTES]},be.internalSpec={keyId:[1,r.d.MESSAGE,Ee],keyData:[2,r.d.MESSAGE,ge]},ye.internalSpec={fileSha256:[1,r.d.BYTES],fileLength:[2,r.d.UINT64],mediaKey:[3,r.d.BYTES],fileEncSha256:[4,r.d.BYTES],directPath:[5,r.d.STRING],syncType:[6,r.d.ENUM,{INITIAL_BOOTSTRAP:0,INITIAL_STATUS_V3:1,FULL:2,RECENT:3,PUSH_NAME:4}],chunkOrder:[7,r.d.UINT32],originalMessageId:[8,r.d.STRING]},Se.internalSpec={key:[1,r.d.MESSAGE,a.a],type:[2,r.d.ENUM,i],ephemeralExpiration:[4,r.d.UINT32],ephemeralSettingTimestamp:[5,r.d.INT64],historySyncNotification:[6,r.d.MESSAGE,ye],appStateSyncKeyShare:[7,r.d.MESSAGE,ve],appStateSyncKeyRequest:[8,r.d.MESSAGE,me],initialSecurityNotificationSettingSync:[9,r.d.MESSAGE,he],appStateFatalExceptionNotification:[10,r.d.MESSAGE,fe],disappearingMode:[11,r.d.MESSAGE,Xe]},Ie.internalSpec={displayName:[1,r.d.STRING],id:[2,r.d.STRING]},we.internalSpec={callKey:[1,r.d.BYTES],conversionSource:[2,r.d.STRING],conversionData:[3,r.d.BYTES],conversionDelaySeconds:[4,r.d.UINT32]},Te.internalSpec={url:[1,r.d.STRING],mimetype:[2,r.d.STRING],fileSha256:[3,r.d.BYTES],fileLength:[4,r.d.UINT64],seconds:[5,r.d.UINT32],mediaKey:[6,r.d.BYTES],caption:[7,r.d.STRING],gifPlayback:[8,r.d.BOOL],height:[9,r.d.UINT32],width:[10,r.d.UINT32],fileEncSha256:[11,r.d.BYTES],interactiveAnnotations:[12,r.b.REPEATED|r.d.MESSAGE,Fe],directPath:[13,r.d.STRING],mediaKeyTimestamp:[14,r.d.INT64],jpegThumbnail:[16,r.d.BYTES],contextInfo:[17,r.d.MESSAGE,Ge],streamingSidecar:[18,r.d.BYTES],gifAttribution:[19,r.d.ENUM,s],viewOnce:[20,r.d.BOOL],thumbnailDirectPath:[21,r.d.STRING],thumbnailSha256:[22,r.d.BYTES],thumbnailEncSha256:[23,r.d.BYTES],staticUrl:[24,r.d.STRING]},Ae.internalSpec={url:[1,r.d.STRING],mimetype:[2,r.d.STRING],fileSha256:[3,r.d.BYTES],fileLength:[4,r.d.UINT64],seconds:[5,r.d.UINT32],ptt:[6,r.d.BOOL],mediaKey:[7,r.d.BYTES],fileEncSha256:[8,r.d.BYTES],directPath:[9,r.d.STRING],mediaKeyTimestamp:[10,r.d.INT64],contextInfo:[17,r.d.MESSAGE,Ge],streamingSidecar:[18,r.d.BYTES],waveform:[19,r.d.BYTES]},Oe.internalSpec={url:[1,r.d.STRING],mimetype:[2,r.d.STRING],title:[3,r.d.STRING],fileSha256:[4,r.d.BYTES],fileLength:[5,r.d.UINT64],pageCount:[6,r.d.UINT32],mediaKey:[7,r.d.BYTES],fileName:[8,r.d.STRING],fileEncSha256:[9,r.d.BYTES],directPath:[10,r.d.STRING],mediaKeyTimestamp:[11,r.d.INT64],contactVcard:[12,r.d.BOOL],thumbnailDirectPath:[13,r.d.STRING],thumbnailSha256:[14,r.d.BYTES],thumbnailEncSha256:[15,r.d.BYTES],jpegThumbnail:[16,r.d.BYTES],contextInfo:[17,r.d.MESSAGE,Ge],thumbnailHeight:[18,r.d.UINT32],thumbnailWidth:[19,r.d.UINT32]},Me.internalSpec={text:[1,r.d.STRING],matchedText:[2,r.d.STRING],canonicalUrl:[4,r.d.STRING],description:[5,r.d.STRING],title:[6,r.d.STRING],textArgb:[7,r.d.FIXED32],backgroundArgb:[8,r.d.FIXED32],font:[9,r.d.ENUM,{SANS_SERIF:0,SERIF:1,NORICAN_REGULAR:2,BRYNDAN_WRITE:3,BEBASNEUE_REGULAR:4,OSWALD_HEAVY:5}],previewType:[10,r.d.ENUM,{NONE:0,VIDEO:1}],jpegThumbnail:[16,r.d.BYTES],contextInfo:[17,r.d.MESSAGE,Ge],doNotPlayInline:[18,r.d.BOOL],thumbnailDirectPath:[19,r.d.STRING],thumbnailSha256:[20,r.d.BYTES],thumbnailEncSha256:[21,r.d.BYTES],mediaKey:[22,r.d.BYTES],mediaKeyTimestamp:[23,r.d.INT64],thumbnailHeight:[24,r.d.UINT32],thumbnailWidth:[25,r.d.UINT32],inviteLinkGroupType:[26,r.d.ENUM,o],inviteLinkParentGroupSubjectV2:[27,r.d.STRING],inviteLinkParentGroupThumbnailV2:[28,r.d.BYTES],inviteLinkGroupTypeV2:[29,r.d.ENUM,o]},Ce.internalSpec={degreesLatitude:[1,r.d.DOUBLE],degreesLongitude:[2,r.d.DOUBLE],name:[3,r.d.STRING],address:[4,r.d.STRING],url:[5,r.d.STRING],isLive:[6,r.d.BOOL],accuracyInMeters:[7,r.d.UINT32],speedInMps:[8,r.d.FLOAT],degreesClockwiseFromMagneticNorth:[9,r.d.UINT32],comment:[11,r.d.STRING],jpegThumbnail:[16,r.d.BYTES],contextInfo:[17,r.d.MESSAGE,Ge]},Re.internalSpec={displayName:[1,r.d.STRING],vcard:[16,r.d.STRING],contextInfo:[17,r.d.MESSAGE,Ge]},Ne.internalSpec={note:[1,r.d.STRING],token:[2,r.d.STRING],attachmentType:[3,r.d.ENUM,{IMAGE:0,PDF:1}],attachmentMimetype:[4,r.d.STRING],attachmentMediaKey:[5,r.d.BYTES],attachmentMediaKeyTimestamp:[6,r.d.INT64],attachmentFileSha256:[7,r.d.BYTES],attachmentFileEncSha256:[8,r.d.BYTES],attachmentDirectPath:[9,r.d.STRING],attachmentJpegThumbnail:[10,r.d.BYTES]},ke.internalSpec={url:[1,r.d.STRING],mimetype:[2,r.d.STRING],caption:[3,r.d.STRING],fileSha256:[4,r.d.BYTES],fileLength:[5,r.d.UINT64],height:[6,r.d.UINT32],width:[7,r.d.UINT32],mediaKey:[8,r.d.BYTES],fileEncSha256:[9,r.d.BYTES],interactiveAnnotations:[10,r.b.REPEATED|r.d.MESSAGE,Fe],directPath:[11,r.d.STRING],mediaKeyTimestamp:[12,r.d.INT64],jpegThumbnail:[16,r.d.BYTES],contextInfo:[17,r.d.MESSAGE,Ge],firstScanSidecar:[18,r.d.BYTES],firstScanLength:[19,r.d.UINT32],experimentGroupId:[20,r.d.UINT32],scansSidecar:[21,r.d.BYTES],scanLengths:[22,r.b.REPEATED|r.d.UINT32],midQualityFileSha256:[23,r.d.BYTES],midQualityFileEncSha256:[24,r.d.BYTES],viewOnce:[25,r.d.BOOL],thumbnailDirectPath:[26,r.d.STRING],thumbnailSha256:[27,r.d.BYTES],thumbnailEncSha256:[28,r.d.BYTES],staticUrl:[29,r.d.STRING]},Pe.internalSpec={groupId:[1,r.d.STRING],axolotlSenderKeyDistributionMessage:[2,r.d.BYTES]},Ge.internalSpec={stanzaId:[1,r.d.STRING],participant:[2,r.d.STRING],quotedMessage:[3,r.d.MESSAGE,d],remoteJid:[4,r.d.STRING],mentionedJid:[15,r.b.REPEATED|r.d.STRING],conversionSource:[18,r.d.STRING],conversionData:[19,r.d.BYTES],conversionDelaySeconds:[20,r.d.UINT32],forwardingScore:[21,r.d.UINT32],isForwarded:[22,r.d.BOOL],quotedAd:[23,r.d.MESSAGE,De],placeholderKey:[24,r.d.MESSAGE,a.a],expiration:[25,r.d.UINT32],ephemeralSettingTimestamp:[26,r.d.INT64],ephemeralSharedSecret:[27,r.d.BYTES],externalAdReply:[28,r.d.MESSAGE,Le],entryPointConversionSource:[29,r.d.STRING],entryPointConversionApp:[30,r.d.STRING],entryPointConversionDelaySeconds:[31,r.d.UINT32],disappearingMode:[32,r.d.MESSAGE,Xe],actionLink:[33,r.d.MESSAGE,et],groupSubject:[34,r.d.STRING],parentGroupJid:[35,r.d.STRING]},Le.internalSpec={title:[1,r.d.STRING],body:[2,r.d.STRING],mediaType:[3,r.d.ENUM,{NONE:0,IMAGE:1,VIDEO:2}],thumbnailUrl:[4,r.d.STRING],mediaUrl:[5,r.d.STRING],thumbnail:[6,r.d.BYTES],sourceType:[7,r.d.STRING],sourceId:[8,r.d.STRING],sourceUrl:[9,r.d.STRING],containsAutoReply:[10,r.d.BOOL],renderLargerThumbnail:[11,r.d.BOOL],showAdAttribution:[12,r.d.BOOL]},De.internalSpec={advertiserName:[1,r.d.STRING],mediaType:[2,r.d.ENUM,{NONE:0,IMAGE:1,VIDEO:2}],jpegThumbnail:[16,r.d.BYTES],caption:[17,r.d.STRING]},xe.internalSpec={deviceListMetadata:[1,r.d.MESSAGE,Ue],deviceListMetadataVersion:[2,r.d.INT32],messageSecret:[3,r.d.BYTES]},Ue.internalSpec={senderKeyHash:[1,r.d.BYTES],senderTimestamp:[2,r.d.UINT64],senderKeyIndexes:[3,r.b.REPEATED|r.b.PACKED|r.d.UINT32],recipientKeyHash:[8,r.d.BYTES],recipientTimestamp:[9,r.d.UINT64],recipientKeyIndexes:[10,r.b.REPEATED|r.b.PACKED|r.d.UINT32]},Fe.internalSpec={polygonVertices:[1,r.b.REPEATED|r.d.MESSAGE,Be],location:[2,r.d.MESSAGE,je],__oneofs__:{action:["location"]}},Be.internalSpec={xDeprecated:[1,r.d.INT32],yDeprecated:[2,r.d.INT32],x:[3,r.d.DOUBLE],y:[4,r.d.DOUBLE]},je.internalSpec={degreesLatitude:[1,r.d.DOUBLE],degreesLongitude:[2,r.d.DOUBLE],name:[3,r.d.STRING]},Ve.internalSpec={quickReplyButton:[1,r.d.MESSAGE,$e],urlButton:[2,r.d.MESSAGE,He],callButton:[3,r.d.MESSAGE,Ke],index:[4,r.d.UINT32],__oneofs__:{button:["quickReplyButton","urlButton","callButton"]}},Ke.internalSpec={displayText:[1,r.d.MESSAGE,se],phoneNumber:[2,r.d.MESSAGE,se]},He.internalSpec={displayText:[1,r.d.MESSAGE,se],url:[2,r.d.MESSAGE,se]},$e.internalSpec={displayText:[1,r.d.MESSAGE,se],id:[2,r.d.STRING]},qe.internalSpec={quickReplyButton:[1,r.d.MESSAGE,Ye],urlButton:[2,r.d.MESSAGE,Je],callButton:[3,r.d.MESSAGE,ze],index:[4,r.d.UINT32],__oneofs__:{hydratedButton:["quickReplyButton","urlButton","callButton"]}},ze.internalSpec={displayText:[1,r.d.STRING],phoneNumber:[2,r.d.STRING]},Je.internalSpec={displayText:[1,r.d.STRING],url:[2,r.d.STRING]},Ye.internalSpec={displayText:[1,r.d.STRING],id:[2,r.d.STRING]},We.internalSpec={value:[1,r.d.INT64],offset:[2,r.d.UINT32],currencyCode:[3,r.d.STRING]},Ze.internalSpec={id:[1,r.d.STRING],fileLength:[2,r.d.UINT64],width:[3,r.d.UINT32],height:[4,r.d.UINT32],mimetype:[5,r.d.STRING],placeholderArgb:[6,r.d.FIXED32],textArgb:[7,r.d.FIXED32],subtextArgb:[8,r.d.FIXED32],mediaData:[9,r.d.MESSAGE,Qe],type:[10,r.d.ENUM,{UNKNOWN:0,DEFAULT:1}]},Qe.internalSpec={mediaKey:[1,r.d.BYTES],mediaKeyTimestamp:[2,r.d.INT64],fileSha256:[3,r.d.BYTES],fileEncSha256:[4,r.d.BYTES],directPath:[5,r.d.STRING]},Xe.internalSpec={initiator:[1,r.d.ENUM,u]},et.internalSpec={url:[1,r.d.STRING],buttonTitle:[2,r.d.STRING]}},function(e,t,n){n.d(t,"c",(function(){return p})),n.d(t,"f",(function(){return h})),n.d(t,"d",(function(){return f})),n.d(t,"b",(function(){return m})),n.d(t,"a",(function(){return v})),n.d(t,"g",(function(){return g})),n.d(t,"e",(function(){return E})),n.d(t,"i",(function(){return y})),n.d(t,"h",(function(){return I}));var r=n(9),a=n.n(r),i=n(5),s=n(8),o=n(16);function u(e,t,n,r){return e.transact(t,n,()=>r(e.stores))}var d=n(3),c=n(26),l=n(65);function p(e){return(0,s.e)("getContacts",t=>(0,i.i)(t.getContacts(e)))}function h(){return(0,s.f)("getKnownWhatsAppContacts",e=>(0,i.i)(e.stores.contacts.orderBy("phonebookPhone").filter(e=>!e.noWhatsApp).toArray().then(e=>e.map(e=>e.jid))))}function f(e){return(0,s.e)("getContactsByPhonebookPhones",t=>t.getContactsByPhonebookPhones(e))}function m(e){return(0,s.e)("getContact",t=>t.getContact(e))}function v(e,t,n){__LOG__(2)`addOrReplaceContactNames`;var r=["contacts","meta","groupParticipantsInfo","status","authors","media","previews","receipts"];return(0,s.c)("addOrReplaceContactNames",s=>u(s.table,"rw",r,r=>(function(e,t,n,r){return e.contacts.toArray().then(s=>{var o=[],u=[];return s.forEach(e=>{var n=e.jid;if(t.has(n)){var a=Object.assign({},e,t.get(n));u.push(a),t.delete(n)}else if(r&&r.has(n)&&(e.shortName||e.fullName||e.phonebookPhone)){var i,s,c=Object.assign({},e,{lastKnownName:{ts:(0,d.E)(),shortName:e.shortName||(null==(i=e.lastKnownName)?void 0:i.shortName),fullName:e.fullName||(null==(s=e.lastKnownName)?void 0:s.fullName)}});delete c.fullName,delete c.shortName,delete c.phonebookPhone,u.push(c),o.push(n)}}),u.push(...Array.from(t.values())),(0,i.c)([e.contacts.bulkPut(u).then(()=>u),(0,l.a)(e,o),n&&_(e,n)]).then(e=>{var t=a()(e,2);return{updated:t[0],status:t[1]}})})})(r,e,t,n)),(e,t,n)=>{e.updated.length>0&&n.fireAndForget("event","contactsModified",{changed:e.updated}),w(t,n,e.status)})}function g(e){return(0,s.f)("removeInvalidNumbers",t=>u(t,"rw",["meta"],t=>_(t,e)))}function _(e,t){return b(e).then(n=>{var r=new Set(t),a=n.filter(e=>!r.has(e));return S(e,a)})}function E(){return(0,s.f)("getInvalidNumbers",e=>(function(e,t){return(0,i.i)(b(e.stores))})(e))}function b(e){return(0,c.d)(e.meta,c.a.INVALID_CONTACTS).then(e=>(null==e?void 0:e.value)||[])}function y(e,t,n){return __LOG__(2)`updateContacts ${e.size} updated contacts, ${t?t.size:0} to delete`,(0,s.c)("updateContacts",r=>u(r.table,"rw",["contacts","groups","groupParticipantsInfo","msgs","chats","status","authors","media","previews","receipts"],r=>(function(e,t,n,r){return e.contacts.toArray().then(s=>{var o=new Set,u=[],c=[],p=new Set(r),h=new Map(t);s.forEach(e=>{var t=e.jid,r=h.get(t);if(r){var a=Object.assign({},e);if(e.noWhatsApp&&!r.noWhatsApp?delete a.noWhatsApp:r.noWhatsApp&&!e.noWhatsApp&&(a.noWhatsApp=!0,delete a.about,o.add(t)),r.phonebook){delete a.lastKnownName;var i=r.phonebook;a.fullName=i.fullName,a.shortName=i.shortName,a.phonebookPhone=i.phonebookPhone}else{var s,l;a.lastKnownName={ts:(0,d.E)(),shortName:a.shortName||(null==(s=a.lastKnownName)?void 0:s.shortName),fullName:a.fullName||(null==(l=a.lastKnownName)?void 0:l.fullName)},delete a.fullName,delete a.shortName,delete a.phonebookPhone,o.add(t)}r.about&&(a.about=r.about),"blocked"===r.defaultDisappearingMode?delete a.defaultDisappearingMode:r.defaultDisappearingMode&&(a.defaultDisappearingMode=r.defaultDisappearingMode),c.push(a);var f=e.phonebookPhone;null!=f&&p.delete(f),h.delete(t)}else if(n&&n.has(t)){var m=e.phonebookPhone;if(null!=m&&p.delete(m),o.add(t),e.chatId||e.pushname||e.messaged||e.sentHsm||e.bizIntro||e.verifiedInfo||e.devices&&e.devices.length>1){var v,g,_=Object.assign({},e,{lastKnownName:{ts:(0,d.E)(),shortName:e.shortName||(null==(v=e.lastKnownName)?void 0:v.shortName),fullName:e.fullName||(null==(g=e.lastKnownName)?void 0:g.fullName)}});delete _.fullName,delete _.shortName,delete _.phonebookPhone,delete _.about,delete _.noWhatsApp,c.push(_)}else u.push(e)}}),c.length>0&&__LOG__(2)`Updating ${c.length} existing contacts`,h.forEach((e,t)=>{var n=Object.assign({jid:t},e.phonebook);e.about&&(n.about=e.about),e.noWhatsApp&&(n.noWhatsApp=!0),e.defaultDisappearingMode&&"blocked"!==e.defaultDisappearingMode&&(n.defaultDisappearingMode=e.defaultDisappearingMode),c.push(n)}),h.size>0&&__LOG__(2)`Creating ${h.size} new contacts`;var f,m=u.map(e=>e.jid);return m.length>0&&(__LOG__(2)`Deleting ${m.length} contacts from db`,f=e.contacts.bulkDelete(m).then(()=>m)),(0,i.c)([f||[],(0,l.a)(e,Array.from(o)),e.contacts.bulkPut(c),S(e,Array.from(p))]).then(e=>{var t=a()(e,2),n=t[0],r=t[1];return{updated:c,deleted:n,status:r}})})})(r,e,t,n)),(e,t,n)=>{(e.deleted.length||e.updated.length)&&n.fireAndForget("event","contactsModified",{changed:e.updated,deleted:e.deleted}),w(t,n,e.status)})}function S(e,t){return e.meta.put({key:c.a.INVALID_CONTACTS,value:t})}function I(e,t){var n=new Map;return n.set(e,t),y(n,null,[])}function w(e,t,n){if(n){var r=n.whitelistUpdated,a=n.settings,i=n.removed;r&&e.fireAndForget(o.e.updateServerWhitelist()),a&&t.fireAndForget("event","statusSettingsUpdated",{settings:a}),i&&t.fireAndForget("event","statusAuthorsCleared",{authors:i})}}},function(e,t,n){n.d(t,"a",(function(){return R})),n.d(t,"d",(function(){return N})),n.d(t,"b",(function(){return k})),n.d(t,"h",(function(){return P})),n.d(t,"g",(function(){return G})),n.d(t,"j",(function(){return L})),n.d(t,"f",(function(){return D})),n.d(t,"e",(function(){return x})),n.d(t,"i",(function(){return U}));var r=n(9),a=n.n(r),i=n(294),s=n(26),o=n(5),u=n(2),d=n(77),c=n(15),l=n(59),p=n(14),h=n(11),f=n(7),m=n(24),v=n(10),g=n(33),_=n(295),E=n(6),b=n(205),y=n(12),S=n(3),I=n(130),w=n(49),T=n(60),A=n(45),O=n(134),M=n(21),C=class extends i.BaseContentTable{constructor(){super(),(0,y.d)()&&this.updateLastAppWrite()}transact(e,t,n){var r=t,i=n;return"rw"===e&&(r.includes("meta")||(r=[...t,"meta"]),i=(0,y.d)()?()=>(0,o.c)([n(),this.updateLastAppWrite()]).then(e=>a()(e,1)[0]):()=>(0,o.c)([n(),this.Fb()]).then(e=>a()(e,1)[0])),super.transact(e,r,i)}Fb(){return(0,s.d)(this.stores.meta,s.a.APPWRITE_META_KEY).then(e=>{if(null!=this.Fa){if((null==e?void 0:e.value)!==this.Fa)throw __LOG__(3)`The last app write value has changed, shutting down`,(0,y.j)(),new Error("shutdown")}else if(null!=e){var t=(0,S.F)();if(Math.abs(t-e.value)<=500)throw __LOG__(3)`There was a very recent write in the content table, shutting down`,(0,y.j)(),new Error("shutdown");this.Fa=e.value}})}getRegisteredUser(){return(0,s.d)(this.stores.meta,s.a.REGISTERED).then(e=>e?(0,f.q)(e.value):null)}setRegisteredUser(e){return this.stores.meta.put({key:s.a.REGISTERED,value:e})}getContact(e){return this.stores.contacts.get(e)}getDevicesInTransaction(e){return this.stores.contacts.where("jid").anyOf(e).toArray().then(t=>{var n=new Set(e.map(f.d));return t.forEach(e=>{(0,T.c)(e).forEach(e=>{n.add(e)})}),n})}getGroupInfo(e){return this.stores.groups.get(e)}setGroupInfo(e){return __LOG__(2)`setGroup`,this.stores.groups.put(e)}filterParticipantsInGroup(e){return(0,o.k)(this.stores.groupParticipantsInfo,"participants").anyOf(e).toArray().then(t=>{var n=new Set(e),r=new Set;return t.forEach(e=>{e.jid!==h.h&&e.participants.forEach(e=>{n.has(e)&&r.add(e)})}),Array.from(r)})}getParticipantsInfoInTransaction(e){return x(this.stores,e)}setParticipantsInfo(e){return this.stores.groupParticipantsInfo.put(e)}getGroupInfoWithParticipantsInTransaction(e){var t=this.getGroupInfo(e);return(0,o.c)([t,this.getParticipantsInfoInTransaction(e)]).then(e=>{var t=a()(e,2),n=t[0],r=t[1],i=r&&(0,w.g)(r);if(n&&"parent"!==n.communityInfo&&i)return{groupInfo:n,participantsInfo:i}})}markSenderKeysForRotationInTransaction(e){return this.stores.groupParticipantsInfo.where("jid").anyOf(e).toArray().then(e=>this.stores.groupParticipantsInfo.bulkPut(e.map(e=>(0,v.j)(e,{rotateSenderKey:!0}))))}revokeGroupInvitesInTransaction(e,t,n){return this.getGroupInviteRevokes().then(r=>{__LOG__(2)`Revoke group invites for ${e}`;var a=r.filter(e=>(0,S.p)(e.expiresBefore)),i=[];return n.forEach(n=>{if((0,S.p)(n.expiresBefore)){var r=a.find(r=>r.group===e&&r.outgoing===t&&r.user===n.user);r?(__LOG__(2)`Revoke group invite found. Updating`,n.expiresBefore>r.expiresBefore&&(r.expiresBefore=n.expiresBefore),i.push({user:r.user,expiresBefore:r.expiresBefore})):(__LOG__(2)`Revoke group invite not found. Adding.`,a.push({group:e,outgoing:t,user:n.user,expiresBefore:n.expiresBefore}),i.push({user:n.user,expiresBefore:n.expiresBefore}))}}),this.replaceGroupInviteRevokes(a).then(()=>i)})}addInvitationToGroupInTransaction(e,t){return this.getChatAndGroupInTransaction(e).then(n=>{if(!n||!n.dbGroup)return __LOG__(3)`Tried to add invitation to non-existent group ${e}`,void SEND_LOGS("add-invitation-group-not-exists");__LOG__(2)`Add invitation to group ${e}`;var r=n.dbChat,i=n.dbGroup,s=i.participantsInfo.invitations||[],u=this.revokeGroupInvitesInTransaction(e,!0,[{user:t.jid,expiresBefore:(0,S.x)(1,t.expiration)}]),d=s.find(e=>e.jid===t.jid);return d?(__LOG__(2)`Updating existing invitation`,d.code=t.code,d.expiration=t.expiration):(__LOG__(2)`Creating new invitation`,s.push(t)),s.sort((e,t)=>e.expiration-t.expiration),i.participantsInfo.invitations=s,(0,o.c)([u,this.setParticipantsInfo(i.participantsInfo)]).then(e=>{var t=a()(e,1)[0];return{dbChat:r,dbGroup:i,revokes:t}})})}userParticipantsInfo(e){return this.getParticipantsInfoWithUserInTransaction(e).then(e=>{var t,n=[],r={};return e.forEach(e=>{var a=(0,w.g)(e);if(a){var i=a.jid;n.push(i),r[i]=a}else t=(0,w.h)(e)}),this.stores.groups.where("jid").anyOf(n).toArray().then(e=>({groups:e.map(e=>{if("parent"!==e.communityInfo)return{groupInfo:e,participantsInfo:r[e.jid]}}).filter(Boolean),status:t}))})}resetReceiptsOnRevokedInTransaction(e){return this.stores.receipts.where("msgId").anyOf(e).toArray().then(e=>{var t=e.map(d.g);return this.stores.receipts.bulkPut(t).then(()=>t.map(d.h))})}getMsgFromExternalId(e,t){return this.stores.msgs.where("externalId").equals(t.externalId).toArray().then(n=>{var r=n.filter(n=>n.chat===e&&n.author===t.author);return r.length>1&&__LOG__(4)`multiple msgs in ${e} from ${t.author} with id ${(0,O.a)(t.externalId)}`,r.length?r[0]:null})}getOrphanedMsgsInTransaction(e,t,n){var r;return this.stores.orphanedStanzas.where("externalId").equals(e).filter(e=>e.chatJid===n&&e.author===t&&("revoke"===e.type?(r&&__LOG__(4)`getOrphanedMsgsInTransaction more than one orphaned revoke`,r=e,!1):(e.type,!0))).toArray().then(e=>{if(r)return{revoke:r};var t=new Map;return e.forEach(e=>{"reaction"===e.type&&t.set(e.author,e)}),{reactions:t}})}deleteOrphanedMsgsInTransaction(e,t,n){return this.stores.orphanedStanzas.where("externalId").equals(e).filter(e=>e.chatJid===n&&e.author===t).delete()}getChatIdFromJid(e){return this.stores.chats.where("jid").equals(e).toArray().then(e=>e.length>0?e[0].id:null)}getAllMsgsFromIds(e){return this.stores.msgs.where("id").anyOf(e).toArray()}getAllMsgsFromOrderedIds(e){return this.getAllMsgsFromIds(e).then(t=>{var n=[],r={};return e.forEach((e,t)=>{r[e]=t}),t.forEach(e=>{n[r[e.id]]=e}),n})}getMsgFromId(e){return this.stores.msgs.where("id").equals(e).toArray().then(e=>e.length>0?e[0]:null)}getMsgsToForward(e){var t=[],n=[];return e.forEach(e=>{var r=(0,c.z)(e);"chat"===r.type?t.push(r.msgId):n.push(r.msgId)}),(0,o.c)([this.stores.msgs.where("id").anyOf(t).toArray(),this.stores.status.where("id").anyOf(n).toArray(),this.stores.previews.where("previewId").anyOf(e).toArray(),(0,o.l)(this.stores.media,"msgIds").anyOf(e).toArray()]).then(e=>{var t=a()(e,4),n=t[0],r=t[1],i=t[2],s=t[3],o={};n.forEach(e=>{o[e.id]={type:"chat",msg:e,preview:null,media:null}}),r.forEach(e=>{o[e.id]={type:"status",msg:e,preview:null,media:null}}),i.forEach(e=>{var t=(0,l.d)(e.previewId);if(t){var n=o[t];n&&(n.preview=e.preview)}});var u=new Map;if(s.forEach(e=>{u.set((0,c.C)(e.mediaId),e.msgIds),e.msgIds.forEach(t=>{var n=o[t];n&&(n.media=e)})}),u.size>0){var d=Array.from(u.keys());return this.stores.previews.where("previewId").anyOf(d).toArray().then(e=>(e.forEach(e=>{var t=e.previewId,n=u.get(t);n&&n.forEach(t=>{var n=o[t];n&&(n.preview=e.preview)})}),o))}return o})}getChatInTransaction(e){return this.stores.chats.get(e).then(t=>{if(!t)throw __LOG__(4)`Chat ${e} is not in db`,new Error("The chat is not in db");return t})}getChatAndGroupFromId(e){return this.stores.chats.get(e).then(t=>{if(t){var n=(0,f.p)(t.jid);return n?this.getGroupInfoWithParticipantsInTransaction(n).then(e=>e?{dbChat:t,dbGroup:e}:(__LOG__(4)`Group chat without group info`,SEND_LOGS("chat-without-group"),null)):{dbChat:t}}__LOG__(3)`Chat ${e} is gone`})}getChatAndGroupInTransaction(e){var t=(0,f.p)(e),n=null!=t?this.getGroupInfoWithParticipantsInTransaction(t):null;return(0,o.c)([this.stores.chats.where("jid").equals(e).first(),n]).then(e=>{var t=a()(e,2),n=t[0],r=t[1];return n?{dbChat:n,dbGroup:r}:null})}getAllChatsAndGroupInfosInTransaction(e){var t=[];e.forEach(e=>{var n=(0,f.p)(e);n&&t.push(n)});var n=this.stores.groups.where("jid").anyOf(t).toArray();return(0,o.c)([this.stores.chats.where("jid").anyOf(e).toArray(),n,this.stores.groupParticipantsInfo.where("jid").anyOf(t).toArray()]).then(e=>{var t=a()(e,3),n=t[0],r=t[1],i=t[2],s=(0,v.s)(r,e=>e.jid),o={},u={};return n.forEach(e=>{(0,f.x)(e.jid,{user:t=>{u[t]=e},group:t=>{u[t]=e;var n=s[t],r=i.find(e=>e.jid===t),a=r?r.participants.length:null;n&&"parent"!==n.communityInfo&&(o[t]=Object.assign({},n,{groupSize:a}))}})}),{chats:u,groupInfos:o}})}getMsgInTransaction(e){return this.stores.msgs.get(e).then(t=>{if(!t)throw __LOG__(4)`Msg ${e} is not in db`,new Error("Msg is not in db");return t})}getStarredMsgIdsInTransaction(e,t){return(0,o.j)(this.stores.msgs,["id","starred"]).between([e,c.j],[t,c.i]).keys().then(e=>e.map(e=>{var t=a()(e,2),n=t[0];return t[1],n})).catch(()=>(0,M.e)())}getAllStarredMsgIdsInTransaction(){var e=[];return this.stores.msgs.orderBy("starred").each(t=>{e.push(t.id)}).then(()=>e).catch(()=>[])}updateChat(e){return __LOG__(2)`Updating chat ${e.id} jid ${e.jid} increment ${e.increment} msgCount ${e.msgCount}`,this.stores.chats.put(e)}markChatAsBizRoleChanged(e){return this.stores.chats.get(e).then(e=>e&&!e.bizRoleChanged?(e.bizRoleChanged=!0,this.stores.chats.put(e).then(()=>e)):e)}addMsg(e,t,n){var r=Object.assign({},(0,v.u)(n),{id:e,chat:t,altIndex:k(n.altIndex,e)});return this.stores.msgs.add(r).then(e=>{var t=r;return t.rowId=e,t})}incrementMsgsRowId(e){var t={id:(0,l.n)(e.id,e.increment+1)};return this.stores.msgs.add(t).then(e=>this.stores.msgs.delete(e).then(()=>e))}getMediaMsgIds(e,t,n){var r=[];return(0,o.l)(this.stores.media,"msgIds").between(e,t,!1,!1).filterIdx((e,t)=>{var n=t;return!!(function(e,t){if(null==e.plaintext)return!1;var n=e.mediaEntries[t];return!!n&&!!(n.type&(g.c.IMAGE|g.c.AUDIO|g.c.VIDEO|g.c.GIF))&&!n.isViewOnce})(e,n)&&(r.push(n),!0)}).reverse().limit(n).toArray().then(()=>r)}getStorageSettingSortedMediaMsgIds(e){var t=[],n=null;return(n="chat"===e.type?(0,o.l)(this.stores.media,"msgIds").between(R(e.chatId),N(e.chatId),!1,!1):(0,o.h)(this.stores.media,"msgIds")).filterIdx((n,r)=>{var a=(0,c.r)(r);return!(null==a||!L(n)||"largeFiles"===e.type&&D(n)<p.s||(t.push(a),0))}),n.toArray().then(e=>{var n=e.map((e,n)=>({mediaId:e.mediaId,size:D(e),msgId:t[n]}));return n.sort((e,t)=>(e.mediaId===t.mediaId?0:1)*(t.size-e.size)),n.filter((e,t)=>0===t||e.mediaId!==n[t-1].mediaId).map(e=>e.msgId)})}replaceGroupInviteRevokes(e){return this.stores.meta.put({key:s.a.GROUP_INVITE_REVOKES,value:e})}setBlocklistAndDHash(e,t,n){return this.transact("rw",["meta"],()=>(0,s.d)(this.stores.meta,s.a.BLOCKLIST_DHASH).then(r=>{if(r&&r.value){if(r.value!==n)return"hash-mismatch"}else if(n)return"hash-mismatch";return this.stores.meta.bulkPut([{key:s.a.BLOCKED,value:e},{key:s.a.BLOCKLIST_DHASH,value:t}]).then(()=>"success")}))}getSortedCallLogs(){return this.stores.callLogs.orderBy("ts").reverse().limit(200).toArray().then(e=>(0,I.b)(e))}getCallLog(e){var t=e.callId,n=e.peer,r=e.isFromMe;return this.stores.callLogs.where("callId").equals(t).toArray().then(e=>{var a=e.filter(e=>e.peer===n&&e.isFromMe===r);return 0===a.length?null:(a.length>1&&(__LOG__(4)`getCallLog: multiple call logs in db for callId: ${t} with same peer and same direction`,SEND_LOGS("call-log-key-collision")),a[0])})}getOrInitializeCallLog(e,t){return this.transact("rw",["callLogs"],()=>this.getCallLog(e).then(n=>{if(null!=n)return n;var r={callId:e.callId,peer:e.peer,isFromMe:e.isFromMe,ts:t,duration:null,bytesTransfered:null,callResult:null};return this.stores.callLogs.add(r).then(e=>Object.assign({},r,{id:e}))}))}createMissedCallLog(e,t){return this.transact("rw",["callLogs"],()=>this.getCallLog(e).then(n=>{if(null!=n)return n;var r={callId:e.callId,peer:e.peer,isFromMe:e.isFromMe,ts:t,duration:null,bytesTransfered:null,callResult:"missed"};return this.stores.callLogs.add(r).then(e=>Object.assign({},r,{id:e}))}))}finalizeCallLog(e,t,n,r){return this.transact("rw",["callLogs"],()=>this.getCallLog(e).then(e=>{if(null==e)return null;var a=(0,v.j)(e,{callResult:t,duration:n,bytesTransfered:r});return this.stores.callLogs.update(e.id,{callResult:t,duration:n,bytesTransfered:r}).then(()=>a)}))}deleteCallLogs(e){return this.stores.callLogs.bulkDelete(e)}clearAllCallLogs(){return this.stores.callLogs.clear()}getReceipt(e){return this.stores.receipts.get(e).then(d.j)}getCommonMessageWithJid(e){return this.transact("rw",["chats","msgs","status"],()=>this.getCommonMsg(e).then(e=>{if(e)return(0,m.k)(e)?{type:"status",dbMsg:e}:this.getChatInTransaction(e.chat).then(t=>({type:"chat",dbMsg:e,jid:t.jid}))}))}getCommonMsg(e){var t=(0,c.z)(e);return"chat"===t.type?this.getMsgFromId(t.msgId):this.stores.status.where("id").equals(t.msgId).first()}getCommonMsgFromExternalId(e,t,n){var r=(0,f.b)(e);return r?this.getChatIdFromJid(r).then(e=>e?this.getMsgFromExternalId(e,{author:t,externalId:n}):null):this.getStatusFromExternalId(t,n)}getStatusFromExternalId(e,t){return this.stores.status.where("externalId").equals(t).toArray().then(n=>{var r=n.filter(t=>t.author===e);return r.length>1&&__LOG__(4)`multiple msgs from ${e} with id ${(0,O.a)(t)}`,r.length?r[0]:null})}putCommonMsg(e){return(0,m.k)(e)?this.stores.status.put(e).then(()=>e):this.stores.msgs.put(e).then(()=>e)}checkMsgAuthorized(e,t,n,r){return n.author!==u.b?(__LOG__(3)`checkMsgAuthorized got request for not authored message`,null):this.stores.receipts.get(n.id).then(d.j).then(a=>a?a.chat!==e?(__LOG__(3)`checkMsgAuthorized wrong chat ${(0,O.a)(n.externalId)}`,SEND_LOGS("invalid-check-msg-authorized"),null):(0,d.e)(a,t,r)?n:null:(__LOG__(3)`checkMsgAuthorized no receipt for msg ${n.id}`,null))}isChatEphemeral(e){return this.stores.chats.get(e).then(t=>t?(0,f.x)(t.jid,{user:e=>this.getContact(e).then(e=>{var t;return((null==e||null==(t=e.ephemeral)?void 0:t.expiration)||p.i)>p.i}),group:e=>this.getGroupInfo(e).then(e=>((null==e?void 0:e.expiration)||p.i)>p.i)}):(__LOG__(3)`isChatEphemeral: chat ${e} does not exist`,!1))}};function R(e){return e.toString(16)+"_!"}function N(e){return e.toString(16)+"_g"}function k(e,t){return`${e||"x"}-${t}`}function P(e,t){var n=e.previewMsg,r=n&&t.find(e=>e.id===n.id);return!!r&&(e.previewMsg=(0,b.a)(r)||void 0,!0)}function G(e,t){if(e.previewMsg&&e.previewMsg.id===t.id){var n=(0,b.a)(t);return n?e.previewMsg=n:delete e.previewMsg,!0}return!1}function L(e){if(null==e.plaintext)return!1;if(null==e.filesystemPath&&!(0,A.l)(e.plaintext))return!1;var t=e.mediaEntries[e.msgIds[0]];return!!t&&!!(t.type&(g.c.IMAGE|g.c.AUDIO|g.c.VIDEO|g.c.GIF))&&!t.isViewOnce}function D(e){var t,n;return null!=(t=e.progressiveJpegScanNumber?e.partialSize:null==(n=e.mediaEntries[e.msgIds[0]])?void 0:n.size)?t:0}function x(e,t){return e.groupParticipantsInfo.get(t).then(t=>{if(t){var n=(0,_.a)(t,E.r.get());return n===t?n:(__LOG__(3)`Fixing participantInfo`,SEND_LOGS("fix-participants-info-single"),e.groupParticipantsInfo.put(n).then(()=>n))}})}function U(e,t){return e.groupParticipantsInfo.put(t)}t.c=C},function(e,t,n){n.d(t,"g",(function(){return P})),n.d(t,"c",(function(){return G})),n.d(t,"i",(function(){return L})),n.d(t,"n",(function(){return x})),n.d(t,"l",(function(){return U})),n.d(t,"p",(function(){return F})),n.d(t,"v",(function(){return B})),n.d(t,"e",(function(){return j})),n.d(t,"C",(function(){return V})),n.d(t,"o",(function(){return H})),n.d(t,"z",(function(){return $})),n.d(t,"A",(function(){return q})),n.d(t,"B",(function(){return z})),n.d(t,"s",(function(){return Y})),n.d(t,"r",(function(){return W})),n.d(t,"d",(function(){return ee})),n.d(t,"q",(function(){return ne})),n.d(t,"b",(function(){return ae})),n.d(t,"y",(function(){return ie})),n.d(t,"w",(function(){return se})),n.d(t,"x",(function(){return oe})),n.d(t,"f",(function(){return ue})),n.d(t,"j",(function(){return de})),n.d(t,"t",(function(){return ce})),n.d(t,"a",(function(){return pe})),n.d(t,"u",(function(){return fe})),n.d(t,"h",(function(){return Pe})),n.d(t,"k",(function(){return Ge})),n.d(t,"m",(function(){return xe}));var r=n(9),a=n.n(r),i=n(84),s=n(37),o=n(291),u=n(15),d=n(59),c=n(3),l=n(21),p=n(5),h=n(14),f=n(7),m=n(11),v=n(228),g=n(81),_=n(49),E=(n(33),n(26)),b=n(42),y=n(24),S=n(86),I=n(2),w=n(6),T=n(39),A=n(77),O=n(34),M=n(36),C=n(312),R=n(10),N=n(134),k=n(64);function P(e){return e.table.transact("r",["authors","status"],()=>(performance.now(),D(e).then(e=>(performance.now(),(function(e){var t=0,n=0,r=0,a=0,s=(0,c.E)();return e.forEach(e=>{var o=e.msgsCache;if(0!==o.length){var u=0,d=0;o.forEach(e=>{(0,i.i)(s,e)&&(u+=1,(0,T.h)(e.ack)&&(d+=1))}),n+=u,u>0&&(t+=1),r+=d,d>0&&(a+=1)}}),{statusAvailableCountDaily:n,statusAvailableRowsCountDaily:t,statusViewedCountDaily:r,statusViewedRowsCountDaily:a}})(e)))))}function G(e){var t=performance.now();return e.table.transact("r",["authors","meta"],()=>(0,p.c)([D(e),Se(e),Ie(e)]).then(e=>{var n=a()(e,3),r=n[0],i=n[1],s=n[2],o=performance.now()-t;return __LOG__(2)`getAllAuthors ${o}ms, ${r.length} authors`,{authors:r,me:i,psa:s}}))}function L(e){var t=performance.now();return e.table.transact("rw",["authors","status","meta"],()=>(0,E.d)(e.table.stores.meta,E.a.STATUS_MMS_THUMB_LAST_CHECKED).then(n=>{if(!n||null==n.value||!(0,c.n)(n.value,300))return(0,p.c)([D(e),e.table.stores.status.where("ts").between((0,c.x)(h.Q),(0,c.l)(h.Q)).toArray(),e.table.stores.meta.put({key:E.a.STATUS_MMS_THUMB_LAST_CHECKED,value:(0,c.E)()})]).then(e=>{var n=a()(e,2),r=n[0],i=n[1],s=performance.now()-t;__LOG__(2)`getStatusMmsThumbnailsToDownload ${s}ms, ${r.length} authors & ${i.length} msgs`;var o=new Set;r.forEach(e=>{e.previewMsg&&"text"!==e.previewMsg.content.type&&null==e.previewMsg.content.previewId&&(0,c.n)(e.previewMsg.ts,h.Q)&&o.add(e.previewMsg.id)});var u=[];return i.forEach(e=>{!o.has(e.id)&&null==e.hasPreview&&(0,S.c)(e)&&u.push(e.id)}),{previewMsgIds:Array.from(o),otherMmsThumbnails:u}});performance.now(),__LOG__(2)`Status opened recently, won't download extra thumbnails`}))}function D(e){return e.table.stores.authors.where("sortBy").between((0,c.x)(h.Q),(0,c.l)(h.Q)).reverse().toArray()}function x(e,t,n,r){return e.table.transact("rw",["authors","status","meta"],()=>we(e,t).then(t=>{if(t)return __LOG__(2)`markStatusAsSeen for ${t.id}`,Pe(e,n).then(n=>{var a,i=[];if(n.forEach(e=>{(0,T.h)(e.ack)||e.type!==s.c.FUTUREPROOF&&(e.campaignId&&(a?a.has(e.campaignId)||(__LOG__(3)`Tried to read two statuses from two campaigns at the same time`,SEND_LOGS("psa-status-read-multiple")):a=new Set,a.add(e.campaignId)),e.ack=u.a.READ,i.push(e))}),0!==i.length)return(function(e,t){return e.table.stores.status.bulkPut(t).then(()=>{})})(e,i).then(()=>a&&(function(e,t,n){return(0,E.d)(e.table.stores.meta,E.a.PSA_STATUS_META_KEY).then(r=>{var a;return a=r&&r.value?r.value:new Map,t.forEach(e=>{a.has(e)||a.set(e,n)}),e.table.stores.meta.put({key:E.a.PSA_STATUS_META_KEY,value:a}).then(()=>a)})})(e,a,r)).then(()=>He(e,t)).then(t=>Ae(e,t)).then(e=>({updatedMsgs:i,updatedAuthor:e}));__LOG__(2)`markStatusAsSeen no updates required for ${t.id}`});__LOG__(2)`markStatusAsSeen author no longer exists`}))}function U(e,t,n){return e.table.transact("r",["authors","status"],()=>we(e,t).then(t=>t?e.table.stores.status.where("id").between((0,u.u)(t.id),n,!1,!0).filter(e=>!(0,T.h)(e.ack)&&Ke(e)).toArray():[]))}function F(e,t){return e.table.transact("rw",["authors"],()=>we(e,t).then(t=>t?(t.muted=!0,Ae(e,t)):null))}function B(e,t){return e.table.transact("rw",["authors"],()=>we(e,t).then(t=>t?(delete t.muted,Ae(e,t)):null))}function j(e){return e.table.transact("rw",["status","receipts"],()=>(function(e){return Le(e,s.a).then(e=>e.filter(Ke))})(e).then(t=>{var n=t.map(e=>e.id);return e.table.stores.receipts.where("msgId").anyOf(n).toArray().then(e=>{var n=(0,R.s)(e,e=>e.msgId),r={};return t.forEach(e=>{var t=e.id,a=(0,A.j)(n[t]);r[t]={id:t,preview:(0,g.e)((0,v.a)(e)),acks:a?(0,A.c)(a):null}}),r})}))}function V(e,t){return e.table.transact("rw",["authors","status","receipts","media","previews","contacts","groupParticipantsInfo"],()=>K(e,t))}function K(e,t){return(0,p.c)([e.table.getStatusFromExternalId(s.a,t.msg.externalId),ye(e),ve(e.table.stores)]).then(n=>{var r=a()(n,3),i=r[0],s=r[1],o=r[2];return o?i?e.table.getReceipt(i.id).then(e=>({result:"deduped",author:s,dbMsg:i,to:e&&e.to||(0,l.f)(),keyIncrement:o.info.keyIncrement||0})):X(e,s,t.msg,t.media).then(t=>{var n=t.dbAuthor,r=t.dbMsg;return(function(e,t,n){return e.table.getDevicesInTransaction(n).then(n=>{var r={to:(0,l.m)(Array.from(n)),identityIds:new Map};return(function(e,t,n){var r=(0,A.f)(t.id,m.h,t.ts,!1,n);return e.table.stores.receipts.add((0,A.i)(r)).then(()=>r)})(e,t,r)})})(e,r,(0,l.g)(o.info.participants,e=>e!==w.r.get())).then(e=>({result:"new",author:n,dbMsg:r,to:e.to||(0,l.f)(),keyIncrement:o.info.keyIncrement||0}))}):(__LOG__(4)`_writeOutgoingStatusMsgInTransaction tried to send status without settings`,void SEND_LOGS("error-status-no-settings"))})}function H(e,t,n){return ke(e,t).then(r=>{if(r){if(r.author!==s.a)return __LOG__(4)`markStatusAsSent on incoming message`,null;if(!(0,T.k)(r.ack))return n&&(r.ts=n),r.ack=u.a.SENT,delete r.resendCount,Fe(e,r).then(()=>oe(e)).then(e=>({dbMsg:r,dbAuthor:e}));__LOG__(3)`markStatusAsSent: status ${t} is sent. ack = ${r.ack}`}else __LOG__(3)`markStatusAsSent: status ${t} was not found`})}function $(e,t,n){return e.table.transact("rw",["status","authors","receipts","media","groupParticipantsInfo","previews","contacts","msgs"],()=>{var r=n.map(e=>e.msgId),a=n.length>1;return e.table.getMsgsToForward(r).then(r=>{var i=[];return n.reduce((n,s)=>n.then(()=>{var n=r[s.msgId];if(!n)return null;if("status"===n.type)return __LOG__(3)`Trying to forward a status message into status ${s.msgId}`,SEND_LOGS("unsupported-status-forward"),null;var i=(0,o.d)(n,s.externalId,t,a);return i?K(e,i):null}).then(e=>{e&&i.push(e)}),(0,p.e)()).then(()=>i)}).then(t=>0===t.length?(__LOG__(2)`writeForwardedStatusMsgs no changes required`,null):ye(e).then(e=>({results:t,author:e})))})}function q(e,t){return e.table.transact("rw",["authors","status","meta","media","previews"],()=>Ie(e).then(t=>t||Oe(e,s.b)).then(n=>(0,p.f)(t.map(t=>()=>Z(e,s.b,n,t)))))}function z(e,t,n){return e.table.transact("rw",["authors","status","media","previews"],()=>we(e,t).then(r=>r||(r||n.msg.type===s.c.REVOKED?(__LOG__(3)`Got a message that shouldn't create an author, ignoring`,null):Oe(e,t))).then(r=>r&&Z(e,t,r,n)))}function J(e,t){var n=[];return e.table.stores.status.where("author").equals(s.b).filter(e=>e.campaignId===t&&(n.push(e),!0)).delete().then(()=>n)}function Y(e,t){return e.table.transact("rw",["authors","status","receipts","media","previews"],()=>(0,p.c)([Ie(e),J(e,t)]).then(n=>{var r=a()(n,2),i=r[0],s=r[1];__LOG__(2)`Revoking ${s.length} status from campaign ${t}`;var o=[],u=[];return s.forEach(e=>{o.push(e.id),(0,y.g)(e)&&u.push(e)}),(0,p.c)([i&&He(e,i).then(t=>Ae(e,t)),e.table.stores.previews.bulkDelete(o),b.L(e.table.stores,u,!1)]).then(e=>{var t=a()(e,1)[0];if(t)return{result:"revokedPsa",author:t};__LOG__(3)`Revoke campaign received without PSA author`})}))}function W(e,t){return e.table.transact("rw",["authors","status","receipts","media","previews"],()=>(0,p.c)([ke(e,t),ye(e)]).then(n=>{var r=a()(n,2),i=r[0],o=r[1];if(i){if(i.author!==s.a)return __LOG__(4)`revokeStatusMsg: tried to revoke ${t} from other author.`,void SEND_LOGS("revoke-other-author");if(i.type===s.c.REVOKED)return(0,T.k)(i.ack)?void __LOG__(3)`revokeStatusMsg: tried to revoke already sent revoked msg`:e.table.getReceipt(i.id).then(e=>({result:"removed",author:o,dbMsg:i,to:e&&e.to||(0,l.f)()}));var d={type:s.c.REVOKED,rowId:i.rowId,id:i.id,externalId:(0,M.e)((0,O.l)(7)),ts:i.ts,author:s.a,ack:u.a.CLOCK,revokedExternalId:i.externalId,altIndex:Ve("revoked",i.id)},c=Fe(e,d),h=(0,y.g)(i)?b.L(e.table.stores,[i],!1):null,f=e.table.stores.previews.delete(t),m=e.table.resetReceiptsOnRevokedInTransaction([t]).then(e=>1!==e.length?(__LOG__(3)`revokeStatusMsg: inconsistent receipts received for ${t}`,void SEND_LOGS("revoke-status-receipts")):e[0]);return(0,p.c)([m,c,h,f]).then(t=>{var n=a()(t,1)[0];return oe(e).then(e=>({result:"removed",author:e,dbMsg:d,to:n&&n.to||(0,l.f)()}))})}__LOG__(3)`revokeStatusMsg: tried to revoke non-existent msg ${t}`}))}function Z(e,t,n,r){var a=r.msg,i=r.media;return e.table.getStatusFromExternalId(t,a.externalId).then(t=>t?a.type===s.c.REVOKED?(__LOG__(2)`_writeIncomingStatusMsgInTransaction revoking msg ${t.id}`,(function(e,t,n){return __LOG__(2)`Revoking status msg ${(0,N.a)(n.externalId)}`,(0,p.c)([Be(e,n.rowId),e.table.stores.previews.delete(n.id),(0,y.g)(n)&&b.L(e.table.stores,[n],!1)]).then(()=>He(e,t)).then(t=>Ae(e,t)).then(e=>({updatedAuthor:e,deletedMsg:n}))})(e,n,t).then(e=>({result:"revoked",author:e.updatedAuthor,dbMsg:e.deletedMsg}))):t.type===s.c.CIPHERTEXT&&a.type!==s.c.CIPHERTEXT?(__LOG__(2)`_writeIncomingStatusMsgInTransaction clearing ciphertext ${t.id}`,(function(e,t,n,r,a){return __LOG__(2)`_updateCiphertextMsgInTransaction updating ${n.id}`,(function(e,t){var n=(0,u.t)(t);return e.table.stores.status.where("id").between(t,(0,u.x)(n),!1,!1).first()})(e,n.id).then(i=>{var s=null!=i?i.ack:u.a.RECEIVED,o=Object.assign({},r,{rowId:n.rowId,ack:s,id:n.id,ts:n.ts,author:n.author,altIndex:r.altIndex||n.altIndex});return(a?b.q(e,n.id,o,a).then(t=>{var n=t.toStore;return Fe(e,n)}):Fe(e,o)).then(n=>Ke(n)?He(e,t).then(t=>Ae(e,t)).then(e=>({updatedMsg:n,updatedAuthor:e})):{updatedMsg:n,updatedAuthor:t})})})(e,n,t,a,i).then(t=>{var n=t.updatedAuthor,r=t.updatedMsg;return Q(e,{result:"modified",author:n,dbMsg:r})})):{result:"deduped",author:n,dbMsg:t}:a.type===s.c.REVOKED?null:X(e,n,a,i).then(t=>{var n=t.dbAuthor,r=t.dbMsg;return Q(e,{result:"new",author:n,dbMsg:r})}))}function Q(e,t){var n=(function(e,t){if(!(0,y.g)(e))return!1;if("@psa"===t.jid)return!0;if(null!=e.plaintext)return!1;if(!(function(e){var t,n=null==(t=w.G.get().stats)?void 0:t.externalStorageAvailSize;return!(!n||(e.type===I.f.IMAGE&&n<h.N*e.size?(__LOG__(2)`Not autodownloading img status due to lack of storage`,1):(e.type===I.f.VIDEO||e.type===I.f.GIF)&&n<h.O*e.size&&(__LOG__(2)`Not autodownloading video status due to lack of storage`,1)))})(e))return __LOG__(3)`Not enought storage available, do not autodownload`,!1;if(t.muted||!(0,c.n)(e.ts,h.Q))return __LOG__(2)`No need to autodownload ${e.id}`,!1;var n=t.msgsCache,r=n.findIndex(t=>t.id===e.id);return-1===r?(__LOG__(3)`msgsCache got out of sync for ${e.id}`,SEND_LOGS("autodownload-cache-sync"),!1):0===r?!!t.lastExpiredWasRead:1===r?t.lastExpiredWasRead||(0,T.h)(n[0].ack):(0,T.h)(n[r-1].ack)||(0,T.h)(n[r-2].ack)})(t.dbMsg,t.author);return(0,S.c)(t.dbMsg)&&t.dbMsg.media?b.l(e,t.dbMsg.media).then(e=>Object.assign({},t,{shouldAutodownload:n,shouldDownloadMmsThumb:null!=e&&(0,S.b)(e,t.dbMsg.id)})):Object.assign({},t,{shouldAutodownload:n,shouldDownloadMmsThumb:!1})}function X(e,t,n,r){return(function e(t,n,r){var a=r,i=(0,d.o)(n,++a);return ke(t,i).then(r=>r?(__LOG__(4)`Found existing msg on new increment id`,SEND_LOGS("repaired-status-author-increment"),e(t,n,a)):{msgId:i,increment:a})})(e,t.id,t.increment).then(a=>{var i=a.msgId,s=a.increment;return(function(e,t,n,r){return r?b.q(e,t,n,r).then(n=>{var r=n.toStore;return Ue(e,t,r)}):Ue(e,t,n)})(e,i,n,r).then(n=>(t.increment=s,Ke(n)?He(e,t).then(t=>Ae(e,t)).then(e=>({dbAuthor:e,dbMsg:n})):Ae(e,t).then(()=>({dbAuthor:t,dbMsg:n}))))})}function ee(e){return e.table.transact("rw",["status","authors"],()=>(0,p.c)([te(e),Ie(e).then(t=>t&&!t.muted?(function(e){var t=(0,c.E)();return e.table.stores.status.where("author").equals(s.b).reverse().filter(e=>!(0,T.h)(e.ack)&&!Ne(t,e)&&Ke(e)).first()})(e):null)]).then(e=>{var t=a()(e,2),n=t[0],r=t[1];return n&&r?n.ts>r.ts?n:r:n||r}))}function te(e){return(function(e){return e.table.stores.authors.orderBy("sortBy").filter(e=>"@me"!==e.jid&&!e.muted).toArray()})(e).then(t=>{var n=new Set;return t.forEach(e=>{n.add(e.jid)}),e.table.stores.status.where("ts").above((0,c.x)(h.Q)).reverse().filter(e=>!(0,T.h)(e.ack)&&n.has(e.author)&&Ke(e)).first()})}function ne(e){return e.table.transact("rw",["status","authors","media","previews","receipts","meta"],()=>(function(e){return(0,p.c)([Me(e),Ce(e)]).then(e=>{var t=a()(e,2);return[...t[0],...t[1]]})})(e).then(t=>(__LOG__(2)`Deleting ${t.length} status msgs`,re(e.table.stores,t).then(()=>(function(e,t){__LOG__(2)`Updating authors for deleted messages`;var n=new Map;return t.forEach(e=>{var t=n.get(e.author);Ke(e)&&(!t||t.ts<e.ts)&&n.set(e.author,e)}),be(e.table.stores,Array.from(n.keys())).then(t=>{var r=t.map(t=>{var r=n.get(t.jid);return r?He(e,t).then(e=>(e.lastExpiredWasRead=(0,T.h)(r.ack)||void 0,e)):null}).filter(Boolean);return(0,p.c)(r).then(t=>e.table.stores.authors.bulkPut(t).then(()=>t))})})(e,t)))))}function re(e,t){var n=t.map(e=>e.id);return __LOG__(2)`clearing ${t.length} status msgs`,(0,p.c)([b.L(e,t,!1),e.receipts.bulkDelete(n),e.previews.bulkDelete(n),je(e,t.map(e=>e.rowId))])}function ae(e,t){return Pe(e,t).then(t=>re(e.table.stores,t).then(()=>be(e.table.stores,t.map(e=>e.author)).then(t=>{var n=t.map(t=>He(e,t));return(0,p.c)(n).then(t=>e.table.stores.authors.bulkPut(t).then(()=>{}))})))}function ie(e,t){return e.table.transact("rw",["authors","status","meta"],()=>t===s.a?oe(e):we(e,t).then(t=>{if(t)return He(e,t).then(t=>Ae(e,t))}))}function se(e){return e.table.transact("rw",["authors","status"],()=>oe(e))}function oe(e){return __LOG__(2)`Updating author me stats`,ye(e).then(t=>He(e,t).then(t=>Ae(e,t)))}function ue(e,t,n,r){return e.table.transact("r",["status","receipts"],()=>e.table.stores.status.where("externalId").equals(n).toArray().then(n=>(0,p.c)(n.map(n=>e.table.checkMsgAuthorized(m.h,r,n,t))))).then(e=>0===e.length?void __LOG__(2)`getSentStatusMsgIfAuthorized message is gone`:1===e.length?e[0]:(__LOG__(3)`getSentStatusMsgIfAuthorized unexpected results length ${e.length}`,void SEND_LOGS("unexpected-results-authorized")))}function de(e){return(0,p.i)(ge(e.table.stores))}function ce(e,t){return e.table.transact("rw",["groupParticipantsInfo","meta"],()=>ge(e.table.stores).then(n=>{if(n)return __LOG__(3)`Tried to initialize already initialized status settings ${n.type}`,SEND_LOGS("initial-status-settings-twice"),n;__LOG__(2)`setInitialStatusPrivacy init to ${null==t?void 0:t.type}`;var r=le(t);return(0,p.c)([Ee(e.table.stores,t),e.table.setParticipantsInfo(r)]).then(()=>t)}))}function le(e){__LOG__(2)`Initializing status participants info`;var t=e.participants,n=new Map;return t.forEach(e=>n.set((0,f.e)(e),!1)),{jid:m.h,participants:t,knowsSenderKey:n,keyIncrement:0,rotateSenderKey:!0,senderKeyTimestamp:(0,c.E)()}}function pe(e,t){return(0,p.c)([ve(e).then(t=>{if(t)return(function(e,t){return me(e,(0,i.l)(t.settings),t).then(e=>{var n=e.settings;if(!(0,C.a)(n,t.settings))return{settings:n,whitelistUpdated:!(0,l.b)(n.whitelist,t.settings.whitelist)}})})(e,t);__LOG__(2)`contactsUpdatedInTransaction without existing privacy info`}),t.length>0&&he(e,t)]).then(e=>{var n=a()(e,1)[0];return n?{settings:n.settings,whitelistUpdated:n.whitelistUpdated,removed:t}:{removed:t}})}function he(e,t){return(0,p.c)([be(e,t),De(e,t)]).then(t=>{var n=a()(t,2),r=n[0],i=n[1];return re(e,i).then(()=>(function(e,t){var n=[],r=[];return t.forEach(e=>{!(function(e){return e.muted})(e)?r.push(e.id):n.push((function(e){return{id:e.id,jid:e.jid,muted:e.muted,msgsCache:[],increment:e.increment}})(e))}),(0,p.c)([e.authors.bulkPut(n),e.authors.bulkDelete(r)]).then(()=>{__LOG__(2)`${n.length} authors cleared, ${r.length} authors deleted`})})(e,r))})}function fe(e,t){return e.table.transact("rw",["contacts","groupParticipantsInfo","meta"],()=>ve(e.table.stores).then(n=>n?me(e.table.stores,t,n).then(e=>e.settings):(__LOG__(4)`setStatusPrivacy called without being initialized`,void SEND_LOGS("set-status-privacy-not-initialized"))))}function me(e,t,n){return __LOG__(2)`_putStatusPrivacySettingsInTransaction setting to ${t.type}`,(function(e){return e.contacts.orderBy("phonebookPhone").filter(e=>!e.noWhatsApp).toArray().then(e=>e.map(e=>e.jid))})(e).then(r=>{var a=n.settings,s=n.info,o=(0,i.d)(r,t,a),u=(function(e,t,n){var r,a,i=(0,l.n)(t,e),s=(0,l.n)(e,t);if(i.length>0){__LOG__(2)`statusParticipantsInfo removed ${i.length}`;var o=new Map;e.forEach(e=>{o.set((0,f.e)(e),!1)}),r=o,a=!0}else{if(!(s.length>0))return void __LOG__(2)`statusParticipantsInfo no changes on participants list`;__LOG__(2)`statusParticipantsInfo added ${s.length}`;var u=new Map(n.knowsSenderKey);s.forEach(e=>{u.set((0,f.e)(e),!1)}),r=u,a=n.rotateSenderKey}return{jid:m.h,participants:e,knowsSenderKey:r,rotateSenderKey:a,keyIncrement:n.keyIncrement,senderKeyTimestamp:n.senderKeyTimestamp}})(o.participants,a.participants,s);return(0,p.c)([Ee(e,o),u&&(0,k.i)(e,u)]).then(()=>({settings:o,info:u||s}))})}function ve(e){return(0,p.c)([ge(e),_e(e)]).then(e=>{var t=a()(e,2),n=t[0],r=t[1];return n?(r&&(0,l.b)(r.participants,n.participants)||(__LOG__(3)`Status settings participants are not in sync with participants info.`,SEND_LOGS("status-settings-participants-sync"),r=le(n)),{settings:n,info:r}):null})}function ge(e){return(0,E.d)(e.meta,E.a.STATUS_PRIVACY_META_KEY).then(e=>null==e?void 0:e.value)}function _e(e){return(0,k.e)(e,m.h).then(e=>e&&(0,_.h)(e))}function Ee(e,t){return e.meta.put({key:E.a.STATUS_PRIVACY_META_KEY,value:t}).then(()=>t)}function be(e,t){return e.authors.where("jid").anyOf(t).toArray()}function ye(e){return Se(e).then(t=>t||Oe(e,s.a))}function Se(e){return e.table.stores.authors.where("jid").equals(s.a).first()}function Ie(e){return e.table.stores.authors.where("jid").equals(s.b).first()}function we(e,t){return e.table.stores.authors.where("jid").equals(t).first()}function Te(e,t){return e.table.stores.authors.where("id").equals(t).first()}function Ae(e,t){return __LOG__(2)`Updating status author ${t.jid} increment ${t.increment}`,e.table.stores.authors.put(t).then(()=>t)}function Oe(e,t){return we(e,t).then(n=>{if(n)return __LOG__(4)`createEmptyAuthor: author ${t} already exists`,SEND_LOGS("created-author-twice"),n;var r={jid:t,increment:0,msgsCache:[]};return e.table.stores.authors.add(r).then(e=>Object.assign({},r,{id:e}))})}function Me(e){return e.table.stores.status.where("ts").below((0,c.x)(h.Q)).toArray().then(e=>e.filter(e=>e.author!==s.b&&(e.author!==s.a||(0,T.k)(e.ack))))}function Ce(e){return(0,p.c)([e.table.stores.status.where("author").equals(s.b).toArray(),Re(e)]).then(e=>{var t=a()(e,2),n=t[0],r=t[1],i=(0,c.E)();return n.filter(e=>Ne(i,e,r))})}function Re(e){return(0,E.d)(e.table.stores.meta,E.a.PSA_STATUS_META_KEY).then(e=>{if(e&&e.value)return e.value})}function Ne(e,t,n){if(!t.campaignId)return __LOG__(4)`PSA status without campaignId`,!0;var r=t.campaignId,a=n&&n.get(r);return null!=a?!(0,c.o)(e,a,h.Q):null!=t.campaignDuration&&!(0,c.o)(e,t.ts,t.campaignDuration)}function ke(e,t){return e.table.stores.status.where("id").equals(t).first()}function Pe(e,t){return e.table.stores.status.where("id").anyOf(t).toArray()}function Ge(e,t){return e.table.transact("r",["authors","status"],()=>{var n=(0,u.t)(t);return(0,p.c)([ke(e,t),Te(e,n)]).then(e=>{var t=a()(e,2),n=t[0],r=t[1];if(null!=n)return null==r?(__LOG__(4)`Found status ${n.id} but not its author (supposed to be ${n.author})`,void SEND_LOGS("statusDb-getStatusWithAuthorFromId-statusWithoutAuthor")):{dbStatus:n,dbStatusAuthor:r}})})}function Le(e,t){return e.table.stores.status.where("author").equals(t).toArray()}function De(e,t){return e.status.where("author").anyOf(t).toArray()}function xe(e,t){return e.table.transact("r",["status","media","previews"],()=>e.table.stores.status.get(t).then(t=>(function(e,t){if(t){var n=(0,y.g)(t)&&t.media,r=(0,y.l)(t)&&t.hasPreview;if(!n&&!r)return{dbMsg:t,preview:null,dbMedia:null};var i=b.i(e,t),s=n?b.l(e,n):null;return(0,p.c)([s,i]).then(e=>{var n=a()(e,2),r=n[0],i=n[1];return{dbMsg:t,dbMedia:r,preview:i}})}})(e,t)))}function Ue(e,t,n){var r=Object.assign({},n,{id:t,altIndex:Ve(n.altIndex,t)});return e.table.stores.status.add(r).then(e=>{var t=r;return t.rowId=e,t})}function Fe(e,t){return e.table.stores.status.put(t).then(()=>t)}function Be(e,t){return e.table.stores.status.delete(t)}function je(e,t){return e.status.bulkDelete(t)}function Ve(e,t){return`${e||"x"}-${t}`}function Ke(e){return e.type===s.c.FUTUREPROOF||e.type===s.c.TEXT||e.type===s.c.IMAGE||e.type===s.c.VIDEO||e.type===s.c.GIF}function He(e,t){return(function(e,t){var n=t.jid===s.b?Re(e):null;return(0,p.c)([Le(e,t.jid),n]).then(e=>{var n,r=a()(e,2),i=r[0],s=r[1],o=[];i.sort((e,t)=>e.ts-t.ts).forEach(e=>{if(Ke(e)){var t={id:e.id,ts:e.ts,ack:e.ack},r=e.campaignId;r&&(t.campaignId=r,t.campaignDuration=e.campaignDuration,s&&s.has(r)&&(t.campaignReadTs=s.get(r))),o.push(t),n=e}});var u=(0,_.m)(t.jid,{user:e=>{var t;return{sortBy:null==(t=n)?void 0:t.ts,previewMsg:n&&(0,v.a)(n)}},me:()=>({sortBy:void 0,previewMsg:n&&(0,v.a)(n)}),psa:()=>({sortBy:void 0,previewMsg:void 0})});return{sortBy:u.sortBy,previewMsg:u.previewMsg,msgsCache:o}})})(e,t).then(e=>{var n=e.sortBy,r=e.previewMsg,a=e.msgsCache,i=Object.assign({},t);return i.msgsCache=a,n?i.sortBy=n:delete i.sortBy,r?i.previewMsg=r:delete i.previewMsg,i})}},function(e,t,n){n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return i})),n(3).a;var r=n(166)({Star:"star",Contact:"contact",Mute:"mute",PinDEPRECATED:"pin",Pin:"pin_v1",SettingPushName:"setting_pushName",LabelEdit:"label_edit",LabelMessage:"label_message",LabelJid:"label_jid",QuickReply:"quick_reply",LocaleSetting:"setting_locale",Archive:"archive",MarkChatAsRead:"markChatAsRead",ClearChat:"clearChat",DeleteMessageForMe:"deleteMessageForMe",Sentinel:"sentinel",UnarchiveChatsSetting:"setting_unarchiveChats",DeleteChat:"deleteChat",AndroidUnsupportedActions:"android_unsupported_actions",PrimaryFeature:"primary_feature",Subscription:"subscription",Nux:"nux",Agent:"deviceAgent",TimeFormat:"time_format"}),a=n(166)({Regular:"regular",RegularLow:"regular_low",RegularHigh:"regular_high",CriticalBlock:"critical_block",CriticalUnblockLow:"critical_unblock_low"}),i=(n(166).Mirrored(["Success","SuccessHasMore","Conflict","ConflictHasMore","ErrorRetry","ErrorFatal","Blocked"]),n(166).Mirrored(["UpToDate","Dirty","FailingFiniteRetry","Fatal","Blocked"]),n(166).Mirrored(["Success","Malformed","Orphan","Unsupported","Skipped","Failed"]));n(166)({Msg:"Msg",Chat:"Chat"}),n(166).Mirrored(["ApplyRemoteAndDropLocal","SkipRemote","SkipRemoteAndDropLocal"]),n(166).Mirrored(["Patch","Snapshot","Local"])},,function(e,t,n){n.d(t,"b",(function(){return a})),n.d(t,"f",(function(){return i})),n.d(t,"e",(function(){return s})),n.d(t,"d",(function(){return o})),n.d(t,"c",(function(){return u})),n.d(t,"a",(function(){return d}));var r=n(12);function a(e){if("exists"===e.type)return e.chatId;e.type;var t=e.contact,n=e.chat,a=e.msgs;return t&&(0,r.c)("event","contactsModified",{changed:[t]}),n&&(0,r.c)("event","msgsReceived",{newMsgs:a.map(e=>null==e?void 0:e.msg).filter(Boolean),changedMsgs:[],affectedChats:[n]}),n.id}function i(e){0!==e.length&&(0,r.c)("event","msgsReceived",{newMsgs:[],changedMsgs:[],affectedChats:e})}function s(e){return i([e.chat]),e.chat.id}function o(e){e&&e.forEach(u)}function u(e){e&&(e.notifications&&e.notifications.length>0&&e.notifications.forEach(e=>{"updated_chat"===e.result?s(e):"revoked_group_invites"===e.result?d(e):u(e)}),e.updatedContact&&(0,r.c)("event","contactsModified",{changed:[e.updatedContact]}),"deduped"!==e.result&&("new"===e.result?(0,r.c)("event","msgsReceived",{newMsgs:[e.msg].filter(Boolean),changedMsgs:[],affectedChats:[e.chat]}):(e.result,(0,r.c)("event","msgsReceived",{newMsgs:[],changedMsgs:[{msg:e.msg,recent:"modified_from_recent"===e.result}],affectedChats:[e.chat]}))))}function d(e){var t=e.groupJid,n=e.outgoing,a=e.revokes;0!==a.length&&(0,r.c)("event","groupInvitesRevoked",{groupJid:t,outgoing:n,revokes:a})}},,,,function(e,t,n){n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return i})),n.d(t,"c",(function(){return s}));var r=n(11),a={JID:0,JID_U:1,JID_AD:1,JID_FB:3},i=n(166)({WHATSAPP:0,LID:1}),s=class e{constructor(e){this.Cl=e}static createAD(t,n,r){return new e({type:a.JID_AD,user:t,device:null==r?0:r,agent:null==n?0:n,domainType:i.WHATSAPP})}static createJidU(t,n,r){return new e({type:a.JID_U,user:t,device:null==r?0:r,domainType:null==n?i.WHATSAPP:n})}static createFbJid(t,n){var r=null==n?0:n;return new e({type:a.JID_FB,user:t,device:r})}static create(t,n){return new e({type:a.JID,user:t,server:n})}toString(){if(this.Cl.type===a.JID_AD||this.Cl.type===a.JID_U){var e=this.Cl,t=e.user,n=e.device,s=e.domainType===i.WHATSAPP?r.k:r.e;return 0===n?`${t}@${s}`:`${t}:${n}@${s}`}if(this.Cl.type===a.JID_FB){var o=this.Cl;return`${o.user}:${o.device}@${r.g}`}this.Cl.type;var u=this.Cl,d=u.user,c=u.server;return null!=d?`${d}@${c}`:c}getInnerJid(){return this.Cl}}},,,function(e,t,n){n.d(t,"a",(function(){return c.d})),n.d(t,"b",(function(){return o.a})),n.d(t,"d",(function(){return p})),n.d(t,"c",(function(){return h}));var r=n(119),a=n(3);function i(e,t,n){return(r,a,i)=>e(r,a,i)?t(r,a,i):n(r,a,i)}function s(e,t,n){var r={requirements:e,code:t,stopRetryIf:n};return()=>r}var o=n(46),u=n(266),d=n(12),c=n(4),l=null;function p(){return null==l&&(l=(0,d.d)()?new u.a("page api"):new u.b("page api")),l}function h(){return new class e{constructor(e){this.steps=e}step(e,t){return this.KO(e,"function"==typeof t?{code:t}:t)}KO(t,n){var o,u=n.stopRetryIf,d=s(n.requirements,n.code,u);if(u){var c=u.timePassedSeconds,l=u.appCrashed,p=s(null,(o=u.onStopRetry,(e,t,n)=>Promise.resolve(o(e,t,n)).then(e=>e instanceof r.b?e:new r.b(e))),u);null!=c&&(d=i((e,t,n)=>{var r=n.jobStartTime;return(0,a.n)(r,c)},d,p)),l&&(d=i((e,t,n)=>!n.afterCrash,d,p))}return new e([...this.steps,{stepName:t,info:d}])}finalStep(e,t){var n=this.step(e,t);return{end:()=>n.steps}}}([])}},,function(e,t,n){n.d(t,"g",(function(){return c})),n.d(t,"f",(function(){return l})),n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return h})),n.d(t,"e",(function(){return f})),n.d(t,"c",(function(){return m})),n.d(t,"d",(function(){return v})),n.d(t,"i",(function(){return S})),n.d(t,"h",(function(){return I})),n.d(t,"j",(function(){return w}));var r=n(2),a=n(21),i=n(3),s=n(7),o=n(39),u=60*i.b,d=[r.a.INACTIVE_RECEIVED,r.a.RECEIVED,r.a.READ,r.a.PLAYED];function c(e){var t=e.to?e.to.length:1;return Object.assign({},e,{data:g(2*t)})}function l(e,t,n,r,a){var i=a.to.length,s={msgId:e,chat:t,sent:n,data:g(2*i),inactiveReceiptsData:g(i),to:a.to,identityIds:a.identityIds};return r&&(s.playedData=g(i)),s}function p(e,t){var n=e.identityIds||new Map;return t.forEach((e,t)=>{n.has(t)||n.set(t,e)}),0===n.size?e:Object.assign({},e,{identityIds:n})}function h(e,t,n,u){var c=(0,s.w)(n.chat,{user:e=>n.to?n.to:a.l((0,s.e)(e)),multicast:e=>n.to?n.to:(__LOG__(4)`applyUpdateToReceipt oldReceipt.to is null for group chat ${n.chat}`,SEND_LOGS("multicast-receipt-with-null-to"),a.f())}),l=a.m(u.map(e=>e.participant)),p=a.n(l,c);if(p.length>0){var h=new Set(c.map(s.h)),f=p;(p=a.g(f,e=>h.has((0,s.h)(e)))).length<f.length&&__LOG__(3)`Received receipt for user we did not send to`}var m=new DataView(n.data),v=new DataView(n.inactiveReceiptsData),S=n.playedData?new DataView(n.playedData):null;if(S&&S.byteLength/4!==c.length&&(S=new DataView(g(c.length))),p.length>0){for(var I=new Map,w=c.length,T=0;T<w;++T)I.set(c[T],{delivered:b(m,2*T),read:b(m,2*T+1),inactive:b(v,T),played:S?b(S,T):i.c});w=(c=a.j(c,p)).length,m=new DataView(g(2*w)),v=new DataView(g(w)),S=S&&new DataView(g(w));for(var A=0;A<w;++A){var O=I.get(c[A]);O&&(y(m,2*A,O.delivered),y(m,2*A+1,O.read),y(v,A,O.inactive),S&&y(S,A,O.played))}}for(var M=[],C=[],R=new Map,N=0;N<c.length;++N)R.set(c[N],N);for(var k=0;k<u.length;++k){var P=R.get(u[k].participant);null!=P&&(M.push(P),C.push(u[k].ts))}if(0===M.length)return __LOG__(3)`applyUpdatesToReceipt all participants are not in to array`,null;var G=!1,L=(e,t)=>t.some(t=>!E(e,t));(0,o.g)(t)&&S&&L(S,M)&&(S=_(S,M,C),G=!0),t===r.a.INACTIVE_RECEIVED&&L(v,M)&&(v=_(v,M,C),G=!0);var D=M.map(e=>2*e+1),x=M.map(e=>2*e);(0,o.h)(t)&&L(m,D)&&(m=_(m,D,C),G=!0),(0,o.j)(t)&&L(m,x)&&(m=_(m,x,C),G=!0);var U=n.identityIds;if(U&&d.includes(t)&&(U=new Map(U),u.forEach(e=>{var t=e.participant;U&&U.has(t)&&(U.delete(t),G=!0)}),0===U.size&&(U=null)),t===r.a.SENDER_BACKFILL_SENT&&p.length>0&&(G=!0),(0,o.i)(t)&&e===r.a.SENT&&(G=!0),!G)return null;var F=Object.assign({},n,{to:c,data:m.buffer,inactiveReceiptsData:v.buffer,identityIds:U});if(S&&(F.playedData=S.buffer),t===r.a.SENDER_BACKFILL_SENT)return{updatedAck:null,updatedReceipt:F};var B=(0,s.w)(n.chat,{user:e=>{for(var t=!1,n=!1,r=!1,a=0;a<c.length&&(t=t||E(m,2*a),n=n||E(m,2*a+1),r=r||S&&E(S,a),!t||!n||!r&&S);a++);return{hasProcessedReceipts:t||n||r,isAllReceived:t,isAllRead:n,isAllPlayed:r}},multicast:e=>{for(var t=new Map,n=!1,r=0;r<c.length;r++){var a=(0,s.h)(c[r]),i=t.get(a)||{received:!1,read:!1,played:!1};E(m,2*r)&&(i.received=!0,n=!0),E(m,2*r+1)&&(i.read=!0,n=!0),S&&E(S,r)&&(i.played=!0,n=!0),t.set(a,i)}var o=Array.from(t.values());return{hasProcessedReceipts:n,isAllReceived:o.every(e=>e.received),isAllRead:o.every(e=>e.read),isAllPlayed:o.every(e=>e.played)}}}),j=B.hasProcessedReceipts,V=B.isAllReceived,K=B.isAllRead,H=B.isAllPlayed;return{updatedAck:!j&&(0,o.i)(t)?t:H&&!(0,o.g)(e)?r.a.PLAYED:K&&!(0,o.h)(e)?r.a.READ:V&&!(0,o.j)(e)?r.a.RECEIVED:null,updatedReceipt:F}}function f(e,t,n){var r=(0,s.w)(e.chat,{user:t=>e.to||[(0,s.e)(t)],multicast:t=>e.to||[]}).findIndex(e=>e===t);if(-1===r)return __LOG__(2)`isRetryAuthorized did not send to ${t}`,!1;if("retry"===n){if(new DataView(e.data).getInt32(8*r)!==i.c)return __LOG__(2)`isRetryAuthorized already received by ${t}`,!1;if(b(new DataView(e.inactiveReceiptsData),r)!==i.c)return __LOG__(2)`isRetryAuthorized already inactively received by ${t}`,!1;if(!(0,i.n)(e.sent,u))return __LOG__(2)`isRetryAuthorized expired message`,!1}return!0}function m(e){for(var t={},n=(0,s.w)(e.chat,{user:t=>e.to||[(0,s.e)(t)],multicast:()=>e.to||[]}),a=new DataView(e.data),o=e.playedData&&new DataView(e.playedData),u=0;u<n.length;u++){var d=(0,s.h)(n[u]),c=t[d]||{},l=b(a,2*u);if(l!==i.c){var p=(0,i.j)(l);r.a.RECEIVED in c?c[r.a.RECEIVED]>p&&(c[r.a.RECEIVED]=p):c[r.a.RECEIVED]=p}var h=b(a,2*u+1);if(h!==i.c){var f=(0,i.j)(h);r.a.READ in c?c[r.a.READ]>f&&(c[r.a.READ]=f):c[r.a.READ]=f}var m=o?b(o,u):i.c;if(m!==i.c){var v=(0,i.j)(m);r.a.PLAYED in c?c[r.a.PLAYED]>v&&(c[r.a.PLAYED]=v):c[r.a.PLAYED]=v}t[d]=c}return t}function v(e){return{to:e.to||(0,s.w)(e.chat,{user:e=>a.l((0,s.e)(e)),multicast:t=>(__LOG__(4)`getOutgoingToInfo receipt.to is null for group chat ${e.chat}`,SEND_LOGS("getOutgoingToInfo-multicast-receipt-with-null-to"),a.f())}),identityIds:e.identityIds||new Map}}function g(e){for(var t=new ArrayBuffer(4*e),n=new DataView(t),r=0;r<t.byteLength;r+=4)n.setInt32(r,i.c);return t}function _(e,t,n){if(t.length!==n.length)throw new Error("Indices and timestamps array sizes do not match");for(var r=e.byteOffset,a=e.buffer.slice(r,r+e.byteLength),i=new DataView(a),s=0;s<t.length;++s)E(e,t[s])||y(i,t[s],n[s]);return i}function E(e,t){return e.getInt32(4*t)!==i.c}function b(e,t){return e.getInt32(4*t)}function y(e,t,n){e.setInt32(4*t,n)}function S(e){return e}function I(e){var t=e.to?e.to.length:1,n={msgId:e.msgId,chat:e.chat,sent:e.sent,data:e.data,inactiveReceiptsData:e.inactiveReceiptsData||g(t),identityIds:e.identityIds};return e.playedData&&(n.playedData=e.playedData),e.to&&(n.to=a.k(e.to,e=>{var t=(0,s.o)(e);if("phoneUser"===t.jidType)return(0,s.e)(t.userJid);if("phoneDevice"===t.jidType)return t.deviceJid;throw new Error("Expected {PhoneUserJid | PhoneDeviceJid} but got "+e)})),n}function w(e){return e?I(e):null}},,,,function(e,t,n){n.d(t,"a",(function(){return l})),n.d(t,"d",(function(){return p})),n.d(t,"e",(function(){return h})),n.d(t,"b",(function(){return f})),n.d(t,"c",(function(){return m}));var r=n(37),a=n(84),i=n(31),s=n.n(i),o=n(133),u=n(49),d=n(24),c=null;function l(e){c=e}function p(e){var t,n,i,s;switch(e.type){case r.c.TEXT:s={type:"text",text:e.text.trim(),hexBackgroundColor:(0,a.c)(e.backgroundColor),linkPreview:e.linkPreview,linkPreviewImage:e.hasPreview?{previewId:e.id,backgroundColor:e.bg}:void 0,fromFb:e.fromFb,actionLink:e.actionLink};break;case r.c.IMAGE:s={type:"image",mediaStatus:(0,o.a)(e,c),preview:(0,d.b)(e),highResPreview:null,height:e.height,width:e.width,caption:null==(t=e.text)?void 0:t.trim(),bg:e.bg,size:e.size,actionLink:e.actionLink};break;case r.c.VIDEO:s={type:"video",mediaStatus:(0,o.a)(e,c),duration:e.duration,rotation:e.rotation,size:e.size,width:e.width,height:e.height,caption:null==(n=e.text)?void 0:n.trim(),preview:(0,d.b)(e),highResPreview:e.frame,bg:e.bg,actionLink:e.actionLink};break;case r.c.GIF:s={type:"gif",mediaStatus:(0,o.a)(e,c),duration:e.duration,rotation:e.rotation,size:e.size,width:e.width,height:e.height,caption:null==(i=e.text)?void 0:i.trim(),preview:(0,d.b)(e),highResPreview:e.frame,bg:e.bg,actionLink:e.actionLink};break;default:s={type:"text",text:"",hexBackgroundColor:e.bg||"black",linkPreview:void 0,linkPreviewImage:void 0,fromFb:void 0}}return{id:e.id,ack:e.ack,content:s,authorJid:e.author}}function h(e){if(null==e)return null;var t=e.content;switch(t.type){case"text":return{type:"text",text:t.text,hexBackgroundColor:(0,a.c)(t.backgroundColor)};case"image":case"gif":case"video":return(function(e){if(e.previewId||e.bg)return{type:"media",previewId:e.previewId,bgColor:e.bg}})(t);default:return(0,s.a)(t.type)}}function f(e,t){var n=v(e,t);return{jid:r.a,preview:h(e.previewMsg),msgs:n}}function m(e,t){var n=v(e,t);if(0!==n.length){var i=(0,a.g)(n),s=e.muted?"muted":0===i.count?"viewed":"recent";return(0,u.m)(e.jid,{user:t=>{var r=e.sortBy;if(null!=r)return{id:e.id,jid:t,muted:e.muted,sortBy:r,preview:h(e.previewMsg),msgs:n,section:s,unread:i};__LOG__(3)`sortStatusAuthors received author ${e.jid} without sortBy.`},me:()=>(__LOG__(4)`sortStatusAuthors received unexpected author ${e.jid}`,null),psa:()=>({id:e.id,jid:r.b,muted:e.muted,msgs:n,sortBy:Number.MAX_SAFE_INTEGER,section:s,unread:i})})}}function v(e,t){return e.msgsCache.filter(e=>(0,a.i)(t,e))}},,function(e,t,n){n.d(t,"e",(function(){return o})),n.d(t,"f",(function(){return u})),n.d(t,"d",(function(){return d})),n.d(t,"c",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return p}));var r=n(9),a=n.n(r),i=n(46),s=n(10);function o(e,t){if(e.hasAttr("error")){var n=e.attrString("error");return t.hasOwnProperty(n)?(0,t[n])(e):(__LOG__(3)`Unrecognized error code received`,SEND_LOGS("Unrecognized error code."),{reason:"unknown"})}}function u(e,t){var n=e.errorCode.toString();return t.hasOwnProperty(n)?t[n]:{error:{reason:"unknown"}}}function d(e){return{error:{reason:e}}}function c(e){return()=>({reason:e})}function l(e,t){return n=>({reason:e,extra:t(n)})}function p(e,t,n){return new i.a(e,e=>{e.assertTag("error");var r=e.attrString("code"),i=t[r];if(i)return{error:{reason:i}};if(n){var o=(0,s.v)(n).find(e=>{var t=a()(e,2);return t[0],t[1][0]===r});if(null!=o){var u=a()(o,2);return{error:{reason:u[0],extra:(0,u[1][1])(e)}}}}return{error:{reason:"unknown"}}})}},,,function(e,t,n){n.d(t,"g",(function(){return u})),n.d(t,"b",(function(){return d})),n.d(t,"c",(function(){return c})),n.d(t,"a",(function(){return l})),n.d(t,"f",(function(){return p})),n.d(t,"e",(function(){return h})),n.d(t,"d",(function(){return f}));var r=n(2),a=n(23),i=n(24),s=n(6),o=n(3);function u(e){return e.type===r.f.DOCUMENT&&void 0===e.isVCard||(0,i.k)(e)&&(e.type===r.f.IMAGE||e.type===r.f.VIDEO||e.type===r.f.GIF)}function d(e,t){var n=e.mediaEntries[t];return n?null!=n.progressiveJpeg&&null!=n.directPath||null!=e.mmsThumb&&null!=n.mmsThumb&&null!=n.mmsThumb.directPath:(__LOG__(3)`hasMmsThumbnailInfo no entry found on ${e.mediaId}:${t}`,!1)}function c(e){if(e.author!==r.b&&u(e)&&"mms"!==e.hasPreview){if(e.type===r.f.DOCUMENT&&(0,a.a)("download_document_thumb_mms_enabled"))return!0;if((0,i.k)(e)&&(0,i.e)(e)&&(0,a.a)("download_status_thumb_mms_enabled")&&(null==(t=s.F.get().tabLastOpened)||(0,o.n)(t,14*o.b)))return!0}var t;return!1}function l(e){return e.type===r.f.DOCUMENT&&!e.isVCard}function p(e){if(u(e)){if(e.type===r.f.DOCUMENT&&(0,a.a)("upload_document_thumb_mms_enabled"))return!0;if((0,i.k)(e)&&(0,i.e)(e)&&(0,a.a)("upload_status_thumb_mms_enabled"))return!0}return!1}function h(e){return!(!u(e)||"mms"!==e.hasPreview||e.type!==r.f.DOCUMENT)&&(0,a.a)("send_document_thumb_in_message_disabled")}function f(e){return!u(e)||"mms"!==e.hasPreview||!(0,a.a)("send_status_thumb_in_message_disabled")}},,function(e,t,n){n.d(t,"c",(function(){return s}));var r=n(46);n.d(t,"b",(function(){return r.a}));var a=n(4);n.d(t,"a",(function(){return a.a}));var i=1;function s(e,t,n){var r=1;return function(a,s){var o=`ServerJob.${i++} ${e}.${r++}`;__LOG__(2)`${o}: starting`;var u=t.parse(a);if(u.error)return __LOG__(4)`${o}: ${u.error} parsing ${a}`,Promise.reject(u.error);var d=Promise.resolve().then(()=>n(u.success,s)).then(e=>(__LOG__(2)`${o}: success`,"NO_ACK"===e?null:e));return d.catch(e=>{__LOG__(4)`${o}: error ${e}`}),d}}},function(e,t,n){n.d(t,"c",(function(){return i}));var r=n(12),a=n(119);function i(e){if(!(0,r.d)())throw new a.d(e)}n.d(t,"a",(function(){return a.d})),n.d(t,"b",(function(){return a.e}))},function(e,t,n){function r(e){return"old_version"===e||"blocked"===e||"missing_param"===e||"bad_param"===e}function a(e,t,n,r,a){var i=t.localNumber,s=t.country;return"blocked"===n?{type:"ENTERING_PHONE_NUMBER",prefill:{country:s,localNumber:i},state:{type:r,reason:"blocked",localNumber:i,cc:s.cc}}:"old_version"===n?{type:"BLOCKED",error:{reason:n,localNumber:i,cc:s.cc}}:"missing_param"===n?{type:"ENTERING_PHONE_NUMBER",prefill:{country:s,localNumber:i},state:{type:r,reason:"missing_param",localNumber:i,cc:s.cc,param:a}}:"number"===a?{type:"ENTERING_PHONE_NUMBER",prefill:{country:s,localNumber:i},state:{type:r,reason:"bad_param",localNumber:i,cc:s.cc,param:a}}:{type:"BLOCKED",error:{reason:"bad_param",localNumber:i,cc:s.cc}}}function i(e,t,n){return{type:"ENTERING_PHONE_NUMBER",prefill:{country:t,localNumber:e},state:{type:n,reason:"unknown",localNumber:e,cc:t.cc}}}n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return i}))},,,,function(e,t,n){n.d(t,"e",(function(){return f})),n.d(t,"f",(function(){return m})),n.d(t,"c",(function(){return v})),n.d(t,"a",(function(){return g})),n.d(t,"i",(function(){return _})),n.d(t,"h",(function(){return E})),n.d(t,"g",(function(){return y})),n.d(t,"d",(function(){return S})),n.d(t,"b",(function(){return I}));var r=n(33),a=n(2),i=n(105),s=n(12),o=n(45),u=n(89),d=n(31),c=n.n(d),l=n(10),p=n(43),h=n(120);function f(e){return(0,l.h)(e).then(e=>(0,h.a)(e)).then(e=>(0,p.e)(new Uint8Array(e)))}function m(e){return e&r.c.IMAGE?"image":e&r.c.STICKER?"sticker":e&r.c.PTT?"ptt":e&r.c.AUDIO?"audio":e&r.c.GIF?"gif":e&r.c.VIDEO?"video":e&r.c.MD_HISTORY?"md-msg-hist":e&r.c.THUMBNAIL_DOCUMENT?"thumbnail-document":e&r.c.THUMBNAIL_IMAGE?"thumbnail-image":e&r.c.THUMBNAIL_LINK?"thumbnail-link":e&r.c.THUMBNAIL_VIDEO?"thumbnail-video":e&r.c.THUMBNAIL_GIF?"thumbnail-gif":e&r.c.MD_APP_STATE?"md-app-state":(e&r.c.DOCUMENT||(__LOG__(4)`endpointForType unrecognized ${e}`,SEND_LOGS("unrecognized-endpoint-for-media-type")),"document")}function v(e){return"/mms/"+m(e)}function g(e){return e&(r.c.IMAGE|r.c.STICKER)?"image":e&(r.c.PTT|r.c.AUDIO)?"audio":e&(r.c.GIF|r.c.VIDEO)?"video":e&r.c.MD_HISTORY?"history":e&r.c.THUMBNAIL_DOCUMENT?"thumbnail-document":e&r.c.THUMBNAIL_IMAGE?"thumbnail-image":e&r.c.THUMBNAIL_LINK?"thumbnail-link":e&r.c.THUMBNAIL_VIDEO?"thumbnail-video":e&r.c.THUMBNAIL_GIF?"thumbnail-gif":e&r.c.MD_APP_STATE?"md-app-state":(e&r.c.DOCUMENT||__LOG__(4)`baseType unrecognized type ${e}`,"doc")}function _(e){if(e===a.f.IMAGE)return r.c.THUMBNAIL_IMAGE;if(e===a.f.VIDEO)return r.c.THUMBNAIL_VIDEO;if(e===a.f.GIF)return r.c.THUMBNAIL_GIF;if(e===a.f.DOCUMENT)return r.c.THUMBNAIL_DOCUMENT;if(e===a.f.TEXT)return r.c.THUMBNAIL_LINK;throw new Error("msgTypeToMediaType bad type "+e)}function E(e){if(e===a.f.IMAGE)return r.c.IMAGE;if(e===a.f.PTT)return r.c.PTT;if(e===a.f.AUDIO)return r.c.AUDIO;if(e===a.f.VIDEO)return r.c.VIDEO;if(e===a.f.GIF)return r.c.GIF;if(e===a.f.RICH_HSM)return r.c.RICH_HSM;if(e===a.f.DOCUMENT)return r.c.DOCUMENT;if(e===a.f.STICKER)return r.c.STICKER;throw new Error("msgTypeToMediaType bad type "+e)}var b="image/jpeg";function y(e){switch(e.type){case a.f.IMAGE:return b;case a.f.STICKER:case a.f.PTT:case a.f.AUDIO:case a.f.VIDEO:case a.f.GIF:case a.f.DOCUMENT:return e.mimetype;case a.f.RICH_HSM:var t=e.richContent;if(null==t)return null;switch(t.type){case a.f.IMAGE:return b;case a.f.VIDEO:return t.mimetype;case a.f.LOCATION:return null;case a.f.DOCUMENT:return t.mimetype;default:return(0,c.a)(t.type)}default:return(0,c.a)(e.type)}}function S(e){return(0,o.q)(e,{uri:e=>(0,i.getChunkTable)().getFullContent(e,!1),path:e=>((0,u.c)("getFullMediaContent"),(0,s.e)("page","getBlobFromPhoneStorage",{path:e}).then(e=>e.blob))})}function I(e){return(0,o.q)(e,{uri:e=>(0,i.getChunkTable)().deleteMediaContent(e),path:e=>((0,u.c)("deleteMediaContent"),(0,s.e)("page","deletePath",{path:e}))})}},,,,function(e,t,n){n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return i})),n.d(t,"d",(function(){return s})),n.d(t,"e",(function(){return o})),n(4);var r={STAR:"star",CONTACT:"contact",MUTE:"mute",PIN_DEPRECATED:"pin",PIN:"pin_v1",SETTING_PUSHNAME:"setting_pushName",LABEL_EDIT:"label_edit",LABEL_MSG:"label_message",LABEL_JID:"label_jid",QUICK_REPLY:"quick_reply",LOCALE_SETTING:"setting_locale",ARCHIVE:"archive",MARK_CHAT_AS_READ:"markChatAsRead",CLEAR_CHAT:"clearChat",DELETE_MSG_FOR_ME:"deleteMessageForMe",SENTINEL:"sentinel",UNARCHIVE_SETTING:"setting_unarchiveChats",DELETE_CHAT:"deleteChat",ANDROID_UNSUPPORTED_ACTIONS:"android_unsupported_actions",PRIMARY_FEATURE:"primary_feature",SUBSCRIPTION:"subscription",NUX:"nux",AGENT:"deviceAgent",TIME_FORMAT:"time_format"},a={REGULAR:"regular",REGULAR_LOW:"regular_low",REGULAR_HIGH:"regular_high",CRITICAL_BLOCK:"critical_block",CRITICAL_UNBLOCK_LOW:"critical_unblock_low"},i={SUCCESS:"Success",SUCCESS_HAS_MORE:"SuccessHasMore",CONFLICT:"Conflict",CONFLICT_HAS_MORE:"ConflictHasMore",ERROR_RETRY:"ErrorRetry",ERROR_FATAL:"ErrorFatal",BLOCKED:"Blocked"},s={UP_TO_DATE:"upToDate",DIRTY:"dirty",FAILING_FINITE_RETRY:"failingFiniteRetry",FATAL:"fatal",BLOCKED:"blocked"},o={SUCCESS:"success",MALFORMED:"malformed",ORPHAN:"orphan",UNSUPPORTED:"unsupported",SKIPPED:"skipped",FAILED:"failed"}},function(e,t,n){n.d(t,"j",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"i",(function(){return u})),n.d(t,"k",(function(){return d})),n.d(t,"b",(function(){return c})),n.d(t,"f",(function(){return l})),n.d(t,"g",(function(){return f})),n.d(t,"l",(function(){return T})),n.d(t,"d",(function(){return A})),n.d(t,"h",(function(){return O})),n.d(t,"e",(function(){return M})),n.d(t,"m",(function(){return R}));var r=n(44),a=null;function i(e){var t=a;a=[];try{return e()}finally{var n;(null!=(n=a)?n:[]).forEach(e=>{e.fill(0)}),a=t}}function s(e,t){if(null==a)throw new Error("allocate called outside of active scope");return new e(t)}function o(e,t,n){r.c.crypto_hash(e,t,n)}function u(e,t){for(var n=0;n<64;++n)t[n]=e[n],e[n]=0;l(e,t),t.fill(0)}function d(e,t){var n=[c(),c(),c(),c()];r.c.scalarbase(n,t),O(e,n)}function c(e){var t=s(Float64Array,16);if(e){if(e.length>16)throw new Error("Incorrect initialiser array provided to the fieldElement");for(var n=0;n<e.length;n++)t[n]=e[n]}return t}function l(e,t){r.c.modL(e,t)}var p=()=>c([0]),h=()=>c([1]);function f(){return[c(),c(),c(),c()]}function m(){return[c(),c(),c()]}function v(e,t){for(var n=0,r=t;r>0;){var a=r%65536;e[n]=a,r=(r-a)/65536,n++}}function g(e,t){var n=r.c.S,a=r.c.M,i=c([2]),s=c();n(s,t),a(e,i,s)}function _(e,t){var n=r.c.S,a=r.c.M,i=r.c.A,s=p(),o=h(),u=c(),d=c(),l=c(),f=c();v(s,486662),n(u,t),a(d,s,t),i(l,u,d),i(f,l,o),a(e,t,f)}function E(e,t,n){1===n&&e.set(t)}var b=new Uint8Array([176,160,14,74,39,27,238,196,120,228,47,173,6,24,67,47,167,215,251,61,153,0,77,43,11,223,193,79,128,36,131,43]);function y(e,t){(0,r.c.Z)(e,p(),t)}function S(e,t){var n=r.c.M;n(e[0],t[0],t[3]),n(e[1],t[1],t[2]),n(e[2],t[2],t[3])}function I(e,t){var n=r.c.S,a=r.c.A,i=r.c.Z;n(e[0],t[0]),n(e[2],t[1]),g(e[3],t[2]),a(e[1],t[0],t[1]);var s=c();n(s,e[1]),a(e[1],e[2],e[0]),i(e[2],e[2],e[0]),i(e[0],s,e[1]),i(e[3],e[3],e[2])}var w=new Uint8Array([6,126,69,255,170,4,110,204,130,26,125,75,209,211,161,197,126,79,252,3,220,8,123,210,187,6,160,96,244,237,38,15]);function T(e,t){var n=f();return 0!==R(n,t)?-1:((function(e,t){y(e[0],t[0]),e[1].set(t[1]),e[2].set(t[2]),y(e[3],t[3])})(e,n),0)}function A(e){return i(()=>(function(e){var t=r.c.unpack25519,n=(0,r.b)(e),a=(128&n[31])>>7;n[31]&=127;var o=c();t(o,n);var u=c();(function(e,t){i(()=>(function(e,t){var n=r.c.M,a=r.c.A,i=t,s=h(),o=p();v(o,486662);var u=c();g(u,i);var d=c();a(d,u,s);var l=c();M(l,d);var f=c();n(f,l,o);var m=c();y(m,f);var b=c();_(b,m);var S=(function(e){var t=r.c.S,n=r.c.M,a=r.c.pow2523,i=r.c.pack25519,s=c(),o=c(),u=c(),d=c(),l=c();a(s,e),t(o,s),t(u,o),n(d,u,e),n(l,d,e);var p=new Uint8Array(32);return i(p,l),1&p[31]})(b),I=c([0]);E(I,o,S);var w=c();a(w,m,I);var T=c();y(T,w),E(w,T,S),e.set(w)})(e,t))})(u,o);var d=f();(function(e,t,n){var a=r.c.unpack25519,i=r.c.M,o=c();a(o,w);var u=c();(function(e,t){var n=r.c.Z,a=r.c.A,i=r.c.M,s=h(),o=c(),u=c(),d=c();n(o,t,s),a(u,t,s),M(d,u),i(e,o,d)})(u,t);var d=c();_(d,t);var l=c();(function(e,t){var n=r.c.unpack25519,a=r.c.pow2523,i=r.c.M,s=r.c.S,o=c();n(o,b);var u=c();a(u,t);var d=c();i(d,t,u);var l=c();s(l,d);var p=c();i(p,d,o),E(d,p,1^(C(l,t)?0:1)),e.set(d)})(l,d);var p=c();i(p,t,o);var f=c();M(f,l);var m=c();i(m,p,f);var v,g,S=c();y(S,m),E(m,S,(v=m,(0,r.c.pack25519)(g=s(Uint8Array,32),v),1&g[0]^n)),e[0].set(m),e[1].set(u),e[2].set(h()),i(e[3],e[0],e[1])})(d,u,a);var l=f();return(function(e,t){var n=[c(),c(),c(),c()],a=m();(function(e,t){var n=m();(function(e,t){e[0].set(t[0]),e[1].set(t[1]),e[2].set(t[2])})(n,t),I(e,n)})(n,t),S(a,n),I(n,a),S(a,n),I(n,a),(function(e,t){var n=r.c.M;n(e[0],t[0],t[3]),n(e[1],t[1],t[2]),n(e[2],t[2],t[3]),n(e[3],t[0],t[1])})(e,n)})(l,d),l})(e))}function O(e,t){var n=c(),a=c(),i=c(),s=r.c.M,o=r.c.pack25519;M(i,t[2]),s(n,t[0],i),s(a,t[1],i),o(e,a);var u=new Uint8Array(32);o(u,n),e[31]^=(1&u[0])<<7}function M(e,t){var n=c();n.set(t);for(var a=r.c.M,i=r.c.S,s=253;s>=0;--s)i(n,n),2!==s&&4!==s&&a(n,n,t);e.set(n)}function C(e,t){var n=r.c.pack25519,a=r.c.crypto_verify_32,i=new Uint8Array(32),s=new Uint8Array(32);return n(i,e),n(s,t),a(i,0,s,0)}function R(e,t){var n,a,i=r.c.set25519,s=r.c.S,o=r.c.M,u=r.c.Z,d=r.c.A,l=r.c.D,f=r.c.unpack25519,m=r.c.pow2523,v=c(),g=c(),_=c(),E=c(),b=c(),y=c(),S=c();return i(e[2],h()),f(e[1],t),s(_,e[1]),o(E,_,l),u(_,_,e[2]),d(E,e[2],E),s(b,E),s(y,b),o(S,y,b),o(v,S,_),o(v,v,E),m(v,v),o(v,v,_),o(v,v,E),o(v,v,E),o(e[0],v,E),s(g,e[0]),o(g,g,E),C(g,_)&&o(e[0],e[0],c([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139])),s(g,e[0]),o(g,g,E),C(g,_)?-1:(n=e[0],(0,r.c.pack25519)(a=new Uint8Array(32),n),(1&a[0])==t[31]>>7&&u(e[0],p(),e[0]),o(e[3],e[0],e[1]),0)}},,,function(e,t,n){n.d(t,"o",(function(){return k})),n.d(t,"p",(function(){return F})),n.d(t,"h",(function(){return B})),n.d(t,"f",(function(){return j})),n.d(t,"g",(function(){return V})),n.d(t,"a",(function(){return K})),n.d(t,"l",(function(){return H})),n.d(t,"m",(function(){return $})),n.d(t,"b",(function(){return q})),n.d(t,"k",(function(){return z})),n.d(t,"i",(function(){return J})),n.d(t,"q",(function(){return Y})),n.d(t,"d",(function(){return W})),n.d(t,"e",(function(){return Z})),n.d(t,"c",(function(){return Q})),n.d(t,"j",(function(){return X})),n.d(t,"n",(function(){return ee})),n.d(t,"r",(function(){return te}));var r=n(9),a=n.n(r),i=n(152),s=n(61),o=n(6),u=n(29),d=n(150),c=n(17),l=(n(63),n(34)),p=n(71),h=n(338),f=n(12),m=n(7),v=n(3),g=n(30),_=n(16),E=n(130),b=(n(60),n(136)),y=n(28),S=n(4),I=(n(11),n(72)),w=n(203),T=null,A=new s.a,O=new s.a,M=!1,C=null,R=null;function N(){return T||(__LOG__(2)`voip::getVoipService`,T=(0,i.a)("voip",{onConnect:G,onDisconnect:D})),A.promise}function k(){N()}var P={beforeAccept:null,ending:null,busy:null};function G(e){if(!o.n.get())return __LOG__(2)`voip::onSessionConnected: VOIP service is not supported`,void A.resolve();if("undefined"==typeof lib_wavoip||null==lib_wavoip.WaVoipService)return __LOG__(4)`voip::onSessionConnected cannot find lib_wavoip.WaVoipService`,void A.resolve();var t=lib_wavoip.WaVoipService,n=t.CallEvent,r=t.CallState,i=t.CallLogResult,s=t.FieldStateType,c=t.ClientPlatform,l=function(e){switch(e){case r.None:return"none";case r.Calling:return"calling";case r.PreacceptReceived:return"ringing";case r.ReceivedCall:return"incoming";case r.AcceptSent:return"loading";case r.AcceptReceived:return"ringing";case r.CallActive:case r.CallActiveElseWhere:return"ongoing";default:return"none"}},v=function(e){switch(e){case c.Unknown:return"unknown";case c.Android:return"android";case c.iPhone:return"iphone";case c.WP:return"wp";case c.iOSTablet:return"ios_tablet";case c.Kaios:return"kaios";case c.Windows:return"windows";case c.Portal:return"portal";default:return"unknown"}},E=class extends t.EventCallback{constructor(e,t,n){super(e,t),this.callResult=null,this.uiContext=null,this.peerPlatform=null,this.peerAppVersion=null,this.wavoip=n,P.beforeAccept=null,P.ending=null,P.busy=null}manageCallStateChange(e,t,n,r,a,i){if("none"===e&&null!=P.busy&&(clearTimeout(P.busy),P.busy=null),"none"===e&&"ongoing"===t)(0,f.c)("event","callStateChanged",{state:"ending",peerJid:n,isCaller:r,isLocallyMuted:a});else if("none"!==e||"ringing"!==t||!1!==i||"missed"!==this.callResult&&"rejected"!==this.callResult)null!=P.ending&&(clearTimeout(P.ending),P.ending=null),(0,f.c)("event","callStateChanged",{state:e,peerJid:n,isCaller:r,isLocallyMuted:a});else{var s="missed"===this.callResult?"ending-missed":"ending-rejected";(0,f.c)("event","callStateChanged",{state:s,peerJid:n,isCaller:r,isLocallyMuted:a})}"none"===e&&(this.callResult=null,this.uiContext=null,this.peerPlatform=null,this.peerAppVersion=null)}startTimeoutBeforeAccept(e){null==P.beforeAccept&&(P.beforeAccept=setTimeout(()=>{this.wavoip.endCall(!0),this.stopTimeoutBeforeAccept()},e))}stopTimeoutBeforeAccept(){null!=P.beforeAccept&&(clearTimeout(P.beforeAccept),P.beforeAccept=null)}manageTimeoutBeforeAccept(e){e===r.ReceivedCall?this.startTimeoutBeforeAccept(45e3):e===r.Calling||e===r.PreacceptReceived?this.startTimeoutBeforeAccept(9e4):this.stopTimeoutBeforeAccept()}onEvent(e,t){switch(e){case n.CallRejectReceived:"busy"===(null==t?void 0:t.reason)?((0,f.c)("event","callBusyReceived",{}),null==P.busy&&(P.busy=setTimeout(()=>{this.wavoip.endCall(!0),P.busy=null},3e4))):this.wavoip.endCall(!1);break;case n.CallStateChanged:var r=null==t?void 0:t.callInfo,a=null==t?void 0:t.oldCallState;if(null==r||null==a)return;var s=r.callState,c=r.peerJid,p=r.isCaller,h=r.participants,E=r.callEndedByMe,b=r.callId,y=h&&h.find(e=>e.jid===o.r.get()),S=y&&y.isMuted,I=l(s),w=l(a);if(this.manageCallStateChange(I,w,c,p,S,E),this.manageTimeoutBeforeAccept(s),p&&"none"!==I&&null!=C){var T=C,A=T.id,O=T.uiContext,M=T.peerPlatform,N=T.peerAppVersion;A===b&&(this.uiContext=O,this.peerPlatform=M,this.peerAppVersion=N)}if(!p&&"none"!==I&&null!=R){var k=R,G=k.id,L=k.peerPlatform,D=k.peerAppVersion;G===b&&(this.peerPlatform=L,this.peerAppVersion=D)}break;case n.CallEnding:var x=t||{},U=x.callInfo,F=x.callLogInfo,B=U||{},j=B.callId,V=B.initialPeerJid,K=B.isCaller,H=B.callDuration,$=F||{},q=$.result,z=$.totalTxBytes;null!=j&&null!=V&&null!=K&&null!=q||__LOG__(2)`Voip::EventCallback::onEvent CallEvent.CallEnding missing required data in payload to update the call log`;var J=(function(e){switch(e){case i.Invalid:return"invalid";case i.Cancelled:return"cancelled";case i.Missed:return"missed";case i.Unavailable:return"unavailable";case i.Rejected:return"rejected";case i.Connected:return"connected";default:return"invalid"}})(q);this.callResult=J,(0,g.b)().fireAndForget(_.e.finalizeCallLog({callId:j,peer:V,isFromMe:K},J,H,z));break;case n.RxTimeout:case n.TxTimeout:this.wavoip.endCall(!0);break;case n.MuteStateChanged:var Y=t||{},W=Y.isMuted,Z=Y.jid;(0,f.c)("event","callMuteStateChanged",{isMuted:W,jid:Z});break;case n.RejectedDecryptionFailure:var Q=t||{},ee=Q.callId,te=Q.peerJid,ne=Q.registrationId,re=(0,m.e)(te);(0,u.F)(re).then(e=>{var t=()=>{this.wavoip.resendOfferOnDecryptionFailure(te,ee)};e&&e!==ne?(__LOG__(2)`Voip::EventCallback::onEvent CallEvent.RejectedDecryptionFailure delete session`,(0,u.k)(re).then(()=>(0,d.ensureE2eSession)(re)).then(t)):t()});break;case n.CallMissed:var ae=t||{},ie=ae.callId,se=ae.peerJid,oe=ae.peerPlatform,ue=ae.peerAppVersion,de=ae.isVideoCall,ce=ae.callWakeupSource,le=ae.timeElapsedSinceCallOffer,pe=ae.abTestBucket;null!=ie&&null!=se||__LOG__(2)`Voip::EventCallback::onEvent CallEvent.CallMissed missing callId or peerJid in payload`,(0,g.b)().fireAndForget(_.e.finalizeCallLog({callId:ie,peer:se,isFromMe:!1},"missed"));var he=""===pe?null:pe;X({callId:ie,callPeerPlatform:v(oe),callPeerAppVersion:ue,videoEnabled:de,callTestBucket:he,callWakeupSource:ce,callOfferElapsedT:le});break;case n.InterruptionStateChanged:var fe=t||{},me=fe.isInterrupted,ve=fe.jid;(0,f.c)("event","callInterruptedStateChanged",{isInterrupted:me,jid:ve});break;case n.CallOfferNacked:var ge=(t||{}).errors,_e=(Array.isArray(ge)?ge[0]:{})||{},Ee=_e.code,be=_e.jid;null!=Ee&&null!=be&&(0,f.c)("event","callOfferNacked",{code:Ee,jid:be}),this.wavoip.endCall(!1)}return Promise.resolve()}onFieldStatsReady(e){if(null!=e){var t=e.stats.reduce((e,t)=>{var n=t.id,r=t.value,a=t.fieldType;if(null==r||null==a)return e;var i=null,o=null;switch(a){case s.ENUM:case s.TIMER:case s.BYTES:case s.INT:o=0;var u=parseInt(r,10);i=isNaN(u)?null:u;break;case s.BOOL:o=1,i="true"===r||"false"!==r&&null;break;case s.STR:o=2,i=r;break;case s.FLOAT:o=3;var d=parseFloat(r);i=isNaN(d)?null:d}return null!=i&&null!=o&&e.push([n,o,i]),e},[]),n={};if(null!=this.uiContext)switch(this.uiContext){case"conversation":n.callFromUi=8;break;case"conversationOptions":n.callFromUi=29;break;case"callLogInfo":n.callFromUi=4;break;case"callLogListIncoming":n.callFromUi=9;break;case"callLogListOutgoing":n.callFromUi=2;break;case"callLogListMissed":n.callFromUi=1;break;case"chatList":n.callFromUi=27;break;case"contactInfo":case"contactInfoVoiceCall":n.callFromUi=6;break;case"newCall":n.callFromUi=16;break;default:this.uiContext,n.callFromUi=28}return null!=this.peerPlatform&&(n.callPeerPlatform=this.peerPlatform),null!=this.peerAppVersion&&(n.callPeerAppVersion=this.peerAppVersion),WAM.log("regular",462,void 0,[1016,0,n.acceptAckLatencyMs,1015,0,n.acceptedButNotConnectedTimeSpentMs,412,0,n.activeRelayProtocol,1186,0,n.aflDisPrefetchFailure1x,1187,0,n.aflDisPrefetchFailure2x,1188,0,n.aflDisPrefetchFailure4x,1189,0,n.aflDisPrefetchFailure8x,1190,0,n.aflDisPrefetchFailureTotal,1191,0,n.aflDisPrefetchSuccess1x,1192,0,n.aflDisPrefetchSuccess2x,1193,0,n.aflDisPrefetchSuccess4x,1194,0,n.aflDisPrefetchSuccess8x,1195,0,n.aflDisPrefetchSuccessTotal,1196,0,n.aflNackFailure1x,1197,0,n.aflNackFailure2x,1198,0,n.aflNackFailure4x,1199,0,n.aflNackFailure8x,1200,0,n.aflNackFailureTotal,1201,0,n.aflNackSuccess1x,1202,0,n.aflNackSuccess2x,1203,0,n.aflNackSuccess4x,1204,0,n.aflNackSuccess8x,1205,0,n.aflNackSuccessTotal,1206,0,n.aflOther1x,1207,0,n.aflOther2x,1208,0,n.aflOther4x,1209,0,n.aflOther8x,1210,0,n.aflOtherTotal,1211,0,n.aflPureLoss1x,1212,0,n.aflPureLoss2x,1213,0,n.aflPureLoss4x,1214,0,n.aflPureLoss8x,1215,0,n.aflPureLossTotal,593,0,n.allocErrorBitmap,1055,1,n.androidAudioRouteMismatch,444,0,n.androidCamera2MinHardwareSupportLevel,443,0,n.androidCameraApi,477,0,n.androidSystemPictureInPictureT,497,0,n.androidTelecomTimeSpentBeforeReject,1109,1,n.appInBackgroundDuringCall,1119,3,n.audStreamMixPct,755,0,n.audioCodecDecodedFecFrames,756,0,n.audioCodecDecodedPlcFrames,751,0,n.audioCodecEncodedFecFrames,753,0,n.audioCodecEncodedNonVoiceFrames,1177,0,n.audioCodecEncodedThrottledVoiceFrames,752,0,n.audioCodecEncodedVoiceFrames,754,0,n.audioCodecReceivedFecFrames,860,0,n.audioDeviceIssues,861,0,n.audioDeviceLastIssue,867,0,n.audioDeviceSwitchCount,866,0,n.audioDeviceSwitchDuration,724,0,n.audioFrameLoss1xMs,725,0,n.audioFrameLoss2xMs,726,0,n.audioFrameLoss4xMs,727,0,n.audioFrameLoss8xMs,83,0,n.audioGetFrameUnderflowPs,679,0,n.audioInbandFecDecoded,678,0,n.audioInbandFecEncoded,722,0,n.audioLossPeriodCount,1184,1,n.audioNackHbhEnabled,646,0,n.audioNackReqPktsRecvd,645,0,n.audioNackReqPktsSent,649,0,n.audioNackRtpRetransmitDiscardCount,651,0,n.audioNackRtpRetransmitFailCount,648,0,n.audioNackRtpRetransmitRecvdCount,647,0,n.audioNackRtpRetransmitReqCount,650,0,n.audioNackRtpRetransmitSentCount,1008,0,n.audioNumPiggybackRxPkt,1007,0,n.audioNumPiggybackTxPkt,1138,0,n.audioPlayCbIntervalGtDefaultCnt,1139,0,n.audioPlayCbLatencyGteMaxCnt,82,0,n.audioPutFrameOverflowPs,1036,0,n.audioRecCbLatencyAvg,1035,0,n.audioRecCbLatencyMax,1034,0,n.audioRecCbLatencyMin,1037,0,n.audioRecCbLatencyStddev,677,0,n.audioRtxPktDiscarded,676,0,n.audioRtxPktProcessed,675,0,n.audioRtxPktSent,728,3,n.audioRxAvgFpp,642,3,n.audioRxPktLossPctDuringPip,450,3,n.audioTotalBytesOnNonDefCell,192,3,n.avAvgDelta,193,3,n.avMaxDelta,578,0,n.aveNumPeersAutoPaused,994,0,n.aveTimeBwResSwitches,719,0,n.aveTimeBwVidRcDynCondTrue,139,0,n.avgClockCbT,1220,3,n.avgCpuUtilizationPct,136,0,n.avgDecodeT,1048,0,n.avgEncRestartAndKfGenT,1047,0,n.avgEncRestartIntervalT,135,0,n.avgEncodeT,816,0,n.avgEventQueuingDelay,1152,0,n.avgPlayCbIntvT,137,0,n.avgPlayCbT,495,0,n.avgRecordCbIntvT,138,0,n.avgRecordCbT,140,0,n.avgRecordGetFrameT,141,3,n.avgTargetBitrate,413,0,n.avgTcpConnCount,414,0,n.avgTcpConnLatencyInMsec,355,1,n.batteryDropMatched,442,1,n.batteryDropTriggered,354,1,n.batteryLowMatched,441,1,n.batteryLowTriggered,353,1,n.batteryRulesApplied,843,0,n.biDirRelayRebindLatencyMs,844,0,n.biDirRelayResetLatencyMs,1222,0,n.boundSocketIpAddressIsInvalid,33,1,n.builtinAecAvailable,38,1,n.builtinAecEnabled,36,2,n.builtinAecImplementor,37,2,n.builtinAecUuid,34,1,n.builtinAgcAvailable,35,1,n.builtinNsAvailable,1114,1,n.bwaVidDisablingCandidate,1116,0,n.bwaVidDisablingRxCandidateDuration,1115,0,n.bwaVidDisablingTxCandidateDuration,1068,0,n.bweEvaluationScoreE2e,1070,0,n.bweEvaluationScoreSfuDl,1069,0,n.bweEvaluationScoreSfuUl,302,0,n.c2DecAvgT,300,0,n.c2DecFrameCount,301,0,n.c2DecFramePlayed,298,0,n.c2EncAvgT,299,0,n.c2EncCpuOveruseCount,297,0,n.c2EncFrameCount,296,0,n.c2RxTotalBytes,295,0,n.c2TxTotalBytes,132,0,n.callAcceptFuncT,39,0,n.callAecMode,42,0,n.callAecOffset,43,0,n.callAecTailLength,52,0,n.callAgcMode,268,1,n.callAndrGcmFgEnabled,55,0,n.callAndroidAudioMode,57,0,n.callAndroidRecordAudioPreset,56,0,n.callAndroidRecordAudioSource,54,0,n.callAudioEngineType,96,3,n.callAudioRestartCount,97,3,n.callAudioRestartReason,640,3,n.callAvgAudioRxPipBitrate,259,0,n.callAvgRottRx,258,0,n.callAvgRottTx,107,0,n.callAvgRtt,638,3,n.callAvgVideoRxPipBitrate,195,3,n.callBatteryChangePct,50,0,n.callCalculatedEcOffset,51,0,n.callCalculatedEcOffsetStddev,505,2,n.callCreatorHid,405,0,n.callDefNetwork,99,3,n.callEcRestartCount,46,3,n.callEchoEnergy,44,0,n.callEchoLikelihood,47,3,n.callEchoLikelihoodBeforeEc,1142,0,n.callEndFrameLossMs,130,0,n.callEndFuncT,70,1,n.callEndReconnecting,877,1,n.callEndReconnectingBeforeNetworkChange,875,1,n.callEndReconnectingBeforeP2pFailover,869,1,n.callEndReconnectingBeforeRelayFailover,948,1,n.callEndReconnectingBeforeRelayReset,848,1,n.callEndReconnectingSoonAfterCallActive,878,1,n.callEndReconnectingSoonAfterNetworkChange,876,1,n.callEndReconnectingSoonAfterP2pFailover,870,1,n.callEndReconnectingSoonAfterRelayFailover,949,1,n.callEndReconnectingSoonAfterRelayReset,518,1,n.callEndedDuringAudFreeze,517,1,n.callEndedDuringVidFreeze,23,1,n.callEndedInterrupted,626,0,n.callEnterPipModeCount,2,0,n.callFromUi,45,3,n.callHistEchoLikelihood,1157,3,n.callInitRxPktLossPct3s,109,0,n.callInitialRtt,22,1,n.callInterrupted,388,1,n.callIsLastSegment,108,0,n.callLastRtt,106,0,n.callMaxRtt,422,0,n.callMessagesBufferedCount,105,0,n.callMinRtt,76,0,n.callNetwork,77,0,n.callNetworkSubtype,53,0,n.callNsMode,159,3,n.callOfferAckTimout,243,0,n.callOfferDelayT,102,0,n.callOfferElapsedT,588,0,n.callOfferFanoutCount,134,0,n.callOfferReceiptDelay,457,0,n.callP2pAvgRtt,18,1,n.callP2pDisabled,456,0,n.callP2pMinRtt,15,2,n.callPeerAppVersion,10,2,n.callPeerIpStr,8,0,n.callPeerIpv4,5,2,n.callPeerPlatform,501,0,n.callPendingCallsAcceptedCount,498,0,n.callPendingCallsCount,499,0,n.callPendingCallsRejectedCount,500,0,n.callPendingCallsTerminatedCount,628,0,n.callPipMode10sCount,633,0,n.callPipMode10sT,631,0,n.callPipMode120sCount,636,0,n.callPipMode120sT,632,0,n.callPipMode240sCount,637,0,n.callPipMode240sT,629,0,n.callPipMode30sCount,634,0,n.callPipMode30sT,630,0,n.callPipMode60sCount,635,0,n.callPipMode60sT,627,0,n.callPipModeT,59,0,n.callPlaybackBufferSize,25,1,n.callPlaybackCallbackStopped,93,3,n.callPlaybackFramesPs,95,3,n.callPlaybackSilenceRatio,231,0,n.callRadioType,529,2,n.callRandomId,94,3,n.callRecentPlaybackFramesPs,29,3,n.callRecentRecordFramesPs,438,0,n.callReconnectingStateCount,58,0,n.callRecordBufferSize,24,1,n.callRecordCallbackStopped,28,0,n.callRecordFramesPs,98,3,n.callRecordMaxEnergyRatio,26,0,n.callRecordSilenceRatio,131,0,n.callRejectFuncT,455,0,n.callRelayAvgRtt,16,0,n.callRelayBindStatus,104,0,n.callRelayCreateT,454,0,n.callRelayMinRtt,17,2,n.callRelayServer,1155,2,n.callReplayerId,63,0,n.callResult,103,0,n.callRingingT,121,3,n.callRxAvgBitrate,122,3,n.callRxAvgBwe,125,0,n.callRxAvgJitter,128,0,n.callRxAvgLossPeriod,124,0,n.callRxMaxJitter,127,0,n.callRxMaxLossPeriod,123,0,n.callRxMinJitter,126,0,n.callRxMinLossPeriod,120,3,n.callRxPktLossPct,892,3,n.callRxPktLossRetransmitPct,100,0,n.callRxStoppedT,30,0,n.callSamplingRate,389,0,n.callSegmentIdx,393,0,n.callSegmentType,9,2,n.callSelfIpStr,7,0,n.callSelfIpv4,68,0,n.callServerNackErrorCode,71,0,n.callSetupErrorType,101,0,n.callSetupT,1,0,n.callSide,133,0,n.callSoundPortFuncT,129,0,n.callStartFuncT,41,0,n.callSwAecMode,40,0,n.callSwAecType,92,0,n.callT,69,0,n.callTermReason,19,2,n.callTestBucket,318,0,n.callTestEvent,49,0,n.callTonesDetectedInRecord,48,0,n.callTonesDetectedInRingback,78,0,n.callTransitionCount,432,0,n.callTransitionCountCellularToWifi,431,0,n.callTransitionCountWifiToCellular,72,0,n.callTransport,515,1,n.callTransportExtrayElected,80,0,n.callTransportP2pToRelayFallbackCount,587,1,n.callTransportPeerTcpUsed,79,0,n.callTransportRelayToRelayFallbackCount,516,1,n.callTransportTcpFallbackToUdp,514,1,n.callTransportTcpUsed,112,3,n.callTxAvgBitrate,113,3,n.callTxAvgBwe,116,0,n.callTxAvgJitter,119,0,n.callTxAvgLossPeriod,115,0,n.callTxMaxJitter,118,0,n.callTxMaxLossPeriod,114,0,n.callTxMinJitter,117,0,n.callTxMinLossPeriod,111,3,n.callTxPktErrorPct,110,3,n.callTxPktLossPct,20,0,n.callUserRate,156,0,n.callWakeupSource,447,0,n.calleeAcceptToDecodeT,476,1,n.callerInContact,445,0,n.callerOfferToDecodeT,446,0,n.callerVidRtpToDecodeT,765,0,n.cameraFormats,850,0,n.cameraIssues,851,0,n.cameraLastIssue,331,0,n.cameraOffCount,1131,0,n.cameraPauseT,849,1,n.cameraPermission,322,0,n.cameraPreviewMode,852,0,n.cameraStartDuration,856,0,n.cameraStartFailureDuration,233,0,n.cameraStartMode,916,0,n.cameraStartToFirstFrameT,853,0,n.cameraStopDuration,858,0,n.cameraStopFailureCount,855,0,n.cameraSwitchCount,854,0,n.cameraSwitchDuration,857,0,n.cameraSwitchFailureDuration,527,1,n.clampedBwe,624,0,n.codecSamplingRate,760,3,n.combinedE2eAvgRtt,761,3,n.combinedE2eMaxRtt,759,3,n.combinedE2eMinRtt,623,0,n.confBridgeSamplingRate,974,1,n.conservativeModeStopped,743,0,n.conservativeRampUpExploringT,643,0,n.conservativeRampUpHeldCount,741,0,n.conservativeRampUpHoldingT,742,0,n.conservativeRampUpRampingUpT,519,1,n.createdFromGroupCallDowngrade,537,1,n.dataLimitOnAltNetworkReached,230,2,n.deviceBoard,229,2,n.deviceHardware,914,0,n.dtxRxByteFrameCount,912,0,n.dtxRxCount,911,0,n.dtxRxDurationT,913,0,n.dtxRxTotalCount,1083,0,n.dtxRxTotalFrameCount,910,0,n.dtxTxByteFrameCount,619,0,n.dtxTxCount,618,0,n.dtxTxDurationT,909,0,n.dtxTxTotalCount,1082,0,n.dtxTxTotalFrameCount,320,0,n.echoCancellationMsPerSec,940,0,n.echoCancelledFrameCount,941,0,n.echoEstimatedFrameCount,987,0,n.echoSpeakerModeFrameCount,81,0,n.encoderCompStepdowns,90,0,n.endCallAfterConfirmation,534,0,n.failureToCreateAltSocket,532,0,n.failureToCreateTestAltSocket,1005,0,n.fastplayMaxDurationMs,1004,0,n.fastplayNumFrames,1006,0,n.fastplayNumTriggers,328,0,n.fieldStatsRowType,503,1,n.finishedDlBwe,528,1,n.finishedOverallBwe,502,1,n.finishedUlBwe,1051,3,n.freezeAheadBweCongestionCorrPct,1009,3,n.freezeBweCongestionCorrPct,1013,1,n.groupAcceptNoCriticalGroupUpdate,1014,0,n.groupAcceptToCriticalGroupUpdateMs,439,0,n.groupCallCallerParticipantCountAtCallStart,360,0,n.groupCallInviteCountSinceCallStart,357,1,n.groupCallIsGroupCallInvitee,356,1,n.groupCallIsLastSegment,361,0,n.groupCallNackCountSinceCallStart,946,0,n.groupCallReringCountSinceCallStart,947,0,n.groupCallReringNackCountSinceCallStart,329,0,n.groupCallSegmentIdx,358,0,n.groupCallTotalCallTSinceCallStart,359,0,n.groupCallTotalP3CallTSinceCallStart,592,0,n.groupCallVideoMaximizedCount,539,1,n.hasRestrictedSettingsForAudioCalls,1219,0,n.hbhSrtcpRxRejectedPktCntFromOldRelay,884,0,n.highPeerBweT,342,0,n.hisBasedInitialTxBitrate,339,1,n.hisInfoCouldBeUsedForInitBwe,807,1,n.historyBasedBweActivated,806,1,n.historyBasedBweEnabled,808,1,n.historyBasedBweSuccess,809,0,n.historyBasedBweVideoTxBitrate,387,0,n.incomingCallUiAction,337,0,n.initBweSource,244,3,n.initialEstimatedTxBitrate,1149,1,n.isCallFull,91,1,n.isIpv6Capable,1090,1,n.isLinkedGroupCall,976,1,n.isPendingCall,927,1,n.isRejoin,945,1,n.isRering,260,1,n.isUpnpExternalIpPrivate,261,1,n.isUpnpExternalIpTheSameAsReflexiveIp,146,3,n.jbAvgDelay,644,3,n.jbAvgDelayUniform,1086,3,n.jbAvgDisorderTargetSize,1012,3,n.jbAvgTargetSize,150,3,n.jbDiscards,151,3,n.jbEmpties,997,3,n.jbEmptyPeriods1x,998,3,n.jbEmptyPeriods2x,999,3,n.jbEmptyPeriods4x,1e3,3,n.jbEmptyPeriods8x,152,3,n.jbGets,149,3,n.jbLastDelay,277,3,n.jbLost,641,0,n.jbLostEmptyDuringPip,777,3,n.jbLostEmptyHighPeerBwePerSec,775,3,n.jbLostEmptyLowPeerBwePerSec,776,3,n.jbLostEmptyLowToHighPeerBwePerSec,148,3,n.jbMaxDelay,1087,3,n.jbMaxDisorderTargetSize,147,3,n.jbMinDelay,846,3,n.jbNonSpeechDiscards,153,3,n.jbPuts,996,3,n.jbTotalEmptyPeriods,1081,0,n.jbVoiceFrames,895,1,n.joinableAfterCall,894,1,n.joinableDuringCall,893,1,n.joinableNewUi,986,2,n.l1Locations,415,0,n.lastConnErrorStatus,504,0,n.libsrtpVersionUsed,1127,0,n.lobbyVisibleT,1120,0,n.logSampleRatio,21,1,n.longConnect,535,0,n.lossOfAltSocket,533,0,n.lossOfTestAltSocket,157,3,n.lowDataUsageBitrate,885,0,n.lowPeerBweT,886,0,n.lowToHighPeerBweT,452,2,n.malformedStanzaXpath,1085,0,n.maxConnectedParticipants,558,0,n.maxEventQueueDepth,448,0,n.mediaStreamSetupT,253,0,n.micAvgPower,252,0,n.micMaxPower,251,0,n.micMinPower,859,1,n.micPermission,862,0,n.micStartDuration,931,0,n.micStartToFirstCallbackT,863,0,n.micStopDuration,838,1,n.multipleTxRxRelaysInUse,1169,0,n.muteNotSupportedCount,1170,0,n.muteReqAlreadyMutedCount,1171,0,n.muteReqTimeoutsCount,32,2,n.nativeSamplesPerFrame,31,2,n.nativeSamplingRate,653,0,n.neteqAcceleratedFrames,652,0,n.neteqExpandedFrames,1135,0,n.networkFailoverTriggeredCount,995,0,n.networkMediumChangeLatencyMs,1128,1,n.nseEnabled,1129,0,n.nseOfflineQueueMs,933,0,n.numAsserts,330,0,n.numConnectedParticipants,1052,0,n.numConnectedPeers,567,0,n.numCriticalGroupUpdateDropped,985,0,n.numDirPjAsserts,1054,0,n.numInvitedParticipants,929,0,n.numL1Errors,930,0,n.numL2Errors,625,0,n.numOutOfOrderCriticalGroupUpdate,1053,0,n.numOutgoingRingingPeers,577,0,n.numPeersAutoPausedOnce,1029,0,n.numRenderSkipGreenFrame,993,0,n.numResSwitch,1113,0,n.numTransitionsToSpeech,574,0,n.numVidDlAutoPause,576,0,n.numVidDlAutoResume,579,0,n.numVidDlAutoResumeRejectBadAudio,717,0,n.numVidRcDynCondTrue,559,0,n.numVidUlAutoPause,560,0,n.numVidUlAutoPauseFail,564,0,n.numVidUlAutoPauseRejectHighSendingRate,565,0,n.numVidUlAutoPauseRejectTooEarly,566,0,n.numVidUlAutoPauseUserAction,561,0,n.numVidUlAutoResume,562,0,n.numVidUlAutoResumeFail,563,0,n.numVidUlAutoResumeRejectAudioLqm,27,0,n.numberOfProcessors,1017,0,n.offerAckLatencyMs,805,0,n.oibweDlProbingTime,802,0,n.oibweE2eProbingTime,868,1,n.oibweNotFinishedWhenCallActive,803,0,n.oibweOibleProbingTime,804,0,n.oibweUlProbingTime,525,1,n.onMobileDataSaver,540,1,n.onWifiAtStart,507,0,n.oneSideInitRxBitrate,506,0,n.oneSideInitTxBitrate,509,0,n.oneSideMinPeerInitRxBitrate,508,1,n.oneSideRcvdPeerRxBitrate,287,0,n.opusVersion,522,0,n.p2pSuccessCount,599,3,n.pcntPoorAudLqmAfterPause,598,3,n.pcntPoorAudLqmBeforePause,597,3,n.pcntPoorVidLqmAfterPause,596,3,n.pcntPoorVidLqmBeforePause,264,0,n.peerCallNetwork,66,0,n.peerCallResult,591,0,n.peerTransport,191,0,n.peerVideoHeight,190,0,n.peerVideoWidth,4,0,n.peerXmppStatus,1172,0,n.peersMuteSuccCount,1173,0,n.peersRejectedMuteReqCount,160,3,n.pingsSent,161,3,n.pongsReceived,510,0,n.poolMemUsage,511,0,n.poolMemUsagePadding,89,0,n.presentEndCallConfirmation,1060,2,n.prevCallTestBucket,266,0,n.previousCallInterval,265,1,n.previousCallVideoEnabled,267,1,n.previousCallWithSamePeer,1001,1,n.previousJoinNotEnded,327,3,n.probeAvgBitrate,158,3,n.pushToCallOfferDelay,155,3,n.rcMaxrtt,154,3,n.rcMinrtt,1130,1,n.receivedByNse,847,1,n.reconnectingStartsBeforeCallActive,84,0,n.recordCircularBufferFrameCount,162,3,n.reflectivePortsDiff,1174,0,n.rejectMuteReqCount,1140,0,n.rekeyTime,583,0,n.relayBindFailureAltNetSwitchSuccess,582,0,n.relayBindFailureAltNetSwitchTriggered,586,0,n.relayBindFailureAltNetworkSwitchToCallEnd,581,0,n.relayBindFailureFallbackCount,585,0,n.relayBindFailureIpVersionSwitchToCallEnd,584,0,n.relayBindFailureIpVersionSwitchTriggered,424,0,n.relayBindTimeInMsec,423,0,n.relayElectionTimeInMsec,481,0,n.relayFallbackOnRxDataFromRelay,482,0,n.relayFallbackOnStopRxDataOnP2p,483,0,n.relayFallbackOnTransportStanzaNotification,780,0,n.renderFreezeHighPeerBweT,778,0,n.renderFreezeLowPeerBweT,779,0,n.renderFreezeLowToHighPeerBweT,1168,0,n.rxAllocRespNoMatchingTid,291,0,n.rxProbeCountSuccess,290,0,n.rxProbeCountTotal,841,0,n.rxRelayRebindLatencyMs,842,0,n.rxRelayResetLatencyMs,145,3,n.rxTotalBitrate,143,3,n.rxTotalBytes,294,3,n.rxTpFbBitrate,758,1,n.rxTrafficStartFalsePositive,963,3,n.sbweAvgDowntrend,962,3,n.sbweAvgUptrend,783,0,n.sbweCeilingCongestionCount,781,0,n.sbweCeilingCount,786,0,n.sbweCeilingMissingRtcpCongestionCount,787,0,n.sbweCeilingNoNewDataReceivedCongestionCount,782,0,n.sbweCeilingPktLossCount,1106,0,n.sbweCeilingReceiveSideCount,784,0,n.sbweCeilingRttCongestionCount,785,0,n.sbweCeilingZeroRttCongestionCount,1103,0,n.sbweGlobalMinRttCongestionCount,1133,0,n.sbweHighestRttCongestionCount,961,0,n.sbweHoldCount,1104,0,n.sbweMinRttEmaCongestionCount,960,0,n.sbweRampDownCount,959,0,n.sbweRampUpCount,1134,0,n.sbweRampUpPauseCount,1175,0,n.selfMuteSuccessCount,1176,0,n.selfUnmuteAfterMuteReqCount,975,0,n.senderBweInitBitrate,879,0,n.sfuAbnormalUplinkRttCount,1096,3,n.sfuAvgDlPlrAtBalancedCongestion,1094,3,n.sfuAvgDlPlrAtHighDlCongestion,1092,3,n.sfuAvgDlPlrAtHighUlCongestion,1002,3,n.sfuAvgLqHqTargetBitrateDiff,1102,0,n.sfuAvgPeerRttAtBalancedCongestion,1100,0,n.sfuAvgPeerRttAtHighPeerCongestion,1098,0,n.sfuAvgPeerRttAtHighSelfCongestion,1101,0,n.sfuAvgSelfRttAtBalancedCongestion,1099,0,n.sfuAvgSelfRttAtHighPeerCongestion,1097,0,n.sfuAvgSelfRttAtHighSelfCongestion,673,3,n.sfuAvgTargetBitrate,943,3,n.sfuAvgTargetBitrateHq,1095,3,n.sfuAvgUlPlrAtBalancedCongestion,1093,3,n.sfuAvgUlPlrAtHighDlCongestion,1091,3,n.sfuAvgUlPlrAtHighUlCongestion,1075,0,n.sfuBalancedPktLossAtCongestion,1079,0,n.sfuBalancedRttAtCongestion,919,3,n.sfuBwaAllParticipantDlBwUsedPct,918,3,n.sfuBwaAllParticipantUlBwUsedPct,928,0,n.sfuBwaChangeNumStreamCount,1003,3,n.sfuBwaSelfDlBwUsedPct,917,3,n.sfuBwaSelfUlBwUsedPct,920,0,n.sfuBwaSimulcastDisabledCntReasonBattery,921,0,n.sfuBwaSimulcastDisabledCntReasonNetMedium,926,0,n.sfuBwaVidEncHqStreamScheduledT,925,0,n.sfuBwaVidEncLqStreamScheduledT,662,3,n.sfuDownlinkAvgCombinedBwe,667,3,n.sfuDownlinkAvgPktLossPct,661,3,n.sfuDownlinkAvgRemoteBwe,660,3,n.sfuDownlinkAvgSenderBwe,1158,3,n.sfuDownlinkInitCombinedBwe3s,1159,3,n.sfuDownlinkInitPktLossPct3s,668,3,n.sfuDownlinkMaxPktLossPct,666,3,n.sfuDownlinkMinPktLossPct,973,3,n.sfuDownlinkSbweAvgDowntrend,972,3,n.sfuDownlinkSbweAvgUptrend,797,0,n.sfuDownlinkSbweCeilingCongestionCount,795,0,n.sfuDownlinkSbweCeilingCount,800,0,n.sfuDownlinkSbweCeilingMissingRtcpCongestionCount,801,0,n.sfuDownlinkSbweCeilingNoNewDataReceivedCongestionCount,796,0,n.sfuDownlinkSbweCeilingPktLossCount,798,0,n.sfuDownlinkSbweCeilingRttCongestionCount,799,0,n.sfuDownlinkSbweCeilingZeroRttCongestionCount,971,0,n.sfuDownlinkSbweHoldCount,970,0,n.sfuDownlinkSbweRampDownCount,969,0,n.sfuDownlinkSbweRampUpCount,958,3,n.sfuDownlinkSenderBweDiffStddev,957,3,n.sfuDownlinkSenderBweStddev,1111,0,n.sfuFirstRxBandwidthReportTime,883,0,n.sfuFirstRxParticipantReportTime,881,0,n.sfuFirstRxUplinkReportTime,1074,0,n.sfuHighDlPktLossAtCongestion,1078,0,n.sfuHighDlRttAtCongestion,1073,0,n.sfuHighUlPktLossAtCongestion,1077,0,n.sfuHighUlRttAtCongestion,674,3,n.sfuMaxTargetBitrate,944,3,n.sfuMaxTargetBitrateHq,672,3,n.sfuMinTargetBitrate,942,3,n.sfuMinTargetBitrateHq,813,3,n.sfuPeerDownlinkStddevAllCombinedBwe,1110,0,n.sfuRxBandwidthReportCount,882,0,n.sfuRxParticipantReportCount,880,0,n.sfuRxUplinkReportCount,833,0,n.sfuSimulcastAvgDecSessFlipTime,837,0,n.sfuSimulcastAvgEncSchedEventUpdateTime,923,0,n.sfuSimulcastBwaCandidateCnt,874,0,n.sfuSimulcastBwaDownlinkBottleneckCount,873,0,n.sfuSimulcastBwaUplinkBottleneckCount,952,0,n.sfuSimulcastDecAvgKfRecvTimeSinceFlip,951,3,n.sfuSimulcastDecAvgNumReplayedCachedPkt,950,3,n.sfuSimulcastDecAvgNumSkippedCachedPkt,953,0,n.sfuSimulcastDecNumNoKf,744,0,n.sfuSimulcastDecSessFlipCount,768,0,n.sfuSimulcastDecSessFlipErrorBitmap,767,0,n.sfuSimulcastDecSessFlipErrorCount,766,0,n.sfuSimulcastEncErrorBitmap,732,0,n.sfuSimulcastEncSchedEventCount,735,0,n.sfuSimulcastEncSchedEventErrorCount,734,0,n.sfuSimulcastEncSchedEventSkipCount,733,0,n.sfuSimulcastEncSchedEventSuccessUpdateCount,832,0,n.sfuSimulcastMaxDecSessFlipTime,836,0,n.sfuSimulcastMaxEncSchedEventUpdateTime,831,0,n.sfuSimulcastMinDecSessFlipTime,835,0,n.sfuSimulcastMinEncSchedEventUpdateTime,659,3,n.sfuUplinkAvgCombinedBwe,664,3,n.sfuUplinkAvgPktLossPct,658,3,n.sfuUplinkAvgRemoteBwe,670,3,n.sfuUplinkAvgRtt,657,3,n.sfuUplinkAvgSenderBwe,1160,3,n.sfuUplinkInitCombinedBwe3s,1161,3,n.sfuUplinkInitPktLossPct3s,665,3,n.sfuUplinkMaxPktLossPct,671,3,n.sfuUplinkMaxRtt,663,3,n.sfuUplinkMinPktLossPct,669,3,n.sfuUplinkMinRtt,968,3,n.sfuUplinkSbweAvgDowntrend,967,3,n.sfuUplinkSbweAvgUptrend,790,0,n.sfuUplinkSbweCeilingCongestionCount,788,0,n.sfuUplinkSbweCeilingCount,793,0,n.sfuUplinkSbweCeilingMissingRtcpCongestionCount,794,0,n.sfuUplinkSbweCeilingNoNewDataReceivedCongestionCount,789,0,n.sfuUplinkSbweCeilingPktLossCount,791,0,n.sfuUplinkSbweCeilingRttCongestionCount,792,0,n.sfuUplinkSbweCeilingZeroRttCongestionCount,966,0,n.sfuUplinkSbweHoldCount,965,0,n.sfuUplinkSbweRampDownCount,964,0,n.sfuUplinkSbweRampUpCount,956,3,n.sfuUplinkSenderBweDiffStddev,955,3,n.sfuUplinkSenderBweStddev,1011,0,n.simulcastAvgLqBitrateWhenHqEnabled,982,0,n.simulcastReplayVideoRenderFreeze2xT,983,0,n.simulcastReplayVideoRenderFreeze4xT,984,0,n.simulcastReplayVideoRenderFreeze8xT,981,0,n.simulcastReplayVideoRenderFreezeT,748,0,n.skippedBwaCycles,747,0,n.skippedBweCycles,250,0,n.speakerAvgPower,249,0,n.speakerMaxPower,248,0,n.speakerMinPower,864,0,n.speakerStartDuration,932,0,n.speakerStartToFirstCallbackT,865,0,n.speakerStopDuration,900,1,n.startedInitBweProbing,538,0,n.switchToDefTriggeredByGoodDefNet,750,0,n.switchToNonSfu,1057,0,n.switchToNonSimulcast,749,0,n.switchToSfu,1056,0,n.switchToSimulcast,257,0,n.symmetricNatPortGap,541,0,n.systemNotificationOfNetChange,440,0,n.telecomFrameworkCallStartDelayT,1221,0,n.timeCpuOverutilizedInMs,992,0,n.timeEnc1280w,988,0,n.timeEnc160w,989,0,n.timeEnc320w,990,0,n.timeEnc480w,991,0,n.timeEnc640w,530,0,n.timeOnNonDefNetwork,531,0,n.timeOnNonDefNetworkPerSegment,715,0,n.timeSinceLastRtpToCallEndInMsec,718,0,n.timeVidRcDynCondTrue,1126,0,n.totalAqsMsgSent,723,0,n.totalAudioFrameLossMs,449,3,n.totalBytesOnNonDefCell,575,0,n.totalTimeVidDlAutoPause,573,0,n.totalTimeVidUlAutoPause,898,0,n.trafficShaperAvgAudioQueueMs,242,0,n.trafficShaperAvgQueueMs,899,0,n.trafficShaperAvgVideoQueueMs,240,0,n.trafficShaperMaxDelayViolations,241,0,n.trafficShaperMinDelayViolations,237,0,n.trafficShaperOverflowCount,238,0,n.trafficShaperQueueEmptyCount,896,0,n.trafficShaperQueuedAudioPacketCount,239,0,n.trafficShaperQueuedPacketCount,897,0,n.trafficShaperQueuedVideoPacketCount,552,0,n.transportCurTimeInMsecAsyncWriteWaitingInQueue,555,0,n.transportLastSendOsError,580,0,n.transportNumAsyncWriteDispatched,551,0,n.transportNumAsyncWriteQueued,699,0,n.transportOvershoot10PercCount,700,0,n.transportOvershoot20PercCount,701,0,n.transportOvershoot40PercCount,708,0,n.transportOvershootLongestStreakS,704,0,n.transportOvershootSinceLast10sCount,705,0,n.transportOvershootSinceLast15sCount,702,0,n.transportOvershootSinceLast1sCount,706,0,n.transportOvershootSinceLast30sCount,703,0,n.transportOvershootSinceLast5sCount,709,3,n.transportOvershootStreakAvgS,707,3,n.transportOvershootTimeBetweenAvgS,557,3,n.transportRtpSendErrorRate,556,0,n.transportSendErrorCount,1153,0,n.transportSnJumpDetectCount,1059,0,n.transportSplitterRxErrCnt,1058,0,n.transportSplitterTxErrCnt,1141,0,n.transportSrtcpRxRejectedPktCnt,1038,0,n.transportSrtpRxMaxPktSize,763,3,n.transportSrtpRxRejectedBitrate,772,0,n.transportSrtpRxRejectedDupPktCnt,762,0,n.transportSrtpRxRejectedPktCnt,774,0,n.transportSrtpTxFailedPktCnt,773,0,n.transportSrtpTxMaxPktSize,554,0,n.transportTotalNumSendOsError,553,0,n.transportTotalTimeInMsecAsyncWriteQueueToDispatch,710,0,n.transportUndershoot10PercCount,711,0,n.transportUndershoot20PercCount,712,0,n.transportUndershoot40PercCount,536,0,n.triggeredButDataLimitReached,1112,0,n.tsLogUpload,289,0,n.txProbeCountSuccess,288,0,n.txProbeCountTotal,1105,0,n.txRelayBindUnbindPacketsMissingMessageIntegrity,839,0,n.txRelayRebindLatencyMs,840,0,n.txRelayResetLatencyMs,144,3,n.txTotalBitrate,142,3,n.txTotalBytes,293,3,n.txTpFbBitrate,246,0,n.upnpAddResultCode,247,0,n.upnpRemoveResultCode,341,0,n.usedInitTxBitrate,1150,0,n.usedIpv4Count,1151,0,n.usedIpv6Count,87,2,n.userDescription,88,0,n.userProblems,86,0,n.userRating,1143,0,n.v2vAudioFrameLoss1xMs,1144,0,n.v2vAudioFrameLoss2xMs,1145,0,n.v2vAudioFrameLoss4xMs,1146,0,n.v2vAudioFrameLoss8xMs,1147,0,n.v2vAudioLossPeriodCount,1148,0,n.v2vTotalAudioFrameLossMs,1121,0,n.vidAvgBurstyPktLossLength,1122,0,n.vidAvgRandomPktLossLength,1123,0,n.vidBurstyPktLossTime,688,0,n.vidCorrectRetxDetectPcnt,695,0,n.vidFreezeTMsInSample0,1062,3,n.vidJbAvgDelay,1063,3,n.vidJbDiscards,1064,3,n.vidJbEmpties,1065,3,n.vidJbGets,1061,3,n.vidJbLost,1066,3,n.vidJbPuts,1067,3,n.vidJbResets,696,0,n.vidNumFecDroppedNoHole,697,0,n.vidNumFecDroppedTooBig,1124,0,n.vidNumRandToBursty,698,0,n.vidNumRetxDropped,757,0,n.vidNumRxRetx,693,2,n.vidPktRxState0,1125,0,n.vidRandomPktLossTime,694,3,n.vidRxFecRateInSample0,589,1,n.vidUlAutoPausedAtCallEnd,590,0,n.vidUlTimeSinceAutoPauseAtCallEnd,716,0,n.vidWrongRetxDetectPcnt,276,0,n.videoActiveTime,1041,0,n.videoAheadAvSyncDiscardedFramesAvgDeltaT,1043,0,n.videoAheadAvSyncRenderedFramesAvgDeltaT,1039,0,n.videoAheadNumAvSyncDiscardFrames,484,0,n.videoAveDelayLtrp,390,3,n.videoAvgCombPsnr,410,3,n.videoAvgEncodingPsnr,408,3,n.videoAvgScalingPsnr,186,3,n.videoAvgSenderBwe,184,3,n.videoAvgTargetBitrate,828,3,n.videoAvgTargetBitrateHq,1042,0,n.videoBehindAvSyncDiscardedFramesAvgDeltaT,1044,0,n.videoBehindAvSyncRenderedFramesAvgDeltaT,1040,0,n.videoBehindNumAvSyncDiscardFrames,222,0,n.videoCaptureAvgFps,226,0,n.videoCaptureConverterTs,887,0,n.videoCaptureDupFrames,496,0,n.videoCaptureFrameOverwriteCount,228,0,n.videoCaptureHeight,227,0,n.videoCaptureWidth,401,0,n.videoCodecScheme,303,0,n.videoCodecSubType,236,0,n.videoCodecType,220,0,n.videoDecAvgBitrate,610,3,n.videoDecAvgConsecutiveKfVp8,611,3,n.videoDecAvgConsecutiveLtrpVp8,207,3,n.videoDecAvgFps,612,3,n.videoDecAvgFramesFromFoundLtrVp8,613,3,n.videoDecAvgFramesFromUnfoundLtrVp8,205,0,n.videoDecColorId,419,0,n.videoDecCrcMismatchFrames,174,0,n.videoDecErrorFrames,714,0,n.videoDecErrorFramesCodecSwitch,713,0,n.videoDecErrorFramesDuplicate,680,0,n.videoDecErrorFramesH264,478,0,n.videoDecErrorFramesIgnoreConsecutive,682,0,n.videoDecErrorFramesOutoforder,812,0,n.videoDecErrorFramesSpsPpsH264,810,0,n.videoDecErrorFramesSpsPpsMissingAfterResolutionSwitch,811,0,n.videoDecErrorFramesSpsPpsNotSupportedAfterResolutionSwitch,681,0,n.videoDecErrorFramesVp8,462,0,n.videoDecErrorLtrpFramesVp8,479,0,n.videoDecErrorLtrpFramesVp8CrcMismatch,480,0,n.videoDecErrorLtrpFramesVp8NoLtr,615,0,n.videoDecErrorLtrpFramesVp8NoLtr10,614,0,n.videoDecErrorLtrpFramesVp8NoLtr5,1084,0,n.videoDecFatalErrorNum,172,0,n.videoDecInputFrames,175,0,n.videoDecKeyframes,223,0,n.videoDecLatency,684,0,n.videoDecLatencyH264,683,0,n.videoDecLatencyVp8,210,0,n.videoDecLostPackets,461,0,n.videoDecLtrpFramesVp8,490,1,n.videoDecLtrpPoolCreateFailed,204,0,n.videoDecName,915,0,n.videoDecNumPliThrottledByAllLtrp,616,0,n.videoDecNumSkippedFramesVp8,617,0,n.videoDecNumSwitchesToAllLtrp,173,0,n.videoDecOutputFrames,206,0,n.videoDecRestart,209,0,n.videoDecSkipPackets,232,0,n.videoDecodePausedCount,273,0,n.videoDowngradeCount,163,1,n.videoEnabled,270,1,n.videoEnabledAtCallStart,609,0,n.videoEncAllLtrpTimeInMsec,221,0,n.videoEncAvgBitrate,605,3,n.videoEncAvgConsecutiveKfVp8,606,3,n.videoEncAvgConsecutiveLtrpVp8,216,3,n.videoEncAvgFps,825,3,n.videoEncAvgFpsHq,604,3,n.videoEncAvgFramesFromFoundLtrVp8,603,3,n.videoEncAvgFramesFromUnfoundLtrVp8,465,3,n.videoEncAvgPsnrKeyFrameVp8,469,3,n.videoEncAvgPsnrLtrpFrameVp8,474,3,n.videoEncAvgPsnrPFramePrevRefVp8,1216,3,n.videoEncAvgQpKeyFrameOpenh264,466,3,n.videoEncAvgQpKeyFrameVp8,1217,3,n.videoEncAvgQpLtrpFrameOpenh264,470,3,n.videoEncAvgQpLtrpFrameVp8,1218,3,n.videoEncAvgQpPFramePrevRefOpenh264,475,3,n.videoEncAvgQpPFramePrevRefVp8,685,3,n.videoEncAvgSizeAllLtrpFrameVp8,464,3,n.videoEncAvgSizeKeyFrameVp8,468,3,n.videoEncAvgSizeLtrpFrameVp8,473,3,n.videoEncAvgSizePFramePrevRefVp8,215,3,n.videoEncAvgTargetFps,827,3,n.videoEncAvgTargetFpsHq,213,0,n.videoEncColorId,686,3,n.videoEncDeviationAllLtrpFrameVp8,687,3,n.videoEncDeviationPFramePrevRefVp8,217,0,n.videoEncDiscardFrame,938,0,n.videoEncDiscardFrameHq,179,0,n.videoEncDropFrames,937,0,n.videoEncDropFramesHq,178,0,n.videoEncErrorFrames,936,0,n.videoEncErrorFramesHq,1049,0,n.videoEncFatalErrorNum,176,0,n.videoEncInputFrames,934,0,n.videoEncInputFramesHq,180,0,n.videoEncKeyframes,939,0,n.videoEncKeyframesHq,463,0,n.videoEncKeyframesVp8,731,0,n.videoEncKfErrCodecSwitchT,729,0,n.videoEncKfIgnoreOldFrames,730,0,n.videoEncKfQueueEmpty,224,0,n.videoEncLatency,826,0,n.videoEncLatencyHq,471,0,n.videoEncLtrpFrameGenFailedVp8,467,0,n.videoEncLtrpFramesVp8,491,1,n.videoEncLtrpPoolCreateFailed,494,0,n.videoEncLtrpToKfFallbackVp8,1050,0,n.videoEncModifyNum,212,0,n.videoEncName,600,0,n.videoEncNumErrorLtrHoldFailedVp8,602,0,n.videoEncNumErrorLtrHoldFailedVp810,601,0,n.videoEncNumErrorLtrHoldFailedVp85,622,0,n.videoEncNumSuccessHfFallbackVp8,607,0,n.videoEncNumSwitchesToAllLtrp,177,0,n.videoEncOutputFrames,935,0,n.videoEncOutputFramesHq,472,0,n.videoEncPFramePrevRefVp8,608,0,n.videoEncRegularLtrpTimeInMsec,214,0,n.videoEncRestart,1046,0,n.videoEncRestartPresetChange,1045,0,n.videoEncRestartResChange,363,0,n.videoEncTimeOvershoot10PercH264,366,0,n.videoEncTimeOvershoot10PercH265,369,0,n.videoEncTimeOvershoot10PercVp8,372,0,n.videoEncTimeOvershoot10PercVp9,364,0,n.videoEncTimeOvershoot20PercH264,367,0,n.videoEncTimeOvershoot20PercH265,370,0,n.videoEncTimeOvershoot20PercVp8,373,0,n.videoEncTimeOvershoot20PercVp9,365,0,n.videoEncTimeOvershoot40PercH264,368,0,n.videoEncTimeOvershoot40PercH265,371,0,n.videoEncTimeOvershoot40PercVp8,374,0,n.videoEncTimeOvershoot40PercVp9,1026,0,n.videoEncTimeSpentInFastH264Ms,1025,0,n.videoEncTimeSpentInFasterH264Ms,1027,0,n.videoEncTimeSpentInMediumH264Ms,1019,0,n.videoEncTimeSpentInNegative10Vp8Ms,1018,0,n.videoEncTimeSpentInNegative12Vp8Ms,1022,0,n.videoEncTimeSpentInNegative4Vp8Ms,1021,0,n.videoEncTimeSpentInNegative6Vp8Ms,1020,0,n.videoEncTimeSpentInNegative8Vp8Ms,1023,0,n.videoEncTimeSpentInSuperfastH264Ms,1024,0,n.videoEncTimeSpentInVeryfastH264Ms,375,0,n.videoEncTimeUndershoot10PercH264,378,0,n.videoEncTimeUndershoot10PercH265,381,0,n.videoEncTimeUndershoot10PercVp8,384,0,n.videoEncTimeUndershoot10PercVp9,376,0,n.videoEncTimeUndershoot20PercH264,379,0,n.videoEncTimeUndershoot20PercH265,382,0,n.videoEncTimeUndershoot20PercVp8,385,0,n.videoEncTimeUndershoot20PercVp9,377,0,n.videoEncTimeUndershoot40PercH264,380,0,n.videoEncTimeUndershoot40PercH265,383,0,n.videoEncTimeUndershoot40PercVp8,386,0,n.videoEncTimeUndershoot40PercVp9,183,0,n.videoFecRecovered,334,0,n.videoH264Time,335,0,n.videoH265Time,189,0,n.videoHeight,904,3,n.videoInitRxBitrate16s,901,3,n.videoInitRxBitrate2s,902,3,n.videoInitRxBitrate4s,903,3,n.videoInitRxBitrate8s,402,0,n.videoInitialCodecScheme,321,0,n.videoInitialCodecType,404,0,n.videoLastCodecType,185,3,n.videoLastSenderBwe,392,3,n.videoMaxCombPsnr,411,3,n.videoMaxEncodingPsnr,426,3,n.videoMaxRxBitrate,409,3,n.videoMaxScalingPsnr,420,3,n.videoMaxTargetBitrate,829,3,n.videoMaxTargetBitrateHq,425,3,n.videoMaxTxBitrate,824,3,n.videoMaxTxBitrateHq,391,3,n.videoMinCombPsnr,407,3,n.videoMinEncodingPsnr,406,3,n.videoMinScalingPsnr,421,3,n.videoMinTargetBitrate,830,3,n.videoMinTargetBitrateHq,1185,1,n.videoNackHbhEnabled,872,0,n.videoNackSendDelay,871,0,n.videoNewPktsBeforeNack,594,0,n.videoNpsiGenFailed,595,0,n.videoNpsiNoNack,1010,0,n.videoNumAvSyncDiscardFrames,332,0,n.videoNumH264Frames,333,0,n.videoNumH265Frames,275,0,n.videoPeerState,654,0,n.videoPeerTriggeredPauseCount,208,0,n.videoRenderAvgFps,225,0,n.videoRenderConverterTs,196,0,n.videoRenderDelayT,888,0,n.videoRenderDupFrames,304,0,n.videoRenderFreeze2xT,305,0,n.videoRenderFreeze4xT,306,0,n.videoRenderFreeze8xT,235,0,n.videoRenderFreezeT,908,0,n.videoRenderInitFreeze16sT,905,0,n.videoRenderInitFreeze2sT,906,0,n.videoRenderInitFreeze4sT,907,0,n.videoRenderInitFreeze8sT,526,0,n.videoRenderInitFreezeT,569,0,n.videoRenderNumFreezes,571,0,n.videoRenderNumSinceLastFreeze10s,572,0,n.videoRenderNumSinceLastFreeze30s,570,0,n.videoRenderNumSinceLastFreeze5s,1132,0,n.videoRenderPauseT,568,0,n.videoRenderSumTimeSinceLastFreeze,1178,0,n.videoRetxRtcpNack,1179,0,n.videoRetxRtcpPli,1180,0,n.videoRetxRtcpRr,493,0,n.videoRtcpAppRxFailed,492,0,n.videoRtcpAppTxFailed,169,3,n.videoRxBitrate,187,1,n.videoRxBweHitTxBwe,489,3,n.videoRxBytesRtcpApp,219,3,n.videoRxFecBitrate,182,0,n.videoRxFecFrames,485,0,n.videoRxKfBeforeLtrpAfterRpsi,460,0,n.videoRxLtrpFramesVp8,721,0,n.videoRxNumCodecSwitch,201,0,n.videoRxPackets,171,3,n.videoRxPktErrorPct,170,3,n.videoRxPktLossPct,487,0,n.videoRxPktRtcpApp,621,0,n.videoRxRtcpFir,203,0,n.videoRxRtcpNack,1181,0,n.videoRxRtcpNackDropped,521,0,n.videoRxRtcpNpsi,202,0,n.videoRxRtcpPli,1182,0,n.videoRxRtcpPliDropped,459,0,n.videoRxRtcpRpsi,1183,0,n.videoRxRtcpRrDropped,168,3,n.videoRxTotalBytes,274,0,n.videoSelfState,954,3,n.videoSenderBweDiffStddev,348,3,n.videoSenderBweStddev,351,0,n.videoTargetBitrateReaches1000kbpsT,435,0,n.videoTargetBitrateReaches1500kbpsT,436,0,n.videoTargetBitrateReaches2000kbpsT,349,0,n.videoTargetBitrateReaches200kbpsT,433,0,n.videoTargetBitrateReaches250kbpsT,350,0,n.videoTargetBitrateReaches500kbpsT,434,0,n.videoTargetBitrateReaches750kbpsT,451,3,n.videoTotalBytesOnNonDefCell,165,3,n.videoTxBitrate,823,3,n.videoTxBitrateHq,488,3,n.videoTxBytesRtcpApp,218,3,n.videoTxFecBitrate,181,0,n.videoTxFecFrames,720,0,n.videoTxNumCodecSwitch,197,0,n.videoTxPackets,818,0,n.videoTxPacketsHq,167,3,n.videoTxPktErrorPct,821,3,n.videoTxPktErrorPctHq,166,3,n.videoTxPktLossPct,822,3,n.videoTxPktLossPctHq,486,0,n.videoTxPktRtcpApp,198,0,n.videoTxResendPackets,819,0,n.videoTxResendPacketsHq,620,0,n.videoTxRtcpFirEmptyJb,200,0,n.videoTxRtcpNack,520,0,n.videoTxRtcpNpsi,199,0,n.videoTxRtcpPli,820,0,n.videoTxRtcpPliHq,458,0,n.videoTxRtcpRpsi,164,3,n.videoTxTotalBytes,817,3,n.videoTxTotalBytesHq,453,0,n.videoUpdateEncoderFailureCount,325,0,n.videoUpgradeCancelByTimeoutCount,323,0,n.videoUpgradeCancelCount,272,0,n.videoUpgradeCount,326,0,n.videoUpgradeRejectByTimeoutCount,324,0,n.videoUpgradeRejectCount,271,0,n.videoUpgradeRequestCount,188,0,n.videoWidth,1136,0,n.voipParamsCompressedSize,1137,0,n.voipParamsUncompressedSize,513,0,n.vpxLibUsed,891,0,n.waLongFreezeCount,890,0,n.waReconnectFreezeCount,889,0,n.waShortFreezeCount,1162,0,n.waVoipHistoryGetVideoTxBitrateBySelfAndPeerIpStrResult,1163,1,n.waVoipHistoryGetVideoTxBitrateBySelfAndPeerIpStrSuccess,1164,0,n.waVoipHistoryGetVideoTxBitrateBySelfIpStrResult,1165,1,n.waVoipHistoryGetVideoTxBitrateBySelfIpStrSuccess,834,1,n.waVoipHistoryIpAddressNotAvailable,737,1,n.waVoipHistoryIsCallRecordLoaded,738,1,n.waVoipHistoryIsCallRecordSaved,769,1,n.waVoipHistoryIsInitialized,1166,0,n.waVoipHistoryNumOfCallRecordFoundByMatchingSelfAndPeerIpStr,1167,0,n.waVoipHistoryNumOfCallRecordFoundByMatchingSelfIpStr,739,0,n.waVoipHistoryNumOfCallRecordLoaded,770,0,n.waVoipHistorySaveCallRecordConditionCheckStatus,656,3,n.warpHeaderRxTotalBytes,655,3,n.warpHeaderTxTotalBytes,1118,0,n.warpMiRxPktErrorCount,1117,0,n.warpMiTxPktErrorCount,1154,0,n.warpRelayChangeDetectCount,746,0,n.warpRxPktErrorCount,745,0,n.warpTxPktErrorCount,1156,0,n.waspKeyErrorCount,1089,0,n.wavFileWriteMaxLatency,429,0,n.weakCellularNetConditionDetected,430,0,n.weakWifiNetConditionDetected,397,0,n.weakWifiSwitchToDefNetSuccess,395,0,n.weakWifiSwitchToDefNetSuccessByPeriodicalCheck,396,0,n.weakWifiSwitchToDefNetTriggered,394,0,n.weakWifiSwitchToDefNetTriggeredByPeriodicalCheck,399,0,n.weakWifiSwitchToNonDefNetFalsePositive,400,0,n.weakWifiSwitchToNonDefNetSuccess,398,0,n.weakWifiSwitchToNonDefNetTriggered,263,0,n.wifiRssiAtCallStart,64,0,n.wpNotifyCallFailed,65,1,n.wpSoftwareEcMatches,3,0,n.xmppStatus,269,0,n.xorCipher,1088,0,n.zedFileWriteMaxLatency],t),Promise.resolve()}__LOG__(2)`EventCallback::onFieldStatsReady called without payload`}},w=class extends t.SendSignalingCallback{constructor(){var e;return e=super(...arguments),this.AU=new p.a,e}sendSignaling(e){var t=e.peerJid,n=e.payload,r=n.tag;__LOG__(2)`SendSignalingCallback::sendSignaling start ${t}, tag ${r}, ${e}`;var a,i=(0,m.o)(t);if("phoneUser"===i.jidType)a=(0,m.e)(i.userJid);else{if("phoneDevice"!==i.jidType)throw __LOG__(4)`SendSignalingCallback incorrect peerJid format ${t}`,SEND_LOGS("voip-incorrect-peerjid"),new Error("SendSignalingCallback incorrect peerJid format "+t);a=(0,m.v)(i.deviceJid)}var s=(0,S.t)();return this.AU.enqueue(()=>(function(e,t){if("offer"!==t.tag)return Promise.resolve(t);var n=t.children.find(e=>"enc"===e.tag);return null!=n&&null!=n.content?(function(e,t){var n={call:{callKey:t.content}},r=(0,b.d)(n);return(0,d.ensureE2eSession)(e).then(()=>(0,u.o)(e,r)).then(e=>{var n=e.type,r=e.ciphertext;t.content=r,t.attrs.push({key:"type",value:n}),t.attrs.push({key:"v",value:"2"})})})(e,n).then(()=>t):Promise.resolve(t)})(a,n).then(e=>(__LOG__(2)`SendSignalingCallback::sendSignaling encodedPayload received`,(0,y.k)((0,S.v)("call",{id:s,to:(0,S.g)(a)},(function e(t){var n=t.tag,r=t.attrs,a=t.children,i=t.content,s=r.reduce((e,t)=>{var n=t.key,r=t.value,a=t.jidValue;return null!=a&&(function(e){return e.subType===I.b.JID||e.agent<=0&&e.device<=0})(a)?e[n]=(0,h.c)(a):e[n]=r,e},{}),o=Array.isArray(a)&&a.length>0?a.map(t=>e(t)):i.length>0?i:null;return new S.n(n,s,o)})(e)),{id:String(s),class:"call",type:r,from:a,participant:null}).then(e=>{var t=h.a.parse(e);if(!t.error){var n,i=t.success.stanzaObject,s=i.attrs.find(e=>"error"===e.key),o=null==s?0:parseInt(s.value,10);return __LOG__(2)`handleIncomingAck sendStanzaAndReturnAck`,n={peerJid:a,type:r,error:o,ack:i},A.promise.then(e=>{if(e)return e.handleIncomingAck(n).then(e=>e)})}__LOG__(2)`Unable to parse call ack stanza`}))).then(()=>(__LOG__(2)`SendSignalingCallback::sendSignaling done`,0)).catch(e=>{throw __LOG__(4)`SendSignalingCallback::sendSignaling error`,e}))}};M=!0,t.get(e).then(e=>(__LOG__(2)`voip::onSessionConnected got server #${e.id}`,Object.getOwnPropertyNames(Object.getPrototypeOf(e)).filter(e=>"constructor"!==e),e.addEventListener(e.SERVICE_EVICTED_EVENT,e=>{O.resolve(),L()}),e.getVersion().then(e=>{__LOG__(2)`voip::getVersion version: ${e}`}),e.setApplicationSettings({selfJid:o.r.get(),enableCallerMsgBuffer:!1,enableCalleeMsgBuffer:!0,enableLowDataUsage:!0,enableMdOutgoingCall:!1,forceKillDaemonOnDisconnected:(0,f.d)()}).then(t=>{if(0!==t)throw __LOG__(2)`Invalid settings, result = ${t}`,new Error("Invalid settings");return e}))).then(t=>{__LOG__(2)`voip::onSessionConnected register event callback`;var n=e.new_tracked(E,t);return t.setEventCallback(n).then(()=>t)}).then(t=>{__LOG__(2)`voip::onSessionConnected register send signaling callback`;var n=e.new_tracked(w);return t.setSendSignalingCallback(n).then(()=>t)}).then(e=>(__LOG__(2)`voip::onSessionConnected determining if there is an ongoing call`,e.getCallInfo().then(t=>[e,t]))).then(e=>{var t=a()(e,2),n=t[0],r=t[1];A.resolve(n),__LOG__(2)`voip::onSessionConnected setup done`,n.hasCrash().then(e=>{e&&(__LOG__(2)`voip::onSessionConnected crash detected`,SEND_LOGS("voip-daemon-crashed"))});var i=!!(null==r?void 0:r.callId);__LOG__(2)`voip::onSessionConnected in ongoing call ${i}`,(0,f.c)("event","voipSetupDone",{inOngoingCall:i})}).catch(e=>{__LOG__(4)`An error occured while VoIP was setup: ${e}`,A.resolve()})}function L(){Object.keys(P).forEach(e=>{null!=P[e]&&(clearTimeout(P[e]),P[e]=null)})}function D(){o.n.get()?(__LOG__(2)`voip::onSessionDisconnected`,A=new s.a,L(),(0,f.c)("event","voipServiceDisconnected",{})):__LOG__(2)`voip::onSessionDisconnected: VOIP service is not supported`}function x(e,t){return N().then(t)}function U(e,t){var n=(function(e){return o.n.get()?(0,w.a)(o.E.get())||"getVoipLogData"===e&&o.E.get().kaiosVoiceLogsEnabled?!(!(0,f.d)()&&O.resolveWasCalled())||(__LOG__(3)`voip::${e} called, but the worker has been evicted`,"evicted"):(__LOG__(3)`voip::${e} called when VOIP is not enabled`,!1):(__LOG__(4)`voip::${e} called when VOIP is not supported`,SEND_LOGS("voip-used-while-unsupported"),!1)})(e);return"evicted"===n?Promise.resolve("evicted"):n?x(0,e=>{if(e)return t(e)}):Promise.resolve()}function F(e,t){return U("startVoipCall",n=>{var r=(0,c.s)((0,l.l)(15));return C={id:r,uiContext:t},(0,c.qb)({callId:r,peer:e,isFromMe:!0},(0,v.E)()),Promise.resolve(null).then(t=>{t?n.startCallMd(t,r):n.startCall(e,r)}).then(e=>{})}).catch(()=>{(0,f.c)("event","voipCallFailed",{})})}function B(e){return U("handleIncomingVoipSignaling",t=>{var n=e.payload,r=e.peerPlatform,a=e.peerAppVersion;if("accept"===n.tag){if(null==C)return void __LOG__(4)`voip::handleIncomingSignaling LastOutgoingCallDetails is missing but accept received`;var i=n.attrs.find(e=>"call-id"===e.key),s=null==i?void 0:i.value;if(C.id!==s)return void __LOG__(4)`voip::handleIncomingSignaling LastOutgoingCallDetails contains information for a different call ${C.id} instead of expected ${s}`;C.peerPlatform=r,C.peerAppVersion=a}return t.handleIncomingSignaling(e).then(e=>{})})}function j(e,t){var n=e.payload,r=e.peerPlatform,a=e.peerAppVersion,i=n.attrs.find(e=>"call-id"===e.key),s=null==i?void 0:i.value;return null==s?(__LOG__(4)`voip::handleIncomingOffer missing call-id in offer attributes`,SEND_LOGS("voip-incoming-offer-missing-call-id"),Promise.resolve()):(R={id:s,peerPlatform:r,peerAppVersion:a},U("handleIncomingVoipOffer",n=>n.handleIncomingOffer(e,t).then(e=>{})))}function V(e){return U("handleIncomingVoipReceipt",t=>t.handleIncomingReceipt(e).then(e=>{}))}function K(){return U("acceptVoipCall",e=>e.acceptCall().then(e=>{})).catch(()=>{(0,f.c)("event","voipCallFailed",{})})}function H(){return U("rejectVoipCall",e=>e.rejectCall().then(e=>{})).catch(()=>{(0,f.c)("event","voipCallFailed",{})})}function $(e,t,n,r,a){return U("rejectVoipCallWithoutCallContext",i=>i.rejectCallWithoutCallCtx(e,t,n,r,a).then(e=>{}))}function q(e){return U("endVoipCall",t=>t.endCall(e).then(e=>{}))}function z(e){return U("muteVoipCall",t=>t.muteCall(e).then(e=>{}))}function J(e){return U("interruptVoipCall",t=>t.interruptCall(e).then(e=>{}))}function Y(e){return U("updateVoipNetworkMedium",t=>{var n;if("undefined"==typeof lib_wavoip||null==(null==(n=lib_wavoip.WaVoipService)?void 0:n.NetworkMedium))throw new Error("voip::updateVoipNetworkMedium cannot find lib_wavoip.WaVoipService.NetworkMedium");var r=lib_wavoip.WaVoipService.NetworkMedium,a=e===E.a.WIFI?r.WIFI:e===E.a.CELLULAR?r.CELLULAR:r.NONE;return t.updateNetworkMedium(a).then(e=>{})})}function W(){return U("getVoipCallInfo",e=>e.getCallInfo().then(e=>e))}function Z(e){return U("getVoipLogData",t=>(performance.now(),t.getLogData(e).then(e=>{var t=null==e?void 0:e.content;return t instanceof Uint8Array&&t.byteLength,e})))}function Q(){return x(0,e=>e?e.endCall(!0).then(e=>{}):(__LOG__(4)`voip::forceEndVoipCall called when VOIP is not supported`,void SEND_LOGS("voip-used-while-unsupported")))}function X(e){WAM.log("regular",462,void 0,[102,0,e.callOfferElapsedT,15,2,e.callPeerAppVersion,5,2,e.callPeerPlatform,63,0,4,1,0,2,19,2,e.callTestBucket,156,0,e.callWakeupSource,163,1,e.videoEnabled])}function ee(){return O.promise}function te(){return M}},,function(e,t,n){n.d(t,"a",(function(){return g})),n.d(t,"f",(function(){return E})),n.d(t,"m",(function(){return b})),n.d(t,"k",(function(){return y})),n.d(t,"j",(function(){return S})),n.d(t,"i",(function(){return I})),n.d(t,"l",(function(){return w})),n.d(t,"h",(function(){return T})),n.d(t,"g",(function(){return A})),n.d(t,"e",(function(){return M})),n.d(t,"c",(function(){return C})),n.d(t,"d",(function(){return R})),n.d(t,"o",(function(){return k})),n.d(t,"p",(function(){return P})),n.d(t,"n",(function(){return G})),n.d(t,"q",(function(){return D})),n.d(t,"b",(function(){return x}));var r=n(2),a=n(6),i=n(57),s=n(3),o=n(7),u=n(36),d=n(84),c=n(24),l=n(47),p=n(374),h=n(97),f=n(23),m=n(63),v=n(14),g={[r.f.TEXT]:1,[r.f.PTT]:5,[r.f.AUDIO]:4,[r.f.FUTUREPROOF]:12,[r.f.GIF]:11,[r.f.IMAGE]:2,[r.f.STICKER]:16,[r.f.LOCATION]:6,[r.f.VIDEO]:3,[r.f.VCARD]:13,[r.f.DOCUMENT]:8,[r.f.RICH_HSM]:17};function _(e){var t,n,r=(0,o.b)(e);return n=r?(0,o.x)(r,{user:e=>(t=(0,i.g)(e)!==(0,i.g)(a.r.get()),1),group:e=>2}):4,{messageIsInternational:t,messageType:n}}function E(e,t,n){var r=r=>{if(e.forwardOriginalTs){var a=1e3*(e.ts-e.forwardOriginalTs),i=g[e.type],o=_(t),d=o.messageIsInternational,c=o.messageType,l=e.forwardingScore;null==l&&(l=e.isForwarded?1:0);var p=null!=e.expiration?e.expiration:void 0,h=null!=r?r:{};WAM.log("regular",1728,void 0,[1,0,null!=h.messageType?h.messageType:c,2,0,null!=h.messageMediaType?h.messageMediaType:i,3,1,null!=h.messageIsFastForward?h.messageIsFastForward:!n,4,0,null!=h.messageForwardAgeT?h.messageForwardAgeT:a,5,1,null==h.fastForwardEnabled||h.fastForwardEnabled,9,1,null!=h.messageIsInternational?h.messageIsInternational:d,13,0,null!=h.messageSendT?h.messageSendT:1e3*((0,s.E)()-e.ts),14,1,null!=h.isFrequentlyForwarded?h.isFrequentlyForwarded:l>=u.a,8,0,null!=h.resendCount?h.resendCount:e.resendCount,18,0,null!=h.ephemeralityDuration?h.ephemeralityDuration:p,21,0,h.disappearingChatInitiator,12,0,h.e2eCiphertextType,11,0,h.e2eCiphertextVersion,22,1,h.isForwardedForward,10,1,h.mediaCaptionPresent,6,1,h.messageIsFanout,20,0,h.receiverDefaultDisappearingDuration,7,0,h.retryCount,19,0,h.senderDefaultDisappearingDuration,16,1,h.wouldBeFrequentlyForwardedAt3,17,1,h.wouldBeFrequentlyForwardedAt4])}};(0,o.w)(t,{user:e=>{if(!(0,f.a)("disappearing_mode"))return r();(0,m.b)(e).then(e=>{var t=e&&x(e,"sender-me");r(t)}).catch(e=>{throw r(),e})},multicast:()=>r()})}function b(e){A({jid:e.jid,dbMsg:e.dbMsg,thumbSize:e.thumbSize,result:7,isTerminal:!0,origin:e.origin})}function y(e){var t=e.jid,n=e.dbMsg,r=e.thumbSize,a=e.origin,i=e.isTerminal;A({jid:t,dbMsg:n,thumbSize:r,result:5,isTerminal:void 0===i||i,origin:a,e2eBackfill:e.e2eBackfill})}function S(e){A({jid:e.jid,dbMsg:e.dbMsg,thumbSize:e.thumbSize,result:3,isTerminal:!0,origin:e.origin})}function I(e,t){A({jid:e,result:6,isTerminal:!0,origin:t})}function w(e,t){A({jid:e,result:3,isTerminal:!0,origin:t})}function T(e){A({jid:e.jid,dbMsg:e.dbMsg,result:8,isTerminal:!1,e2eBackfill:e.e2eBackfill})}function A(e){var t=e.jid,n=e.dbMsg,a=e.thumbSize,i=e.result,u=e.isTerminal,l=e.origin,p=e.e2eBackfill,h=n&&O(n),v=e=>{var o=(null==n?void 0:n.forwardOriginalTs)?1e3*(n.ts-n.forwardOriginalTs):void 0,d=_(t),l=d.messageIsInternational,f=d.messageType,m=!n||n.type!==r.f.IMAGE&&n.type!==r.f.VIDEO&&n.type!==r.f.GIF?void 0:null!=n.text&&""!==n.text,v=n?1e3*((0,s.E)()-n.ts):void 0,g=null!=(null==n?void 0:n.expiration)?n.expiration:void 0,E=n&&(0,c.o)(n),b=n&&n.type===r.f.REVOKED,y=null!=e?e:{};WAM.log("regular",854,void 0,[2,0,null!=y.messageType?y.messageType:f,3,0,null!=y.messageMediaType?y.messageMediaType:h,8,1,null!=y.mediaCaptionPresent?y.mediaCaptionPresent:m,15,1,null==y.fastForwardEnabled||y.fastForwardEnabled,4,1,null!=y.messageIsForward?y.messageIsForward:n?null!=n.forwardOriginalTs:void 0,14,0,null!=y.messageForwardAgeT?y.messageForwardAgeT:o,7,1,null!=y.messageIsInternational?y.messageIsInternational:l,1,0,null!=y.messageSendResult?y.messageSendResult:i,17,1,null!=y.messageSendResultIsTerminal?y.messageSendResultIsTerminal:u,11,0,null!=y.messageSendT?y.messageSendT:v,16,0,null!=y.resendCount?y.resendCount:n?n.resendCount:void 0,20,3,null!=y.thumbSize?y.thumbSize:a,21,0,null!=y.ephemeralityDuration?y.ephemeralityDuration:g,22,1,null!=y.isViewOnce?y.isViewOnce:E,23,1,null!=y.e2eBackfill?y.e2eBackfill:p,24,1,null!=y.messageIsRevoke?y.messageIsRevoke:b,31,0,y.deviceCount,25,0,y.deviceSizeBucket,30,0,y.disappearingChatInitiator,10,0,y.e2eCiphertextType,9,0,y.e2eCiphertextVersion,35,1,y.isAReply,19,1,y.isFromWamsys,5,1,y.messageIsFanout,13,1,y.messageIsFastForward,26,1,y.messageIsFirstUserMessage,29,1,y.messageIsInvisible,12,1,y.messageSendOptUploadEnabled,32,0,y.participantCount,28,0,y.receiverDefaultDisappearingDuration,6,0,y.retryCount,33,0,y.revokeDuration,34,0,y.revokeType,27,0,y.senderDefaultDisappearingDuration,18,1,y.stickerIsFirstParty])};(0,o.y)(t,{user:e=>{if(!(0,f.a)("disappearing_mode"))return v();(0,m.b)(e).then(e=>{var t=e&&x(e,"sender-me");v(t)}).catch(e=>{throw v(),e})},group:()=>v(),status:()=>{var e;switch(v(),i){case 1:e=1;break;case 6:e=2;break;default:e=3}(function(e,t,n){WAM.log("regular",1176,void 0,[1,0,n&&"statusTab"===n.from?n.sessionId:void 0,2,0,e,3,0,t,4,0,n&&(0,d.k)(n)])})(h,e,l)}})}function O(e){return e.type===r.f.TEXT?null==e.linkPreview?1:9:g[e.type]}function M(e){if(e.deviceSentMessage){var t=e.deviceSentMessage.message;return t?M(t):1}if(e.ephemeralMessage){var n=e.ephemeralMessage.message;return n?M(n):1}return e.imageMessage?2:e.stickerMessage?16:e.locationMessage?14:e.contactMessage?7:e.contactsArrayMessage?13:e.documentMessage?8:e.audioMessage?e.audioMessage.ptt?5:4:e.videoMessage?e.videoMessage.gifPlayback?11:3:1}function C(e){switch(e){case l.b.ERR_NOMEM:return 30;case l.b.ERR_UNKNOWN:return 34;case l.b.ERR_INVALID_KEY_ID:return 28;case l.b.ERR_INVALID_KEY:case l.b.ERR_INVALID_SIGNED_PRE_KEY:return 27;case l.b.ERR_SIGNED_PRE_KEY_ID_MISMATCH:case l.b.ERR_SIGNED_PRE_KEY_DESERIALIZATION:return 28;case l.b.ERR_INVALID_ONE_TIME_KEY:return 27;case l.b.ERR_ONE_TIME_KEY_ID_MISMATCH:case l.b.ERR_ONE_TIME_KEY_DESERIALIZATION:return 28;case l.b.ERR_INVALID_MAC:return 29;case l.b.ERR_INVALID_VERSION:return 2;case l.b.ERR_LEGACY_MESSAGE:return 1;case l.b.ERR_STALE_KEY_EXCHANGE:return 31;case l.b.ERR_UNTRUSTED_IDENTITY:return 5;case l.b.ERR_VRF_SIG_VERIF_FAILED:return 32;case l.b.ERR_INVALID_PROTO_BUF:return 11;case l.b.ERR_FP_VERSION_MISMATCH:return 25;case l.b.ERR_FP_IDENT_MISMATCH:return 24;case l.b.ERR_DUPLICATE_MESSAGE:return 23;case l.b.ERR_NO_SESSION:return 6;case l.b.ERR_INVALID_MESSAGE:return 0;case l.b.ERR_DECRYPTION_FAILED:return 51;case l.b.ERR_DESERIALIZE_INVALID_PROTO_FORMAT:return 52;case l.b.ERR_DESERIALIZE_RATCHET_KEY_BAD_FORMAT:return 53;case l.b.ERR_DESERIALIZE_PK_INVALID_PROTO_FORMAT:return 54;case l.b.ERR_DESERIALZE_PK_KEY_BAD_FORMAT:return 55;case l.b.ERR_TOO_MANY_MESSAGES_IN_FUTURE:return 56;case l.b.ERR_EMPTY_VERSION_CONTENT_SUFFIX:return 57;case l.b.ERR_CONTENT_EXCEEDED_EXPECTED_LENGTH:return 58;case l.b.ERR_GRP_INVALID_PROTO_FORMAT:return 59;case l.b.ERR_GRP_INVALID_KEY_FORMAT:return 60;case l.b.ERR_GRP_VERSION_CONTENT_EMPTY:return 61;case l.b.ERR_GRP_INVALID_VERSION_CONTENT_LENGTH:return 62;case l.b.ERR_GRP_SENDER_KEY_INVALID_PROTO_FORMAT:return 63;case l.b.ERR_GRP_SENDER_KEY_PROTO_ERROR:return 64;case l.b.ERR_GRP_TOO_MANY_MESSAGES_IN_FUTURE:return 65}return null}function R(e){var t=(0,o.r)(e);return(0,o.h)(e)===a.r.get()?t?1:3:t?2:4}function N(e,t){return(0,o.x)(e,{user:e=>{if((0,f.a)("disappearing_mode")&&null!=t){var n,r=x(t,"sender-them");return r?(n=t.ephemeral&&t.ephemeral.expiration>v.i&&t.ephemeral.initiator===h.a.CHANGED_IN_CHAT&&r.receiverDefaultDisappearingDuration===v.i&&r.senderDefaultDisappearingDuration===v.i?t.ephemeral.expiration:null,Object.assign({},r,{ephemeralityDuration:n})):null}},group:()=>{}})}function k(e,t){var n=e.chatJid,r=_(n),a=r.messageIsInternational,i=r.messageType,s=N(n,t)||{},o=s.senderDefaultDisappearingDuration,u=s.receiverDefaultDisappearingDuration,d=s.disappearingChatInitiator,c=s.ephemeralityDuration;WAM.log("regular",450,void 0,[4,1,a,1,0,i,2,0,34,11,0,o,12,0,u,14,0,d,13,0,c])}function P(e,t){L(e,t)}function G(e,t,n){L(e,t,N(t,n))}function L(e,t,n){var r=O(e),a=_(t),i=a.messageIsInternational,s=a.messageType,o=e&&(0,c.o)(e),u=n||{},d=u.senderDefaultDisappearingDuration,l=u.receiverDefaultDisappearingDuration,p=u.disappearingChatInitiator,h=u.ephemeralityDuration;WAM.log("regular",450,void 0,[4,1,i,1,0,s,2,0,r,9,1,o,11,0,d,12,0,l,14,0,p,13,0,h])}function D(e){var t=a.J.get().status,n=(0,p.a)(e,t);"country-disabled"===n?WAM.log("regular",3152,void 0,[1,0,2]):"tos-not-accepted"===n&&WAM.log("regular",3152,void 0,[1,0,1])}function x(e,t){var n,r=e.ephemeral;if(null==r)return null;var i=a.j.get().disappearingMsgsDefaultTimer||v.i,s=(null==(n=e.defaultDisappearingMode)?void 0:n.expiration)||v.i,o="sender-me"===t;return{disappearingChatInitiator:U(r.initiator),senderDefaultDisappearingDuration:o?i:s,receiverDefaultDisappearingDuration:o?s:i}}function U(e){switch(e){case h.a.CHANGED_IN_CHAT:return 1;case h.a.INITIATED_BY_ME:return 2;case h.a.INITIATED_BY_OTHER:return 3}return null}},,,function(e,t,n){n.d(t,"k",(function(){return C})),n.d(t,"b",(function(){return N})),n.d(t,"d",(function(){return k})),n.d(t,"c",(function(){return P})),n.d(t,"m",(function(){return G})),n.d(t,"l",(function(){return L})),n.d(t,"a",(function(){return D})),n.d(t,"f",(function(){return x})),n.d(t,"e",(function(){return U})),n.d(t,"i",(function(){return F})),n.d(t,"j",(function(){return B})),n.d(t,"h",(function(){return j})),n.d(t,"g",(function(){return V}));var r=n(28),a=n(109),i=["image","sticker","ptt","audio","document","video","gif","ppic","md-app-state","md-msg-hist","kyc-id","template","thumbnail-image","thumbnail-video","thumbnail-gif","thumbnail-document","thumbnail-link","payment-bg-image","novi-video","novi-image","product","product-catalog-image","xma-image","biz-cover-photo"],s=new(n(46).a)("mediaConnParser",e=>{var t,n,r=e.child("media_conn");return{hosts:r.mapChildrenWithTag("host",u),authToken:r.attrString("auth"),authTTL:r.hasAttr("auth_ttl")?r.attrFutureTime("auth_ttl"):null,authExpires:r.attrFutureTime("ttl"),maxBuckets:r.hasAttr("max_buckets")?r.attrInt("max_buckets"):null,maxManualRetry:null!=(t=r.maybeAttrInt("max_manual_retry",0,4))?t:3,maxAutoDownloadRetry:null!=(n=r.maybeAttrInt("max_auto_download_retry",0,4))?n:3}});function o(e){var t,n;if(e.hasAttr("fallback_hostname"))return{domain:e.attrString("fallback_hostname"),class:e.maybeAttrString("fallback_class"),ip4:null!=(t=e.maybeAttrString("fallback_ip4"))?t:void 0,ip6:null!=(n=e.maybeAttrString("fallback_ip6"))?n:void 0}}function u(e){var t,n,r,a;return{domain:e.attrString("hostname"),fallback:o(e),uploadable:d(e,"upload"),downloadable:d(e,"download"),isFallback:"fallback"===e.maybeAttrString("type"),downloadBuckets:null!=(t=null==(n=e.maybeChild("download_buckets"))?void 0:n.mapChildren(e=>parseInt(e.tag(),10)))?t:[],class:e.maybeAttrString("class"),ip4:null!=(r=e.maybeAttrString("ip4"))?r:void 0,ip6:null!=(a=e.maybeAttrString("ip6"))?a:void 0}}function d(e,t){return e.hasChild(t)?e.child(t).mapChildren(e=>(function(e){switch(e){case"image":case"sticker":case"ptt":case"audio":case"document":case"video":case"gif":case"ppic":case"md-app-state":case"md-msg-hist":case"kyc-id":case"thumbnail-image":case"thumbnail-video":case"thumbnail-gif":case"thumbnail-document":case"thumbnail-link":case"payment-bg-image":case"novi-video":case"novi-image":case"template":case"product":case"product-catalog-image":case"xma-image":case"biz-cover-photo":return e;default:return null}})(e.tag())).filter(Boolean):i}var c=n(115),l=n(235),p=n(38),h=n(4),f=(0,c.a)(()=>"gatherMediaInfo",(function(){var e=new l.a({name:"gatherMediaInfo",timer:{jitter:.25,max:987e3,algo:{type:"fibonacci",first:6e3,second:12e3},relativeDelay:!0},code:m});return e.start(),e.promise()}));function m(e){var t=(0,h.v)("iq",{to:h.k,xmlns:"w:m",type:"set",id:(0,h.t)()},(0,h.v)("media_conn",null));return(0,r.g)(t,s,60).then(t=>{if(t.success)__LOG__(2)`gatherMediaInfo got ${t.result.hosts.length} hosts`,e((0,p.b)(t.result));else if(__LOG__(2)`gatherMediaInfo failure ${t}`,507===t.errorCode){var n=t.errorBackoff;__LOG__(2)`gatherMediaInfo got ${n} seconds backoff`,e((0,p.a)({type:"backoff",backoffMs:1e3*n}))}}).catch(t=>{t instanceof a.a?e((0,p.a)("disconnected")):__LOG__(4)`gatherMediaInfo error ${t}`})}var v=n(3),g=n(71),_=n(12),E=n(6),b=n(58),y=n(81),S=n(261),I=n(224);function w(e){var t=null,n=null,r=null,a=e.hosts,i=e.operation,s=e.mediaType;if("download"===e.operation){var o,u=e.catHotTimespan,d=e.ncHot,c=e.getVcaEnabledBucket,l=new Map;a.forEach(e=>{e.downloadBuckets.forEach(t=>{l.set(t,e)})});var p=l.get(0);u>0&&("sticker"===s||null!=d&&(0,v.n)((0,v.j)(d),u))?t=1:c&&(t=c());var h=null;null!=t&&(h=l.get(t)),(null==(o=h)?void 0:o.downloadable.includes(s))?n=h:(null==p?void 0:p.downloadable.includes(s))&&(n=p)}for(var f=0;f<a.length;f++){var m=a[f];if(m.isFallback&&null==r&&(r=m),"upload"===i?null==n&&m.uploadable.includes(s)&&(n=m):null==n&&m.downloadable.includes(s)&&(n=m),null!=n&&null!=r)break}return{selectedHost:n,fallbackHost:r,bucket:t}}var T=n(94),A=n(187),O=n(95),M=null;function C(e){null!=e.overallDownloadResult&&null!=e.overallMediaType&&WAM.log("regular",1590,void 0,[28,1,!0,31,0,0,24,2,e.debugMediaException,22,2,e.debugMediaIp,23,2,e.debugUrl,20,3,e.downloadBytesTransferred,15,0,e.downloadConnectT,18,0,e.downloadHttpCode,17,1,e.downloadIsReuse,19,1,e.downloadIsStreaming,16,0,e.downloadNetworkT,37,0,e.downloadQuality,14,0,e.downloadResumePoint,21,0,e.downloadTimeToFirstByteT,36,3,e.estimatedBandwidth,41,1,e.isViewOnce,38,0,e.mediaId,30,0,e.networkStack,4,0,e.overallAttemptCount,39,0,e.overallBackendStore,10,0,e.overallConnBlockFetchT,29,2,e.overallConnectionClass,27,0,e.overallCumT,12,0,e.overallDecryptT,5,2,e.overallDomain,11,0,e.overallDownloadMode,35,0,e.overallDownloadOrigin,25,0,e.overallDownloadResult,13,0,e.overallFileValidationT,26,1,e.overallIsFinal,7,3,e.overallMediaSize,1,0,e.overallMediaType,6,0,e.overallMmsVersion,9,0,e.overallQueueT,3,0,e.overallRetryCount,8,0,e.overallT,40,2,e.usedFallbackHint])}function R(e){return(function(e){return H("pickHosts",e=>e.mediaAccess()).then(t=>{if("disconnected"===t)return"disconnected";var n,r,a=t.access,i=a.hosts,s=a.authToken,o=a.maxBuckets,u=t.timeElapsed;if("upload"===e.operationType){var d=w({operation:"upload",mediaType:(0,T.f)(e.mediaType),hosts:i});n=d.selectedHost,r=d.fallbackHost}else{var c,l=null;"mms4"===e.version&&(c=(function(e,t){return function(){return null==t?null:(0,A.a)(e,t)+100}})(e.ciphertextHash,o),l=(function(e){if(null==e)return null;var t,n=(t=e.split("?"),new URLSearchParams(2===t.length?t[1]:""));if(n.has("_nc_hot")){var r=parseInt(n.get("_nc_hot"),10);return Number.isInteger(r)?(0,v.j)(r):null}return null})(e.mediaDirectPath));var p=w({operation:"download",mediaType:(0,T.f)(e.mediaType),hosts:i,catHotTimespan:E.E.get().mmsHotContentTimespan,ncHot:l,getVcaEnabledBucket:c});n=p.selectedHost,r=p.fallbackHost}return n?{host:n,fallbackHost:r,authToken:s,timeElapsed:u}:"no-hosts"})})(e).then(t=>"no-hosts"===t||"disconnected"===t?t:new I.c(e.operationType,{authToken:t.authToken,host:{domain:t.host.domain,class:t.host.class},fallbackHost:t.fallbackHost&&{domain:t.fallbackHost.domain,class:t.fallbackHost.class},timeElapsed:t.timeElapsed},r.p))}function N(e){return R({operationType:"upload",mediaType:e,version:"mms4"})}function k(e,t,n){return R({operationType:"download",version:"mms4",mediaType:e,mediaDirectPath:t,ciphertextHash:n})}function P(e){return R({operationType:"download",version:"mms3",mediaType:e})}function G(){if(!M){__LOG__(2)`startMedia invoked`;var e=new class{constructor(){this.Ze=null,this.Zf=null,this.queue=new g.a,this.Zg=new g.b,this.pendingMmsThumbDownloads=new Set,this.Zh=new Map,this.Zi=new Map,this.Zj=new Set,this.STATUS_IDLE={type:"idle"},this.STATUS_PENDING={type:"pending"},this.STATUS_ERROR_NOT_ENOUGH_SPACE={type:"error",error:"notEnoughSpace"},this.STATUS_ERROR_TOO_BIG={type:"error",error:"tooBig"},this.STATUS_ERROR_DISCONNECTED={type:"error",error:"disconnected"},this.getActiveStatus=e=>this.Zj.has(e)?this.STATUS_IDLE:this.Zi.has(e)?this.Zi.get(e)||this.STATUS_IDLE:this.Zh.get(e)||this.STATUS_IDLE}disconnected(){this.Ze=null,this.Zf=null}mediaAccess(){if(this.Ze&&"disconnected"!==this.Zf&&(null==this.Zf||(0,v.z)(this.Zf)>0))return this.Ze.then(e=>"disconnected"===e?"disconnected":{access:e,timeElapsed:null});var e=(0,v.u)();return this.Zf=null,this.Ze=(function e(){return f().then(t=>t.success?t.value:"disconnected"===t.error?"disconnected":(t.error.type,(0,O.a)(t.error.backoffMs).then(()=>e())))})().then(e=>"disconnected"===e?(this.Zf="disconnected","disconnected"):(this.Zf=e.authExpires,e)),this.Ze.then(t=>"disconnected"===t?"disconnected":{access:t,timeElapsed:(0,v.v)(e)})}msgMediaStatusUpdated(e,t){(0,_.c)("event","msgMediaStatusUpdated",{msgId:e,mediaStatus:t})}clearDownload(e){this.Zh.delete(e),this.Zj.delete(e)}updateDownload(e,t){this.Zh.set(e,t),this.Zj.has(e)||this.msgMediaStatusUpdated(e,t)}updateUploadStatus(e,t,n){this.Zi.set(e,t),null==n&&this.msgMediaStatusUpdated(e,t)}isDownloading(e){return this.Zh.has(e)}clearCancellation(e){return this.Zj.delete(e)}isDownloadCancelled(e){return this.Zj.has(e)}cancelDownload(e){this.Zj.add(e),this.Zh.has(e)&&this.msgMediaStatusUpdated(e,this.STATUS_IDLE)}};M=e,(0,b.a)(e.getActiveStatus),(0,y.a)(e.getActiveStatus)}}function L(){M&&null!=M.Zf&&(M.Ze=null,M.Zf=null)}function D(e){H("cancelMedia",t=>{__LOG__(2)`cancelMedia cancelling ${e}`,t.cancelDownload(e)})}function x(e,t){return H("enqueueExtractFrame",n=>n.queue.enqueue(()=>t(e)))}function U(e,t,n){return H("enqueueDownload",r=>(r.clearCancellation(e)&&__LOG__(2)`_doDownload overpowering cancellation for ${e}`,r.isDownloading(e)?(__LOG__(3)`_shouldDownload twice for same msgId ${e}`,Promise.resolve()):r.queue.enqueueHandlers(t(r),e=>n(r,e)).finally(()=>{r.clearDownload(e)})))}function F(e,t){return H("enqueueDownload",n=>n.pendingMmsThumbDownloads.has(e)?(__LOG__(3)`enqueueThumbDownload twice for same msgId ${e}`,Promise.resolve()):(n.pendingMmsThumbDownloads.add(e),n.queue.enqueue(()=>t(n)).finally(()=>{n.pendingMmsThumbDownloads.delete(e)})))}function B(e,t,n){return H("enqueueUpload",r=>r.Zi.has(e)?(__LOG__(4)`enqueueUpload twice for same msgId ${e}`,Promise.resolve()):(r.updateUploadStatus(e,r.STATUS_PENDING,n),r.queue.enqueue(()=>t(r)).finally(()=>{r.Zi.delete(e)})))}function j(e,t,n,r){return K(t,()=>(0,S.d)(e,n,r))}function V(e,t,n,r){return K(t,()=>(0,S.b)(e,t,n,null,r)).then(()=>{})}function K(e,t){return H("enqueueFinalizeMedia",n=>n.Zg.enqueue(e.toString(),t))}function H(e,t){if(!M)throw new Error(`MediaManager::${e} called before startMedia`);return t(M)}},,function(e,t,n){n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return i}));var r=n(82),a=(0,r.d)("Disconnected",!1),i=(0,r.d)("Offline",!1,a)},,function(e,t,n){n.d(t,"a",(function(){return _})),n.d(t,"b",(function(){return E})),n.d(t,"c",(function(){return y})),n.d(t,"h",(function(){return S})),n.d(t,"i",(function(){return I})),n.d(t,"d",(function(){return w})),n.d(t,"g",(function(){return T})),n.d(t,"f",(function(){return A})),n.d(t,"e",(function(){return M}));var r=n(27),a=n.n(r),i=n(9),s=n.n(i),o=n(67),u=n(163),d=n(29),c=n(60),l=n(7),p=n(17),h=n(63),f=n(25),m=n(106),v=n(0),g={};v.d.BYTES,v.d.UINT32,v.d.UINT32,v.d.BYTES,g.internalSpec={registrationId:[5,v.d.UINT32],preKeyId:[1,v.d.UINT32],signedPreKeyId:[6,v.d.UINT32],baseKey:[2,v.d.BYTES],identityKey:[3,v.d.BYTES],message:[4,v.d.BYTES]},v.d.UINT32,v.d.BYTES,v.d.BYTES,v.d.BYTES,v.d.BYTES,v.d.UINT32,v.d.UINT32,v.d.BYTES,v.d.UINT32,v.d.UINT32,v.d.BYTES,v.d.BYTES,v.d.UINT32,v.d.BYTES;var _=new Uint8Array([6,0]),E=new Uint8Array([6,2]),b=new Uint8Array([6,1]);function y(e){return(0,o.a)(u.e,e)}function S(e,t){return I(new Map([[e,t]])).then(t=>t.get(e))}function I(e){var t=new Map;return e.forEach((e,n)=>{"primary_only"!==e.type&&"device_removed_notification"!==e.type&&t.set(n,e.adv)}),(function(e){var t=Array.from(e.keys()).map(l.e);return(0,d.x)(t).then(t=>{var n=[];return e.forEach((e,r)=>{var a=e.details,i=e.accountSignature;if(!a||!i)return __LOG__(3)`ADV Incomplete ADVSignedKeyIndexList for ${r}`,null;var s=t.get((0,l.e)(r));if(!s)return __LOG__(3)`ADV No public key for ${r}`,null;var p=f.a.build(E,a).readByteArray(),h=(0,d.P)(s,p,new Uint8Array(i)).then(e=>{if(!e)return __LOG__(3)`ADV Signature verification failed for ${r}`,null;var t=(function(e){var t=e.rawId,n=e.currentIndex,r=e.validIndexes;if(null==t||0===t)return __LOG__(3)`ADV Invalid ADVList object: missing or zero raw ID`,null;if(null==n)return __LOG__(3)`ADV Invalid ADVList object: missing current index`,null;var a=(0,m.d)(e.timestamp);return null==a||0===a?(__LOG__(3)`ADV Invalid ADVList object: missing or zero timestamp`,null):{rawId:t,timestamp:a,currentIndex:n,validIndexes:(0,c.f)(r)}})((0,o.a)(u.b,a));return t?[r,t]:null});n.push(h)}),Promise.all(n)}).then(e=>new Map(e.filter(Boolean)))})(t).then(t=>{var n=new Map;return e.forEach((e,r)=>{var a=t.get(r),i=null;"adv_list"===e.type?a&&(a.timestamp===e.stanzaTs?i={type:"adv_list",adv:a,expectedTs:e.expectedTs}:(__LOG__(3)`advVerifier timestamp in ADV KeyIndex list is different from stanza timestamp, adv_list`,SEND_LOGS("advVerifier-ts-mismatch"))):"adv_list_and_devices"===e.type?a&&(a.timestamp===e.stanzaTs?i={type:"adv_list_and_devices",adv:a,devices:e.devices,expectedTs:e.expectedTs}:(__LOG__(3)`advVerifier timestamp in ADV KeyIndex list is different from stanza timestamp, adv_list_and_devices`,SEND_LOGS("advVerifier-ts-mismatch"))):"device_added_notification"===e.type?a&&(a.timestamp===e.stanzaTs?i={type:"device_added_notification",adv:a,devicesToAdd:e.devicesToAdd}:(__LOG__(3)`advVerifier timestamp in ADV KeyIndex list is different from stanza timestamp, device_added_notification`,SEND_LOGS("advVerifier-ts-mismatch"))):"device_removed_notification"===e.type?i={type:"device_removed_notification",devicesToRemove:e.devicesToRemove,advTs:e.advTs}:(e.type,i={type:"primary_only"}),i&&n.set(r,i)}),n})}function w(e){return(0,o.a)(u.d,e)}function T(e,t,n,r){var a=t.details,i=t.accountSignature,p=t.deviceSignature,h=t.accountSignatureKey;if(!a||!i||!p)return __LOG__(3)`ADV Invalid ADVSignedDeviceIdentity proto for ${e}`,Promise.resolve(null);var v,g=M(n);if(r)v=r;else{if(!h)return __LOG__(3)`ADV Can't verify ADVSignedDeviceIdentity, no public key for primary device of ${e}`,Promise.resolve(null);v=new Uint8Array(h)}var E=f.a.build(_,a,g).readByteArray(),y=(0,d.P)(v,E,new Uint8Array(i)),S=f.a.build(b,a,g,M(v)).readByteArray(),I=(0,d.P)(n,S,new Uint8Array(p));return Promise.all([y,I]).then(t=>{var n=s()(t,2),r=n[0],i=n[1];if(!r)return __LOG__(3)`ADV account_signature invalid in device_identity for ${e}`,null;if(!i)return __LOG__(3)`ADV device_signature invalid in device_identity for ${e}`,null;__LOG__(2)`ADV signatures in ADVSignedDeviceIdentity for ${e} are valid`;var d=(0,o.a)(u.a,a),p=d.rawId,h=d.keyIndex,f=d.timestamp;if(null==p)return __LOG__(3)`ADV Invalid ADVSignedDeviceIdentity proto for ${e}, missing rawId`,null;if(null==h)return __LOG__(3)`ADV Invalid ADVSignedDeviceIdentity proto for ${e}, missing keyIndex`,null;var v=(0,m.d)(f);return null==v?(__LOG__(3)`ADV Invalid ADVSignedDeviceIdentity proto for ${e}, missing timestamp`,null):{rawId:p,timestamp:v,keyIndex:(0,c.e)(h),deviceId:(0,l.f)(e)}})}function A(e,t,n){var r=(function(e){var t=(0,o.a)(g,e.slice(1)).identityKey;return t?new Uint8Array(t):null})(t);return r?T(n,e,r).then(t=>{if(!t)return __LOG__(3)`handleMsg failed to verify received ADV object`,Promise.resolve(!1);var a=(0,l.h)(n),i=(0,l.f)(n);return(function(e,t,n,r){return O.apply(this,arguments)})(t,e.accountSignatureKey,a,i).then(e=>!!e.continueProcessingMsg&&(0,p.ob)(a,{identity:t,isPkMsg:!0}).then(()=>(0,d.K)(n,r,{rawId:t.rawId,keyIndex:t.keyIndex})).then(()=>!0))}):(__LOG__(4)`verifyCompanionPkMsg pkmsg received without identityKey`,Promise.resolve(!1))}function O(){return(O=a()((function*(e,t,n,r){var a=yield(0,h.b)(n),i=0;if(a&&a.deviceVerification&&(i=a.deviceVerification.timestamp),i<e.timestamp)return t&&(yield(0,d.L)([[n,new Uint8Array(t)]])),{continueProcessingMsg:!0};var s=!1;if(null==a?void 0:a.devices){var o=e.keyIndex;s=null==a?void 0:a.devices.some(e=>{var t=e.id,n=e.index;return t===r&&n===o})}return{continueProcessingMsg:s}}))).apply(this,arguments)}function M(e){return 33===e.length&&5===e[0]?e.slice(1):e}},,,,,,,,,function(e,t,n){function r(e){return Promise.resolve(self.crypto.subtle.digest({name:"SHA-256"},e))}n.d(t,"a",(function(){return r})),n(43)},,,,,,,,,,,function(e,t,n){n.d(t,"a",(function(){return E})),n.d(t,"b",(function(){return I})),n.d(t,"c",(function(){return w})),n.d(t,"d",(function(){return T})),n.d(t,"e",(function(){return O}));var r=n(9),a=n.n(r),i=n(27),s=n.n(i),o=n(233),u=n(124),d=n(25),c=n(43),l=n(94),p=n(10),h=n(264),f=n(341),m=n(29),v=n(82),g=n(129),_=n(120),E=16,b=E,y=65536,S={image:"WhatsApp Image Keys",audio:"WhatsApp Audio Keys",video:"WhatsApp Video Keys",doc:"WhatsApp Document Keys",history:"WhatsApp History Keys","thumbnail-document":"WhatsApp Document Thumbnail Keys","thumbnail-link":"WhatsApp Link Thumbnail Keys","thumbnail-image":"WhatsApp Image Thumbnail Keys","thumbnail-video":"WhatsApp Video Thumbnail Keys","thumbnail-gif":"WhatsApp Video Thumbnail Keys","md-app-state":"WhatsApp App State Keys"},I=(0,v.d)("HmacValidationError",!1);function w(e,t){var n=S[(0,l.a)(t)];return(0,o.a)(new Uint8Array(e),n,112).then(e=>({iv:new Uint8Array(e,0,16),cipherKey:new Uint8Array(e,16,32),hmacKey:new Uint8Array(e,48,32),refKey:new Uint8Array(e,80,32)}))}function T(e,t,n,r,a){return A.apply(this,arguments)}function A(){return(A=s()((function*(e,t,n,r,i){var s=new d.a;s.ensureCapacity(b+i.size+E+10),s.writeByteArray(t);for(var o=new h.a(s,"encrypt",e,t),u=0,c=u+y;c<i.size;){var m=i.slice(u,c),v=yield(0,p.h)(m);yield o.append(new Uint8Array(v)),u=c,c+=y}var S=yield(0,p.h)(i.slice(u));yield o.finalize(new Uint8Array(S));var I=s.peek(e=>e.readByteArray()),w=yield(0,g.b)(n),T=yield(0,g.f)(w,I);s.writeByteArray(new Uint8Array(T,0,10));var A=s.readByteArray(),O=A.subarray(b),M=yield Promise.all([(0,_.a)(O),"no-sidecar"!==r&&(0,f.b)((0,l.f)(r))&&i.size>y?(0,f.a)(w,A):void 0]),C=a()(M,2);return{ciphertext:O,ciphertextHash:C[0],sidecar:C[1]}}))).apply(this,arguments)}function O(e,t,n,r,a,i,s){return 10<=a.length&&a.length<=32?(0,m.C)("hmacSha256").then(e=>{var a=i?n.slice(0,n.byteLength-i):n;if(e)return(0,m.B)(r,[t,a]);var s=d.a.build(t,a).readByteArray();return(0,g.d)(r,s).then(e=>new Uint8Array(e))}).then(e=>{var t=e.slice(0,a.length);if(!(0,u.c)(t,a))throw new I("hmacAndDecrypt hmac mismatch")}).then(()=>(0,h.b)(e,t,n)).then(e=>{var t=s?e.slice(0,e.byteLength-s):e;return(0,_.a)(t).then(e=>({plaintext:t,plaintextHash:(0,c.e)(new Uint8Array(e))}))}):Promise.reject(new I("Bad hmac size "+a.length))}},,,function(e,t,n){function r(e){return"###"}n.d(t,"a",(function(){return r}))},,function(e,t,n){n.d(t,"a",(function(){return I})),n.d(t,"b",(function(){return w})),n.d(t,"c",(function(){return M})),n.d(t,"d",(function(){return C}));var r=n(27),a=n.n(r),i=n(101),s=n(29),o=n(7),u=n(168),d=n(288),c=n(21),l=n(150),p=(n(28),n(4)),h=(n(17),n(111),n(88));n(11),new h.b("userKeys",e=>{var t=new Map;return e.child("list").forEachChild(e=>{var n=(0,l.parseUserKeysNode)(e),r=n.sessionInfo.jid;t.set(r,n)}),t});var f=n(24),m=n(75),v=n(301),g=n(62),_=n(36),E=n(400),b=n(199);function y(e){return S.apply(this,arguments)}function S(){return(S=a()((function*(e){for(var t=new Set,n=new Set,r=(0,_.j)()?50:100,a=(0,E.a)(e,r),i=0;i<a.length;i++){var s=a[i];yield Promise.all(s.map(e=>(0,l.ensureE2eSession)(e).then(()=>{t.add((0,o.h)(e)),n.add(e)}).catch(()=>{})))}return{userJids:t,deviceJids:n}}))).apply(this,arguments)}function I(e,t,n,r,a){return y(e).then(e=>{var i=e.userJids,s=e.deviceJids;return((0,f.k)(t)?(0,d.c)(Array.from(i),t,n):(0,u.f)(Array.from(i),t,n,r)).then(e=>{var n=new Map;return e.forEach(e=>{n.set(e.userJid,e.msg)}),T(n,(0,c.c)(s),(0,b.a)(t),a)})})}function w(e,t,n){return y(e).then(e=>{var r=e.userJids,a=e.deviceJids;return(0,u.c)(Array.from(r),t).then(e=>{var t=new Map;return e.forEach(e=>{t.set(e.userJid,e.msg)}),T(t,(0,c.c)(a),void 0,n)})})}function T(e,t,n,r){return A.apply(this,arguments)}function A(){return(A=a()((function*(e,t,n,r){var a=yield Promise.all(t.map(t=>{var n=e.get((0,o.h)(t));if(null!=n){var a,i="primary"===(null==r?void 0:r.type)?r.ids.get((0,o.e)((0,o.h)(t))):null==r||null==(a=r.ids)?void 0:a.get(t),s=null!=i&&r?{id:i,type:null==r?void 0:r.type}:void 0;return O(t,C(n),s)}}).filter(Boolean)),i=new Map,s=[];return a.forEach(e=>{if(e){var t=e.jid,r=e.type,a=e.ciphertext;if(!a||!r)return;s.push((0,p.v)("to",{jid:(0,p.g)(t)},M(r,a,n))),null!=e.identityId&&i.set(t,e.identityId)}}),{nodes:s,identityIds:i}}))).apply(this,arguments)}function O(e,t,n){return null!=(null==n?void 0:n.id)?(0,s.p)(e,t,n.id,"primary"===n.type).then(t=>{if((null==t?void 0:t.ciphertext)&&t.type)return Object.assign({},t,{jid:e})}):(0,s.o)(e,t).then(t=>Object.assign({},t,{jid:e}))}function M(e,t,n){return(0,p.v)("enc",{v:(0,p.b)("2"),type:e,mediatype:n||m.a},t)}function C(e){var t=(0,i.a)(g.g,e);return(0,v.b)(t),t.readByteArray()}},function(e,t,n){n.d(t,"c",(function(){return o})),n.d(t,"d",(function(){return u})),n.d(t,"f",(function(){return d})),n.d(t,"e",(function(){return c})),n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return p})),n(193);var r=n(78),a=n(44),i=(n(67),16777215);function s(e,t){return{publicKey:e,privateKey:t}}function o(){var e=a.a.keyPair(),t=e.publicKey,n=e.secretKey;return n[0]&=248,n[31]=64|63&n[31],s((0,r.d)(t,32),(0,r.d)(n,32))}function u(e,t){return s((0,r.f)(t,1,32),e)}function d(e){var t=(0,r.e)(33);return t[0]=5,t.set(e.publicKey,1),t}function c(e){var t=(0,r.e)(33);return t[0]=5,t.set((0,r.d)(e,32),1),t}function l(e){return(0,r.c)(e,1,i)}function p(e){if(0===e.length||5!==e[0])throw new Error("Unrecognized public key type");return(0,r.d)(e,33)}},,function(e,t,n){n.d(t,"a",(function(){return a}));var r=n(0),a={};a.internalSpec={remoteJid:[1,r.d.STRING],fromMe:[2,r.d.BOOL],id:[3,r.d.STRING],participant:[4,r.d.STRING]}},,,,,function(e,t,n){n.d(t,"e",(function(){return d})),n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return p})),n.d(t,"d",(function(){return h})),n.d(t,"f",(function(){return f})),n.d(t,"c",(function(){return v}));var r=n(87),a=n(2),i=n(10),s=n(3),o=n(6),u=n(141);function d(e,t){var n=e.chatId;if(n&&o.M.get())return(0,u.b)(e)&&!(0,u.c)(t)?{type:a.f.IDENTITY_CHANGE,author:a.c,subtype:"unavailable",externalId:"keychange/unavailable/"+n,ts:(0,s.E)(),ack:a.a.RECEIVED,altIndex:""}:void 0}function c(e,t){if(e.chatId){var n=e.chatId,r=l(e.verifiedInfo,t);return null!=r?{externalId:"/privacy/"+n,ts:(0,s.E)(),author:a.c,ack:a.a.RECEIVED,type:a.f.PRIVACY_CHANGE,subtype:r,altIndex:""}:void 0}}function l(e,t){var n=e&&e.bsp&&e.bsp.host===r.b.FB,a=e&&e.bsp&&e.bsp.actors===r.a.BSP,i=t&&t.bsp&&t.bsp.actors===r.a.BSP,s=t&&t.bsp&&t.bsp.host===r.b.FB,o=null;return i||s?s?n||(o="now_fb"):i&&(a&&!n||(o="now_bsp")):!a&&!n||(o="now_e2ee"),o}function p(e){if(e.chatId){var t=e.chatId,n=e.verifiedInfo,i=n&&n.bsp&&n.bsp.host===r.b.FB;return n&&n.bsp&&n.bsp.actors===r.a.BSP||i?{externalId:"/privacy/"+t,ts:(0,s.E)(),author:a.c,ack:a.a.RECEIVED,type:a.f.PRIVACY_CHANGE,subtype:"now_e2ee",altIndex:""}:void 0}}function h(e,t,n,r){var a,i,s;return!e||null==e.verifiedInfo||e.verifiedInfo.level!==n||e.verifiedInfo.serial!==t||(null==(a=e.verifiedInfo.bsp)?void 0:a.ts)!==(null==r?void 0:r.ts)||(null==(i=e.verifiedInfo.bsp)?void 0:i.actors)!==(null==r?void 0:r.actors)||(null==(s=e.verifiedInfo.bsp)?void 0:s.host)!==(null==r?void 0:r.host)}function f(e,t,n){var r=e.verifiedInfo,a=n.msg;return t?r?Object.assign({},n,{msg:(0,i.j)(a,{bizInfo:{bsp:r.bsp}})}):n:null!=l(r,a.bizInfo)?Object.assign({},n,{msg:(0,i.j)(a,{bizConflict:!0})}):n}var m={validateBusinessCertificate:!1};function v(e,t){if("NO_BIZ"===t)return e?(__LOG__(3)`hasMsgConflict: unexpected empty receipt`,{validateBusinessCertificate:!0}):m;var n="NO_BSP"===t?{bsp:void 0}:{bsp:t};return null!=l(e,n)?(__LOG__(3)`hasMsgConflict: conflict with receipt`,{bizConflict:!0,validateBusinessCertificate:!0,msgBizInfo:n}):m}},,,,,,function(e,t,n){n.r(t),n.d(t,"IMPLICIT_LEAD_BYTE",(function(){return g})),n.d(t,"parseUserKeysNode",(function(){return _})),n.d(t,"ensureE2eSession",(function(){return b})),n.d(t,"handleE2eIdentityChange",(function(){return S})),n.d(t,"establishE2eSession",(function(){return I})),n.d(t,"fetchMissingKeysForContact",(function(){return A})),n.d(t,"prependByte",(function(){return O}));var r=n(27),a=n.n(r),i=n(28),s=n(29),o=n(71),u=n(88),d=n(4),c=n(17),l=n(63),p=n(7),h=n(75),f=n(60),m=n(111),v=new o.b,g=5;function _(e){var t=e.child("skey"),n=e.hasChild("key")?e.child("key"):null,r=e.attrPhoneDeviceJid("jid"),a=e.child("identity").contentBytes(32),i={jid:r,identity:a,info:{regId:e.child("registration").contentUint(4),identity:O(g,a),signedKey:{id:t.child("id").contentUint(3),publicKey:O(g,t.child("value").contentBytes(32)),signature:t.child("signature").contentBytes(64)},oneTimeKey:n&&{id:n.child("id").contentUint(3),publicKey:O(g,n.child("value").contentBytes(32))}}};return(0,p.r)(r)?{type:"primary",sessionInfo:i}:{type:"companion",sessionInfo:i,signedDeviceIdentity:(0,m.d)(e.child("device-identity").contentBytes())}}var E=new u.b("userKeys",e=>e.child("list").mapChildren(_));function b(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];__LOG__(2)`ensureE2eSession ${e}`;var n=v.waitIfPending(e);if(n)return __LOG__(2)`ensureE2eSession deduped ${e}`,n;var r=(0,s.A)(e).then(n=>{if(!n)return(0,p.r)(e)?I(e,t):w(e)});return v.enqueueHandlers(e,r)}var y=new u.b("identityChange",e=>(e.assertTag("notification"),e.assertAttr("type","encrypt"),e.child("identity"),{jid:e.attrPhoneDeviceJid("from"),stanzaId:e.attrString("id")})),S=(0,u.c)("handleE2eIdentityChange",y,e=>{var t=e.jid,n=e.stanzaId;return v.enqueue(t,()=>(0,s.A)(t).then(e=>{if(e)return __LOG__(2)`handleE2eIdentityChange ${t} updated, establishing session`,(0,s.k)(t).then(()=>I(t,!0))}).then(()=>(0,d.v)("ack",{to:(0,d.g)(t),id:(0,d.b)(n),class:"notification"})))});function I(e,t){if(!(0,p.r)(e))throw new Error("establishE2eSession called for companion device "+e);var n=(0,d.v)("iq",{id:(0,d.t)(),xmlns:"encrypt",type:"get",to:d.k},(0,d.v)("key",null,(0,d.v)("user",{jid:(0,d.g)(e),reason:t?"identity":d.d})));return(0,i.e)(n,E).then(t=>{if(!t.success)throw new Error("establishE2eSession bad response "+String(t));var n=t.result;if(n.length<=0)throw new Error("No key for "+e);var r=n[0];if(r.sessionInfo.jid!==e)throw new Error("Mismatch jid");return(0,s.f)(r.sessionInfo)})}function w(e){return T.apply(this,arguments)}function T(){return(T=a()((function*(e){if((0,p.r)(e))throw new Error("establishE2eSessionForCompanionDevice called for primary device "+e);var t=(0,p.h)(e),n=(0,p.e)(t),r=yield(0,s.w)(n),a=r?null:(0,d.v)("user",{jid:(0,d.g)(n)}),o=(0,d.v)("iq",{id:(0,d.t)(),xmlns:"encrypt",type:"get",to:d.k},(0,d.v)("key",null,a,(0,d.v)("user",{jid:(0,d.g)(e)}))),u=yield(0,i.e)(o,E);if(!u.success)throw new Error("establishE2eSessionForCompanionDevice bad response "+String(u));var l=new Map;u.result.forEach(e=>{l.set(e.sessionInfo.jid,e)});var h=r;if(!h){var f=l.get(n);if(!f)throw new Error("establishE2eSessionForCompanionDevice bad response, no keys for primary device "+String(u));yield(0,s.f)(f.sessionInfo),h=f.sessionInfo.identity}var v=l.get(e);if(!v)throw new Error("establishE2eSessionForCompanionDevice bad response, no keys for companion device "+String(u));if("companion"!==v.type)throw new Error("establishE2eSessionForCompanionDevice bad response, companionKeyInfo type is not companion");var g=v.sessionInfo,_=v.signedDeviceIdentity,b=yield(0,m.g)(e,_,g.identity,h);if(!b)throw new Error("establishE2eSessionForCompanionDevice failed to verify received ADV object");yield(0,c.ob)(t,{identity:b,isPkMsg:!1}),yield(0,s.g)(g,{rawId:b.rawId,keyIndex:b.keyIndex})}))).apply(this,arguments)}var A=(0,h.c)().finalStep("fetchMissingKeysForContact",e=>{var t=e.jid;return(0,l.b)(t).then(e=>{if(e)return Promise.all((0,f.c)(e).map(e=>b(e,!0)))}).then(()=>{})}).end();function O(e,t){var n=new Uint8Array(1+t.length);return n[0]=e,n.set(t,1),n}},,function(e,t,n){n.d(t,"a",(function(){return v})),n.d(t,"b",(function(){return g})),n.d(t,"d",(function(){return _})),n.d(t,"c",(function(){return b}));var r=n(9),a=n.n(r),i=n(128),s=n(6),o=n(12),u=n(203),d=navigator.externalapi,c=8081,l=null==d?void 0:d.port;"number"==typeof l&&(c=l),d&&8081===c&&(d.getToken=()=>Promise.resolve("secrettoken"));var p=null,h=new Map,f=new Map;function m(e){var t=e.onConnect,n=e.onDisconnect,r=new lib_session.Session;(function(e){e.close||(e.close=function(){this.lazy_reconnect=!1;var e=this.transport.socket;e&&e.close()})})(r);var a={onsessionconnected(){t(r)},onsessiondisconnected(){n()}};return r.open("websocket","localhost:"+c,"secrettoken",a,!0),r}function v(e,t){var n=t.onConnect,r=t.onDisconnect;__LOG__(2)`connectToDaemon called for ${e}`;var i=f.get(e);if(i)return __LOG__(4)`connectToDaemon called twice for ${e}`,i;var d=(function(e){var t;switch(e){case"tcp":t=h.get("tcpsocket");break;case"signal":t=h.get("libsignal");break;case"settings":t=h.get("settings");break;case"contacts":t=h.get("contacts");break;default:t=h.get("telephony")}return t||(function(e){__LOG__(2)`loadKaiosApi: called for daemon ${e}`;var t=["core","session"],n=[];function r(){return E([...t,...n])}if("settings"===e?n.push("settings"):"contacts"===e?n.push("contacts"):(n.push("libsignal"),n.push("tcpsocket")),c>=1024)return __LOG__(2)`loadKaiosApi:VoIP is disabled, daemon port=${c}`,s.n.set(!1),r();var i="voip"===e||"telephony"===e;return i||__LOG__(2)`loadKaiosApi: will skip loading of VoIP scripts`,s.n.get()?(i&&(__LOG__(2)`loadKaiosApi: VoIP service previously detected as available`,n.push("wavoip2","telephony")),r()):E(t).then(()=>new Promise(e=>{m({onConnect(t){__LOG__(2)`loadKaiosApi: daemon session opened to test VoIP service availability`,null==t.has_service?(__LOG__(2)`loadKaiosApi: VoIP service is unavailable`,t.close(),e(n)):Promise.all([t.has_service("wavoip2"),null!=t.has_service&&t.has_service("telephony")]).then(r=>{var d=a()(r,2),c=d[0],l=d[1],p=c&&l;if(p)__LOG__(2)`loadKaiosApi: VoIP and telephony services are available`,i&&n.push("wavoip2","telephony");else{var h=[c?null:"VoIP",l?null:"Telephony"].filter(Boolean);__LOG__(2)`loadKaiosApi: cannot handle VoIP. ${h} missing`}(function(e){e!==s.n.get()&&(s.n.set(e),(0,o.c)("event","voipStatusChanged",{hasVoip:e,voipCallEnabled:(0,u.a)(s.E.get())}))})(p),t.close(),e(n)})},onDisconnect(){__LOG__(2)`loadKaiosApi: daemon session closed`}})})).then(E)})(e)})(e).then(()=>m({onConnect(t){__LOG__(2)`connectToDaemon connect for ${e}`,n(t)},onDisconnect(){__LOG__(3)`connectToDaemon disconnected for ${e}`,r()}}));return f.set(e,d),d}function g(){f.forEach(e=>{e.then(e=>{e.close()})}),f.clear()}function _(){var e="voip",t=f.get(e);return t?(f.delete(e),t):(__LOG__(3)`surrenderDaemonSessionOwnership could not find session for ${e}`,null)}function E(e){var t=(0,i.a)({algo:{type:"fibonacci",first:500,second:1e3},max:5e3});p||(p=t());var n=[];return e.reduce((e,r)=>{var a=h.get(r);if(a)return a;var i=()=>{var e=Date.now(),a=(function(e){var t="http://127.0.0.1:"+c;return"core"===e||"session"===e?`${t}/api/v1/shared/${e}.js`:`${t}/api/v1/${e}/service.js`})(r);return __LOG__(2)`loadScripts load ${a}`,("function"==typeof importScripts?(function(e){return Promise.resolve().then(()=>{self.importScripts(e)})})(a):(function(e){return new Promise((function(t,n){var r,a=document.getElementsByTagName("head")[0],i=document.createElement("script");function s(a){i.onerror=i.onload=null,clearTimeout(r),"load"===a.type?t():"timeout"===a.type?n(new Error("Timeout while loading script "+e)):n(a)}i.charset="utf-8",i.src=e,r=setTimeout((function(){s({type:"timeout",target:i})}),12e4),i.onerror=i.onload=s,a.appendChild(i)}))})(a)).then(()=>{n.push(`${r} ${Date.now()-e}ms`)}).catch(e=>(__LOG__(4)`loadScripts failed on ${a}: ${e}`,t().then(i)))};return a=e.then(i),h.set(r,a),a},p).then(()=>{__LOG__(2)`loadScripts load finished, timings: ${n.join(", ")}`})}function b(e,t,n,r,a){return e().then(r).catch(i=>{if(i&&"session_closed"===i.reason){var s=a<0?1:a+1;return s<=10?(__LOG__(2)`voip::runLibWithRetries retrying ${n}`,b(e,t,n,r,s)):Promise.reject(`runLibWithRetries ${t}::${n} maximum number of retries on session_closed exceeded`)}return Promise.reject(i)})}},,function(e,t,n){n.d(t,"b",(function(){return y})),n.d(t,"c",(function(){return I})),n.d(t,"a",(function(){return A})),n.d(t,"h",(function(){return C})),n.d(t,"e",(function(){return P})),n.d(t,"f",(function(){return L})),n.d(t,"g",(function(){return x})),n.d(t,"d",(function(){return V}));var r=n(62),a=n(106),i=n(49),s=n(7),o=n(2),u=n(33),d=n(34),c=n(6),l=n(43),p=n(3),h=n(21),f=n(10),m=n(238),v=n(20),g=n(14),_=n(23),E=n(214),b=n(302);function y(e,t,n,r){var a=null;if(e.mediaKey&&e.fileEncSha256){var i={version:"mms4",type:t,cryptoKey:e.mediaKey,ciphertextHash:e.fileEncSha256,size:n,creationTs:(0,p.E)(),mediaKeyTs:null!=e.mediaKeyTimestamp?(0,p.i)(e.mediaKeyTimestamp):r,validatedTs:r};e.directPath&&(i.directPath=e.directPath),e.url&&(i.url=e.url),a=i}else e.url&&e.mediaKey&&!e.fileEncSha256?(a={version:"mms3",type:t,cryptoKey:e.mediaKey,url:e.url,size:n,creationTs:(0,p.E)()},/^https:\/\/(\w|-)+\.whatsapp\.net\//.test(a.url)||(__LOG__(4)`makeMedia msg has bad mms3 url ${a.url}`,a=null)):__LOG__(4)`makeMedia msg does not have enough entry info`;return a&&e.viewOnce&&(a.isViewOnce=e.viewOnce),a&&e.streamingSidecar&&(a.sidecar=e.streamingSidecar),a}function S(e){var t={externalId:e.externalId,ts:e.ts,author:(0,s.h)(e.author),deviceId:(0,s.f)(e.author),ack:o.a.RECEIVED,urlNumber:e.urlNumber,urlText:e.urlText,altIndex:""};return e.bspInfo&&(t.bizInfo={bsp:e.bspInfo}),null!=e.expiration&&(t.expiration=e.expiration),e.broadcastJid&&(t.broadcastJid=e.broadcastJid),t}function I(e,t){return null!=t.forwardingScore?Object.assign({},e,{forwardingScore:t.forwardingScore}):t.isForwarded?Object.assign({},e,{forwardingScore:1}):e}function w(e){return null==e?null:e===r.a.INITIATED_BY_ME?r.a.INITIATED_BY_OTHER:e===r.a.INITIATED_BY_OTHER?r.a.INITIATED_BY_ME:e}function T(e){return e.verifiedLevel?{level:e.verifiedLevel,serial:e.verifiedNameSerial||-1,cert:e.verifiedNameCert,bsp:e.bspInfo}:null}function A(e){var t=T(e),n=S({externalId:e.externalId,ts:e.ts,author:e.author,broadcastJid:e.broadcastJid,verifiedLevel:e.verifiedLevel,verifiedNameSerial:e.verifiedNameSerial,bspInfo:e.bspInfo}),r=e.hydratedTemplate;if(null!=r.hydratedContentText){var a=r.imageMessage||r.videoMessage||r.locationMessage||r.documentMessage?{imageMessage:r.imageMessage,videoMessage:r.videoMessage,locationMessage:r.locationMessage,documentMessage:r.documentMessage}:null,i=a?C(Object.assign({},e,{proto:a,expiration:null,urlNumber:!1,urlText:!1,edit:-1,bytes:new Uint8Array(0)})):null,s={msg:Object.assign({},n,{type:o.f.RICH_HSM,title:r.hydratedTitleText,content:r.hydratedContentText,footer:r.hydratedFooterText,hsmTemplateId:r.templateId,media:null}),media:null,contactVerification:t,pushname:e.pushname,isHsm:e.isHsm};if(s.msg.type===o.f.RICH_HSM){if(i){var u=i.msg,d=i.media;switch(s.media=d,u.type){case o.f.IMAGE:s.msg.richContent={type:o.f.IMAGE,size:u.size,text:u.text,width:u.width,height:u.height,bg:u.bg};break;case o.f.VIDEO:s.msg.richContent={type:o.f.VIDEO,size:u.size,duration:u.duration,width:u.width,height:u.height,mimetype:u.mimetype,text:u.text,rotation:u.rotation,frame:u.frame,bg:u.bg};break;case o.f.LOCATION:s.msg.richContent={type:o.f.LOCATION,degreesLatitude:u.degreesLatitude,degreesLongitude:u.degreesLongitude,name:u.name,address:u.address,url:u.url,bg:u.bg};break;case o.f.DOCUMENT:if("application/pdf"!==u.mimetype)return null;s.msg.richContent={type:o.f.DOCUMENT,bg:u.bg,mimetype:u.mimetype,fileName:u.fileName,size:u.size,pages:u.pages};break;default:return __LOG__(4)`protoMsgToDbMsg returned unexpected message type ${u.type}`,null}}if(r.hydratedButtons){var c=r.hydratedButtons;if(c.length>3)return null;for(var l=[],p=0;p<c.length;p++){var h=c[p];if(h.urlButton){var f=h.urlButton;l.push({type:o.d.URL,displayText:f.displayText,url:f.url})}else if(h.callButton){var m=h.callButton;l.push({type:o.d.CALL,displayText:m.displayText,phoneNumber:m.phoneNumber})}else{if(!h.quickReplyButton)return __LOG__(4)`HSM message with unknown button type`,null;var v=h.quickReplyButton;if(null==v.displayText)return __LOG__(4)`HSM message with quick reply button withuot a value to display`,null;l.push({type:o.d.QUICK_REPLY,displayText:v.displayText,payload:v.id})}}s.msg.buttons=l}return s}__LOG__(4)`Message type has magically changed to ${s.msg.type}`}}function O(e,t){var n=t;if(null!=e&&null!=n){for(var r=[],a=0;a<e.length;a++){var i=(0,s.o)(e[a]);"phoneUser"===i.jidType&&n.includes("@"+(0,s.u)(i.userJid))&&r.push(i.userJid)}return r.length?(0,h.m)(r):void 0}}function M(e){if(e&&e.byteLength<=192&&e.byteLength>=64)return e}function C(e){var t=e.proto,n=(0,E.b)(t);if(!n)return null;var a,l,h=S({externalId:e.externalId,ts:e.ts,author:e.author,urlNumber:e.urlNumber,urlText:e.urlText,expiration:e.expiration,broadcastJid:e.broadcastJid,verifiedLevel:e.verifiedLevel,verifiedNameSerial:e.verifiedNameSerial,bspInfo:e.bspInfo});switch(h=(function(e,t){var n=(0,E.a)(e);return n?I((function(e,t){return null==t.placeholderKey?e:(0,f.j)(e,{placeholderId:t.placeholderKey.id})})((function(e,t){if(null!=e.expiration)return e;if(null!=t.expiration&&null!=t.ephemeralSettingTimestamp){var n=Object.assign({},e,{expiration:t.expiration,ephemeralSettingTimestamp:(0,p.i)(t.ephemeralSettingTimestamp)});if((0,_.a)("disappearing_mode")){var r,a=null==t||null==(r=t.disappearingMode)?void 0:r.initiator;null!=a&&(n.disappearingModeInitiator=w(a))}return n}return e})(t,n),n),n):t})(n,h),n.type){case"conversation":a=Object.assign({type:o.f.TEXT,text:n.value},h);break;case"extendedTextMessage":var m=(function(e,t){var n=P(e,(0,i.i)(t.author));if(n){var r=n.content,a=n.mentionedJids,s=n.preview;return{msg:Object.assign({type:o.f.TEXT},r,t,{mentionedJids:a}),media:s?{preview:s}:void 0}}})(n.value,h);m&&(a=m.msg,l=m.media);break;case"stickerMessage":var v=(function(e,t){var n,r,a=G(e,t.ts);if(a){var i=Object.assign({},a.content,t,{media:void 0}),s={entry:a.media.mediaEntry,plaintextHash:a.media.plaintextHash,preview:a.preview||null};return null==(null==(n=a.media.stickerInfo)?void 0:n.firstFrameLength)&&null==(null==(r=a.media.stickerInfo)?void 0:r.firstFrameSidecar)||(s.stickerInfo={firstFrameLength:a.media.stickerInfo.firstFrameLength,firstFrameSidecar:a.media.stickerInfo.firstFrameSidecar}),{msg:i,media:s}}})(n.value,h);v&&(a=v.msg,l=v.media);break;case"imageMessage":var g=(function(e,t){var n=L(e,t.ts,y);if(n){var r=Object.assign({},n.content,t,{mentionedJids:n.mentionedJids,media:void 0});return!0===e.viewOnce&&(r.viewOnceState="active"),{msg:r,media:{entry:n.media.mediaEntry,plaintextHash:n.media.plaintextHash,preview:n.preview||null}}}})(n.value,h);g&&(a=g.msg,l=g.media);break;case"audioMessage":var A=n.value;if(A.ptt){var O=(function(e,t){var n=D(e,t.ts,u.c.PTT);if(n)return{msg:Object.assign({type:o.f.PTT},n.content,t,{media:void 0,waveform:M(e.waveform)}),media:{entry:n.media.mediaEntry,plaintextHash:n.media.plaintextHash,preview:n.preview||null}}})(A,h);O&&(a=O.msg,l=O.media)}else{var C=(function(e,t){var n=D(e,t.ts,u.c.AUDIO);if(n)return{msg:Object.assign({type:o.f.AUDIO},n.content,t,{media:void 0}),media:{entry:n.media.mediaEntry,plaintextHash:n.media.plaintextHash,preview:n.preview||null}}})(A,h);C&&(a=C.msg,l=C.media)}break;case"videoMessage":var N=n.value;if(N.gifPlayback){var k=(function(e,t){var n=x(e,t.ts,u.c.GIF,y);if(n){var a=Object.assign({type:o.f.GIF},n.content,t,{mentionedJids:n.mentionedJids,media:void 0});return null!=e.gifAttribution&&e.gifAttribution!==r.d.NONE&&(a.gifAttribution=e.gifAttribution),{msg:a,media:{entry:n.media.mediaEntry,plaintextHash:n.media.plaintextHash,preview:n.preview||null}}}})(N,h);k&&(a=k.msg,l=k.media)}else{var H=(function(e,t){var n=x(e,t.ts,u.c.GIF,y);if(n){var r=Object.assign({type:o.f.VIDEO},n.content,t,{mentionedJids:n.mentionedJids,media:void 0});return!0===e.viewOnce&&(r.viewOnceState="active"),{msg:r,media:{entry:n.media.mediaEntry,plaintextHash:n.media.plaintextHash,preview:n.preview||null}}}})(N,h);H&&(a=H.msg,l=H.media)}break;case"protocolMessage":var $=(0,s.h)(e.author);switch(n.value.type){case r.c.REVOKE:var q=n.value.key,z=e.jid;e.edit===u.a&&q&&q.fromMe&&(q.remoteJid===c.r.get()?$===z:q.remoteJid===z||q.remoteJid===e.broadcastJid)?a={type:o.f.REVOKED,ts:e.ts,externalId:q.id,revokedExternalId:q.id,chatJid:z,author:$,deviceId:(0,s.f)(e.author),ack:o.a.RECEIVED,altIndex:""}:__LOG__(4)`recv'd invalid revoke key ${q} for ${e.jid}/${$}`;break;case r.c.EPHEMERAL_SETTING:a={type:o.f.EPHEMERAL,subtype:"setting",ts:e.ts,externalId:e.externalId,author:$,deviceId:(0,s.f)(e.author),ack:o.a.RECEIVED,altIndex:"",ephemeralExpiration:n.value.ephemeralExpiration};break;case r.c.EPHEMERAL_SYNC_RESPONSE:var J;a={type:o.f.EPHEMERAL,subtype:"sync_response",ts:e.ts,externalId:e.externalId,author:$,deviceId:(0,s.f)(e.author),ack:o.a.RECEIVED,altIndex:"",ephemeralExpiration:n.value.ephemeralExpiration,ephemeralSettingTimestamp:n.value.ephemeralSettingTimestamp},(0,_.a)("disappearing_mode")&&(a.ephemeralInitiator=w(null==(J=n.value.disappearingMode)?void 0:J.initiator));break;case r.c.APP_STATE_SYNC_KEY_REQUEST:break;default:__LOG__(4)`received protocol message with unknown type ${n.value.type}`}break;case"contactMessage":a=U(h,[n.value],n.value.contextInfo);break;case"contactsArrayMessage":a=U(h,n.value.contacts,n.value.contextInfo);break;case"locationMessage":var Y=(function(e,t){var n=B(e);if(n){var r=n.content,a=n.preview;return{msg:Object.assign({},r,t,{media:void 0}),media:a?{preview:a}:void 0}}})(n.value,h);Y&&(a=Y.msg,l=Y.media);break;case"fastRatchetKeySenderKeyDistributionMessage":break;case"chat":__LOG__(4)`protoMsgToDbMsg should never handle msg of type ${n.type}`;break;case"groupInviteMessage":var W=(function(e,t){var n=j(e);if(n){var r=n.content,a=n.preview;return{msg:Object.assign({},r,t,{media:void 0}),media:a?{preview:a}:void 0}}})(n.value,h);W&&(a=W.msg,l=W.media);break;case"highlyStructuredMessage":return null;case"documentMessage":var Z=V(n.value,h);Z&&(a=Z.msg,l=Z.media);break;default:n.type,a=(function(e,t,n){var r=t.type;if("pollCreationMessage"!==r&&"pollUpdateMessage"!==r||(0,s.p)(e.jid)){var a=b.a[t.type]||null;return Object.assign({type:o.f.FUTUREPROOF,protobuf:(0,d.b)(e.bytes),subtype:a,altIndex:"futureproof-"+(a||"unknown")},n)}})(e,n,h)}var Q=null;if(a&&n&&"conversation"!==n.type&&n.value&&n.value.contextInfo){var X=a,ee=n.value.contextInfo,te="string"==typeof ee.remoteJid?ee.remoteJid:null,ne=te?(0,s.o)(te):null;if(ee.quotedMessage){var re;ne&&("status"===ne.jidType?re=ne.statusJid:"group"===ne.jidType?re=ne.groupJid:(__LOG__(4)`ContextInfo has a remoteJid ${ee.remoteJid} but neither a status jid nor a group jid.`,SEND_LOGS("contextinfo-with-invalid-quoted-remoteJid")));var ae=(function(e,t,n,r){var a=e,d=n.stanzaId,c=n.quotedMessage,l=(0,s.p)(a),p=(0,s.o)(l?n.participant||"":n.participant||a),h="phoneUser"===p.jidType?p.userJid:null;if(!d||!c||!h)return null;var f,m,v,g=(0,E.b)(c);if(!g)return null;function _(e,t){e&&(f=t(e.content,(function(e){if(e.media)return{plaintextHash:e.media.plaintextHash,mediaEntry:e.media.mediaEntry}})(e)),m=e.preview,v=e.mentionedJids)}switch(g.type){case"conversation":f={type:o.f.TEXT,text:g.value};break;case"extendedTextMessage":_(P(g.value,h),R);break;case"stickerMessage":_(G(g.value,t),(e,t)=>Object.assign({},e,{media:t}));break;case"imageMessage":var b=g.value;_(L(b,t,y),(e,t)=>b.viewOnce?Object.assign({},e,{media:t,viewOnceState:"active"}):Object.assign({},e,{media:t}));break;case"audioMessage":var S=g.value;S.ptt?_(D(S,t,u.c.PTT),(e,t)=>Object.assign({},e,{type:o.f.PTT,media:t})):_(D(S,t,u.c.AUDIO),(e,t)=>Object.assign({},e,{type:o.f.AUDIO,media:t}));break;case"videoMessage":var I=g.value;I.gifPlayback?_(x(I,t,u.c.GIF,y),(e,t)=>Object.assign({},e,{type:o.f.GIF,media:t})):_(x(I,t,u.c.VIDEO,y),(e,t)=>I.viewOnce?Object.assign({},e,{type:o.f.VIDEO,media:t,viewOnceState:"active"}):Object.assign({},e,{type:o.f.VIDEO,media:t}));break;case"contactMessage":_(F([g.value]),R);break;case"contactsArrayMessage":_(F(g.value.contacts),R);break;case"locationMessage":_(B(g.value),R);break;case"groupInviteMessage":_(j(g.value),R);break;case"documentMessage":_(K(g.value,t),(e,t)=>(e.isVCard,Object.assign({},e,{media:t})))}if(!f)return null;var w=f;return{msg:{externalId:d,remoteJid:r,author:(0,i.k)(h),content:w,mentionedJids:v,id:void 0,ts:void 0},quotedMediaPreview:m}})(e.jid,h.ts,ee,re);ae&&(X.quoted=ae.msg,Q={quotedMediaPreview:ae.quotedMediaPreview})}else ne&&("group"===ne.jidType?X.remoteJid=ne.groupJid:(__LOG__(4)`ContextInfo has a remoteJid ${ee.remoteJid} but not a group jid.`,SEND_LOGS("contextinfo-with-invalid-remoteJid")))}var ie=T(e);if(a){var se=(0,E.a)(n);return{msg:a,media:l,contactVerification:ie,quotedData:Q,pushname:e.pushname,ephSetting:e.ephSetting,ephemeralSharedSecret:null==se?void 0:se.ephemeralSharedSecret}}return null}function R(e){return e}function N(e){var t=e.fileSha256;if(t){var n=e.fileLength;if(n){try{n=(0,a.e)(n)}catch(e){return void __LOG__(4)`protobuf msg with too large size ${n}`}return{size:n,plaintextHash:(0,l.e)(new Uint8Array(t))}}__LOG__(4)`protobuf msg with bad size ${n}`}else __LOG__(4)`protobuf msg with no plaintext hash`}function k(e){return e.jpegThumbnail}function P(e,t){var n;if(e.text){var r,a=e.title,i=e.description,s=e.matchedText,u=e.canonicalUrl;(a||i)&&s&&e.text.includes(s)&&(r={matchedText:s,canonicalUrl:u,description:i,title:a,suspiciousCharacters:null!=t?(0,m.a)(s,t,c.r.get(),[(0,v.d)().lg]):null});var d={type:o.f.TEXT,text:e.text,linkPreview:r},l=O(null==(n=e.contextInfo)?void 0:n.mentionedJid,e.text);return{content:d,preview:k(e),mentionedJids:l}}}function G(e,t){var n=N(e);if(n){var r=n.size,a=n.plaintextHash,i=y(e,u.c.STICKER,r,t);if(i){var s={type:o.f.STICKER,size:r};null!=e.isAnimated&&(s.isAnimated=e.isAnimated),null!=e.width&&e.width>0&&(s.width=e.width),null!=e.height&&e.height>0&&(s.height=e.height),null!=e.mimetype&&(s.mimetype=e.mimetype);var d={mediaEntry:i,plaintextHash:a};return null==e.firstFrameLength&&null==e.firstFrameSidecar||(d.stickerInfo={firstFrameLength:e.firstFrameLength,firstFrameSidecar:e.firstFrameSidecar}),{content:s,media:d,preview:e.pngThumbnail,mentionedJids:void 0}}}}function L(e,t,n){var r,a=N(e);if(a){var i=a.size,s=a.plaintextHash,d=n(e,u.c.IMAGE,i,t);if(d){var c=(function(e){var t=e.scanLengths,n=e.scansSidecar,r=e.midQualityFileSha256;if(t||n||r)if(t)if(n)if(t.length!==g.H||r)if(t.length!==g.H&&t.length!==g.I)__LOG__(3)`protoMsgToDbMsg scanLengths has incorrect length: ${t.length}`;else{if(n.byteLength===t.length*g.m)return{scanLengths:t,scansSidecar:n,midQualityFileSha256:t.length===g.H?r:void 0};__LOG__(3)`protoMsgToDbMsg scansSidecar has incorrect length: ${n.byteLength}`}else __LOG__(3)`protoMsgToDbMsg midQualityFileSha256 missing for progressive JPEG info with ${g.H}`;else __LOG__(3)`protoMsgToDbMsg scansSidecar missing for progressive JPEG info`;else __LOG__(3)`protoMsgToDbMsg scanLengths missing for progressive JPEG info`;return null})(e);"mms4"===d.version&&null!=c&&(d.progressiveJpeg=c);var l={type:o.f.IMAGE,size:i,text:e.caption||void 0};null!=e.width&&e.width>0&&(l.width=e.width),null!=e.height&&e.height>0&&(l.height=e.height);var p=O(null==(r=e.contextInfo)?void 0:r.mentionedJid,e.caption);return{content:l,media:{mediaEntry:d,plaintextHash:s},preview:k(e),mentionedJids:p}}}}function D(e,t,n){var r=N(e);if(r){var a=r.size,i=r.plaintextHash,s=y(e,n,a,t);if(s){var o;null!=e.seconds?o=Math.max(e.seconds,1):(__LOG__(4)`makeMedia given audio msg without duration`,o=1);var u={size:a,duration:o};return e.mimetype&&(u.mimetype=e.mimetype),{content:u,media:{mediaEntry:s,plaintextHash:i},preview:k(e),mentionedJids:void 0}}}}function x(e,t,n,r){var a,i=N(e);if(i){var s=i.size,o=i.plaintextHash,u=r(e,n,s,t);if(u){var d={size:s,text:e.caption||void 0};null!=e.seconds&&(d.duration=Math.max(e.seconds,1)),e.mimetype&&(d.mimetype=e.mimetype),null!=e.width&&e.width>0&&(d.width=e.width),null!=e.height&&e.height>0&&(d.height=e.height);var c=O(null==(a=e.contextInfo)?void 0:a.mentionedJid,e.caption);return{content:d,media:{mediaEntry:u,plaintextHash:o},preview:k(e),mentionedJids:c}}}}function U(e,t,n){var r=F(t);if(r)return Object.assign({type:o.f.VCARD},r.content,e)}function F(e){var t=[];if(e.forEach(e=>{e.displayName&&e.vcard&&t.push({displayName:e.displayName,vcard:e.vcard})}),0!==t.length)return{content:{type:o.f.VCARD,contacts:t},preview:null,mentionedJids:void 0};__LOG__(4)`protoMsgToDbMsg no valid vcards in msg`}function B(e){var t=e.degreesLatitude,n=e.degreesLongitude;if(null!=t&&null!=n)return{content:{type:o.f.LOCATION,degreesLatitude:t,degreesLongitude:n,name:e.name,address:e.address,url:e.url},preview:k(e),mentionedJids:void 0};__LOG__(4)`protobuf location msg with no degreesLatitude or degreesLongitude`}function j(e){var t=null!=e.groupJid?(0,s.o)(e.groupJid):null,n="group"===(null==t?void 0:t.jidType)?t.groupJid:null;if(null==n)return __LOG__(4)`Received invite with bad groupJid ${e.groupJid}`,void SEND_LOGS("empty-groupjid");if(null==e.inviteCode||null==e.inviteExpiration||null==e.groupName)return __LOG__(4)`Received invalid group invite`,void SEND_LOGS("invalid-invite");var r=e.inviteCode,a=e.inviteExpiration,i=e.groupName;return{content:{type:o.f.GROUP_INVITE,groupJid:n,inviteCode:r,inviteExpiration:(0,p.i)(a),groupName:i,caption:e.caption},preview:k(e),mentionedJids:void 0}}function V(e,t){var n=K(e,t.ts);if(n){var r=Object.assign({},n.content,t,{media:void 0}),a={entry:n.media.mediaEntry,plaintextHash:n.media.plaintextHash,preview:n.preview||null};return n.media.thumbPlaintextHash&&(a.mmsThumbInfo={hash:n.media.thumbPlaintextHash}),{msg:r,media:a}}}function K(e,t){var n=N(e);if(n){var r=n.size,a=n.plaintextHash,i=y(e,u.c.DOCUMENT,r,t);if(i){var s,d,p=e.contactVcard&&"text/vcard"===e.mimetype,h=r<=c.E.get().vcardMaxSizeKb*f.a,m=e.fileName||e.title;if(p&&h)s={type:o.f.DOCUMENT,isVCard:!0,mimetype:"text/vcard",size:r,fileName:m,contactsCount:e.pageCount||void 0};else{var v={type:o.f.DOCUMENT,size:r,mimetype:e.mimetype||g.D,fileName:m,pages:e.pageCount||void 0};s=v,"mms4"===i.version&&null!=e.thumbnailHeight&&null!=e.thumbnailWidth&&e.thumbnailEncSha256&&e.thumbnailDirectPath&&null!=e.thumbnailSha256&&(v.mmsThumb={height:e.thumbnailHeight,width:e.thumbnailWidth},i.mmsThumb={directPath:e.thumbnailDirectPath,ciphertextHash:e.thumbnailEncSha256},d=(0,l.e)(new Uint8Array(e.thumbnailSha256)))}return{content:s,media:{mediaEntry:i,plaintextHash:a,thumbPlaintextHash:d},preview:k(e),mentionedJids:void 0}}}}},function(e,t,n){n.d(t,"a",(function(){return i})),n.d(t,"f",(function(){return o})),n.d(t,"b",(function(){return u})),n.d(t,"d",(function(){return d})),n.d(t,"e",(function(){return c})),n.d(t,"c",(function(){return l}));var r=n(128),a=n(3),i="no_reschedule",s=null;function o(e){__LOG__(2)`startScheduler invoked`,s||(s=new class{constructor(e){this.YP=!1,this.YQ={},this.YR={},this.YS={},this.YT=new Map,this.YU=e.scheduledTimeResolver}YV(e){var t=this.YT.get(e);null!=t?this.YU.get(e).then(n=>{var r=null==n;if(r||n!==a.c){var i=null==n?0:1e3*n-(0,a.F)();i=Math.max(0,i),i=Math.min(i,~(1<<31)),__LOG__(2)`Scheduling task ${e} in ${i}ms`,this.YS[e]=setTimeout(()=>{delete this.YS[e],__LOG__(2)`Firing task ${e}`,t(r).then(t=>{return"no_reschedule"===t?new Promise(()=>{}):(t===a.c?(__LOG__(2)`Task ${e} complete, deactivating`,delete this.YR[e],n=a.c):t>=0?(__LOG__(2)`Task ${e} complete, waiting ${t}`,delete this.YR[e],n=(0,a.l)(t)):(__LOG__(2)`Task ${e} will try again later`,n=this.YW(e)),this.YU.set(e,n));var n}).then(()=>{this.YV(e),this.YQ[e]&&(this.YQ[e].forEach(e=>e()),delete this.YQ[e])}).catch(t=>(__LOG__(2)`Task ${e} failed, try again later: ${t}`,this.YU.set(e,this.YW(e)).then(()=>{this.YV(e)})))},i)}else __LOG__(2)`Task ${e} deactivated`}):__LOG__(4)`Tried to start task ${e} before registering its implementation`}YW(e){return this.YR[e]||(this.YR[e]=(0,r.b)({jitter:.1,max:1e3*a.d,algo:{type:"fibonacci",first:1e3,second:2e3}})),(0,a.l)(Math.round(this.YR[e]()/1e3))}YX(e,t){this.YQ[e]||(this.YQ[e]=[]),this.YQ[e].push(t)}awaitTaskPromise(e){return new Promise(t=>{this.YX(e,t)})}reschedule(e,t){this.YP?(this.YU.set(e,t),null!=this.YS[e]&&clearTimeout(this.YS[e]),this.YV(e)):this.YU.set(e,t)}registerTask(e,t){this.YP||(this.YP=!0),this.YT.set(e,t),this.YV(e)}getScheduledTime(e){return this.YU.get(e)}}(e))}function u(e){return p("awaitTaskPromise").awaitTaskPromise(e)}function d(e,t){p("reschedule").reschedule(e,t)}function c(e){d(e,(0,a.E)())}function l(e,t){p("registerTask").registerTask(e,t)}function p(e){if(s)return s;throw new Error(`TaskScheduler::${e} called before startScheduler`)}},,function(e,t,n){n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return l})),n.d(t,"d",(function(){return p})),n.d(t,"e",(function(){return h})),n.d(t,"c",(function(){return f})),n.d(t,"g",(function(){return m})),n.d(t,"f",(function(){return v}));var r=n(9),a=n.n(r),i=n(61),s=n(7),o=n(38),u=null,d=new Set;function c(){return g("generateIdentityKeyPair",e=>e.context.generate_identity_key_pair())}function l(e,t){return _({type:"lib",methodName:"calculateAgreement",code:n=>n.curve_calculate_agreement(e,t),resolvable:new i.a})}function p(){return Promise.all([g("generateRegistrationId",e=>e.context.generate_registration_id(!1)),c()]).then(e=>{var t=a()(e,2);return{regId:t[0],staticKeyPair:t[1]}})}function h(e,t,n){return g("generateSignedPreKey",r=>{var a=r.context,i=r.storeContext;return a.generate_signed_pre_key(n,e,t).then(e=>({plainObject:{id:e.id,ts:e.timestamp,keyPair:e.keyPair,signature:e.signature},record:i.serialize_signed_pre_key(e)}))})}function f(e,t){return g("generatePreKeys",n=>{var r=n.context,a=n.storeContext;return r.generate_pre_keys(e,t).then(e=>e.map(e=>({plainObject:e,record:a.serialize_pre_key(e)})))})}function m(e,t){var n=e;return g("signalCreateSession",e=>{var r=e.context,a=e.storeContext;return r.session_builder((function(e){return lib_libsignal.protos.Address.create({name:(0,s.h)(e),deviceId:(0,s.f)(e)})})(n),a).then(e=>{var r=t.signedKey,a=t.oneTimeKey;return e.process_pre_key_bundle({deviceId:(0,s.f)(n),registrationId:t.regId,identityKey:b(t.identity),signedPreKeyId:r.id,signedPreKeyPublic:b(r.publicKey),signedPreKeySignature:r.signature,preKeyId:a?a.id:0,preKeyPublic:a?b(a.publicKey):null})}).then(()=>(0,o.b)())})}function v(e,t){var n={lib:e,context:t.then(e=>e.signalContexts())};u=n,d.forEach(e=>{__LOG__(2)`DaemonSignal run queued ${e.methodName}`,E(n,e)})}function g(e,t){return _({type:"context",methodName:e,code:t,resolvable:new i.a})}function _(e){return d.add(e),u&&E(u,e),e.resolvable.promise}function E(e,t){var n;if("lib"===t.type){var r=t.code;n=e.lib.then(e=>!t.resolvable.resolveWasCalled()&&r(e))}else{t.type;var a=t.code;n=e.context.then(e=>!t.resolvable.resolveWasCalled()&&a(e))}n.then(e=>{t.resolvable.resolve(e),d.delete(t)}).catch(e=>{e&&"session_closed"===e.reason?__LOG__(2)`DaemonSignal session_closed on ${t.methodName}`:(t.resolvable.reject(e),d.delete(t))})}function b(e){return e.subarray(1)}},function(e,t,n){n.d(t,"e",(function(){return T})),n.d(t,"g",(function(){return A})),n.d(t,"a",(function(){return O})),n.d(t,"c",(function(){return M})),n.d(t,"d",(function(){return C})),n.d(t,"b",(function(){return R})),n.d(t,"f",(function(){return N}));var r=n(3),a=n(95),i=n(35),s=n(20),o=n(6),u=n(317),d="https://graph.whatsapp.com",c="/graphql";function l(e){return{app_id:"com.whatsapp.kaios",request_token:e}}function p(e,t){return{lang:(0,s.d)().langTag,doc_id:e,access_token:"WA|2934776726793242|3093fa3bbf8935316304fe131f075eec",variables:t}}function h(e){var t=o.h.get().userAgent,n=p("4276154569100535",l(e)),r=(0,i.c)(d,c);return(0,i.f)(r,{},{method:"POST",headers:{"User-Agent":t,"Content-Type":"application/json"},body:JSON.stringify(n)}).then(e=>e.ok?e.json().then(e=>e.errors&&e.errors.length>0?{type:"error",error:f(e.errors[0])}:{type:"ok",result:m(e.data.whatsapp_support_ban_appeal_status)}):(__LOG__(4)`queryBanAppealStatus unexpected error ${e.status}`,{type:"error",error:"retry"})).catch(()=>({type:"error",error:"network_error"}))}function f(e){switch(e.code){case 2498024:return"unrecoverable";case 2498023:return"token-error";case 2498022:return"retry";default:return __LOG__(4)`responseToError error in response ${e.code}`,"retry"}}function m(e){var t=e.status,n=e.reason,r=e.reason_url;switch(t){case"UNBANNED":return{state:"unbanned",reason:v(n),reasonUrl:r};case"BANNED":return{state:"banned"};case"IN_REVIEW":return{state:"in_review"};case"NO_APPEAL_OPENED":return{state:"no_appeal_opened"};default:return __LOG__(4)`responseToBanAppealState error in response ${t}`,{state:"no_appeal_opened"}}}function v(e){switch(e){case"OOPS":return"oops";default:return"other"}}var g=n(9),_=n.n(g),E=n(27),b=n.n(E),y=n(194),S="https://v.whatsapp.net",I="ban_appeal",w=n(90);function T(e,t,n,s,u){__LOG__(2)`RegFlow.requestCodeBanAppeal`;var d,c=e.getStoreInStates3(["ENTERING_PHONE_NUMBER","REQUESTING_CODE_BAN_APPEAL","BLOCKED_BAN_APPEAL_PRE"]);if(c)return"sms"===s?(e.updateStore({type:"SENDING_SMS_BAN_APPEAL",country:t,localNumber:n,banInfo:u}),d=e.startSmsListener()):(d=Promise.resolve(),e.updateStore({type:"SENDING_VOICE_BAN_APPEAL",country:t,localNumber:n})),d.then(()=>(function(e,t,n,r){return e.getSlowParams().then(e=>{var a=o.h.get(),s=null!=a.lc?{lc:a.lc}:null,u=(0,i.c)(S,"/v2/acverify_request",Object.assign({cc:r.cc,in:n,lg:a.lg,mcc:a.mcc,mnc:a.mnc,method:t,context:I,"x-whatsapp-ua":a.userAgent},s,e));return(0,i.k)(u).then((function(){var e=b()((function*(e){return yield e.json()}));return function(t){return e.apply(this,arguments)}})()).catch(()=>({status:"network_error"}))})})(e,s,n,t)).then(i=>{if(e.getStoreInStates2(["SENDING_SMS_BAN_APPEAL","SENDING_VOICE_BAN_APPEAL"]))switch(i.status){case"sent":return void(0,a.a)(5e3).then(()=>{var t=e.getStoreInStates2(["SENDING_SMS_BAN_APPEAL","SENDING_VOICE_BAN_APPEAL"]);if(t){var n=t.country,a=t.localNumber;(function(e,t,n,a,i){var s={type:"CODE_PENDING",method:a.method,smsWait:k(a.wait),voiceWait:k(a.wait),requestTime:(0,r.E)()};e.updateStore({type:"REQUESTING_CODE_BAN_APPEAL",country:n,localNumber:t,state:s,banInfo:i})})(e,a,n,i,u)}});case"network_error":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:t,localNumber:n},state:{type:"CODE_REQUEST_ERROR",reason:"network_error",localNumber:n,cc:t.cc}});case"fail":var o=c.state;return void(function(e,t,n){var a=t.localNumber,i=t.country,s=t.method,o=t.banInfo,u=n.reason;if((0,w.b)(u))e.updateStore((0,w.a)(e,{localNumber:a,country:i},u,"CODE_REQUEST_ERROR",n.param));else switch(u){case"bad_token":return void e.updateStore({type:"BLOCKED",error:{reason:u,localNumber:a,cc:i.cc}});case"too_many_guesses":case"too_many":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:i,localNumber:a},state:{type:"CODE_REQUEST_ERROR",reason:"too_many_all_methods",localNumber:a,cc:i.cc,retryAfter:k(n.retry_after)||void 0}});case"too_recent":case"temporarily_unavailable":case"no_routes":var d,c,l={type:"CODE_REQUEST_ERROR",reason:u,retryAfter:k(n.retry_after),smsWait:"sms"===s?k(n.wait||n.retry_after):null==(d=t.prev)?void 0:d.smsWait,voiceWait:"voice"===s?k(n.wait||n.retry_after):null==(c=t.prev)?void 0:c.voiceWait,method:s,localNumber:a,cc:i.cc,requestTime:(0,r.E)()};return void e.updateStore({type:"REQUESTING_CODE_BAN_APPEAL",country:i,localNumber:a,state:l,banInfo:o});default:__LOG__(4)`verifyPhoneExists: Unexpected result reason ${u}`,SEND_LOGS("unexpected-otp-request-reason"),e.updateStore((0,w.c)(a,i,"CODE_REQUEST_ERROR"))}})(e,{localNumber:n,country:t,method:s,prev:o,banInfo:u},i);default:return __LOG__(4)`requestCodeBanAppeal: Unexpected result status ${i.status}`,i.status,void e.updateStore((0,w.c)(n,t,"CODE_REQUEST_ERROR"))}})}function A(e,t,n){__LOG__(2)`RegFlow.verifySmsCodeBanAppeal`;var a=e.getStoreInStates2(["REQUESTING_CODE_BAN_APPEAL","SENDING_SMS_BAN_APPEAL"]);if(a){var s=a.localNumber,u=a.country,d=a.banInfo;e.updateStore({type:"VERIFYING_SMS_BAN_APPEAL",localNumber:s,country:u}),(function(e,t,n,r,a){return __LOG__(2)`verifySmsCodeWithOTPService`,Promise.all([e.getSlowParams(),e.stopSmsListener()]).then(e=>{var s=_()(e,1)[0],u=o.h.get(),d=null!=u.lc?{lc:u.lc}:null,c=(0,i.c)(S,"/v2/acverify",Object.assign({cc:a.cc,in:r,lg:u.lg,context:I,code:t.join(""),entered:n,"x-whatsapp-ua":u.userAgent},d,s));return(0,i.k)(c).then((function(){var e=b()((function*(e){var t=yield e.json();return"verified"===t.status?{status:"verified",ban_reason:y.c[""+t.violation_type]||"other_harm",ban_token:t.ban_token}:{status:t.status,reason:t.reason,retry_after:t.retry_after,param:t.param}}));return function(t){return e.apply(this,arguments)}})()).catch(()=>({status:"network_error"}))})})(e,t,n,s,u).then(n=>{switch(n.status){case"verified":return void(function(e,t,n){var a=t.localNumber,i=t.country,s=t.banInfo,o=n.ban_token,u=n.ban_reason,d=void 0===u?"other_harm":u;h(o).then(t=>{if("ok"===t.type){var n=t.result;"no_appeal_opened"===n.state||"in_review"===n.state?null!=s?(s.banReason!==d&&__LOG__(3)`handleSmsCodeVerified: unexpected ban-reason ${d} vs ${s.banReason}`,e.updateStore({type:"BAN_APPEAL",banAppeal:{banAppealToken:o,banReason:d,banAppealState:n,banAppealLastSync:(0,r.E)()},localNumber:a,country:i})):e.updateStore({type:"BLOCKED_BAN_APPEAL",banAppeal:{banAppealToken:o,banReason:d,banAppealState:n,banAppealLastSync:(0,r.E)()},localNumber:a,country:i}):(n.state,e.updateStore({type:"BAN_APPEAL",banAppeal:{banAppealToken:o,banReason:d,banAppealState:n,banAppealLastSync:(0,r.E)()},localNumber:a,country:i}))}else switch(t.error){case"token-error":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{localNumber:a,country:i},state:{type:"BAN_APPEAL_ERROR",reason:"token-error",localNumber:a,cc:i.cc}});case"unrecoverable":return void e.updateStore({type:"BLOCKED",error:{reason:"bad_token",localNumber:a,cc:i.cc}});default:return void e.updateStore({type:"BLOCKED_BAN_APPEAL",banAppeal:{banAppealToken:o,banReason:d,banAppealState:{state:"no_appeal_opened"},banAppealLastSync:void 0},localNumber:a,country:i})}})})(e,{localNumber:s,country:u,banInfo:d},n);case"network_error":var i=a.state;return void e.updateStore({type:"REQUESTING_CODE_BAN_APPEAL",country:u,localNumber:s,banInfo:d,state:{type:"CODE_VERIFY_ERROR",reason:"network_error",code:t,localNumber:s,cc:u.cc,retryAfter:null==i?void 0:i.retryAfter,smsWait:null==i?void 0:i.smsWait,voiceWait:null==i?void 0:i.voiceWait,requestTime:null==i?void 0:i.requestTime}});case"fail":return void(function(e,t,n){var r=n.reason,a=t.country,i=t.localNumber,s=t.banInfo;if((0,w.b)(r))e.updateStore((0,w.a)(e,t,r,"CODE_VERIFY_ERROR",n.param));else switch(r){case"too_many_guesses":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:a,localNumber:i},state:{type:"CODE_VERIFY_ERROR",reason:"too_many_guesses",localNumber:i,cc:a.cc,retryAfter:k(n.retry_after)||void 0}});case"guessed_too_fast":case"missing":case"stale":case"mismatch":case"temporarily_unavailable":var o,u,d,c={type:"CODE_VERIFY_ERROR",reason:r,retryAfter:k(n.retry_after),smsWait:null==(o=t.prev)?void 0:o.smsWait,voiceWait:null==(u=t.prev)?void 0:u.voiceWait,code:t.code,localNumber:i,cc:a.cc,requestTime:null==(d=t.prev)?void 0:d.requestTime};return void e.updateStore({type:"REQUESTING_CODE_BAN_APPEAL",country:a,localNumber:i,banInfo:s,state:c});default:__LOG__(4)`verifySmsCodeBanAppeal: Unexpected result reason ${r}`,e.updateStore((0,w.c)(i,a,"CODE_VERIFY_ERROR"))}})(e,{code:t,country:u,localNumber:s,prev:a.state,banInfo:d},n);default:return __LOG__(4)`verifySmsCodeBanAppeal: Unexpected result status ${n.status}`,SEND_LOGS("unexpected-otp-verify-status"),n.status,void e.updateStore((0,w.c)(s,u,"CODE_VERIFY_ERROR"))}})}}function O(e){var t=e.getStoreInState("BAN_APPEAL");t&&e.updateStore(Object.assign({},t,{error:void 0}))}function M(e){__LOG__(2)`RegFlow.goToBanAppeal`;var t=e.getStoreInState("BLOCKED_BAN_APPEAL");if(t&&("no_appeal_opened"===t.banAppeal.banAppealState.state||"in_review"===t.banAppeal.banAppealState.state)){var n=t.banAppeal.banAppealState,r=t.banAppeal,a=t.localNumber,i=t.country;e.updateStore({type:"BAN_APPEAL",country:i,localNumber:a,banAppeal:{banAppealContent:r.banAppealContent,banReason:r.banReason,banAppealToken:r.banAppealToken,banAppealLastSync:r.banAppealLastSync,banAppealState:n}})}}function C(e,t){__LOG__(2)`RegFlow.goToBanAppealBlocked`;var n=e.getStoreInState("BAN_APPEAL"),r=null==n?void 0:n.banAppeal.banAppealState;if(n&&r&&("no_appeal_opened"===r.state||"in_review"===r.state)){var a=n.banAppeal,i=n.localNumber,s=n.country;e.updateStore({type:"BLOCKED_BAN_APPEAL",country:s,localNumber:i,banAppeal:{banAppealContent:t,banReason:a.banReason,banAppealToken:a.banAppealToken,banAppealLastSync:a.banAppealLastSync,banAppealState:r}})}}function R(e){__LOG__(2)`RegFlow.fetchBanAppealStatus`;var t=e.getStoreInStates2(["BAN_APPEAL","BLOCKED_BAN_APPEAL"]);if(!t)return Promise.resolve(!1);var n=t.banAppeal;return h(n.banAppealToken).then(t=>{var a=e.getStoreInStates2(["BAN_APPEAL","BLOCKED_BAN_APPEAL"]);if(!a)return!1;var i=a.localNumber,s=a.country,o=a.banAppeal;if("ok"===t.type){var u=(0,r.E)(),d=t.result;if("banned"===d.state||"unbanned"===d.state)e.updateStore({type:"BAN_APPEAL",country:s,localNumber:i,banAppeal:{banAppealState:d,banReason:n.banReason,banAppealToken:n.banAppealToken,banAppealLastSync:u}});else{d.state;var c="BAN_APPEAL"===a.type?{type:"BAN_APPEAL",country:s,localNumber:i,banAppeal:{banAppealState:d,banReason:n.banReason,banAppealToken:n.banAppealToken,banAppealLastSync:u}}:{type:"BLOCKED_BAN_APPEAL",country:s,localNumber:i,banAppeal:{banAppealState:d,banReason:n.banReason,banAppealToken:n.banAppealToken,banAppealLastSync:u}};e.updateStore(c)}return o.banAppealState.state!==d.state}switch(t.type,t.error){case"token-error":e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:s,localNumber:i},state:{type:"BAN_APPEAL_ERROR",reason:"token-error",localNumber:i,cc:s.cc}});break;case"unrecoverable":e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:s,localNumber:i},state:{type:"BAN_APPEAL_ERROR",reason:"error",localNumber:i,cc:s.cc}})}return!1})}function N(e,t){__LOG__(2)`RegFlow.submitBanAppeal`;var n=e.getStoreInState("BAN_APPEAL");if(n)return(function(e,t){var n=p("6960707423955525",(function(e,t){var n=l(e);return n.user_request={description:t,debug_info:JSON.stringify((0,u.a)("blocked"))},n})(e,t)),r=(0,i.c)(d,c);return(0,i.f)(r,{},{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(e=>e.ok?e.json().then(e=>e.errors&&e.errors.length>0?{type:"error",error:f(e.errors[0])}:{type:"ok",result:m(e.data.whatsapp_support_process_ban_appeal_request)}):(__LOG__(4)`submitBanAppealRequest: unexpected ${e.status}`,{type:"error",error:"retry"})).catch(()=>({type:"error",error:"network_error"}))})(n.banAppeal.banAppealToken,t).then(t=>{var n=e.getStoreInState("BAN_APPEAL");if(n){var a=n.banAppeal,i=n.localNumber,s=n.country;if("ok"!==t.type){t.type;var o=t.error;switch(o){case"token-error":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:s,localNumber:i},state:{type:"BAN_APPEAL_ERROR",reason:"token-error",localNumber:i,cc:s.cc}});case"unrecoverable":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:s,localNumber:i},state:{type:"BAN_APPEAL_ERROR",reason:"error",localNumber:i,cc:s.cc}});default:return void e.updateStore({type:"BAN_APPEAL",country:s,localNumber:i,banAppeal:a,error:{type:"BAN_APPEAL_ERROR",reason:o,localNumber:i,cc:s.cc}})}}else e.updateStore({type:"BAN_APPEAL",country:s,localNumber:i,banAppeal:{banAppealState:t.result,banAppealToken:a.banAppealToken,banReason:a.banReason,banAppealLastSync:(0,r.E)()}})}})}function k(e){return null==e||-1===e?null:(0,r.l)(e)}},,,,,function(e,t,n){n.d(t,"b",(function(){return a})),n.d(t,"e",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"d",(function(){return o})),n.d(t,"c",(function(){return u}));var r=n(0),a={},i={},s={},o={},u={};a.internalSpec={rawId:[1,r.d.UINT32],timestamp:[2,r.d.UINT64],currentIndex:[3,r.d.UINT32],validIndexes:[4,r.b.REPEATED|r.b.PACKED|r.d.UINT32]},i.internalSpec={details:[1,r.d.BYTES],accountSignature:[2,r.d.BYTES]},s.internalSpec={rawId:[1,r.d.UINT32],timestamp:[2,r.d.UINT64],keyIndex:[3,r.d.UINT32]},o.internalSpec={details:[1,r.d.BYTES],accountSignatureKey:[2,r.d.BYTES],accountSignature:[3,r.d.BYTES],deviceSignature:[4,r.d.BYTES]},u.internalSpec={details:[1,r.d.BYTES],hmac:[2,r.d.BYTES]}},,,function(e,t,n){var r=Object.prototype.hasOwnProperty,a="function"==typeof WeakMap?new WeakMap:new Map;function i(e){var t=a.get(e);if(void 0!==t)return t;var n=new Map;return Object.getOwnPropertyNames(e).forEach((function(t){n.set(e[t],t)})),a.set(e,n),n}var s=Object.freeze(Object.defineProperties(Object.create(null),{isValid:{value:function(e){return i(this).has(e)}},cast:{value:function(e){return this.isValid(e)?e:void 0}},members:{value:function(){return i(this).keys()}},getName:{value:function(e){return i(this).get(e)}}}));function o(e){var t=Object.create(s);for(var n in e)r.call(e,n)&&Object.defineProperty(t,n,{value:e[n]});return Object.freeze(t)}var u=Object.freeze(Object.defineProperties(Object.create(null),{isValid:{value:function(e){return"string"==typeof e&&r.call(this,e)}},cast:{value:s.cast},members:{value:function(){return Object.getOwnPropertyNames(this).values()}},getName:{value:function(e){return e}}}));o.Mirrored=function(e){for(var t=Object.create(u),n=0,r=e.length;n<r;++n)Object.defineProperty(t,e[n],{value:e[n]});return Object.freeze(t)},Object.freeze(o.Mirrored),e.exports=Object.freeze(o)},,function(e,t,n){n.d(t,"c",(function(){return g})),n.d(t,"e",(function(){return E})),n.d(t,"f",(function(){return b})),n.d(t,"b",(function(){return y})),n.d(t,"d",(function(){return M})),n.d(t,"g",(function(){return C})),n.d(t,"a",(function(){return j}));var r=n(27),a=n.n(r),i=n(31),s=n.n(i),o=n(43),u=n(62),d=n(2),c=n(6),l=n(49),p=n(135),h=n(412),f=n(23),m=n(24);function v(e,t){var n,r;return{senderKeyHash:(null==t?void 0:t.hash)||void 0,senderTimestamp:null!=(n=null==t?void 0:t.timestamp)?n:void 0,senderKeyIndexes:(null==t?void 0:t.keyIndexes)||void 0,recipientKeyHash:(null==e?void 0:e.hash)||void 0,recipientTimestamp:null!=(r=null==e?void 0:e.timestamp)?r:void 0,recipientKeyIndexes:(null==e?void 0:e.keyIndexes)||void 0}}function g(e,t){return _.apply(this,arguments)}function _(){return(_=a()((function*(e,t){var n=new Set(e);n.add(c.r.get());var r=yield(0,h.b)(n),a=[];return e.forEach(e=>{var n,i=e===c.r.get(),s=i?null:r.get(e),o=null!=s&&(null!=s.timestamp||null!=s.hash),u=Object.assign({},t);(i||o||(0,f.a)("md_icdc_enabled"))&&(n={deviceListMetadata:v(s,r.get(c.r.get()))},u.messageContextInfo=n),a.push({userJid:e,msg:u})}),a}))).apply(this,arguments)}function E(e,t,n,r){return b([e],t,n,r).then(e=>e[0].msg)}function b(e,t,n,r){return g(e,y(t,n,r))}function y(e,t,n){var r=e.forwardingScore;null==r&&(r=e.isForwarded?1:0);var a=r>0?{isForwarded:!0,forwardingScore:r}:void 0;a=(function(e,t,n,r){if(null==t)return e;var a=e||{};return a.expiration=t,null!=n&&(a.ephemeralSettingTimestamp=n),(0,f.a)("disappearing_mode")&&(a.disappearingMode={initiator:null!=r?r:u.a.CHANGED_IN_CHAT}),a})(a=S(a=I(a,e.remoteJid),e.mentionedJids),e.expiration,e.ephemeralSettingTimestamp,e.disappearingModeInitiator);var i=e.quoted,o=i&&(0,l.d)(i.content);if(null!=i&&null!=o){if(!n)throw new Error("sendMsg has a quote without its info");(a=(a=I(a,i.remoteJid))||{}).stanzaId=i.externalId,a.participant=i.author===d.b?c.r.get():i.author;var h,v=S(void 0,i.mentionedJids);switch(o.type){case d.f.TEXT:h=T(o,w(n.preview),v);break;case d.f.STICKER:h=A(o,w(n.preview,o.media),v);break;case d.f.IMAGE:h=null!=o.viewOnceState?{imageMessage:{fileSha256:new ArrayBuffer(1),fileLength:1,fileEncSha256:new ArrayBuffer(1),mediaKey:new ArrayBuffer(1),viewOnce:!0}}:O(o,w(n.preview,o.media),v);break;case d.f.AUDIO:h=k(o,w(n.preview,o.media),v);break;case d.f.PTT:h=N(o,w(n.preview,o.media),v);break;case d.f.VIDEO:h=null!=o.viewOnceState?{videoMessage:{fileSha256:new ArrayBuffer(1),fileLength:1,fileEncSha256:new ArrayBuffer(1),mediaKey:new ArrayBuffer(1),viewOnce:!0}}:G(o,w(n.preview,o.media),v);break;case d.f.GIF:h=L(o,w(n.preview,o.media),v);break;case d.f.VCARD:h=D(o,w(n.preview),v);break;case d.f.LOCATION:h=x(o,w(n.preview),v);break;case d.f.GROUP_INVITE:h=U(o,w(n.preview),v);break;case d.f.RICH_HSM:h=(function(e,t,n){var r=e.richContent;if(!r)return{conversation:(0,p.c)(e.title,e.content)};switch(r.type){case d.f.IMAGE:return O(r,t,n);case d.f.VIDEO:return G(r,t,n);case d.f.DOCUMENT:return B(r,t,n);default:return r.type,x(r,t,n)}})(o,w(n.preview,o.media),v);break;case d.f.HSM_BUTTON_REPLY:h=F(o,v);break;case d.f.DOCUMENT:h=B(o,w(n.preview,o.media),v);break;default:return(0,s.a)(o.type)}a.quotedMessage=h}var g=null;switch(e.type){case d.f.TEXT:g=T(e,t,a);break;case d.f.STICKER:g=A(e,t,a);break;case d.f.IMAGE:g=O(e,t,a);break;case d.f.AUDIO:g=k(e,t,a);break;case d.f.PTT:g=N(e,t,a);break;case d.f.VIDEO:g=G(e,t,a);break;case d.f.GIF:g=L(e,t,a);break;case d.f.VCARD:g=D(e,0,a);break;case d.f.LOCATION:g=x(e,t,a);break;case d.f.GROUP_INVITE:g=U(e,t,a);break;case d.f.HSM_BUTTON_REPLY:g=F(e,a);break;case d.f.DOCUMENT:g=B(e,t,a);break;case d.f.EPHEMERAL:g=(function(e){if("fail"===e.subtype)throw Error("asEphemeralProtocolMsg is never sent or received");var t=e.ephemeralExpiration;if("setting"===e.subtype)return{protocolMessage:{type:u.c.EPHEMERAL_SETTING,ephemeralExpiration:t}};e.subtype;var n=e.ephemeralSettingTimestamp,r={type:u.c.EPHEMERAL_SYNC_RESPONSE,ephemeralExpiration:t,ephemeralSettingTimestamp:n};if((0,f.a)("disappearing_mode")){var a=e.disappearingModeInitiator;null!=a&&(r.disappearingMode={initiator:a})}return{protocolMessage:r}})(e);break;case d.f.REVOKED:g={protocolMessage:{key:{remoteJid:e.chatJid,fromMe:!0,id:e.revokedExternalId},type:u.c.REVOKE}};break;default:throw new Error(`sendMsg has not implemented ${e.type} msgs`)}return(function(e,t,n){var r=t;return(0,m.o)(e)&&(r=(function(e){return{viewOnceMessage:{message:e}}})(r)),e.type!==d.f.EPHEMERAL&&null==(null==n?void 0:n.expiration)||(r=j(r)),r})(e,g,a)}function S(e,t){return null==t||0===t.length?e:e?(e.mentionedJid=t,e):{mentionedJid:t}}function I(e,t){return null==t?e:null!=(null==e?void 0:e.remoteJid)&&null!=t?(__LOG__(4)`Trying to assign remoteJid ${t} to ContextInfo already containing remoteJid ${null==e?void 0:e.remoteJid}`,SEND_LOGS("assignRemoteJid-contextInfo-already-has-remoteJid"),e):e?(e.remoteJid=t,e):{remoteJid:t}}function w(e,t){return{plaintextHash:null==t?void 0:t.plaintextHash,partialPlaintextHash:null,mediaEntry:null==t?void 0:t.mediaEntry,preview:e,thumbPlaintextHash:void 0}}function T(e,t,n){var r,a,i,s;return n||null!=e.linkPreview?{extendedTextMessage:{text:e.text,contextInfo:n,matchedText:null==(r=e.linkPreview)?void 0:r.matchedText,canonicalUrl:null==(a=e.linkPreview)?void 0:a.canonicalUrl,description:null==(i=e.linkPreview)?void 0:i.description,title:null==(s=e.linkPreview)?void 0:s.title,jpegThumbnail:(null==t?void 0:t.preview)||void 0}}:{conversation:e.text}}function A(e,t,n){var r=(null==t?void 0:t.partialPlaintextHash)||(null==t?void 0:t.plaintextHash);if(!r)throw new Error("asProtoMessage no hash for sticker");var a=(null==t?void 0:t.mediaEntry)||void 0,i={fileSha256:(0,o.c)(r),fileLength:e.size,contextInfo:n};if(null!=e.mimetype&&(i.mimetype=e.mimetype),null!=e.isAnimated&&(i.isAnimated=e.isAnimated),null!=e.width&&null!=e.height&&(i.width=e.width,i.height=e.height),null!=(null==t?void 0:t.preview)&&(i.pngThumbnail=t.preview),null!=(null==t?void 0:t.stickerInfo)){var u=t.stickerInfo;null!=u.firstFrameLength&&(i.firstFrameLength=u.firstFrameLength),null!=u.firstFrameSidecar&&(i.firstFrameSidecar=u.firstFrameSidecar)}if(null!=a)if(i.url=a.url,i.mediaKey=a.cryptoKey,"mms4"===a.version)i.mediaKeyTimestamp=a.mediaKeyTs,i.fileEncSha256=a.ciphertextHash,i.directPath=a.directPath;else if("mms3"!==a.version)return(0,s.a)(a.version);return{stickerMessage:i}}function O(e,t,n){var r=M(e,t);if(!r)throw new Error("asProtoMessage no hash for image");var a=r.fileLength,i=r.hash,s=null!=e.viewOnceState,u=!s&&(null==t?void 0:t.preview)||void 0,d={mimetype:"image/jpeg",caption:e.text||void 0,fileSha256:(0,o.c)(i),fileLength:a,height:e.height||void 0,width:e.width||void 0,jpegThumbnail:u,contextInfo:n,viewOnce:s||void 0};return C(d,null==t?void 0:t.mediaEntry),{imageMessage:d}}function M(e,t){var n=(null==t?void 0:t.mediaEntry)||void 0,r=(null==n?void 0:n.uploadToken)&&(null==t?void 0:t.partialPlaintextHash)||(null==t?void 0:t.plaintextHash),a=(null==n?void 0:n.size)||e.size;return r?{hash:r,fileLength:a}:void 0}function C(e,t){if(null==t);else if(e.url=t.url||void 0,e.mediaKey=t.cryptoKey,"mms4"===t.version){if(e.mediaKeyTimestamp=t.mediaKeyTs,e.fileEncSha256=t.ciphertextHash,e.directPath=t.directPath,t.progressiveJpeg){var n=t.progressiveJpeg,r=n.scanLengths,a=n.scansSidecar,i=n.midQualityFileSha256;4===r.length?i&&(e.midQualityFileSha256=i,e.scanLengths=r,e.scansSidecar=a):(e.scanLengths=r,e.scansSidecar=a)}}else t.version}function R(e){var t=e.msg,n=e.media,r=e.contextInfo,a=e.isPtt,i=null==n?void 0:n.plaintextHash,u=(null==n?void 0:n.mediaEntry)||void 0;if(!i)throw new Error("asProtoMessage no hash for ptt");var d={mimetype:t.mimetype||void 0,fileSha256:(0,o.c)(i),fileLength:t.size,seconds:t.duration,ptt:a,contextInfo:r};if(null==u);else if(d.url=u.url||void 0,d.streamingSidecar=u.sidecar||void 0,d.mediaKey=u.cryptoKey,"mms4"===u.version)d.mediaKeyTimestamp=u.mediaKeyTs,d.fileEncSha256=u.ciphertextHash,d.directPath=u.directPath;else if("mms3"!==u.version)return(0,s.a)(u.version);return{audioMessage:d}}function N(e,t,n){var r=R({msg:e,media:t,contextInfo:n,isPtt:!0});return(null==e?void 0:e.waveform)&&r.audioMessage&&(r.audioMessage=Object.assign({},r.audioMessage,{waveform:e.waveform})),r}function k(e,t,n){return R({msg:e,media:t,contextInfo:n,isPtt:!1})}function P(e,t,n,r,a,i){var u=null==t?void 0:t.plaintextHash,d=(null==t?void 0:t.mediaEntry)||void 0,c=!a&&(null==t?void 0:t.preview)||void 0;if(!u)throw new Error("asProtoMessage no hash for video");var l={mimetype:e.mimetype||void 0,fileSha256:(0,o.c)(u),fileLength:e.size,seconds:e.duration,caption:e.text||void 0,gifPlayback:!!r||void 0,height:e.height||void 0,width:e.width||void 0,jpegThumbnail:c,gifAttribution:i,contextInfo:n,viewOnce:a||void 0};if(null==d);else if(l.url=d.url||void 0,l.streamingSidecar=d.sidecar||void 0,l.mediaKey=d.cryptoKey,"mms4"===d.version)l.mediaKeyTimestamp=d.mediaKeyTs,l.fileEncSha256=d.ciphertextHash,l.directPath=d.directPath;else if("mms3"!==d.version)return(0,s.a)(d.version);return{videoMessage:l}}function G(e,t,n){return P(e,t,n,!1,null!=e.viewOnceState)}function L(e,t,n){return P(e,t,n,!0,!1,e.gifAttribution)}function D(e,t,n){var r=e.contacts;return 1===r.length?{contactMessage:{displayName:r[0].displayName,vcard:r[0].vcard,contextInfo:n}}:{contactsArrayMessage:{contacts:r,contextInfo:n}}}function x(e,t,n){return{locationMessage:{degreesLatitude:e.degreesLatitude,degreesLongitude:e.degreesLongitude,name:e.name,address:e.address,url:e.url,jpegThumbnail:(null==t?void 0:t.preview)||void 0,contextInfo:n}}}function U(e,t,n){return{groupInviteMessage:{groupJid:e.groupJid,groupName:e.groupName,inviteCode:e.inviteCode,inviteExpiration:e.inviteExpiration,jpegThumbnail:(null==t?void 0:t.preview)||void 0,contextInfo:n}}}function F(e,t){return{templateButtonReplyMessage:{contextInfo:t,selectedId:e.payload,selectedDisplayText:e.selectedDisplayText,selectedIndex:e.selectedButtonIndex}}}function B(e,t,n){var r=null==t?void 0:t.plaintextHash,a=(null==t?void 0:t.mediaEntry)||void 0;if(!r)throw new Error("asProtoMessage no hash for document");var i=e.isVCard?e.contactsCount:e.pages,s={mimetype:e.mimetype,title:e.fileName,fileName:e.fileName,fileSha256:(0,o.c)(r),fileLength:e.size,pageCount:i,contextInfo:n,contactVcard:e.isVCard,jpegThumbnail:(null==t?void 0:t.preview)||void 0};if(null==a);else if(s.url=a.url||void 0,s.mediaKey=a.cryptoKey,"mms4"===a.version){if(s.mediaKeyTimestamp=a.mediaKeyTs,s.fileEncSha256=a.ciphertextHash,s.directPath=a.directPath,t&&t.thumbPlaintextHash&&a.mmsThumb&&a.mmsThumb.directPath&&e.mmsThumb&&(0,f.a)("upload_document_thumb_mms_enabled")){var u=e.mmsThumb,d=u.height,c=u.width,l=a.mmsThumb,p=l.ciphertextHash,h=l.directPath;s.thumbnailSha256=(0,o.c)(t.thumbPlaintextHash),s.thumbnailHeight=d,s.thumbnailWidth=c,s.thumbnailEncSha256=p,s.thumbnailDirectPath=h}}else a.version;return{documentMessage:s}}function j(e){return{ephemeralMessage:{message:e}}}},function(e,t,n){n.d(t,"d",(function(){return u})),n.d(t,"h",(function(){return d})),n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return l})),n.d(t,"a",(function(){return p})),n.d(t,"g",(function(){return h})),n.d(t,"f",(function(){return f})),n.d(t,"e",(function(){return m}));var r=n(26),a=n(60),i=n(8),s=n(5),o=Math.pow(2,32)-1;function u(){return(0,i.f)("incrementADVCurrentKeyIndex",e=>e.transact("rw",["meta"],()=>(0,r.d)(e.stores.meta,r.a.ADV_COMPANION_INFO).then(e=>{var t=null==e||null==e.value||e.value.rawId<=0||e.value.currentIndex<=0;return null==e||t?{rawId:Math.floor(Math.random()*o)+1,currentIndex:(0,a.e)(1),timestamp:null}:Object.assign({},e.value,{currentIndex:(0,a.e)(e.value.currentIndex+1)})})))}function d(e){return(0,i.f)("storeADVCompanionDetails",t=>t.transact("rw",["meta"],()=>(0,r.d)(t.stores.meta,r.a.ADV_COMPANION_INFO).then(n=>{var a,i=e.signingTimestamp,s=e.keyIndex,o=e.rawId,u=e.deviceId,d=e.platformType,c=e.os,l=e.requireFullSync,p=null==n||null==n.value||n.value.rawId<=0||n.value.currentIndex<=0,h={keyIndex:s,deviceId:u,timestamp:i};if(d&&(h.platformType=d),c&&(h.os=c),null!=l&&(h.requireFullSync=l),p)a={rawId:o,currentIndex:s,timestamp:i,devices:[h]};else{if(null==n||!(null==n.value.timestamp||n.value.timestamp<i))throw new Error("Invaid timestamp value");var f;(a=Object.assign({},n.value)).rawId=o,a.currentIndex=s,a.timestamp=i,null==(f=a.devices)||f.push(h)}return t.stores.meta.put({key:r.a.ADV_COMPANION_INFO,value:a}).then(()=>{})})))}function c(){return(0,i.f)("getADVCompanions",e=>e.transact("r",["meta"],()=>(0,r.d)(e.stores.meta,r.a.ADV_COMPANION_INFO).then(e=>{if(e)return Object.assign({},e.value).devices})))}function l(e){return(0,i.f)("getADVDeviceInfo",t=>t.transact("r",["meta"],()=>(0,r.d)(t.stores.meta,r.a.ADV_COMPANION_INFO).then(t=>{if(t){var n=Object.assign({},t.value).devices;return null==n?void 0:n.find(t=>t.deviceId===e)}})))}function p(){return(0,i.f)("getADVCompanionInfo",e=>e.transact("r",["meta"],()=>(0,r.d)(e.stores.meta,r.a.ADV_COMPANION_INFO).then(e=>{if(e)return null==e?void 0:e.value})))}function h(e){return(0,i.f)("removeStoredCompanion",t=>t.transact("rw",["meta"],()=>(0,r.d)(t.stores.meta,r.a.ADV_COMPANION_INFO).then(n=>{if(null!=n){var a=n.value,i=a.devices;if(null!=i&&0!==i.length){var s=i.findIndex(t=>t.deviceId===e);if(-1!==s)return i.splice(s,1),t.stores.meta.put({key:r.a.ADV_COMPANION_INFO,value:a}).then(()=>{})}}})))}function f(){return(0,i.f)("removeAllStoredCompanions",e=>(0,s.i)(e.stores.meta.delete(r.a.ADV_COMPANION_INFO)))}function m(){return c().then(e=>{var t=[];return null!=e&&e.forEach(e=>{var n=e.deviceId,r=e.platformType,a=e.os;t.push({deviceId:n,platformType:r,os:a})}),t})}},,,,,,function(e,t,n){n.r(t),n.d(t,"verifyUserCert",(function(){return I})),n.d(t,"validateBusinessMsg",(function(){return C})),n.d(t,"VLEVEL_TYPES",(function(){return R})),n.d(t,"getBspInfo",(function(){return N})),n.d(t,"getBusinessInfoFromNode",(function(){return P})),n.d(t,"maybeGetBusinessNode",(function(){return G}));var r=n(87),a=n(28),i=n(4),s=n(0),o={},u={},d={};o.internalSpec={lg:[1,s.d.STRING],lc:[2,s.d.STRING],verifiedName:[3,s.d.STRING]},u.internalSpec={details:[1,s.d.BYTES],signature:[2,s.d.BYTES],serverSignature:[3,s.d.BYTES]},d.internalSpec={serial:[1,s.d.UINT64],issuer:[2,s.d.STRING],verifiedName:[4,s.d.STRING],localizedNames:[8,s.b.REPEATED|s.d.MESSAGE,o],issueTime:[10,s.d.UINT64]},s.d.MESSAGE,s.d.BYTES,s.d.UINT64,s.d.STRING,s.d.UINT64,s.d.ENUM,s.d.ENUM,s.d.ENUM,s.d.MESSAGE,s.d.BOOL,s.d.BOOL,s.d.ENUM,s.d.ENUM,s.d.UINT64,s.d.UINT64;var c=n(10),l=n(75),p=n(46),h=n(17),f=n(63),m=n(49),v=n(6),g=n(67),_=n(144),E=n(30),b=n(16),y=n(89),S=n(3);function I(e,t,n,r){return w(e,t,n,r).then(t=>{if("error"===t)return __LOG__(4)`verifyUserCert error`,SEND_LOGS("biz-cert-error",.01),(0,E.b)().waitUntilPersisted(b.e.validateBusinessCertificate(e))})}function w(e,t,n,r){var a=(function(e){var t=(0,g.a)(u,e).details;if(!t)return __LOG__(4)`verifyCertificate cert missing details`,"error";var n=(0,g.a)(d,t),r=n.issuer,a=n.verifiedName,i=n.serial;return a?null==i?(__LOG__(4)`verifyCertificate details missing serial`,"error"):A.includes(r)?{serial:i,name:a,isApi:r===T}:(__LOG__(4)`verifyCertificate unrecognized issuer "${String(r)}"`,"error"):(__LOG__(3)`verifyCertificate verified name missing`,"name-missing")})(n);if("name-missing"===a)return Promise.resolve();if("error"===a)return Promise.resolve("error");var i=a.serial,s=a.name,o=a.isApi;return h.ed(e,o?{level:t,serial:i,name:s,bsp:r,isApi:!0}:{level:t,serial:i,name:s,isApi:!1})}var T="ent:wa",A=[T,"smb:wa"],O={algo:{type:"constant",delay:1e3*S.b}};function M(e){var t=e.chat,n=e.content,r=(0,m.i)(n.msg.author);return null==r?Promise.resolve():(0,E.b)().waitUntilPersisted(b.e.validateBusinessCertificate(r)).then(()=>h.gd(t,n))}t.default=(0,l.c)().finalStep("validateBusinessCertificate",e=>D(e.jid,"background").then(e=>{if("error"===e)throw __LOG__(4)`validateBusinessCertificate error`,SEND_LOGS("biz-cert-error",.01),new y.b(O)})).end();var C=(0,l.c)().finalStep("validateBusinessMsg",{code:e=>{var t=e.chat,n=e.content;return(function(e,t){var n=(0,m.i)(t.msg.author);if(null==n)return Promise.resolve();if(t.contactVerification){var r=t.contactVerification,a=r.level,i=r.serial,s=r.cert,o=r.bsp;return(0,f.b)(n).then(e=>{if((0,_.d)(e,i,a,o)){var t,r,u=null==e||null==(t=e.verifiedInfo)||null==(r=t.bsp)?void 0:r.ts,d=null==o?void 0:o.ts;if(d&&u&&d<u)return;return s?w(n,a,s,o||void 0):D(n,"interactive")}})}return D(n,"interactive")})(0,n).then(e=>e?M({chat:t,content:n}):h.gd(t,n))},stopRetryIf:{timePassedSeconds:S.b,onStopRetry:M}}).end(),R={high:"high",low:"low",unknown:"unknown"};function N(e){if(e.hasAttr("actual_actors")&&e.hasAttr("host_storage"))return{actors:e.attrEnumValues("actual_actors",(0,c.x)(r.a)),host:e.attrEnumValues("host_storage",(0,c.x)(r.b)),ts:e.attrTime("privacy_mode_ts")}}var k={high:"high",low:"low",unknown:"unknown"};function P(e){if(!e.hasChild("business"))return"NO_BIZ";var t=e.child("business").maybeChild("verified_name");return t?{verifiedInfo:{level:t.attrEnumOrDefault("verified_level",k,"unknown"),cert:t.hasContent()?t.contentBytes():"UNCHANGED",bsp:N(t)}}:"NO_BIZ"}function G(e){if(null!=(null==e?void 0:e.verifiedInfo))return(0,i.v)("business",null,(0,i.v)("verified_name",{serial:(0,i.h)(e.verifiedInfo.serial)}))}var L=new p.a("syncBusinessResult",e=>{e.assertAttr("type","result");var t=e.child("usync"),n=t.child("result").child("business"),r=t.child("list"),a=new Map;return r.forEachChildWithTag("user",e=>{a.set(e.attrPhoneUserJid("jid"),P(e))}),{refresh:n.maybeAttrInt("refresh",0)||0,updates:a}});function D(e,t){return(0,f.b)(e).then(n=>{var r=(0,i.v)("iq",{to:(0,i.g)(v.r.get()),id:(0,i.t)(),xmlns:"usync",type:"get"},(0,i.v)("usync",{mode:"query",context:t,sid:(0,i.t)(),index:"0",last:"true"},(0,i.v)("query",null,(0,i.v)("business",null,(0,i.v)("verified_name",null))),(0,i.v)("list",null,(0,i.v)("user",{jid:(0,i.g)(e)},G(n)))));return(0,a.e)(r,L).then(t=>{if(!t.success)return __LOG__(4)`Error while attempting to update business in query sync ${t.errorCode}`,"error";var n=t.result.updates.get(e);if(!n||"NO_BIZ"===n)return h.Mc(e);var r=n.verifiedInfo;return"UNCHANGED"!==r.cert?w(e,r.level,r.cert,r.bsp):(0,f.b)(e).then(t=>{var n=null==t?void 0:t.verifiedInfo;if(t&&n&&(0,_.d)(t,n.serial,r.level,r.bsp)){var a=n.isApi?Object.assign({},n,{level:r.level,bsp:r.bsp}):Object.assign({},n,{level:r.level});return h.ed(e,a)}})})})}},,function(e,t,n){n.d(t,"b",(function(){return M})),n.d(t,"a",(function(){return R})),n.d(t,"f",(function(){return L})),n.d(t,"e",(function(){return j})),n.d(t,"d",(function(){return V})),n.d(t,"c",(function(){return H}));var r=n(27),a=n.n(r),i=n(128),s=class{constructor(e,t,n){this.aL=(0,i.a)(t),this.aM=0,this.aN=e,this.aO=n}run(e,t){var n=this;return a()((function*(){for(;n.aM<n.aN;){yield n.aL(),n.aM>0&&(__LOG__(2)`NetworkOperationsRetrier wait for internet, attempt = ${n.aM}`,yield null==n.aO?void 0:n.aO());var r=yield e(n.aM,t);if(r.success)return r.value;++n.aM}return null}))()}},o=n(224),u=n(38),d=n(107),c=n(94),l=n(131),p=n(36),h=n(29),f=n(25),m=n(43),v=n(12),g=n(35),_=n(3),E=n(82),b=n(252),y=n(124),S=n(14);function I(e){return(Math.floor(e/l.a)+1)*l.a}function w(){return(w=a()((function*(e){var t,n;try{t=yield(0,g.k)(e)}catch(e){return __LOG__(2)`fetchPayload network error ${e}`,{type:"network-error"}}if(__LOG__(2)`fetchPayload http status ${t.status}`,t.status!==g.a.OK)return{type:"http-error",code:t.status};try{n=yield t.arrayBuffer()}catch(e){return __LOG__(2)`fetchPayload network error on body ${e}`,{type:"body-network-error"}}return{type:"ok",payload:n}}))).apply(this,arguments)}function T(e,t){return(n,r)=>{var a=(0,_.u)();return(function(e){return w.apply(this,arguments)})(n).then(n=>{var i=(0,_.v)(a);if("ok"!==n.type)return{status:n,networkTime:i};var s=n.payload;if(__LOG__(2)`simpleFetcher received data, payload.byteLength = ${s.byteLength}`,"unknown"!==t){var o=I(t);if(s.byteLength<o+S.m)return __LOG__(4)`simpleFetcher incoherent ciphertext, expected ${o+S.m} bytes, got ${s.byteLength}`,{status:{type:"body-network-error"},networkTime:i}}var u=s.byteLength-S.m,d=new Uint8Array(s,u),c=new Uint8Array(s,0,u);return{status:{type:"done",finalize:()=>{var t=(0,_.u)();return(0,l.e)(e.cipherKey,e.iv,c,e.hmacKey,d).then(e=>{var n=e.plaintext,a=e.plaintextHash;return r(new Uint8Array(n)),{plaintextHash:a,decryptionTime:(0,_.v)(t)}})}},networkTime:i}})}}function A(e,t){var n=I(t);return(t,r)=>(0,h.m)(t,e.iv,e.cipherKey,e.hmacKey,n,S.m,e=>{r(e)}).then(e=>{var t=e.tail,n=e.plainTextHash,r=e.hmac;return __LOG__(2)`daemonFetcher successfully received data`,{type:"done",finalize:()=>{var e=r.slice(0,S.m);if(!(0,y.c)(t,e))throw new l.b("daemonFetch hmac mismatch");return Promise.resolve({plaintextHash:(0,m.e)(n)})}}}).catch(e=>{if(e&&"string"==typeof e.reason&&"session_closed"===e.reason)return __LOG__(3)`daemonFetcher daemon disconnected`,{type:"daemon-disconnected"};if("string"!=typeof e)throw __LOG__(4)`Error was not a string: ${e}`,new Error("Download failed with unknown error");if("bad_url"===e||"bad_ciphertext_size"===e||"bad_iv"===e||"bad_cipher_key"===e||"bad_hmac_key"===e||"bad_tail_size"===e)throw new Error("Incorrect input: "+e);if(e.startsWith("http_error")){var t=e.split("=");if(2!==t.length)throw new Error("Incorrect output: http error does not have code");var n=parseInt(t[1],10);if(n===g.a.OK)throw new Error("Daemon raised exception for successful HTTP request");return{type:"http-error",code:n}}if("bad_content_size"===e)return{type:"body-network-error"};if("download_error"===e||"connection_error"===e)return{type:"network-error"};if("dns_error"===e)return{type:"dns-error"};if("tls_error"===e)return{type:"tls-error"};if(e.startsWith("aes_error")){var r=e.split("_");if(3!==r.length)throw new Error("Incorrect output: aes error does not have error description");throw __LOG__(4)`Crypto error: ${r[2]}`,new Error("Crypto error")}throw __LOG__(4)`Download failed with unknown error: ${e}`,new Error("Download failed with unknown error")}).then(e=>({status:e}))}var O=n(28),M={initial:10,downloading:80,processing:10},C=(0,E.d)("FilesystemError",!1),R={gone:6,"exceeded-max-attempts":void 0,"access-expired":9,"download-throttled":18,"no-hosts":17,"hash-mismatch":8,"enc-hash-mismatch":14,"output-stream-failure":10,"daemon-disconnected":20,"request-error":2};function N(e,t,n,r,a,i){return k.apply(this,arguments)}function k(){return(k=a()((function*(e,t,n,r,a,i){var s=t.size,o=t.type,u=t.cryptoKey,d=t.progressiveJpeg;if(__LOG__(2)`downloadMms entry.size = ${s}`,"unknown"!==s&&s>p.c)throw new Error("downloadMms error: attempt to download media of size larger than "+p.c);var c=yield(0,l.c)(u,o);__LOG__(2)`downloadMms have keys`;var f,m=s||"unknown",v=n,g=1;d&&"unknown"!==m&&(__LOG__(2)`downloadMms dectected a progressive JPEG`,(f=(0,b.b)(d,m))&&(m=f.downloadSize,v=f.expectedPlaintextHash,g=2));var _,E=Object.assign({},i,{downloadQuality:g}),y={cipherKey:c.cipherKey,iv:c.iv,hmacKey:c.hmacKey};if(f){var S=f.partialFetchOptions;_=(0,b.c)(y,S,f.downloadSize)}else _="static"===t.version?T(y,m):(yield(0,h.C)("downloadAndDecrypt"))&&"unknown"!==m?A(y,m):T(y,m);var I=yield L(t,e,v,m,r,_,a,E);if("success"!==I.result.status&&f){__LOG__(3)`downloadMms partial download failed. Falling back to a full download`,a.parts.downloading.reset(),_="static"===t.version?T(y,m):(yield(0,h.C)("downloadAndDecrypt"))&&"unknown"!==m?A(y,m):T(y,m);var w=Object.assign({},E,{downloadQuality:1});I=yield L(t,e,n,t.size||"unknown",r,_,a,w)}return I}))).apply(this,arguments)}function P(){}function G(e){throw e}function L(e,t,n,r,a,i,s,o){return D.apply(this,arguments)}function D(){return(D=a()((function*(e,t,n,r,a,i,u,d){var c,l;if("static"===e.version){var p=e,h=new _.e,f=(0,g.h)(p.staticUrl);l=Object.assign({},d);var m=new s(o.b,o.a,O.p);c=yield m.run((e,t)=>U(f,e,r,a,i,h,u,Object.assign({},t,{overallRetryCount:e})),l)}else{var v=e,E=yield x(v);if("no-hosts"===E)return u.failed("no-hosts"),{result:{status:"no-hosts"},metric:d};if("disconnected"===E)return u.failed("daemon-disconnected"),{result:{status:"daemon-disconnected"},metric:d};var b=new _.e;l=Object.assign({},d,{overallConnBlockFetchT:E.routesInfo.timeElapsed}),c=yield E.run((e,n,s,o)=>U(q(v,e.domain,t),s,r,a,i,b,u,Object.assign({},o,{overallDomain:E.routesInfo.host.domain,overallConnectionClass:E.routesInfo.host.class,overallRetryCount:s})),l)}if(!c)return __LOG__(3)`downloadMms given up`,u.failed("exceeded-max-attempts"),{result:{status:"exceeded-max-attempts"},metric:l};var y,S=c,I=S.result,w=S.metric;if("ok"!==I.type)return u.failed(I.type),__LOG__(2)`downloadMms failed ${I.type}`,{result:{status:I.type},metric:w};I.type,u.parts.downloading.finished();try{y=yield I.finalization()}catch(e){if(e&&"FilesystemError"===e.name)return{result:{status:"output-stream-failure"},metric:w};if(e&&"HmacValidationError"===e.name)return __LOG__(3)`downloadMms failed to verify ciphertext`,{result:{status:"enc-hash-mismatch"},metric:w};throw e}var T=y,A=T.plaintextHash,M=T.result,C=T.decryptionTime,R=T.progressiveDownload;return __LOG__(2)`downloadMms successfully decrypted, plaintext size = ${r}`,n&&n!==A?{result:{status:"hash-mismatch"},metric:w}:{result:{status:"success",result:M,progressiveDownload:R},metric:Object.assign({},w,{overallDecryptT:C})}}))).apply(this,arguments)}function x(e){switch(e.version){case"mms4":return(0,d.d)(e.type,e.directPath,e.ciphertextHash);default:return e.version,(0,d.c)(e.type)}}function U(e,t,n,r,a,i,s,o){return F.apply(this,arguments)}function F(){return(F=a()((function*(e,t,n,r,a,i,s,c){var l;s.parts.initial.finished();try{l=yield r(n,s)}catch(e){if(e&&"FilesystemError"===e.name)return(0,u.b)({result:{type:"output-stream-failure"},metric:Object.assign({},c,{overallT:i.elapsed(),overallCumT:i.cumulative()})});throw e}var p,h=yield a(e,e=>l.addChunk(e)),f=h.status,m=h.networkTime,v=Object.assign({},c,{overallT:i.elapsed(),overallCumT:i.cumulative(),downloadNetworkT:m});if("done"===f.type)return(0,u.b)({result:{type:"ok",finalization:()=>f.finalize().then(e=>l.ZW().then(t=>({plaintextHash:e.plaintextHash,result:t,decryptionTime:e.decryptionTime,progressiveDownload:e.progressiveDownload})))},metric:Object.assign({},v,{downloadHttpCode:g.a.OK})});if(yield l.ZX(),"daemon-disconnected"===f.type)return(0,u.b)({result:{type:"daemon-disconnected"},metric:v});if("http-error"===f.type){var _,E=f.code;if(E===g.a.GONE||E===g.a.NOT_FOUND)_="gone";else if(E===g.a.UNAUTHORIZED||E===g.a.FORBIDDEN)_="access-expired";else if(E===g.a.INSUFFICIENT_STORAGE)_="download-throttled";else{if(E===g.a.REQUEST_TIMEOUT||E>=500)return(0,d.k)(Object.assign({},v,{overallDownloadResult:2,overallIsFinal:t===o.b-1,downloadHttpCode:E})),i.reset(),(0,u.a)({progressMade:!0});if(!(E>=400&&E<500))throw new Error("downloadMms unexpected code "+E);_="request-error"}return(0,u.b)({result:{type:_},metric:Object.assign({},v,{downloadHttpCode:E})})}switch(f.type){case"dns-error":p=4;break;case"tls-error":p=19;break;default:p=3}(0,d.k)(Object.assign({},v,{overallDownloadResult:p,overallIsFinal:t===o.b-1})),i.reset();var b="body-network-error"===f.type;return(0,u.a)({progressMade:b})}))).apply(this,arguments)}function B(e,t){return(0,v.e)("page","createTemporaryFile",{}).then(n=>{var r=n.path;return new class{constructor(e,t,n){this.ZY=e,this.ZZ=Promise.resolve(),this.Za=t,this.Zb=n,this.Zc=0}addChunk(e){this.ZZ=this.ZZ.then(()=>(0,v.e)("page","appendBlobToFile",{blob:new Blob([e]),path:this.Za}).then(()=>{this.Zc+=e.byteLength,this.Zb.parts.downloading.set(this.Zc/this.ZY)}).catch(e=>{throw __LOG__(3)`Failed to write chunk ${e}: ${null==e?void 0:e.name} - ${null==e?void 0:e.message}`,new C("Failed to write chunk")})).then(P,G)}ZW(){return this.ZZ.then(()=>this.Za)}ZX(){return this.ZZ.catch(P).then(()=>(0,v.e)("page","deletePath",{path:this.Za}))}}("unknown"===e?0:e,r,t)}).catch(e=>{throw __LOG__(3)`Failed to create temporary file ${e}: ${null==e?void 0:e.name} - ${null==e?void 0:e.message}`,new C("Failed to create temporary file")})}function j(e,t){return new class{constructor(e,t){this.ZY=e,this.Zd=new f.a,this.Zd.ensureCapacity(e),this.Zb=t}addChunk(e){this.Zd.writeByteArray(e),this.Zb.parts.downloading.set(this.Zd.size()/this.ZY)}ZW(){return Promise.resolve(this.Zd.readBuffer())}ZX(){return Promise.resolve()}}("unknown"===e?0:e,t)}function V(e,t,n,r,a){return K.apply(this,arguments)}function K(){return(K=a()((function*(e,t,n,r,a){var i=yield N(e,t,n,B,r,a),s=i.result,o=i.metric;return"success"===s.status?{result:{status:"success",path:s.result,progressiveDownload:s.progressiveDownload},metric:i.metric}:{result:s,metric:o}}))).apply(this,arguments)}function H(e,t,n,r,a){return $.apply(this,arguments)}function $(){return($=a()((function*(e,t,n,r,a){var i=yield N(e,t,n,j,r,a),s=i.result,o=i.metric;return"success"===s.status?{result:{status:"success",plaintext:s.result},metric:o}:{result:{status:s.status},metric:o}}))).apply(this,arguments)}function q(e,t,n){return"mms3"===e.version?(0,g.h)(e.url):(function(e,t,n){var r=(0,m.e)(e.ciphertextHash);return e.directPath?(0,g.c)("https://"+t,e.directPath,{hash:r,mode:n}):(0,g.c)("https://"+t,`${(0,c.c)(e.type)}/${r}`,{mode:n})})(e,t,n)}},,,,,,,function(e,t,n){n.d(t,"l",(function(){return u})),n.d(t,"n",(function(){return d})),n.d(t,"m",(function(){return c})),n.d(t,"o",(function(){return l})),n.d(t,"b",(function(){return p})),n.d(t,"w",(function(){return h})),n.d(t,"e",(function(){return f})),n.d(t,"f",(function(){return m})),n.d(t,"c",(function(){return v})),n.d(t,"k",(function(){return g})),n.d(t,"p",(function(){return _})),n.d(t,"a",(function(){return E})),n.d(t,"x",(function(){return b})),n.d(t,"q",(function(){return I})),n.d(t,"v",(function(){return w})),n.d(t,"u",(function(){return T})),n.d(t,"d",(function(){return A})),n.d(t,"g",(function(){return O})),n.d(t,"t",(function(){return M})),n.d(t,"s",(function(){return C})),n.d(t,"r",(function(){return R})),n.d(t,"i",(function(){return N})),n.d(t,"h",(function(){return k})),n.d(t,"j",(function(){return P}));var r=n(98),a=n(5),i=n(121),s=n(3),o=n(187);function u(e){return(0,a.i)((0,i.b)().stores.syncActions.get(e))}function d(e){return(0,a.i)((0,i.b)().stores.syncActions.where("indexMac").anyOf(e).toArray())}function c(e){return(0,a.i)((0,i.b)().stores.syncActions.where("collection").anyOf(e).toArray())}function l(e){var t=(0,o.b)(e);return(0,a.i)((0,i.b)().stores.syncKeys.get(t).then(e=>{if(e)return Object.assign({},e,{keyId:(0,o.c)(e.keyId)})}))}function p(){return(0,a.i)((0,i.b)().stores.syncKeys.toArray().then(e=>e.map(e=>Object.assign({},e,{keyId:(0,o.c)(e.keyId)}))))}function h(e){var t=Object.assign({},e,{keyId:(0,o.b)(e.keyId)});return(0,a.i)((0,i.b)().stores.syncKeys.put(t).then(()=>{}))}function f(e){return(0,a.i)((0,i.b)().stores.collectionVersion.get(e)).then(e=>null==e?void 0:e.version)}function m(e){return(0,a.i)((0,i.b)().stores.collectionVersion.where("collection").anyOf(e).toArray().then(t=>new Map(e.map((e,n)=>[e,t[n].version]))))}function v(e){return(0,a.i)((0,i.b)().stores.collectionVersion.get(e).then(e=>null==e?void 0:e.ltHash))}function g(e){return(0,a.i)((0,i.b)().stores.pendingMutations.where("collection").equals(e).toArray())}function _(e){return(0,a.i)((0,i.b)().stores.pendingMutations.where("collection").equals(e).toArray().then(e=>e.length>0))}function E(e){return(0,a.i)((0,i.b)().stores.pendingMutations.bulkPut(e).then(()=>{}))}function b(e,t,n,r,s){var o=(0,i.b)();return(0,a.i)((0,a.c)([o.stores.syncActions.bulkPut(s),o.stores.pendingMutations.bulkDelete(r),o.stores.collectionVersion.get(e).then(e=>{if(null!=e){var r=Object.assign({},e);return r.version=t,r.ltHash=n,o.stores.collectionVersion.put(r)}})]).then(e=>{}))}var y=null;function S(e){if(y)return y;throw new Error(`CollectionStateMachine::${e} called before collection states are initialized`)}function I(){return y||(y=new class{constructor(){this.EJ=new Map}EK(){return(0,a.i)((0,i.b)().stores.collectionVersion.toArray().then(e=>{e.forEach(e=>this.EJ.set(e.collection,{collection:e.collection,state:e.state,finiteFailureStartTime:e.finiteFailureStartTime}))}))}EL(){var e=[];return this.EJ.forEach(t=>e.push(t)),(0,a.i)((0,i.b)().stores.collectionVersion.bulkPut(e).then(()=>{}))}EM(e){e.forEach(e=>this.EJ.set(e,{collection:e,state:r.d.UP_TO_DATE,finiteFailureStartTime:void 0}))}EN(e){var t=this.EJ.get(e);return t?t.state:(T([e]),r.d.UP_TO_DATE)}EO(e){e.forEach(e=>this.EJ.set(e,{collection:e,state:r.d.DIRTY,finiteFailureStartTime:void 0}))}EP(){var e=[];return this.EJ.forEach(t=>{t.state===r.d.DIRTY&&e.push(t.collection)}),e}EQ(e){e.forEach(e=>this.EJ.set(e,{collection:e,state:r.d.FAILING_FINITE_RETRY,finiteFailureStartTime:(0,s.F)()}))}ER(e){e.forEach(e=>this.EJ.set(e,{collection:e,state:r.d.FATAL,finiteFailureStartTime:void 0}))}ES(e){e.forEach(e=>this.EJ.set(e,{collection:e,state:r.d.BLOCKED,finiteFailureStartTime:void 0}))}ET(){var e=[];return this.EJ.forEach(t=>{t.state===r.d.FAILING_FINITE_RETRY&&e.push(t.collection)}),e}EU(){var e=[];return this.EJ.forEach(t=>{t.state===r.d.FATAL&&e.push(t.collection)}),e}EV(){var e=[];return this.EJ.forEach(t=>{var n;t.state===r.d.FAILING_FINITE_RETRY&&(null==t.finiteFailureStartTime?(n=1/0,__LOG__(3)`Collection ${t.collection} is in finite retry state with no failure start time`):n=t.finiteFailureStartTime,n+s.f<(0,s.F)()&&e.push(t.collection))}),e}}),y.EK()}function w(){return S("persistCollectionStateToDb").EL()}function T(e){return S("moveCollectionsToUpToDate").EM(e)}function A(e){return S("getCollectionState").EN(e)}function O(){return S("moveCollectionsToUpToDate").EP()}function M(e){return S("moveCollectionsToUpToDate").EQ(e)}function C(e){return S("moveCollectionsToUpToDate").ER(e)}function R(e){return S("moveCollectionsToUpToDate").ES(e)}function N(){return S("moveCollectionsToUpToDate").ET()}function k(){return S("moveCollectionsToUpToDate").EU()}function P(){return S("moveCollectionsToUpToDate").EV()}},,,function(e,t,n){function r(e){var t,n,r=new ArrayBuffer(e.length),a=new Uint8Array(r);for(t=0,n=e.length;t<n;t++)a[t]=e.charCodeAt(t);return a.buffer}function a(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function i(e,t){var n=new Uint8Array(e);if(t>8388607)throw new Error("Divisor is too big");for(var r=0,a=0;a<n.length;++a)r=((r<<8)+n[a])%t;return r}n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return i}))},,function(e,t,n){n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return d}));var r=n(43),a=n(25),i=n(7),s=n(21),o=n(120);function u(e){for(var t=(0,s.m)(e.map(i.j)),n=new a.a,u=0;u<t.length;u++)n.writeString(t[u]);return Promise.resolve((0,o.a)(n.readByteArray()).then(e=>{var t=new Uint8Array(e,0,6);return"2:"+(0,r.d)(t)}))}function d(e,t){return u(t.map(t=>(0,i.A)(e,t)))}},,,,,function(e,t,n){n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return i}));var r="1",a="2",i={14:"other_harm",15:"spam",21:"other_scam"}},function(e,t,n){n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"b",(function(){return u})),n.d(t,"d",(function(){return d})),n.d(t,"e",(function(){return c}));var r=n(3),a=n(10),i=30*r.b;function s(e,t){var n=new Map(e.knowsSenderKey),r=!1;return t.forEach(e=>{n.get(e)||(n.set(e,!0),r=!0)}),r?Object.assign({},e,{knowsSenderKey:n}):null}function o(e,t){if(e.rotateSenderKey||!1===e.knowsSenderKey.get(t))return null;var n=new Map(e.knowsSenderKey);return n.set(t,!1),(0,a.j)(e,{knowsSenderKey:n})}function u(e){return e.rotateSenderKey||!(0,r.n)(e.senderKeyTimestamp,i)}function d(e){var t=new Map;return Array.from(e.knowsSenderKey.keys()).forEach(e=>{t.set(e,!1)}),(0,a.j)(e,{rotateSenderKey:!1,senderKeyTimestamp:(0,r.E)(),keyIncrement:(e.keyIncrement||0)+1,knowsSenderKey:t})}function c(e,t,n){var r=new Map(e.knowsSenderKey),i=!1;return n.forEach(e=>{r.has(e)&&(i=!0,r.delete(e))}),t.forEach(e=>{r.has(e)||r.set(e,!1)}),(0,a.j)(e,{knowsSenderKey:r,rotateSenderKey:i||e.rotateSenderKey})}},,,,function(e,t,n){n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var r=n(2),a=n(4),i=n(24);function s(e){switch(e.type){case r.f.IMAGE:return"image";case r.f.AUDIO:return"audio";case r.f.PTT:return"ptt";case r.f.VIDEO:return"video";case r.f.GIF:return"gif";case r.f.VCARD:return"vcard";case r.f.LOCATION:return"location";case r.f.DOCUMENT:return"document";case r.f.STICKER:return"sticker";default:return a.d}}function o(e){return(0,i.e)(e)?"media":"text"}},,function(e,t,n){n.d(t,"i",(function(){return y})),n.d(t,"d",(function(){return S})),n.d(t,"j",(function(){return w})),n.d(t,"g",(function(){return O})),n.d(t,"h",(function(){return M})),n.d(t,"b",(function(){return C})),n.d(t,"f",(function(){return R})),n.d(t,"a",(function(){return N})),n.d(t,"c",(function(){return k})),n.d(t,"e",(function(){return P})),n.d(t,"k",(function(){return G})),n.d(t,"l",(function(){return L}));var r=n(9),a=n.n(r),i=n(8),s=n(2),o=n(49),u=n(7),d=n(3),c=n(6),l=n(10),p=n(15),h=n(215),f=n(21),m=n(5),v=n(51),g=n(68),_=n(30),E=n(16),b=n(23);function y(e,t){var n=e.participants,r=e.jid,a=e.title,i=e.titleTs,s=e.description,o=e.descriptionId,u=e.creatorJid,c=e.creationTs,l=e.locked,p=e.announcement,h=[],m=[],v=[];return n.forEach(e=>{var t=e.jid,n=e.type;"superadmin"===n?(h.push(t),m.push(t)):"admin"===n&&m.push(t),v.push(t)}),h=f.m(h),m=f.m(m),v=f.m(v),{groupInfo:{jid:r,title:a,titleTs:i,description:s,descriptionId:o,creatorJid:u,creationTs:c,locked:l,announcement:p,messaged:!1,isAdmin:!1,isInTheGroup:!1,expiration:null,communityInfo:"parent"},participantsInfo:{jid:r,superadmins:h,admins:m,participants:v,invitations:[],knowsSenderKey:Z(t),rotateSenderKey:!0,senderKeyTimestamp:d.c}}}function S(e,t,n){var r,a,i,l=e.participants,m=e.jid,v=e.description,g=e.descriptionId,_=e.creatorJid,E=e.creationTs,b=e.locked,y=e.announcement,S=e.expiration,I=e.support,w=e.communityInfo,T=[],A=[],O=[];if(l.forEach(e=>{var t=e.jid,n=e.type;"superadmin"===n?(T.push(t),A.push(t)):"admin"===n&&A.push(t),O.push(t)}),n.delete((0,u.e)(c.r.get())),T=f.m(T),A=f.m(A),O=f.m(O),t){var M=t.participantsInfo,C=M.knowsSenderKey;Array.from(C.keys()).some(e=>!n.has(e))?(a=!0,r=Z(n),i=M.senderKeyTimestamp):(a=M.rotateSenderKey,i=M.senderKeyTimestamp,r=new Map,n.forEach(e=>{r.set(e,C.get(e)||!1)}))}else r=Z(n),a=!0,i=d.c;var R={jid:m,superadmins:T,admins:A,participants:O,invitations:(null==t?void 0:t.participantsInfo.invitations)||[],knowsSenderKey:r,rotateSenderKey:a,senderKeyTimestamp:i};t&&t.participantsInfo.keyIncrement&&(R.keyIncrement=t.participantsInfo.keyIncrement);var N=e.title,k=e.titleTs;t&&null!=t.groupInfo.titleTs&&t.groupInfo.titleTs>k&&(N=t.groupInfo.title,k=t.groupInfo.titleTs);var P={jid:m,title:N,titleTs:k,description:v,descriptionId:g,creatorJid:_,creationTs:E,locked:b,announcement:y,messaged:null!=t&&t.groupInfo.messaged,isAdmin:(0,h.a)(R),isInTheGroup:(0,h.b)(R),expiration:S,communityInfo:w};null!=e.growthLocked&&(P.growthLocked=e.growthLocked),I&&(P.support=I);var G=[];t||G.push({externalId:"/create/"+m,ts:E,author:(0,o.j)(_),ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:"create",title:N,altIndex:""}),t&&t.groupInfo.expiration!==S&&(void 0!==t.groupInfo.expiration||null!==S)&&G.push({externalId:"/ephemeral/"+m,ts:E,author:s.b,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:"ephemeral_authorless",expiration:S,altIndex:""});var L,D=e.addInfo,x=c.r.get();if(!D||D.author===s.b||!D.participants.includes(x)||t&&t.participantsInfo.participants.includes(x)||(D.isInvite?(L="invite",P.messaged=!0):L=D.hasAccepted?"accept":"add",G.push({externalId:"/add/"+D.id,ts:D.ts,author:D.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:L,involvesMe:!0,participants:[],altIndex:""})),t){var U=z(t.groupInfo.growthLocked,e.growthLocked,P.isAdmin,(0,u.n)(e.jid),e.creationTs);U&&U.msg&&G.push(U.msg)}return{groupInfo:P,participantsInfo:R,notificationMessages:G}}var I={add:function(e,t,n){var r=e.participantsInfo.participants,a=e.participantsInfo.knowsSenderKey,i=f.n(f.m(t.participants),r),o=(0,u.e)(c.r.get()),d=[];if(n.forEach(e=>{a.has(e)||e===o||d.push(e)}),0===i.length&&0===d.length)return null;var l=f.j(r,i),m=Y(i),v=m.involvesMe,g=m.others,_=new Map(a);d.forEach(e=>_.set(e,!1));var E="add";t.isInvite&&(v?0===g.length:1===g.length)?E="invite":t.hasAccepted&&t.author===s.b&&(E="accept");var b=Object.assign({},e.participantsInfo,{participants:l,knowsSenderKey:_});return{groupInfo:Object.assign({},e.groupInfo,{isInTheGroup:(0,h.b)(b)}),participantsInfo:b,msg:{externalId:"/add/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:E,involvesMe:v,participants:g,altIndex:""}}},remove:T,promote:function(e,t){var n=e.participantsInfo.admins,r=f.h(f.m(t.participants),e.participantsInfo.participants),a=f.n(r,n);if(0===a.length)return null;var i=f.j(a,n),o=Y(a),u=o.involvesMe,d=o.others,c=Object.assign({},e.participantsInfo,{admins:i});return{groupInfo:Object.assign({},e.groupInfo,{isAdmin:(0,h.a)(c)}),participantsInfo:c,msg:u?{externalId:"/promote/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:"promote",involvesMe:u,participants:d,altIndex:""}:null}},demote:function(e,t){var n=e.participantsInfo.admins,r=f.h(f.m(t.participants),n);if(0===r.length)return null;var a=f.n(n,r),i=Y(r),o=i.involvesMe,u=i.others,d=Object.assign({},e.participantsInfo,{admins:a,invitations:o?[]:e.participantsInfo.invitations});return{groupInfo:Object.assign({},e.groupInfo,{isAdmin:(0,h.a)(d)}),participantsInfo:d,msg:o?{externalId:"/demote/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:"demote",involvesMe:o,participants:u,altIndex:""}:null}},delete:function(e,t,n){var r=T(e,t,n);return r?Object.assign({},r,{msg:{externalId:"/deletion/"+t.id,ts:t.ts,author:s.c,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:r.groupInfo.support?"closed":"delete",altIndex:""}}):null}};function w(e,t,n){var r=n.author===c.r.get()?Object.assign({},n,{author:s.b}):n;return(0,i.c)("runGeneralGroupAction",n=>(function(e,t,n,r){return __LOG__(2)`runGeneralGroupAction ${t} on ${n}`,e.table.transact("rw",["groups","groupParticipantsInfo","msgs","chats","contacts"],()=>e.table.getGroupInfoWithParticipantsInTransaction(n).then(a=>{if(!a)return __LOG__(2)`runGeneralGroupAction ${t} on non-existent ${n}`,null;switch(t){case"add":case"remove":case"delete":return e.table.getDevicesInTransaction(r.participants).then(e=>I[t](a,r,e));default:return I[t](a,r)}}).then(r=>r?(function(e,t){var n=t.groupInfo,r=t.participantsInfo,i=t.msg,s=(0,m.c)([e.table.setGroupInfo(n),e.table.setParticipantsInfo(r)]);return i?(0,m.c)([e.addGroupSystemMsgWithResult(n.chatId,i,{groupInfo:n,participantsInfo:r}),s]).then(e=>a()(e,1)[0]):s.then(()=>e.table.getChatInTransaction(n.chatId).then(e=>({result:"updated_chat",chat:(0,v.a)(e,{groupInfo:n,participantsInfo:r})})))})(e,r):(__LOG__(2)`runGeneralGroupAction ${t} on ${n} had no change`,null)))})(n,e,t,r),t=>{null!=t&&("updated_chat"===t.result?(0,g.e)(t):(0,g.c)(t),"add"===e&&(0,_.b)().fireAndForget(E.e.syncDeviceList((0,f.m)(n.participants))))})}function T(e,t,n){var r=e.participantsInfo.participants,a=e.participantsInfo.knowsSenderKey,i=f.h(f.m(t.participants),r),o=[];if(n.forEach(e=>{a.has(e)&&o.push(e)}),0===i.length&&0===o.length)return null;var u=f.n(e.participantsInfo.superadmins,i),d=f.n(e.participantsInfo.admins,i),c=f.n(r,i),l=Y(i),m=l.involvesMe,v=l.others,g=new Map(a);o.forEach(e=>g.delete(e));var _=Object.assign({},e.participantsInfo,{superadmins:u,admins:d,participants:c,invitations:m?[]:e.participantsInfo.invitations,knowsSenderKey:g,rotateSenderKey:!0});return{groupInfo:Object.assign({},e.groupInfo,{isAdmin:(0,h.a)(_),isInTheGroup:(0,h.b)(_)}),participantsInfo:_,msg:{externalId:"/delete/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:J(t.author,m,v)?"leave":"remove",involvesMe:m,participants:v,altIndex:""}}}function A(e,t,n,r){return e.table.transact("rw",["groups","groupParticipantsInfo","msgs","chats"],()=>e.table.getGroupInfoWithParticipantsInTransaction(t).then(i=>{if(!i)return __LOG__(2)`groupChanged for non existent group ${t}`,null;var s=i.groupInfo.chatId,o=n(i,r);if(!o)return null;var u=o.groupInfo,d=o.participantsInfo,c=o.msg,l=i,p=[];return u&&(l.groupInfo=u,p.push(e.table.setGroupInfo(u))),d&&(l.participantsInfo=d,p.push(e.table.setParticipantsInfo(d))),(0,m.c)([c&&e.addGroupSystemMsgWithResult(s,c,l),...p]).then(e=>a()(e,1)[0])}))}function O(e,t){return(0,i.c)("groupMemberModified",n=>A(n,e,D,t),g.c)}function M(e,t){return(0,i.c)("groupSubjectChanged",n=>A(n,e,x,t),g.c)}function C(e,t){return(0,i.c)("groupDescriptionChanged",n=>A(n,e,U,t),g.c).then(()=>{})}function R(e,t){return(0,i.c)("groupLockedChanged",n=>A(n,e,F,t),g.c)}function N(e,t){return(0,i.c)("groupAnnouncementChanged",n=>A(n,e,B,t),g.c)}function k(e,t){return(0,i.c)("groupEphemeralSettingChange",n=>A(n,e,j,t),g.c)}function P(e,t){return(0,i.c)("groupInviteCodeChanged",n=>A(n,e,V,t),g.c)}function G(e,t){return(0,i.c)("setGroupGrowthLocked",n=>A(n,e,K,t),g.c)}function L(e,t){return(0,i.c)("setGroupGrowthUnlocked",n=>A(n,e,$,t),g.c)}function D(e,t){var n=e.participantsInfo.participants,r=f.h(f.l(t.changedFrom),n),a=f.n(f.l(t.changedTo),n);if(0===r.length&&0===a.length)return null;var i=f.j(a,f.n(n,r)),o=f.o(e.participantsInfo.admins,t.changedFrom,t.changedTo),u=f.o(e.participantsInfo.superadmins,t.changedFrom,t.changedTo);return{participantsInfo:Object.assign({},e.participantsInfo,{superadmins:u,admins:o,participants:i,knowsSenderKey:W(i),rotateSenderKey:!0}),groupInfo:null,msg:{externalId:"/modify/"+t.id,ts:t.ts,author:t.changedTo,participants:[t.changedFrom],ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:"modify",altIndex:""}}}function x(e,t){return t.subject===e.groupInfo.title||null!=e.groupInfo.titleTs&&e.groupInfo.titleTs>t.subjectTs?null:{groupInfo:(0,l.j)(e.groupInfo,{title:t.subject,titleTs:t.subjectTs}),participantsInfo:null,msg:{externalId:"/subject/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,title:t.subject,subtype:"subject",altIndex:""}}}function U(e,t){if(t.deleted&&t.descriptionId!==e.groupInfo.descriptionId||!t.deleted&&t.descriptionId===e.groupInfo.descriptionId)return null;var n=t.deleted?"description_remove":"description";return{groupInfo:(0,l.j)(e.groupInfo,{description:t.description,descriptionId:t.deleted?null:t.descriptionId}),participantsInfo:null,msg:{externalId:"/description/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:n,altIndex:""}}}function F(e,t){if(t.locked===e.groupInfo.locked)return null;var n=t.locked?"locked":"unlocked";return{groupInfo:(0,l.j)(e.groupInfo,{locked:t.locked}),participantsInfo:null,msg:{externalId:"/locked/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:n,altIndex:""}}}function B(e,t){if(t.announcement===e.groupInfo.announcement)return null;var n=t.announcement?"announcement":"not_announcement";return{groupInfo:(0,l.j)(e.groupInfo,{announcement:t.announcement}),participantsInfo:null,msg:{externalId:"/announcement/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:n,altIndex:""}}}function j(e,t){return e.groupInfo.expiration===t.expiration||void 0===e.groupInfo.expiration&&null==t.expiration?null:{groupInfo:Object.assign({},e.groupInfo,{expiration:t.expiration}),participantsInfo:null,msg:{externalId:"/ephemeral/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:"ephemeral",expiration:t.expiration,altIndex:""}}}function V(e,t){return{groupInfo:e.groupInfo,participantsInfo:null,msg:{externalId:"/revoke_invite/"+t.id,ts:t.ts,author:t.author,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:"revoke_invite",altIndex:""}}}function K(e,t){var n=e.groupInfo,r=z(n.growthLocked,t.growthLocked,n.isAdmin,t.id,t.ts);if(r){var a=r.msg,i=r.growthLocked;return{groupInfo:Object.assign({},n,{growthLocked:i}),participantsInfo:null,msg:a}}}function H(e,t,n){if((0,b.a)("growth_lock_v0_enabled"))return{externalId:`/growth_locked/${n.type}/${e}`,ts:t,author:s.c,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:"growth_locked",growthLocked:n,altIndex:""}}function $(e,t){var n=e.groupInfo,r=z(n.growthLocked,void 0,n.isAdmin,t.id,t.ts);if(r){var a=r.msg,i=r.growthLocked;return{groupInfo:Object.assign({},n,{growthLocked:i}),participantsInfo:null,msg:a}}}function q(e,t){if((0,b.a)("growth_lock_v0_enabled"))return{externalId:"/growth_unlocked/"+e,ts:t,author:s.c,ack:p.a.RECEIVED,type:s.f.GROUP_NOTIFICATION,subtype:"growth_unlocked",altIndex:""}}function z(e,t,n,r,a){if(null!=t){if(null!=e&&e.type===t.type){var i=e.expiration;if(t.expiration<=i)return;return{growthLocked:t}}return{growthLocked:t,msg:n?H(r,a,t):void 0}}if(null!=e)return{growthLocked:t,msg:n?q(r,a):void 0}}function J(e,t,n){return e===s.b?t&&0===n.length:!t&&1===n.length&&n[0]===e}function Y(e){var t=c.r.get(),n=e.filter(e=>e!==t);return{involvesMe:e.length!==n.length,others:n}}function W(e){var t=c.r.get(),n=new Map;return e.forEach(e=>{e!==t&&n.set((0,u.e)(e),!1)}),n}function Z(e){return new Map(Array.from(e).map(e=>[e,!1]))}},,,,,function(e,t,n){n.d(t,"a",(function(){return I})),n.d(t,"b",(function(){return w})),n.d(t,"c",(function(){return T})),n.d(t,"e",(function(){return A})),n.d(t,"d",(function(){return O}));var r=n(9),a=n.n(r),i=n(15),s=n(10),o=n(64),u=n(51),d=n(5),c=n(7),l=n(2),p=n(77),h=n(58),f=n(205),m=n(42),v=n(65),g=n(53),_=n(24),E=n(68),b=n(30),y=n(16),S=n(8);function I(e,t,n){return e.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo","media","receipts","meta","previews","reactions"],()=>T(e,t,n))}function w(e,t){return e.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo","media","receipts","meta","previews","status","authors","reactions"],()=>(0,d.l)(e.table.stores.media,"msgIds").anyOf(t).toArray().then(t=>{var n=new Set,r=[];t.forEach(e=>e.msgIds.forEach(e=>{var t=(0,i.z)(e);"chat"===t.type?n.add(t.msgId):r.push(t.msgId)}));var a=new Map;n.forEach(e=>{var t=(0,i.w)(e),n=a.get(t)||[];n.push(e),a.set(t,n)});var s=[];return a.forEach((t,n)=>{s.push(()=>T(e,n,t))}),(0,v.b)(e,r).then(()=>(0,d.f)(s))}))}function T(e,t,n){var r=new Set,s=[];return n.forEach(e=>{(0,i.w)(e)===t?(s.push(e),r.add(e)):__LOG__(3)`Tried to delete ${e} from different chat ${t}. Skipping`}),e.table.getAllMsgsFromIds(s).then(n=>(0,d.c)([e.table.getChatInTransaction(t),(0,m.L)(e.table.stores,(0,g.e)(n),!1),e.table.stores.msgs.bulkDelete(n.map(e=>e.rowId)),e.table.stores.receipts.bulkDelete(s),e.table.stores.previews.bulkDelete(s),e.table.stores.previews.bulkDelete(s.map(i.F)),e.table.stores.reactions.where("msgId").anyOf(s).delete()]).then(t=>{var i,s,o,u,c=a()(t,2),l=c[0],p=c[1],h=l.newest,m=l.oldest,v=l.oldestUnread;return i=m&&h&&r.has(l.newest)?e.table.stores.msgs.where("id").between(m,h,!0,!1).reverse().first().then(e=>e?e.id:void 0):h,s=m&&h&&l.previewMsg&&r.has(l.previewMsg.id)?e.table.stores.msgs.where("id").between(m,h,!0,!1).filter(e=>(0,g.k)(e)>g.a.GARBAGE).reverse().first().then(e=>e&&(0,f.a)(e)||void 0):l.previewMsg,o=m&&h&&r.has(m)?e.table.stores.msgs.where("id").between(m,h,!1,!0).first().then(e=>e?e.id:void 0):m,u=v&&h&&r.has(v)?e.table.stores.msgs.where("id").between(v,h,!1,!0).toArray().then(e=>{var t=e.find(g.i);return t?t.id:void 0}):v,(0,d.c)([l,n,p,i,s,o,u])}).then(t=>{var n=a()(t,7),r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],l=n[5],p=n[6];i.forEach(e=>{r.msgCount--,r.oldestUnread&&e.id>=r.oldestUnread&&(0,g.i)(e)&&r.unreadMsgCount--,(0,g.n)(r,e)&&null!=r.importantMsgCount&&r.importantMsgCount--,e.starred&&null!=r.starredMsgCount&&r.starredMsgCount--,e.kept&&null!=r.keptMsgCount&&r.keptMsgCount--}),null!=r.starredMsgCount&&r.starredMsgCount<=0&&delete r.starredMsgCount,null!=r.keptMsgCount&&r.keptMsgCount<=0&&delete r.keptMsgCount,null!=r.importantMsgCount&&r.importantMsgCount<=0&&delete r.importantMsgCount,r.newest=o,r.oldest=l,r.oldestUnread=p,r.previewMsg=u;var h=(0,c.p)(r.jid),f=null!=h?e.table.getGroupInfoWithParticipantsInTransaction(h):void 0;return(0,d.c)([r,f,s,e.table.updateChat(r)])}).then(e=>{var t=a()(e,3),n=t[0],r=t[1],i=t[2];return{chat:(0,u.a)(n,r),msgIds:s,deletedMediaStats:i}}))}function A(e,t){return(0,S.c)("revokeChatMsgs",n=>(function(e,t,n){return e.table.transact("rw",["groups","groupParticipantsInfo","msgs","receipts","chats","media","meta","previews","reactions"],()=>(0,d.c)([e.table.getAllMsgsFromIds(n),e.table.getChatAndGroupInTransaction(t)]).then(n=>{var r=a()(n,2),c=r[0],f=r[1];if(!f)return __LOG__(3)`Ignoring revoke for inexisting chat ${t}.`,[];var v=f.dbChat,_=f.dbGroup,E={},b={},y=[],S=[],I=[],w=v.starredMsgCount,T=v.keptMsgCount,A=v.importantMsgCount;c.forEach(e=>{if(e.author!==l.b)return __LOG__(4)`Tried to revoke ${e.id} from other author. Skipping`,void SEND_LOGS("Tried to revoke message from other author.");S.push(e.id),e.type!==l.f.REVOKED?(null!=e.starred&&null!=v.starredMsgCount&&v.starredMsgCount--,null!=e.kept&&null!=v.keptMsgCount&&v.keptMsgCount--,null!=v.importantMsgCount&&(0,g.n)(v,e)&&v.importantMsgCount--,y.push(e.id),b[e.id]={rowId:e.rowId,id:e.id,chat:e.chat,ts:e.ts,type:l.f.REVOKED,externalId:(0,g.t)(),author:l.b,ack:l.a.CLOCK,revokedExternalId:e.externalId,chatJid:v.jid,altIndex:(0,o.b)("revoked",e.id),validUntil:null!=e.kept?e.keptValidUntil:e.validUntil},I.push((0,i.F)(e.id))):E[e.id]=e});var O=(0,s.x)(b),M=e.table.resetReceiptsOnRevokedInTransaction(S);0===v.starredMsgCount&&delete v.starredMsgCount,0===v.keptMsgCount&&delete v.keptMsgCount,null!=v.importantMsgCount&&v.importantMsgCount<=0&&delete v.importantMsgCount;var C=(0,o.h)(v,O)||w!==v.starredMsgCount||T!==v.keptMsgCount||A!==v.importantMsgCount?e.table.updateChat(v).then(()=>v):(0,d.e)(v),R=e.table.stores.msgs.bulkPut(O),N=(0,m.L)(e.table.stores,(0,g.e)(c),!1),k=e.table.stores.previews.bulkDelete(y),P=e.table.stores.previews.bulkDelete(I),G=e.table.stores.reactions.where("msgId").anyOf(y).delete();return(0,d.c)([M,C,R,N,k,P,G]).then(e=>{var t=a()(e,2),n=t[0],r=t[1],i=(0,s.s)(n,e=>e.msgId),o=(0,u.a)(r,_);return S.map(e=>{var t,n;E[e]?(n="deduped",t=E[e]):(n="revoked",t=b[e]);var r=i[t.id];return{result:n,chat:o,msg:(0,h.c)(t),dbMsg:t,outgoingTo:r&&(0,p.d)(r),updatedContact:null,shouldDownloadMmsThumb:!1}})})}))})(n,e,t),e=>((0,E.d)(e),(0,b.b)().fireAndForget(y.e.removeDeadMediaContent("revoke-msgs")),e))}function O(e,t,n,r,s){var u=Object.assign({},s,{rowId:r.rowId,id:r.id,ts:r.ts,author:r.author,chat:r.chat,validUntil:null!=r.kept?r.keptValidUntil:r.validUntil,altIndex:(0,o.b)("revoked",r.id)}),c=!1;null!=r.starred&&null!=t.starredMsgCount&&(t.starredMsgCount--,c=!0,0===t.starredMsgCount&&delete t.starredMsgCount);var l=!1;null!=r.kept&&null!=t.keptMsgCount&&(t.keptMsgCount--,l=!0,0===t.keptMsgCount&&delete t.keptMsgCount);var p=!1;(0,g.n)(t,r)&&null!=t.importantMsgCount&&(t.importantMsgCount--,p=!0,t.importantMsgCount<=0&&delete t.importantMsgCount);var h=(0,o.g)(t,u)||c||p||l?e.table.updateChat(t).then(()=>t):(0,d.e)(t);return(0,d.c)([h,e.table.stores.msgs.put(u),(0,_.e)(r)&&(0,m.L)(e.table.stores,[r],!1),e.table.stores.previews.delete(r.id),e.table.stores.previews.delete((0,i.F)(r.id)),e.table.stores.reactions.where("msgId").equals(r.id).delete()]).then(e=>({result:"revoked",dbChat:a()(e,1)[0],dbGroup:n,dbMsg:u,outgoingTo:null,shouldDownloadMmsThumb:!1}))}},,,,,,,function(e,t,n){n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){return i}));var r=2,a=["xmlstreamstart","xmlstreamend","s.whatsapp.net","type","participant","from","receipt","id","broadcast","status","message","notification","notify","to","jid","user","class","offline","g.us","result","mediatype","enc","skmsg","off_cnt","xmlns","presence","participants","ack","t","iq","device_hash","read","value","media","picture","chatstate","unavailable","text","urn:xmpp:whatsapp:push","devices","verified_name","contact","composing","edge_routing","routing_info","item","image","verified_level","get","fallback_hostname","2","media_conn","1","v","handshake","fallback_class","count","config","offline_preview","download_buckets","w:profile:picture","set","creation","location","fallback_ip4","msg","urn:xmpp:ping","fallback_ip6","call-creator","relaylatency","success","subscribe","video","business_hours_config","platform","hostname","version","unknown","0","ping","hash","edit","subject","max_buckets","download","delivery","props","sticker","name","last","contacts","business","primary","preview","w:p","pkmsg","call-id","retry","prop","call","auth_ttl","available","relay_id","last_id","day_of_week","w","host","seen","bits","list","atn","upload","is_new","w:stats","key","paused","specific_hours","multicast","stream:error","mmg.whatsapp.net","code","deny","played","profile","fna","device-list","close_time","latency","gcm","pop","audio","26","w:web","open_time","error","auth","ip4","update","profile_options","config_value","category","catalog_not_created","00","config_code","mode","catalog_status","ip6","blocklist","registration","7","web","fail","w:m","cart_enabled","ttl","gif","300","device_orientation","identity","query","401","media-gig2-1.cdn.whatsapp.net","in","3","te2","add","fallback","categories","ptt","encrypt","notice","thumbnail-document","item-not-found","12","thumbnail-image","stage","thumbnail-link","usync","out","thumbnail-video","8","01","context","sidelist","thumbnail-gif","terminate","not-authorized","orientation","dhash","capability","side_list","md-app-state","description","serial","readreceipts","te","business_hours","md-msg-hist","tag","attribute_padding","document","open_24h","delete","expiration","active","prev_v_id","true","passive","index","4","conflict","remove","w:gp2","config_expo_key","screen_height","replaced","02","screen_width","uploadfieldstat","2:47DEQpj8","media-bog1-1.cdn.whatsapp.net","encopt","url","catalog_exists","keygen","rate","offer","opus","media-mia3-1.cdn.whatsapp.net","privacy","media-mia3-2.cdn.whatsapp.net","signature","preaccept","token_id","media-eze1-1.cdn.whatsapp.net"],i=[["media-for1-1.cdn.whatsapp.net","relay","media-gru2-2.cdn.whatsapp.net","uncompressed","medium","voip_settings","device","reason","media-lim1-1.cdn.whatsapp.net","media-qro1-2.cdn.whatsapp.net","media-gru1-2.cdn.whatsapp.net","action","features","media-gru2-1.cdn.whatsapp.net","media-gru1-1.cdn.whatsapp.net","media-otp1-1.cdn.whatsapp.net","kyc-id","priority","phash","mute","token","100","media-qro1-1.cdn.whatsapp.net","none","media-mrs2-2.cdn.whatsapp.net","sign_credential","03","media-mrs2-1.cdn.whatsapp.net","protocol","timezone","transport","eph_setting","1080","original_dimensions","media-frx5-1.cdn.whatsapp.net","background","disable","original_image_url","5","transaction-id","direct_path","103","appointment_only","request_image_url","peer_pid","address","105","104","102","media-cdt1-1.cdn.whatsapp.net","101","109","110","106","background_location","v_id","sync","status-old","111","107","ppic","media-scl2-1.cdn.whatsapp.net","business_profile","108","invite","04","audio_duration","media-mct1-1.cdn.whatsapp.net","media-cdg2-1.cdn.whatsapp.net","media-los2-1.cdn.whatsapp.net","invis","net","voip_payload_type","status-revoke-delay","404","state","use_correct_order_for_hmac_sha1","ver","media-mad1-1.cdn.whatsapp.net","order","540","skey","blinded_credential","android","contact_remove","enable_downlink_relay_latency_only","duration","enable_vid_one_way_codec_nego","6","media-sof1-1.cdn.whatsapp.net","accept","all","signed_credential","media-atl3-1.cdn.whatsapp.net","media-lhr8-1.cdn.whatsapp.net","website","05","latitude","media-dfw5-1.cdn.whatsapp.net","forbidden","enable_audio_piggyback_network_mtu_fix","media-dfw5-2.cdn.whatsapp.net","note.m4r","media-atl3-2.cdn.whatsapp.net","jb_nack_discard_count_fix","longitude","Opening.m4r","media-arn2-1.cdn.whatsapp.net","email","timestamp","admin","media-pmo1-1.cdn.whatsapp.net","America/Sao_Paulo","contact_add","media-sin6-1.cdn.whatsapp.net","interactive","8000","acs_public_key","sigquit_anr_detector_release_rollover_percent","media.fmed1-2.fna.whatsapp.net","groupadd","enabled_for_video_upgrade","latency_update_threshold","media-frt3-2.cdn.whatsapp.net","calls_row_constraint_layout","media.fgbb2-1.fna.whatsapp.net","mms4_media_retry_notification_encryption_enabled","timeout","media-sin6-3.cdn.whatsapp.net","audio_nack_jitter_multiplier","jb_discard_count_adjust_pct_rc","audio_reserve_bps","delta","account_sync","default","media.fjed4-6.fna.whatsapp.net","06","lock_video_orientation","media-frt3-1.cdn.whatsapp.net","w:g2","media-sin6-2.cdn.whatsapp.net","audio_nack_algo_mask","media.fgbb2-2.fna.whatsapp.net","media.fmed1-1.fna.whatsapp.net","cond_range_target_bitrate","mms4_server_error_receipt_encryption_enabled","vid_rc_dyn","fri","cart_v1_1_order_message_changes_enabled","reg_push","jb_hist_deposit_value","privatestats","media.fist7-2.fna.whatsapp.net","thu","jb_discard_count_adjust_pct","mon","group_call_video_maximization_enabled","mms_cat_v1_forward_hot_override_enabled","audio_nack_new_rtt","media.fsub2-3.fna.whatsapp.net","media_upload_aggressive_retry_exponential_backoff_enabled","tue","wed","media.fruh4-2.fna.whatsapp.net","audio_nack_max_seq_req","max_rtp_audio_packet_resends","jb_hist_max_cdf_value","07","audio_nack_max_jb_delay","mms_forward_partially_downloaded_video","media-lcy1-1.cdn.whatsapp.net","resume","jb_inband_fec_aware","new_commerce_entry_point_enabled","480","payments_upi_generate_qr_amount_limit","sigquit_anr_detector_rollover_percent","media.fsdu2-1.fna.whatsapp.net","fbns","aud_pkt_reorder_pct","dec","stop_probing_before_accept_send","media_upload_max_aggressive_retries","edit_business_profile_new_mode_enabled","media.fhex4-1.fna.whatsapp.net","media.fjed4-3.fna.whatsapp.net","sigquit_anr_detector_64bit_rollover_percent","cond_range_ema_jb_last_delay","watls_enable_early_data_http_get","media.fsdu2-2.fna.whatsapp.net","message_qr_disambiguation_enabled","media-mxp1-1.cdn.whatsapp.net","sat","vertical","media.fruh4-5.fna.whatsapp.net","200","media-sof1-2.cdn.whatsapp.net","-1","height","product_catalog_hide_show_items_enabled","deep_copy_frm_last","tsoffline","vp8/h.264","media.fgye5-3.fna.whatsapp.net","media.ftuc1-2.fna.whatsapp.net","smb_upsell_chat_banner_enabled","canonical","08","9",".","media.fgyd4-4.fna.whatsapp.net","media.fsti4-1.fna.whatsapp.net","mms_vcache_aggregation_enabled","mms_hot_content_timespan_in_seconds","nse_ver","rte","third_party_sticker_web_sync","cond_range_target_total_bitrate","media_upload_aggressive_retry_enabled","instrument_spam_report_enabled","disable_reconnect_tone","move_media_folder_from_sister_app","one_tap_calling_in_group_chat_size","10","storage_mgmt_banner_threshold_mb","enable_backup_passive_mode","sharechat_inline_player_enabled","media.fcnq2-1.fna.whatsapp.net","media.fhex4-2.fna.whatsapp.net","media.fist6-3.fna.whatsapp.net","ephemeral_drop_column_stage","reconnecting_after_network_change_threshold_ms","media-lhr8-2.cdn.whatsapp.net","cond_jb_last_delay_ema_alpha","entry_point_block_logging_enabled","critical_event_upload_log_config","respect_initial_bitrate_estimate","smaller_image_thumbs_status_enabled","media.fbtz1-4.fna.whatsapp.net","media.fjed4-1.fna.whatsapp.net","width","720","enable_frame_dropper","enable_one_side_mode","urn:xmpp:whatsapp:dirty","new_sticker_animation_behavior_v2","media.flim3-2.fna.whatsapp.net","media.fuio6-2.fna.whatsapp.net","skip_forced_signaling","dleq_proof","status_video_max_bitrate","lazy_send_probing_req","enhanced_storage_management","android_privatestats_endpoint_dit_enabled","media.fscl13-2.fna.whatsapp.net","video_duration"],["group_call_discoverability_enabled","media.faep9-2.fna.whatsapp.net","msgr","bloks_loggedin_access_app_id","db_status_migration_step","watls_prefer_ip6","jabber:iq:privacy","68","media.fsaw1-11.fna.whatsapp.net","mms4_media_conn_persist_enabled","animated_stickers_thread_clean_up","media.fcgk3-2.fna.whatsapp.net","media.fcgk4-6.fna.whatsapp.net","media.fgye5-2.fna.whatsapp.net","media.flpb1-1.fna.whatsapp.net","media.fsub2-1.fna.whatsapp.net","media.fuio6-3.fna.whatsapp.net","not-allowed","partial_pjpeg_bw_threshold","cap_estimated_bitrate","mms_chatd_resume_check_over_thrift","smb_upsell_business_profile_enabled","product_catalog_webclient","groups","sigquit_anr_detector_release_updated_rollout","syncd_key_rotation_enabled","media.fdmm2-1.fna.whatsapp.net","media-hou1-1.cdn.whatsapp.net","remove_old_chat_notifications","smb_biztools_deeplink_enabled","use_downloadable_filters_int","group_qr_codes_enabled","max_receipt_processing_time","optimistic_image_processing_enabled","smaller_video_thumbs_status_enabled","watls_early_data","reconnecting_before_relay_failover_threshold_ms","cond_range_packet_loss_pct","groups_privacy_blacklist","status-revoke-drop","stickers_animated_thumbnail_download","dedupe_transcode_shared_images","dedupe_transcode_shared_videos","media.fcnq2-2.fna.whatsapp.net","media.fgyd4-1.fna.whatsapp.net","media.fist7-1.fna.whatsapp.net","media.flim3-3.fna.whatsapp.net","add_contact_by_qr_enabled","https://faq.whatsapp.com/payments","multicast_limit_global","sticker_notification_preview","smb_better_catalog_list_adapters_enabled","bloks_use_minscript_android","pen_smoothing_enabled","media.fcgk4-5.fna.whatsapp.net","media.fevn1-3.fna.whatsapp.net","media.fpoj7-1.fna.whatsapp.net","media-arn2-2.cdn.whatsapp.net","reconnecting_before_network_change_threshold_ms","android_media_use_fresco_for_gifs","cond_in_congestion","status_image_max_edge","sticker_search_enabled","starred_stickers_web_sync","db_blank_me_jid_migration_step","media.fist6-2.fna.whatsapp.net","media.ftuc1-1.fna.whatsapp.net","09","anr_fast_logs_upload_rollout","camera_core_integration_enabled","11","third_party_sticker_caching","thread_dump_contact_support","wam_privatestats_enabled","vcard_as_document_size_kb","maxfpp","fbip","ephemeral_allow_group_members","media-bom1-2.cdn.whatsapp.net","media-xsp1-1.cdn.whatsapp.net","disable_prewarm","frequently_forwarded_max","media.fbtz1-5.fna.whatsapp.net","media.fevn7-1.fna.whatsapp.net","media.fgyd4-2.fna.whatsapp.net","sticker_tray_animation_fully_visible_items","green_alert_banner_duration","reconnecting_after_p2p_failover_threshold_ms","connected","share_biz_vcard_enabled","stickers_animation","0a","1200","WhatsApp","group_description_length","p_v_id","payments_upi_intent_transaction_limit","frequently_forwarded_messages","media-xsp1-2.cdn.whatsapp.net","media.faep8-1.fna.whatsapp.net","media.faep8-2.fna.whatsapp.net","media.faep9-1.fna.whatsapp.net","media.fdmm2-2.fna.whatsapp.net","media.fgzt3-1.fna.whatsapp.net","media.flim4-2.fna.whatsapp.net","media.frao1-1.fna.whatsapp.net","media.fscl9-2.fna.whatsapp.net","media.fsub2-2.fna.whatsapp.net","superadmin","media.fbog10-1.fna.whatsapp.net","media.fcgh28-1.fna.whatsapp.net","media.fjdo10-1.fna.whatsapp.net","third_party_animated_sticker_import","delay_fec","attachment_picker_refresh","android_linked_devices_re_auth_enabled","rc_dyn","green_alert_block_jitter","add_contact_logging_enabled","biz_message_logging_enabled","conversation_media_preview_v2","media-jnb1-1.cdn.whatsapp.net","ab_key","media.fcgk4-2.fna.whatsapp.net","media.fevn1-1.fna.whatsapp.net","media.fist6-1.fna.whatsapp.net","media.fruh4-4.fna.whatsapp.net","media.fsti4-2.fna.whatsapp.net","mms_vcard_autodownload_size_kb","watls_enabled","notif_ch_override_off","media.fsaw1-14.fna.whatsapp.net","media.fscl13-1.fna.whatsapp.net","db_group_participant_migration_step","1020","cond_range_sterm_rtt","invites_logging_enabled","triggered_block_enabled","group_call_max_participants","media-iad3-1.cdn.whatsapp.net","product_catalog_open_deeplink","shops_required_tos_version","image_max_kbytes","cond_low_quality_vid_mode","db_receipt_migration_step","jb_early_prob_hist_shrink","media.fdmm2-3.fna.whatsapp.net","media.fdmm2-4.fna.whatsapp.net","media.fruh4-1.fna.whatsapp.net","media.fsaw2-2.fna.whatsapp.net","remove_geolocation_videos","new_animation_behavior","fieldstats_beacon_chance","403","authkey_reset_on_ban","continuous_ptt_playback","reconnecting_after_relay_failover_threshold_ms","false","group","sun","conversation_swipe_to_reply","ephemeral_messages_setting","smaller_video_thumbs_enabled","md_device_sync_enabled","bloks_shops_pdp_url_regex","lasso_integration_enabled","media-bom1-1.cdn.whatsapp.net","new_backup_format_enabled","256","media.faep6-1.fna.whatsapp.net","media.fasr1-1.fna.whatsapp.net","media.fbtz1-7.fna.whatsapp.net","media.fesb4-1.fna.whatsapp.net","media.fjdo1-2.fna.whatsapp.net","media.frba2-1.fna.whatsapp.net","watls_no_dns","600","db_broadcast_me_jid_migration_step","new_wam_runtime_enabled","group_update","enhanced_block_enabled","sync_wifi_threshold_kb","mms_download_nc_cat","bloks_minification_enabled","ephemeral_messages_enabled","reject","voip_outgoing_xml_signaling","creator","dl_bw","payments_request_messages","target_bitrate","bloks_rendercore_enabled","media-hbe1-1.cdn.whatsapp.net","media-hel3-1.cdn.whatsapp.net","media-kut2-2.cdn.whatsapp.net","media-lax3-1.cdn.whatsapp.net","media-lax3-2.cdn.whatsapp.net","sticker_pack_deeplink_enabled","hq_image_bw_threshold","status_info","voip","dedupe_transcode_videos","grp_uii_cleanup","linked_device_max_count","media.flim1-1.fna.whatsapp.net","media.fsaw2-1.fna.whatsapp.net","reconnecting_after_call_active_threshold_ms","1140","catalog_pdp_new_design","media.fbtz1-10.fna.whatsapp.net","media.fsaw1-15.fna.whatsapp.net","0b","consumer_rc_provider","mms_async_fast_forward_ttl","jb_eff_size_fix","voip_incoming_xml_signaling","media_provider_share_by_uuid","suspicious_links","dedupe_transcode_images","green_alert_modal_start","media-cgk1-1.cdn.whatsapp.net","media-lga3-1.cdn.whatsapp.net","template_doc_mime_types","important_messages","user_add","vcard_max_size_kb","media.fada2-1.fna.whatsapp.net","media.fbog2-5.fna.whatsapp.net","media.fbtz1-3.fna.whatsapp.net","media.fcgk3-1.fna.whatsapp.net","media.fcgk7-1.fna.whatsapp.net","media.flim1-3.fna.whatsapp.net","media.fscl9-1.fna.whatsapp.net","ctwa_context_enterprise_enabled","media.fsaw1-13.fna.whatsapp.net","media.fuio11-2.fna.whatsapp.net","status_collapse_muted","db_migration_level_force","recent_stickers_web_sync","bloks_session_state","bloks_shops_enabled","green_alert_setting_deep_links_enabled","restrict_groups","battery","green_alert_block_start","refresh","ctwa_context_enabled","md_messaging_enabled","status_image_quality","md_blocklist_v2_server","media-del1-1.cdn.whatsapp.net","13","userrate","a_v_id","cond_rtt_ema_alpha","invalid"],["media.fada1-1.fna.whatsapp.net","media.fadb3-2.fna.whatsapp.net","media.fbhz2-1.fna.whatsapp.net","media.fcor2-1.fna.whatsapp.net","media.fjed4-2.fna.whatsapp.net","media.flhe4-1.fna.whatsapp.net","media.frak1-2.fna.whatsapp.net","media.fsub6-3.fna.whatsapp.net","media.fsub6-7.fna.whatsapp.net","media.fvvi1-1.fna.whatsapp.net","search_v5_eligible","wam_real_time_enabled","report_disk_event","max_tx_rott_based_bitrate","product","media.fjdo10-2.fna.whatsapp.net","video_frame_crc_sample_interval","media_max_autodownload","15","h.264","wam_privatestats_buffer_count","md_phash_v2_enabled","account_transfer_enabled","business_product_catalog","enable_non_dyn_codec_param_fix","is_user_under_epd_jurisdiction","media.fbog2-4.fna.whatsapp.net","media.fbtz1-2.fna.whatsapp.net","media.fcfc1-1.fna.whatsapp.net","media.fjed4-5.fna.whatsapp.net","media.flhe4-2.fna.whatsapp.net","media.flim1-2.fna.whatsapp.net","media.flos5-1.fna.whatsapp.net","android_key_store_auth_ver","010","anr_process_monitor","delete_old_auth_key","media.fcor10-3.fna.whatsapp.net","storage_usage_enabled","android_camera2_support_level","dirty","consumer_content_provider","status_video_max_duration","0c","bloks_cache_enabled","media.fadb2-2.fna.whatsapp.net","media.fbko1-1.fna.whatsapp.net","media.fbtz1-9.fna.whatsapp.net","media.fcgk4-4.fna.whatsapp.net","media.fesb4-2.fna.whatsapp.net","media.fevn1-2.fna.whatsapp.net","media.fist2-4.fna.whatsapp.net","media.fjdo1-1.fna.whatsapp.net","media.fruh4-6.fna.whatsapp.net","media.fsrg5-1.fna.whatsapp.net","media.fsub6-6.fna.whatsapp.net","minfpp","5000","locales","video_max_bitrate","use_new_auth_key","bloks_http_enabled","heartbeat_interval","media.fbog11-1.fna.whatsapp.net","ephemeral_group_query_ts","fec_nack","search_in_storage_usage","c","media-amt2-1.cdn.whatsapp.net","linked_devices_ui_enabled","14","async_data_load_on_startup","voip_incoming_xml_ack","16","db_migration_step","init_bwe","max_participants","wam_buffer_count","media.fada2-2.fna.whatsapp.net","media.fadb3-1.fna.whatsapp.net","media.fcor2-2.fna.whatsapp.net","media.fdiy1-2.fna.whatsapp.net","media.frba3-2.fna.whatsapp.net","media.fsaw2-3.fna.whatsapp.net","1280","status_grid_enabled","w:biz","product_catalog_deeplink","media.fgye10-2.fna.whatsapp.net","media.fuio11-1.fna.whatsapp.net","optimistic_upload","work_manager_init","lc","catalog_message","cond_net_medium","enable_periodical_aud_rr_processing","cond_range_ema_rtt","media-tir2-1.cdn.whatsapp.net","frame_ms","group_invite_sending","payments_web_enabled","wallpapers_v2","0d","browser","hq_image_max_edge","image_edit_zoom","linked_devices_re_auth_enabled","media.faly3-2.fna.whatsapp.net","media.fdoh5-3.fna.whatsapp.net","media.fesb3-1.fna.whatsapp.net","media.fknu1-1.fna.whatsapp.net","media.fmex3-1.fna.whatsapp.net","media.fruh4-3.fna.whatsapp.net","255","web_upgrade_to_md_modal","audio_piggyback_timeout_msec","enable_audio_oob_fec_feature","from_ip","image_max_edge","message_qr_enabled","powersave","receipt_pre_acking","video_max_edge","full","011","012","enable_audio_oob_fec_for_sender","md_voip_enabled","enable_privatestats","max_fec_ratio","payments_cs_faq_url","media-xsp1-3.cdn.whatsapp.net","hq_image_quality","media.fasr1-2.fna.whatsapp.net","media.fbog3-1.fna.whatsapp.net","media.ffjr1-6.fna.whatsapp.net","media.fist2-3.fna.whatsapp.net","media.flim4-3.fna.whatsapp.net","media.fpbc2-4.fna.whatsapp.net","media.fpku1-1.fna.whatsapp.net","media.frba1-1.fna.whatsapp.net","media.fudi1-1.fna.whatsapp.net","media.fvvi1-2.fna.whatsapp.net","gcm_fg_service","enable_dec_ltr_size_check","clear","lg","media.fgru11-1.fna.whatsapp.net","18","media-lga3-2.cdn.whatsapp.net","pkey","0e","max_subject","cond_range_lterm_rtt","announcement_groups","biz_profile_options","s_t","media.fabv2-1.fna.whatsapp.net","media.fcai3-1.fna.whatsapp.net","media.fcgh1-1.fna.whatsapp.net","media.fctg1-4.fna.whatsapp.net","media.fdiy1-1.fna.whatsapp.net","media.fisb4-1.fna.whatsapp.net","media.fpku1-2.fna.whatsapp.net","media.fros9-1.fna.whatsapp.net","status_v3_text","usync_sidelist","17","announcement","...","md_group_notification","0f","animated_pack_in_store","013","America/Mexico_City","1260","media-ams4-1.cdn.whatsapp.net","media-cgk1-2.cdn.whatsapp.net","media-cpt1-1.cdn.whatsapp.net","media-maa2-1.cdn.whatsapp.net","media.fgye10-1.fna.whatsapp.net","e","catalog_cart","hfm_string_changes","init_bitrate","packless_hsm","group_info","America/Belem","50","960","cond_range_bwe","decode","encode","media.fada1-8.fna.whatsapp.net","media.fadb1-2.fna.whatsapp.net","media.fasu6-1.fna.whatsapp.net","media.fbog4-1.fna.whatsapp.net","media.fcgk9-2.fna.whatsapp.net","media.fdoh5-2.fna.whatsapp.net","media.ffjr1-2.fna.whatsapp.net","media.fgua1-1.fna.whatsapp.net","media.fgye1-1.fna.whatsapp.net","media.fist1-4.fna.whatsapp.net","media.fpbc2-2.fna.whatsapp.net","media.fres2-1.fna.whatsapp.net","media.fsdq1-2.fna.whatsapp.net","media.fsub6-5.fna.whatsapp.net","profilo_enabled","template_hsm","use_disorder_prefetching_timer","video_codec_priority","vpx_max_qp","ptt_reduce_recording_delay","25","iphone","Windows","s_o","Africa/Lagos","abt","media-kut2-1.cdn.whatsapp.net","media-mba1-1.cdn.whatsapp.net","media-mxp1-2.cdn.whatsapp.net","md_blocklist_v2","url_text","enable_short_offset","group_join_permissions","enable_audio_piggyback_feature","image_quality","media.fcgk7-2.fna.whatsapp.net","media.fcgk8-2.fna.whatsapp.net","media.fclo7-1.fna.whatsapp.net","media.fcmn1-1.fna.whatsapp.net","media.feoh1-1.fna.whatsapp.net","media.fgyd4-3.fna.whatsapp.net","media.fjed4-4.fna.whatsapp.net","media.flim1-4.fna.whatsapp.net","media.flim2-4.fna.whatsapp.net","media.fplu6-1.fna.whatsapp.net","media.frak1-1.fna.whatsapp.net","media.fsdq1-1.fna.whatsapp.net","to_ip","015","vp8","19","21","1320","auth_key_ver","message_processing_dedup","server-error","wap4_enabled","420","014","cond_range_rtt","ptt_fast_lock_enabled","media-ort2-1.cdn.whatsapp.net","fwd_ui_start_ts"],["contact_blacklist","Asia/Jakarta","media.fepa10-1.fna.whatsapp.net","media.fmex10-3.fna.whatsapp.net","disorder_prefetching_start_when_empty","America/Bogota","use_local_probing_rx_bitrate","America/Argentina/Buenos_Aires","cross_post","media.fabb1-1.fna.whatsapp.net","media.fbog4-2.fna.whatsapp.net","media.fcgk9-1.fna.whatsapp.net","media.fcmn2-1.fna.whatsapp.net","media.fdel3-1.fna.whatsapp.net","media.ffjr1-1.fna.whatsapp.net","media.fgdl5-1.fna.whatsapp.net","media.flpb1-2.fna.whatsapp.net","media.fmex2-1.fna.whatsapp.net","media.frba2-2.fna.whatsapp.net","media.fros2-2.fna.whatsapp.net","media.fruh2-1.fna.whatsapp.net","media.fybz2-2.fna.whatsapp.net","options","20","a","017","018","mute_always","user_notice","Asia/Kolkata","gif_provider","locked","media-gua1-1.cdn.whatsapp.net","piggyback_exclude_force_flush","24","media.frec39-1.fna.whatsapp.net","user_remove","file_max_size","cond_packet_loss_pct_ema_alpha","media.facc1-1.fna.whatsapp.net","media.fadb2-1.fna.whatsapp.net","media.faly3-1.fna.whatsapp.net","media.fbdo6-2.fna.whatsapp.net","media.fcmn2-2.fna.whatsapp.net","media.fctg1-3.fna.whatsapp.net","media.ffez1-2.fna.whatsapp.net","media.fist1-3.fna.whatsapp.net","media.fist2-2.fna.whatsapp.net","media.flim2-2.fna.whatsapp.net","media.fmct2-3.fna.whatsapp.net","media.fpei3-1.fna.whatsapp.net","media.frba3-1.fna.whatsapp.net","media.fsdu8-2.fna.whatsapp.net","media.fstu2-1.fna.whatsapp.net","media_type","receipt_agg","016","enable_pli_for_crc_mismatch","live","enc_rekey","frskmsg","d","media.fdel11-2.fna.whatsapp.net","proto","2250","audio_piggyback_enable_cache","skip_nack_if_ltrp_sent","mark_dtx_jb_frames","web_service_delay","7282","catalog_send_all","outgoing","360","30","LIMITED","019","audio_picker","bpv2_phase","media.fada1-7.fna.whatsapp.net","media.faep7-1.fna.whatsapp.net","media.fbko1-2.fna.whatsapp.net","media.fbni1-2.fna.whatsapp.net","media.fbtz1-1.fna.whatsapp.net","media.fbtz1-8.fna.whatsapp.net","media.fcjs3-1.fna.whatsapp.net","media.fesb3-2.fna.whatsapp.net","media.fgdl5-4.fna.whatsapp.net","media.fist2-1.fna.whatsapp.net","media.flhe2-2.fna.whatsapp.net","media.flim2-1.fna.whatsapp.net","media.fmex1-1.fna.whatsapp.net","media.fpat3-2.fna.whatsapp.net","media.fpat3-3.fna.whatsapp.net","media.fros2-1.fna.whatsapp.net","media.fsdu8-1.fna.whatsapp.net","media.fsub3-2.fna.whatsapp.net","payments_chat_plugin","cond_congestion_no_rtcp_thr","green_alert","not-a-biz","..","shops_pdp_urls_config","source","media-dus1-1.cdn.whatsapp.net","mute_video","01b","currency","max_keys","resume_check","contact_array","qr_scanning","23","b","media.fbfh15-1.fna.whatsapp.net","media.flim22-1.fna.whatsapp.net","media.fsdu11-1.fna.whatsapp.net","media.fsdu15-1.fna.whatsapp.net","Chrome","fts_version","60","media.fada1-6.fna.whatsapp.net","media.faep4-2.fna.whatsapp.net","media.fbaq5-1.fna.whatsapp.net","media.fbni1-1.fna.whatsapp.net","media.fcai3-2.fna.whatsapp.net","media.fdel3-2.fna.whatsapp.net","media.fdmm3-2.fna.whatsapp.net","media.fhex3-1.fna.whatsapp.net","media.fisb4-2.fna.whatsapp.net","media.fkhi5-2.fna.whatsapp.net","media.flos2-1.fna.whatsapp.net","media.fmct2-1.fna.whatsapp.net","media.fntr7-1.fna.whatsapp.net","media.frak3-1.fna.whatsapp.net","media.fruh5-2.fna.whatsapp.net","media.fsub6-1.fna.whatsapp.net","media.fuab1-2.fna.whatsapp.net","media.fuio1-1.fna.whatsapp.net","media.fver1-1.fna.whatsapp.net","media.fymy1-1.fna.whatsapp.net","product_catalog","1380","audio_oob_fec_max_pkts","22","254","media-ort2-2.cdn.whatsapp.net","media-sjc3-1.cdn.whatsapp.net","1600","01a","01c","405","key_frame_interval","body","media.fcgh20-1.fna.whatsapp.net","media.fesb10-2.fna.whatsapp.net","125","2000","media.fbsb1-1.fna.whatsapp.net","media.fcmn3-2.fna.whatsapp.net","media.fcpq1-1.fna.whatsapp.net","media.fdel1-2.fna.whatsapp.net","media.ffor2-1.fna.whatsapp.net","media.fgdl1-4.fna.whatsapp.net","media.fhex2-1.fna.whatsapp.net","media.fist1-2.fna.whatsapp.net","media.fjed5-2.fna.whatsapp.net","media.flim6-4.fna.whatsapp.net","media.flos2-2.fna.whatsapp.net","media.fntr6-2.fna.whatsapp.net","media.fpku3-2.fna.whatsapp.net","media.fros8-1.fna.whatsapp.net","media.fymy1-2.fna.whatsapp.net","ul_bw","ltrp_qp_offset","request","nack","dtx_delay_state_reset","timeoffline","28","01f","32","enable_ltr_pool","wa_msys_crypto","01d","58","dtx_freeze_hg_update","nack_if_rpsi_throttled","253","840","media.famd15-1.fna.whatsapp.net","media.fbog17-2.fna.whatsapp.net","media.fcai19-2.fna.whatsapp.net","media.fcai21-4.fna.whatsapp.net","media.fesb10-4.fna.whatsapp.net","media.fesb10-5.fna.whatsapp.net","media.fmaa12-1.fna.whatsapp.net","media.fmex11-3.fna.whatsapp.net","media.fpoa33-1.fna.whatsapp.net","1050","021","clean","cond_range_ema_packet_loss_pct","media.fadb6-5.fna.whatsapp.net","media.faqp4-1.fna.whatsapp.net","media.fbaq3-1.fna.whatsapp.net","media.fbel2-1.fna.whatsapp.net","media.fblr4-2.fna.whatsapp.net","media.fclo8-1.fna.whatsapp.net","media.fcoo1-2.fna.whatsapp.net","media.ffjr1-4.fna.whatsapp.net","media.ffor9-1.fna.whatsapp.net","media.fisb3-1.fna.whatsapp.net","media.fkhi2-2.fna.whatsapp.net","media.fkhi4-1.fna.whatsapp.net","media.fpbc1-2.fna.whatsapp.net","media.fruh2-2.fna.whatsapp.net","media.fruh5-1.fna.whatsapp.net","media.fsub3-1.fna.whatsapp.net","payments_transaction_limit","252","27","29","tintagel","01e","237","780","callee_updated_payload","020","257","price","025","239","payments_cs_phone_number","mediaretry","w:auth:backup:token","Glass.caf","max_bitrate","240","251","660","media.fbog16-1.fna.whatsapp.net","media.fcgh21-1.fna.whatsapp.net","media.fkul19-2.fna.whatsapp.net","media.flim21-2.fna.whatsapp.net","media.fmex10-4.fna.whatsapp.net","64","33","34","35","interruption","media.fabv3-1.fna.whatsapp.net","media.fadb6-1.fna.whatsapp.net","media.fagr1-1.fna.whatsapp.net","media.famd1-1.fna.whatsapp.net","media.famm6-1.fna.whatsapp.net","media.faqp2-3.fna.whatsapp.net"]]},function(e,t,n){n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return o}));var r=n(6),a=["conversation","imageMessage","contactMessage","locationMessage","extendedTextMessage","documentMessage","audioMessage","videoMessage","call","chat","protocolMessage","contactsArrayMessage","highlyStructuredMessage","fastRatchetKeySenderKeyDistributionMessage","sendPaymentMessage","requestPaymentMessage","liveLocationMessage","stickerMessage","groupInviteMessage","viewOnceMessage","ephemeralMessage","reactionMessage","deviceSentMessage","pollCreationMessage","pollUpdateMessage"];function i(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=null,i=0;i<a.length;i++)if(e[a[i]]){if(n)return __LOG__(4)`interpretProto msg came with tags ${n} and ${a[i]}`,null;n=a[i]}if(!n&&e.senderKeyDistributionMessage)return null;if(!n)return{type:"futureproof"};switch(n){case"viewOnceMessage":if(!r.E.get().viewOnceRead)return{type:"futureproof"};break;case"ephemeralMessage":break;case"deviceSentMessage":return __LOG__(3)`interpretProto: Received deviceSentMessage but companions is not supported`,{type:"futureproof"};default:return{type:n,value:e[n]}}return s(e[n],t)}function s(e,t){if(t>=2)return __LOG__(4)`unwrapExplicitlyFutureProofMsg: msg had too many futureproof layers`,null;var n=null==e?void 0:e.message;return null!=n?i(n,t+1):(__LOG__(4)`unwrapExplicitlyFutureProofMsg: msg had invalid futureproof message`,null)}function o(e){if("extendedTextMessage"===e.type||"imageMessage"===e.type||"videoMessage"===e.type||"audioMessage"===e.type||"documentMessage"===e.type||"contactMessage"===e.type||"contactsArrayMessage"===e.type||"groupInviteMessage"===e.type||"stickerMessage"===e.type||"liveLocationMessage"===e.type||"locationMessage"===e.type||"pollCreationMessage"===e.type)return e.value.contextInfo;e.type}},,function(e,t,n){function r(e){return new DataView(e).getUint32(2)}function a(e){return new DataView(e).getUint16(0)+1}function i(e){return new DataView(e).getUint16(0)}function s(e,t){for(var n=t,r=new Uint8Array(e),a=e-1;a>=0;a--)r[a]=255&n,n>>>=8;return r}n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return i})),n.d(t,"d",(function(){return s}))},,function(e,t,n){n.r(t),n.d(t,"extractDescription",(function(){return y})),n.d(t,"simpleQueryGroupParser",(function(){return w})),n.d(t,"buildSimpleGroupResult",(function(){return T})),n.d(t,"queryAllGroups",(function(){return M})),n.d(t,"queryGroup",(function(){return C})),n.d(t,"queryAllGroupsWithRetry",(function(){return R})),n.d(t,"queryAddRequest",(function(){return P}));var r=n(27),a=n.n(r),i=n(28),s=n(4),o=n(75),u=n(46),d=n(244),c=n(17),l=n(7),p=n(74),h=n(12),f=n(89),m=n(109),v=n(83),g=n(122),_=n(237),E=n(404),b={superadmin:"superadmin",admin:"admin",participant:"participant"};function y(e){if(e.hasChild("description")){var t=e.child("description");if(t.hasChild("body")){var n=t.child("body");if(n.hasContent())return{content:n.contentString(),id:t.attrString("id")}}}return null}function S(e){var t=y(e),n=e.mapChildrenWithTag("participant",e=>({jid:e.attrPhoneUserJid("jid"),type:e.attrEnumOrDefault("type",b,"participant")})),r=(0,E.a)(e);return Object.assign({phashMatch:!1,creatorJid:e.maybeAttrPhoneUserJid("creator"),creationTs:e.attrTime("creation"),groupJid:(0,l.z)(e.attrString("id")),title:e.attrString("subject"),titleTs:e.attrTime("s_t"),description:t?t.content:null,descriptionId:t?t.id:null,locked:e.hasChild("locked"),announcement:e.hasChild("announcement"),support:e.hasChild("support"),size:e.hasAttr("size")?e.attrInt("size"):n.length,participants:n},r&&{communityInfo:r},{expiration:e.hasChild("ephemeral")?e.child("ephemeral").attrInt("expiration"):null,growthLocked:(0,_.b)(e)})}var I=new u.a("queryGroup",e=>e.hasChild("group")?S(e.child("group")):{phashMatch:!0}),w=new u.a("simpleQueryGroup",e=>{if(!e.hasChild("group"))throw __LOG__(4)`simpleQueryGroupParser: no group node found`,SEND_LOGS("no-group-node"),new d.b("simpleQueryGroup","501");return S(e.child("group"))});function T(e){return A.apply(this,arguments)}function A(){return(A=a()((function*(e){var t=yield(0,c.O)(e.groupJid);return(null==t?void 0:t.isInGroup)?{error:{reason:"already-in-group",extra:e.groupJid}}:{result:{group:e.groupJid,title:e.title,description:e.description,participantJids:e.participants.map(e=>e.jid),creatorJid:e.creatorJid,size:e.size}}}))).apply(this,arguments)}var O=new u.a("queryAllGroups",e=>({groups:e.child("groups").mapChildren(S)}));function M(){__LOG__(2)`queryAllGroups invoked`;var e=(0,s.v)("iq",{to:s.e,type:"get",xmlns:"w:g2",id:(0,s.t)()},(0,s.v)("participating",null,(0,s.v)("participants",null),(0,s.v)("description",null)));return(0,i.e)(e,O).then(e=>{if(!e.success)return(0,v.d)("unknown");var t=e.result.groups.map(e=>e.groupJid),n=[(0,p.getProfilePicTable)().clearRecords(t).then(()=>{(0,h.c)("event","avatarsUpdated",{cleared:t})})];return e.result.groups.forEach(e=>{var t={jid:e.groupJid,title:e.title,titleTs:e.titleTs,description:e.description,descriptionId:e.descriptionId,participants:e.participants,creatorJid:e.creatorJid,creationTs:e.creationTs,locked:e.locked,announcement:e.announcement,support:e.support,expiration:e.expiration,growthLocked:e.growthLocked};"parent"===e.communityInfo?n.push((0,c.sb)(Object.assign({},t,{communityInfo:"parent"}))):n.push((0,c.rb)(Object.assign({},t,{communityInfo:e.communityInfo})))}),Promise.all(n).then(()=>"success")})}var C=(0,o.c)().finalStep("queryGroup",e=>{var t=e.groupJid,n=e.request,r=e.phash;return(function(e,t,n){var r=(0,s.v)("iq",{to:(0,s.g)(e),type:"get",xmlns:"w:g2",id:(0,s.t)()},(0,s.v)("query",{request:t||s.d,phash:(0,s.i)(n)}));return(0,i.e)(r,I)})(t,n,r).then(e=>{if(e.success){var n=e.result;if(!n.phashMatch){var r={jid:t,title:n.title,titleTs:n.titleTs,description:n.description,descriptionId:n.descriptionId,locked:n.locked,announcement:n.announcement,support:n.support,participants:n.participants,creatorJid:n.creatorJid,creationTs:n.creationTs,expiration:n.expiration,growthLocked:n.growthLocked},a=[];return"parent"===n.communityInfo?a.push((0,c.sb)(Object.assign({},r,{communityInfo:"parent"}))):a.push((0,c.rb)(Object.assign({},r,{communityInfo:n.communityInfo}))),Promise.all([(0,p.getProfilePicTable)().clearRecord(t).then(()=>{(0,h.c)("event","avatarsUpdated",{cleared:[t]})}),...a]).then(()=>{})}}})}).end(),R=(0,o.c)().finalStep("queryAllGroups",()=>M().catch((0,g.a)(m.a,()=>"disconnected")).then(e=>{if("success"!==e)throw new f.b({algo:{type:"constant",delay:3e5}})})).end(),N={400:(0,v.d)("malformed"),404:(0,v.d)("group-not-found"),419:(0,v.d)("too-many-participants"),500:(0,v.d)("unknown")};function k(e,t,n,r){var a=(0,s.v)("iq",{to:(0,s.g)(e),type:"get",xmlns:"w:g2",id:(0,s.t)()},(0,s.v)("query",null,(0,s.v)("add_request",{code:(0,s.b)(t),expiration:(0,s.f)(n),admin:(0,s.g)(r)})));return(0,i.e)(a,w)}function P(e,t,n,r){return G.apply(this,arguments)}function G(){return(G=a()((function*(e,t,n,r){var a=yield(0,c.O)(e);return(null==a?void 0:a.isInGroup)?{error:{reason:"already-in-group",extra:e}}:k(e,t,n,r).then(e=>e.success?T(e.result):(0,v.f)(e,N))}))).apply(this,arguments)}},function(e,t,n){n.r(t),n.d(t,"statusQuerySync",(function(){return X})),n.d(t,"syncAllContacts",(function(){return ne})),n.d(t,"oneTimeSyncAllContacts",(function(){return re})),n.d(t,"deltaSync",(function(){return ae})),n.d(t,"contactQuerySync",(function(){return ie})),n.d(t,"addContactToSidelist",(function(){return Z}));var r=n(27),a=n.n(r),i=n(9),s=n.n(i),o=n(109),u=n(28),d=n(4),c=n(46),l=n(17),p=n(63),h=n(12),f=n(220),m=n(175),v=n(6),g=n(3),_=n(61),E=n(95),b=null;function y(){if(null!=b)return b;b=new class{constructor(){this.aP={},this.aQ=[],this.aR={},this.aS=null,this.aU=null}enqueue(e,t){if(this.aR[e])return this.aR[e].promise;var n=new _.a;if(this.aR[e]=n,this.aQ.push(e),this.aP[e]=t,null==this.aS){var r=()=>{if(!(this.aQ.length<1)){if(this.aU&&(0,g.p)(this.aU))return(0,E.a)(1e3*(0,g.z)(this.aU)).then(()=>r());this.aU=null;var e=this.aQ.shift();this.aS=e;var t=this.aP[e]();return this.aR[e].resolve(t),t.catch(()=>{}).then(()=>(delete this.aP[e],delete this.aR[e],r()))}this.aS=null};this.aT=r()}return n.promise}pause(e){return this.aU=e,null==this.aS}};var e=v.L.get();return null!=e&&(0,g.p)(e)&&b.pause(e),b}function S(e){v.L.set(e),null!=b&&b.pause(e)}var I=n(40),w=n(83),T=n(10),A=n(30),O=n(16),M=n(89),C=n(29),R=n(340),N=n(304),k=n(111),P=n(75),G=n(144),L=n(122),D=n(23),x={algo:{type:"constant",delay:1e4}},U=g.d;function F(e){if(!e.hasChild("status"))return"UNCHANGED";var t=e.child("status");return"fail"===t.maybeAttrString("type")?{status:"blocked"}:t.hasAttr("t")?{status:"loaded",content:t.contentString(),ts:t.attrTime("t")}:{status:"empty"}}function B(e){if(e.hasChild("devices"))return(0,R.parseUSyncDevices)(e.child("devices"))}function j(e){if(se()){if(!e.hasChild("disappearing_mode"))return"blocked";var t=e.child("disappearing_mode");return{expiration:t.attrInt("duration"),lastChangedTs:t.attrTime("t")}}}var V=new c.a("syncContactsResult",e=>{e.assertAttr("type","result");var t=e.child("usync"),n=t.child("result").child("contact"),r=t.maybeChild("list"),a=t.maybeChild("side_list"),i=[],s=new Map,o=new Map,u=[];return null!=r&&r.forEachChildWithTag("user",e=>{if(e.hasChild("contact")){var t=e.child("contact"),n=t.attrString("type");if("in"===n||"out"===n){var r=e.attrPhoneUserJid("jid"),a=t.contentString();if(i.push({phonebookKey:a,jid:r,about:F(e),inWhatsApp:"in"===n,business:(0,m.getBusinessInfoFromNode)(e),disappearingMode:j(e)}),"in"===n){var d=B(e);d&&o.set(r,d)}}else"invalid"===n?u.push(t.contentString()):__LOG__(3)`<contact> node with unrecognized type ${n}`}else{var c=e.attrPhoneUserJid("jid");s.set(c,{jid:c,about:F(e),business:(0,m.getBusinessInfoFromNode)(e),inWhatsApp:!0,disappearingMode:j(e)})}}),null!=a&&a.forEachChildWithTag("user",e=>{var t=e.maybeChild("sidelist");if(t){var n=t.attrString("type");if("in"===n||"out"===n){var r="in"===n,a=e.attrPhoneUserJid("jid"),i=s.get(a);if(i?s.set(a,Object.assign({},i,{inWhatsApp:r})):s.set(a,{jid:a,about:F(e),business:(0,m.getBusinessInfoFromNode)(e),inWhatsApp:r,disappearingMode:j(e)}),"in"===n){var u=B(e);u&&o.set(a,u)}}else __LOG__(3)`<sidelist> node with unrecognized type ${n}`}}),{refresh:n.maybeAttrInt("refresh",0)||0,inPhonebook:i,inSidelist:Array.from(s.values()),invalid:u,unverifiedDevicesInfo:o}});function K(e){var t;return null!=e.about&&"loaded"===e.about.status&&(t=(0,d.v)("status",{t:(0,d.f)(e.about.ts)})),{about:t,devices:e.noWhatsApp?Promise.resolve():(0,R.getDevicesNode)(e),business:(0,m.maybeGetBusinessNode)(e)}}function H(e,t){return __LOG__(2)`syncAllContacts`,Promise.all([(0,h.e)("page","getContactsFromPhoneBook",{}),(0,p.c)()]).then(n=>{var r=s()(n,2),a=r[0],i=r[1],o={},u={},c=new Set,p=new Set,h=[],m="interactive"!==e;a.forEach(e=>{if(Array.isArray(e.tel))for(var t=0;t<e.tel.length;t++){var n=(0,I.f)(e.tel[t]);n&&(o[n]=(0,f.a)(e),c.add(n))}});var g={};i.forEach(e=>{var t=e.phonebookPhone;if(null==t||c.has(t)||p.add(e.jid),null!=t&&c.has(t))u[t]=e;else if(!e.noWhatsApp){if(!m)return;if(e.jid===v.r.get())return;null!=e.chatId?h.push(e):null!=e.verifiedInfo&&(g[e.jid]=e)}});var _,E=Array.from(c).map(e=>{var t=u[e];if(!t)return(0,d.v)("user",null,(0,d.v)("contact",null,e));var n=K(t),r=n.about,a=n.devices,i=n.business;return a.then(t=>(0,d.v)("user",null,(0,d.v)("contact",null,e),r,t,i))}),b=Array.from(h).map(e=>{var t=K(e),n=t.about,r=t.devices,a=t.business;return r.then(t=>(0,d.v)("user",{jid:(0,d.g)(e.jid)},n,t,a))}),y=(0,T.w)(g);return y.length>0&&(_=(0,l.t)(y).then(e=>Promise.all(e.map(e=>{var t=K(g[e]),n=t.about,r=t.devices,a=t.business;return r.then(t=>(0,d.v)("user",{jid:(0,d.g)(e)},n,t,a))})))),Promise.all([Promise.all(E),Promise.all(b),_]).then(n=>{var r=s()(n,3),i=r[0],u=r[1],c=r[2],l=(0,d.v)("iq",{to:(0,d.g)(v.r.get()),id:(0,d.t)(),xmlns:"usync",type:"get"},(0,d.v)("usync",{mode:"full",context:e,sid:(0,d.t)(),index:"0",last:"true"},(0,d.v)("query",null,(0,d.v)("contact",null),(0,d.v)("status",null),(0,d.v)("devices",{version:(0,d.f)(2)}),m?(0,d.v)("sidelist",null):null,(0,d.v)("business",null,(0,d.v)("verified_name",null)),se()?(0,d.v)("disappearing_mode",null):null),(0,d.v)("list",null,i),m?(0,d.v)("side_list",null,c?[...u,...c]:u):null));return{phoneToNames:o,deletedJids:p,revision:t,phoneContactsSize:a.length,iq:l}})})}function $(e,t){var n=e.deletedJids,r=e.phoneToNames,i=e.phoneContactsSize,s=e.revision;if(!t.success)return __LOG__(4)`Error while sending contacts to WA server in full sync`,t.errorBackoff>0?(S((0,g.l)(t.errorBackoff)),1):v.k.get()?3*g.b:g.b;for(var o=t.result.unverifiedDevicesInfo,u=new Map,d=Array.from(t.result.inPhonebook.values()),c=new Map,l=0,p=0;p<d.length;p++){var h=d[p],f=h.jid,m=h.phonebookKey,_=h.business,E=q(h,r[m]);E.noWhatsApp||l++,n.delete(f),c.set(f,E),u.set(f,_)}for(var b=t.result.inSidelist,y=0;y<b.length;y++){var I=b[y],w=I.jid,T=I.business;if(!c.has(w)){var M=z(I);M&&(n.delete(w),c.set(w,M))}u.has(w)||u.set(w,T)}return ee(c,n,t.result.invalid,o,u).then(a()((function*(){return v.k.get()||(yield v.k.set(!0),__LOG__(2)`initLocalSettingsFromServer after syncAllContacts`,yield(0,A.b)().waitUntilPersisted(O.e.initLocalSettingsFromServer())),v.s.set(s),v.t.set({addressbookSize:i,addressbookWhatsappSize:l}),t.result.refresh>0?t.result.refresh:3*g.b})))}function q(e,t){var n=e.phonebookKey,r=e.about,a=e.inWhatsApp,i=e.disappearingMode,s={phonebook:{fullName:(null==t?void 0:t.fullName)||void 0,shortName:(null==t?void 0:t.shortName)||void 0,phonebookPhone:n}};return a?("UNCHANGED"!==r&&(s.about=r),null!=i&&(s.defaultDisappearingMode=i)):s.noWhatsApp=!0,s}function z(e){var t,n=e.about,r=e.inWhatsApp,a=e.disappearingMode;return r?("UNCHANGED"!==n&&(t={about:n}),null!=a&&(t?t.defaultDisappearingMode=a:t={defaultDisappearingMode:a})):t={noWhatsApp:!0},t}function J(e,t,n){var r=null==t?void 0:t.verifiedInfo;if("NO_BIZ"===n){if(null!=r)return(0,l.Mc)(e)}else{var a=n.verifiedInfo;if("UNCHANGED"!==a.cert){var i=a.cert,s=a.level,o=a.bsp;return(0,m.verifyUserCert)(e,s,i,o)}if(r&&(0,G.d)(t,r.serial,a.level,a.bsp)){var u=r.isApi?Object.assign({},r,{level:a.level,bsp:a.bsp}):Object.assign({},r,{level:a.level});return(0,l.ed)(e,u)}}}function Y(e,t,n){var r=(0,f.a)(t);return{jid:e,fullName:r.fullName||void 0,shortName:r.shortName||void 0,phonebookPhone:n}}var W=new c.a("syncSidelistResult",e=>{e.assertAttr("type","result");var t=e.child("usync"),n=t.child("result").child("sidelist"),r=t.child("side_list"),a=new Map,i=new Map;return r.forEachChildWithTag("user",e=>{var t=e.maybeChild("sidelist");if(t){var n=t.attrString("type");if("in"===n||"out"===n){var r="in"===n,s=e.attrPhoneUserJid("jid");if(a.set(s,{jid:s,about:F(e),inWhatsApp:r,business:(0,m.getBusinessInfoFromNode)(e),disappearingMode:j(e)}),"in"===n){var o=B(e);o&&i.set(s,o)}}else __LOG__(3)`<sidelist> node with unrecognized type ${n}`}}),{refresh:n.maybeAttrInt("refresh",0)||0,updates:a,unverifiedDevicesInfo:i}}),Z=(0,P.c)().finalStep("addToSidelist",e=>{var t=e.userJid;if(t!==v.r.get())return(0,p.b)(t).then((function(){var e=a()((function*(e){var n;if(e){if(null!=e.phonebookPhone)return void __LOG__(2)`addContactToSidelist: contact in phonebook`;var r=K(e),a=r.business,i=r.devices,s=r.about;n=(0,d.v)("user",{jid:(0,d.g)(e.jid)},s,yield i,a)}else n=(0,d.v)("user",{jid:(0,d.g)(t)});var o=(0,d.v)("iq",{to:(0,d.g)(v.r.get()),id:(0,d.t)(),xmlns:"usync",type:"get"},(0,d.v)("usync",{mode:"delta",context:"interactive",sid:(0,d.t)(),index:"0",last:"true"},(0,d.v)("query",null,(0,d.v)("status",null),(0,d.v)("devices",{version:(0,d.f)(2)}),(0,d.v)("business",null,(0,d.v)("verified_name",null)),(0,d.v)("sidelist",null),se()?(0,d.v)("disappearing_mode",null):null),(0,d.v)("side_list",null,n)));return(0,u.e)(o,W)}));return function(t){return e.apply(this,arguments)}})()).then(e=>{if(e){if(!e.success){if(__LOG__(4)`addContactToSidelist: error`,409===e.errorCode)throw new M.b(x);throw e.errorBackoff>0&&S((0,g.l)(e.errorBackoff)),new Error("addContactToSideList error")}var t=Array.from(e.result.updates.values());if(0!==t.length){t.length>1&&(__LOG__(4)`addContactToSidelist: Received more than one result`,SEND_LOGS("multiple-results-usync-contact"));var n=t[0],r=new Map,a=new Map,i=n.jid,s=z(n);return s&&r.set(i,s),a.set(i,n.business),ee(r,null,[],e.result.unverifiedDevicesInfo,a)}__LOG__(3)`addContactToSidelist: Received no results`}})}).end(),Q=new c.a("syncAboutResult",e=>{e.assertAttr("type","result");var t=e.child("usync"),n=t.child("result").child("status"),r=t.child("list"),a=new Map;return r.forEachChildWithTag("user",e=>{var t=F(e);"UNCHANGED"!==t&&a.set(e.attrPhoneUserJid("jid"),t)}),{refresh:n.maybeAttrInt("refresh",0)||0,updates:a}});function X(e){var t=(0,d.v)("iq",{to:(0,d.g)(v.r.get()),id:(0,d.t)(),xmlns:"usync",type:"get"},(0,d.v)("usync",{mode:"query",context:(0,h.d)()?"interactive":"notification",sid:(0,d.t)(),index:"0",last:"true"},(0,d.v)("query",null,(0,d.v)("status",null)),(0,d.v)("list",null,e.map(e=>(0,d.v)("user",{jid:(0,d.g)(e)})))));return(0,u.e)(t,Q).then(e=>{if(!e.success)throw __LOG__(4)`Error while attempting to update status in query sync`,new Error("status query sync unsuccessful");e.result.updates.forEach((e,t)=>{(0,l.Nc)(t,e)})})}function ee(e,t,n,r,a){return te(r).then(()=>{return e=a,(0,p.c)().then(t=>{var n=(0,T.s)(t,e=>e.jid),r=[];return Array.from(e.entries()).forEach(e=>{var t=s()(e,2),a=t[0],i=t[1],o=n[a];r.push(J(a,o,i))}),Promise.all(r).then(()=>{})});var e}).then(()=>(0,p.i)(e,t,n))}function te(e){return(0,N.a)(Array.from(e.keys())).then(()=>(0,k.i)(e).then(e=>{var t=[];return e.forEach((e,n)=>{t.push((0,C.y)(n,e).then(()=>(0,l.ob)(n,{usyncResponse:e})))}),Promise.all(t)}))}var ne=function(e,t){return(0,M.c)("full-sync"),y().enqueue("syncAll",()=>H(e,t).then(e=>{var t=e.phoneToNames,n=e.phoneContactsSize,r=e.deletedJids,a=e.revision,i=e.iq;return(0,u.e)(i,V).then(e=>$({phoneToNames:t,phoneContactsSize:n,deletedJids:r,revision:a},e))}))},re=function(e,t){(0,M.c)("full-sync");var n=H(e,t).then(e=>{var t=e.phoneToNames,n=e.phoneContactsSize,r=e.deletedJids,a=e.revision,i=e.iq;return(0,u.h)(i,V).then(e=>$({phoneToNames:t,phoneContactsSize:n,deletedJids:r,revision:a},e)).then(()=>{}).catch((0,L.a)(o.a,()=>(__LOG__(3)`Disconnected while trying to sync contacts`,(0,w.d)("network-error"))))});return y().enqueue("syncAll",()=>n.then(()=>-1)).then(()=>n)},ae=function(e,t,n){return(0,M.c)("delta-sync"),y().enqueue("deltaSync",()=>(function(e,t,n){return __LOG__(2)`Running deltaSync`,(r=v.v.get()).length<50||!(0,g.n)(r[0],U)?Promise.all([(0,h.e)("page","getContactsFromPhoneBook",{}),(0,p.c)(),(0,p.e)()]).then(t=>{var r=s()(t,3),a=r[0],i=r[1],o=r[2],c=a.length,h=0,m=new Map,_=new Set,E=new Set,b=new Set,y=new Map;i.forEach(e=>{var t=e.phonebookPhone;null!=t&&(m.set(t,e),_.add(t),b.add(t),e.noWhatsApp||h++)}),o.forEach(e=>{_.add(e),b.add(e)});var w={};if(a.forEach(e=>{if(Array.isArray(e.tel))for(var t=0;t<e.tel.length;t++){var r=(0,I.f)(e.tel[t]);if(r)if(w[r]=e,_.has(r)){var a=m.get(r);if(a&&a.phonebookPhone){var i=(0,f.a)(e);if(a.fullName!==i.fullName||a.shortName!==i.shortName){var s={jid:a.jid,fullName:i.fullName||void 0,shortName:i.shortName||void 0,phonebookPhone:a.phonebookPhone};y.set(a.jid,s)}else y.has(a.jid)&&y.delete(a.jid)}b.delete(r)}else if(E.add(r),n&&n.hasOwnProperty(r)){var o=n[r],u=Y(o,e,r);y.set(o,u)}}}),0===E.size&&0===b.size)return __LOG__(2)`syncContacts phonebook unchanged`,(y.size>0?(0,p.a)(y):Promise.resolve()).then(()=>{v.t.set({addressbookSize:c,addressbookWhatsappSize:h})});var A=[],O=[],M={},C=new Set;E.forEach(e=>{A.push((0,d.v)("user",null,(0,d.v)("contact",null,e)))});for(var R=Array.from(b),N=function(e){var t=R[e],n=m.get(t);if(n){if(C.add(n.jid),A.push((0,d.v)("user",{jid:(0,d.g)(n.jid)},(0,d.v)("contact",{type:"delete"}))),n.jid===v.r.get())return"continue";if(null!=n.chatId){var r=K(n),a=r.devices,i=r.about,s=r.business;O.push(a.then(e=>(0,d.v)("user",{jid:(0,d.g)(n.jid)},i,e,s)))}else null!=n.verifiedInfo&&(M[n.jid]=n)}},k=0;k<R.length;k++)N(k);if(0===A.length){var P=Array.from(b);return(y.size>0?(0,p.a)(y,P):(0,p.g)(P)).then(()=>{v.t.set({addressbookSize:c,addressbookWhatsappSize:h})})}var G=Promise.resolve(O).then(e=>{var t=(0,T.w)(M);return t.length>0?(0,l.t)(t).then(t=>(t.forEach(t=>{var n=M[t],r=K(n),a=r.devices,i=r.about,s=r.business;e.push(a.then(e=>(0,d.v)("user",{jid:(0,d.g)(n.jid)},i,e,s)))}),Promise.all(e))):Promise.all(e)}).then(t=>{var n=(0,d.v)("iq",{to:(0,d.g)(v.r.get()),id:(0,d.t)(),xmlns:"usync",type:"get"},(0,d.v)("usync",{mode:"delta",context:e,sid:(0,d.t)(),index:"0",last:"true"},(0,d.v)("query",null,(0,d.v)("contact",null),(0,d.v)("status",null),(0,d.v)("business",null,(0,d.v)("verified_name",null)),(0,d.v)("devices",{version:(0,d.f)(2)}),se()?(0,d.v)("disappearing_mode",null):null,t.length>0?(0,d.v)("sidelist",null):null),(0,d.v)("list",null,A),t.length>0?(0,d.v)("side_list",null,t):null));return(0,u.e)(n,V)});return Promise.all([G,y.size>0||C.size>0?(0,p.a)(y,null,C).catch(e=>__LOG__(3)`updateContactNames failed: ${e}`):null]).then(e=>{var t=s()(e,1)[0];if(!t.success)throw __LOG__(4)`Error while sending contacts to WA server in delta sync`,t.errorBackoff>0&&S((0,g.l)(t.errorBackoff)),new Error("delta sync unsuccessful");for(var n=t.result.inPhonebook,r=t.result.unverifiedDevicesInfo,a=new Map,i=new Map,u=0;u<n.length;u++){var d=n[u],p=d.phonebookKey,h=d.jid,m=d.business,_=q(d,(0,f.a)(w[p]));C.delete(h),a.set(h,_),i.set(h,m)}for(var E=t.result.inSidelist,b=0;b<E.length;b++){var y=E[b],I=y.jid,T=y.business;if(!a.has(I)){var A=z(y);A&&(C.delete(I),a.set(I,A))}i.has(I)||i.set(I,T)}var O=[...o.filter(e=>w.hasOwnProperty(e)),...t.result.invalid];return ee(a,C,O,r,i).then(()=>{for(var e=[...v.v.get(),(0,g.E)()];e.length>50;)e.shift();return Promise.all([(0,l.w)().then(e=>{v.t.set({addressbookSize:c,addressbookWhatsappSize:e})}),v.v.set(e)])})})}).then(()=>v.s.set(t)):(__LOG__(3)`Delta sync has been throttled`,Promise.resolve());var r})(e,t,n).then(()=>-1))},ie=function(e){var t=new _.a;return y().enqueue("contactQuerySync-"+e,()=>(function(e){var t="+"+e,n=(0,d.v)("iq",{to:(0,d.g)(v.r.get()),id:(0,d.t)(),xmlns:"usync",type:"get"},(0,d.v)("usync",{mode:"query",context:"interactive",sid:(0,d.t)(),index:"0",last:"true"},(0,d.v)("query",null,(0,d.v)("contact",null),(0,d.v)("status",null),(0,d.v)("devices",{version:(0,d.f)(2)}),(0,d.v)("business",null,(0,d.v)("verified_name",null)),se()?(0,d.v)("disappearing_mode",null):null),(0,d.v)("list",null,(0,d.v)("user",null,(0,d.v)("contact",null,t)))));return(0,u.g)(n,V,5).then(e=>{if(__LOG__(2)`syncContacts: finished waiting, executing`,!e.success)throw new Error("contact query sync unsuccessful");if(e.result.invalid.length>0)return"invalid";var t=e.result.inPhonebook;if(0===t.length)return __LOG__(3)`contactQuerySync: no updates and no invalid received`,"invalid";var n=t[0],r=n.jid;return(0,p.b)(r).then(t=>{var a=new Map,i=z(n);if(i){if(t&&null!=t.phonebookPhone){var s=t.phonebookPhone,o=t.shortName,u=t.fullName;i.phonebook={phonebookPhone:s,shortName:o,fullName:u}}a.set(r,i)}return te(e.result.unverifiedDevicesInfo).then(()=>{var e=n.business;return J(r,t,e)}).then(()=>(0,p.i)(a,null,[])).then(()=>n.inWhatsApp?r:"not-found")})}).catch((0,L.a)(o.a,()=>(__LOG__(3)`syncContacts: timeout`,"offline")))})(e).then(e=>(t.resolve(e),-1)).catch(e=>(t.reject(e),-1))),t.promise};function se(){return(0,D.a)("disappearing_mode")}},,,function(e,t,n){n.d(t,"l",(function(){return v})),n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return _})),n.d(t,"r",(function(){return E})),n.d(t,"j",(function(){return b})),n.d(t,"k",(function(){return y})),n.d(t,"s",(function(){return S})),n.d(t,"q",(function(){return I})),n.d(t,"c",(function(){return M})),n.d(t,"m",(function(){return C})),n.d(t,"n",(function(){return R})),n.d(t,"f",(function(){return N})),n.d(t,"g",(function(){return k})),n.d(t,"h",(function(){return P})),n.d(t,"o",(function(){return G})),n.d(t,"d",(function(){return L})),n.d(t,"e",(function(){return D})),n.d(t,"p",(function(){return x})),n.d(t,"i",(function(){return U}));var r=n(9),a=n.n(r),i=n(59),s=n(5),o=n(45),u=n(3),d=n(26),c=n(8),l=n(10),p=n(2),h=n(105),f=n(366),m=n(12);function v(e){return(0,c.f)("hasGifRecentOrRecompute",t=>t.transact("rw",["meta"],()=>w(t).then(n=>{var r=n.recentGifs,a=n.toDelete,i=r.get(e);if(i){if(null==i.contentPath)return __LOG__(2)`hasGifRecentOrRecompute: gif exists without content`,i;var s=T(r,e);return t.stores.meta.put({key:d.a.RECENT_GIFS,value:{recentGifs:s,toDelete:a}}).then(()=>i)}__LOG__(2)`hasGifRecentOrRecompute: gif does not exist`})))}function g(e){return(0,c.f)("addRecentWorthGifOrRecompute",t=>t.transact("rw",["meta"],()=>w(t).then(n=>{var r,a=n.recentGifs,i=n.toDelete,s=a.get(e);if(s&&null!=s.contentPath?(__LOG__(3)`addRecentWorthGifOrRecompute: recent gif already exist`,r=!1):r=(function(e,t){var n=A(e);return n.length<12||n[11].weight<(t||0)+1e3})(a,null==s?void 0:s.weight),!r){var o=T(a,e);return t.stores.meta.put({key:d.a.RECENT_GIFS,value:{recentGifs:o,toDelete:i}}).then(()=>r)}return!0})))}function _(e,t){return(0,c.f)("createEmptyRecentGif",n=>n.transact("rw",["meta"],()=>w(n).then(r=>{var a=r.recentGifs,i=r.toDelete;if(!a.get(e))return a.set(e,{plaintextHash:e,lastSent:(0,u.E)(),weight:0,relativePath:t}),n.stores.meta.put({key:d.a.RECENT_GIFS,value:{recentGifs:a,toDelete:i}}).then(()=>{});__LOG__(3)`createEmptyRecentGif: recent gif already exists`})))}function E(e,t,n){return(0,c.f)("markRecentGifAsStored",r=>r.transact("rw",["meta"],()=>w(r).then(a=>{var i=a.recentGifs,s=a.toDelete,o=i.get(e);if(o){if(null==o.contentPath){i.set(e,Object.assign({},o,{contentPath:n,info:O(t)})),__LOG__(2)`markRecentGifAsStored: Recomputing recentGifs weights`;var u=T(i,e),c=(function(e){return A(e).slice(12)})(u);return __LOG__(2)`markRecentGifAsStored purging ${c.length}`,c.forEach(e=>{null!=e.contentPath&&(s.push(e.contentPath),u.set(e.plaintextHash,(0,l.j)(e,{contentPath:void 0,info:void 0})))}),r.stores.meta.put({key:d.a.RECENT_GIFS,value:{recentGifs:u,toDelete:s}}).then(()=>s)}__LOG__(3)`markRecentGifAsStored recent gif already stored`}else __LOG__(3)`markRecentGifAsStored: recent gif not found`})))}function b(){return(0,c.f)("getRecentGifs",e=>e.transact("rw",["meta"],()=>w(e).then(e=>{var t=e.recentGifs,n=[];return t.forEach(e=>{void 0!==e.contentPath&&n.push(e)}),n.sort((e,t)=>t.weight-e.weight).map(e=>({plaintextHash:e.plaintextHash,contentPath:e.contentPath,info:e.info}))})))}function y(){return(0,c.f)("getRecentGifsToDelete",e=>(0,s.i)((0,d.d)(e.stores.meta,d.a.RECENT_GIFS).then(e=>null==e?void 0:e.value.toDelete)))}function S(e){return(0,c.f)("markRecentGifContentAsDeleted",t=>t.transact("rw",["meta"],()=>w(t).then(n=>{var r=n.recentGifs,a=n.toDelete,i=r.get(e);if(i)return r.set(e,(0,l.j)(i,{contentPath:void 0,info:void 0})),t.stores.meta.put({key:d.a.RECENT_GIFS,value:{recentGifs:r,toDelete:a}}).then(()=>{});__LOG__(3)`markRecentGifContentAsDeleted: No recent gif found`})))}function I(e){return(0,c.f)("markPathAsDeleted",t=>t.transact("rw",["meta"],()=>w(t).then(n=>{var r=n.recentGifs,a=n.toDelete,i=a.filter(t=>t!==e);if(i.length!==a.length)return t.stores.meta.put({key:d.a.RECENT_GIFS,value:{recentGifs:r,toDelete:i}}).then(()=>{});__LOG__(3)`markPathAsDeleted path not found in toDelete`})))}function w(e){return(0,d.d)(e.stores.meta,d.a.RECENT_GIFS).then(e=>e?{recentGifs:e.value.recentGifs,toDelete:e.value.toDelete}:{recentGifs:new Map,toDelete:[]})}function T(e,t){var n=new Map;return Array.from(e.entries()).forEach(e=>{var r=a()(e,2),i=r[0],s=r[1],o=t===i?s.weight+1e3:Math.floor(.9*s.weight);null==s.contentPath&&o<500?__LOG__(2)`_recomputeRecentGifWeights: No need to keep gif ${i} with weight ${o}`:n.set(i,(0,l.j)(s,{weight:o}))}),n}function A(e){return Array.from(e.values()).filter(e=>null!=e.contentPath).sort((e,t)=>e.weight===t.weight?e.lastSent>t.lastSent?-1:1:e.weight>t.weight?-1:1)}function O(e){return{gifId:e.gifId,size:e.plaintext.size,gifAttribution:e.gifAttribution,preview:e.preview,highResPreview:e.frame,bg:e.bg,width:e.width,height:e.height,duration:e.duration,rotation:e.rotation}}function M(e,t,n){return(0,c.f)("createFavoriteGif",r=>r.transact("rw",["favoriteGifs"],()=>r.stores.favoriteGifs.where("plaintextHash").equals(e).first().then(a=>{if(a)return __LOG__(3)`setFavoriteGifContent gif already saved`,a;var i={plaintextHash:e,created:(0,u.E)(),relativePath:t,gifId:n.gifId,gifAttribution:n.gifAttribution};return r.stores.favoriteGifs.add(i).then(e=>Object.assign({id:e},i))})))}function C(e){return(0,c.f)("isFavoriteGif",t=>(0,s.i)(t.stores.favoriteGifs.where("plaintextHash").equals(e).first().then(e=>null!=e)))}function R(e,t){return(0,c.f)("isFavoriteGifFromId",n=>(0,s.i)((0,s.j)(n.stores.favoriteGifs,["gifAttribution","gifId"]).equals([e,t]).first().then(e=>null!=e)))}function N(e){return(0,c.f)("getFavoriteGif",t=>t.transact("rw",["favoriteGifs"],()=>t.stores.favoriteGifs.where("plaintextHash").equals(e).first()))}function k(e,t){return(0,c.f)("getFavoriteGifFromId",n=>n.transact("rw",["favoriteGifs"],()=>(0,s.j)(n.stores.favoriteGifs,["gifAttribution","gifId"]).equals([t,e]).first()))}function P(e,t){return(0,c.f)("getFavoriteGifs",n=>n.transact("rw",["favoriteGifs"],()=>null==e?n.stores.favoriteGifs.orderBy("id").reverse().limit(t).toArray():n.stores.favoriteGifs.where("id").below(e).reverse().limit(t).toArray()).then(e=>{var t=[];return e.forEach(e=>{var n=F(e);null!=n&&t.push(n)}),t}))}function G(e,t,n){return(0,c.f)("markFavoriteGifAsStored",r=>r.transact("rw",["favoriteGifs"],()=>r.stores.favoriteGifs.where("plaintextHash").equals(e).first().then(e=>{if(e){var a=Object.assign({},e,{contentPath:t,info:O(n)});return r.stores.favoriteGifs.put(a).then(()=>F(a))}__LOG__(3)`markFavoriteGifAsStored no ref found`})))}function L(e){return(0,c.f)("deleteFavoriteGif",t=>t.transact("rw",["favoriteGifs"],()=>t.stores.favoriteGifs.where("plaintextHash").equals(e).delete().then(()=>{})))}function D(e,t){return(0,c.f)("deleteFavoriteGifFromId",n=>n.transact("rw",["favoriteGifs"],()=>(0,s.j)(n.stores.favoriteGifs,["gifAttribution","gifId"]).equals([t,e]).delete().then(()=>{})))}function x(e){return(0,c.f)("markFavoriteGifContentAsDeleted",t=>(0,s.i)(t.stores.favoriteGifs.where("plaintextHash").equals(e).delete().then(()=>{})))}function U(e){return(0,c.f)("getGifUploadRequest",t=>(0,s.i)(t.stores.msgs.where("id").anyOf(e).toArray().then(e=>{var n=[];return e.forEach(e=>{if(e.type===p.f.GIF&&e.hasPreview&&e.media&&e.frame&&e.plaintext&&e.bg&&e.gifAttribution){var r=e.bg,u=e.media,d=e.frame,c=e.plaintext,v=e.gifAttribution,g=(0,i.u)(u),_=(0,o.e)(c);if(null!=_){var E=(0,s.c)([t.stores.media.get(u),t.stores.previews.get(g)]).then(n=>{var i=a()(n,2),s=i[0],o=i[1];if(null==s||null==o)return __LOG__(2)`getGifUploadRequestsByIds: ${e.id} has no media`,null;var u=s.plaintextHash;return t.stores.favoriteGifs.where("plaintextHash").equals(u).first().then(t=>t&&t.contentPath?(__LOG__(2)`getGifUploadRequestsByIds: ${e.id} already favorited and has content`,null):(__LOG__(2)`getGifUploadRequestsByIds: obtaining ${e.id} info`,(function(e,t,n){return Promise.all([(0,m.e)("page","getBlobFromPhoneStorage",{path:e}),(0,h.getChunkTable)().getFrame(t),(0,l.h)(n)]).then(n=>{var r=a()(n,3),i=r[0],s=r[1],o=r[2];if(null==s)return __LOG__(3)`getGifVideoInfo: ${t} has no frame data`,null;if(null==o)return __LOG__(3)`getGifVideoInfo: error converting blob`,null;var u=i.blob;return null==u?(__LOG__(3)`getGifVideoInfo: ${e} has no blob data`,null):(0,f.a)(u).then(e=>{if("error"===e.type)return __LOG__(3)`getGifVideoInfo: unable to parse stored gif`,null;e.type;var t=e.info.video;if(null==t)return __LOG__(3)`'getGifVideoInfo: stored gif not video!'`,null;var n=t.duration;return isNaN(n)?(__LOG__(3)`'getGifVideoInfo: stored gif has unknown length'`,null):{plaintext:u,info:Object.assign({},t,{duration:Math.ceil(n)}),frame:s,preview:o}})})})(_,d,o.preview).then(e=>{if(null==e)return null;var t=e.frame,n=e.plaintext,a=e.info,i=e.preview;return{request:Object.assign({type:"gif",bg:r,gifAttribution:v,frame:t,preview:i,plaintext:n},a,{gifId:null,caption:null}),plaintextHash:u}})))});n.push(E)}}}),(0,s.c)(n).then(e=>e.filter(e=>null!=e))})))}function F(e){return void 0===e.contentPath?null:{id:e.id,plaintextHash:e.plaintextHash,contentPath:e.contentPath,info:e.info}}},function(e,t,n){n.d(t,"c",(function(){return u})),n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return c}));var r=n(3),a=n(23),i=n(2),s={[i.g.TC_RECEIVED]:{num_buckets:"tctoken_num_buckets",duration:"tctoken_duration"},[i.g.TC_SENDER]:{num_buckets:"tctoken_num_buckets_sender",duration:"tctoken_duration_sender"}},o=180*r.b;function u(e){var t=(0,a.a)(s[e].duration),n=(0,a.a)(s[e].num_buckets),i=(0,r.E)(),u=Math.floor(i/t)-(n-1),d=(0,r.j)(u*t),c=(0,r.x)(o,i);return d>c?d:c}function d(e){return e.ts<u(e.type)}function c(e){var t=(0,a.a)("tctoken_duration_sender"),n=Math.floor((0,r.E)()/t);return Math.floor(e.ts/t)<n}},function(e,t,n){n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o})),n.d(t,"c",(function(){return u}));var r=n(27),a=n.n(r),i=n(128),s=4,o={algo:{type:"constant",delay:1e3},jitter:0},u=class{constructor(e,t,n){this.aG=e,this.routesInfo=t,this.aH=(0,i.a)(o),this.aI=0,this.aJ=!1,this.aK=n}run(e,t){var n=this;return a()((function*(){for(;n.aI<s;){yield n.aH();var r=void 0;n.aI>0?(r=n.aI>=s-2&&!n.aJ,"download"===n.aG&&(__LOG__(2)`MediaOperationsRetrier:download wait for internet, attempt = ${n.aI}`,yield null==n.aK?void 0:n.aK())):r=!1;var a=n.routesInfo;if(!a)return null;var i=a.host;r&&a.fallbackHost&&(i=a.fallbackHost);var o=yield e(i,a.authToken,n.aI,t);if(o.success)return o.value;++n.aI,n.aJ=o.error.progressMade}return null}))()}}},function(e,t,n){n.d(t,"b",(function(){return wr})),n.d(t,"a",(function(){return Tr})),n.d(t,"c",(function(){return Ar}));var r=n(28),a=n(343),i=n(8),s=n(17),o=n(222),u=n(29),d=n(102),c=n(260),l=n(4),p=n(27),h=n.n(p),f=n(9),m=n.n(f),v=n(88),g=n(301),_=n(360),E=n(47),b=n(63),y=n(239),S=n(62),I=n(67),w=n(154),T=n(401),A=n(402),O=n(2),M=n(37),C=n(31),R=n.n(C),N=n(7),k=n(11),P=n(30),G=n(16),L=n(3),D=n(14),x=n(6),U=n(242),F=n(111),B=n(175),j=n(25),V=n(43),K=n(0),H={};H.internalSpec={duration:[1,K.d.SFIXED32],timestamp:[2,K.d.SFIXED64]};var $=n(106),q=new Uint8Array(32),z=n(229),J=n(104),Y=(function(){var e=h()((function*(e,t,n){for(var r=n,a=e.length,i=0;i<a;i++)r=yield t(r,e[i],i);return r}));return function(t,n,r){return e.apply(this,arguments)}})();function W(e,t,n,r,a){if(t>=e||n&&n>=e)return{type:"skip-update"};var i=e,s=a.lastRunTs,o=r;return null!=o&&0!==o||(o=Date.now()),{type:"update",expectedTs:i,expectedTsUpdatedTs:o,expectedTsDeleteExpiredJobTs:s}}var Z=n(134);n(282),n(184),n(303);var Q=n(23),X=(n(169),n(21)),ee=n(33),te={skmsg:"skmsg",pkmsg:"pkmsg",msg:"msg"},ne={high:"high",low:"low",unknown:"unknown"},re=new v.b("incomingMsgParser",e=>{e.assertTag("message"),e.hasAttr("to")&&(0,_.a)(e,"to");var t=e.hasChild("unavailable"),n=e.mapChildrenWithTag("enc",e=>({e2eType:e.attrEnum("type",te),ciphertext:e.contentBytes(),retryCount:e.hasAttr("count")?e.attrInt("count"):0,hideFail:"hide"===e.maybeAttrString("decrypt-fail")}));0!==n.length||t||e.throw("to have enc node children or unavailable");var r=e.hasChild("device-identity")?(0,F.d)(e.child("device-identity").contentBytes()):null,a=e.hasChild("biz")?(0,B.getBspInfo)(e.child("biz")):void 0;return{from:e.attrFromPhoneJid(),content:{externalId:e.attrString("id"),ts:e.attrTime("t"),rawTs:e.attrString("t"),encs:n,isHsm:e.hasChild("hsm"),edit:e.hasAttr("edit")?e.attrInt("edit"):ee.b,verifiedNameSerial:e.hasAttr("verified_name")?e.attrLongInt("verified_name"):null,verifiedLevel:e.attrEnumOrDefault("verified_level",ne,null),verifiedNameCert:e.hasChild("verified_name")?e.child("verified_name").contentBytes():null,bspInfo:a,pushname:e.maybeAttrString("notify"),urlNumber:e.hasChild("url_number"),urlText:e.hasChild("url_text"),expiration:e.maybeAttrInt("expiration"),ephSetting:e.maybeAttrString("eph_setting"),unavailable:t,signedDeviceIdentity:r,recipient:null}}}),ae=(0,v.c)("handleMsg",re,e=>"status"===e.from.type?(0,b.b)((0,N.h)(e.from.author)).then(t=>{if(!t||null==t.phonebookPhone){__LOG__(3)`Received status for non-existing contact`;var n=null!=t&&null!=t.lastKnownName&&(null!=t.lastKnownName.fullName||null!=t.lastKnownName.shortName);return WAM.log("regular",1260,void 0,[1,1,n]),se(e.content,e.from)}return ie(e.content,e.from,fe,me)}):ie(e.content,e.from,ce,he));function ie(e,t,n,a){var s=e.externalId,o=t.author,d=(function(e){switch(e.type){case"device":return null;case"group":return e.groupJid;case"broadcast":return e.broadcastJid;case"status":return k.h;default:return(0,R.a)(e.type)}})(t),c=(function(e){switch(e.type){case"device":case"group":case"broadcast":return e.chat;case"status":return k.h;default:return(0,R.a)(e.type)}})(t);return(0,i.d)(c,()=>e.unavailable&&"status"!==t.type?(function(e,t){var n=e.externalId,r=e.ts,a=e.verifiedNameSerial,i=e.verifiedLevel,s=e.verifiedNameCert,o=e.bspInfo,u=(0,N.h)(t.author),d={msg:{type:O.f.MD_PLACEHOLDER,externalId:n,ts:r,author:u,ack:O.a.RECEIVED,altIndex:""}};if(i){var c={level:i,serial:a||-1,cert:s,bsp:o};d.contactVerification=c}return pe(t.chat,u,d).then(()=>{})})(e,t).then(()=>(0,l.v)("ack",{id:(0,l.b)(s),from:(0,l.g)(x.r.get()),to:(0,l.l)(t),class:"message"})):Y(e.encs,(r,i)=>{if("success"!==r.result)return Promise.resolve(r);var c=i.e2eType,l=i.ciphertext,p=i.retryCount,h=i.hideFail,f=null!=d?{type:"multicast",to:d}:{type:"user",to:o},m={onSuccess:r=>{var a=(0,g.a)(r),i=(0,I.a)(S.g,a);(0,z.a)({type:c,destination:f,e2eSenderType:(0,J.d)(o),e2eSuccessful:!0,messageMediaType:(0,J.e)(i)});var s=(function(e,t,n){var r=e.senderKeyDistributionMessage;if(r){var a=r.groupId;if(t)if(a&&t===a){var i=r.axolotlSenderKeyDistributionMessage;if(i)return u.e({group:t,sender:n,skdist:i});__LOG__(4)`skmsg from ${n} has no content`}else __LOG__(4)`skmsg from ${n} mismatched to ${t}, says ${a}`;else __LOG__(4)`skmsg from ${n} says ${a} but unattached`}})(i,d,o);return Promise.resolve(s).then(()=>n(e,t,i,a))},onDecryptFailure:n=>{var r=(0,J.c)(n),i={type:c,destination:f,e2eSenderType:(0,J.d)(o),e2eFailureReason:null!=r?r:void 0,e2eSuccessful:!1};(0,z.a)(i);var u=(0,Z.a)(s);switch(n){case E.b.ERR_DUPLICATE_MESSAGE:return __LOG__(2)`Msg ${u} is duplicate`,{result:"success"};case E.b.ERR_NO_SESSION:__LOG__(2)`Msg ${u} has no session`;break;case E.b.ERR_INVALID_KEY_ID:__LOG__(2)`Msg ${s} has invalid key id`;break;case E.b.ERR_INVALID_KEY:__LOG__(2)`Msg ${u} has invalid key`;break;case E.b.ERR_INVALID_SIGNED_PRE_KEY:__LOG__(2)`Msg ${u} has invalid signed pre key`;break;case E.b.ERR_SIGNED_PRE_KEY_ID_MISMATCH:__LOG__(2)`Msg ${u} has mismatched signed pre key id`;break;case E.b.ERR_SIGNED_PRE_KEY_DESERIALIZATION:__LOG__(2)`Cannot deserialize local signed pre key while processing msg ${u}`;break;case E.b.ERR_INVALID_ONE_TIME_KEY:__LOG__(2)`Msg ${u} has invalid one time key`;break;case E.b.ERR_ONE_TIME_KEY_ID_MISMATCH:__LOG__(2)`Msg ${u} has mismatched one time key id`;break;case E.b.ERR_ONE_TIME_KEY_DESERIALIZATION:__LOG__(2)`Cannot deserialize local one time key while processing msg ${u}`;break;case E.b.ERR_INVALID_MESSAGE:__LOG__(2)`Msg ${u} has invalid message`;break;default:return __LOG__(4)`TODO: unhandled error code ${n} for msg ${u}`,{result:"success"}}return h?{result:"retry",retryCount:p}:a(e,t,p)}};if("skmsg"===c)return d?u.h(d,o,l,m):(__LOG__(4)`Can not do skmsg for non group ${o}`,Promise.resolve({result:"success"}));if("pkmsg"!==c||(0,N.r)(o))return u.i(o,c,l,m);var v=e.signedDeviceIdentity;return v?(0,F.f)(v,l,o).then(n=>n?u.i(o,c,l,m):(__LOG__(4)`handleMsg failed ADV verification`,a(e,t,p))):(__LOG__(4)`handleMsg pkmsg from companion device must have device-identity`,a(e,t,p))},{result:"success"}).then(n=>{switch(n.result){case"success":return se(e,t);case"hsm-envelope-mismatch":return(0,r.l)((0,l.v)("receipt",{to:(0,l.l)(t),participant:(0,l.j)(t),id:(0,l.b)(s),type:"error"},(0,l.v)("error",{type:"hsm-envelope-mismatch"})),{id:s,class:"receipt",from:(0,l.s)(t),participant:(0,l.r)(t),type:"error"}).then(()=>se(e,t));case"retry":var a,i=n.retryCount+1,o=()=>u.H().then(e=>({registrationNode:(0,l.v)("registration",null,(0,v.a)(e)),keysNode:null}));a=i>=2?u.N().then(e=>({registrationNode:(0,l.v)("registration",null,(0,v.a)(e.regId)),keysNode:(0,l.v)("keys",null,(0,l.v)("type",null,""),(0,l.v)("identity",null,e.staticPublicKey),(0,U.a)(e.preKey),(0,U.b)(e.signedPreKey))})).catch(e=>(__LOG__(4)`handleMsg error with info: ${e}`,o())):o();var d=i>=3?(0,P.b)().waitUntilCompleted(G.e.requestPreKeyDigest()):null;return Promise.all([a,d]).then(n=>{var a=m()(n,1)[0],o=(0,l.v)("receipt",{id:(0,l.b)(s),to:(0,l.l)(t),participant:(0,l.j)(t),type:"retry"},(0,l.v)("retry",{v:"1",count:(0,l.f)(i),id:(0,l.b)(s),t:(0,l.b)(e.rawTs)}),a.registrationNode,a.keysNode);return(0,r.l)(o,{id:s,class:"receipt",from:(0,l.s)(t),participant:(0,l.r)(t),type:"retry"}).then(()=>"NO_ACK")});default:return(0,R.a)(n.result)}}))}function se(e,t){return(0,l.v)("receipt",{id:(0,l.b)(e.externalId),to:(0,l.l)(t),participant:(0,l.j)(t)})}function oe(){return __LOG__(4)`Received message with <hsm/> tag but the message is actually not an HSM`,Promise.resolve({result:"hsm-envelope-mismatch"})}function ue(){return Promise.resolve({result:"success"})}function de(e,t,n){var r=n.hydratedTemplate;if(!r)return oe();var a=r.hydratedContentText,i=r.templateId;if(!a||!i)return oe();var s="broadcast"===t.type?{broadcastJid:t.broadcastJid}:Object.freeze({}),o=(0,w.a)(Object.assign({externalId:e.externalId,jid:t.chat,author:t.author,ts:e.ts,hydratedTemplate:r,verifiedLevel:e.verifiedLevel,verifiedNameSerial:e.verifiedNameSerial,verifiedNameCert:e.verifiedNameCert,bspInfo:e.bspInfo,pushname:e.pushname},s,{isHsm:!0}));if(!o)return oe();var u=(0,N.h)(t.author);return pe(t.chat,u,o).then(ue)}function ce(e,t,n,r){return(function(e,t){le.apply(this,arguments)})(t.author,n.messageContextInfo),e.isHsm?n.highlyStructuredMessage?(function(e,t,n){return n?n.hydratedHsm?de(e,t,n.hydratedHsm):(__LOG__(4)`Got dehydrated HSM message, even though server was supposed not to send it`,SEND_LOGS("handle-msg-got-dehydrated-hsm"),oe()):oe()})(e,t,n.highlyStructuredMessage):n.templateMessage?(function(e,t,n){return n?n.hydratedTemplate?de(e,t,n):(__LOG__(4)`Got dehydrated template HSM message, even though server was supposed not to send it`,SEND_LOGS("handle-msg-got-dehydrated-hsm"),oe()):oe()})(e,t,n.templateMessage):oe():n.highlyStructuredMessage||n.templateMessage&&n.templateMessage.hydratedTemplate?Promise.resolve({result:"hsm-envelope-mismatch"}):(function(e,t,n,r){var a={externalId:e.externalId,jid:t.chat,author:t.author,ts:e.ts,proto:n,bytes:r,edit:e.edit,verifiedNameSerial:e.verifiedNameSerial,verifiedLevel:e.verifiedLevel,verifiedNameCert:e.verifiedNameCert,bspInfo:e.bspInfo,pushname:e.pushname,urlNumber:e.urlNumber,urlText:e.urlText,expiration:e.expiration};if("broadcast"===t.type&&(a.broadcastJid=t.broadcastJid,e.ephSetting&&(a.ephSetting=e.ephSetting)),(0,Q.a)("reactions_receive")&&null!=n.reactionMessage){var i=(0,T.a)(a,n.reactionMessage);return i?(0,y.f)(i).then(ue):(__LOG__(4)`Invalid reaction msg`,ue())}var o=(0,w.h)(a);if(!o)return n.senderKeyDistributionMessage?__LOG__(2)`msg was just sender key`:__LOG__(4)`Poorly formatted protobuf!`,ue();if(o.ephSetting||o.ephemeralSharedSecret)return(function(e,t){var n=e.ephSetting;if(!n)return __LOG__(4)`maybeProcessEphemeralBCLMessage called with missing ephSetting`,SEND_LOGS("maybeProcessEphemeralBCLMessage-undefined-ephSetting"),ue();var r=e.ephemeralSharedSecret;if(!r)return __LOG__(4)`maybeProcessEphemeralBCLMessage called with missing ephemeralSharedSecret`,SEND_LOGS("maybeProcessEphemeralBCLMessage-undefined-shared-secret"),ue();var a=e.msg.broadcastJid;return a?(function(e,t,n,r,a){var i=j.a.build(`Ephemeral ${t} ${e}`).readByteArray(),s=new Uint8Array(a),o=(0,V.b)(r),u=j.a.build((0,N.h)(n)).readBuffer();return(function(e,t){return self.crypto.subtle.importKey("raw",e,"HKDF",!1,["deriveKey"]).then(e=>self.crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:q,info:t},e,{name:"HMAC",hash:"SHA-256"},!0,["verify"])).then(e=>self.crypto.subtle.exportKey("raw",e))})(s,i).then(e=>(function(e,t,n){var r=e.slice(0,12),a=e.slice(12,44);return self.crypto.subtle.importKey("raw",a,"AES-GCM",!1,["decrypt"]).then(e=>self.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(r),additionalData:n},e,t))})(e,o,u)).then(e=>{var t=(0,I.a)(H,e),n=t.duration,r=t.timestamp;return null==n||null==r?(__LOG__(3)`ephSetting decoded into malformed proto`,Promise.reject("ephSetting decoded into malformed proto")):{expiration:n,timestamp:(0,L.j)((0,$.e)(r))}})})(a,x.r.get(),t.author,n,r).then(n=>(e.msg.expiration=n.expiration,e.msg.ephemeralSettingTimestamp=n.timestamp,(0,s.gd)(t.chat,e).then(ue))).catch(()=>(__LOG__(3)`ephSetting Failed to decode`,SEND_LOGS("eph-setting-failed-to-decode"),ue())):(__LOG__(3)`maybeProcessEphemeralBCLMessage for non-broadcast message`,SEND_LOGS("maybeProcessEphemeralBCLMessage-non-broadcast"),ue())})(o,t);var u=(0,N.h)(t.author);return pe(t.chat,u,o).then(ue)})(e,t,n,r)}function le(){return(le=h()((function*(e,t){var n=null==t?void 0:t.deviceListMetadata;if(null!=n){var r=(0,N.h)(e),a=yield(0,s.J)(r),i=a.contact,o=a.jobInfo,d=null==i?void 0:i.deviceVerification;if(null!=i&&null!=d){var c=n.senderTimestamp,l=n.senderKeyHash;if(null!=c)if((0,N.r)(e)&&null==l){var p=parseInt(c,10);if(p>=d.timestamp){var h=i.devices;null!=h&&(yield u.l(r,h.map(e=>e.id)),yield(0,s.ob)(r,{usyncResponse:{type:"adv_devices_reset",rawId:d.rawId,newIncomingTs:p+1}}))}}else{var f=W(parseInt(c,10),d.timestamp,d.expectedTs,d.expectedTsUpdatedTs,o);"update"===f.type&&(yield(0,s.Rc)(r,f.expectedTs,f.expectedTsUpdatedTs,f.expectedTsDeleteExpiredJobTs))}}}}))).apply(this,arguments)}function pe(e,t,n){return null!=n.contactVerification?(0,P.b)().waitUntilPersisted(G.e.validateBusinessMsg(e,n)):(0,b.b)(t).then(t=>t&&null!=t.verifiedInfo?(0,P.b)().waitUntilPersisted(G.e.validateBusinessMsg(e,n)):(0,s.gd)(e,n))}function he(e,t,n){var r=(0,N.h)(t.author),a={msg:{type:O.f.CIPHERTEXT,externalId:e.externalId,ts:e.ts,author:r,deviceId:(0,N.f)(t.author),ack:O.a.RECEIVED,altIndex:""}};if(e.verifiedLevel){var i={level:e.verifiedLevel,serial:e.verifiedNameSerial||-1,cert:e.verifiedNameCert,bsp:e.bspInfo};a.contactVerification=i}return pe(t.chat,r,a).then(()=>({result:"retry",retryCount:n}))}function fe(e,t,n,r){var a=(0,A.a)({externalId:e.externalId,author:t.author,ts:e.ts,proto:n,bytes:r,edit:e.edit,verifiedNameSerial:e.verifiedNameSerial,verifiedLevel:e.verifiedLevel,verifiedNameCert:e.verifiedNameCert,pushname:e.pushname,urlNumber:e.urlNumber,urlText:e.urlText});return a?(0,L.n)(a.msg.ts,D.Q)?(0,s.id)((0,N.h)(t.author),a).then(()=>({result:"success"})):(__LOG__(2)`status msg arrived after it was expired. Ignoring`,Promise.resolve({result:"success"})):(n.senderKeyDistributionMessage?__LOG__(2)`msg was just sender key`:__LOG__(4)`Poorly formatted protobuf!`,Promise.resolve({result:"success"}))}function me(e,t,n){if(!(0,L.n)(e.ts,D.Q))return __LOG__(2)`ciphertext status msg arrived after it was expired. Ignoring`,Promise.resolve({result:"success"});var r=(0,N.h)(t.author),a={msg:{type:M.c.CIPHERTEXT,externalId:e.externalId,ts:e.ts,author:r,deviceId:(0,N.f)(t.author),ack:O.a.RECEIVED,altIndex:""}};return(0,s.id)(r,a).then(()=>({result:"retry",retryCount:n}))}var ve=Promise.resolve();function ge(e,t){var n=ve.then(()=>e);return ve=n,n.then(e=>Promise.resolve(t(e)).then(e=>null!=e?e:"NO_ACK"))}function _e(e,t){var r=e.attrs;switch(e.tag){case"iq":return(function(e){var t=e.attrs;if("urn:xmpp:ping"===t.xmlns)return(0,l.v)("iq",{type:"result",to:t.from});throw new Error("handleIq unrecognized "+e.toString())})(e);case"receipt":if("retry"===r.type)return ge(n.e(66).then(n.bind(null,556)),t=>t.default(e));var a=e.content;if(Array.isArray(a)&&a.length>0){var i=a[0].tag;if("offer"===i||"accept"===i||"reject"===i)return ge(n.e(50).then(n.bind(null,557)),t=>t.default(e))}return ge(Promise.all([n.e(5),n.e(6),n.e(18),n.e(63)]).then(n.bind(null,656)),t=>t.default(e));case"notification":switch(r.type){case"w:gp2":return ge(n.e(55).then(n.bind(null,558)),t=>t.default(e));case"picture":return ge(Promise.all([n.e(1),n.e(22),n.e(65)]).then(n.bind(null,559)),t=>t.default(e));case"business":return ge(Promise.all([n.e(1),n.e(49)]).then(n.bind(null,560)),t=>t.default(e));case"contacts":return ge(Promise.all([n.e(1),n.e(52)]).then(n.bind(null,561)),t=>t.default(e));case"mediaretry":return ge(Promise.all([n.e(6),n.e(62)]).then(n.bind(null,562)),t=>t.default(e));case"encrypt":var s=e.content;if(!Array.isArray(s)||!s.length)break;var o=s[0].tag;if("count"===o)return ge(Promise.resolve().then(n.bind(null,377)),n=>n.handlePreKeysLow(e,t));if("identity"===o)return ge(Promise.resolve().then(n.bind(null,150)),t=>t.handleE2eIdentityChange(e));if("digest"===o)return ge(n.e(58).then(n.bind(null,563)),t=>t.handleDigestNotification(e));break;case"server":return ge(n.e(67).then(n.bind(null,564)),t=>t.default(e));case"status":return ge(Promise.all([n.e(1),n.e(48)]).then(n.bind(null,565)),t=>t.default(e));case"gdpr":return ge(n.e(54).then(n.bind(null,566)),t=>t.default(e));case"devices":return ge(Promise.all([n.e(1),n.e(57)]).then(n.bind(null,567)),t=>t.handleDevicesNotification(e));case"account_sync":return ge(Promise.all([n.e(5),n.e(18),n.e(56)]).then(n.bind(null,652)),t=>t.handleAccountSyncNotification(e));case"psa":return ge(n.e(60).then(n.bind(null,568)),t=>t.default(e));case"disappearing_mode":return ge(n.e(59).then(n.bind(null,569)),t=>t.default(e));case"privacy_token":return ge(n.e(61).then(n.bind(null,570)),t=>t.default(e))}if(r.hasOwnProperty("id"))return(0,l.v)("ack",{id:r.id,class:"notification",from:r.to||l.d,to:r.from||l.d,type:r.type||l.d,participant:r.participant||l.d});break;case"chatstate":return ge(n.e(51).then(n.bind(null,571)),t=>t.default(e));case"presence":return ge(n.e(64).then(n.bind(null,572)),t=>t.default(e));case"message":return ge(Promise.resolve(),()=>ae(e));case"ib":return ge(n.e(19).then(n.bind(null,537)),t=>t.default(e));case"call":return ge(n.e(50).then(n.bind(null,557)),t=>t.default(e));case"stream:error":return ge(n.e(68).then(n.bind(null,573)),t=>t.default(e));case"stream:stream":return"NO_ACK";case"failure":return ge(Promise.resolve().then(n.bind(null,247)),t=>t.default(e));case"success":return ge(Promise.resolve().then(n.bind(null,343)),t=>t.default(e));case"error":return ge(n.e(53).then(n.bind(null,574)),t=>t.handleError(e))}return __LOG__(3)`Comms.handleStanza unrecognized stanza ${e}`,"NO_ACK"}var Ee=n(12),be=n(236),ye=n(141),Se=n(40);function Ie(e,t){null==t?(0,r.a)((0,l.v)("presence",{to:(0,l.g)(e),type:"subscribe"})):(0,r.a)((0,l.v)("presence",{to:(0,l.g)(e),type:"subscribe"},(0,l.v)("tctoken",null,t)))}var we=n(243),Te=n(46),Ae=new Te.a("pushResult",e=>{e.assertAttr("type","result")}),Oe=n(107),Me=n(247),Ce=new Te.a("deleteAccountReply",e=>{}),Re=n(329),Ne=n(35),ke=n(317),Pe=n(155),Ge=n(71),Le=n(70),De=class{constructor(){this.Yx=new Ge.a,this.Yy=new Le.a(()=>{Ue()||(__LOG__(2)`BackendEphemeralCleaner::_clearTimer`,this.Yx.enqueue(()=>(0,s.M)().then(e=>{var t=[];return e.forEach((e,n)=>{t.push((0,s.m)(n,e,"expired"))}),Promise.all(t)}).then(()=>(0,s.X)()).then(e=>{null!=e&&this.update(e)})))}),this.Yy.forceRunNow()}update(e){__LOG__(2)`BackendEphemeralCleaner::update ${e}`,this.Yy.onOrBefore((0,L.h)(e))}},xe=null;function Ue(){var e=(0,Ee.d)()||!x.E.get().ephemeralPruningEnabled;return e&&__LOG__(2)`BackendEphemeralCleaner:: disabled`,e}var Fe=class{constructor(){this.Yu=new Ge.a,this.Yv=new Le.a(()=>{je()||this.Yu.enqueue(()=>this.Yw())}),this.Yv.forceRunNow()}update(e){__LOG__(2)`ViewOnceExpirer::update ${e}`,this.Yv.onOrBefore((0,L.h)(e))}Yw(){return __LOG__(2)`ViewOnceExpirer::_purge`,(0,s.r)().then(e=>{var t=e.expiredMsgs,n=e.updatedChats;t.length>0&&(0,Ee.c)("event","viewOnceExpired",{expiredMsgs:t,updatedChats:n})}).then(()=>(0,s.Y)()).then(e=>{null!=e&&this.update(e)})}},Be=null;function je(){return!x.E.get().viewOnceWrite&&!x.E.get().viewOnceRead}var Ve=n(219),Ke=n(408),He=n(305),$e=n(74),qe=n(82),ze=n(89),Je=n(122),Ye={preview:"preview",image:"image"},We=new Te.a("getProfilePic",e=>{if(e.hasChild("picture")){var t=e.child("picture");return{code:200,id:t.attrInt("id"),type:t.attrEnum("type",Ye),url:t.attrString("url")}}return{code:304}});function Ze(e,t){return(0,l.v)("iq",{to:l.k,target:(0,l.g)(e),type:"get",xmlns:"w:profile:picture",id:(0,l.t)()},t)}function Qe(e){return(0,$e.getProfilePicTable)().storeEmptyThumb(e).then(()=>((0,Ee.c)("event","avatarsUpdated",{cleared:[e]}),{jid:e,avatar:null}))}function Xe(e,t,n){return(0,$e.getProfilePicTable)().getThumb(e).then(a=>{if(a){if(!n&&a.lastUpdated&&(0,L.n)(a.lastUpdated,L.g))return a;if(a.dontRetryBefore&&(0,L.p)(a.dontRetryBefore))return a;null!=a.lastUpdated&&(0,Ee.c)("event","avatarsUpdated",{changed:[{jid:e,photoId:a.photoId}]})}return __LOG__(2)`getProfilePic request ${e} with previous id ${a?a.photoId:"none"}`,(0,r.e)(t(a&&a.photoId),We).then(t=>{if(!t.success)switch(t.errorCode){case 401:return(0,N.p)(e)?(0,$e.getProfilePicTable)().refreshLastUpdated(e).then(()=>null):(0,$e.getProfilePicTable)().storeEmptyThumb(e);case 404:case 406:return __LOG__(2)`getProfilePic for ${e}: No picture found in server`,(0,$e.getProfilePicTable)().storeEmptyThumb(e);case 500:case 501:case 503:return __LOG__(2)`getProfilePic error ${e}: Do not retry`,a?(0,$e.getProfilePicTable)().setDontRetryBefore(e,(0,L.l)(L.d)).then(()=>a):(0,$e.getProfilePicTable)().storeEmptyThumb(e,(0,L.l)(L.d));default:throw new Error(`Failed to get profile picture: ${t.errorCode} ${t.errorText}`)}var n=t.result;if(304===n.code){if(null==a)throw new Error("getProfilePic:  empty success response without id.");return __LOG__(2)`getProfilePic for ${e}: picture unchanged.`,(0,$e.getProfilePicTable)().refreshLastUpdated(e).then(()=>null)}var r=n.url;return(0,Ne.g)((0,Ne.h)(r)).then(t=>(__LOG__(2)`getProfilePic for ${e}: Fetched last version with id ${n.id}`,(0,ze.c)("image canvas"),(0,Ee.e)("event","profilePicReceived",{image:t}).then(r=>{var a=r.croppedImage;return(0,$e.getProfilePicTable)().storeThumb(e,{photoId:n.id,icon:a,thumb:t})}))).catch((0,Je.a)(qe.a,e=>{if(404===e.code)return __LOG__(2)`getProfilePic:fetchRetryBlob thumb not found, probably lost on server. Wait for re-upload.`,null;throw __LOG__(2)`getProfilePic:fetchRetryBlob thumburl ${e.code}`,e}))})}).then(e=>{e&&(0,Ee.c)("event","avatarsUpdated",{changed:[{jid:e.jid,photoId:e.photoId}]})})}var et=n(403),tt=new Te.a("getTwoFactor",e=>e.hasChild("2fa")?{code:e.child("2fa").hasChild("code"),email:e.child("2fa").hasChild("email")}:{code:!1,email:!1}),nt=new Te.a("checkTwoFactor",e=>e.hasChild("2fa")&&e.child("2fa").hasChild("code")),rt=n(292),at=n(177),it=n(293),st=n(105),ot=n(416),ut=new Ge.a;function dt(){return ut.enqueue(()=>Promise.resolve())}var ct=n(218),lt=n(344),pt=n(115),ht=n(91),ft=n(173),mt=n(309),vt=n(405),gt=n(15),_t=n(114),Et=n(34),bt=n(10);function yt(){return(0,Et.l)(16)}function St(){var e=x.y.get(),t=!1,n=new Set,r=D.F.reduce((r,a)=>{var i,s=a.keyHashInt,o=a.rotationPeriodDays;if(n.add(s),null!=e[s])return r;if(113760892===s){var u=x.x.get();null==u?(i=yt(),(0,Q.a)("kaios_privatestats_phase3_enabled")?WAM.log("regular",2862,void 0,[2,0,1,1,0,s,3,0,o]):WAM.log("regular",2310,void 0,[])):i=u}else i=yt(),(0,Q.a)("kaios_privatestats_phase3_enabled")&&WAM.log("regular",2862,void 0,[2,0,1,1,0,s,3,0,o]);var d={value:i,creationTs:(0,L.E)()};return r[s]=d,t=!0,r},{}),a=(0,bt.v)(e).reduce((e,r)=>{var a=m()(r,1)[0];return n.has(parseInt(a,10))||(e.push(a),t=!0),e},[]);if(!t)return Promise.resolve(It(e));var i=Object.assign({},e,r);return a.forEach(e=>{delete i[e];var t=parseInt(e,10);113760892===t&&x.x.set(null),(0,Q.a)("kaios_privatestats_phase3_enabled")&&WAM.log("regular",2862,void 0,[2,0,3,1,0,t])}),x.y.set(i).then(()=>It(i))}function It(e){var t=new Map;return D.F.forEach(n=>{var r=n.keyHashInt,a=e[r].value;t.set(r,a)}),t}var wt=n(284),Tt=n(262),At=n(261),Ot=n(376),Mt=n(417),Ct=n(142),Rt=n(59),Nt=n(64),kt=n(51),Pt=n(5),Gt=n(77),Lt=n(201),Dt=n(195),xt=n(58),Ut=n(205),Ft=n(49),Bt=n(20),jt=n(42),Vt=n(24),Kt=n(86),Ht=n(238),$t=n(79),qt=n(26),zt=n(60);function Jt(e,t){return{type:"usync",advResult:e,deviceVerificationFailed:t||!1}}function Yt(e,t){return{type:"device-change",advResult:e,requestDeviceSync:t||!1}}function Wt(e,t,n){var r=[],a=[],i=e.jid;(0,zt.d)(e).forEach(e=>{e!==k.c&&a.push((0,N.A)(i,e))});var s=new Map;return n&&n.forEach(e=>{var t=e.id,n=e.index;s.set(t,n),r.push((0,N.A)(i,t))}),{addedDevices:r,removedDevices:a,updatedContact:Object.assign({},e,{devices:Qt(s),deviceVerification:{rawId:t.rawId,timestamp:t.timestamp}})}}function Zt(e,t){return!(!t.validIndexes.includes(e)||e>t.currentIndex)}function Qt(e){var t=Array.from(e.entries()).map(e=>{var t=m()(e,2);return{id:t[0],index:t[1]}});return e.has(k.c)||t.push(zt.a),t}var Xt=gt.q.TRIGGERED,en=gt.q.FETCHED,tn=gt.q.BANNER_SHOW,nn=gt.q.NON_BLOCKING_MODAL_SHOW,rn=gt.q.BLOCKING_MODAL_SHOW,an=gt.q.EXPIRED;function sn(e,t){var n=t.banner,r=t.nonBlockingModal,a=t.blockingModal;return e===Xt?(__LOG__(4)`maybeTimeTransitionNotice: can not perform time transitions in state 0`,SEND_LOGS("user-notice-time-transition-initial-state"),e):e<tn&&n?tn:e<nn&&r?nn:e<rn&&a?rn:an}function on(e,t){var n,r,a;if(e)switch(t){case tn:return null==(n=e.banner)?void 0:n.timing;case nn:return null==(r=e.nonBlockingModal)?void 0:r.timing;case rn:return null==(a=e.blockingModal)?void 0:a.timing;default:return}}var un=n(53),dn=n(39),cn=n(206),ln=(n(353),new Set([O.f.TEXT,O.f.AUDIO,O.f.IMAGE,O.f.PTT,O.f.GIF,O.f.VIDEO,O.f.VCARD,O.f.FUTUREPROOF,O.f.CIPHERTEXT,O.f.MD_PLACEHOLDER,O.f.DOCUMENT])),pn=n(318),hn=class extends Error{constructor(e){var t="SocketClosed";super(null!=e?e:t),this.name=t}};function fn(e){return!(e.size()<3)&&mn(e)<=e.size()}function mn(e){return e.readUint8()<<16|e.readUint16()}var vn=n(233),gn=n(120),_n=n(109),En=Promise.reject("UNINITIALIZED HANDSHAKE"),bn=new Uint8Array(0);function yn(e){var t=new ArrayBuffer(12);return new DataView(t).setUint32(8,e),new Uint8Array(t)}En.catch(()=>{});var Sn=n(61),In=Promise.reject("UNINITIALIZED HANDSHAKE"),wn=new Uint8Array(0);In.catch(()=>{});var Tn=class{constructor(e){this.ZA=In,this.ZB=In,this.ZC=In,this.ZD=0,this.Yz=e,this.ZE=new Sn.a,e.onClose=()=>{this.ZE.reject(new _n.a("NoiseHandshake: SocketClosed"))},Cn(this.ZE.promise)}start(e,t){var n=j.a.build(e).readBuffer(),r=32===n.byteLength?Promise.resolve(n):(0,gn.a)(n);this.ZA=r,this.ZB=r,this.ZC=r.then(On),this.authenticate(t)}sendAndReceive(e){var t=this.Yz,n=new Promise(n=>{t.onFrame=e=>{t.onFrame=null,n(e)},t.sendFrame(e)});return this.ZF(n)}send(e){this.Yz.sendFrame(e)}authenticate(e){this.ZA=Promise.all([this.ZA,e]).then(e=>{var t=m()(e,2),n=t[0],r=t[1],a=j.a.build(n,r).readByteArray();return(0,gn.a)(a)})}encrypt(e){var t=this.ZD++,n=Promise.all([this.ZC,this.ZA,e]).then(e=>{var n=m()(e,3),r=n[0],a=n[1],i=n[2];return(function(e,t,n,r){return self.crypto.subtle.encrypt({name:"AES-GCM",iv:An(t),additionalData:n?new Uint8Array(n):wn},e,r)})(r,t,a,i)});return this.authenticate(n),this.ZF(n)}decrypt(e){var t=this.ZD++,n=Promise.all([this.ZC,this.ZA]).then(n=>{var r=m()(n,2),a=r[0],i=r[1];return(function(e,t,n,r){return self.crypto.subtle.decrypt({name:"AES-GCM",iv:An(t),additionalData:n?new Uint8Array(n):wn},e,r)})(a,t,i,e)});return this.authenticate(e),this.ZF(n)}finish(){var e=this.ZB.then(e=>Mn(e,new Uint8Array(0))).then(e=>{var t=m()(e,2),n=t[0],r=t[1];return Promise.all([On(n,["encrypt"]),On(r,["decrypt"])])}).then(e=>{var t=m()(e,2),n=t[0],r=t[1];return new class{constructor(e,t,n){this.Zn=[],this.Zo=new Ge.a,this.Zp=new Ge.a,this.Zq=0,this.Zr=0,this.Zs=!1,this.Zx=e=>{this.Zk.closed?__LOG__(2)`NoiseSocket socket closed while encrypting frame`:this.Zk.sendFrame(e)},this.Zv=e=>{var t=this.Zq++;this.Zo.enqueueHandlers((function(e,t,n,r){return self.crypto.subtle.decrypt({name:"AES-GCM",iv:yn(t),additionalData:bn},e,r)})(this.Zl,t,0,e),this.Zy)},this.Zw=()=>{this.Zs=!0,this.Zo.wait().then(()=>{this.Zs=!1;var e=this.Zu;e&&e()})},this.Zy=e=>{this.Zt?this.Zt(e):this.Zn.push(e)},this.Zk=e,this.Zm=t,this.Zl=n,e.onFrame=this.Zv,this.Zk.onClose=this.Zw,e.convertBufferedToFrames()}sendFrame(e){if(!this.Zs){this.Zk.throwIfClosed();var t,n,r,a=this.Zr++;this.Zp.enqueueHandlers((t=this.Zm,n=a,r=e,self.crypto.subtle.encrypt({name:"AES-GCM",iv:yn(n),additionalData:bn},t,r)),this.Zx)}}setOnFrame(e){this.Zt=e}setOnClose(e){this.Zu=e}close(){this.Zk.close()}}(this.Yz,n,r)});return this.ZF(e)}mixIntoKey(e){this.ZD=0;var t=Promise.all([this.ZB,e]).then(e=>{var t=m()(e,2),n=t[0],r=t[1];return Mn(n,new Uint8Array(r))});this.ZB=t.then(e=>e[0]),this.ZC=t.then(e=>On(e[1])),Cn(this.ZB),Cn(this.ZC)}ZF(e){return Promise.race([e,this.ZE.promise]).then(e=>this.ZE.resolveWasCalled()?this.ZE.promise:e)}};function An(e){var t=new ArrayBuffer(12);return new DataView(t).setUint32(8,e),new Uint8Array(t)}function On(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["encrypt","decrypt"];return self.crypto.subtle.importKey("raw",new Uint8Array(e),"AES-GCM",!1,t)}function Mn(e,t){return(0,vn.b)(t,new Uint8Array(e),"",64).then(e=>[e.slice(0,32),e.slice(32)])}function Cn(e){e.catch(()=>{})}function Rn(e,t,n,r,a){var i=t||{},s=i.ephemeral,o=i.static,u=i.payload;if(null==s||null==o||null==u)return Promise.reject(new Error("doFullHandshakeCore server hello invalid proto"));e.authenticate(s),e.mixIntoKey(r.generateSharedSecret(s));var d=e.decrypt(o);e.mixIntoKey(d.then(e=>r.generateSharedSecret(e)));var c=e.decrypt(u);return Promise.all([d,c]).then(e=>{var t=m()(e,2),n=t[0],r=t[1];return __LOG__(2)`doFullHandshakeCore parsing and verifying server certificate`,a.processCertificate({certificate:r,serverStatic:n})}).then(()=>{var t=e.encrypt(a.staticKeyPair.generatePublicKey());e.mixIntoKey(a.staticKeyPair.generateSharedSecret(s));var r=e.encrypt(Promise.resolve(n));return Promise.all([t,r])}).then(t=>{var n=m()(t,2),r=n[0],i=n[1];return __LOG__(2)`doFullHandshakeCore client finish and deriving secrets`,e.send(a.encodeHandshakeFinish({static:r,payload:i})),e.finish()})}var Nn=n(271),kn=n(213),Pn=n(101),Gn={CELLULAR_UNKNOWN:0,WIFI_UNKNOWN:1,CELLULAR_EDGE:100,CELLULAR_IDEN:101,CELLULAR_UMTS:102,CELLULAR_EVDO:103,CELLULAR_GPRS:104,CELLULAR_HSDPA:105,CELLULAR_HSUPA:106,CELLULAR_HSPA:107,CELLULAR_CDMA:108,CELLULAR_1XRTT:109,CELLULAR_EHRPD:110,CELLULAR_LTE:111,CELLULAR_HSPAP:112},Ln={PUSH:0,USER_ACTIVATED:1,SCHEDULED:2,ERROR_RECONNECT:3,NETWORK_SWITCH:4,PING_RECONNECT:5},Dn={RELEASE:0,BETA:1,ALPHA:2,DEBUG:3},xn={ANDROID:0,IOS:1,WINDOWS_PHONE:2,BLACKBERRY:3,BLACKBERRYX:4,S40:5,S60:6,PYTHON_CLIENT:7,TIZEN:8,ENTERPRISE:9,SMB_ANDROID:10,KAIOS:11,SMB_IOS:12,WINDOWS:13,WEB:14,PORTAL:15,GREEN_ANDROID:16,GREEN_IPHONE:17,BLUE_ANDROID:18,BLUE_IPHONE:19,FBLITE_ANDROID:20,MLITE_ANDROID:21,IGLITE_ANDROID:22,PAGE:23,MACOS:24,OCULUS_MSG:25,OCULUS_CALL:26,MILAN:27,CAPI:28},Un={},Fn={},Bn={},jn={},Vn={},Kn={},Hn={},$n={},qn={},zn={},Jn={},Yn={},Wn={};function Zn(){var e=x.h.get(),t=Dn.RELEASE,n={username:parseInt(x.r.get(),10),passive:!1,connectType:Gn.WIFI_UNKNOWN,connectReason:Ln.USER_ACTIVATED,pushName:x.z.get(),userAgent:{mcc:e.mcc,mnc:e.mnc,appVersion:{primary:2,secondary:2218,tertiary:5},platform:xn.KAIOS,osVersion:e.osVersion,manufacturer:e.manufacturer,device:e.device,osBuildNumber:e.osBuild,releaseChannel:t,localeLanguageIso6391:e.lg,localeCountryIso31661Alpha2:e.lc}};return(0,Pn.a)(Hn,n).readByteArray()}Un.internalSpec={clientHello:[2,K.d.MESSAGE,jn],serverHello:[3,K.d.MESSAGE,Bn],clientFinish:[4,K.d.MESSAGE,Fn]},Fn.internalSpec={static:[1,K.d.BYTES],payload:[2,K.d.BYTES]},Bn.internalSpec={ephemeral:[1,K.d.BYTES],static:[2,K.d.BYTES],payload:[3,K.d.BYTES]},jn.internalSpec={ephemeral:[1,K.d.BYTES],static:[2,K.d.BYTES],payload:[3,K.d.BYTES]},Vn.internalSpec={details:[1,K.d.BYTES],signature:[2,K.d.BYTES]},Kn.internalSpec={serial:[1,K.d.UINT32],issuer:[2,K.d.STRING],expires:[3,K.d.UINT64],subject:[4,K.d.STRING],key:[5,K.d.BYTES]},Hn.internalSpec={username:[1,K.d.UINT64],passive:[3,K.d.BOOL],userAgent:[5,K.d.MESSAGE,Yn],webInfo:[6,K.d.MESSAGE,zn],pushName:[7,K.d.STRING],sessionId:[9,K.d.SFIXED32],shortConnect:[10,K.d.BOOL],connectType:[12,K.d.ENUM,Gn],connectReason:[13,K.d.ENUM,Ln],shards:[14,K.b.REPEATED|K.d.INT32],dnsSource:[15,K.d.MESSAGE,qn],connectAttemptCount:[16,K.d.UINT32],device:[18,K.d.UINT32],regData:[19,K.d.MESSAGE,$n],product:[20,K.d.ENUM,{WHATSAPP:0,MESSENGER:1}],fbCat:[21,K.d.BYTES],fbUserAgent:[22,K.d.BYTES],oc:[23,K.d.BOOL],lc:[24,K.d.INT32],iosAppExtension:[30,K.d.ENUM,{SHARE_EXTENSION:0,SERVICE_EXTENSION:1,INTENTS_EXTENSION:2}],fbAppId:[31,K.d.UINT64],fbDeviceId:[32,K.d.BYTES],pull:[33,K.d.BOOL]},$n.internalSpec={eRegid:[1,K.d.BYTES],eKeytype:[2,K.d.BYTES],eIdent:[3,K.d.BYTES],eSkeyId:[4,K.d.BYTES],eSkeyVal:[5,K.d.BYTES],eSkeySig:[6,K.d.BYTES],buildHash:[7,K.d.BYTES],companionProps:[8,K.d.BYTES]},qn.internalSpec={dnsMethod:[15,K.d.ENUM,{SYSTEM:0,GOOGLE:1,HARDCODED:2,OVERRIDE:3,FALLBACK:4}],appCached:[16,K.d.BOOL]},zn.internalSpec={refToken:[1,K.d.STRING],version:[2,K.d.STRING],webdPayload:[3,K.d.MESSAGE,Jn],webSubPlatform:[4,K.d.ENUM,{WEB_BROWSER:0,APP_STORE:1,WIN_STORE:2,DARWIN:3,WIN32:4}]},Jn.internalSpec={usesParticipantInKey:[1,K.d.BOOL],supportsStarredMessages:[2,K.d.BOOL],supportsDocumentMessages:[3,K.d.BOOL],supportsUrlMessages:[4,K.d.BOOL],supportsMediaRetry:[5,K.d.BOOL],supportsE2EImage:[6,K.d.BOOL],supportsE2EVideo:[7,K.d.BOOL],supportsE2EAudio:[8,K.d.BOOL],supportsE2EDocument:[9,K.d.BOOL],documentTypes:[10,K.d.STRING],features:[11,K.d.BYTES]},Yn.internalSpec={platform:[1,K.d.ENUM,xn],appVersion:[2,K.d.MESSAGE,Wn],mcc:[3,K.d.STRING],mnc:[4,K.d.STRING],osVersion:[5,K.d.STRING],manufacturer:[6,K.d.STRING],device:[7,K.d.STRING],osBuildNumber:[8,K.d.STRING],phoneId:[9,K.d.STRING],releaseChannel:[10,K.d.ENUM,Dn],localeLanguageIso6391:[11,K.d.STRING],localeCountryIso31661Alpha2:[12,K.d.STRING],deviceBoard:[13,K.d.STRING]},Wn.internalSpec={primary:[1,K.d.UINT32],secondary:[2,K.d.UINT32],tertiary:[3,K.d.UINT32],quaternary:[4,K.d.UINT32],quinary:[5,K.d.UINT32]};var Qn=n(124),Xn={fb:["g.whatsapp.net"],ips:["2a03:2880:f201:c6:face:b00c:0:7260","2a03:2880:f203:c6:face:b00c:0:7260","2a03:2880:f20d:c6:face:b00c:0:7260","2a03:2880:f20d:1c6:face:b00c:0:7260","2a03:2880:f211:c6:face:b00c:0:7260","2a03:2880:f212:c6:face:b00c:0:7260","2a03:2880:f227:c6:face:b00c:0:7260","2a03:2880:f227:2c6:face:b00c:0:7260","2a03:2880:f22c:c6:face:b00c:0:7260","2a03:2880:f22c:1c6:face:b00c:0:7260","2a03:2880:f231:c7:face:b00c:0:7260","2a03:2880:f234:c7:face:b00c:0:7260","2a03:2880:f234:1c7:face:b00c:0:7260"]},er=n(152),tr=1,nr=null,rr=new Sn.a,ar="\r\n",ir=j.a.build(ar,ar).readByteArray(),sr=j.a.build(ar).readByteArray(),or=new Set,ur=class{constructor(e){this.ab=!1,this.ac=!1,this.dataToSend=new j.a,this.ae=!1,this.onData=null,this.onClose=null,this.onError=null,this.af=e=>{this.ab||(this.onData?this.onData(e):__LOG__(4)`TCPSocket #${this.id} dropped ${e.length} bytes`)},this.ag=()=>{__LOG__(3)`TCPSocket #${this.id} closed`,this.ac=!0,this.ab||this.ai()},this.ah=e=>{__LOG__(2)`TCPSocket #${this.id} errored: ${e}`,this.ab||this.onError&&this.onError(e)},this.aj=()=>{this.ae=!1,this.ab?__LOG__(4)`TCPSocket #${this.id} not opened`:this.dataToSend.size()&&this.ad.send(this.dataToSend.readByteArray()).catch(e=>{if(!e||"session_closed"!==e.reason)return Promise.reject(e);__LOG__(2)`TCPSocket::send session owning the socket was closed, buffer is not sent`})};var t=tr++;this.id=t,this.ad=e,__LOG__(2)`TCPSocket #${t} opened`,e.addEventListener(e.DATA_EVENT,this.af),e.addEventListener(e.CLOSE_EVENT,this.ag),e.addEventListener(e.ERROR_EVENT,this.ah)}requestSend(){this.ab?__LOG__(4)`TCPSocket #${this.id} not opened`:this.dataToSend.size()&&(this.ae?__LOG__(2)`TCPSocket #${this.id} delay ${this.dataToSend.size()} bytes`:(this.aj(),this.ae=setTimeout(this.aj,100)))}close(){this.ab||(this.ad.close().catch(e=>{if(!this.ac)return e&&"session_closed"===e.reason?void __LOG__(2)`TCPSocket::close session owning the socket was closed`:Promise.reject(e)}),this.ai())}ai(){this.ab=!0,or.delete(this),this.onClose&&this.onClose()}},dr=new Promise(()=>{}),cr=n(57),lr={},pr=[5222,443];function hr(e){var t,n,r=(function(e){var t=e%2==0?"fb":"ips",n=Xn[t],r=lr[t];null==r&&(r=Math.floor(Math.random()*n.length));var a=(r+1)%n.length,i=n[a];return lr[t]=a,__LOG__(2)`getNextUrl round ${e} settled on: ${i}`,i})(e),a=pr.length>1?pr[10*Math.random()&1]:pr[0];return e%2!=0&&(0,cr.g)(x.r.get())===D.d&&(a=80),t=`${r}:${a}`,n=()=>(function(e,t){return(nr||(nr=(0,er.a)("tcp",{onConnect(e){rr.resolve(self.lib_tcpsocket.TcpSocketService.get(e))},onDisconnect(){rr=new Sn.a;var e=or;or=new Set,e.forEach(e=>{setTimeout(()=>{__LOG__(2)`TCPSocket #${e.id} now defunct`,e.close()},0)})}})),rr.promise).then(n=>n.open({host:e,port:t})).then(e=>{var n;return n=80===t?new class{constructor(e){this.al=!1,this.am="headers",this.ao=new j.a,this.ab=!1,this.dataToSend=new j.a,this.onData=null,this.onClose=null,this.onError=null,this.af=e=>{if(!this.ab){var t=this.ao;if(t.writeByteArray(e),"headers"===this.am){var n=t.indexOf(ir);if(-1===n)return;clearTimeout(this.ap);var r=t.readString(n);if(t.advance(2*ar.length),!(function(e){for(var t=e.replace(/\r\n[ \t]/g," ").replace(/[ \t]+/g," ").split(ar),n=0;n<t.length;n++){var r=t[n].match(/^Transfer-Encoding: ?(.*?) ?$/i);if(r)return/^chunked$/i.test(r[1])}return!1})(r))return __LOG__(4)`ChunkedHTTPSocket #${this.id} is closing as Transfer-Encoding is not chunked`,SEND_LOGS("bad-chunking-header"),void this.aq("Transfer-encoding not chunked");this.am="chunkLength"}this.ar()}},this.ag=()=>{this.ab||this.ai()},this.ah=e=>{__LOG__(2)`ChunkedHTTPSocket #${this.id} errored: ${e}`,this.ab||this.onError&&this.onError(e)},this.id=tr++;var t=new ur(e);t.onData=this.af,t.onClose=this.ag,t.onError=this.ah,this.ak=t}ar(){if(!this.ab){var e,t,n,r=this.ao;if("chunkLength"===this.am){var a=r.indexOf(sr);if(-1===a)return;var i=(t=a,n=(e=r).readString(t),e.advance(ar.length),parseInt(n,16));if(isNaN(i)||0===i){var s=0===i?"Server is closing":"NaN length chunk";return void this.aq(s)}this.an=i,this.am="chunkData"}if("chunkData"===this.am){var o=this.an;if(r.size()<o+ar.length)return;var u=r.readByteArray(o);r.advance(ar.length),this.am="chunkLength";var d=this.onData;d?d(u):(__LOG__(4)`ChunkedHTTPSocket #${this.id} dropped ${o} bytes.`,SEND_LOGS("dropped-bytes")),this.ar()}}}requestSend(){if(this.ab)__LOG__(3)`Sending data but ChunkedHttpSocket #${this.id} is closed`;else{var e=this.ak.dataToSend;this.al||(e.writeByteArray(j.a.build("POST /chat HTTP/1.1\r\nHost: c.whatsapp.net\r\nUser-Agent: Mozilla/5.0 (compatible; WAChat/1.2; +http://www.whatsapp.com/contact)\r\nTransfer-Encoding: chunked\r\n\r\n").readByteArray()),this.al=!0,this.ap=setTimeout(()=>{this.aq("Timeout")},2e3));var t=this.dataToSend;e.write(t.size().toString(16),sr,t.readByteArray(),sr),this.ak.requestSend()}}aq(e){if(__LOG__(2)`ChunkedHTTPSocket #${this.id} is closing because ${e}`,!this.ab){var t=this.ak;t.dataToSend.write("0",ar,ar),t.requestSend(),t.close()}}close(){this.aq("External close")}ai(){this.ab=!0,clearTimeout(this.ap),or.delete(this),this.onClose&&this.onClose()}}(e):new ur(e),or.add(n),n})})(r,a),__LOG__(2)`openSocketWithLoop (round ${e}) connecting to ${t}`,n().then(n=>(__LOG__(2)`openSocketWithLoop (round ${e}) to ${t} succeeded`,n)).catch(t=>{throw __LOG__(3)`openSocketWithLoop (round ${e}) failed: ${t}`,t})}function fr(){return(function(e,t,n,r){var a=0,i=0,s=!1,o=null,u=null;function d(e){return s?(null==r||r(e),dr):(s=!0,null!=o&&(clearTimeout(o),o=null),e)}function c(){if(s)return dr;if(3==++i)throw new Error(`TreasureHunt: all ${i} errored`);return null!=u&&i===a&&(null!=o&&(clearTimeout(o),o=null),u()),dr}return(function t(){var n=a++,r=e(n).then(d,c);if(a<3){var i=new Promise(e=>{o=setTimeout(e,15e3),u=e}).then(t);return Promise.race([r,i])}return r})()})(hr,0,0,e=>{e.close()}).then(e=>(__LOG__(2)`openSocketWithLoop success, resetting round`,e))}var mr="WhatsAppLongTerm1",vr="142375574d0a587166aae71ebe516437c4a28b73e3695c6ce1f7f9545da8ee6b";function gr(e){return(0,Pn.a)(Un,{clientHello:e}).readByteArray()}function _r(e){return(0,Pn.a)(Un,{clientFinish:e}).readByteArray()}function Er(e){return(0,I.a)(Un,e).serverHello}function br(e){var t,n=e.certificate,r=e.serverStatic,a=(t=n,(0,I.a)(Vn,t)),i=a.details,s=a.signature;if(!i)throw new Error("noiseFullHandshake cert missing details");if(!s)throw new Error("noiseFullHandshake cert missing signature");var o={details:i,signature:s};return(function(e){var t=e.cert,n=e.serverStatic,r=(0,I.a)(Kn,t.details);if(r.issuer!==mr)throw new Error(`verifyCertificate unrecognized issuer "${String(r.issuer)}"`);var a=(0,$.d)(r.expires);if(null!=a&&a<=(0,L.E)())throw new Error("verifyCertificate cert has expired");if(!r.key)throw new Error("verifyCertificate cert has no key detail");if(!(0,Qn.a)(r.key,n))throw new Error("verifySignature cert key does not match issuer");return(0,u.P)(new Uint8Array((0,Et.k)(vr)),new Uint8Array(t.details),new Uint8Array(t.signature)).then(e=>{if(!e)throw new Error("verifyCertificate cert poorly signed!")})})({cert:o,serverStatic:r}).then(()=>{var e=(0,I.a)(Kn,o.details),t=(0,$.d)(e.expires);x.Q.set({staticKey:r,expires:t,certificate:{issuer:mr,key:vr}})})}function yr(){if(!x.Q.isDefined())return null;var e=x.Q.get();return e&&(null==e.expires||e.expires>(0,L.E)())&&e.certificate.issuer===mr&&e.certificate.key===vr?e:null}function Sr(e){var t={edgeInfo:x.C.get().edgeInfo,getClientPayload:Zn,protoHeader:new Uint8Array([87,65,5,kn.b]),encodeHandshakeHello:gr,decodeServerHello:Er,encodeHandshakeFinish:_r,processCertificate:br,serverInfoIfKnown:yr,staticKeyPair:new Nn.a(x.P.get().staticKeyPair),openSocket:fr,curveSignalDependencies:(0,Nn.b)()};return{openChatSocket:e=>(function(e,t){return e.openSocket().then(n=>{Promise.resolve().then(t);var r=void 0,a=e.edgeInfo;if(a){var i=new j.a;i.write("ED",0,1),i.writeUint8(a.byteLength>>16),i.writeUint16(65535&a.byteLength),i.writeBuffer(a),r=i.readByteArray(),__LOG__(2)`openChatSocket preIntro ${r}`}var s=e.getClientPayload(),o=new pn.a(e.curveSignalDependencies),u=r?j.a.build(r,e.protoHeader).readByteArray():e.protoHeader,d=new class{constructor(e,t){this.ZI=new j.a,this.closed=!1,this.ZJ=!1,this.onFrame=null,this.onClose=null,this.ZK=e=>{this.ZI.writeByteArray(e),this.convertBufferedToFrames()},this.ZL=()=>{if(this.ZI.peek(fn))return __LOG__(2)`FrameSocket closed, waiting for pending processing`,void(this.ZJ=!0);this.ZN()},this.ZN=()=>{if(!this.closed){__LOG__(2)`FrameSocket closed`,this.ZJ=!1,this.closed=!0;var e=this.onClose;e&&e()}},this.ZM=e=>{__LOG__(4)`FrameSocket error ${e}`},this.ZH=t,this.ZG=e,e.onData=this.ZK,e.onClose=this.ZL,e.onError=this.ZM}sendFrame(e){if(!this.ZJ){this.throwIfClosed();var t=this.ZH,n=e.byteLength,r=this.ZG.dataToSend;t?(this.ZH=null,r.ensureAdditionalCapacity(t.length+3+n),r.writeByteArray(t)):r.ensureAdditionalCapacity(3+n),r.writeUint8(n>>16),r.writeUint16(65535&n),r.write(e),this.ZG.requestSend()}}convertBufferedToFrames(){for(var e=this.ZI,t=this.onFrame;t&&e.peek(fn);){var n=mn(e);__LOG__(2)`FrameSocket.onFrame(${n} bytes)`,t(e.readByteArray(n)),t=this.onFrame}this.ZJ&&!e.peek(fn)&&this.ZN(),t&&e.size()&&__LOG__(2)`FrameSocket: queueing partial frame of ${e.size()} bytes`}throwIfClosed(){if(this.closed)throw new hn}close(){this.ZG.close()}}(n,u),c=e.serverInfoIfKnown();return c?(__LOG__(2)`openChatSocket performing resume handshake`,(function(e,t,n,r,a){var i=new Tn(e);i.start("Noise_IK_25519_AESGCM_SHA256\0\0\0\0",a.protoHeader);var s=r.generatePublicKey();i.authenticate(n),i.authenticate(s),i.mixIntoKey(r.generateSharedSecret(n));var o=i.encrypt(a.staticKeyPair.generatePublicKey());i.mixIntoKey(a.staticKeyPair.generateSharedSecret(n));var u=i.encrypt(Promise.resolve(t));return Promise.all([s,u,o]).then(e=>{var t=m()(e,3),n=t[0],r=t[1],s=t[2];return __LOG__(2)`resumeNoiseHandshake send hello`,i.sendAndReceive(a.encodeHandshakeHello({ephemeral:n,payload:r,static:s}))}).then(n=>{__LOG__(2)`resumeNoiseHandshake rcv hello`;var s=a.decodeServerHello(n),o=s||{},u=o.ephemeral,d=o.static,c=o.payload;if(null==d){if(__LOG__(2)`resumeNoiseHandshake continuing resume handshake`,!u)throw new Error("serverHello missing serverEphemeral");if(!c)throw new Error("serverHello missing certificateCiphertext");return i.authenticate(u),i.mixIntoKey(r.generateSharedSecret(u)),i.mixIntoKey(a.staticKeyPair.generateSharedSecret(u)),i.decrypt(c).then(()=>(__LOG__(2)`resumeNoiseHandshake deriving secrets`,i.finish()))}return __LOG__(2)`resumeNoiseHandshake performing fallback handshake`,(function(e,t,n,r,a){var i=new Tn(e);i.start("Noise_XXfallback_25519_AESGCM_SHA256",a.protoHeader);var s=r.generatePublicKey();return i.authenticate(s),__LOG__(2)`doFallbackHandshake continuing handshake with given server hello`,Rn(i,t,n,r,a)})(e,s,t,r,a)})})(d,s,c.staticKey,o,e)):(__LOG__(2)`openChatSocket performing full handshake`,(function(e,t,n,r){var a=new Tn(e);a.start("Noise_XX_25519_AESGCM_SHA256\0\0\0\0",r.protoHeader);var i=n.generatePublicKey();return a.authenticate(i),i.then(e=>(__LOG__(2)`fullNoiseHandshake send hello`,a.sendAndReceive(r.encodeHandshakeHello({ephemeral:e})))).then(e=>{__LOG__(2)`fullNoiseHandshake rcv hello`;var i=r.decodeServerHello(e);return Rn(a,i,t,n,r)})})(d,s,o,e))})})(t,e),healthCheckInterval:20,shouldCloseStaleSocket:!1,shouldBlockReceivingUntilSuccess:!1,deadSocketTime:2e4,maxSocketLoopWaitTime:6e4,handlers:e}}var Ir=n(406);function wr(e){e.setHandlers("basic",{sendLogs(){},sendSupportRequest(){throw new Error("sendSupportRequest during delete")},wifiStatusChanged(){}}),e.setNamespaceHandler("backend",(e,t,n)=>{if(n)throw new Error("backend not supported while deleting")}),(0,u.O)();var t=Sr({onConnectionChange:e=>{},onOptimisticConnectionChange:e=>{}});(0,r.m)(_e,a.sendPing,t,Tt.b),(0,pt.c)(Promise.all([(0,i.b)(),(0,Me.deleteTmpTables)()]).then(()=>{var e=(0,l.v)("iq",{xmlns:"urn:xmpp:whatsapp:account",type:"get",to:l.k,id:(0,l.t)()},(0,l.v)("remove",null));return(0,r.e)(e,Ce)}).then(()=>(0,Me.deregister)("deleted")).then(()=>{__LOG__(2)`deleteAccount success`,(0,Ee.c)("page","reload",{})}))}function Tr(e){e.setHandlers("basic",{sendLogs(e){var t=e.manual;(0,Re.a)(t,null)},sendSupportRequest(e){var t=e.requestText,n=e.email,r=e.context,a=e.regPhoneNumber;return(0,Re.a)(!0,a).then(e=>(function(e,t,n,r,a){var i,s=x.h.get(),o=(0,Ne.c)("https://graph.facebook.com","/fastdesk_ticket",{access_token:"265339280745412|83b02cdbc885728b0463237fd8882e92"}),u={request_description:e,email_address:t,language:s.lg,platform:"kaios"};x.r.isDefined()?(i=(0,N.u)(x.r.get()),u=Object.assign({},u,{phone_number:i})):a&&(i=a,u=Object.assign({},u,{phone_number:i}));var d=(0,ke.a)(n,i,r);u=Object.assign({},u,{debug_info:JSON.stringify(d)});var c={method:"POST",body:(0,Ne.b)(u),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"}};return(0,Ne.f)(o,{},c).then(e=>{if(!e.ok)return e.text().then(t=>{throw __LOG__(4)`Could not send support request: ${o}: response status = ${e.status}, response body = ${t}`,new Error("Could not send support request: "+o)})}).catch(e=>{__LOG__(4)`Error while sending support request: ${e}`})})(t,n,r,e,a))},wifiStatusChanged(e){var t=e.connected,n=e.radioType;WAM.logAttributes([["regular"],23,1,t,["regular"],105,0,n])}})}function Ar(e,t,p){__LOG__(2)`startBackendRegistered invoked`;var h=!1,f=a=>{var i,o;h||(h=!0,(0,Q.b)({type:"backend",bridge:e}),(0,Ct.setContextImplementations)({getPrivateStatsIds:St}),__LOG__(2)`startBackendRegistered continued, triggered by ${a}`,p&&((0,d.o)(),(0,c.b)()),(0,ht.jobsTable)().updateAppRunId(),(0,Oe.m)(),Ue()||(__LOG__(2)`startExpiredMessagesCleaner invoked`,xe||(xe=new De)),je()?__LOG__(2)`ViewOnceExpirer::startViewOnceExpirer View once disabled`:(__LOG__(2)`ViewOnceExpirer::startViewOnceExpirer`,Be||(Be=new Fe)),(0,P.d)(t),i=(0,P.b)(),o={createGroup:()=>n.e(76).then(n.bind(null,575)).then(e=>e.default),demoteGroupParticipants:()=>n.e(86).then(n.bind(null,576)).then(e=>e.default),promoteGroupParticipants:()=>n.e(99).then(n.bind(null,577)).then(e=>e.default),removeGroupParticipants:()=>n.e(103).then(n.bind(null,578)).then(e=>e.default),addGroupParticipants:()=>n.e(72).then(n.bind(null,579)).then(e=>e.default),setGroupSubject:()=>n.e(133).then(n.bind(null,580)).then(e=>e.default),setGroupDescription:()=>n.e(129).then(n.bind(null,581)).then(e=>e.default),setGroupEphemeralSetting:()=>n.e(130).then(n.bind(null,582)).then(e=>e.default),setGroupLocked:()=>n.e(131).then(n.bind(null,583)).then(e=>e.default),setGroupParticipants:()=>n.e(132).then(n.bind(null,584)).then(e=>e.default),setGroupAnnouncement:()=>n.e(128).then(n.bind(null,585)).then(e=>e.default),setOneToOneEphemeralSetting:()=>n.e(135).then(n.bind(null,586)).then(e=>e.setOneToOneEphemeralSetting),sendEphemeralSyncResponse:()=>n.e(116).then(n.bind(null,587)).then(e=>e.sendEphemeralSyncResponse),joinGroupViaInvite:()=>n.e(92).then(n.bind(null,588)).then(e=>e.default),updateGeneralSettings:()=>n.e(142).then(n.bind(null,589)).then(e=>e.default),setStatusSettings:()=>n.e(2).then(n.bind(null,485)).then(e=>e.default),initLocalSettingsFromServer:()=>n.e(2).then(n.bind(null,485)).then(e=>e.initLocalSettingsFromServer),updateServerWhitelist:()=>n.e(2).then(n.bind(null,485)).then(e=>e.updateServerWhitelistJob),markChatAsRead:()=>n.e(94).then(n.bind(null,590)).then(e=>e.default),markStatusAsSeen:()=>n.e(97).then(n.bind(null,591)).then(e=>e.default),starMessagesFromChat:()=>n.e(137).then(n.bind(null,592)).then(e=>e.starMessagesFromChatJob),unstarMessagesFromChat:()=>n.e(137).then(n.bind(null,592)).then(e=>e.unstarMessagesFromChatJob),keepMessagesFromChat:()=>n.e(93).then(n.bind(null,593)).then(e=>e.keepMessagesFromChatJob),unkeepMessagesFromChat:()=>n.e(93).then(n.bind(null,593)).then(e=>e.unkeepMessagesFromChatJob),saveKeyChange:()=>n.e(114).then(n.bind(null,594)).then(e=>e.default),queryGroup:()=>Promise.resolve().then(n.bind(null,218)).then(e=>e.queryGroup),revokeGroupInviteCode:()=>Promise.resolve().then(n.bind(null,344)).then(e=>e.resetGroupInviteCode),forwardMsgs:()=>Promise.all([n.e(2),n.e(89)]).then(n.bind(null,595)).then(e=>e.default),retryMsg:()=>n.e(110).then(n.bind(null,596)).then(e=>e.default),reportUserSpam:()=>n.e(105).then(n.bind(null,597)).then(e=>e.default),reportGroupSpam:()=>n.e(104).then(n.bind(null,598)).then(e=>e.default),requestPreKeyDigest:()=>n.e(107).then(n.bind(null,599)).then(e=>e.default),markGroupAsMessaged:()=>n.e(95).then(n.bind(null,600)).then(e=>e.default),queryDirtyInfo:()=>Promise.all([n.e(19),n.e(100)]).then(n.bind(null,601)).then(e=>e.default),deleteChat:()=>n.e(79).then(n.bind(null,657)).then(e=>e.deleteChatJob),deleteChatContents:()=>n.e(79).then(n.bind(null,657)).then(e=>e.deleteChatContentsJob),clearChat:()=>n.e(79).then(n.bind(null,657)).then(e=>e.clearChatJob),markPlayed:()=>n.e(96).then(n.bind(null,602)).then(e=>e.default),rotateKey:()=>n.e(113).then(n.bind(null,603)).then(e=>e.default),deleteExpiredPreKeys:()=>n.e(82).then(n.bind(null,604)).then(e=>e.deleteExpiredPreKeys),deleteExpiredDevices:()=>n.e(81).then(n.bind(null,605)).then(e=>e.default),fetchMissingKeysForContact:()=>Promise.resolve().then(n.bind(null,150)).then(e=>e.fetchMissingKeysForContact),removeDeadMediaContent:()=>n.e(102).then(n.bind(null,606)).then(e=>e.default),sendMetrics:()=>n.e(119).then(n.bind(null,607)).then(e=>e.default),sendAnonymousMetrics:()=>n.e(115).then(n.bind(null,647)).then(e=>e.default),deleteTwoFactor:()=>n.e(85).then(n.bind(null,608)).then(e=>e.default),setTwoFactor:()=>n.e(136).then(n.bind(null,609)).then(e=>e.default),changeTwoFactorPin:()=>n.e(136).then(n.bind(null,609)).then(e=>e.changeTwoFactorPin),changeTwoFactorEmail:()=>n.e(136).then(n.bind(null,609)).then(e=>e.changeTwoFactorEmail),getBlocklist:()=>Promise.resolve().then(n.bind(null,418)).then(e=>e.default),getBlocklistV2:()=>Promise.resolve().then(n.bind(null,419)).then(e=>e.default),setBlocklistV2:()=>n.e(127).then(n.bind(null,610)).then(e=>e.setBlocklistV2),validateBusinessCertificate:()=>Promise.resolve().then(n.bind(null,175)).then(e=>e.default),validateBusinessMsg:()=>Promise.resolve().then(n.bind(null,175)).then(e=>e.validateBusinessMsg),deleteChatMsgs:()=>n.e(80).then(n.bind(null,611)).then(e=>e.default),deleteMsgsFromStorageSetting:()=>n.e(84).then(n.bind(null,612)).then(e=>e.default),revokeChatMsgs:()=>Promise.all([n.e(20),n.e(112)]).then(n.bind(null,613)).then(e=>e.default),revokeStatusMsg:()=>Promise.all([n.e(20),n.e(112)]).then(n.bind(null,613)).then(e=>e.revokeStatusMsgJob),blockUser:()=>n.e(73).then(n.bind(null,614)).then(e=>e.blockUser),unblockUser:()=>n.e(73).then(n.bind(null,614)).then(e=>e.unblockUser),sendReaction:()=>n.e(122).then(n.bind(null,615)).then(e=>e.sendReaction),retryReaction:()=>n.e(122).then(n.bind(null,615)).then(e=>e.retryReaction),sendMsg:()=>Promise.all([n.e(2),n.e(120)]).then(n.bind(null,616)).then(e=>e.default),sendStatusMsg:()=>Promise.all([n.e(2),n.e(120)]).then(n.bind(null,616)).then(e=>e.sendStatusMsg),sendWrittenMsg:()=>n.e(23).then(n.bind(null,539)).then(e=>e.sendWrittenMsg),resendWrittenRevokeMsg:()=>n.e(109).then(n.bind(null,617)).then(e=>e.resendWrittenRevokeMsg),senderBackfill:()=>Promise.all([n.e(23),n.e(125)]).then(n.bind(null,618)).then(e=>e.senderBackfill),sendMediaMsg:()=>Promise.all([n.e(2),n.e(21),n.e(117)]).then(n.bind(null,619)).then(e=>e.default),sendMediaMsgs:()=>Promise.all([n.e(2),n.e(21),n.e(118)]).then(n.bind(null,620)).then(e=>e.default),sendVCardMsg:()=>n.e(124).then(n.bind(null,621)).then(e=>e.default),sendStatusMediaMsg:()=>Promise.all([n.e(2),n.e(21),n.e(117)]).then(n.bind(null,619)).then(e=>e.sendStatusMediaMsg),uploadMedia:()=>Promise.all([n.e(5),n.e(24)]).then(n.bind(null,552)).then(e=>e.uploadMedia),reuploadMedia:()=>Promise.all([n.e(5),n.e(6),n.e(24),n.e(111)]).then(n.bind(null,622)).then(e=>e.reuploadMedia),downloadMedia:()=>n.e(87).then(n.bind(null,658)).then(e=>e.default),requestReupload:()=>Promise.all([n.e(6),n.e(108)]).then(n.bind(null,623)).then(e=>e.requestReupload),getOwnAbout:()=>n.e(90).then(n.bind(null,624)).then(e=>e.getOwnAbout),getUserAbout:()=>n.e(90).then(n.bind(null,624)).then(e=>e.getUserAbout),setAbout:()=>n.e(126).then(n.bind(null,625)).then(e=>e.setAbout),requestGdprReport:()=>n.e(106).then(n.bind(null,626)).then(e=>e.requestGdprReport),deleteGdprReport:()=>n.e(83).then(n.bind(null,627)).then(e=>e.deleteGdprReport),setMsgBg:()=>n.e(134).then(n.bind(null,628)).then(e=>e.default),acceptGroupAddRequest:()=>n.e(71).then(n.bind(null,629)).then(e=>e.default),revokeGroupInvitations:()=>n.e(20).then(n.bind(null,538)).then(e=>e.default),syncDeviceList:()=>Promise.resolve().then(n.bind(null,340)).then(e=>e.default),updateContactPHash:()=>n.e(141).then(n.bind(null,630)).then(e=>e.default),createMissedCallLog:()=>n.e(77).then(n.bind(null,631)).then(e=>e.default),finalizeCallLog:()=>n.e(88).then(n.bind(null,632)).then(e=>e.default),deleteCallLogs:()=>n.e(78).then(n.bind(null,633)).then(e=>e.default),clearAllCallLogs:()=>n.e(74).then(n.bind(null,634)).then(e=>e.default),queryAllGroups:()=>Promise.resolve().then(n.bind(null,218)).then(e=>e.queryAllGroupsWithRetry),setGroupPicture:()=>n.e(22).then(n.bind(null,536)).then(e=>e.setGroupPictureJob),setProfilePicture:()=>n.e(22).then(n.bind(null,536)).then(e=>e.setProfilePictureJob),setProfileName:()=>n.e(121).then(n.bind(null,635)).then(e=>e.default),quickReplyToHsm:()=>n.e(101).then(n.bind(null,636)).then(e=>e.default),updateChatWallpaper:()=>n.e(140).then(n.bind(null,637)).then(e=>e.default),convertFutureproofMessage:()=>n.e(75).then(n.bind(null,638)).then(e=>e.default),processFutureProofMsgs:()=>n.e(98).then(n.bind(null,639)).then(e=>e.processFutureProofMsgs),downloadUserNoticeContent:()=>Promise.resolve().then(n.bind(null,417)).then(e=>e.default),addContactToSidelist:()=>Promise.resolve().then(n.bind(null,219)).then(e=>e.addContactToSidelist),syncUserNoticeState:()=>n.e(138).then(n.bind(null,640)).then(e=>e.default),addRecentGif:()=>n.e(91).then(n.bind(null,641)).then(e=>e.default),addFavoriteGif:()=>n.e(91).then(n.bind(null,641)).then(e=>e.addFavoriteGif),addFavoriteGifsFromChat:()=>n.e(91).then(n.bind(null,641)).then(e=>e.addFavoriteGifsFromChat),removeFavoriteGif:()=>n.e(91).then(n.bind(null,641)).then(e=>e.removeFavoriteGif),removeFavoriteGifFromId:()=>n.e(91).then(n.bind(null,641)).then(e=>e.removeFavoriteGifFromId),downloadMediaThumb:()=>Promise.resolve().then(n.bind(null,416)).then(e=>e.default),updateTOSGatingAcceptanceStatus:()=>n.e(139).then(n.bind(null,642)).then(e=>e.updateTOSGatingAcceptanceStatus),removeCompanion:()=>{throw new Error("Companions not supported")},removeAllCompanions:()=>{throw new Error("Companions not supported")},refreshTrustedContactSenderToken:()=>n.e(123).then(n.bind(null,643)).then(e=>e.refreshTrustedContactSenderTokenJob),resendTrustedContactSenderToken:()=>n.e(123).then(n.bind(null,643)).then(e=>e.resendTrustedContactSenderTokenJob),getPrivacySettings:void 0,initializeMediaFsMeta:void 0},(0,bt.w)(o).forEach(e=>{var t=o[e];null!=t&&i.addPersistedJobImplementation(e,t)}),(0,Pe.f)({scheduledTimeResolver:{get:e=>{var t=x.H[e];return t.isDefined()?Promise.resolve(t.get()):Promise.resolve(null)},set:(e,t)=>x.H[e].set(t)}}),gt.p.forEach(e=>{var t=(function(e){switch(e){case"sync":return()=>{var e=x.k.get()?"interactive":"registration";return(0,Ee.e)("page","getContactDatabaseRevision",{}).then(t=>{var n=t.revision;return(0,Ve.syncAllContacts)(e,n)}).catch(e=>{if(e instanceof ze.a)return __LOG__(2)`Task 'sync' failed because it requires page, don't reschedule`,Pe.a;throw e})};case"abProps":return()=>(0,Ee.e)("backend","syncAbProps",{}).then(e=>{var t=e.seconds;return __LOG__(2)`Rescheduling syncAbProps in ${t}s`,t});case"serverProps":return()=>(0,Ee.e)("backend","syncServerProps",{}).then(()=>L.b);case"rotateKey":return e=>{var t;return e?(__LOG__(2)`RotateKeyTask skip first run`,t=Promise.resolve()):t=(0,P.b)().waitUntilCompleted(G.e.rotateKey()),t.then(()=>27*L.b)};case"deleteExpiredDevices":return()=>(0,P.b)().waitUntilCompleted(G.e.deleteExpiredDevices()).then(()=>1*L.b);case"deleteDeadMedia":return()=>(0,P.b)().waitUntilCompleted(G.e.removeDeadMediaContent("routine")).then(()=>L.b).catch(e=>{if(e instanceof ze.a)return __LOG__(2)`Task 'deleteDeadMedia' failed because it requires page, don't reschedule`,Pe.a;throw e});case"sendMetrics":return()=>(0,P.b)().waitUntilCompleted(G.e.sendMetrics()).then(()=>300);case"sendAnonymousMetrics":return()=>(0,P.b)().waitUntilCompleted(G.e.sendAnonymousMetrics()).then(()=>300);case"purgeExpiredStatus":return()=>(0,s.Zb)().then(()=>L.b);case"dailyWAM":return()=>{return(t=(e=x.j.get()).autodownloadMobile,n=e.autodownloadWifi,r=e.autodownloadRoaming,a={autoDlAudioCellular:t.includes("audio"),autoDlImageCellular:t.includes("photos"),autoDlVideoCellular:t.includes("videos"),autoDlAudioWifi:n.includes("audio"),autoDlImageWifi:n.includes("photos"),autoDlVideoWifi:n.includes("videos"),autoDlAudioRoaming:r.includes("audio"),autoDlImageRoaming:r.includes("photos"),autoDlVideoRoaming:r.includes("videos"),receiptsEnabled:"none"!==e.readReceipts},i=(function(){var e=x.h.get();return{languageCode:e.lg,locationCode:e.lc||void 0,osBuildNumber:e.osBuild,simMcc:parseInt(e.mcc,10),simMnc:parseInt(e.mnc,10),networkIsRoaming:e.roaming}})(),o=x.G.get().stats||{},u=x.t.get(),d=Object.assign({},a,i,o,u),(0,Q.a)("disappearing_mode")&&(d.defaultDisappearingDuration=x.j.get().disappearingMsgsDefaultTimer||D.i),WAM.log("regular",1158,void 0,[108,1,d.accessibilityVoiceover,11,0,d.addressbookSize,12,0,d.addressbookWhatsappSize,135,2,d.androidAdvertisingId,139,0,d.androidKeystoreState,103,2,d.appCodeHash,90,1,d.autoDlAudioCellular,91,1,d.autoDlAudioRoaming,89,1,d.autoDlAudioWifi,96,1,d.autoDlDocCellular,97,1,d.autoDlDocRoaming,95,1,d.autoDlDocWifi,87,1,d.autoDlImageCellular,88,1,d.autoDlImageRoaming,86,1,d.autoDlImageWifi,93,1,d.autoDlVideoCellular,94,1,d.autoDlVideoRoaming,92,1,d.autoDlVideoWifi,10,0,d.backupNetworkSetting,138,0,d.backupRestoreEncryptionVersion,9,0,d.backupSchedule,19,0,d.chatDatabaseSize,140,0,d.defaultDisappearingDuration,153,2,d.deviceLanguage,134,1,d.entSecurityNotificationsEnabled,109,0,d.externalStorageAvailSize,110,0,d.externalStorageTotalSize,113,0,d.favoritedAnimatedStickerCount,112,0,d.favoritedFirstPartyStickerCount,111,0,d.favoritedTotalStickerCount,116,0,d.installedAnimatedStickerPackCount,137,0,d.installedAnimatedThirdPartyStickerPackCount,115,0,d.installedFirstPartyStickerPackCount,114,0,d.installedTotalStickerPackCount,123,2,d.ipCountry,122,2,d.ipStr,154,2,d.keyboardLanguage,5,2,d.languageCode,6,2,d.locationCode,124,0,d.mdPairTime,21,0,d.mediaFolderFileCount,20,0,d.mediaFolderSize,155,1,d.modifiedInternalProps,7,1,d.networkIsRoaming,4,2,d.osBuildNumber,118,0,d.osNotificationSetting,102,2,d.packageName,100,1,d.paymentsIsEnabled,104,1,d.permissionContacts,156,0,d.phoneCores,141,0,d.privacySettingsAbout,142,0,d.privacySettingsAboutExceptNum,143,0,d.privacySettingsGroups,144,0,d.privacySettingsGroupsExceptNum,145,0,d.privacySettingsLastSeen,146,0,d.privacySettingsLastSeenExceptNum,147,0,d.privacySettingsProfilePhoto,148,0,d.privacySettingsProfilePhotoExceptNum,150,0,d.privacySettingsStatus,151,0,d.privacySettingsStatusExceptNum,152,0,d.privacySettingsStatusShareNum,8,1,d.receiptsEnabled,2,0,d.simMcc,3,0,d.simMnc,31,0,d.storageAvailSize,32,0,d.storageTotalSize,23,0,d.videoFolderFileCount,22,0,d.videoFolderSize]),WAM.log("private",2328,113760892,[]),(0,Q.a)("kaios_privatestats_phase3_enabled")&&(WAM.log("private",2956,42196056,[]),WAM.log("private",3004,0,[])),(0,s.fb)().then(e=>(WAM.log("regular",1676,void 0,[3,0,e.statusAvailableCountDaily,1,0,e.statusAvailableRowsCountDaily,4,0,e.statusViewedCountDaily,2,0,e.statusViewedRowsCountDaily]),(0,s.Fb)())).then(e=>{})).then(()=>L.b);var e,t,n,r,a,i,o,u,d};case"deleteExpiredPreKeys":return e=>{var t;return e?(__LOG__(2)`DeleteExpiredPreKeys skip first run`,t=Promise.resolve()):t=(0,P.b)().waitUntilCompleted(G.e.deleteExpiredPreKeys(x.E.get().prekeyExpirationDays)),t.then(()=>7*L.b)};case"purgeContactsLastKnownName":return()=>(0,s.Xb)().then(()=>L.b);case"decodeFutureProofEphemeral":return e=>(e?(0,P.b)().waitUntilCompleted(G.e.processFutureProofMsgs()):Promise.resolve()).then(()=>L.c);case"timeTransitionCurrentUserNotice":return()=>(0,s.Hc)().then(()=>L.d);case"rotatePrivateStatsIds":return()=>St().then(()=>(function(){var e=[];if(D.F.forEach(t=>{var n=t.keyHashInt,r=t.rotationPeriodDays;if(-1!==r){var a=x.y.get()[n];if(null!=a){var i=r*L.b,s=Math.floor((0,L.E)()/i)*i;if(!(a.creationTs>=s)){var o={value:yt(),creationTs:(0,L.E)()};(0,Q.a)("kaios_privatestats_phase3_enabled")&&WAM.log("regular",2862,void 0,[2,0,2,1,0,n,3,0,r]),e.push({keyHashInt:n,entry:o})}}}}),0===e.length)return Promise.resolve();var t=(0,bt.u)(x.y.get());return e.forEach(e=>{var n=e.keyHashInt,r=e.entry;t[n]=r}),(0,_t.i)(It(t)),x.y.set(t).then(()=>{})})()).then(()=>L.b);case"deleteExpiredOrphanedStanzas":return()=>(0,s.n)().then(()=>L.b);case"deleteExpiredPrivacyTokens":return()=>(0,be.b)().then(()=>L.b);default:return(0,R.a)(e)}})(e);(0,Pe.c)(e,t)}),(0,ft.initializeWAMSink)("backend","regular",()=>(0,Pe.e)("sendMetrics")),(0,ft.initializeWAMSink)("backend","private",()=>(0,Pe.e)("sendAnonymousMetrics")),setTimeout(()=>{(function(e){var t,a,i;__LOG__(2)`lazyBackendCode`,e.sendAndReceive("event","finishedBooting",{}),e.sendAndReceive("page","getPushEndpoint",{}).then(e=>{var t,n,a;t=e.endpoint,n=e.auth,a=e.p256dh,(0,r.e)((0,l.v)("iq",{id:(0,l.t)(),to:l.k,xmlns:"urn:xmpp:whatsapp:push",type:"set"},(0,l.v)("config",{platform:"kaios",endpoint:(0,l.b)(t),auth:(0,l.b)(n),p256dh:(0,l.b)(a)})),Ae)}),(0,Ee.d)()&&((0,qe.e)()&&e.fireAndForget("event","ranOutOfStorage",{}),x.k.get()&&e.sendAndReceive("page","getContactDatabaseRevision",{}).then(e=>{var t=e.revision;x.s.get()!==t&&(0,Ve.deltaSync)("interactive",t).catch(e=>{throw new qe.c("Delta sync failed",e)})}),e.fireAndForget("backend","loadLastUnreadStatusMsg",{})),"unknown"===(i=x.J.get()).status&&(0,Q.a)("tos_client_state_fetch_enabled")||(0,Q.a)("tos_client_state_fetch_iteration")>i.forcedFetchIteration?n.e(139).then(n.bind(null,642)).then(e=>e.fetchTOSGatingAcceptanceStatus()):Promise.resolve(),(t=x.u.get())!==(a="2.2218.5")?(__LOG__(2)`Update version detected: ${t} to ${a}. Running hooks.`,(function(e){(0,P.b)().waitUntilPersisted(G.e.processFutureProofMsgs()).then(()=>(__LOG__(2)`Post-update hooks applied for ${e}`,x.u.set(e)))})(a)):Promise.resolve()})(e)},1e3))},v=(0,i.g)(class{constructor(){this.table=new Nt.c,this.nextMsgChecker=e=>{var t=(0,Rt.n)(e.id,++e.increment);return this.table.getMsgFromId(t).then(n=>n?(__LOG__(4)`Found existing msg on new increment id`,SEND_LOGS("repaired-chat-increment"),this.nextMsgChecker(e)):t)}}verifyRegisteredUser(){return(0,Pt.i)(this.table.getRegisteredUser().then(e=>e?e===x.r.get():(this.table.setRegisteredUser(x.r.get()),!0)))}setMsgValidUntilInTransaction(e,t,n){return t===D.i?(0,Pt.e)():this.table.getMsgFromId(e).then(e=>{if(e&&e.validUntil){var r=n?(0,L.l)(t,n):(0,L.l)(t);if(!(r<=(0,L.E)()||r===e.validUntil))return e.validUntil=r,this.table.putCommonMsg(e)}})}unlinkViewOnceMsgsMedia(e){return this.table.getAllMsgsFromIds(e).then(e=>{var t=e.filter(e=>e&&(0,Vt.e)(e)&&e.media);if(0!==t.length)return jt.L(this.table.stores,t,!1).then(()=>this.table.stores.msgs.bulkPut(t.map(e=>(delete e.media,(0,Vt.e)(e)&&jt.d(e),(0,$t.b)(e)&&delete e.viewOnceExpiration,e)))).then(()=>{})})}cleanViewOnceMessages(){return this.table.stores.msgs.where("viewOnceExpiration").belowOrEqual((0,L.E)()).filter(e=>(0,$t.b)(e)&&"active"!==e.viewOnceState).toArray().then(e=>{var t=e.map(e=>e.id);return __LOG__(2)`cleanViewOnceMessages: cleaning up msgs ${t}`,this.unlinkViewOnceMsgsMedia(t)})}createUserChatInTransaction(e,t){return this.table.stores.chats.where("jid").equals(e).first().then(n=>{var r=t||{jid:e};if(n)return __LOG__(4)`Chat created that already exists!`,SEND_LOGS("createChat"),[n,r,null];var a=(0,un.j)(r);return(0,un.h)(this,e,r,a)}).then(e=>{var t=m()(e,3),n=t[0],r=t[1],a=t[2],i=a?a.map(e=>(0,un.u)(e,n)):[],s=Object.assign({},r,{chatId:n.id});return[n,s,i]})}mutateChatAttributesOnNewMsg(e,t){e.msgCount++,e.newest=t.id,e.oldest||(e.oldest=t.id);var n=(0,un.k)(t);if((0,un.i)(t,n)&&(e.oldestUnread||(e.oldestUnread=t.id),e.unreadMsgCount>=0?e.unreadMsgCount++:e.unreadMsgCount=1),(0,un.n)(e,t)&&(null!=e.importantMsgCount&&e.importantMsgCount>=0?e.importantMsgCount++:e.importantMsgCount=1),n>=un.a.NOTEWORTHY&&(e.sortBy=t.rowId),(0,un.v)(t,e)){var r=(0,Ut.a)(t);r&&(e.previewMsg=r)}}addSystemMsgWithResult(e,t){return this.addSystemMsgToChatInTransaction(e,t).then(un.w)}addGroupSystemMsgWithResult(e,t,n){return this.addSystemMsgToChatInTransaction(e,t).then(e=>{var t=e.dbChat,r=e.dbMsg;return(0,un.l)({dbChat:t,dbMsg:r,dbGroup:n})})}addSystemMsgToChatInTransaction(e,t,n){return this.table.getChatInTransaction(e).then(e=>(n?(0,Pt.e)(n):this.nextMsgChecker(e)).then(n=>this.table.addMsg(n,e.id,t)).then(t=>(this.mutateChatAttributesOnNewMsg(e,t),this.table.updateChat(e).then(()=>({dbChat:e,dbMsg:t})))))}msgsInRangeInclusive(e,t){return this.table.transact("r",["msgs"],()=>this.table.stores.msgs.where("id").between(e,t,!0,!0).toArray())}markGroupAsMessaged(e,t){return this.table.transact("rw",["groups","groupParticipantsInfo","chats","msgs"],()=>this.table.getGroupInfoWithParticipantsInTransaction(t).then(n=>{if(n)return n.groupInfo.messaged=!0,(0,Pt.c)([this.table.getChatInTransaction(e),this.table.setGroupInfo(n.groupInfo)]).then(e=>{var t=m()(e,1)[0];return(0,kt.a)(t,n)});__LOG__(3)`Tried to mark non-existent group as messages: ${t}`}))}markChatAsRead(e,t){return __LOG__(2)`markChatAsRead ${e} upTo ${t}`,this.table.transact("rw",["chats","msgs"],()=>this.table.stores.chats.get(e).then(n=>{if(n){var r=n.oldestUnread;if(null!=r)return this.table.stores.msgs.where("id").between(r,(0,Nt.d)(n.id),!0,!1).toArray().then(e=>{for(var r=[],a=void 0,i=0,s=0;s<e.length;s++){var o=e[s];if(o.author!==O.b&&!(0,dn.h)(o.ack)&&o.type!==O.f.FUTUREPROOF)if(o.id<=t)r.push((0,bt.j)(o,{ack:O.a.READ}));else{var u=(0,un.k)(o);(0,un.i)(o,u)&&i++,u>un.a.GARBAGE&&(!a||a>o.id)&&(a=o.id)}}var d=r.length?this.table.stores.msgs.bulkPut(r):null,c=(0,bt.j)(n,{oldestUnread:a,unreadMsgCount:i});return delete c.importantMsgCount,(0,Pt.c)([this.table.updateChat(c),d]).then(()=>c)});__LOG__(2)`markChatAsRead chat ${e} already fully read`}else __LOG__(2)`markChatAsRead chat ${e} no longer exists`}))}getContacts(e){return null==e?this.table.stores.contacts.toArray():this.table.stores.contacts.where("jid").anyOf(e).toArray()}getChatJid(e){return(0,Pt.i)(this.table.getChatInTransaction(e).then(e=>e.jid))}getChatWithGroup(e){return this.table.transact("rw",["chats","groups","groupParticipantsInfo"],()=>this.table.stores.chats.get(e).then(t=>{if(!t)return __LOG__(3)`Trying to retrieve inexisting chat ${e}`,null;var n=(0,N.p)(t.jid);return n?this.table.getGroupInfoWithParticipantsInTransaction(n).then(e=>({dbChat:t,dbGroup:e})):{dbChat:t,dbGroup:null}}))}getCommunityInfo(e){return(0,Pt.i)(this.table.stores.groups.get(e).then(e=>e&&Ft.c(e)))}getContact(e){return(0,Pt.i)(this.table.getContact(e))}getDeleteExpiredJobInfoAndContact(e){return(0,Pt.i)((0,Pt.c)([this.table.stores.meta.get(qt.a.DELETE_EXPIRED_DEVICES_JOB),this.table.getContact(e)])).then(e=>{var t=m()(e,2),n=t[0];return{contact:t[1],jobInfo:null==n?{lastRunTs:-1}:n.value}})}getSidelistJids(){return this.table.transact("r",["contacts","groupParticipantsInfo"],()=>this.table.stores.contacts.toArray().then(e=>{var t=[],n=[];return e.forEach(e=>{var r=e.jid,a=null==e.phonebookPhone,i=null!=e.chatId,s=null!=e.verifiedInfo;a&&(i?t.push(r):s&&n.push(r))}),n.length>0?this.table.filterParticipantsInGroup(n).then(e=>[...t,...e]):t}))}getContactsByPhonebookPhones(e){return(0,Pt.i)(this.table.stores.contacts.where("phonebookPhone").anyOf(e).toArray())}getAddressbookWhatsAppSize(){return performance.now(),(0,Pt.i)(this.table.stores.contacts.orderBy("phonebookPhone").toArray().then(e=>{var t=0;return e.forEach(e=>{e.noWhatsApp||t++}),performance.now(),t}))}purgeContactsLastKnownName(){return this.table.transact("rw",["contacts"],()=>this.table.stores.contacts.filter(e=>null!=e.lastKnownName&&!(0,L.n)(e.lastKnownName.ts,D.Q)).modify(e=>{delete e.lastKnownName}).then(e=>{__LOG__(2)`purgeContactsLastKnownName purged ${e} contacts`}))}updatePushname(e,t){return this.table.transact("rw",["contacts"],()=>this.table.stores.contacts.get(e).then(n=>{if(n&&n.pushname===t)return null;var r=n?Object.assign({},n,{pushname:t}):{jid:e,pushname:t};return this.table.stores.contacts.put(r).then(()=>r)}))}updateContactEphemeralSettings(e,t,n){return this.table.transact("rw",["contacts"],()=>this.table.stores.contacts.get(e).then(r=>{var a={expiration:t,ts:n,initiator:S.a.CHANGED_IN_CHAT,notificationTs:n,deviceJid:void 0},i=null==r?void 0:r.ephemeral;if(null!=i){var s=i.ts,o=i.expiration,u=i.deviceJid;if(o!==t&&s===n&&null!=u&&(0,N.e)(x.r.get())>u)return null;a=Object.assign({},i,a)}var d=r?Object.assign({},r,{ephemeral:a}):{jid:e,ephemeral:a};return this.table.stores.contacts.put(d).then(()=>d)}))}updateAbout(e,t){return this.table.transact("rw",["contacts"],()=>this.table.stores.contacts.get(e).then(n=>{var r=n&&n.about;if(r&&t&&(0,bt.r)(r,t))return null;var a=Object.assign({jid:e},n,{about:t});return this.table.stores.contacts.put(a).then(()=>a)}))}getEverything(){return this.table.getEverything()}loadMsgRange(e,t,n){return this.table.loadDbMsgRange(e,t,n).then(e=>{if(e){var t=e.dbMsgs,n=e.containsOldest,r=e.containsNewest;return{msgs:t.map(xt.c),containsOldest:n,containsNewest:r}}})}doesMsgExist(e){return(0,Pt.i)(this.table.stores.msgs.where("id").equals(e).count().then(e=>1===e))}loadLastMsgsInChatForSpamReport(e,t){return this.table.transact("r",["msgs","media","previews"],()=>{var n=(0,Nt.a)(e),r=(0,Nt.d)(e);return this.table.stores.msgs.where("id").between(n,r).reverse().filter(this.Ym).limit(t).toArray().then(e=>(0,Pt.c)(e.map(e=>this.Yn(e))))})}loadMsgForSpamReport(e){return this.table.transact("r",["msgs","media","previews"],()=>this.table.getMsgFromId(e).then(e=>null!=e&&this.Ym(e)?this.Yn(e):null))}Ym(e){return!(!ln.has(e.type)||e.author===O.b||(!(0,$t.b)(e)||null==e.viewOnceState)&&(0,Vt.e)(e)&&!e.media&&(__LOG__(2)`Got media without media id, skipping it`,1))}Yn(e){var t;if(!e)return(0,Pt.e)(null);var n,r=(0,Vt.e)(e)&&e.media,a=(0,Vt.j)(e)&&e.hasPreview,i=null==(t=e.quoted)?void 0:t.hasPreview;if(!r&&!a&&!i)return(0,Pt.e)({dbMsg:e,preview:null,dbMedia:null,quotePreview:null});n=r&&(0,Kt.e)(e)?this.table.stores.previews.get((0,gt.C)(r)).then(t=>t?t.preview:jt.i(this,e)):jt.i(this,e);var s=r?jt.l(this,r):null,o=i?this.table.stores.previews.get((0,gt.F)(e.id)):null;return(0,Pt.c)([s,n,o]).then(t=>{var n=m()(t,3),r=n[0],a=n[1],i=n[2];return{dbMsg:e,dbMedia:r,preview:a,quotePreview:null==i?void 0:i.preview}})}getWrittenMsgFromRowId(e){return this.table.transact("r",["msgs","previews","media"],()=>this.table.stores.msgs.get(e).then(e=>this.Yn(e)))}getMsgIfAuthorized(e,t,n,r){return(function(e,t,n,r,a){return e.transact("r",["msgs","receipts","contacts"],()=>{var i=(0,Pt.e)(!0),s=(0,N.f)(a);return s!==k.c&&(i=e.getContact((0,N.h)(a)).then(e=>!!e&&(0,zt.d)(e).includes(s))),i.then(i=>i?e.stores.msgs.where("externalId").equals(r).toArray().then(r=>(0,Pt.c)(r.map(r=>e.checkMsgAuthorized(n,a,r,t))).then(e=>{var t=e.reduce((e,t)=>e||t,null);return null==t?{error:"message-not-found"}:{dbMsg:t}})):(__LOG__(2)`getMsgIfAuthorized rejecting request for removed device`,{error:"error-unknown-device"}))})})(this.table,e,t,n,r)}createUserChat(e){return this.table.transact("rw",["chats","contacts","msgs"],()=>this.table.getContact(e).then(t=>t&&t.chatId?{type:"exists",chatId:t.chatId}:this.createUserChatInTransaction(e,t).then(e=>{var t=m()(e,3),n=t[0],r=t[1],a=t[2];return this.table.stores.contacts.put(r).then(()=>({type:"new",chat:(0,kt.a)(n,null),contact:r,msgs:a}))})))}instantiateGroupChat(e){return this.table.transact("rw",["groups","groupParticipantsInfo","contacts","chats","msgs","media"],()=>{var t=this.table.getGroupInfoWithParticipantsInTransaction(e.jid);return(0,Pt.c)([t,this.table.getDevicesInTransaction(e.participants.map(e=>e.jid))]).then(t=>{var n=m()(t,2),r=n[0],a=n[1],i=(0,Lt.d)(e,r,a),s=i.groupInfo,o=i.participantsInfo,u=i.notificationMessages;return(r?(0,Pt.e)({chatId:r.groupInfo.chatId}):(0,un.g)(this,e.jid,s.expiration).then(e=>{var t=m()(e,2),n=t[0],r=t[1];return{chatId:n.id,dbChat:n,dbMsgs:r}})).then(e=>{var t,n=e.chatId,r=Object.assign({},s,{chatId:n}),a={groupInfo:r,participantsInfo:o};if(e.dbChat){var i=e.dbChat,d=e.dbMsgs;t=d.map(e=>(0,un.u)(e,i,a))}var c=(0,Pt.e)([]);return u.forEach(e=>{c=c.then(t=>this.addGroupSystemMsgWithResult(n,e,a).then(e=>e?t.concat(e):t))}),(0,Pt.c)([c,this.table.setGroupInfo(r),this.table.setParticipantsInfo(o)]).then(e=>{var n=m()(e,1)[0];return t?t.concat(n):n})})})})}instantiateParentGroup(e){return this.table.transact("rw",["groups","groupParticipantsInfo","contacts"],()=>this.table.getDevicesInTransaction(e.participants.map(e=>e.jid)).then(t=>{var n=(0,Lt.i)(e,t),r=n.groupInfo,a=n.participantsInfo;return(0,Pt.c)([this.table.setGroupInfo(r),this.table.setParticipantsInfo(a)]).then(e=>{})}))}markParticipantsAsUpToDateInTransaction(e,t,n){return this.table.getParticipantsInfoInTransaction(e).then(r=>{if(r){var a=r.keyIncrement||0;if(n===a){var i=Dt.a(r,t);if(i)return __LOG__(2)`markParticipantsAsUpToDate ${e} updating`,this.table.setParticipantsInfo(i);__LOG__(2)`markParticipantsAsUpToDate ${e} no change`}else __LOG__(2)`markParticipantsAsUpToDate ${e} key updated`}else __LOG__(2)`markParticipantsAsUpToDate ${e} no longer exists`})}participantForgotKey(e,t){return this.table.transact("rw",["groupParticipantsInfo"],()=>this.table.getParticipantsInfoInTransaction(e).then(n=>{if(n){var r=Dt.c(n,t);if(r)return this.table.setParticipantsInfo(r);__LOG__(2)`markParticipantHasNoKey ${e} has no change`}else __LOG__(2)`markParticipantHasNoKey ${e} no longer exists`}))}muteChat(e,t){return this.table.transact("rw",["groups","groupParticipantsInfo","msgs","chats"],()=>this.table.stores.chats.get(e).then(e=>{if(!e)return null;var n=Object.assign({},e,{mutedUntil:t}),r=(0,N.p)(n.jid),a=r?this.table.getGroupInfoWithParticipantsInTransaction(r):null;return(0,Pt.c)([a,this.table.updateChat(n)]).then(e=>{var t=m()(e,1)[0];return(0,kt.a)(n,t)})}))}setChatArchivedState(e,t){return this.table.transact("rw",["groups","groupParticipantsInfo","chats"],()=>this.table.stores.chats.get(e).then(n=>{if(!n)return __LOG__(2)`setChatArchivedState chat ${e} does not exist`,null;if(!!n.archived===t)return null;var r=Object.assign({},n,{archived:t}),a=(0,N.p)(r.jid),i=a?this.table.getGroupInfoWithParticipantsInTransaction(a):null;return(0,Pt.c)([i,this.table.updateChat(r)]).then(e=>{var t=m()(e,1)[0];return(0,kt.a)(r,t)})}))}markChatAsUnread(e){return this.table.transact("rw",["groups","groupParticipantsInfo","chats"],()=>this.table.stores.chats.get(e).then(t=>{if(!t)return __LOG__(2)`markChatAsUnread chat ${e} does not exist`,null;if(0!==t.unreadMsgCount)return __LOG__(2)`markChatAsUnread chat ${e} is already marked unread`,null;t.unreadMsgCount=-1,delete t.importantMsgCount;var n=(0,N.p)(t.jid),r=n?this.table.getGroupInfoWithParticipantsInTransaction(n):null;return(0,Pt.c)([r,this.table.updateChat(t)]).then(e=>{var n=m()(e,1)[0];return(0,kt.a)(t,n)})}))}removeChatUnreadMark(e){return this.table.transact("rw",["groups","groupParticipantsInfo","chats"],()=>this.table.stores.chats.get(e).then(t=>{if(!t)return __LOG__(2)`removeChatUnreadMark chat ${e} does not exist`,null;if(-1!==t.unreadMsgCount)return __LOG__(2)`removeChatUnreadMark chat ${e} is not marked unread`,null;t.unreadMsgCount=0,delete t.importantMsgCount;var n=(0,N.p)(t.jid),r=n?this.table.getGroupInfoWithParticipantsInTransaction(n):null;return(0,Pt.c)([r,this.table.updateChat(t)]).then(e=>{var n=m()(e,1)[0];return(0,kt.a)(t,n)})}))}starMessagesFromChat(e,t){return this.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo","meta"],()=>{var n=this.table.getChatInTransaction(t).then(e=>this.table.getChatAndGroupInTransaction(e.jid));return(0,Pt.c)([n,this.table.stores.msgs.where("id").anyOf(e).toArray()]).then(e=>{var n=m()(e,2),r=n[0],a=n[1];if(!r)return __LOG__(3)`starMessage chat ${t} does not exist`,null;var i=r.dbChat,s=r.dbGroup,o=null!=i.starredMsgCount?i.starredMsgCount:0,u=[];return a.forEach(e=>{if(e.chat!==t)return __LOG__(3)`starMessagesFromChat message ${e.id} does not belong to chat ${t}`,void SEND_LOGS("starred-message-not-from-chat");e.starred?__LOG__(3)`starMessagesFromChat message ${e.id} is already starred`:e.type!==O.f.REVOKED?(e.starred=e.rowId,o++,u.push(e)):__LOG__(3)`starMessagesFromChat message ${e.id} is revoked`}),o>0&&(i.starredMsgCount=o),(0,Pt.c)([this.table.stores.msgs.bulkPut(u),this.table.updateChat(i),(0,un.c)(this,i.jid,u.length)]).then(()=>({msgs:u.map(e=>(0,xt.c)(e)),chat:(0,kt.a)(i,s)}))})})}unstarMessagesFromChat(e,t){return this.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo"],()=>{var n=this.table.getChatInTransaction(t).then(e=>this.table.getChatAndGroupInTransaction(e.jid));return(0,Pt.c)([n,this.table.stores.msgs.where("id").anyOf(e).toArray()]).then(e=>{var n=m()(e,2),r=n[0],a=n[1];if(!r)return __LOG__(3)`unstarMessagesFromChat chat ${t} does not exist`,null;var i=r.dbChat,s=r.dbGroup,o=null!=i.starredMsgCount?i.starredMsgCount:0,u=[];return a.forEach(e=>{if(e.chat!==t)return __LOG__(3)`unstarMessagesFromChat message ${e.id} does not belong to chat ${t}`,void SEND_LOGS("starred-message-not-from-chat");e.starred?(delete e.starred,o--,u.push(e)):__LOG__(3)`unstarMessagesFromChat message ${e.id} is not starred`}),o>0?i.starredMsgCount=o:delete i.starredMsgCount,(0,Pt.c)([this.table.stores.msgs.bulkPut(u),this.table.updateChat(i)]).then(()=>({msgs:u.map(e=>(0,xt.c)(e)),chat:(0,kt.a)(i,s)}))})})}getBlocklist(){return(0,Pt.i)(this.table.getBlocklist())}setBlocklist(e){return this.table.stores.meta.put({key:qt.a.BLOCKED,value:e})}addToBlocklist(e){return this.table.transact("rw",["chats","contacts","msgs","meta"],()=>this.table.getBlocklist().then(t=>{if((0,X.d)(t,(0,X.l)(e)))return[t,null];var n=(0,X.a)(t,e);return(0,Pt.c)([this.setBlocklist(n),this.Yo(e,!0)]).then(e=>{var t=m()(e,2),r=(t[0],t[1]);return[n,r]})}))}removeFromBlocklist(e){return this.table.transact("rw",["chats","contacts","msgs","meta"],()=>this.table.getBlocklist().then(t=>{if(!(0,X.d)(t,(0,X.l)(e)))return[t,null];var n=(0,X.g)(t,t=>t!==e);return(0,Pt.c)([this.setBlocklist(n),this.Yo(e,!1)]).then(e=>{var t=m()(e,2),r=(t[0],t[1]);return[n,r]})}))}Yo(e,t){return this.table.getContact(e).then(n=>{if(n){var r=n.chatId;if(r){var a={type:O.f.CONTACT_BLOCK_CHANGE,externalId:"/blocked/"+e,ts:(0,L.E)(),author:O.b,ack:O.a.RECEIVED,altIndex:"",blocked:t};return this.addSystemMsgWithResult(r,a)}}})}getMsgInfo(e){return this.table.transact("r",["receipts"],()=>this.table.getReceipt(e).then(e=>({acks:e?(0,Gt.c)(e):null})))}recordKeyChange(e,t){return this.table.transact("rw",["contacts","groups","groupParticipantsInfo","chats","msgs"],()=>(0,Pt.c)([this.table.getContact(e),this.table.userParticipantsInfo(e)]).then(n=>{var r=m()(n,2),a=r[0],i=r[1],s=i.groups,o=i.status,u=null,d=null,c=[];if(a&&(t&&(0,ye.b)(a)&&(u=s.map(e=>this.addGroupSystemMsgWithResult(e.groupInfo.chatId,t,e)),a.chatId&&u.push(this.addSystemMsgWithResult(a.chatId,t))),a.devices)){var l=(0,N.e)(e);(0,zt.c)(a).forEach(e=>{e!==l&&c.push(e)}),c.length>0&&(d=this.table.stores.contacts.put(Object.assign({},a,{devices:[zt.a]})))}var p=s.map(e=>e.groupInfo.jid);o&&p.push(o.jid);var h=this.table.markSenderKeysForRotationInTransaction(p).then(()=>0===c.length?null:this.table.stores.groupParticipantsInfo.bulkPut(s.map(e=>{var t=e.participantsInfo;return Dt.e(t,[],c)})));return(0,Pt.c)([u&&(0,Pt.c)(u),h,d])})).then(e=>{var t=m()(e,1)[0],n=[];return t&&t.forEach(e=>null!=e&&n.push(e)),{newMsgs:n}})}markPlayed(e){return this.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo","media","previews"],()=>this.table.getMsgFromId(e).then(e=>{if(!e)return{};if(e.type!==O.f.PTT||e.played&&(0,dn.g)(e.ack)){if(!(0,$t.b)(e)||"viewed"===e.viewOnceState&&(0,dn.g)(e.ack))return{};e.viewOnceState="viewed",(0,un.d)(this.table,e.chat),e.viewOnceExpiration=(0,L.x)(1)}else e.played=!0;var t=this.table.stores.msgs.put(e),n=this.table.stores.chats.get(e.chat).then(t=>{if(t&&(0,Nt.h)(t,[e])){var n=this.table.stores.chats.put(t),r=(0,N.p)(t.jid),a=(r?this.table.getGroupInfoWithParticipantsInTransaction(r):(0,Pt.e)()).then(e=>(0,kt.a)(t,e));return(0,Pt.c)([a,n]).then(e=>m()(e,1)[0])}});return(0,Pt.c)([n,t]).then(t=>{var n=m()(t,1)[0];return{msg:(0,xt.c)(e),externalId:e.externalId,updatedChat:n}})}))}updateChatLastNotified(e,t){return this.table.transact("rw",["chats"],()=>this.table.stores.chats.get(e).then(n=>{if(!n)return e;var r=(0,bt.j)(n,{lastNotified:t});return this.table.updateChat(r)}))}getMsgFromId(e){return this.table.transact("r",["msgs"],()=>this.table.getMsgFromId(e))}getChatMediaMsgs(e){return this.table.transact("r",["chats","msgs","media"],()=>{var t=(0,Nt.a)(e.chatId),n=e.fromMsgId||(0,Nt.d)(e.chatId);return this.table.getMediaMsgIds(t,n,e.limit).then(e=>this.table.getAllMsgsFromOrderedIds(e).then(un.e))})}getStorageSettingMediaMsgs(e){return this.table.transact("r",["msgs","media"],()=>this.table.getStorageSettingSortedMediaMsgIds(e.filter).then(t=>{var n=-1;e.fromMsgId&&(n=t.indexOf(e.fromMsgId));var r=t.slice(n+1,n+1+e.limit);return this.table.getAllMsgsFromOrderedIds(r).then(un.e)}))}getStorageSettingChatsMediaSizes(){return this.table.transact("r",["media"],()=>{var e=performance.now();return this.table.stores.media.toArray().then(t=>{var n=new Map;t.forEach(e=>{if((0,Nt.j)(e)){var t=new Set;e.msgIds.forEach(e=>{var n=(0,gt.v)(e);null!=n&&t.add(n)});var r=(0,Nt.f)(e);t.forEach(e=>{var t,a=null!=(t=n.get(e))?t:0;n.set(e,a+r)})}});var r=Array.from(n.entries()).map(e=>{var t=m()(e,2);return{chatId:t[0],mediaSize:t[1]}}).sort((e,t)=>t.mediaSize-e.mediaSize),a=performance.now()-e;return a>=5e3&&(__LOG__(2)`getStorageSettingChatsMediaSizes ${a}ms, medias.length = ${t.length}`,SEND_LOGS("storageSetting-slow",.01)),{chatIdsWithMediaSize:r}})})}getStorageSettingTotalMediaSize(){return this.table.transact("r",["media"],()=>{var e=performance.now();return this.table.stores.media.toArray().then(t=>{var n=0,r=0;t.forEach(e=>{if((0,Nt.j)(e)){var t=(0,Nt.f)(e);n+=t,t>=D.s&&(r+=t)}});var a=performance.now()-e;return a>=5e3&&(__LOG__(2)`getStorageSettingTotalMediaSize ${a}ms, medias.length = ${t.length}`,SEND_LOGS("storageSetting-slow",.01)),{totalMediaSize:n,largeFilesTotalSize:r}})})}getAllMediaMsgIds(e){return this.table.transact("r",["msgs","media"],()=>this.table.getStorageSettingSortedMediaMsgIds(e))}loadMsgContentVCards(e){return(0,Pt.i)(this.table.getMsgFromId(e).then(t=>{if(t)return t.type!==O.f.VCARD?(__LOG__(4)`Trying to load vcard content from non-vcard msg ${e}`,void SEND_LOGS("non-vcard")):t.contacts;__LOG__(2)`Tried to load vcard content but message is gone ${e}`}))}loadChatStarredMsgs(e,t,n){var r=[(0,Nt.a)(e),gt.i],a=n?[n.msgId,n.starred]:[(0,Nt.d)(e),gt.i];return(0,Pt.i)((0,Pt.j)(this.table.stores.msgs,["id","starred"]).between(r,a,!1,!1).reverse().limit(t).toArray().catch(()=>[]))}loadStarredMsgs(e,t){var n=t||gt.i;return(0,Pt.i)(this.table.stores.msgs.where("starred").below(n).reverse().limit(e).toArray().catch(()=>[]))}purgeExpiredInvitations(e){return this.table.transact("rw",["groups","groupParticipantsInfo","chats"],()=>this.table.getChatAndGroupInTransaction(e).then(t=>{if(!t||!t.dbGroup)return __LOG__(3)`Trying to purge invitations for a non-group chat ${e}`,void SEND_LOGS("purge-group-invitations");var n=t.dbChat,r=t.dbGroup,a=r.participantsInfo.invitations;if(!a)return __LOG__(2)`No invitations to purge in ${e}`,null;var i=a.filter(e=>(0,L.p)(e.expiration));return i.length===a.length?(__LOG__(2)`No invitations to be purged for ${e}`,null):(r.participantsInfo.invitations=i,__LOG__(2)`${a.length-i.length} invitations removed for ${e}`,this.table.setParticipantsInfo(r.participantsInfo).then(()=>(0,kt.a)(n,r)))}))}getSentGroupInvitations(e,t){return this.table.transact("rw",["msgs","meta"],()=>this.table.getAllMsgsFromIds(t).then(t=>this.table.getGroupInviteRevokes().then(Ft.f).then(n=>{var r=n.sent,a={};return t.forEach(t=>{if(t.author===O.b&&t.type===O.f.GROUP_INVITE){var n,i=null==(n=r[e])?void 0:n[t.groupJid],s=i&&t.inviteExpiration<=i;if((0,L.p)(t.inviteExpiration)&&!s){var o=a[t.groupJid];(null==o||o.expiration<t.inviteExpiration)&&(a[t.groupJid]={jid:e,code:t.inviteCode,expiration:t.inviteExpiration})}}}),__LOG__(2)`${Object.keys(a).length} group invites to be purged.`,a})))}removeGroupInvitations(e,t){return this.table.transact("rw",["groups","groupParticipantsInfo","chats","msgs","meta"],()=>{var n=(0,bt.s)(t,e=>e.jid);return this.removeGroupInvitationsInTransaction(e,e=>{var t=n[e.jid];return null!=t&&t.code===e.code}).then(n=>this.table.revokeGroupInvitesInTransaction(e,!0,t.map(e=>({user:e.jid,expiresBefore:e.expiration}))).then(t=>({updatedGroup:n,revokedInvites:{result:"revoked_group_invites",groupJid:e,outgoing:!0,revokes:t}})))})}removeGroupInvitationsInTransaction(e,t){return this.table.getChatAndGroupInTransaction(e).then(n=>{if(!n||!n.dbGroup)return __LOG__(3)`Tried to remove invitation from non-existent group ${e}`,void SEND_LOGS("remove-group-invitations-not-exists");var r=n.dbChat,a=n.dbGroup,i=a.participantsInfo.invitations;if(i){var s=i.filter(e=>!t(e));if(i.length!==s.length)return a.participantsInfo.invitations=s,__LOG__(2)`${i.length-s.length} filtered for group ${e}`,this.table.setParticipantsInfo(a.participantsInfo).then(()=>(0,kt.a)(r,a));__LOG__(2)`No invitations to be updated. Ignoring`}else __LOG__(2)`No invitations in group. Ignoring`})}revokeGroupInvites(e,t,n){return __LOG__(2)`revokeGroupInvites: revoke invite for ${e}`,this.table.transact("rw",["meta","groups","groupParticipantsInfo","chats"],()=>{var r;if(t){var a=(0,bt.s)(n,e=>e.user);r=this.removeGroupInvitationsInTransaction(e,e=>{var t=a[e.jid];return null!=t&&e.expiration<=t.expiresBefore})}return(r||(0,Pt.e)()).then(r=>this.table.revokeGroupInvitesInTransaction(e,t,n).then(n=>({updatedGroup:r,revokeResult:{result:"revoked_group_invites",groupJid:e,outgoing:t,revokes:n}})))})}updatePHashIfMatches(e,t,n){return this.table.transact("rw",["contacts"],()=>this.table.stores.contacts.get(e).then(e=>{if(e){var r=(0,zt.d)(e);if(r.length===t.length){r.sort();for(var a=t.sort(),i=0;i<a.length;++i)if(a[i]!==r[i])return;return this.table.stores.contacts.put(Object.assign({},e,{phash:n})).then(()=>{})}}}))}handleDevicesInfo(e,t){return this.table.transact("rw",["meta","contacts","groupParticipantsInfo","msgs","chats","groups"],()=>(0,Pt.c)([this.table.stores.meta.get(qt.a.DELETE_EXPIRED_DEVICES_JOB),this.table.stores.contacts.get(e)]).then(n=>{var r=m()(n,2),a=r[0],i=r[1],s=null==a?{lastRunTs:-1}:a.value,o=i||{jid:e};return this.handleADVInTransaction(o,t,s).then(e=>{var t=e.notificationMsgs,n=e.updatedContact,r=e.contactWasUpdated,a=e.requestDeviceSync,i=e.deviceVerificationWasUpdated;return r||i?(r&&delete n.phash,this.table.stores.contacts.put(n).then(()=>({contactWasUpdated:r,updatedContact:n,notificationMsgs:t,requestDeviceSync:a}))):{contactWasUpdated:r,updatedContact:n,notificationMsgs:[],requestDeviceSync:a}})}))}expireContacts(e){var t=[],n=[];return this.table.transact("rw",["contacts","groupParticipantsInfo","msgs","chats","groups"],()=>{var r=e.map(e=>()=>this.expireContactInTransaction(e).then(r=>{var a=r.updated,i=r.notificationMsgs;a&&t.push(e),n.push(...i)}));return(0,Pt.f)(r).then(()=>({updatedJids:t,notificationMsgs:n}))})}expireContactInTransaction(e){return this.table.stores.contacts.get(e).then(e=>{var t;if(null==e)return{updated:!1,notificationMsgs:[]};var n=Object.assign({},e,{devices:[zt.a],deviceVerification:void 0,phash:void 0}),r=(null==(t=e.devices)?void 0:t.filter(e=>e.id!==k.c).map(t=>(0,N.A)(e.jid,t.id)))||[];return 0===r.length?this.table.stores.contacts.put(n).then(()=>({updated:!1,notificationMsgs:[]})):this.table.userParticipantsInfo(e.jid).then(e=>{var t=e.groups,a=this.table.stores.groupParticipantsInfo.bulkPut(t.map(e=>{var t=e.participantsInfo;return Dt.e(t,[],r)})),i=this.Yp(n,!1,t,0,r.length,!1);return(0,Pt.c)([i,a])}).then(e=>{var t=m()(e,1)[0],n=t.notificationMsgs,a=t.updatedContact;return this.table.stores.contacts.put(a).then(()=>({updated:r.length>0,notificationMsgs:n}))})})}updateContactADVTimestamps(e,t,n,r){return this.table.transact("rw",["contacts"],()=>this.table.stores.contacts.get(e).then(e=>{var a=null==e?void 0:e.deviceVerification;if(null!=e&&null!=a){var i=Object.assign({},e,{deviceVerification:Object.assign({},a,{expectedTs:t,expectedTsUpdatedTs:n,deleteExpiredDeviceTs:r})});return this.table.stores.contacts.put(i).then(()=>{})}}))}handleADVInTransaction(e,t,n){var r=t.usyncResponse?(function(e,t,n){switch(t.type){case"adv_list":return(function(e,t,n,r){var a=e.deviceVerification;if(a&&a.timestamp>t.timestamp)return Jt({addedDevices:[],removedDevices:[],updatedContact:e});if(!a||a.rawId!==t.rawId)return Jt(Wt(e,t));var i=!1,s=!1;if(null!=n&&null!=a.expectedTs&&n===a.expectedTs){var o=a.deleteExpiredDeviceTs;t.timestamp<a.expectedTs&&(null==o||o<r.lastRunTs)&&(i=!0,s=!0)}(null==a.expectedTs||t.timestamp>=a.expectedTs)&&(s=!0);var u=s?void 0:a.expectedTs,d=s?void 0:a.expectedTsUpdatedTs,c=s?void 0:a.deleteExpiredDeviceTs;if(!e.devices||0===e.devices.length)return Jt({addedDevices:[],removedDevices:[],updatedContact:Object.assign({},e,{deviceVerification:{rawId:t.rawId,timestamp:t.timestamp,expectedTs:u,expectedTsUpdatedTs:d,deleteExpiredDeviceTs:c}})},i);var l=[],p=[];return e.devices.forEach(n=>{var r=n.id,a=n.index;r!==k.c?a>t.currentIndex||t.validIndexes.includes(a)?p.push({id:r,index:a}):l.push((0,N.A)(e.jid,r)):p.push({id:r,index:a})}),Jt({addedDevices:[],removedDevices:l,updatedContact:Object.assign({},e,{devices:p,deviceVerification:{rawId:t.rawId,timestamp:t.timestamp,expectedTs:u,expectedTsUpdatedTs:d,deleteExpiredDeviceTs:c}})},i)})(e,t.adv,t.expectedTs,n);case"adv_list_and_devices":return(function(e,t,n,r,a){var i=e.deviceVerification;if(i&&i.timestamp>n.timestamp)return Jt({addedDevices:[],removedDevices:[],updatedContact:e});var s=t.filter(e=>Zt(e.index,n));if(!i||i.rawId!==n.rawId)return Jt(Wt(e,n,s));var o=new Map([[k.c,zt.b]]),u=[],d=[],c=e.devices?new Map(e.devices.map(e=>[e.id,e.index])):new Map;e.devices&&e.devices.forEach(e=>{var t=e.id,r=e.index;r>n.currentIndex&&o.set(t,r)}),s.forEach(t=>{var n=t.id,r=t.index;o.has(n)||(o.set(n,r),c.get(n)!==r&&u.push((0,N.A)(e.jid,n)))}),e.devices&&e.devices.forEach(t=>{var n=t.id,r=t.index;o.get(n)!==r&&d.push((0,N.A)(e.jid,n))});var l=!1,p=!1;if(null!=r&&null!=i.expectedTs&&r===i.expectedTs){var h=i.deleteExpiredDeviceTs;n.timestamp<i.expectedTs&&(null==h||h<a.lastRunTs)&&(l=!0,p=!0)}(null==i.expectedTs||n.timestamp>=i.expectedTs)&&(p=!0);var f=p?void 0:i.expectedTs,m=p?void 0:i.expectedTsUpdatedTs,v=p?void 0:i.deleteExpiredDeviceTs;return Jt({addedDevices:u,removedDevices:d,updatedContact:Object.assign({},e,{devices:Qt(o),deviceVerification:{rawId:n.rawId,timestamp:n.timestamp,expectedTs:f,expectedTsUpdatedTs:m,deleteExpiredDeviceTs:v}})},l)})(e,t.devices,t.adv,t.expectedTs,n);case"primary_only":return(function(e){var t=[];return(0,zt.d)(e).forEach(n=>{n!==k.c&&t.push((0,N.A)(e.jid,n))}),Jt({addedDevices:[],removedDevices:t,updatedContact:Object.assign({},e,{devices:[zt.a]})})})(e);case"device_added_notification":return(function(e,t,n,r){var a=e.deviceVerification;if(a&&a.timestamp>=n.timestamp)return Yt({addedDevices:[],removedDevices:[],updatedContact:e},!1);var i,s=a?a.timestamp:0,o=(i=a&&a.rawId===n.rawId?(function(e,t,n){var r=new Set([...(0,zt.d)(e),...t.map(e=>e.id)]),a=[],i=[],s=new Map,o=e.devices?new Map(e.devices.map(e=>[e.id,e.index])):new Map,u=new Map(t.map(e=>[e.id,e.index]));return r.forEach(t=>{var r=(0,N.A)(e.jid,t),d=u.get(t),c=o.get(t);c&&!Zt(c,n)&&c<=n.currentIndex&&(i.push(r),c=null,null==d)||(null!=c&&null!=d&&d>c?(i.push(r),a.push(r),s.set(t,d)):null==c&&null!=d?(a.push(r),s.set(t,d)):c&&s.set(t,c))}),{addedDevices:a,removedDevices:i,updatedContact:Object.assign({},e,{devices:Qt(s),deviceVerification:{rawId:n.rawId,timestamp:n.timestamp}})}})(e,t,n):Wt(e,n,t)).updatedContact.deviceVerification;if(!o)throw __LOG__(4)`Expected contact to have deviceVerification info at this point`,SEND_LOGS("adv-device-add-null-deviceverification"),Error("Expected contact to have deviceVerification info at this point");o.timestamp=s;var u=W(n.timestamp,s,null==a?void 0:a.expectedTs,null==a?void 0:a.expectedTsUpdatedTs,r);return"update"===u.type&&(i.updatedContact.deviceVerification=Object.assign({},o,{expectedTs:u.expectedTs,expectedTsUpdatedTs:u.expectedTsUpdatedTs,deleteExpiredDeviceTs:u.expectedTsDeleteExpiredJobTs})),Yt(i,"update"===u.type)})(e,t.devicesToAdd,t.adv,n);case"device_removed_notification":return(function(e,t,n){var r=e.deviceVerification;if(r&&r.timestamp>n)return Yt({addedDevices:[],removedDevices:[],updatedContact:e},!1);var a=[],i=e.devices?new Map(e.devices.map(e=>[e.id,e.index])):new Map;t.forEach(t=>{var n=t.id,r=t.index;i.get(n)===r&&(a.push((0,N.A)(e.jid,n)),i.delete(n))});var s=0===a.length?e:Object.assign({},e,{devices:Qt(i)});return Yt({addedDevices:[],removedDevices:a,updatedContact:s},!1)})(e,t.devicesToRemove,t.advTs);case"adv_devices_reset":return(function(e,t,n){var r=e.deviceVerification;if(r&&r.timestamp>n)return Jt({addedDevices:[],removedDevices:[],updatedContact:e});var a=[];return e.devices&&e.devices.forEach(t=>{var n=t.id;t.index,n!==k.c&&a.push((0,N.A)(e.jid,n))}),Jt({addedDevices:[],removedDevices:a,updatedContact:Object.assign({},e,{devices:[zt.a],deviceVerification:{rawId:t,timestamp:n}})})})(e,t.rawId,t.newIncomingTs);default:return(0,R.a)(t.type)}})(e,t.usyncResponse,n):(function(e,t,n){var r=t.keyIndex,a=t.deviceId,i=t.rawId,s=t.timestamp,o=e.deviceVerification;if(o&&o.timestamp>=s)return Yt({addedDevices:[],removedDevices:[],updatedContact:e},!1);if(o&&o.rawId===i){var u=new Map;if(e.devices&&e.devices.forEach(e=>{var t=e.id,n=e.index;u.set(t,n)}),u.get(a)===r)return Yt({addedDevices:[],removedDevices:[],updatedContact:e},!1);var d=[],c=[];if(u.has(a)){var l=(0,N.A)(e.jid,a);d.push(l),c.push(l),u.set(a,r)}else d.push((0,N.A)(e.jid,a)),u.set(a,r);var p=Object.assign({},e,{devices:Qt(u)}),h=W(s,o.timestamp,o.expectedTs,o.expectedTsUpdatedTs,n);return"update"===h.type&&(p.deviceVerification=Object.assign({},o,{expectedTs:h.expectedTs,expectedTsUpdatedTs:h.expectedTsUpdatedTs,deleteExpiredDeviceTs:h.expectedTsDeleteExpiredJobTs})),Yt({addedDevices:d,removedDevices:c,updatedContact:p},"update"===h.type)}var f=[];(0,zt.d)(e).forEach(t=>{t!==k.c&&f.push((0,N.A)(e.jid,t))});var m=null,v=void 0,g=void 0,_=void 0;if(null==o)m=0;else{m=o.timestamp;var E=W(s,o.timestamp,o.expectedTs,o.expectedTsUpdatedTs,n);"update"===E.type&&(v=E.expectedTs,g=E.expectedTsUpdatedTs,_=E.expectedTsDeleteExpiredJobTs)}return Yt({addedDevices:[(0,N.A)(e.jid,a)],removedDevices:f,updatedContact:Object.assign({},e,{deviceVerification:{rawId:i,timestamp:m,expectedTs:v,expectedTsUpdatedTs:g,deleteExpiredDeviceTs:_},devices:[zt.a,{id:a,index:r}]})},!0)})(e,t.identity,n),a=r.advResult,i=a.updatedContact,s=a.removedDevices,o=a.addedDevices,u="usync"===r.type&&r.deviceVerificationFailed;if(s.length+o.length===0){var d=null;d=u?this.table.userParticipantsInfo(e.jid).then(e=>{var n=e.groups;return this.Yp(i,t.isPkMsg||!1,n,o.length,s.length,u)}):(0,Pt.e)({notificationMsgs:[]});var c=i.deviceVerification,l=e.deviceVerification,p=(null==c?void 0:c.expectedTs)!==(null==l?void 0:l.expectedTs)||(null==c?void 0:c.expectedTsUpdatedTs)!==(null==l?void 0:l.expectedTsUpdatedTs)||(null==c?void 0:c.deleteExpiredDeviceTs)!==(null==l?void 0:l.deleteExpiredDeviceTs);return d.then(t=>{var n=t.notificationMsgs;return(0,Pt.e)({notificationMsgs:n,updatedContact:p?i:e,contactWasUpdated:!1,deviceVerificationWasUpdated:p,requestDeviceSync:"device-change"===r.type&&r.requestDeviceSync})})}return this.table.userParticipantsInfo(e.jid).then(e=>{var n=e.groups,r=this.table.stores.groupParticipantsInfo.bulkPut(n.map(e=>{var t=e.participantsInfo;return Dt.e(t,o,s)})),a=this.Yp(i,t.isPkMsg||!1,n,o.length,s.length,u);return(0,Pt.c)([a,r])}).then(e=>{var t=m()(e,1)[0],n=t.notificationMsgs;return{updatedContact:t.updatedContact,notificationMsgs:n,contactWasUpdated:!0,requestDeviceSync:"device-change"===r.type&&r.requestDeviceSync}})}Yp(e,t,n,r,a,i){if(!x.M.get()||!(0,ye.b)(e))return(0,Pt.e)({notificationMsgs:[],updatedContact:e});var s;if((0,Q.a)("adv_v2_m6")){if(!i)return(0,Pt.e)({notificationMsgs:[],updatedContact:e});s="verification-failed"}else if(r+a>1)s="coalesced";else if(1===r)s="add";else{if(1!==a)return(0,Pt.e)({notificationMsgs:[],updatedContact:e});s="remove"}var o=e.jid;return(!e.chatId&&t?this.createUserChatInTransaction(o,e).then(e=>{var t=m()(e,3);return t[0],[t[1],t[2]]}):(0,Pt.e)([e,[]])).then(e=>{var t=m()(e,2),r=t[0],a=t[1],i={type:O.f.IDENTITY_CHANGE,externalId:"keychange/devices/"+(0,un.t)(),ts:(0,L.E)(),author:o,ack:O.a.RECEIVED,altIndex:"",subtype:s},u=n.map(e=>this.addGroupSystemMsgWithResult(e.groupInfo.chatId,i,e));return r.chatId&&u.push(this.addSystemMsgWithResult(r.chatId,i)),(0,Pt.c)(u).then(e=>({notificationMsgs:e.concat(a).filter(Boolean),updatedContact:r}))})}getSortedCallLogs(){return(0,Pt.i)(this.table.getSortedCallLogs())}initializeCallLog(e,t){return this.table.getOrInitializeCallLog(e,t)}createMissedCallLog(e,t){return this.table.createMissedCallLog(e,t)}finalizeCallLog(e,t,n,r){return this.table.finalizeCallLog(e,t,n,r)}deleteCallLogs(e){return(0,Pt.i)(this.table.deleteCallLogs(e))}clearAllCallLogs(){return(0,Pt.i)(this.table.clearAllCallLogs())}getGroupInfoWithParticipants(e){return this.table.transact("rw",["groups","groupParticipantsInfo"],()=>this.table.getGroupInfoWithParticipantsInTransaction(e))}getParticipantsInfo(e){return this.table.transact("rw",["groupParticipantsInfo"],()=>this.table.getParticipantsInfoInTransaction(e))}rotateSenderKey(e){return this.table.transact("rw",["groupParticipantsInfo"],()=>this.table.getParticipantsInfoInTransaction(e).then(e=>{if(!e)return null;var t=Dt.d(e);return this.table.setParticipantsInfo(t).then(()=>t)}))}getNextExpirationTimestamp(){return this.table.stores.msgs.orderBy("validUntil").first().then(e=>null==e?void 0:e.validUntil)}getExpiredMessages(){return this.table.stores.msgs.where("validUntil").belowOrEqual((0,L.E)()).toArray().then(e=>{var t=new Map;return e.forEach(e=>{var n=e.chat,r=e.id,a=t.get(n);a?a.push(r):t.set(n,[r])}),t})}getNextViewOnceExpirationTimestamp(){return this.table.stores.msgs.orderBy("viewOnceExpiration").filter(e=>(0,$t.b)(e)&&"active"===e.viewOnceState).first().then(e=>null==e?void 0:e.viewOnceExpiration)}expireViewOnceMessages(){return this.table.stores.msgs.where("viewOnceExpiration").belowOrEqual((0,L.E)()).filter(e=>(0,$t.b)(e)&&"active"===e.viewOnceState).toArray().then(e=>{if(0===e.length)return{expiredMsgs:[],updatedChats:[]};var t=new Map,n=e.map(e=>{var n,r=e;return(0,$t.b)(e)?r=(0,bt.j)(e,{viewOnceState:"expired"}):__LOG__(3)`expireViewOnceMessages: Expected view once messages only`,t.set(r.chat,[...null!=(n=t.get(r.chat))?n:[],r]),r});if(0===n.length)return{expiredMsgs:[],updatedChats:[]};var r=this.table.stores.msgs.bulkPut(n).then(()=>n.map(xt.c)),a=this.table.stores.chats.where("id").anyOf(Array.from(t.keys())).toArray().then(e=>{var n=[];if(e.forEach(e=>{(0,Nt.h)(e,t.get(e.id)||[])&&n.push(e)}),0===n.length)return[];var r=this.table.stores.chats.bulkPut(n),a=(0,Pt.c)(n.map(e=>(0,N.x)(e.jid,{user:t=>(0,Pt.e)().then(()=>(0,kt.a)(e,null)),group:t=>this.table.getGroupInfoWithParticipantsInTransaction(t).then(t=>(0,kt.a)(e,t))})));return(0,Pt.c)([a,r]).then(e=>m()(e,1)[0])});return(0,Pt.c)([a,r]).then(e=>{var t=m()(e,2),n=t[0];return{expiredMsgs:t[1],updatedChats:n}})})}deleteAllExpiredMsgsForChat(e){return this.table.transact("rw",["msgs","chats","groups","groupParticipantsInfo","media","receipts","meta","previews","reactions"],()=>this.table.stores.msgs.where("validUntil").belowOrEqual((0,L.E)()).toArray().then(t=>t.filter(t=>t.chat===e).map(e=>e.id)).then(t=>(0,cn.c)(this,e,t)).then(e=>e.chat))}markHsmButtonPressed(e,t){return this.table.transact("rw",["msgs"],()=>this.table.getMsgFromId(e).then(e=>{if(e)if(e.type===O.f.RICH_HSM){var n=e.buttons;if(null!=n)if(t<0||t>n.length)__LOG__(3)`markHsmButtonPressed called with button index that is out of range of the stored buttons array`;else{if(n[t].type===O.d.QUICK_REPLY){var r=Object.assign({},n[t],{pressed:!0}),a=[...n];a[t]=r;var i=Object.assign({},e,{buttons:a});return this.table.stores.msgs.put(i).then(()=>(0,xt.c)(i))}__LOG__(3)`markHsmButtonPressed called for a button that is not of a quick reply type`}else __LOG__(3)`markHsmButtonPressed called for a rich HSM with no buttons defined`}else __LOG__(3)`markHsmButtonPressed called for a non rich HSM`;else __LOG__(3)`markHsmButtonPressed called for a non existing message`}))}setChatWallpaper(e,t){return this.table.transact("rw",["groups","groupParticipantsInfo","chats"],()=>this.table.stores.chats.get(e).then(n=>{if(!n)return __LOG__(2)`setChatWallpaper chat ${e} does not exist`,null;var r=(0,bt.j)(n,t),a=(0,N.p)(r.jid),i=a?this.table.getGroupInfoWithParticipantsInTransaction(a):null;return(0,Pt.c)([i,this.table.updateChat(r)]).then(e=>{var t=m()(e,1)[0];return{result:"updated_chat",chat:(0,kt.a)(r,t)}})}))}resetWallpaperInAllChats(){var e=[];return this.table.transact("rw",["groups","groupParticipantsInfo","chats"],()=>this.table.stores.chats.toCollection().filter(e=>!!e.chatBackgroundSettings).modify(t=>{t.chatBackgroundSettings=void 0,e.push(t.id)}).then(()=>0===e.length?[]:(0,Pt.c)(e.map(e=>this.table.getChatInTransaction(e).then(e=>this.table.getChatAndGroupInTransaction(e.jid)))).then(e=>e?e.reduce((e,t)=>{if(!t)return __LOG__(4)`One of previously modified chats have not been found`,e;var n=t.dbChat,r=t.dbGroup;return e.push((0,kt.a)(n,r)),e},[]):(__LOG__(4)`None of previously modified chats have been found`,[]))))}getRecentEmojis(){return(0,Pt.i)(this.table.stores.meta.get(qt.a.RECENT_EMOJIS).then(e=>null==e?void 0:e.value))}setRecentEmojis(e){return(0,Pt.i)(this.table.stores.meta.put({key:qt.a.RECENT_EMOJIS,value:e}).then(()=>e))}Yq(e){var t={ack:e.ack,altIndex:e.altIndex,ts:e.ts,author:e.author,externalId:e.externalId,urlText:e.urlText};null!=e.deviceId&&(t.deviceId=e.deviceId),null!=e.urlNumber&&(t.urlNumber=e.urlNumber);var n=(0,I.a)(S.g,e.protobuf).documentMessage,r=n?(0,w.d)(n,t):void 0,a=e.rowId,i=e.id,s=e.chat;if(null==r)return(0,cn.c)(this,s,[i]).then(e=>{var t=e.chat,n=e.msgIds.find(e=>e===i);return null==n?(__LOG__(4)`Message was not deleted!`,void SEND_LOGS("convert-futureproof-document-delete-error")):{type:"deleted",msgId:n,chat:t}});var o=r.msg,u=r.media;if(o.type!==O.f.DOCUMENT)throw new Error("makeMedia created non-document message!");var d=(o.isVCard,Object.assign({},o,{rowId:a,id:i,chat:s}));return jt.q(this,i,d,u).then(e=>{var t=e.toStore;return this.table.stores.msgs.put(t).then(()=>this.table.getChatInTransaction(s).then(e=>this.table.getChatAndGroupInTransaction(e.jid)).then(e=>{if(null!=e){var n=e.dbChat,r=e.dbGroup,a={type:"updated",chat:(0,kt.a)(n,r),msg:(0,xt.c)(t),recent:!1};return null==n.previewMsg||n.previewMsg.id!==i?a:(n.previewMsg=(0,Ut.a)(t)||void 0,this.table.updateChat(n).then(()=>Object.assign({type:"updated"},a,{chat:(0,kt.a)(n,r)})))}__LOG__(4)`Tried to convert message in an non-existing chat!`}))})}convertFutureproofMessage(e){return this.table.transact("rw",["groups","groupParticipantsInfo","chats","msgs","receipts","media","previews","reactions"],()=>this.table.getMsgFromId(e).then(e=>{if(null!=e)if(e.type===O.f.FUTUREPROOF)switch(e.subtype){case"document":return this.Yq(e);default:return __LOG__(4)`Tried to convert a futureproof message that cannot be converted (subtype: ${e.subtype})!`,void SEND_LOGS("tried-convert-wrong-futureproof")}else __LOG__(3)`Tried to convert non-futureproof message type ${e.type}!`;else __LOG__(3)`Tried to convert non-existing message!`}))}recomputeSuspiciousCharacters(e){return this.table.transact("rw",["groups","groupParticipantsInfo","chats","msgs"],()=>this.table.getMsgFromId(e).then(e=>{if(null!=e)if(e.type===O.f.TEXT){var t=e.linkPreview;if(t){var n=Ft.i(e.author),r=null!=n?(0,Ht.a)(t.matchedText,n,x.r.get(),[(0,Bt.d)().lg]):null,a=Object.assign({},e,{linkPreview:Object.assign({},t,{suspiciousCharacters:r})});return this.table.stores.msgs.put(a).then(()=>{var e=a.chat;return this.table.getChatInTransaction(e).then(e=>this.table.getChatAndGroupInTransaction(e.jid)).then(e=>{if(null!=e){var t=e.dbChat,n=e.dbGroup;return{type:"updated",chat:(0,kt.a)(t,n),msg:(0,xt.c)(a),recent:!1}}__LOG__(4)`Tried to convert message in an non-existing chat!`})})}__LOG__(4)`Tried to recompute suspicious characters in a text message with no link preview!`}else __LOG__(4)`Tried to recompute suspicious characters in a message of type ${e.type}!`;else __LOG__(3)`Tried to recompute suspicious characters in an non-existing message!`}))}getRecipientsForJid(e){return this.table.transact("rw",["groupParticipantsInfo","contacts"],()=>(0,N.w)(e,{user:e=>this.table.getContact(e).then(t=>t&&t.devices&&0!==t.devices.length?(0,X.m)((0,zt.c)(t)):(0,X.l)((0,N.e)(e))),multicast:e=>this.table.getParticipantsInfoInTransaction(e).then(e=>{if(!e)return(0,X.f)();var t=Array.from(e.knowsSenderKey.keys());return(0,X.m)(t)})}))}updateDeleteExpiredDevicesJobInfo(e){return(0,Pt.i)(this.table.stores.meta.put({key:qt.a.DELETE_EXPIRED_DEVICES_JOB,value:e}).then(()=>{}))}getDeleteExpiredDevicesJobInfo(){return(0,Pt.i)(this.table.stores.meta.get(qt.a.DELETE_EXPIRED_DEVICES_JOB).then(e=>null==e?{lastRunTs:-1}:e.value))}putDbUserNotice(e){return this.table.stores.meta.put({key:qt.a.USER_NOTICE,value:e}).then(()=>{})}deleteDbUserNotice(){return this.table.stores.meta.delete(qt.a.USER_NOTICE)}updateCurrentUserNotice(e){var t=["meta"];return x.m.set(!0).then(()=>this.table.transact("rw",t,()=>this.table.getDbUserNotice().then(t=>{var n=t,r=!1;if(n){var a=n.id,i=e.find(e=>e.id===a);if(i&&i.state!==gt.q.EXPIRED){if(i.state>n.currentState)n=Object.assign({},n,{currentState:i.state,transitionTs:i.ts});else if(n.currentState===gt.q.EXPIRED)return __LOG__(2)`updateCurrentUserNotice: current user notice in accept state. will try resending acceptance IQ. id:${a}`,{id:i.id,needsSendAccept:{version:i.version},needsDownload:!1};if(n.content){var s=n.content,o=s.lglc,u=s.version,d=o.lg,c=o.lc,l=(0,Bt.d)(),p=l.lg,h=l.lc;u<i.version?(r=!0,__LOG__(2)`updateCurrentUserNotice: old version content detected ${u}, will download ${i.version}`):d===p&&c===h||(__LOG__(2)`updateCurrentUserNotice: content in old language detected ${d}-${c}, will download ${p}-${h}`,r=!0)}else r=!0}else{var f=i?"expired-in-ib":"not-in-ib";__LOG__(2)`updateCurrentUserNotice: will delete current user notice. id:${a} reason:${f}`,n=null}}if(null==n){var m=e.filter(e=>e.state!==gt.q.EXPIRED).map(e=>e.id);if(m.length>0){var v=Math.min(...m),g=e.find(e=>e.id===v);g&&(__LOG__(2)`updateCurrentUserNotice: choosing new user notice ${g.id} to be the current user notice`,n={id:g.id,currentState:g.state,transitionTs:g.ts},r=!0)}}if(null!=n){var _=n.id;return this.putDbUserNotice(n).then(()=>({id:_,needsDownload:r}))}return this.deleteDbUserNotice()})).then(e=>x.m.set(null!==e).then(()=>e)))}updateContentForUserNotice(e,t){return this.table.transact("rw",["meta"],()=>this.table.getDbUserNotice().then(n=>{if(n){if(n.id===e){var r=n.currentState,a=n.transitionTs,i=n.showCount,s=n.snoozed,o=n.timeLastShown;if(r===gt.q.TRIGGERED&&(r=gt.q.FETCHED,a=(0,L.E)()),(function(e){switch(e){case Xt:case en:case an:return!1;case tn:case nn:case rn:return!0;default:return __LOG__(4)`isUIUserNoticeState: unknown state ${e}`,!1}})(r)){var u,d=on(t,n.currentState);if(!d)return __LOG__(4)`updateContentForUserNotice: Current UI state ${r} does not have a timing object`,void SEND_LOGS("user-notice-content-update-no-timing");(null==(u=d.duration)?void 0:u.repeat)||(i=void 0,s=void 0,o=void 0)}var c=Object.assign({},n,{content:t,currentState:r,transitionTs:a,showCount:i,snoozed:s,timeLastShown:o});return this.putDbUserNotice(c).then(()=>c)}__LOG__(3)`Tried to update content for non-existing user notice with id ${e}`}else __LOG__(4)`Could not get user notice from meta table`}))}getDbUserNotice(){return this.table.transact("r",["meta"],()=>this.table.getDbUserNotice())}logUserNoticeDisplayed(e,t){return this.table.transact("rw",["meta"],()=>this.table.getDbUserNotice().then(n=>{var r;if(n){if(n.id!==e)return __LOG__(3)`Attempted to log user notice display for ${e} that does not exist in storage`,void SEND_LOGS("log-notice-display-not-exists");if(!n.content)return __LOG__(4)`Attempted to log user notice display that has no content`,void SEND_LOGS("log-notice-display-no-content");if(n.snoozed)__LOG__(2)`Attempted to log user notice display that has has been snoozed`;else{if(n.currentState>=gt.q.EXPIRED)return __LOG__(4)`Attempted to log user notice display for expired notice`,void SEND_LOGS("log-notice-display-expired");var a=on(n.content,n.currentState);if(a&&(null==a||null==(r=a.duration)?void 0:r.repeat)){var i=(n.showCount||0)+1,s=Object.assign({},n,{showCount:i,timeLastShown:t,snoozed:!0});return __LOG__(2)`timeTransitionUserNotice: notice with id: "${n.id}" is snoozed. showCount is: ${i}"`,this.putDbUserNotice(s).then(()=>s)}__LOG__(3)`Attempted to log notice display when current state has no "repeat" timing`}}else __LOG__(4)`Could not get user notice from meta table`}))}acceptUserNotice(e,t,n,r){return this.table.transact("rw",["meta"],()=>this.table.getDbUserNotice().then(t=>{if(!t)return __LOG__(4)`Could not get user notice from meta table`,!1;if(t.id!==e)return __LOG__(4)`Attempted to accept a user notice that does not exist"`,SEND_LOGS("accept-notice-not-exists"),!1;if(!t.content)return __LOG__(4)`Attempted to accept user notice that has no content`,SEND_LOGS("accept-notice-no-content"),!1;var a=t.currentState,i=t.content;if(a>=gt.q.EXPIRED)return __LOG__(4)`Attempted to accept expired user notice`,SEND_LOGS("accept-expired-notice"),!1;var s=null;"non-blocking-modal"===r?s=6:"blocking-modal"===r&&(s=9);var o=Object.assign({},t,{currentState:gt.q.EXPIRED,transitionTs:n,snoozed:void 0,showCount:void 0,timeLastShown:void 0});return this.putDbUserNotice(o).then(()=>{var t=i.version;return s&&WAM.log("regular",2472,void 0,[3,0,s,1,0,e,2,0,t]),!0})}))}purgeUserNotice(e){return this.table.transact("rw",["meta"],()=>this.table.getDbUserNotice().then(t=>t?t.id!==e?(__LOG__(3)`purgeUserNotice: Tried to purge user notice ${t.id} when there is a different notice ${e} in storage`,!0):this.deleteDbUserNotice().then(()=>!1):(__LOG__(2)`purgeUserNotice: Tried to delete ${e} but there is no user notice to delete`,!1))).then(e=>x.m.set(e)).then(()=>{})}updateStaleUserNotice(e,t,n){return this.table.transact("rw",["meta"],()=>this.table.getDbUserNotice().then(r=>{if(r){if(r.id!==e)return __LOG__(4)`updateStaleUserNotice: Attempted to update state for user notice that does not exist"`,void SEND_LOGS("update-stale-user-notice-not-exist");if(r.currentState>=t)__LOG__(3)`updateStaleUserNotice: Tried to update user notice state to a previous state`;else{if(!(0,L.p)(n)){var a=Object.assign({},r,{currentState:t,transitionTs:n});return this.putDbUserNotice(a)}__LOG__(3)`updateStaleUserNotice: Tried to update user notice state to a time in the future`}}else __LOG__(4)`updateStaleUserNotice: Could not get user notice from meta table`}))}timeTransitionUserNotice(){return __LOG__(2)`timeTransitionUserNotice: checking if current user notice needs to change state via their timing object"`,this.table.transact("rw",["meta"],()=>this.table.getDbUserNotice().then(e=>{if(e){var t=void 0,n=(function(e){var t,n,r,a,i=e.content;if(i){for(var s=i.banner,o=i.nonBlockingModal,u=i.blockingModal,d=e.currentState,c=(function(e,t){var n=[];if(e===en&&t.length>0){var r=t[0],a=r.state;null==r.timing.start&&n.push({state:a,type:"start",time:(0,L.E)()})}return t.forEach(t=>{var r=t.state,a=t.timing;r>e&&a.start&&n.push({state:r,type:"start",time:a.start.time}),r>=e&&a.end&&n.push({state:r,type:"end",time:a.end.time})}),n})(d,[(null==s?void 0:s.timing)&&{state:tn,timing:null==s?void 0:s.timing},(null==o?void 0:o.timing)&&{state:nn,timing:null==o?void 0:o.timing},(null==u?void 0:u.timing)&&{state:rn,timing:null==u?void 0:u.timing}].filter(Boolean)),l=null,p=c.length-1;p>=0;p--){var h=c[p];if(!(0,L.p)(h.time)){l=h;break}}if(l){var f=l,m=f.type,v=f.state;return"start"===m?{nextState:v,reason:"future-state-timing-start-elapsed"}:{nextState:sn(v,i),reason:"future-state-timing-end-elapsed"}}var g=on(i,d),_=sn(d,i),E=on(i,_);if(null==E||null==(t=E.start)?void 0:t.time)return(0,L.p)(E.start.time)?void __LOG__(2)`maybeTimeTransitionNotice: Waiting for start time to elapse at time ${E.start.time}`:{nextState:_,reason:"next-state-timing-start-elapsed"};if(null==g||null==(n=g.end)?void 0:n.time)return(0,L.p)(g.end.time)?void __LOG__(2)`maybeTimeTransitionNotice: Waiting for end time to elapse at time ${g.end.time}`:{nextState:_,reason:"current-state-timing-end-elapsed"};if(null==g||null==(r=g.duration)?void 0:r.static){var b=(0,L.j)(e.transitionTs+L.d*g.duration.static);return(0,L.p)(b)?void __LOG__(2)`maybeTimeTransitionNotice: Waiting for static duration to elapse at time ${b}`:{nextState:_,reason:"current-state-timing-duration-elapsed"}}if(null==g||null==(a=g.duration)?void 0:a.repeat){var y=g.duration.repeat,S=e.showCount,I=e.timeLastShown,w=e.snoozed;if(null==S||null==w||null==I)return void __LOG__(2)`maybeTimeTransitionNotice: repeat timing but storage missing repeat properties`;if(S>y.length)return __LOG__(3)`maybeTimeTransitionNotice: showCount was greater than number of elements in in "repeat" timing`,{nextState:_,reason:"current-state-timing-repeat-final-complete"};var T=(0,L.j)(I+L.d*y[S-1]);if(!(0,L.p)(T)&&S===y.length)return{nextState:_,reason:"current-state-timing-repeat-final-complete"};__LOG__(2)`maybeTimeTransitionNotice: Waiting for next repeat event at time ${T}`}}else __LOG__(2)`maybeTimeTransitionNotice: no time transition because there is no content (and hence no timings)`})(e);if(n)__LOG__(2)`timeTransitionUserNotice: notice with id: "${e.id}" time transition: "${e.currentState}" -> "${n.nextState}", reason: "${n.reason}"`,t=Object.assign({},e,{currentState:n.nextState,transitionTs:(0,L.E)(),snoozed:void 0,showCount:void 0,timeLastShown:void 0});else{if(!(function(e){var t,n=e.currentState;if(!e.content)return!1;var r=on(e.content,n);if(!(null==r||null==(t=r.duration)?void 0:t.repeat))return!1;var a=r.duration.repeat,i=e.showCount,s=e.timeLastShown,o=e.snoozed;if("number"!=typeof i||"boolean"!=typeof o||!s)return!1;if(!1===o||i<=0||i>=a.length)return!1;var u=(0,L.j)(s+L.d*a[i-1]);return!(0,L.p)(u)})(e))return void __LOG__(2)`timeTransitionUserNotice: nothing to do right now (no time transition or unsnoozing needed)`;__LOG__(2)`timeTransitionUserNotice: notice with id: "${e.id}" is being unsnoozed`,t=Object.assign({},e,{snoozed:!1})}if(t){var r,a={id:t.id,state:t.currentState,version:null==(r=t.content)?void 0:r.version};return this.putDbUserNotice(t).then(()=>a)}}else __LOG__(2)`No user notice to time transition`}))}Yr(e){return __LOG__(3)`manuallyAdvanceUserNoticeToNextState: Only available during development`,Promise.resolve()}manuallyAdvanceUserNoticeToState(e){return this.Yr(e)}manuallyAdvanceUserNoticeToNextState(){return this.Yr()}manuallySetUserNoticeTiming(e,t){return __LOG__(3)`manuallySetUserNoticeTiming: Only available during development`,Promise.resolve()}manuallyUnsnoozeUserNotice(){return __LOG__(3)`manuallyUnsnoozeUserNotice: Only available during development`,Promise.resolve()}manuallyAddDebugUserNotice(e){return __LOG__(3)`manuallyAddDebugUserNotice: Only available during development`,Promise.resolve()}manuallyAddDebugUserNoticeWithContent(e){var t=gt.q.FETCHED;return null!=e.banner?t=gt.q.BANNER_SHOW:null!=e.nonBlockingModal?t=gt.q.NON_BLOCKING_MODAL_SHOW:null!=e.blockingModal&&(t=gt.q.BLOCKING_MODAL_SHOW),this.manuallyAddDebugUserNotice({id:1234,transitionTs:(0,L.E)(),currentState:t,content:e})}manuallyPurgeUserNotice(){return __LOG__(3)`manuallyPurgeUserNotice: Only available during development`,Promise.resolve()}deleteExpiredOrphanedStanzas(){return this.table.transact("rw",["orphanedStanzas"],()=>this.table.stores.orphanedStanzas.where("ts").belowOrEqual((0,L.x)(D.y*L.b)).delete())}});Tr(e),(0,u.O)();var g=Sr({onConnectionChange:t=>{"in_handshake"===t?v.then(()=>{f("socket-connection")}):(0,Ee.d)()?"connected"===t?e.fireAndForget("event","commsConnected",{}):e.fireAndForget("event","commsDisconnected",{}):(0,ht.jobsTable)().checkAppRunId().then(e=>{e&&(0,Ee.j)()}),(0,Ee.d)()&&(0,ht.jobsTable)().updateAppRunId()},onOptimisticConnectionChange:e=>{}});(0,r.m)(_e,a.sendPing,g,Tt.b);var _=()=>(f("bridge-call"),(function(e){e.setHandlers("voip",{startVoipCall:e=>{return t=e.jid,n=e.uiContext,void ut.enqueue(()=>(0,c.a)()).then(e=>{"idle"===e?d.p(t,n):__LOG__(2)`startVoipCall called while a POTS call is ongoing (${e})`});var t,n},acceptVoipCall(){ut.enqueue(()=>(0,c.a)()).then(e=>{"idle"===e?d.a():__LOG__(2)`acceptVoipCall called while a POTS call is ongoing (${e})`})},rejectVoipCall(){dt().then(()=>d.l())},endVoipCall(){dt().then(()=>d.b(!0))},muteVoipCall:e=>{return t=e.shouldMute,void dt().then(()=>d.k(t));var t},interruptVoipCall:e=>{return t=e.shouldInterrupt,void dt().then(()=>d.i(t));var t},updateVoipCallDuration(){d.d().then(e=>{"evicted"!==e&&(null==e?(0,Ee.c)("event","callEnded",{}):(0,Ee.c)("event","callDurationChanged",{duration:e.audioDuration}))})},updateCallNetworkMedium(e){var t;t=e.type,dt().then(()=>d.q(t))},voipCallFailed(){},voipConnectionAttempted:()=>(0,d.r)()}),e.setHandlers("backend",{networkConnected(){__LOG__(2)`Internet connection established, trying to reconnect to whatsapp`,(0,r.c)()},createChat(e){var t=e.jid;return s.i(t).then(e=>({chatId:e}))},runJob(e){var t=e.jobId;return(0,P.c)(t)},clearUiJobStatus(e){var t=e.jobId;(0,P.a)(t)},muteChat(e){var t=e.chatId,n=e.mutedUntil;s.Vb(t,n)},muteAuthor(e){var t=e.authorJid;s.Ub(t)},unmuteAuthor(e){var t=e.authorJid;s.Jc(t)},setChatArchivedState(e){var t=e.chatId,n=e.archived;s.sc(t,n)},markChatAsUnread(e){var t=e.chatId;s.Ib(t)},removeChatUnreadMark(e){var t=e.chatId;s.dc(t)},sendChatState(e){(function(e,t){var n;switch(t){case"idle":n=(0,l.v)("paused",null);break;case"typing":n=(0,l.v)("composing",null);break;case"recording_audio":n=(0,l.v)("composing",{media:"audio"});break;default:return(0,R.a)(t)}(0,r.a)((0,l.v)("chatstate",{to:(0,l.g)(e)},n))})(e.jid,e.type)},sendPresenceSubscription:e=>(function(e){var t=(0,N.q)(e);if(t&&(0,Q.a)("trusted_contacts"))return(0,be.d)(t).then(n=>{var r=n.dbContact,a=n.receivedToken,i=n.senderTokenTs;(0,Q.a)("trusted_contacts_reciprocity")?(i||r&&((0,Se.k)(r)||(0,ye.e)(r)))&&Ie(t,a):Ie(e,a)});Ie(e)})(e.jid),sendPresenceStatus(e){var t;t=e.type,(0,r.a)((0,l.v)("presence",{type:t}))},runDebugMethod(e){var t=e.name,n=e.args;return self.Debug[t].apply(null,n)},loadMsgRange(e){var t=e.chatId,n=e.anchor,r=e.range;return s.Ab(t,n,r)},doesMsgExist(e){var t=e.msgId;return s.p(t)},loadFullsizeAvatar(e){var t;t=e.jid,(0,$e.getProfilePicTable)().getThumb(t).then(e=>e&&e.dontRetryBefore&&(0,L.p)(e.dontRetryBefore)?null:(0,r.e)((function(e){return(0,l.v)("iq",{to:l.k,target:(0,l.g)(e),type:"get",xmlns:"w:profile:picture",id:(0,l.t)()},(0,l.v)("picture",{type:"image",query:"url"}))})(t),We).then(n=>{if(!n.success)switch(n.errorCode){case 401:return __LOG__(2)`getProfilePic for ${t}: Not authorized`,(0,N.p)(t)?(0,$e.getProfilePicTable)().refreshLastUpdated(t).then(()=>null):Qe(t);case 404:case 406:return Qe(t);case 500:case 501:case 503:return __LOG__(2)`getFullsizeAvatar error ${t}: Do not retry`,e?(0,$e.getProfilePicTable)().setDontRetryBefore(t,(0,L.l)(L.d)).then(()=>null):(0,$e.getProfilePicTable)().storeEmptyThumb(t,(0,L.l)(L.d)).then(()=>null);default:throw new Error(`Failed to get profile picture: ${n.errorCode} ${n.errorText}`)}var r=n.result;if(304===r.code)return __LOG__(4)`getFullsizeAvatar: code 304 received when we shouldn't`,null;var a={jid:t,avatar:{url:r.url,photoId:r.id}};return e&&r.id!==e.photoId?(0,$e.getProfilePicTable)().clearRecord(t).then(()=>{(0,Ee.c)("event","avatarsUpdated",{cleared:[t]})}).then(()=>a):a}).then(e=>{null!=e&&(0,Ee.c)("event","fullsizeAvatarLoaded",{jid:e.jid,avatar:e.avatar})}))},markMediaContentAsDeleted(e){var t=e.msgId;return s.Mb(t)},getRecentGifs:()=>(0,o.j)(),getFavoriteGifs(e){var t=e.fromId,n=e.limit;return(0,o.h)(t,n)},isFavoriteGif(e){var t=e.plaintextHash;return(0,o.m)(t)},isFavoriteGifFromId(e){var t=e.gifAttribution,n=e.gifId;return(0,o.n)(t,n)},markGifContentAsDeleted(e){var t=e.source,n=e.plaintextHash;return"recents"===t?(0,o.s)(n):(0,o.p)(n)},loadAvatars(e){e.jids.forEach(e=>(function(e){return Xe(e,t=>(function(e,t){return Ze(e,(0,l.v)("picture",{id:null!=t?(0,l.f)(t):l.d,type:"preview",query:"url"}))})(e,t))})(e))},loadAvatarGroupInvite(e){var t,n;t=e.jid,n=e.code,Xe(t,e=>(function(e,t,n){return Ze(e,(0,l.v)("picture",{id:null!=t?(0,l.f)(t):l.d,invite:(0,l.b)(n),type:"preview",query:"url"}))})(t,e,n),!0)},loadAvatarAddRequest(e){var t,n;t=e.jid,n=e.addRequest,Xe(t,e=>(function(e,t,n){return Ze(e,(0,l.v)("picture",{id:null!=t?(0,l.f)(t):l.d,type:"preview",query:"url"},(0,l.v)("add_request",{code:(0,l.b)(n.code),expiration:(0,l.f)(n.expiration),admin:(0,l.g)(n.admin)})))})(t,e,n),!0)},getMsgInfos(e){var t=e.msgId;return s.V(t)},getMsgReactions(e){var t=e.msgId;return(0,y.c)(t)},getIdentityVerificationData(e){var t=e.jid;return Promise.resolve().then(n.bind(null,415)).then(e=>e.default(t))},registerCompanionDevice:e=>(e.qrString,Promise.resolve()),syncAllContacts(e){var t=e.type,n=e.revision;return(0,Ve.oneTimeSyncAllContacts)(t,n)},deltaSync(e){var t=e.type,n=e.revision,r=e.addedPhoneToJid;return(0,Ve.deltaSync)(t,n,r)},startDeleteAccount:()=>x.g.set(!0).then(()=>Promise.all([(0,i.b)(),(0,Me.deleteTmpTables)()])).then(()=>{}),setVerboseSecurity(e){var t=e.privacySecurity;x.M.set(t)},saveAlphaJpegStickerBlob(e){var t=e.msgId,n=e.blob;return(0,At.c)(t,n).then(e=>("fail"===e.status&&__LOG__(2)`WEBP AlphaJpeg sticker cannot be saved in a ChunkTable`,e))},getStickerMsgMediaRefs(e){var t=e.msgId;return s.kb(t).then(e=>null==e||null==e.frame||null==e.plaintext?null:{isNotNativeSupported:!0,frame:e.frame,contentRef:e.plaintext})},decodeWebPImage(e){var t=e.buffer,r=e.scaleCount;return n.e(178).then(n.bind(null,649)).then(e=>e.decodeWebP(t,r))},receivedPush(){(0,r.p)()},syncAbProps:()=>(0,Ke.a)(),syncServerProps:()=>(0,He.a)(),chatsNotified(e){e.chatNotifications.forEach(e=>{e.ts?s.Qc(e.chatId,e.ts):__LOG__(4)`For some reason notification was set as notified without a ts`})},cancelMedia(e){var t=e.msgId;(0,Oe.a)(t)},deleteAllMedia(e){var t=e.olderThan;return s.k(t||void 0).then(()=>{})},loadCallLogs:()=>s.eb().then(e=>({logs:e})),loadChatMediaMsgs:e=>s.ub(e),getStorageSettingChatsMediaSizes:()=>s.lb(),getStorageSettingTotalMediaSize:()=>s.mb(),loadStorageSettingMediaMsgs:e=>s.Eb(e),getAllMediaMsgIds(e){var t=e.filter;return s.x(t)},loadChatStarredMsgs(e){var t=e.chatId,n=e.limit,r=e.previousLastMsgId;return s.vb(t,n,r)},loadStarredMsgs(e){var t=e.limit,n=e.previousLastMsgStarredId;return s.Cb(t,n)},loadChatKeptMessages(e){var t=e.chatId,n=e.limit,r=e.previousLastMsgId;return(0,Ir.b)(t,n,r)},sendMetrics(){(0,Pe.e)("sendMetrics")},sendAnonymousMetrics(){(0,Pe.e)("sendAnonymousMetrics")},getGdprReportStatus(){(0,et.a)()},getTwoFactor(){(0,r.e)((0,l.v)("iq",{to:l.k,type:"get",xmlns:"urn:xmpp:whatsapp:account",id:(0,l.t)()},new l.n("2fa")),tt).then(e=>{if(!e.success)throw new Error(`Failed to get 2fa: ${e.errorCode} ${e.errorText}`);return __LOG__(2)`getTwoFactor: response has code: ${e.result.code}, has email: ${e.result.email}`,e.result})},checkTwoFactor(e){var t,n;t=e.pin,(0,r.e)((n=t.join(""),(0,l.v)("iq",{to:l.k,type:"get",xmlns:"urn:xmpp:whatsapp:account",id:(0,l.t)()},new l.n("2fa",void 0,[(0,l.v)("code",null,n)]))),nt).then(e=>!!e.success&&e.result)},queryBusinessProfile(e){var t=e.jid;return n.e(161).then(n.bind(null,650)).then(e=>e.default(t))},verifyTwoFactorReminder(e){var t,n,r;t=e.pin,r="enabled"===(n=x.K.get()).status&&n.pin===t.join(""),(0,rt.e)(r),(0,Ee.c)("event","twoFactorReminderVerified",{success:r})},downloadGdprReport(e){(function(e,t){var n=(function(e,t){var n=t.fileLength;if(!n)return __LOG__(4)`makeEntry: protobuf metadata with bad size ${n}`,null;var r=(0,L.E)();if(t.mediaKey&&t.fileEncSha256){var a={version:"mms4",type:ee.c.DOCUMENT,cryptoKey:t.mediaKey,ciphertextHash:t.fileEncSha256,size:n,creationTs:r,mediaKeyTs:t.mediaKeyTimestamp?(0,L.j)(t.mediaKeyTimestamp):e,validatedTs:r};return t.directPath&&(a.directPath=t.directPath),a}if(t.url&&t.mediaKey&&!t.fileEncSha256){var i={version:"mms3",type:ee.c.DOCUMENT,cryptoKey:t.mediaKey,url:t.url,size:n,creationTs:(0,L.E)()};return/^https:\/\/(\w|-)+\.whatsapp\.net\//.test(i.url)?i:(__LOG__(4)`makeMedia msg has bad mms3 url ${i.url}`,null)}return __LOG__(4)`makeEntry: metadata does not have enough entry info`,null})(e,t);if(n){var r=new it.a({parts:at.b,onUpdate(e){__LOG__(2)`download ${100*e}% finished`,(0,Ee.c)("event","gdprReportDownloading",{percent:e})},onSuccess:()=>{__LOG__(2)`download finished`},onError:()=>{__LOG__(2)`download failed`}});r.parts.initial.finished(),(0,at.c)("manual",n,(0,V.e)(t.fileSha256),r,{overallDownloadOrigin:6,overallDownloadMode:1,overallMediaType:8}).then(e=>{var n=e.result,a=e.metric;if(r.parts.processing.finished(),"success"===n.status){(0,Oe.k)(Object.assign({},a,{overallDownloadResult:1,overallIsFinal:!0}));var i=new Blob([n.plaintext],{type:t.mimetype});return(0,st.getChunkTable)().storeGdprReport(i).then(()=>({type:"success",plaintext:i}))}return(0,Oe.k)(Object.assign({},a,{overallDownloadResult:at.a[n.status],overallIsFinal:!0})),{type:"error",error:"gone"===n.status?"download_expired":"download_failed"}}).then(e=>(0,Ee.c)("event","gdprReportDownloaded",{result:e}))}})(e.reportCreationTime,e.gdprReportMetadata)},queryGroupInfoFromCode(e){var t=e.code;return(0,lt.queryGroupInfoFromCode)(t)},queryGroupInviteCode(e){var t=e.groupJid;return(0,lt.queryGroupInviteCode)(t)},queryAddRequest(e){var t=e.group,n=e.code,r=e.expiration,a=e.admin;return(0,ct.queryAddRequest)(t,n,r,a)},purgeExpiredInvitations(e){var t=e.groupJid;s.Yb(t)},loadStatusAuthors(){s.tb()},loadStatuses(e){var t=e.statusIds;return s.gb(t)},loadStatusWithAuthor(e){var t=e.statusId;return s.jb(t)},loadLastUnreadStatusMsg(){s.xb()},loadStatusPrivacySettings(){s.Db()},loadSentStatusInfo:()=>s.Bb().then(e=>({infos:e})),statusTabOpened(){x.F.flush().then(ot.maybeDownloadPendingStatusThumbnails)},contactQuerySync(e){var t=e.rawPhoneNumber;return(0,Ve.contactQuerySync)(t)},getContactsBlacklist:()=>(0,we.a)(),getExpiredMessages:()=>s.M(),deleteExpiredMsgs(e){var t=e.chatId,n=e.msgIds;return s.m(t,n,"expired")},deleteAllExpiredMsgsForChat(e){var t=e.chatId;return s.j(t)},getNextExpirationTimestamp:()=>s.X(),recomputeSuspiciousCharacters(e){var t=e.msgId;s.bc(t)},getPrivacySettings:()=>(0,we.b)(),setActivityInProgress(e){var t=e.name;(0,vt.b)(t)},loadMsgContentVCards(e){var t=e.msgId;return s.yb(t)},getRecentEmojis:()=>s.ab(),setRecentEmojis(e){var t=e.recentEmojis;s.Dc(t)},getUserNotice:()=>s.G().then(e=>e?(0,wt.b)(e):void 0),acceptUserNotice(e){var t=e.id,n=e.version,r=e.ts,a=e.source;s.a(t,n,r,a)},logUserNoticeDisplayed(e){var t=e.id,n=e.ts;s.Gb(t,n)},downloadUserNoticeDeepLinkModal(e){var t=e.id;return(0,Mt.downloadUserNoticeDeepLinkModal)(t)},ephemeralTimestamp(e){var t;t=e.validUntil,Ue()||(__LOG__(2)`addNewEphemeralTimestamp invoked`,xe||(xe=new De),xe.update(t))},syncAbCacheFromStorage:()=>(0,Q.e)(),maybePinAbProp(e){var t=e.key,n=e.val;return(0,Q.d)(t,n)},getMediaMsglikelyOnServerFrom(e){var t=e.msgId;return s.R(t)},viewOnceTimestamp(e){var t;t=e.validUntil,je()||(Be||(Be=new Fe),Be.update(t))},setAppVisible(e){var t=e.visible;(0,Ot.b)(t)},unlinkViewOnceMsgsMedia(e){var t=e.msgIds;return s.Ic(t)},getPrivateStatsIds:()=>St(),loadCompanions:()=>Promise.resolve(),getCommunityInfo(e){var t=e.jid;return s.F(t)},queryCommunitiesSubGroups(e){var t=e.jid;return n.e(162).then(n.bind(null,555)).then(e=>e.default(t))}})})(e),mt.b);return e.setNamespaceHandler("backend",_),e.setNamespaceHandler("voip",_),v.then(()=>f)}},,,function(e,t,n){n.d(t,"a",(function(){return u}));var r=n(37),a=n(31),i=n.n(a),s=n(108),o=n(24);function u(e){var t;switch(e.type){case r.c.TEXT:t={type:"text",text:(0,s.c)(e.text),font:e.font,textColor:e.textColor,backgroundColor:e.backgroundColor};break;case r.c.IMAGE:t={type:"image",previewId:(0,o.b)(e),bg:e.bg};break;case r.c.VIDEO:t={type:"video",previewId:(0,o.b)(e),bg:e.bg};break;case r.c.GIF:t={type:"gif",previewId:(0,o.b)(e),bg:e.bg};break;case r.c.FUTUREPROOF:break;case r.c.REVOKED:case r.c.CIPHERTEXT:break;default:(0,i.a)(e)}return t?{id:e.id,content:t,ts:e.ts}:null}},function(e,t,n){n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));var r=n(7);function a(e){return"msg"===e?0:"pkmsg"===e?1:2}function i(e){var t=null,n=null;if("multicast"===e.type){var a=e.to;n=null!=(0,r.p)(a)?1:(0,r.c)(a)?3:2}else n=0,t=(0,r.r)(e.to)?1:2;return{e2eDestination:n,e2eReceiverType:t}}function s(e){var t=e.type,n=e.destination,r=e.e2eSuccessful,s=e.messageMediaType,o=a(t),u=i(n),d=u.e2eDestination,c=u.e2eReceiverType,l=null;e.retryCount&&(l=e.retryCount);var p={e2eCiphertextVersion:2,e2eCiphertextType:o,e2eDestination:d,e2eSuccessful:r,e2eReceiverType:c,messageMediaType:s,retryCount:l};r?WAM.log("regular",476,void 0,[5,0,p.e2eCiphertextType,6,0,p.e2eCiphertextVersion,4,0,p.e2eDestination,2,0,p.e2eFailureReason,8,0,p.e2eReceiverType,1,1,p.e2eSuccessful,9,0,p.encRetryCount,10,1,p.messageIsInvisible,7,0,p.messageMediaType,3,0,p.retryCount]):1*Math.random()<1&&WAM.log("regular",476,void 0,[5,0,p.e2eCiphertextType,6,0,p.e2eCiphertextVersion,4,0,p.e2eDestination,2,0,p.e2eFailureReason,8,0,p.e2eReceiverType,1,1,p.e2eSuccessful,9,0,p.encRetryCount,10,1,p.messageIsInvisible,7,0,p.messageMediaType,3,0,p.retryCount],void 0,1)}function o(e){var t=e.type,n=e.destination,r=e.e2eSuccessful,s=e.messageMediaType,o=e.e2eSenderType,u=e.e2eFailureReason,d=a(t),c=i(n).e2eDestination,l=null;e.retryCount&&(l=e.retryCount);var p={e2eCiphertextVersion:2,e2eCiphertextType:d,e2eDestination:c,e2eSuccessful:r,e2eSenderType:o,e2eFailureReason:u,messageMediaType:s,retryCount:l};r?WAM.log("regular",478,void 0,[5,0,p.e2eCiphertextType,6,0,p.e2eCiphertextVersion,4,0,p.e2eDestination,2,0,p.e2eFailureReason,8,0,p.e2eSenderType,1,1,p.e2eSuccessful,7,0,p.messageMediaType,9,1,p.offline,3,0,p.retryCount]):1*Math.random()<1&&WAM.log("regular",478,void 0,[5,0,p.e2eCiphertextType,6,0,p.e2eCiphertextVersion,4,0,p.e2eDestination,2,0,p.e2eFailureReason,8,0,p.e2eSenderType,1,1,p.e2eSuccessful,7,0,p.messageMediaType,9,1,p.offline,3,0,p.retryCount],void 0,1)}},,,,,,,function(e,t,n){n.d(t,"f",(function(){return p})),n.d(t,"a",(function(){return h})),n.d(t,"d",(function(){return f})),n.d(t,"b",(function(){return m})),n.d(t,"c",(function(){return g})),n.d(t,"e",(function(){return _}));var r=n(9),a=n.n(r),i=n(3),s=n(2),o=n(5),u=n(10),d=n(8),c=n(23),l=n(223);function p(e,t){return(0,c.a)("trusted_contacts")?(0,d.c)("writeReceivedPrivacyTokens",n=>(function(e,t,n){return e.table.transact("rw",["privacyTokens"],()=>{var r=(0,u.u)(n);return e.table.stores.privacyTokens.where("jid").equals(t).toArray().then(n=>{var i=[];n.forEach(e=>{if(e.type===s.g.TC_RECEIVED){var t=e.type,n=r[t];if(n)if(delete r[t],e.ts>=n.ts)__LOG__(3)`_writePrivacyToken received older ${t} token`;else{var a=Object.assign({},e,{value:n.value,ts:n.ts});i.push(a)}}});var d=(0,u.v)(r).map(e=>{var n=a()(e,2),r=n[0],i=n[1];return Object.assign({jid:t,type:r},i)});return(0,o.c)([e.table.stores.privacyTokens.bulkPut(i),e.table.stores.privacyTokens.bulkAdd(d)]).then(()=>({added:d.length,updated:i.length}))})})})(n,e,t),(t,n,r)=>{var a=t.added,i=t.updated;0===a&&0===i||r.fireAndForget("event","trustedContactTokenUpdatedForJid",{jid:e})}):Promise.resolve()}function h(e,t){return e.table.stores.privacyTokens.where("jid").equals(t).delete()}function f(e){return(0,c.a)("trusted_contacts")?(0,d.f)("readTrustedContactPresenceInfo",t=>(function(e,t){return e.transact("rw",["contacts","privacyTokens"],()=>(0,o.c)([e.getContact(t),E(e,t),b(e,t)]).then(t=>{var n=a()(t,3),r=n[0],i=n[1],s=n[2],u={dbContact:r},d=[];return i&&((0,l.b)(i)?d.push(e.stores.privacyTokens.delete(i.id)):u.receivedToken=i.value),s&&((0,l.b)(s)?d.push(e.stores.privacyTokens.delete(s.id)):u.senderTokenTs=null==s?void 0:s.ts),(0,o.c)(d).then(()=>u)}))})(t,e)):Promise.resolve(Object.freeze({}))}function m(){return(0,d.f)("deleteExpiredPrivacyTokens",e=>(function(e){return e.transact("rw",["privacyTokens"],()=>(0,o.c)(v.map(t=>{var n=(0,l.c)(t);return(0,o.j)(e.stores.privacyTokens,["type","ts"]).between([t,i.c],[t,n],!1,!1).delete().then(e=>{})})).then(()=>{}))})(e))}var v=(0,u.x)(s.g);function g(e){return(0,c.a)("trusted_contacts_sender")?(0,d.f)("getTrustedContactSenderToken",t=>(0,o.i)((function(e,t){return b(e,t).then(e=>{if(null!=e&&!(0,l.b)(e))return e})})(t,e))):Promise.resolve()}function _(e,t){return(0,c.a)("trusted_contacts_sender")?(0,d.c)("refreshTrustedContactSenderToken",n=>(function(e,t,n){return e.transact("rw",["privacyTokens"],()=>b(e,t).then(r=>{if(r)return r.ts>n?(__LOG__(3)`Tried to refresh token with older timestamp`,!1):e.stores.privacyTokens.put(Object.assign({},r,{ts:n})).then(()=>!0);var a={jid:t,type:s.g.TC_SENDER,ts:n};return e.stores.privacyTokens.add(a).then(()=>!0)}))})(n.table,e,t),(t,n,r)=>{t&&r.fireAndForget("event","trustedContactTokenUpdatedForJid",{jid:e})}):Promise.resolve()}function E(e,t){return e.stores.privacyTokens.where("jid").equals(t).toArray().then(e=>{for(var t=0;t<e.length;t++){var n=e[t];if(n.type===s.g.TC_RECEIVED)return n}})}function b(e,t){return e.stores.privacyTokens.where("jid").equals(t).toArray().then(e=>{for(var t=0;t<e.length;t++){var n=e[t];if(n.type===s.g.TC_SENDER)return n}})}},function(e,t,n){function r(e){if(e.hasChild("growth_locked"))return a(e)}function a(e){var t=e.child("growth_locked"),n=t.attrString("type");if("invite"===n)return{type:"invite",expiration:t.attrTime("expiration")};throw __LOG__(4)`Unhandled growth locked state value ${n}`,SEND_LOGS("invalid-growth-locked-"+n),new Error("invalid growth locked type")}n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}))},,function(e,t,n){n.d(t,"c",(function(){return g})),n.d(t,"d",(function(){return _})),n.d(t,"f",(function(){return E})),n.d(t,"g",(function(){return b})),n.d(t,"e",(function(){return y})),n.d(t,"b",(function(){return S})),n.d(t,"a",(function(){return I}));var r=n(9),a=n.n(r),i=n(11),s=n(59),o=n(8),u=n(12),d=(n(125),n(106)),c=n(58),l=n(3),p=n(5),h=n(51),f=n(143);function m(e){return t=(function(e){var t=new Map;return e.forEach(e=>{var n=(0,f.c)(e.text),r=t.get(n);if(r)r.reactions.push({author:e.author,text:e.text,ts:e.senderTimestampMs}),e.author===i.a?t.set(n,{label:e.text,reactions:r.reactions,hasFromMe:!0}):!r.hasFromMe&&(0,d.b)(e.senderTimestampMs,r.lastTs)&&(r.lastTs=e.senderTimestampMs,r.label=e.text);else{var a=[{author:e.author,text:e.text,ts:e.senderTimestampMs}],s=e.author===i.a?{label:e.text,reactions:a,hasFromMe:!0}:{label:e.text,reactions:a,lastTs:e.senderTimestampMs};t.set(n,s)}}),t})(e),Array.from(t.values()).sort((e,t)=>{if(e.hasFromMe||t.hasFromMe)return e.hasFromMe?-1:1;var n=t.reactions.length-e.reactions.length;return 0!==n?n:(0,d.b)(e.lastTs,t.lastTs)?-1:1});var t}var v=n(104);function g(e){return(0,o.f)("getMsgReactions",t=>(0,p.i)((function(e,t){return O(e,t).then(e=>m(e))})(t,e)))}function _(e){return(0,o.f)("getReactionFromId",t=>(0,p.i)(t.stores.reactions.get(e)))}function E(e){var t=["reactions","msgs","chats","groups","groupParticipantsInfo","orphanedStanzas","contacts"];return(0,o.f)("writeIncomingReaction",n=>n.transact("rw",t,()=>{var t=e.content,r=e.msgRef,s=t.chatJid;return n.getChatAndGroupInTransaction(s).then(s=>{if(s){var o=s.dbChat,u=s.dbGroup,c=o.id,l=r.msgAuthor,h=r.msgExternalId;return n.getMsgFromExternalId(c,{author:l,externalId:h}).then(r=>{if(!r)return __LOG__(2)`writeIncomingReaction msg not found. Storing as orphan`,(function(e,t){var n=t.content,r=t.msgRef,a=n.author,i=n.senderTimestampMs,s=n.chatJid,o=r.msgExternalId,u=r.msgAuthor;return e.getOrphanedMsgsInTransaction(o,u,s).then(t=>{if(!t.revoke){var r,c=t.reactions.get(a);if(c){if((0,d.b)(c.content.senderTimestampMs,i))return void __LOG__(2)`maybeStoreOrphanReactionInTransaction: newest orphan reaction exists. Skipping`;r=e.stores.orphanedStanzas.delete(c.id)}__LOG__(2)`maybeStoreOrphanReactionInTransaction: storing new orphan reaction`;var l={type:"reaction",ts:n.ts,chatJid:s,content:n,externalId:o,author:u};return(0,p.e)(r).then(()=>e.stores.orphanedStanzas.add(l).then(()=>{}))}__LOG__(2)`maybeStoreOrphanReactionInTransaction: msg is revoked, ignoring orphaned reaction`})})(n,e);var s=r.id;return w(n,Object.assign({},t,{msgId:s})).then(e=>{var t;r.author===i.a&&e.author!==i.a&&void 0!==e.text&&o.archived&&(t=n.incrementMsgsRowId(o).then(e=>(o.sortBy=e,delete o.archived,n.updateChat(o).then(()=>({dbChat:o,dbGroup:u})))));var d=(0,i.D)(o.jid),c=null!=d?n.getContact(d):void 0;return(0,p.c)([T(n,s),t,c]).then(t=>{var n=a()(t,3),r=n[0],i=n[1],s=n[2];return{dbReaction:e,dbMsg:r,dbChatInfo:i,dbContact:s}})})})}__LOG__(4)`writeIncomingReaction chat not found`})})).then(e=>{if(e){var t=e.dbMsg,n=e.dbReaction,r=e.dbChatInfo,a=e.dbContact,i=(0,c.c)(t);if((0,u.c)("event","reactionReceived",{msg:i}),(function(e,t){"@me"!==t.author&&e.meta.fromMe&&(0,u.c)("event","notifyNewReaction",{msg:{id:e.id,chatId:e.chatId,content:e.content,mentionedJids:e.mentionedJids},reaction:{id:t.id,author:t.author,msgId:t.msgId,text:t.text}})})(i,n),r){var s=r.dbChat,o=r.dbGroup;(0,u.c)("event","chatModified",{chat:(0,h.a)(s,o)})}(0,v.o)(n,a)}})}function b(e){var t=["reactions","msgs","chats"];return(0,o.f)("writeOutgoingReaction",n=>n.transact("rw",t,()=>{var t=e.msgId,r=e.text,i=e.externalId,o=e.groupingKey,u=e.senderTimestamp,d=(0,s.k)(t);return(0,p.c)([n.stores.reactions.where("externalId").equals(i).first(),n.stores.chats.get(d)]).then(e=>{var s=a()(e,2),d=s[0],c=s[1];if(c)return d?(__LOG__(2)`writeOutgoingReaction: deduped`,n.getMsgFromId(t).then(e=>e&&{dbMsg:e,dbReaction:d})):w(n,{author:"@me",msgId:t,chatJid:c.jid,externalId:i,groupingKey:o,text:r,ts:(0,l.E)(),senderTimestampMs:1e3*u}).then(e=>T(n,t).then(t=>({dbReaction:e,dbMsg:t})));__LOG__(4)`writeOutgoingReaction msg not found`})})).then(e=>{if(e){var t=e.dbMsg,n=e.dbReaction;return(0,u.c)("event","reactionReceived",{msg:(0,c.c)(t)}),n.id}})}function y(e){return(0,o.f)("markSentReactionError",t=>t.transact("rw",["reactions","msgs"],()=>t.stores.reactions.get(e).then(e=>{if(e&&e.author===i.a){var n=e.msgId;return t.getMsgFromId(n).then(n=>{if(n){var r=n.reactions||{count:0,reactions:[]};return e.error="send-error",r.error={id:e.id,code:"send-error"},n.reactions=r,(0,p.c)([t.stores.msgs.put(n),t.stores.reactions.put(e)]).then(()=>({dbMsg:n}))}__LOG__(4)`markSentReactionError msg not found`})}__LOG__(3)`markSentReactionError sent reaction not found`}))).then(e=>{if(e){var t=e.dbMsg;(0,u.c)("event","reactionReceived",{msg:(0,c.c)(t)})}})}function S(e,t){return(0,o.f)("clearSentReactionError",n=>n.transact("rw",["reactions","msgs"],()=>n.stores.reactions.get(e).then(r=>{if(r&&r.author===i.a&&null!=r.error){var a=r.msgId;return n.getMsgFromId(a).then(i=>{if(!i)return __LOG__(4)`clearSentReactionError msg not found`,SEND_LOGS("orphan-reaction"),n.stores.reactions.delete(e);if(null==i.reactions||null==i.reactions.error)return __LOG__(3)`clearSentReactionError valid cache not found`,T(n,a).then(()=>{});var s=i.reactions;return r.senderTimestampMs=1e3*t,delete r.error,delete s.error,(0,p.c)([n.stores.msgs.put(i),n.stores.reactions.put(r)]).then(()=>({dbMsg:i,dbReaction:r}))})}__LOG__(3)`clearSentReactionError sent error reaction not found`}))).then(e=>{if(e){var t=e.dbMsg,n=e.dbReaction;return(0,u.c)("event","reactionReceived",{msg:(0,c.c)(t)}),n.id}})}function I(e,t,n){return(0,p.c)(Array.from(n.values()).map(n=>{var r=n.content;return A(e,Object.assign({},r,{msgId:t}))})).then(()=>T(e,t))}function w(e,t){var n=t.author,r=t.msgId,a=t.senderTimestampMs;return(function(e,t,n){var r=(0,s.l)(t,n),a=(0,s.l)(t,n,"deleted");return e.stores.reactions.where("idx").anyOf([r,a]).limit(1).first()})(e,r,n).then(n=>n&&(0,d.b)(n.senderTimestampMs,a)?n:(n?(function(e,t){return e.stores.reactions.delete(t).then(()=>{})})(e,n.id):(0,p.e)()).then(()=>A(e,t)))}function T(e,t){return(0,p.c)([O(e,t),e.getMsgFromId(t),e.stores.reactions.where("idx").equals((0,s.l)(t,i.a,"deleted")).first()]).then(t=>{var n=a()(t,3),r=n[0],s=n[1],o=n[2];if(!s)throw new Error("refreshDbMsgReactionInfoInTransaction msg not found");var u=(function(e,t){if(0!==e.length){var n={count:e.length,reactions:(function(e){for(var t=[],n=Math.min(e.length,3),r=0;r<n;r++){var a=e[r];t.push(a.label)}return t})(m(e))},r=t&&t.error?{id:t.id,code:t.error}:(function(e){var t=e.find(e=>e.author===i.a&&e.error);if(t&&t.error)return{id:t.id,code:t.error}})(e);return null!=r&&(n.error=r),n}})(r,o);return u?s.reactions=u:delete s.reactions,e.putCommonMsg(s)})}function A(e,t){var n=t.msgId,r=t.author,a=t.text,i=Object.assign({},t,{idx:(0,s.l)(n,r,null==a?"deleted":void 0)});return e.stores.reactions.add(i).then(e=>Object.assign({},i,{id:e}))}function O(e,t){return e.stores.reactions.where("idx").between((0,s.i)(t),(0,s.q)(t)).toArray().then(e=>e)}},,,function(e,t,n){n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return i}));var r=n(4);function a(e){return(0,r.v)("key",null,(0,r.v)("id",null,(0,r.a)(e.id,3)),(0,r.v)("value",null,e.keyPair.publicKey))}function i(e){return(0,r.v)("skey",null,(0,r.v)("id",null,(0,r.a)(e.id,3)),(0,r.v)("value",null,e.keyPair.publicKey),(0,r.v)("signature",null,e.signature))}},function(e,t,n){n.d(t,"b",(function(){return O})),n.d(t,"c",(function(){return M})),n.d(t,"a",(function(){return N}));var r=n(27),a=n.n(r),i=n(9),s=n.n(i),o=n(28),u=n(109),d=n(4),c=n(46),l=n(15),p=n(6),h=n(12),f=n(10),m=n(83),v=n(21),g=n(122),_=n(23),E=n(14),b={all:"all",contacts:"contacts",none:"none",error:"error"},y={all:"all",none:"none",error:"error"},S={all:"all",contacts:"contacts",contact_blacklist:"contact_blacklist",none:"none",error:"error"};function I(e,t){var n=t.maybeChild("error"),r=n&&n.maybeAttrString("code"),a=n&&n.maybeAttrString("text");__LOG__(4)`getPrivacy error: ${e} code ${r} text ${a}`,SEND_LOGS("get-privacy")}var w=(0,f.w)(l.n).reduce((e,t)=>(e[l.n[t]]=l.n[t],e),{}),T=new c.a("getPrivacyParser",e=>{var t=e.child("privacy"),n={};return t.forEachChildWithTag("category",e=>{var t=e.attrEnumOrNullIfUnknown("name",w);if(t)switch(t){case"readreceipts":var r=e.attrEnum("value",y);"error"!==r?n.readReceipts=r:I("readreceipts",e);break;case"last":var a=e.attrEnum("value",b);"error"!==a?n.lastSeen=a:I("last",e);break;case"profile":var i=e.attrEnum("value",b);"error"!==i?n.profilePhoto=i:I("profile",e);break;case"status":var s=e.attrEnum("value",b);"error"!==s?n.about=s:I("status",e);break;default:var o=e.attrEnum("value",S);"error"!==o?n.groupAdd=o:I("groupadd",e)}else __LOG__(3)`getPrivacyParser unrecognized privacy category ${e.maybeAttrString("name")}`}),n}),A=new c.a("getPrivacyParser",e=>e.child("disappearing_mode").attrInt("duration"));function O(e){var t=e?o.e:o.h,n=t((0,d.v)("iq",{to:d.k,type:"get",id:(0,d.t)(),xmlns:"privacy"},(0,d.v)("privacy",null)),T),r={success:!0,result:E.i};return(0,_.a)("disappearing_mode")&&(r=t((0,d.v)("iq",{to:d.k,type:"get",id:(0,d.t)(),xmlns:"disappearing_mode"}),A)),Promise.all([n,r]).then(t=>{var n=s()(t,2),r=n[0],a=n[1];if(!r.success||!a.success)return{status:"network_error"};var i=r.result;p.j.update(Object.assign({},i,{disappearingMsgsDefaultTimer:a.result}));var o=p.j.get();return(0,h.c)("page","generalSettings",{settings:o}),"contact_blacklist"===o.groupAdd&&null==o.groupAddBlacklistHash?N(e).then(e=>e.error?{status:"network_error"}:{status:"ok"}):{status:"ok"}}).catch((0,g.a)(u.a,()=>(__LOG__(2)`getPrivacySettings disconnected error`,{status:"network_error"})))}function M(){return O(!0)}var C={400:(0,m.d)("bad-request"),404:(0,m.d)("empty-blocklist"),501:(0,m.d)("feature-unavailable"),503:(0,m.d)("service-unavailable"),500:(0,m.d)("unknown")},R=new c.a("getPrivacyParser",e=>{var t=e.child("privacy").maybeChild("list");return null==t?{status:"match"}:{status:"mismatch",listHash:t.attrString("dhash"),users:(0,v.m)(t.mapChildren(e=>e.attrPhoneUserJid("jid")))}});function N(e){var t=p.j.get(),n=t.groupAddBlacklistHash;return(e?o.e:o.h)((0,d.v)("iq",{to:d.k,type:"get",id:(0,d.t)(),xmlns:"privacy"},(0,d.v)("privacy",null,(0,d.v)("list",{name:(0,d.b)("groupadd"),value:(0,d.b)("contact_blacklist"),dhash:n?(0,d.b)(n):(0,d.b)("none")}))),R).then((function(){var e=a()((function*(e){if(!e.success)return(0,m.f)(e,C);var n=e.result;return"match"===n.status?{contactsBlacklist:t.groupAddBlacklist||(0,v.f)()}:(yield p.j.update({groupAddBlacklistHash:n.listHash,groupAddBlacklist:n.users}),(0,h.c)("page","generalSettings",{settings:p.j.get()}),{contactsBlacklist:n.users})}));return function(t){return e.apply(this,arguments)}})()).catch((0,g.a)(u.a,()=>(__LOG__(2)`getContactsBlacklist disconnected error`,(0,m.d)("network-error"))))}},function(e,t,n){n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return p}));var r=n(25),a=n(11),i=n(106),s=n(116),o=n(137),u=n(3),d=n(4),c=n(72),l=class extends Error{constructor(e,t){super(`XmppParsingFailure: ${e}: ${t}`),this.name="XmppParsingFailure",this.parser=e,this.reason=t}},p=class extends class{constructor(e,t){this.EF=e,this.EG=t,this.EH=Array.isArray(t.content)?t.content.map(t=>new this.constructor(e,t)):null}name(){return this.EF}node(){return this.EG}hasAttr(e){return(0,s.a)(this.EG.attrs,e)}assertTag(e){this.EG.tag!==e&&this.throw(`to be <${e}>`)}tag(){return this.EG.tag}maybeChild(e){var t=this.EH;if(!t)return null;for(var n=0;n<t.length;n++)if(t[n].tag()===e)return t[n];return null}hasChild(e){return!!this.maybeChild(e)}child(e){return this.maybeChild(e)||this.throw(`to have child <${e}>`)}assertAttr(e,t){var n=this.attrString(e);n!==t&&this.throw(`to have "${e}"="${t}", but instead has "${n}"`)}attrString(e){return(0,s.a)(this.EG.attrs,e)?this.decodeAsString(this.EG.attrs[e]):this.throw(`to have attribute "${e}"`)}forEachAttributeKey(e){var t=this.EG.attrs;Object.keys(t).forEach(t=>e(t))}maybeAttrString(e){return this.hasAttr(e)?this.decodeAsString(this.EG.attrs[e]):null}maybeAttrInt(e,t,n){return this.hasAttr(e)?this.attrInt(e,t,n):null}attrEnumValues(e,t,n){var r=new Set(t),a=this.attrString(e);if(!r.has(a)){if(null!=n)return n;var i=Array.from(r).join("|");return this.throw(`to have "${e}"={${i}} but has value "${a}"`)}return a}attrEnum(e,t){var n=this.attrString(e);if(!(0,s.a)(t,n)){var r=Object.keys(t).join("|");return this.throw(`to have "${e}"={${r}} but has value "${n}"`)}return t[n]}attrEnumOrNullIfUnknown(e,t){var n=this.attrString(e);return(0,s.a)(t,n)?t[n]:null}attrEnumOrDefault(e,t,n){return this.hasAttr(e)?this.attrEnum(e,t):n}attrInt(e,t,n){var r=this.attrString(e);return this.EI(r,e,t,n)}EI(e,t,n,r){var a=parseInt(e,10);return Number.isNaN(a)?this.throw(`to have "${t}"={integer} but has value "${e}"`):void 0!==n&&a<n?this.throw(`to have "${t}"={at least ${n}} but has value ${a}`):void 0!==r&&a>=r?this.throw(`to have "${t}"={below ${r}} but has value ${a}`):a}forEachChild(e){var t=this.EH;if(t)t.forEach(t=>e(t));else if(null!=this.EG.content)return this.throw("to have children")}forEachChildWithTag(e,t){this.forEachChild(n=>{n.tag()===e&&t(n)})}mapChildren(e){var t=this.EH;return t||null==this.EG.content?t?t.map(t=>e(t)):[]:this.throw("to have children")}mapChildrenWithTag(e,t){var n=this.EH;return n||null==this.EG.content?n?n.filter(t=>t.tag()===e).map(e=>t(e)):[]:this.throw("to have children")}mapFirstChild(e){var t=this.EH;return t&&0!==t.length?e(t[0]):this.throw("to have children")}hasContent(){return!this.EH&&!!this.EG.content}hasChildren(){return null!=this.EH}getChildren(){return this.EH}getNode(){return this.EG}unsafeSetChildren(e){this.EH=e}unsafeSetNodeContent(e){this.EG.content=e}contentUint(e){return(function(e,t){for(var n=0,r=0;r<t;r++)n=256*n+e[r];return n})(this.contentBytes(e),e)}contentBytes(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;if(this.EH)return this.throw("to have binary content, but has children instead");if(null!=this.EG.content){var t=this.EG.content;return-1!==e&&t.length!==e?this.throw(`to be ${e} bytes, but got ${t.length} instead`):t}return this.throw("to have content")}contentString(){return this.EH?this.throw("to have string content, but has children instead"):null!=this.EG.content?this.EG.content:this.throw("to have content")}contentInt(e,t){var n=this.contentString();return this.EI(n,"content",e,t)}contentEnum(e){var t=this.contentString();if(!(0,s.a)(e,t)){var n=Object.keys(e).join("|");return this.throw(`to have content {${n}} but has value "${t}"`)}return e[t]}decodeAsString(e){if("string"!=typeof e)throw new Error(`decodeAsString: attribute is ${typeof e} not a string: ${e}`);return e}throw(e){throw new class{constructor(e,t){this.parser=e,this.reason=t}toString(){return`XmlParsingFailure: ${this.parser}: ${this.reason}`}}(this.EF,`expected <${this.EG.tag}> ${e}`)}toString(){return this.EG.toString()}}{constructor(e,t){super(e,t)}assertFromServer(){var e=this.attrString("from");e!==a.i&&this.throw(`to have "from"="s.whatsapp.net", but instead has "${e}"`)}attrUserJid(e){var t=this.attrString(e),n=(0,a.A)(t);return null==n.userJid?this.throw(`to have "${e}"={UserJid}, but instead has "${t}"`):n.userJid}attrPhoneUserJid(e){var t=this.attrString(e),n=(0,a.A)(t);return"phoneUser"===n.jidType?n.userJid:this.throw(`to have "${e}"={PhoneUserJid}, but instead has "${t}"`)}maybeAttrUserJid(e){return this.hasAttr(e)?this.attrUserJid(e):null}maybeAttrPhoneUserJid(e){return this.hasAttr(e)?this.attrPhoneUserJid(e):null}attrGroupJid(e){var t=this.attrString(e),n=(0,a.A)(t);return null==n.groupJid?this.throw(`to have "${e}"={GroupJid}, but instead has "${t}"`):n.groupJid}maybeAttrGroupJid(e){return this.hasAttr(e)?this.attrGroupJid(e):null}attrChatJid(e){var t=this.attrString(e),n=(0,a.A)(t);return null!=n.userJid?n.userJid:null!=n.groupJid?n.groupJid:this.throw(`to have "${e}"={ChatJid}, but instead has "${t}"`)}attrPhoneChatJid(e){var t=this.attrString(e),n=(0,a.A)(t);return"phoneUser"===n.jidType?n.userJid:"group"===n.jidType?n.groupJid:this.throw(`to have "${e}"={ChatJid}, but instead has "${t}"`)}attrDeviceJid(e){var t=this.attrString(e),n=(0,a.A)(t);return null!=n.deviceJid?n.deviceJid:null!=n.userJid?(0,a.p)(n.userJid):this.throw(`to have "${e}"={DeviceJid}, but instead has "${t}"`)}attrPhoneDeviceJid(e){var t=this.attrString(e),n=(0,a.A)(t);return"phoneDevice"===n.jidType?n.deviceJid:"phoneUser"===n.jidType?(0,a.r)(n.userJid):this.throw(`to have "${e}"={DeviceJid}, but instead has "${t}"`)}attrDeviceId(e){var t=this.attrInt(e);return(0,a.B)(t)}attrFromJidChat(){var e=this.attrJidWithType();switch(e.jidType){case"msgrUser":var t=e.userJid,n=(0,a.p)(t);return{type:"device",chat:t,deviceJid:n,author:n};case"phoneUser":var r=e.userJid,i=(0,a.p)(r);return{type:"device",chat:r,deviceJid:i,author:i};case"lidUser":var s=e.userJid,o=(0,a.q)(s);return{type:"device",chat:s,deviceJid:o,author:o};case"phoneDevice":var u=e.deviceJid;return{type:"device",chat:(0,a.w)(u),deviceJid:u,author:u};case"msgrDevice":var d=e.deviceJid;return{type:"device",chat:(0,a.w)(d),deviceJid:d,author:d};case"lidDevice":var c=e.deviceJid;return{type:"device",chat:(0,a.w)(c),deviceJid:c,author:c};case"group":var l=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return null==l?this.throw("expected to have participant JID for group"):{type:"group",chat:e.groupJid,groupJid:e.groupJid,author:l};case"broadcast":var p=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return null==p?this.throw("expected to have participant JID for group"):{type:"broadcast",broadcastJid:e.broadcastJid,chat:(0,a.w)(p),author:p};case"call":throw __LOG__(4)`ParsableWapNode: attrFromJid() is called with ${e.callJid}`,new Error("ParsableWapNode: attrFromJid() does not support CallJid");default:return e.jidType,this.throw("attrFromJidChat should not be used with a status jid")}}attrFromJidPhoneChat(){var e=this.attrJidWithType();switch(e.jidType){case"phoneUser":var t=e.userJid,n=(0,a.r)(t);return{type:"device",chat:t,deviceJid:n,author:n};case"phoneDevice":var r=e.deviceJid;return{type:"device",chat:(0,a.u)(r),deviceJid:r,author:r};case"group":var i=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return null==i?this.throw("expected to have participant JID for group"):{type:"group",chat:e.groupJid,groupJid:e.groupJid,author:i};case"broadcast":var s=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return null==s?this.throw("expected to have participant JID for group"):{type:"broadcast",broadcastJid:e.broadcastJid,chat:(0,a.u)(s),author:s};case"call":throw __LOG__(4)`ParsableWapNode: attrFromJid() is called with ${e.callJid}`,new Error("ParsableWapNode: attrFromJid() does not support CallJid");default:return e.jidType,this.throw("attrFromJidChat should not be used with jid of type "+e.jidType)}}attrFromPhoneJid(){if("status"===this.attrJidWithType().jidType){var e=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return null==e?this.throw("to have participant for status msg"):{type:"status",author:e}}return this.attrFromJidPhoneChat()}attrFromJid(){if("status"===this.attrJidWithType().jidType){var e=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return null==e?this.throw("to have participant for status msg"):{type:"status",author:e}}return this.attrFromJidChat()}attrJidWithType(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"from",t=this.attrString(e),n=(0,a.A)(t);return"unknown"===n.jidType?this.throw(`to have "${e}"={Jid}, but instead has "${t}"`):n}attrWapJid(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"from",t=this.attrString(e),n=(0,a.A)(t);return"unknown"===n.jidType?c.c.create(null,t):(0,d.g)((0,a.t)(n))}attrLongInt(e){var t=this.attrString(e);return(0,i.a)(t)}attrTime(e){return(0,u.j)(this.attrInt(e))}attrFutureTime(e){var t=this.attrInt(e);return(0,u.l)(t)}contentString(){if(this.hasChildren())return this.throw("to have string content, but has children instead");if(this.hasContent()){var e=new r.a(this.contentBytes());return e.readString(e.size())}return this.throw("to have content")}decodeAsString(e){return(0,d.o)(e)}contentSerializedPubKey(){return this.hasContent()?(0,o.e)(this.contentBytes()):this.throw("to have content")}parseError(e){return new l(this.name(),`expected <${this.tag()}> ${e}`)}throw(e){throw this.parseError(e)}}},,,function(e,t,n){n.r(t),n.d(t,"default",(function(){return y})),n.d(t,"deregisterPhoneBanAppeal",(function(){return S})),n.d(t,"deregisterPhone",(function(){return I})),n.d(t,"deregister",(function(){return w})),n.d(t,"deleteTmpTables",(function(){return T}));var r=n(88),a=(n(4),n(6)),i=n(125),s=n(5),o=n(14),u=n(190),d=n(29),c=n(113),l=n(289),p=n(91),h=n(12),f=n(74),m=n(170),v=n(3),g=n(245),_=n(194),E=(n(121),{100:"100",101:"101",102:"102",103:"103",104:"104",106:"106"}),b=new r.b("failureParser",e=>(e.assertTag("failure"),{reason:e.attrInt("reason",400,599),location:e.attrString("location"),code:e.hasAttr("code")?e.attrEnumOrDefault("code",E,"100"):null,expire:e.hasAttr("expire")?e.attrInt("expire"):null,violationType:e.hasAttr("vt")?_.c[e.attrString("vt")]||"other_harm":null}));function y(e){var t=b.parse(e);if(t.error)__LOG__(4)`handleFailure: failed to parse ${t.error}`;else switch(t.success.reason){case 401:I("deregistered");break;case 402:var n=t.success,r=n.code,i=n.expire;if(null==r||null==i)throw __LOG__(4)`Got incorrect temp banned data ${r} ${i}`,new Error("handleFailure: wrong temp ban data");(function(e,t){a.I.set({code:e,duration:t,until:(0,v.l)(t)}).then(()=>(0,h.c)("page","reload",{}))})(r,i);break;case 403:null!=t.success.violationType?S(t.success.violationType):I("deregistered");break;case 406:I("banned");break;case 405:case 409:(0,h.c)("event","kicked",{reason:"needs_update"});break;case 400:case 500:case 501:__LOG__(3)`handleFailure: got failure code ${t.success.reason}`;break;default:__LOG__(4)`handleFailure: got unknown failure code ${t.success.reason}`}}function S(e){return a.r.isDefined()?T().then(()=>w()).then(t=>{if("noop"!==t){var n=a.r.get(),r=(0,g.b)(n);if(r){var i=r.country,s=r.localNumber;return a.B.setWithin(t,{type:"BLOCKED_BAN_APPEAL_PRE",country:i,localNumber:s,banReason:e})}__LOG__(4)`deregisterPhoneBanAppeal phone is invalid`}}).then(()=>{(0,h.c)("page","reload",{})}):Promise.resolve()}function I(e){return a.r.isDefined()?T().then(()=>w(e)).then(()=>{(0,h.c)("page","reload",{})}):Promise.resolve()}function w(e){return a.r.isDefined()?Promise.all([(0,d.E)(),(0,a.U)()]).then(()=>(0,u.e)()).then(t=>e?a.A.setWithin(t,e).then(()=>t):t):Promise.resolve("noop")}function T(){return Promise.all([(0,s.i)(i.a.delete(o.n)),(0,f.nukeProfilePicTable)(),(0,c.nukeLogs)(),(0,l.c)(),(0,m.d)(),(0,p.jobsTable)().stores.delete(),null]).then(()=>{})}},,,function(e,t,n){n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return v})),n.d(t,"c",(function(){return g})),n.d(t,"d",(function(){return y}));var r=n(2),a=n(6),i=n(3),s=n(7),o=n(12),u=n(97),d=n(30),c=n(16),l=n(31),p=n.n(l),h=n(23),f=n(14);function m(e,t,n){var r=n.groupInfo.expiration;if(null==r||!_(t))return null;var a=t.expiration||f.i;if(!e&&E(r,a)||(a=r),a>f.i){var s=(0,i.l)(a,e?(0,i.E)():t.ts);return y(s),{expiration:a,validUntil:s}}return null}function v(e,t,n,r){var a=null==n?void 0:n.ephemeral;if(null==a||!_(t))return null;var s,o=t.expiration;if(e?(o=a.expiration,s=a.ts):r&&(o=r),null!=o&&o>f.i){var u=(0,i.l)(o,e?(0,i.E)():t.ts),d={expiration:o,validUntil:u};if(y(u),null!=s&&(d.ephemeralSettingTimestamp=s),(0,h.a)("disappearing_mode")){var c=a.initiator;null!=c&&(d.disappearingModeInitiator=c)}return d}return null}function g(e,t,n,o,l){var p,h,m,v,g,y=e||t||{jid:n},I=null==y?void 0:y.ephemeral,w=null==I?void 0:I.expiration,T=null==I?void 0:I.ts,A=null==I?void 0:I.initiator;if(l.type!==r.f.EPHEMERAL||"setting"!==l.subtype&&"sync_response"!==l.subtype){if(o||null==l.expiration||null==l.ephemeralSettingTimestamp||!_(l))return{contact:y};if(p=l.expiration,h=l.ephemeralSettingTimestamp,m=l.disappearingModeInitiator,p>f.i&&(0,i.l)(p,l.ts)<=(0,i.E)())return __LOG__(2)`maybeUpdateEphemeralSetting dropping expired message`,{dropMsg:!0};if(w&&!E(w,p))__LOG__(2)`maybeUpdateEphemeralSetting restoring expiry from ${l.expiration}s to ${w}s`,p=w;else if(w===p&&T===h&&(null==A&&null==m||A===m))return{contact:y}}else{if(p=l.ephemeralExpiration,v=w,(g=l.ephemeralExpiration)<f.i||g!==v&&g>f.i&&!S(g)&&(__LOG__(2)`maybeUpdateEphemeralSetting ${g}s isn't allowed`,1))return{dropMsg:!0};"setting"===l.subtype?(h=l.ts,m=u.a.CHANGED_IN_CHAT):(l.subtype,h=l.ephemeralSettingTimestamp,m=l.ephemeralInitiator)}if(!o&&(h>l.ts||(0,i.z)(h)>15))return __LOG__(2)`maybeUpdateEphemeralSetting ignoring incoming msg from future`,{dropMsg:!0};var O=null!=l.deviceId?(0,s.A)(n,l.deviceId):(0,s.e)(n),M=(null==I?void 0:I.deviceJid)||(0,s.e)(a.r.get());if(o||null==w||null==T||h>T||l.type===r.f.EPHEMERAL&&w!==p&&T===h&&O<=M||null==A&&null!=m){var C;__LOG__(2)`maybeUpdateEphemeralSetting client is out-of-sync`;var R=p!==w,N=R?l.ts:null==I?void 0:I.notificationTs,k=Object.assign({},y,{ephemeral:{expiration:p,ts:h,notificationTs:N,deviceJid:o?void 0:O,syncResponse:void 0,initiator:null!=(C=m)?C:A}});return l.type===r.f.EPHEMERAL?R?{contact:k}:{dropMsg:!0,contact:k}:{contact:k,changedByMsg:R}}__LOG__(2)`maybeUpdateEphemeralSetting remote client is out-of-sync`;var P=y;if((l.type!==r.f.EPHEMERAL||"sync_response"!==l.subtype)&&null!=w&&null!=T){var G=(function(e){var t=(null==e?void 0:e.attempt)||0,n=null==e?void 0:e.ts,r=(0,i.E)();return null==n||t<3&&!(0,i.o)(n,r,b.get(t)||0)?{sync:!0,attempt:t+1,ts:r}:{sync:!1}})(null==I?void 0:I.syncResponse);if(G.sync){__LOG__(2)`maybeUpdateEphemeralSetting sending EPHEMERAL_SYNC_RESPONSE`,(0,d.b)().fireAndForget(c.e.sendEphemeralSyncResponse(n,w,T,A));var L=G.attempt,D=G.ts,x=Object.assign({},I,{expiration:w,ts:T,initiator:A,syncResponse:{attempt:L,ts:D}});P=Object.assign({},y,{ephemeral:x})}else __LOG__(2)`maybeUpdateEphemeralSetting backed off sending EPHEMERAL_SYNC_RESPONSE`}return l.type===r.f.EPHEMERAL?{dropMsg:!0,contact:P}:{overrideExpiration:p,contact:P}}function _(e){switch(e.type){case r.f.CIPHERTEXT:case r.f.IDENTITY_CHANGE:case r.f.PRIVACY_CHANGE:case r.f.MD_PLACEHOLDER:case r.f.FUTUREPROOF:case r.f.GROUP_NOTIFICATION:case r.f.BUSINESS_NOTIFICATION:case r.f.EPHEMERAL:case r.f.CONTACT_BLOCK_CHANGE:return!1;case r.f.TEXT:case r.f.VCARD:case r.f.IMAGE:case r.f.STICKER:case r.f.PTT:case r.f.AUDIO:case r.f.VIDEO:case r.f.GIF:case r.f.RICH_HSM:case r.f.LOCATION:case r.f.EXTENDED_TEXT:case r.f.GROUP_INVITE:case r.f.DOCUMENT:case r.f.HSM_BUTTON_REPLY:case r.f.REVOKED:return!0;default:return(0,p.a)(e.type),!0}}function E(e,t){return e===f.i?t===f.i:e>f.i&&(t===e||S(t))}var b=new Map([[0,0],[1,180],[2,900]]);function y(e){(0,o.d)()?(0,o.c)("event","uiEphemeralTimestamp",{validUntil:e}):(0,o.c)("backend","ephemeralTimestamp",{validUntil:e})}function S(e){return!!a.E.get().ephemeralMessagesAllowedValues.has(e)}},,function(e,t,n){n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return f})),n.d(t,"c",(function(){return _}));var r=n(27),a=n.n(r),i=n(131),s=n(25),o=n(43),u=n(35),d=n(3),c=n(14);function l(e){return 16*parseInt((e+15)/16,10)}var p=n(120);function h(e,t){return m(1,e.scanLengths,e.scansSidecar,t)}function f(e,t){var n=e.scanLengths,r=e.scansSidecar,a=e.midQualityFileSha256;if(a){if(n.length===c.H){var i=m(3,n,r,t);return{downloadSize:i.downloadSize,partialFetchOptions:i.partialFetchOptions,expectedPlaintextHash:(0,o.e)(a)}}__LOG__(2)`downloadMms skipping progressive details as those have incorrect scan number`}else __LOG__(3)`downloadMms skipping progressive details as we are missing midQuality hash`}function m(e,t,n,r){for(var a=(function(e,t){for(var n=[],r=0,a=0,i=0,s=0;s<e.length;++s){if(r+=e[s],s===e.length-1&&null!=t){r>a?n.push(t-a):(n.pop(),n.push(t-i));break}if(r>a){var o=l(r-a);i=a,n.push(o),a+=o}}return n})(t,r),i=0,s=[],o=0;o<e;o++)i+=a[o],s.push(new Uint8Array(n,o*c.m,c.m));return{downloadSize:i,partialFetchOptions:{scans:e,scanLengths:t,alignedChunkLengths:a,chunkHmacs:s}}}function v(){return(v=a()((function*(e,t){var n,r;try{n=yield(0,u.j)(e,{responseType:"text",maxSize:t,keepPartial:!0,overrideMimeType:"text/plain; charset=x-user-defined"})}catch(e){return __LOG__(2)`fetchPartialPayload network error ${e}`,{type:"network-error"}}try{var a=n.response,i=new Uint8Array(a.length);i.set(Array.from(a).map(e=>e.codePointAt(0))),r=new s.a(i.buffer).readBuffer(t)}catch(e){return __LOG__(2)`fetchPartialPayload network error on body ${e}`,{type:"body-network-error"}}return{type:"ok",payload:r}}))).apply(this,arguments)}function g(){return(g=a()((function*(e,t,n){for(var r=new s.a,a=0,u=t.iv,d=0,c=0;c<n.scans;c++){var l=n.alignedChunkLengths[c],h=a+l,f=e.slice(a,h),m=new Uint8Array(f.slice(l-i.a,l)),v=yield(0,i.d)(t.cipherKey,m,t.hmacKey,"no-sidecar",new Blob([2,2])),g=new s.a(f);g.writeByteArray(v.ciphertext.slice(0,i.a));var _=g.readByteArray(),E=(yield(0,i.e)(t.cipherKey,u,_,t.hmacKey,n.chunkHmacs[c],i.a,2)).plaintext;r.writeBuffer(E),a+=l,u=m,d+=n.scanLengths[c]}var b=r.readBuffer(d);return(0,p.a)(b).then(e=>({plaintext:b,plaintextHash:(0,o.e)(new Uint8Array(e)),downloadedScans:c}))}))).apply(this,arguments)}function _(e,t,n){return(r,a)=>{var i=(0,d.u)();return(function(e,t){return v.apply(this,arguments)})(r,n).then(n=>{var r=(0,d.v)(i);if("ok"!==n.type)return{status:n,networkTime:r};var u=n.payload;return __LOG__(2)`simpleFetch received data, payload.byteLength = ${u.byteLength}`,{status:{type:"done",finalize:()=>{var n=(0,d.u)();return(function(e,t,n){return g.apply(this,arguments)})(new Uint8Array(u),e,t).then(e=>{var t=e.plaintext,r=e.plaintextHash,i=e.downloadedScans,u=(function(e){var t=new s.a(e);return t.writeBytes(255,217),t.readByteArray()})(t);return a(u),(0,p.a)(u).then(e=>({plaintextHash:r,decryptionTime:(0,d.v)(n),progressiveDownload:{partialSize:u.byteLength,partialPlaintextHash:(0,o.e)(e),progressiveJpegScanNumber:i}}))})}},networkTime:r}})}}},,,,,,,,function(e,t,n){n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return p}));var r=n(152),a=n(6),i=n(61),s=null,o=new i.a;function u(){return s||(__LOG__(2)`TelephonyService::startTelephonyService`,s=(0,r.a)("telephony",{onConnect:l,onDisconnect:c})),o.promise}function d(){u()}function c(){o=new i.a}function l(e){return a.n.get()?"undefined"==typeof lib_telephony||null==lib_telephony.TelephonyService?(__LOG__(4)`TelephonyService::onSessionConnected cannot find lib_telephony.TelephonyService`,SEND_LOGS("daemon-telephony-service-not-found"),void o.resolve()):void lib_telephony.TelephonyService.get(e).then(e=>{__LOG__(2)`Got TelephonyService : #${e.service_id}`,o.resolve(e)}):(__LOG__(2)`TelephonyService::onSessionConnected: VOIP service is not available`,void o.resolve())}function p(){return __LOG__(2)`TelephonyService::getCallState called`,(0,r.c)(u,"TelephonyService","getCallState",e=>e?(__LOG__(2)`TelephonyService::getCallState calling telephony.callState`,e.callState.then(t=>(__LOG__(2)`TelephonyService::getCallState result ${JSON.stringify(t)}`,t===e.CALLSTATE_IDLE?"idle":"busy"),e=>(__LOG__(4)`TelephonyService::getCallState ${e}`,"unknown"))):"unknown",0)}},function(e,t,n){n.d(t,"d",(function(){return v})),n.d(t,"c",(function(){return _})),n.d(t,"b",(function(){return I})),n.d(t,"a",(function(){return M})),n.d(t,"e",(function(){return C}));var r=n(27),a=n.n(r),i=n(2),s=n(12),o=n(89),u=n(17),d=n(94),c=n(80),l=n(105),p=n(45),h=n(14),f=n(6),m=n(23);function v(e,t,n){return g.apply(this,arguments)}function g(){return(g=a()((function*(e,t,n){var r=yield(0,u.v)(e);if(!r)return __LOG__(2)`processPlaintextMedia message ${e} deleted while in finalization queue`,{type:"error",error:"gone"};var a=r.msg,i=r.media,s=i.mediaId,o=(null==r?void 0:r.fromEphemeralChat)||!1,d=yield S(a,i,t,o);if("ok"===d.type){var c=d.plaintext;return yield(0,u.Ac)(s,d.plaintext,n),{type:"ok",plaintext:c}}return d.type,{type:"error",error:d.error}}))).apply(this,arguments)}function _(e,t){return E.apply(this,arguments)}function E(){return(E=a()((function*(e,t){var n=yield(0,u.v)(e);if(!n)return __LOG__(2)`processConvertedMedia message ${e} deleted while in finalization queue`,{status:"fail"};var r=n.media,a=r.mediaId,i=yield(0,l.getChunkTable)().storeStickerFrame(a,t);return yield(0,u.Fc)(r.mediaId,{frame:i}),__LOG__(2)`WEBP: new media URI ${i} for AlphaJpeg with msgId: ${e} was saved`,{status:"ok"}}))).apply(this,arguments)}function b(e,t){var n=(0,p.e)(e);if(!n)return __LOG__(2)`Moving media from db and into storage`,!0;var r=(0,c.j)(n);return r?(0,c.l)(r,t):(__LOG__(2)`Do not move files from outside whatsapp folder`,!1)}function y(e,t){var n=e.author===i.b;return void 0===e.chat?{isStatus:!0,outgoing:n}:n?{outgoing:!0}:e.type===i.e.DOCUMENT&&e.isVCard||null!=e.viewOnceState||t&&(0,m.a)("ephemeral_media_private")?{outgoing:!1,showInGallery:!1}:{outgoing:!1,showInGallery:f.j.get().saveMediaToPhoneStorage}}function S(e,t,n,r){return O(e.type)?(function(e,t,n,r){return T.apply(this,arguments)})(e,t,n,r):(function(e,t){return A.apply(this,arguments)})(t.mediaId,n)}function I(e,t,n,r,a){return w.apply(this,arguments)}function w(){return(w=a()((function*(e,t,n,r,a){if((0,o.c)("maybeMoveMediaInStorage"),!O(e.type))return{type:"ok",plaintext:n};var i=y(e,a);if(!b(n,i))return __LOG__(2)`maybeMoveMediaInStorage: No need to move media file for ${e.id}`,{type:"ok",plaintext:n};var l=r;if(l||(l=yield(0,d.d)(n)),!l)return __LOG__(3)`maybeMoveMediaInStorage: source blob not found`,{type:"error",error:"gone"};__LOG__(2)`maybeMoveMediaInStorage: moving media file for ${t}`;var p=(0,d.g)(e)||h.D,f=(0,c.h)(p,i),m=(yield(0,s.e)("page","craftMediaFilesystemPath",{path:f})).path,v=yield(0,u.zc)(t,m);if(!v)return __LOG__(3)`moveMediaInStorage failed to craft media ${t} filename`,{type:"error",error:"unknown"};yield(0,s.e)("page","deletePath",{path:v});var g=yield(0,s.e)("page","putBlobToPhoneStorage",{path:v,blob:l});if("ok"===g.result){yield(0,d.b)(n);var _=g.path;return yield(0,u.Yc)(t,_),__LOG__(2)`moveMediaInStorage successfully put media ${t} content to phone storage at ${_}`,{type:"ok",plaintext:_}}return"storage-gone"===g.result?(__LOG__(3)`maybeMoveMediaInStorage: destination storage not found`,{type:"error",error:"gone"}):(g.result,__LOG__(2)`moveMediaInStorage not enough space to save media`,{type:"error",error:"not-enough-space"})}))).apply(this,arguments)}function T(){return(T=a()((function*(e,t,n,r){(0,o.c)("placeMediaInStorage");var a=t.plaintext;if(a)return I(e,t.mediaId,a,n,r);var i=(0,d.g)(e)||h.D,l=y(e,r),p=(0,c.h)(i,l),f=(yield(0,s.e)("page","craftMediaFilesystemPath",{path:p})).path,m=yield(0,u.zc)(t.mediaId,f);if(!m)return __LOG__(3)`placeMediaInStorage failed to craft media ${t.mediaId} filename`,{type:"error",error:"unknown"};yield(0,s.e)("page","deletePath",{path:m});var v=yield(0,s.e)("page","putBlobToPhoneStorage",{path:m,blob:n});return"ok"===v.result?(__LOG__(2)`placeMediaInStorage successfully put media ${t.mediaId} content to phone storage at ${m}`,{type:"ok",plaintext:v.path}):"storage-gone"===v.result?(__LOG__(3)`placeMediaInStorage: destination storage not found`,{type:"error",error:"gone"}):(v.result,__LOG__(2)`placeMediaInStorage not enough space to save media`,{type:"error",error:"not-enough-space"})}))).apply(this,arguments)}function A(){return(A=a()((function*(e,t){var n=yield(0,l.getChunkTable)().storeFullContent(e,t);return __LOG__(2)`placeMediaInDb successfully put media ${e} content to database`,{type:"ok",plaintext:n}}))).apply(this,arguments)}function O(e){return e!==i.e.PTT}function M(e){return"video"===e.type&&void 0===e.modified||"audio"===e.type}function C(e,t){return R.apply(this,arguments)}function R(){return(R=a()((function*(e,t){__LOG__(2)`useMediaSource using source blob path as plaintext ref for media ${e.mediaId}`;var n=(0,p.f)(t);return n?e.plaintext?(__LOG__(2)`useMediaSource media already have plaintext`,{type:"ok",plaintext:e.plaintext}):(yield(0,u.Ac)(e.mediaId,n,"dont-save"),{type:"ok",plaintext:n}):{type:"error",error:"unknown"}}))).apply(this,arguments)}},function(e,t,n){function r(e){return n.e(47).then(n.bind(null,421)).then(t=>t.inflate(e))}function a(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return n.e(47).then(n.bind(null,421)).then(t=>t.createDeflate(e))}n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}))},,function(e,t,n){n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return u})),n(27);var r=n(25),a=n(227),i=class{constructor(e,t,n,r){this.aC=null,this.aE=!1,this.Zz=e,this.aA=t,this.aB=n;var a={name:"AES-CBC",iv:r};this.aD=self.crypto.subtle.importKey("raw",n,"AES-CBC",!1,[t]).then(e=>({algo:a,key:e}))}append(e){var t;this.aF("append");var n=this.aC;if(n)if(n.writeByteArray(e),n.size()>1024){var a=n.size()%16;t=n.readByteArray(n.size()-a),n.size()||(this.aC=null)}else t=null;else if(e.length>1024){var i=e.length%16;i?(this.aC=new r.a(e),t=this.aC.readByteArray(e.length-i)):t=e}else this.aC=new r.a(e),t=null;var s=t;return s&&(this.aD=this.aD.then(e=>{var t=e.key,n=e.algo;if("encrypt"===this.aA)return self.crypto.subtle.encrypt(n,t,s).then(e=>(this.Zz.writeByteArray(new Uint8Array(e,0,e.byteLength-16)),new Uint8Array(e,e.byteLength-32,16)));var r=s.slice(-16);return self.crypto.subtle.decrypt(n,t,s).then(e=>(this.Zz.writeBuffer(e),r))}).then(e=>{var t={name:"AES-CBC",iv:e};return self.crypto.subtle.importKey("raw",this.aB,"AES-CBC",!1,[this.aA]).then(e=>({algo:t,key:e}))})),this.aD.then(()=>{})}finalize(e){var t;if(this.aF("finalize"),this.aC?(e&&this.aC.writeByteArray(e),t=this.aC.readByteArray(),this.aC=null):e&&(t=e),t){var n=t;return this.aD.then(e=>{var t=e.algo,r=e.key;return"encrypt"===this.aA?self.crypto.subtle.encrypt(t,r,n):self.crypto.subtle.decrypt(t,r,n)}).then(e=>{this.Zz.writeBuffer(e)})}return this.aD.then(()=>{})}aF(e){if(this.aE)throw new Error(`AesCbcStream.${e} called after finalize`)}};function s(e){return{name:"AES-CBC",iv:(0,a.a)(Uint8Array,e)}}function o(e,t,n){var r=s(t);return Promise.resolve(self.crypto.subtle.importKey("raw",(0,a.a)(Uint8Array,e),"AES-CBC",!1,["decrypt"])).then(e=>self.crypto.subtle.decrypt(r,e,n))}function u(e,t,n){return Promise.resolve().then(()=>{var r,i=(function(e){if(e)return(0,a.a)(Uint8Array,e);var t=new Uint8Array(16);return self.crypto.getRandomValues(t),t})(n),o=s(i);return Promise.resolve((r=e,self.crypto.subtle.importKey("raw",(0,a.a)(Uint8Array,r),"AES-CBC",!1,["encrypt"]))).then(e=>self.crypto.subtle.encrypt(o,e,t)).then(e=>{return(t=Uint8Array,n=[i,new Uint8Array(e)],r=new t(n.reduce((e,t)=>e+t.length,0)),a=0,n.forEach(e=>{r.set(e,a),a+=e.length}),r).buffer;var t,n,r,a})})}},,,,,,,function(e,t,n){n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s}));var r=n(318),a=n(29);function i(){return a.a}var s=class extends r.a{constructor(e){super(a.a,e)}}},,,,,,,,,,,function(e,t,n){function r(e){if(0===e.length)throw new Error("buffers length is zero");if(1===e.length)return e[0];var t,n=e.map(e=>e.byteLength).reduce((e,t)=>e+t),r=new Uint8Array(n),a=0;for(t=0;t<e.length;t++)r.set(new Uint8Array(e[t]),a),a+=e[t].byteLength;return r.buffer}function a(e){return Array.from(new Uint8Array(e)).map(e=>e.toString(16)).toString().replace(/,/g," ")}function i(e){return Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("")}function s(e){var t=new ArrayBuffer(8);return new DataView(t).setUint32(4,e,!1),t}n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return i})),n.d(t,"d",(function(){return s})),n.d(t,"e",(function(){return u}));var o=new TextEncoder;function u(e){return o.encode(e)}},,,,,,function(e,t,n){n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return l})),n.d(t,"a",(function(){return p}));var r=n(43),a=n(62),i=n(37),s=n(11),o=n(168),u=n(86),d=n(23);function c(e,t,n){return l([e],t,n).then(e=>e[0].msg)}function l(e,t,n){var r=p(t,n);return(0,o.c)(e,r)}function p(e,t){var n=(null==t?void 0:t.mediaEntry)||void 0,d=(null==t?void 0:t.preview)||void 0,c=e.forwardingScore||0,l=c>0?{isForwarded:!0,forwardingScore:c}:void 0;switch(e.type){case i.c.TEXT:var p=e.linkPreview;return{extendedTextMessage:{text:e.text,contextInfo:l,font:e.font,backgroundArgb:e.backgroundColor,jpegThumbnail:d,matchedText:null==p?void 0:p.matchedText,canonicalUrl:null==p?void 0:p.canonicalUrl,description:null==p?void 0:p.description,title:null==p?void 0:p.title}};case i.c.IMAGE:var f=(0,o.d)(e,t);if(!f)throw new Error("asProtoMessage no hash for image");var m=f.hash,v=f.fileLength,g={url:(null==n?void 0:n.url)||void 0,mimetype:"image/jpeg",caption:e.text||void 0,fileSha256:(0,r.c)(m),fileLength:v,height:e.height||void 0,width:e.width||void 0,jpegThumbnail:(0,u.d)(e)?d:void 0,contextInfo:l};return(0,o.g)(g,n),h(g,t),{imageMessage:g};case i.c.VIDEO:case i.c.GIF:var _=null==t?void 0:t.plaintextHash;if(!_)throw new Error("asProtoMessage no hash for video");var E={url:(null==n?void 0:n.url)||void 0,mimetype:e.mimetype||void 0,fileSha256:(0,r.c)(_),fileLength:e.size,seconds:e.duration,mediaKey:null==n?void 0:n.cryptoKey,mediaKeyTimestamp:null==n?void 0:n.mediaKeyTs,caption:e.text||void 0,gifPlayback:e.type===i.c.GIF||void 0,height:e.height||void 0,width:e.width||void 0,fileEncSha256:null==n?void 0:n.ciphertextHash,directPath:null==n?void 0:n.directPath,jpegThumbnail:(0,u.d)(e)?d:void 0,streamingSidecar:(null==n?void 0:n.sidecar)||void 0,gifAttribution:e.type===i.c.GIF&&e.gifAttribution||void 0,contextInfo:l};return h(E,t),{videoMessage:E};case i.c.REVOKED:return{protocolMessage:{key:{remoteJid:s.h,fromMe:!0,id:e.revokedExternalId},type:a.c.REVOKE}};default:throw new Error(`sendMsg has not implemented ${e.type} msgs`)}}function h(e,t){var n=null==t?void 0:t.mediaEntry;if(t&&t.thumbPlaintextHash&&n&&"mms4"===n.version&&n.mmsThumb&&n.mmsThumb.directPath&&(0,d.a)("upload_status_thumb_mms_enabled")){var a=n.mmsThumb,i=a.ciphertextHash,s=a.directPath;e.thumbnailSha256=(0,r.c)(t.thumbPlaintextHash),e.thumbnailEncSha256=i,e.thumbnailDirectPath=s}}},,,function(e,t,n){n.d(t,"n",(function(){return v})),n.d(t,"l",(function(){return g})),n.d(t,"o",(function(){return _})),n.d(t,"i",(function(){return E})),n.d(t,"f",(function(){return b})),n.d(t,"g",(function(){return y})),n.d(t,"q",(function(){return S})),n.d(t,"a",(function(){return I})),n.d(t,"h",(function(){return w})),n.d(t,"k",(function(){return T})),n.d(t,"p",(function(){return A})),n.d(t,"m",(function(){return O})),n.d(t,"e",(function(){return C})),n.d(t,"j",(function(){return R})),n.d(t,"b",(function(){return k})),n.d(t,"c",(function(){return D})),n.d(t,"d",(function(){return x}));var r=n(15),a=n(2),i=n(6),s=n(36),o=n(135),u=n(84),d="transparent";function c(e,t,n){return{preview:e||null,plaintextHash:(null==t?void 0:t.plaintextHash)||null,mmsThumbInfo:t&&t.thumbPlaintextHash?{hash:t.thumbPlaintextHash,blob:n||null}:void 0}}function l(e){return e?{preview:e}:null}function p(e,t,n,r){var a=m(e,t,r);return n&&(a.remoteJid=n),a}function h(e,t,n,r,a){var i=p(e,t,n,a);return r&&(i.mentionedJids=r),i}function f(e,t,n){return m(e,t,n)}function m(e,t,n){var r={externalId:e,ts:t,author:a.b,ack:a.a.CLOCK,altIndex:""};return n&&(n.isMulticast&&(r.isMulticast=n.isMulticast),r.forwardingScore=n.forwardingScore,r.forwardOriginalTs=n.forwardOriginalTs),r}function v(e,t,n,r,i,s,o){return{msg:Object.assign({type:a.f.TEXT},h(e,t,n,r,o),i),media:l(s)}}function g(e,t,n,r,i){return{msg:Object.assign({type:a.f.TEXT},f(e,t,i),n),media:l(r)}}function _(e,t,n,r,i){return{msg:Object.assign({type:a.f.VCARD},p(e,t,n,i),{contacts:r.contacts})}}function E(e,t,n,r,i,s){return{msg:Object.assign({type:a.f.LOCATION},p(e,t,n,s),r),media:l(i)}}function b(e,t,n,r,i){return{msg:Object.assign({type:a.f.GROUP_INVITE},p(e,t,n),{groupJid:r.groupJid,groupName:r.groupName,inviteExpiration:r.inviteExpiration,inviteCode:r.inviteCode,caption:r.caption,bg:r.bg||void 0}),media:c(i)}}function y(e,t,n,r){return{msg:Object.assign({type:a.f.HSM_BUTTON_REPLY},p(e,t,n),r)}}function S(e,t,n,r){return{msg:Object.assign({type:a.f.PTT},p(e,t,n),r,{played:!0,media:null})}}function I(e,t,n,r,i){return{msg:Object.assign({type:a.f.AUDIO},p(e,t,n,i),r,{media:null}),media:c(null,i)}}function w(e,t,n,r,i,s,o,u,d){return{msg:P(Object.assign({type:a.f.IMAGE},h(e,t,n,r,o),i,{media:null,uploadSource:d}),u),media:c(s,o)}}function T(e,t,n,r,i){return{msg:Object.assign({type:a.f.IMAGE},f(e,t,i),n,{media:null}),media:c(r,i)}}function A(e,t,n,r,i,s,o,u,d){return{msg:P(Object.assign({type:a.f.VIDEO},M(i),h(e,t,n,r,o),{uploadSource:d}),u),media:c(s,o)}}function O(e,t,n,r,i){return{msg:Object.assign({type:a.f.VIDEO},f(e,t,i),M(n)),media:c(r,i)}}function M(e){return{type:a.f.VIDEO,size:e.size,width:e.width||void 0,height:e.height||void 0,duration:e.duration||void 0,mimetype:e.mimetype||void 0,text:e.text&&e.text.trim()||void 0,bg:e.bg||d,media:null}}function C(e,t,n,r,a,i,s){return{msg:Object.assign({},N(a),h(e,t,n,r,s)),media:c(i,s)}}function R(e,t,n,r,a){return{msg:Object.assign({},N(n),f(e,t,a)),media:c(r,a)}}function N(e){return{type:a.f.GIF,size:e.size,width:e.width||void 0,height:e.height||void 0,mimetype:e.mimetype||void 0,text:e.text&&e.text.trim()||void 0,bg:e.bg||d,gifAttribution:e.gifAttribution||void 0,media:null}}function k(e,t,n,r,i,s,o){return{msg:Object.assign({type:a.f.DOCUMENT},p(e,t,n,s),r,{media:null}),media:c(i,s,o)}}function P(e,t){return null!=t?Object.assign({},e,{viewOnceState:t}):e}function G(e,t,n,r,o){var u=e.forwardOriginalTs;null==u&&(u=e.ts);var d=e.forwardingScore;null==d&&(d=e.isForwarded?1:0);var c=i.E.get(),l=c.frequentlyForwardedThreshold,p=c.frequentlyForwardedMessages;return e.author!==a.b&&(p?d<s.a&&(d=Math.min(d+1,s.a-1))>=l&&(d=s.a):d=0===d?1:d),{forwardOriginalTs:u,forwardingScore:d,isMulticast:n,plaintextHash:r,thumbPlaintextHash:o}}function L(e,t){return(null==t?void 0:t.progressiveJpegScanNumber)?null==t?void 0:t.partialSize:e.size}function D(e,t,n,r){var i,s=e.media,u=null==(i=e.media)?void 0:i.plaintextHash,d=G(e.msg,e.preview,r,u),l=e.msg;switch(l.type){case a.f.TEXT:return v(t,n,null,l.mentionedJids,{text:l.text,linkPreview:l.linkPreview,bg:l.bg,hasPreview:l.hasPreview},e.preview||null,d);case a.f.VCARD:return _(t,n,null,l,d);case a.f.LOCATION:return E(t,n,null,{degreesLatitude:l.degreesLatitude,degreesLongitude:l.degreesLongitude,name:l.name,address:l.address,url:l.url,bg:l.bg,hasPreview:l.hasPreview},e.preview||null,d);case a.f.IMAGE:if(!u)return __LOG__(4)`craftForwarded no hash on image msg`,null;var h=L(l,s);return null==h?(__LOG__(4)`craftForwarded partial size not defined in case of progressive downloads`,null):w(t,n,null,l.mentionedJids,{text:null,height:l.height,width:l.width,size:h,bg:l.bg,hasPreview:l.hasPreview},e.preview||null,d);case a.f.STICKER:if(!u)return __LOG__(4)`craftForwarded no hash on image msg`,null;var f={size:l.size};return null!=l.mimetype&&(f.mimetype=l.mimetype),null!=l.isAnimated&&(f.isAnimated=l.isAnimated),null!=l.width&&(f.width=l.width),null!=l.height&&(f.height=l.height),(function(e,t,n,r,i,s){return{msg:Object.assign({type:a.f.STICKER},p(e,t,null,s),r,{media:null}),media:c(i,s)}})(t,n,0,f,e.preview||null,d);case a.f.VIDEO:return u?A(t,n,null,l.mentionedJids,{text:null,height:l.height,width:l.width,size:l.size,mimetype:l.mimetype,duration:l.duration,rotation:l.rotation,frame:l.frame,bg:l.bg,hasPreview:l.hasPreview},e.preview||null,d):(__LOG__(4)`craftForwarded no hash on video msg`,null);case a.f.GIF:return u?C(t,n,null,l.mentionedJids,{text:null,height:l.height,width:l.width,size:l.size,mimetype:l.mimetype,duration:l.duration,rotation:l.rotation,frame:l.frame,gifAttribution:l.gifAttribution,bg:l.bg,hasPreview:l.hasPreview},e.preview||null,d):(__LOG__(4)`craftForwarded no hash on gif msg`,null);case a.f.PTT:case a.f.AUDIO:return u?I(t,n,null,{duration:l.duration,size:l.size,mimetype:l.mimetype,hasPreview:l.hasPreview},d):(__LOG__(4)`craftForwarded no hash on audio msg`,null);case a.f.RICH_HSM:var m=l.richContent;return m?m.type===a.f.IMAGE?u?w(t,n,null,null,{text:null,height:m.height,width:m.width,bg:m.bg,size:m.size,hasPreview:m.hasPreview},e.preview||null,d):(__LOG__(4)`craftForwarded no hash on image rich hsm msg`,null):m.type===a.f.VIDEO?u?A(t,n,null,null,{text:null,height:m.height,width:m.width,bg:m.bg,size:m.size,mimetype:m.mimetype,duration:m.duration,hasPreview:m.hasPreview},e.preview||null,d):(__LOG__(4)`craftForwarded no hash on video rich hsm msg`,null):m.type===a.f.DOCUMENT?u?k(t,n,null,m.isVCard?{isVCard:!0,mimetype:m.mimetype,size:m.size,fileName:m.fileName,contactsCount:m.contactsCount,uiVCards:m.uiVCards,hasPreview:m.hasPreview}:{mimetype:m.mimetype,size:m.size,fileName:m.fileName,pages:m.pages,hasPreview:m.hasPreview,mmsThumb:m.mmsThumb},e.preview||null,d):(__LOG__(4)`craftForwarded no hash on document rich hsm msg`,null):(m.type,E(t,n,null,{degreesLatitude:m.degreesLatitude,degreesLongitude:m.degreesLongitude,name:m.name,address:m.address,url:m.url,bg:m.bg,hasPreview:m.hasPreview},e.preview||null,d)):v(t,n,null,null,{text:(0,o.a)(l.title,l.content)},null,d);case a.f.HSM_BUTTON_REPLY:return v(t,n,null,null,{text:l.selectedDisplayText},null,d);case a.f.DOCUMENT:return u?k(t,n,null,l.isVCard?{isVCard:!0,mimetype:l.mimetype,size:l.size,fileName:l.fileName,contactsCount:l.contactsCount,uiVCards:l.uiVCards,hasPreview:l.hasPreview}:{mimetype:l.mimetype,size:l.size,fileName:l.fileName,pages:l.pages,hasPreview:l.hasPreview,mmsThumb:l.mmsThumb},e.preview||null,d):(__LOG__(4)`craftForwarded no hash on document msg`,null);default:return __LOG__(4)`craftForwarded can not forward (yet) type ${l.type}`,null}}function x(e,t,n,i){var d,c=e.media,l=null==(d=e.media)?void 0:d.plaintextHash,p=G(e.msg,e.preview,i,l),h=e.msg;switch(h.type){case a.f.TEXT:var f=(0,s.h)(),m=r.e;return g(t,n,{text:(0,u.e)(h.text),linkPreview:h.linkPreview,backgroundColor:f,font:m,bg:h.bg,hasPreview:h.hasPreview},e.preview||null,p);case a.f.IMAGE:if(!l)return __LOG__(4)`craftForwardedStatus no hash on image msg`,null;var v=L(h,c);return null==v?(__LOG__(4)`craftForwardedStatus partial size not defined in case of progressive downloads`,null):T(t,n,{text:null,height:h.height,width:h.width,size:v,bg:h.bg,hasPreview:h.hasPreview},e.preview||null,p);case a.f.VIDEO:return l?O(t,n,{text:null,height:h.height,width:h.width,size:h.size,mimetype:h.mimetype,duration:h.duration,frame:h.frame,rotation:h.rotation,bg:h.bg,hasPreview:h.hasPreview},e.preview||null,p):(__LOG__(4)`craftForwardedStatus no hash on video msg`,null);case a.f.GIF:return l?R(t,n,{text:null,height:h.height,width:h.width,size:h.size,mimetype:h.mimetype,duration:h.duration,frame:h.frame,rotation:h.rotation,gifAttribution:h.gifAttribution,bg:h.bg,hasPreview:h.hasPreview},e.preview||null,p):(__LOG__(4)`craftForwardedStatus no hash on gif msg`,null);case a.f.RICH_HSM:var _=h.richContent;if(!_){var E=(0,s.h)(),b=r.e;return g(t,n,{text:(0,u.e)((0,o.b)(h.title,h.content)),backgroundColor:E,font:b,bg:h.bg},null,p)}if(_.type===a.f.IMAGE)return l?T(t,n,{text:null,height:_.height,width:_.width,size:_.size,bg:h.bg,hasPreview:_.hasPreview},e.preview||null,p):(__LOG__(4)`craftForwardedStatus no hash on image msg`,null);if(_.type===a.f.VIDEO)return l?O(t,n,{text:null,height:_.height,width:_.width,size:_.size,mimetype:_.mimetype,duration:_.duration,frame:_.frame,rotation:_.rotation,bg:h.bg,hasPreview:_.hasPreview},e.preview||null,p):(__LOG__(4)`craftForwardedStatus no hash on video msg`,null);_.type;var y=(0,s.h)(),S=r.e;return g(t,n,{text:(0,u.e)(h.content),backgroundColor:y,font:S,bg:h.bg},null,p);case a.f.HSM_BUTTON_REPLY:var I=(0,s.h)(),w=r.e;return g(t,n,{text:(0,u.e)(h.selectedDisplayText),backgroundColor:I,font:w,bg:h.bg},null,p);default:return __LOG__(4)`craftForwardedStatus can not forward (yet) type ${h.type}`,null}}},function(e,t,n){n.d(t,"c",(function(){return u})),n.d(t,"b",(function(){return d})),n.d(t,"f",(function(){return c})),n.d(t,"d",(function(){return l})),n.d(t,"a",(function(){return p})),n.d(t,"e",(function(){return h}));var r=n(6),a=n(3),i=[.25*a.b,.5*a.b,1*a.b,1*a.b,3*a.b,7*a.b],s=i.length-1;function o(e){return(0,a.l)(i[e])}function u(e){return d(e,s,null)}function d(e,t,n){var a=Math.min(s,Math.max(0,t));return __LOG__(2)`pinReminder: enabling at interval ${a}`,r.K.set({status:"enabled",pin:e.join(""),intervalIndex:a,nextTime:o(t),hasEmail:n}).then(()=>{})}function c(e,t){var n=r.K.get();return"disabled"===n.status?Promise.resolve():d(e,t,n.hasEmail)}function l(){var e=r.K.get();if("disabled"!==e.status){var t=e.pin,n=e.intervalIndex,a=e.nextTime;r.K.set({status:"enabled",pin:t,intervalIndex:n,nextTime:a,hasEmail:!0})}}function p(){return __LOG__(2)`pinReminder: disabling`,r.K.set({status:"disabled"}).then(()=>{})}function h(e){var t=r.K.get();if("disabled"!==t.status){var n=t.pin,a=t.intervalIndex,i=t.nextTime,u=t.hasEmail,d=e?Math.min(a+1,s):Math.max(a-1,0),c=e?o(d):i;__LOG__(2)`pinReminder: scheduling at ${c} after ${e?"success":"error"}, interval: ${d}`,r.K.set({status:"enabled",pin:n,intervalIndex:d,nextTime:c,hasEmail:u})}}},function(e,t,n){var r=n(10);t.a=class{constructor(e){this.ZP=0,this.ZV=0,this.ZS=e.onUpdate,this.ZT=e.onSuccess,this.ZU=e.onError;var t=()=>{this.ZO()};this.parts=(0,r.n)(e.parts,e=>new class{constructor(e,t){this.ZP=0,this.ZR=!1,this.ZO=e,this.ZQ=t}set(e){if(!this.ZR){var t=Math.max(0,Math.min(e,1))*this.ZQ;t>=this.ZP&&(this.ZP=t,this.ZO())}}reset(){this.ZR||(this.ZP=0,this.ZO())}finished(){this.ZR||(this.ZR=!0,this.ZP=this.ZQ,this.ZO())}}(t,e)),this.ZO()}failed(e){0===this.ZV&&(this.ZV=1,this.ZU(e))}ZO(){if(0===this.ZV){var e=0,t=0,n=!0,r=this.parts;for(var a in r){var i=this.parts[a];e+=i.ZP,t+=i.ZQ,n=n&&i.ZR}if(n)this.ZV=2,this.ZP=1,this.ZT();else{var s=e/t;s>this.ZP&&(this.ZP=s,this.ZS(s))}}}}},,,,,,,,function(e,t,n){function r(e){var t=new Uint8Array(1);self.crypto.getRandomValues(t),(function(e,t){for(var n=0;n<t;n++)e.writeUint8(t)})(e,1+(15&t[0]))}function a(e){if(0===e.length)throw new Error("unpadPkcs7 given empty bytes");var t=e[e.length-1];if(t>e.length)throw new Error(`unpadPkcs7 given ${e.length} bytes, but pad is ${t}`);return new Uint8Array(e.buffer,e.byteOffset,e.length-t)}n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}))},function(e,t,n){n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return u}));var r=n(2),a=n(23),i=n(10),s=n(8),o={call:"call",sendPaymentMessage:"sendPayment",requestPaymentMessage:"requestPayment",liveLocationMessage:"liveLocation",stickerMessage:"sticker",reactionMessage:"reaction",pollCreationMessage:"pollCreation",pollUpdateMessage:"pollUpdate"};function u(){return(0,s.e)("getFutureProofMsgs",e=>e.table.transact("r",["msgs","chats"],()=>(function(e){var t=new Set((0,i.x)(o));return(0,a.a)("reactions_receive")&&t.delete("reaction"),e.table.stores.msgs.where("type").equals(r.f.FUTUREPROOF).filter(e=>e.type===r.f.FUTUREPROOF&&(null==e.subtype||!t.has(e.subtype))).toArray().then(t=>{var n=new Set;return t.forEach(e=>{var t=e.chat;return n.add(t)}),e.table.stores.chats.where("id").anyOf(Array.from(n)).toArray().then(e=>{var n=new Map;e.forEach(e=>{var t=e.id,r=e.jid;n.set(t,r)});var a=[];return t.forEach(e=>{if(e.type===r.f.FUTUREPROOF){var t=n.get(e.chat);if(!t)return __LOG__(3)`_getFutureProofMsgs: chat ${e.chat} not found`,void a.push([e,"deleted"]);a.push([e,t])}}),a})})})(e)))}},function(e,t,n){n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return g}));var r=n(27),a=n.n(r),i=n(98),s=n(282),o=n(62),u=n(354),d=n(169),c=n(46),l=n(28),p=(n(244),n(67)),h=n(322);function f(e){return m.apply(this,arguments)}function m(){return(m=a()((function*(e){var t,n;if("key_rotation"===e.type?(t=E(e.keys),n=yield(0,d.b)()):"missing_key"===e.type&&(t=E(e.keys,e.orphanKeys),n=[{deviceId:e.deviceId}]),null==n)return Promise.resolve();var r={type:o.c.APP_STATE_SYNC_KEY_SHARE,appStateSyncKeyShare:t},a=n.map(e=>e.deviceId),i=e.keys.map(e=>(0,s.a)(e.keyId));__LOG__(2)`syncd: send key share key id ${i} to peer deviceIds ${a} due to ${e.type}`,yield Promise.all(a.map(e=>(0,u.d)(e,r)))}))).apply(this,arguments)}var v=new c.a("syncResponseParser",e=>{__LOG__(2)`syncd: start parsing syncd collections`;var t=[];return e.child("sync").mapChildrenWithTag("collection",e=>{var n={},r=e.attrString("name"),a=Object.keys(i.b).find(e=>i.b[e]===r);if(!a)throw new Error("syncd: invalid collection name");n.name=i.b[a],n.state=(function(e,t){if(!e.hasAttr("type")||"error"!==e.attrString("type"))return e.hasAttr("has_more_patches")?i.c.SUCCESS_HAS_MORE:i.c.SUCCESS;var n=e.child("error"),r=n.attrString("code"),a=n.attrString("text");switch(r){case"409":return e.hasAttr("has_more_patches")?i.c.CONFLICT_HAS_MORE:i.c.CONFLICT;case"400":case"404":return __LOG__(4)`syncd fatal error: collection ${String(t)} throws ${a}`,i.c.ERROR_FATAL;default:return __LOG__(3)`syncd retryable error: collection ${String(t)} throws ${a}`,i.c.ERROR_RETRY}})(e,n.name),e.hasAttr("version")&&(n.version=parseInt(e.attrString("version"),10)),e.hasChild("patches")&&(n.patches=e.child("patches").mapChildrenWithTag("patch",e=>(0,p.a)(h.d,e.contentBytes()))),e.hasChild("snapshot")&&(n.snapshot=(0,p.a)(h.a,e.child("snapshot").contentBytes())),t.push(n),__LOG__(2)`syncd: successfully parsed collection ${a}`}),t});function g(e,t){return _.apply(this,arguments)}function _(){return(_=a()((function*(e,t){var n=t.syncIqNode,r=t.collectionWithPendingMutationsIds,a=t.collectionWithEncryptedMutations,i=(t.localCollectionVersions,yield(0,l.e)(n,v));if(i.success){var s=i.result;return s.forEach(e=>{var t=r.get(e.name);t&&(e.syncedPendingMutationsId=t);var n=a.get(e.name);n&&(e.syncedEncryptedMutations=n)}),s}var o=i.errorCode,u=i.errorText;throw __LOG__(4)`syncd: sync iq errorCode:${o} errorText:${u}`,new Error(u)}))).apply(this,arguments)}function E(e,t){var n=e.map(e=>({keyId:{keyId:e.keyId},keyData:{keyData:e.keyData,fingerprint:{rawId:e.fingerprint.rawId,currentIndex:e.fingerprint.currentIndex,deviceIndexes:e.fingerprint.deviceIndexes},timestamp:e.timestampMs}}));if(t){var r=t.map(e=>({keyId:{keyId:e},keyData:void 0}));n=n.concat(r)}return{keys:n}}},function(e,t,n){n.d(t,"a",(function(){return d}));var r=n(28),a=n(29),i=n(88),s=n(4),o=n(7),u=(n(150),new i.b("userIdentities",e=>e.child("list").mapChildren(e=>[e.attrPhoneUserJid("jid"),e.child("identity").contentBytes(32)])));function d(e){var t=e.map(o.e);return(0,a.x)(t).then(e=>{var n=t.filter(t=>!e.has(t)).map(o.h);if(0!==n.length)return(function(e){var t=(0,s.v)("iq",{id:(0,s.t)(),xmlns:"encrypt",type:"get",to:s.k},(0,s.v)("identity",null,e.map(e=>(0,s.v)("user",{jid:(0,s.g)(e)}))));return(0,r.e)(t,u).then(t=>{if(!t.success){if(406===t.errorCode)return void __LOG__(2)`getAndSaveSignalIdentities 406 error for invalid jids: ${e}`;throw new Error("getAndSaveSignalIdentities bad response "+String(t))}return(0,a.L)(t.result)})})(n)})}},function(e,t,n){var r=n(46),a=n(4),i=n(28),s=n(6),o=n(12),u=n(36),d=n(115),c=n(102),l=n(203),p=n(30),h=n(16),f=new r.a("serverProps",e=>{e.assertTag("iq"),e.assertAttr("from","s.whatsapp.net");var t=e.child("props"),n=t.maybeAttrInt("protocol"),r={serverPropsVersion:t.attrInt("version")};return 2===n&&(r.hash=t.maybeAttrString("hash"),r.abKey=t.maybeAttrString("key")),t.forEachChildWithTag("prop",e=>{switch(e.attrString("name")){case"frequently_forwarded_group_setting":r.frequentlyForwardedGroupSetting=0!==e.attrInt("value");break;case"frequently_forwarded_max":r.frequentlyForwardedMax=e.attrInt("value");break;case"frequently_forwarded_messages":r.frequentlyForwardedMessages=0!==e.attrInt("value");break;case"frequently_forwarded_threshold":r.frequentlyForwardedThreshold=e.attrInt("value");break;case"gif_provider":r.gifProvider=e.attrInt("value");break;case"max_participants":r.maxParticipants=e.attrInt("value");break;case"max_subject":r.maxSubject=e.attrInt("value");break;case"max_keys":r.maxKeys=e.attrInt("value");break;case"multicast_limit_global":r.multicastLimitGlobal=e.attrInt("value");break;case"group_invite_sending":r.groupInviteSending=e.attrInt("value");break;case"group_join_permissions":r.groupJoinPermissions=e.attrInt("value");break;case"mms_hot_content_timespan_in_seconds":r.mmsHotContentTimespan=e.attrInt("value");break;case"mms_vcache_aggregation_enabled":r.mmsVCacheAggregationEnabled=0!==e.attrInt("value");break;case"mms_resume_check_chatd":r.mmsResumeCheckChatd=0!==e.attrInt("value");break;case"status_video_max_duration":r.statusVideoMaxDuration=e.attrInt("value");break;case"prekey_expiration_days":var t=e.attrInt("value");t=Math.min(t,180),t=Math.max(t,30),r.prekeyExpirationDays=t;break;case"voice_call_enabled":r.kaiosVoiceCallEnabled512=0!==e.attrInt("value");break;case"kaios_voice_call_enabled_jio":r.kaiosVoiceCallEnabled512Jio=0!==e.attrInt("value");break;case"kaios_voice_call_enabled_256":r.kaiosVoiceCallEnabled256=0!==e.attrInt("value");break;case"kaios_voice_logs_enabled":r.kaiosVoiceLogsEnabled=0!==e.attrInt("value");break;case"ephemeral_messages_allowed_values":var n=e.attrString("value").split(",").map(e=>parseInt(e,10));n.length>0&&(r.ephemeralMessagesAllowedValues=new Set(n));break;case"md_blocklist_v2":r.mdBlocklistV2=0!==e.attrInt("value");break;case"mms_vcard_autodownload_size_kb":r.mmsVcardAutodownloadSizeKb=e.attrInt("value");break;case"vcard_as_document_size_kb":r.vcardAsDocumentSizeKb=e.attrInt("value");break;case"vcard_max_size_kb":r.vcardMaxSizeKb=e.attrInt("value");break;case"view_once_read":r.viewOnceRead=0!==e.attrInt("value");break;case"view_once_write":r.viewOnceWrite=0!==e.attrInt("value");break;case"mms4_media_retry_notification_encryption_enabled":r.mms4MediaRetryNotificationEncryptionEnabled=0!==e.attrInt("value");break;case"mms4_server_error_receipt_encryption_enabled":r.mms4ServerErrorReceiptEncryptionEnabled=0!==e.attrInt("value");break;case"user_notice":r.userNotice=0!==e.attrInt("value");break;case"privatestats_token_max_expiry_seconds":r.privateStatsTokenMaxExpirySeconds=e.attrInt("value")}}),{protocol:n,values:r}});function m(e,t){__LOG__(2)`syncServerProps updating to ${t.serverPropsVersion}`,s.E.set(t);var n=s.E.get(),r=(0,u.o)(n),a=(0,l.a)(n);(0,o.c)("event","serverPropsUpdated",{serverProps:r}),e.voipCallEnabled!==a&&(function(e){var t=s.n.get();t&&!e&&(0,c.c)(),(0,o.c)("event","voipStatusChanged",{hasVoip:t,voipCallEnabled:e})})(a)}t.a=(0,d.a)(()=>"serverProps",(function(){var e=s.E.get(),t=(0,a.v)("iq",{xmlns:"w",id:(0,a.t)(),type:"get",to:a.k},(0,a.v)("props",{protocol:"2",hash:(0,a.b)(e.hash||"")}));return(0,i.e)(t,f).then(t=>{if(t.success){var n,r,a,i=(0,u.o)(e),o=t.result,d=o.protocol,c=o.values;if(2===d&&null==c.hash?(__LOG__(2)`syncServerProps v2: hash is empty, only updating abKey`,n=Object.assign({},e,{abKey:c.abKey})):n=Object.assign({},e,c),n=Object.assign({},n,{kaiosVoiceLogsEnabled:(r=n.kaiosVoiceLogsEnabled,a=s.l.get(),null!=a&&r&&a>=512)}),!i.viewOnceRead&&!0===n.viewOnceRead)return(0,p.b)().waitUntilPersisted(h.e.processFutureProofMsgs()).then(()=>{m(i,n)});m(i,n)}else __LOG__(4)`syncServerProps failed ${t}`})}))},,,,,,,,,,,,function(e,t,n){n.d(t,"a",(function(){return o}));var r=n(28),a=n(6),i=n(3),s=n(11);function o(e,t,n){var o=a.h.get(),u={version:"2.2218.5",context:e,os:o.osVersion,osBuild:o.osBuild,manufacturer:o.manufacturer,model:o.device,userAgent:o.userAgent,"sim mcc-mnc":`${o.mcc}-${o.mnc}`,"device iso8601":(0,i.G)().toISOString(),"socket conn":(0,r.b)()?"up":"down","is rest of the world":"false","Device ID":s.c};return null!=n&&(u.reference_file_id=""+n),t&&(u["Debug info"]="+"+t),u}},function(e,t,n){n.d(t,"a",(function(){return r}));var r=class{constructor(e,t){this.signalDependencies=e,this.keyPair=t?Promise.resolve(t):this.signalDependencies.generateIdentityKeyPair()}generatePublicKey(){return this.keyPair.then(e=>e.publicKey)}generateSharedSecret(e){return this.keyPair.then(t=>{var n=t.privateKey;return __LOG__(2)`Curve25519.generateSharedSecret pubkey:${e}`,this.signalDependencies.calculateAgreement(new Uint8Array(e),n)})}}},function(e,t,n){n.d(t,"a",(function(){return R}));var r=n(6),a=n(7),i=n(29),s=n(43),o=n(225),u=n(377),d=n(218),c=n(243),l=n(418),p=n(419),h=n(271),f=n(28),m=n(25),v=n(34),g=n(155),_=n(30),E=n(16),b=n(21),y=n(31),S=n.n(y),I=n(109),w=n(122),T=n(241),A=n(305),O=(n(137),n(120)),M=n(35),C={UNINITIALIZED:"SAVE",COUNTRY_SELECT:"DELETE",ENTERING_PHONE_NUMBER:"DELETE",REQUESTING_CODE:"SAVE",TWO_FACTOR:"SAVE",QUERYING_JIO_HEADERS:"SKIP",CONFIRM_FOUND_PHONE_NUMBER:"SKIP",SENDING_SMS:"SKIP",SENDING_VOICE:"SKIP",VERIFYING:"SKIP",SENDING_EMAIL:"SKIP",RESETTING:"SKIP",INITIALIZING:"DELETE",BLOCKED:"DELETE",BLOCKED_BAN_APPEAL:"SAVE",BLOCKED_BAN_APPEAL_PRE:"SAVE",BAN_APPEAL:"SAVE",REQUESTING_CODE_BAN_APPEAL:"SAVE",SENDING_SMS_BAN_APPEAL:"SKIP",SENDING_VOICE_BAN_APPEAL:"SKIP",VERIFYING_SMS_BAN_APPEAL:"SKIP"},R=class{constructor(e,t){__LOG__(2)`new RegFlow()`,this.endReg=t,this.AK=e,this.AI=Promise.all([k("index.html"),k("backendRoot.js")]).then(P),this.AJ=r.B.get(),this.AH=Promise.all([i.z().then(e=>{if(!e)return i.I()}),r.P.isDefined()?Promise.resolve():(new h.a).keyPair.then(e=>{var t=new Uint8Array(24);self.crypto.getRandomValues(t),r.P.set({recoveryToken:t.buffer,staticKeyPair:e})})]).then(i.G).then(e=>{var t=e.regId,n=e.staticPublicKey,a=e.signedPreKey,i=r.P.get(),o=i.recoveryToken,u=i.staticKeyPair,d={id:(0,s.e)(o),authkey:(0,s.e)(u.publicKey),e_regid:(0,s.e)(N(4,t)),e_keytype:(0,s.e)(N(1,5)),e_ident:(0,s.e)(n),e_skey_id:(0,s.e)(N(3,a.id)),e_skey_val:(0,s.e)(a.keyPair.publicKey),e_skey_sig:(0,s.e)(a.signature)};return __LOG__(2)`getSlowParams: finished`,d}).catch(e=>{throw __LOG__(4)`RegFlow slowParams error ${e}`,SEND_LOGS("regflow-slowparams-failed"),e})}getToken(e){return this.AI.then(t=>P([(0,v.k)("aa8243c465a743c488beb4645dda63edc2ca9a58"),t,e]))}getSlowParams(){return this.AH}getStore(){return this.AJ}getStoreInState(e){var t=this.getStore();if(t.type===e)return t;__LOG__(3)`Unexpected store in state ${t.type}. Expected ${e}`}getStoreInStates2(e){var t=this.getStore();if(e.includes(t.type))return t;__LOG__(3)`Unexpected store in state ${t.type}. Expected ${e[0]} or ${e[1]}`}getStoreInStates3(e){var t=this.getStore();if(e.includes(t.type))return t;__LOG__(3)`Unexpected store in state ${t.type}. Expected ${e[0]}, ${e[1]} or ${e[2]}`}updateStore(e){var t;this.AJ=e;var n=C[e.type];switch(n){case"SAVE":t=r.B.set(e);break;case"SKIP":t=Promise.resolve();break;case"DELETE":t=r.B.delete();break;default:return(0,S.a)(n)}return t.then(()=>{this.AK.fireAndForget("regPage","updateReg",{newStore:e})})}startSmsListener(){return this.AK.sendAndReceive("regPage","startSmsListener",{})}stopSmsListener(){return this.AK.sendAndReceive("regPage","stopSmsListener",{})}finish(e){var t=(0,a.B)(e.login);return r.r.set(t),r.d.set("2.2218.5"),r.j.update({saveMediaToPhoneStorage:!0}),this.updateStore({type:"INITIALIZING",jid:t}),(0,o.c)(this.AK,!1,!1).then(e=>{e("registered");var t=(0,T.a)((0,g.b)("sync"),1e4).catch(()=>null),n=this.AK.sendAndReceive("page","getTotalSpace",{area:"sdcard"}).then(e=>{var t=e.result;if(!(t>=838860800))return __LOG__(2)`Storage is low: ${t}. Autodownload only photos.`,r.j.update({autodownloadWifi:(0,b.l)("photos"),autodownloadMobile:(0,b.l)("photos"),autodownloadRoaming:(0,b.f)()})}).catch(e=>{__LOG__(3)`Failed to check available space: ${e}`});return Promise.all([(0,u.default)(),(0,d.queryAllGroups)().catch((0,w.a)(I.a,()=>"disconnected")).then(e=>{if("success"!==e)return __LOG__(4)`Failed to retrieve all groups during registration`,SEND_LOGS("reg-failed-query-groups"),(0,_.b)().waitUntilPersisted(E.e.queryAllGroups())}),(0,c.c)(),(0,A.a)().then(()=>r.E.get().mdBlocklistV2?(0,p.getBlocklistV2)():(0,l.getBlocklist)()),(0,_.b)().waitUntilPersisted(E.e.getOwnAbout()),n,t])}).then(()=>this.endReg()).then(()=>{(0,f.n)()})}};function N(e,t){for(var n=t,r=new Uint8Array(e),a=e-1;a>=0;a--)r[a]=255&n,n>>>=8;return r}function k(e){return(0,M.k)(e).then(e=>e.arrayBuffer())}function P(e){var t=m.a.build(...e).readByteArray();return(0,O.a)(t).then(e=>(0,v.n)(new Uint8Array(e)))}},,,function(e,t,n){n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return l})),n.d(t,"c",(function(){return p})),n.d(t,"d",(function(){return f}));var r=n(0),a=n(166)({SET:0,REMOVE:1}),i={},s={},o={},u={},d={},c={},l={},p={},h={},f={};i.internalSpec={version:[1,r.d.UINT64]},s.internalSpec={code:[1,r.d.UINT64],text:[2,r.d.STRING]},o.internalSpec={blob:[1,r.d.BYTES]},u.internalSpec={blob:[1,r.d.BYTES]},d.internalSpec={id:[1,r.d.BYTES]},c.internalSpec={index:[1,r.d.MESSAGE,o],value:[2,r.d.MESSAGE,u],keyId:[3,r.d.MESSAGE,d]},l.internalSpec={mediaKey:[1,r.d.BYTES],directPath:[2,r.d.STRING],handle:[3,r.d.STRING],fileSizeBytes:[4,r.d.UINT64],fileSha256:[5,r.d.BYTES],fileEncSha256:[6,r.d.BYTES]},r.d.MESSAGE,r.b.REPEATED,r.d.MESSAGE,r.d.BYTES,r.d.MESSAGE,p.internalSpec={mutations:[1,r.b.REPEATED|r.d.MESSAGE,h]},h.internalSpec={operation:[1,r.d.ENUM,a],record:[2,r.d.MESSAGE,c]},f.internalSpec={version:[1,r.d.MESSAGE,i],mutations:[2,r.b.REPEATED|r.d.MESSAGE,h],externalMutations:[3,r.d.MESSAGE,l],snapshotMac:[4,r.d.BYTES],patchMac:[5,r.d.BYTES],keyId:[6,r.d.MESSAGE,d],exitCode:[7,r.d.MESSAGE,s],deviceIndex:[8,r.d.UINT32]}},,,,,,function(e,t,n){n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o})),n.d(t,"c",(function(){return d}));var r=n(0),a=n(339),i=n(62),s={INITIAL_BOOTSTRAP:0,INITIAL_STATUS_V3:1,FULL:2,RECENT:3,PUSH_NAME:4},o={COMPLETE_BUT_MORE_MESSAGES_REMAIN_ON_PRIMARY:0,COMPLETE_AND_NO_MORE_MESSAGE_REMAIN_ON_PRIMARY:1},u={DEFAULT:0,OFF:1,ON:2},d={},c={},l={},p={},h={},f={},m={},v={};d.internalSpec={syncType:[1,r.b.REQUIRED|r.d.ENUM,s],conversations:[2,r.b.REPEATED|r.d.MESSAGE,c],statusV3Messages:[3,r.b.REPEATED|r.d.MESSAGE,a.c],chunkOrder:[5,r.d.UINT32],progress:[6,r.d.UINT32],pushnames:[7,r.b.REPEATED|r.d.MESSAGE,p],globalSettings:[8,r.d.MESSAGE,m],threadIdUserSecret:[9,r.d.BYTES],threadDsTimeframeOffset:[10,r.d.UINT32]},c.internalSpec={id:[1,r.b.REQUIRED|r.d.STRING],messages:[2,r.b.REPEATED|r.d.MESSAGE,l],newJid:[3,r.d.STRING],oldJid:[4,r.d.STRING],lastMsgTimestamp:[5,r.d.UINT64],unreadCount:[6,r.d.UINT32],readOnly:[7,r.d.BOOL],endOfHistoryTransfer:[8,r.d.BOOL],ephemeralExpiration:[9,r.d.UINT32],ephemeralSettingTimestamp:[10,r.d.INT64],endOfHistoryTransferType:[11,r.d.ENUM,o],conversationTimestamp:[12,r.d.UINT64],name:[13,r.d.STRING],pHash:[14,r.d.STRING],notSpam:[15,r.d.BOOL],archived:[16,r.d.BOOL],disappearingMode:[17,r.d.MESSAGE,i.b],unreadMentionCount:[18,r.d.UINT32],markedAsUnread:[19,r.d.BOOL],participant:[20,r.b.REPEATED|r.d.MESSAGE,h],tcToken:[21,r.d.BYTES],tcTokenTimestamp:[22,r.d.UINT64],contactPrimaryIdentityKey:[23,r.d.BYTES],pinned:[24,r.d.UINT32],muteEndTime:[25,r.d.UINT64],wallpaper:[26,r.d.MESSAGE,f],mediaVisibility:[27,r.d.ENUM,u],tcTokenSenderTimestamp:[28,r.d.UINT64],suspended:[29,r.d.BOOL]},l.internalSpec={message:[1,r.d.MESSAGE,a.c],msgOrderId:[2,r.d.UINT64]},p.internalSpec={id:[1,r.d.STRING],pushname:[2,r.d.STRING]},h.internalSpec={userJid:[1,r.b.REQUIRED|r.d.STRING],rank:[2,r.d.ENUM,{REGULAR:0,ADMIN:1,SUPERADMIN:2}]},f.internalSpec={filename:[1,r.d.STRING],opacity:[2,r.d.UINT32]},m.internalSpec={lightThemeWallpaper:[1,r.d.MESSAGE,f],mediaVisibility:[2,r.d.ENUM,u],darkThemeWallpaper:[3,r.d.MESSAGE,f],autoDownloadWiFi:[4,r.d.MESSAGE,v],autoDownloadCellular:[5,r.d.MESSAGE,v],autoDownloadRoaming:[6,r.d.MESSAGE,v],showIndividualNotificationsPreview:[7,r.d.BOOL],showGroupNotificationsPreview:[8,r.d.BOOL],disappearingModeDuration:[9,r.d.INT32],disappearingModeTimestamp:[10,r.d.INT64]},v.internalSpec={downloadImages:[1,r.d.BOOL],downloadAudio:[2,r.d.BOOL],downloadVideo:[3,r.d.BOOL],downloadDocuments:[4,r.d.BOOL]}},function(e,t,n){n.d(t,"a",(function(){return E}));var r=n(9),a=n.n(r),i=n(35),s=n(113),o=n(6),u=n(3),d=n(70),c=n(262),l=n(102),p=n(241),h=n(12),f="https://graph.facebook.com",m=new d.a(()=>{_(),o.p.set((0,u.E)())});function v(e,t,n){var r=o.h.get(),a=e||"+12035555555",i=new FormData;return i.append("access_token","1063127757113399|745146ffa34413f9dbb5469f5370b7af"),i.append("type","crashlog"),i.append("agent",r.userAgent),i.append("from_jid",o.r.isDefined()?o.r.get():"+"+a),i.append("build_id",367214834),t&&i.append("file",new Blob([t],{type:"application/x-gzip"}),"logs.txt.gz"),null!=n&&n.content.byteLength>0&&(i.append("attachment",new Blob([n.content],{type:"application/x-gzip"}),"voipattachment.tar.gz"),n.containsLog&&i.append("tags","voip"),n.crashCount>0&&i.append("tags","native")),{method:"POST",body:i}}function g(e){return(0,p.a)((0,l.e)(Boolean(e)),1e4).then(e=>{if("evicted"!==e)return e}).catch(e=>{__LOG__(2)`dumpVoipLogs error: ${e}`})}function _(e,t){var n=(0,i.c)(f,"/wa_fls_upload_check");return(0,i.f)(n,{},v(e)).then(r=>{if(r.ok)return Promise.all([(0,c.a)().then(e=>{var t=(t,n)=>{try{e.push(t,n)}catch(e){throw new Error("Compressor failed with error "+e.message)}},n=e=>t(e,!1);return((0,h.d)()?(0,h.e)("page","pullInMemoryLogs",{}):Promise.resolve()).then(r=>(0,s.logsEachFormatted)(n,null==r?void 0:r.logs).then(()=>(t("",!0),e.result())))}),o.n.get()?g(t):Promise.resolve()]).then(t=>{var n=a()(t,2),r=n[0],s=n[1],o=(0,i.c)(f,"/wa_clb_data");return __LOG__(2)`uploadLogs: gzipped logs size ${r.byteLength}`,null!=s&&__LOG__(2)`uploadLogs: voip logs size ${s.content.byteLength}`,(0,i.f)(o,{},v(e,r,s))}).then(e=>e.json()).then(e=>parseInt(e.reference_file_id,10)||-1);throw new Error("Error while trying to check if logs can be sent: "+n)}).catch(e=>(__LOG__(4)`Error while sending logs: ${e}`,-1))}function E(e,t){return e?(m.cancel(),(0,s.enableLoggingToTable)(),(0,h.c)("page","enableLoggingToTable",{}),_(t,!0)):((0,u.n)(o.p.get(),3600)?__LOG__(3)`sendLogs too soon since last upload`:m.debounceAndCap(500,5e3),Promise.resolve(-1))}},function(e,t,n){n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return x}));var r=n(0),a={};a.internalSpec={remoteJid:[1,r.d.STRING],fromMe:[2,r.d.BOOL],id:[3,r.d.STRING],participant:[4,r.d.STRING]};var i={},s={},o={},u={},d={},c={},l={},p={},h={},f={},m={},v={},g={},_={},E={},b={},y={},S={},I={},w={},T={},A={},O={},M={},C={},R={},N={},k={},P={},G={},L={},D={},x={};i.internalSpec={filehash:[1,r.d.STRING],weight:[2,r.d.FLOAT]},s.internalSpec={emoji:[1,r.d.STRING],weight:[2,r.d.FLOAT]},o.internalSpec={timestamp:[1,r.d.INT64],starAction:[2,r.d.MESSAGE,D],contactAction:[3,r.d.MESSAGE,L],muteAction:[4,r.d.MESSAGE,G],pinAction:[5,r.d.MESSAGE,P],securityNotificationSetting:[6,r.d.MESSAGE,k],pushNameSetting:[7,r.d.MESSAGE,N],quickReplyAction:[8,r.d.MESSAGE,C],recentStickerWeightsAction:[9,r.d.MESSAGE,A],recentStickerMetadata:[10,r.d.MESSAGE,T],recentEmojiWeightsAction:[11,r.d.MESSAGE,w],labelEditAction:[14,r.d.MESSAGE,O],labelAssociationAction:[15,r.d.MESSAGE,M],localeSetting:[16,r.d.MESSAGE,R],archiveChatAction:[17,r.d.MESSAGE,S],deleteMessageForMeAction:[18,r.d.MESSAGE,y],keyExpiration:[19,r.d.MESSAGE,f],markChatAsReadAction:[20,r.d.MESSAGE,b],clearChatAction:[21,r.d.MESSAGE,E],deleteChatAction:[22,r.d.MESSAGE,_],unarchiveChatsSetting:[23,r.d.MESSAGE,g],primaryFeature:[24,r.d.MESSAGE,h],favoriteStickerAction:[25,r.d.MESSAGE,I],androidUnsupportedActions:[26,r.d.MESSAGE,p],agentAction:[27,r.d.MESSAGE,l],subscriptionAction:[28,r.d.MESSAGE,c],userStatusMuteAction:[29,r.d.MESSAGE,d],timeFormatAction:[30,r.d.MESSAGE,u]},u.internalSpec={isTwentyFourHourFormatEnabled:[1,r.d.BOOL]},d.internalSpec={muted:[1,r.d.BOOL]},c.internalSpec={isDeactivated:[1,r.d.BOOL],isAutoRenewing:[2,r.d.BOOL],expirationDate:[3,r.d.INT64]},l.internalSpec={name:[1,r.d.STRING],deviceID:[2,r.d.INT32],isDeleted:[3,r.d.BOOL]},p.internalSpec={allowed:[1,r.d.BOOL]},h.internalSpec={flags:[1,r.b.REPEATED|r.d.STRING]},f.internalSpec={expiredKeyEpoch:[1,r.d.INT32]},m.internalSpec={key:[1,r.d.MESSAGE,a],timestamp:[2,r.d.INT64]},v.internalSpec={lastMessageTimestamp:[1,r.d.INT64],lastSystemMessageTimestamp:[2,r.d.INT64],messages:[3,r.b.REPEATED|r.d.MESSAGE,m]},g.internalSpec={unarchiveChats:[1,r.d.BOOL]},_.internalSpec={messageRange:[1,r.d.MESSAGE,v]},E.internalSpec={messageRange:[1,r.d.MESSAGE,v]},b.internalSpec={read:[1,r.d.BOOL],messageRange:[2,r.d.MESSAGE,v]},y.internalSpec={deleteMedia:[1,r.d.BOOL],messageTimestamp:[2,r.d.INT64]},S.internalSpec={archived:[1,r.d.BOOL],messageRange:[2,r.d.MESSAGE,v]},I.internalSpec={directPath:[1,r.d.STRING],lastUploadTimestamp:[2,r.d.STRING],handle:[3,r.d.STRING],encFilehash:[4,r.d.STRING],stickerHashWithoutMeta:[5,r.d.STRING],mediaKey:[6,r.d.STRING],mediaKeyTimestamp:[7,r.d.INT64],isFavorite:[8,r.d.BOOL]},w.internalSpec={weights:[1,r.b.REPEATED|r.d.MESSAGE,s]},T.internalSpec={directPath:[1,r.d.STRING],encFilehash:[2,r.d.STRING],mediaKey:[3,r.d.STRING],stanzaId:[4,r.d.STRING],chatJid:[5,r.d.STRING],participant:[6,r.d.STRING],isSentByMe:[7,r.d.BOOL]},A.internalSpec={weights:[1,r.b.REPEATED|r.d.MESSAGE,i]},O.internalSpec={name:[1,r.d.STRING],color:[2,r.d.INT32],predefinedId:[3,r.d.INT32],deleted:[4,r.d.BOOL]},M.internalSpec={labeled:[1,r.d.BOOL]},C.internalSpec={shortcut:[1,r.d.STRING],message:[2,r.d.STRING],keywords:[3,r.b.REPEATED|r.d.STRING],count:[4,r.d.INT32],deleted:[5,r.d.BOOL]},R.internalSpec={locale:[1,r.d.STRING]},N.internalSpec={name:[1,r.d.STRING]},k.internalSpec={showNotification:[1,r.d.BOOL]},P.internalSpec={pinned:[1,r.d.BOOL]},G.internalSpec={muted:[1,r.d.BOOL],muteEndTimestamp:[2,r.d.INT64]},L.internalSpec={fullName:[1,r.d.STRING],firstName:[2,r.d.STRING]},D.internalSpec={starred:[1,r.d.BOOL]},x.internalSpec={index:[1,r.d.BYTES],value:[2,r.d.MESSAGE,o],padding:[3,r.d.BYTES],version:[4,r.d.INT32]}},,,,,,,,function(e,t,n){n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return u})),n.d(t,"a",(function(){return d}));var r=n(88),a=n(7),i=n(72),s=(0,a.m)();function o(e){var t=e.hasChildren()?e.mapChildren(o):[],n=[];return e.forEachAttributeKey(t=>{n.push((function(e,t){return{key:e,value:t}})(t,e.attrString(t)))}),{tag:e.tag(),content:e.hasContent()?e.contentBytes():new Uint8Array(0),attrs:n,children:t}}function u(e){if(e.subType===i.b.JID){var t=e.user,n=e.domain;return i.c.create(t,n)}var r=e.user,a=e.agent,s=e.device;return i.c.createAD(r,a>=0?a:null,s>=0?s:null)}(0,a.l)(),(0,a.k)(),s.slice(1);var d=new r.b("callAckParser",e=>(e.assertTag("ack"),{stanzaObject:o(e)}))},function(e,t,n){n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o})),n.d(t,"c",(function(){return u}));var r=n(0),a=n(62),i=n(139),s={UNKNOWN:0,REVOKE:1,CIPHERTEXT:2,FUTUREPROOF:3,NON_VERIFIED_TRANSITION:4,UNVERIFIED_TRANSITION:5,VERIFIED_TRANSITION:6,VERIFIED_LOW_UNKNOWN:7,VERIFIED_HIGH:8,VERIFIED_INITIAL_UNKNOWN:9,VERIFIED_INITIAL_LOW:10,VERIFIED_INITIAL_HIGH:11,VERIFIED_TRANSITION_ANY_TO_NONE:12,VERIFIED_TRANSITION_ANY_TO_HIGH:13,VERIFIED_TRANSITION_HIGH_TO_LOW:14,VERIFIED_TRANSITION_HIGH_TO_UNKNOWN:15,VERIFIED_TRANSITION_UNKNOWN_TO_LOW:16,VERIFIED_TRANSITION_LOW_TO_UNKNOWN:17,VERIFIED_TRANSITION_NONE_TO_LOW:18,VERIFIED_TRANSITION_NONE_TO_UNKNOWN:19,GROUP_CREATE:20,GROUP_CHANGE_SUBJECT:21,GROUP_CHANGE_ICON:22,GROUP_CHANGE_INVITE_LINK:23,GROUP_CHANGE_DESCRIPTION:24,GROUP_CHANGE_RESTRICT:25,GROUP_CHANGE_ANNOUNCE:26,GROUP_PARTICIPANT_ADD:27,GROUP_PARTICIPANT_REMOVE:28,GROUP_PARTICIPANT_PROMOTE:29,GROUP_PARTICIPANT_DEMOTE:30,GROUP_PARTICIPANT_INVITE:31,GROUP_PARTICIPANT_LEAVE:32,GROUP_PARTICIPANT_CHANGE_NUMBER:33,BROADCAST_CREATE:34,BROADCAST_ADD:35,BROADCAST_REMOVE:36,GENERIC_NOTIFICATION:37,E2E_IDENTITY_CHANGED:38,E2E_ENCRYPTED:39,CALL_MISSED_VOICE:40,CALL_MISSED_VIDEO:41,INDIVIDUAL_CHANGE_NUMBER:42,GROUP_DELETE:43,GROUP_ANNOUNCE_MODE_MESSAGE_BOUNCE:44,CALL_MISSED_GROUP_VOICE:45,CALL_MISSED_GROUP_VIDEO:46,PAYMENT_CIPHERTEXT:47,PAYMENT_FUTUREPROOF:48,PAYMENT_TRANSACTION_STATUS_UPDATE_FAILED:49,PAYMENT_TRANSACTION_STATUS_UPDATE_REFUNDED:50,PAYMENT_TRANSACTION_STATUS_UPDATE_REFUND_FAILED:51,PAYMENT_TRANSACTION_STATUS_RECEIVER_PENDING_SETUP:52,PAYMENT_TRANSACTION_STATUS_RECEIVER_SUCCESS_AFTER_HICCUP:53,PAYMENT_ACTION_ACCOUNT_SETUP_REMINDER:54,PAYMENT_ACTION_SEND_PAYMENT_REMINDER:55,PAYMENT_ACTION_SEND_PAYMENT_INVITATION:56,PAYMENT_ACTION_REQUEST_DECLINED:57,PAYMENT_ACTION_REQUEST_EXPIRED:58,PAYMENT_ACTION_REQUEST_CANCELLED:59,BIZ_VERIFIED_TRANSITION_TOP_TO_BOTTOM:60,BIZ_VERIFIED_TRANSITION_BOTTOM_TO_TOP:61,BIZ_INTRO_TOP:62,BIZ_INTRO_BOTTOM:63,BIZ_NAME_CHANGE:64,BIZ_MOVE_TO_CONSUMER_APP:65,BIZ_TWO_TIER_MIGRATION_TOP:66,BIZ_TWO_TIER_MIGRATION_BOTTOM:67,OVERSIZED:68,GROUP_CHANGE_NO_FREQUENTLY_FORWARDED:69,GROUP_V4_ADD_INVITE_SENT:70,GROUP_PARTICIPANT_ADD_REQUEST_JOIN:71,CHANGE_EPHEMERAL_SETTING:72,E2E_DEVICE_CHANGED:73,VIEWED_ONCE:74,E2E_ENCRYPTED_NOW:75,BLUE_MSG_BSP_FB_TO_BSP_PREMISE:76,BLUE_MSG_BSP_FB_TO_SELF_FB:77,BLUE_MSG_BSP_FB_TO_SELF_PREMISE:78,BLUE_MSG_BSP_FB_UNVERIFIED:79,BLUE_MSG_BSP_FB_UNVERIFIED_TO_SELF_PREMISE_VERIFIED:80,BLUE_MSG_BSP_FB_VERIFIED:81,BLUE_MSG_BSP_FB_VERIFIED_TO_SELF_PREMISE_UNVERIFIED:82,BLUE_MSG_BSP_PREMISE_TO_SELF_PREMISE:83,BLUE_MSG_BSP_PREMISE_UNVERIFIED:84,BLUE_MSG_BSP_PREMISE_UNVERIFIED_TO_SELF_PREMISE_VERIFIED:85,BLUE_MSG_BSP_PREMISE_VERIFIED:86,BLUE_MSG_BSP_PREMISE_VERIFIED_TO_SELF_PREMISE_UNVERIFIED:87,BLUE_MSG_CONSUMER_TO_BSP_FB_UNVERIFIED:88,BLUE_MSG_CONSUMER_TO_BSP_PREMISE_UNVERIFIED:89,BLUE_MSG_CONSUMER_TO_SELF_FB_UNVERIFIED:90,BLUE_MSG_CONSUMER_TO_SELF_PREMISE_UNVERIFIED:91,BLUE_MSG_SELF_FB_TO_BSP_PREMISE:92,BLUE_MSG_SELF_FB_TO_SELF_PREMISE:93,BLUE_MSG_SELF_FB_UNVERIFIED:94,BLUE_MSG_SELF_FB_UNVERIFIED_TO_SELF_PREMISE_VERIFIED:95,BLUE_MSG_SELF_FB_VERIFIED:96,BLUE_MSG_SELF_FB_VERIFIED_TO_SELF_PREMISE_UNVERIFIED:97,BLUE_MSG_SELF_PREMISE_TO_BSP_PREMISE:98,BLUE_MSG_SELF_PREMISE_UNVERIFIED:99,BLUE_MSG_SELF_PREMISE_VERIFIED:100,BLUE_MSG_TO_BSP_FB:101,BLUE_MSG_TO_CONSUMER:102,BLUE_MSG_TO_SELF_FB:103,BLUE_MSG_UNVERIFIED_TO_BSP_FB_VERIFIED:104,BLUE_MSG_UNVERIFIED_TO_BSP_PREMISE_VERIFIED:105,BLUE_MSG_UNVERIFIED_TO_SELF_FB_VERIFIED:106,BLUE_MSG_UNVERIFIED_TO_VERIFIED:107,BLUE_MSG_VERIFIED_TO_BSP_FB_UNVERIFIED:108,BLUE_MSG_VERIFIED_TO_BSP_PREMISE_UNVERIFIED:109,BLUE_MSG_VERIFIED_TO_SELF_FB_UNVERIFIED:110,BLUE_MSG_VERIFIED_TO_UNVERIFIED:111,BLUE_MSG_BSP_FB_UNVERIFIED_TO_BSP_PREMISE_VERIFIED:112,BLUE_MSG_BSP_FB_UNVERIFIED_TO_SELF_FB_VERIFIED:113,BLUE_MSG_BSP_FB_VERIFIED_TO_BSP_PREMISE_UNVERIFIED:114,BLUE_MSG_BSP_FB_VERIFIED_TO_SELF_FB_UNVERIFIED:115,BLUE_MSG_SELF_FB_UNVERIFIED_TO_BSP_PREMISE_VERIFIED:116,BLUE_MSG_SELF_FB_VERIFIED_TO_BSP_PREMISE_UNVERIFIED:117,E2E_IDENTITY_UNAVAILABLE:118,GROUP_CREATING:119,GROUP_CREATE_FAILED:120,GROUP_BOUNCED:121,BLOCK_CONTACT:122,EPHEMERAL_SETTING_NOT_APPLIED:123,SYNC_FAILED:124,SYNCING:125,BIZ_PRIVACY_MODE_INIT_FB:126,BIZ_PRIVACY_MODE_INIT_BSP:127,BIZ_PRIVACY_MODE_TO_FB:128,BIZ_PRIVACY_MODE_TO_BSP:129,DISAPPEARING_MODE:130,E2E_DEVICE_FETCH_FAILED:131,ADMIN_REVOKE:132,GROUP_INVITE_LINK_GROWTH_LOCKED:133,COMMUNITY_LINK_PARENT_GROUP:134,COMMUNITY_LINK_SIBLING_GROUP:135,COMMUNITY_LINK_SUB_GROUP:136,COMMUNITY_UNLINK_PARENT_GROUP:137,COMMUNITY_UNLINK_SIBLING_GROUP:138,COMMUNITY_UNLINK_SUB_GROUP:139,GROUP_PARTICIPANT_ACCEPT:140,GROUP_PARTICIPANT_LINKED_GROUP_JOIN:141,COMMUNITY_CREATE:142},o={ERROR:0,PENDING:1,SERVER_ACK:2,DELIVERY_ACK:3,READ:4,PLAYED:5},u={},d={},c={},l={},p={},h={},f={},m={},v={};u.internalDefaults={status:o.PENDING},u.internalSpec={key:[1,r.b.REQUIRED|r.d.MESSAGE,i.a],message:[2,r.d.MESSAGE,a.g],messageTimestamp:[3,r.d.UINT64],status:[4,r.d.ENUM,o],participant:[5,r.d.STRING],messageC2STimestamp:[6,r.d.UINT64],ignore:[16,r.d.BOOL],starred:[17,r.d.BOOL],broadcast:[18,r.d.BOOL],pushName:[19,r.d.STRING],mediaCiphertextSha256:[20,r.d.BYTES],multicast:[21,r.d.BOOL],urlText:[22,r.d.BOOL],urlNumber:[23,r.d.BOOL],messageStubType:[24,r.d.ENUM,s],clearMedia:[25,r.d.BOOL],messageStubParameters:[26,r.b.REPEATED|r.d.STRING],duration:[27,r.d.UINT32],labels:[28,r.b.REPEATED|r.d.STRING],paymentInfo:[29,r.d.MESSAGE,d],finalLiveLocation:[30,r.d.MESSAGE,a.e],quotedPaymentInfo:[31,r.d.MESSAGE,d],ephemeralStartTimestamp:[32,r.d.UINT64],ephemeralDuration:[33,r.d.UINT32],ephemeralOffToOn:[34,r.d.BOOL],ephemeralOutOfSync:[35,r.d.BOOL],bizPrivacyStatus:[36,r.d.ENUM,{E2EE:0,FB:2,BSP:1,BSP_AND_FB:3}],verifiedBizName:[37,r.d.STRING],mediaData:[38,r.d.MESSAGE,c],photoChange:[39,r.d.MESSAGE,l],userReceipt:[40,r.b.REPEATED|r.d.MESSAGE,h],reactions:[41,r.b.REPEATED|r.d.MESSAGE,f],quotedStickerData:[42,r.d.MESSAGE,c],futureproofData:[43,r.d.BYTES],statusPsa:[44,r.d.MESSAGE,p],pollUpdates:[45,r.b.REPEATED|r.d.MESSAGE,m],pollAdditionalMetadata:[46,r.d.MESSAGE,v],agentId:[47,r.d.STRING],statusAlreadyViewed:[48,r.d.BOOL],messageSecret:[49,r.d.BYTES]},d.internalSpec={currencyDeprecated:[1,r.d.ENUM,{UNKNOWN_CURRENCY:0,INR:1}],amount1000:[2,r.d.UINT64],receiverJid:[3,r.d.STRING],status:[4,r.d.ENUM,{UNKNOWN_STATUS:0,PROCESSING:1,SENT:2,NEED_TO_ACCEPT:3,COMPLETE:4,COULD_NOT_COMPLETE:5,REFUNDED:6,EXPIRED:7,REJECTED:8,CANCELLED:9,WAITING_FOR_PAYER:10,WAITING:11}],transactionTimestamp:[5,r.d.UINT64],requestMessageKey:[6,r.d.MESSAGE,i.a],expiryTimestamp:[7,r.d.UINT64],futureproofed:[8,r.d.BOOL],currency:[9,r.d.STRING],txnStatus:[10,r.d.ENUM,{UNKNOWN:0,PENDING_SETUP:1,PENDING_RECEIVER_SETUP:2,INIT:3,SUCCESS:4,COMPLETED:5,FAILED:6,FAILED_RISK:7,FAILED_PROCESSING:8,FAILED_RECEIVER_PROCESSING:9,FAILED_DA:10,FAILED_DA_FINAL:11,REFUNDED_TXN:12,REFUND_FAILED:13,REFUND_FAILED_PROCESSING:14,REFUND_FAILED_DA:15,EXPIRED_TXN:16,AUTH_CANCELED:17,AUTH_CANCEL_FAILED_PROCESSING:18,AUTH_CANCEL_FAILED:19,COLLECT_INIT:20,COLLECT_SUCCESS:21,COLLECT_FAILED:22,COLLECT_FAILED_RISK:23,COLLECT_REJECTED:24,COLLECT_EXPIRED:25,COLLECT_CANCELED:26,COLLECT_CANCELLING:27,IN_REVIEW:28,REVERSAL_SUCCESS:29,REVERSAL_PENDING:30,REFUND_PENDING:31}],useNoviFiatFormat:[11,r.d.BOOL],primaryAmount:[12,r.d.MESSAGE,a.h],exchangeAmount:[13,r.d.MESSAGE,a.h]},r.d.UINT64,r.d.UINT32,r.d.UINT32,r.b.REPEATED,r.d.MESSAGE,r.d.MESSAGE,i.a,r.d.MESSAGE,a.g,r.d.UINT64,r.d.STRING,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,r.d.ENUM,c.internalSpec={localPath:[1,r.d.STRING]},l.internalSpec={oldPhoto:[1,r.d.BYTES],newPhoto:[2,r.d.BYTES],newPhotoId:[3,r.d.UINT32]},p.internalSpec={campaignId:[44,r.b.REQUIRED|r.d.UINT64],campaignExpirationTimestamp:[45,r.d.UINT64]},h.internalSpec={userJid:[1,r.b.REQUIRED|r.d.STRING],receiptTimestamp:[2,r.d.INT64],readTimestamp:[3,r.d.INT64],playedTimestamp:[4,r.d.INT64],pendingDeviceJid:[5,r.b.REPEATED|r.d.STRING],deliveredDeviceJid:[6,r.b.REPEATED|r.d.STRING]},f.internalSpec={key:[1,r.d.MESSAGE,i.a],text:[2,r.d.STRING],groupingKey:[3,r.d.STRING],senderTimestampMs:[4,r.d.INT64],unread:[5,r.d.BOOL]},m.internalSpec={pollUpdateMessageKey:[1,r.d.MESSAGE,i.a],vote:[2,r.d.MESSAGE,a.f]},v.internalSpec={pollInvalidated:[1,r.d.BOOL]}},function(e,t,n){n.r(t),n.d(t,"parseUSyncDevices",(function(){return g})),n.d(t,"syncDeviceList",(function(){return E})),n.d(t,"getDevicesNode",(function(){return y}));var r=n(75),a=n(29),i=n(17),s=n(63),o=n(4),u=n(28),d=n(46),c=n(11),l=n(6),p=n(189),h=n(60),f=n(111),m=n(304),v=n(23);function g(e){var t=e.maybeChild("device-list"),n=e.maybeChild("key-index-list");if(n&&n.hasContent())try{var r=n.attrTime("ts"),a=n.maybeAttrInt("expected_ts");return null==t?{type:"adv_list",adv:(0,f.c)(n.contentBytes()),stanzaTs:r,expectedTs:a}:{type:"adv_list_and_devices",devices:t.mapChildrenWithTag("device",e=>({id:e.attrDeviceId("id"),index:(0,h.g)(e,"key-index")||h.b})),adv:(0,f.c)(n.contentBytes()),stanzaTs:r,expectedTs:a}}catch(e){return __LOG__(4)`Error while processing usync devices: ${e}`,SEND_LOGS("usync-devices"),null}else if(t){var i=t.mapChildrenWithTag("device",e=>e.attrDeviceId("id"));if(0===i.length||1===i.length&&i[0]===c.c)return{type:"primary_only"}}return null}var _=new d.a("syncDeviceListResponse",e=>{return e.assertAttr("type","result"),t=e.child("usync"),n=new Map,t.child("list").forEachChildWithTag("user",e=>{if(e.hasChild("devices")){var t=g(e.child("devices"));t&&n.set(e.attrPhoneUserJid("jid"),t)}}),n;var t,n});function E(e){var t=(0,m.a)(Array.from(e));return(0,s.c)(e).then(t=>{var n=l.r.get(),r=new Map(t.map(e=>[e.jid,e]));return Promise.all(e.map(e=>{if(e!==n)return(function(e,t){return t?Promise.resolve(y(t)).then(t=>(0,o.v)("user",{jid:(0,o.g)(e)},t)):(0,o.v)("user",{jid:(0,o.g)(e)})})(e,r.get(e))}))}).then(n=>{var r=(0,o.v)("iq",{to:o.k,id:(0,o.t)(),type:"get",xmlns:"usync"},(0,o.v)("usync",{sid:(0,o.t)(),index:"0",last:"true",mode:"full",context:"background"},(0,o.v)("query",null,(0,o.v)("devices",{version:"2"})),(0,o.v)("list",null,n)));return(0,u.e)(r,_).then(n=>{if(!n.success)throw __LOG__(4)`Error while syncing device list for ${e}`,new Error("Error while syncing device list");return t.then(()=>(0,f.i)(n.result).then(e=>{var t=[];return e.forEach((e,n)=>{t.push((0,a.y)(n,e).then(()=>(0,i.ob)(n,{usyncResponse:e})))}),Promise.all(t).then(()=>{})}))})})}function b(e,t,n){var r;return r=(0,v.a)("adv_v2_m4_m5")&&t&&n&&n>t?(0,o.f)(n):o.d,(0,o.v)("devices",{device_hash:(0,o.b)(e),ts:t?(0,o.f)(t):o.d,expected_ts:r})}function y(e){var t=e.deviceVerification?e.deviceVerification.timestamp:null,n=e.deviceVerification?e.deviceVerification.expectedTs:null;if(e.phash)return Promise.resolve(b(e.phash,t,n));var r=(0,h.c)(e);return(0,p.a)(r).then(e=>b(e,t,n))}t.default=(0,r.c)().finalStep("syncDeviceList",e=>E(e.users)).end()},function(e,t,n){n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return c}));var r=n(27),a=n.n(r);function i(e,t,n){for(var r=[],i=[],s=0,o=(function(){var n=a()((function*(){for(;s<e;){var n=s;s++,i[n]=yield t(n)}}));return function(){return n.apply(this,arguments)}})(),u=Math.min(e,n),d=0;d<u;d++)r.push(o());return Promise.all(r).then(()=>i)}var s=n(129);function o(e){return"video"===e}var u=10,d=65536;function c(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=t.buffer.byteLength,a=Math.ceil((r-16)/d),o=new Uint8Array(u*a);return i(a,n=>{var r=n*d,a=r+16+d,i=t.subarray(r,a);return(0,s.f)(e,i).then(e=>{var t=new Uint8Array(e,0,u);o.set(t,n*u)})},n).then(()=>o.buffer)}},,function(e,t,n){n.r(t),n.d(t,"default",(function(){return c})),n.d(t,"sendPing",(function(){return p}));var r=n(88),a=n(3),i=n(6),s=n(12),o=n(28),u=n(4),d=new r.b("successParser",e=>(e.assertTag("success"),{ts:e.attrTime("t"),props:e.attrInt("props")}));function c(e){var t=d.parse(e);if(t.error)__LOG__(4)`handleSuccess: failed to parse ${t.error}`;else{var n=t.success;h(n.ts),i.E.get().serverPropsVersion<n.props&&(0,s.c)("backend","syncServerProps",{})}return"NO_ACK"}var l=new r.b("ping",e=>e.attrTime("t"));function p(){var e=(0,u.v)("iq",{to:u.k,xmlns:"w:p",type:"get",id:(0,u.t)()},(0,u.v)("ping",null));(0,o.i)(e,l).then(e=>{e&&e.success&&h(e.result)})}function h(e){var t=Math.round(Date.now()/1e3-e);(0,a.A)(t),i.f.set(t),(0,s.c)("event","clockSkewUpdated",{clockSkew:t})}},function(e,t,n){n.r(t),n.d(t,"queryGroupInfoFromCode",(function(){return f})),n.d(t,"queryGroupInviteCode",(function(){return _})),n.d(t,"resetGroupInviteCode",(function(){return y}));var r=n(28),a=n(4),i=n(75),s=n(46),o=n(237),u=n(83),d=n(218),c=n(201),l=n(3),p={"growth-locked":["436",o.a]},h=(0,u.a)("errorJoinGroupViaInviteParser",{401:"removed",404:"group-not-found",406:"invalid-link",410:"invite-link-reset",419:"too-many-participants",500:"unknown"},p);function f(e){var t=(0,a.v)("iq",{to:a.e,type:"get",xmlns:"w:g2",id:(0,a.t)()},(0,a.v)("invite",{code:(0,a.b)(e)}));return(0,r.f)(t,d.simpleQueryGroupParser,h).then(e=>e.success?(0,d.buildSimpleGroupResult)(e.result):e.customError)}var m={"growth-locked":["436",o.a]},v=(0,u.a)("inviteCodeErrorParser",{400:"bad-request",404:"group-not-found",401:"not-admin",403:"not-participant",423:"locked",500:"unknown"},m),g=new s.a("queryGroupInviteCodeParser",e=>({code:e.child("invite").attrString("code")}));function _(e){var t=(0,a.t)(),n=(0,a.v)("iq",{to:(0,a.g)(e),type:"get",xmlns:"w:g2",id:t},(0,a.v)("invite",null));return(0,r.f)(n,g,v).then(n=>{if(!n.success){var r=n.customError;if("growth-locked"===r.error.reason){var a=r.error;return(0,c.k)(e,{id:t,ts:(0,l.E)(),growthLocked:a.extra}).then(()=>r)}return r}var i=n.result;return(0,c.l)(e,{id:t,ts:(0,l.E)()}).then(()=>({result:{code:i.code}}))})}var E={"growth-locked":["436",o.a]},b=(0,u.a)("revokeInviteCodeErrorParser",{400:"bad-request",404:"group-not-found",401:"not-admin",403:"not-participant",423:"locked",429:"rate-limited",500:"unknown"},E),y=(0,i.c)().finalStep("revokeGroupInviteCode",e=>{return t=e.groupJid,n=(0,a.t)(),i=(0,a.v)("iq",{to:(0,a.g)(t),type:"set",xmlns:"w:g2",id:n},(0,a.v)("invite",null)),(0,r.f)(i,g,b).then(e=>{if(!e.success){var r=e.customError;if("growth-locked"===r.error.reason){var a=r.error;return(0,c.k)(t,{id:n,ts:(0,l.E)(),growthLocked:a.extra}).then(()=>r)}return e.customError}var i=e.result;return(0,c.l)(t,{id:n,ts:(0,l.E)()}).then(()=>({result:{code:i.code}}))});var t,n,i}).end()},,,,,function(e,t,n){n.d(t,"j",(function(){return P})),n.d(t,"b",(function(){return G})),n.d(t,"d",(function(){return D})),n.d(t,"c",(function(){return B})),n.d(t,"e",(function(){return K})),n.d(t,"f",(function(){return H})),n.d(t,"g",(function(){return $})),n.d(t,"h",(function(){return q})),n.d(t,"i",(function(){return z})),n.d(t,"a",(function(){return J}));var r=n(27),a=n.n(r),i=n(2),s=n(71),o=n(17),u=n(28),d=n(150),c=n(4),l=n(29),p=n(75),h=n(189),f=n(21),m=n(7),v=n(11),g=n(30),_=n(16),E=n(6),b=n(3),y=n(168),S=n(288),I=n(199),w=n(46),T=n(195),A=n(136),O=n(24),M=n(229),C=n(104),R=(n(169),n(23)),N=n(236),k=n(223);function P(e,t){if(null!=e.quoted)return{preview:t}}function G(e,t,n,r,a){return(0,m.x)(e,{user:e=>D(e,t,n,r,P(n,a)),group:e=>(function(e,t,n,r,a){return j({jid:e,to:t,msg:n,media:r,quote:a})})(e,t,n,r,P(n,a))})}var L=new w.a("sendMsgAck",e=>(e.assertTag("ack"),{phash:e.maybeAttrString("phash"),ts:e.attrTime("t"),errorCode:e.maybeAttrInt("error")}));function D(e,t,n,r,a,i,s){return x.apply(this,arguments)}function x(){return(x=a()((function*(e,t,n,r,a,s,d){if(e===E.r.get()){__LOG__(2)`encryptAndSendUserMsg self-send`;var l=(0,b.E)();return yield(0,o.Qb)(n.id,n.expiration,l,new Map),yield(0,o.Oc)([n.externalId],e,(0,m.e)(e),l,"none"===E.j.get().readReceipts?i.a.RECEIVED:i.a.READ),"skip-self"}var v,S,w="sender-backfill"===s,T=(0,m.e)(E.r.get()),O=new Map;if(t.length>1||w){var M=yield(0,A.a)(t,n,r,a,w&&d?{ids:d,type:"primary"}:void 0);if(w&&0===M.nodes.length)return"skip-sender-backfill";v=(0,c.v)("participants",null,M.nodes),S=(0,h.a)(t.concat(T)),O=M.identityIds}else{var C=yield(0,y.e)(e,n,r,a),P=(0,m.e)(e),G=yield K(P,C),D=G.type,x=G.ciphertext,F=G.identityId,B=(0,I.a)(n);v=(0,A.c)(D,x,B),S=(0,h.a)([P,T]),F&&(O=new Map).set(P,F)}var j,V=(0,c.v)("message",{id:(0,c.b)(n.externalId),to:(0,c.g)(e),type:(0,I.b)(n),edit:J(n),device_fanout:w?(0,c.b)("false"):p.a},$(n),q(n),z(n),v),H=yield U(O,[(0,m.e)(e)]),Y=yield(0,u.k)(V,{id:n.externalId,class:"message",from:e,participant:null}),W=L.parse(Y);if(W.error&&(__LOG__(4)`sendWrittenMsg failed to parse ack`,SEND_LOGS("sendWrittenMsg-one-to-one-ack-failed")),W.success&&403===W.success.errorCode)return E.E.get().mdBlocklistV2?(0,g.b)().fireAndForget(_.e.getBlocklistV2()):(0,g.b)().fireAndForget(_.e.getBlocklist()),yield(0,o.dd)(n.id,i.a.FAILED),"error";if(W.success&&W.success.phash&&!w){var Z=yield S;if(Z!==W.success.phash){var Q=n.type===i.f.REVOKED;if(WAM.log("regular",2180,void 0,[2,1,Q,1,0,1]),Q){var X=f.i(t)?f.l((0,m.e)(e)):t;return(0,g.b)().waitUntilPersisted(_.e.resendWrittenRevokeMsg(n.rowId,e,X,Z)).then(()=>"skip-revoke")}(0,g.b)().waitUntilPersisted(_.e.senderBackfill(n.rowId,e,t,W.success.ts,H))}}if(w)W.success&&(yield(0,o.Sb)(n.externalId,e,t,W.success.ts));else if(yield(0,o.Qb)(n.id,n.expiration,null==(j=W.success)?void 0:j.ts,O||new Map),(0,R.a)("trusted_contacts_sender")){var ee=yield(0,N.c)(e);ee&&!(0,k.a)(ee)||(yield(0,g.b)().waitUntilPersisted(_.e.refreshTrustedContactSenderToken(e,n.ts)))}return"sent"}))).apply(this,arguments)}function U(e,t){return F.apply(this,arguments)}function F(){return(F=a()((function*(e,t){var n=new Map;if(e.size>0)e.forEach((e,t)=>{(0,m.r)(t)&&n.set(t,e)});else{var r=t.filter(m.r);n=yield(0,l.t)(r)}return n}))).apply(this,arguments)}function B(e,t,n){return j({jid:v.h,to:e,msg:t,media:n})}function j(e){return V.apply(this,arguments)}function V(){return(V=a()((function*(e){var t=e.to,n=e.msg,r=e.jid,a=e.media;if(0===t.length)return __LOG__(2)`encryptAndSendMultiReceipientMsg empty group`,yield(0,o.dd)(n.id,i.a.READ),"skip-self";var s,d,b=(0,I.a)(n),w=(0,h.a)(t.concat((0,m.e)(E.r.get()))),T=yield W(r),R=T?T.knowsSenderKey:new Map,N=!f.b(t,f.m(Array.from(R.keys()))),k=null,P=new Map;if(N)d=(k=yield(0,A.a)(t,n,a,null!=e.quote?e.quote:null)).nodes,s=(0,A.c)("none",null,b),P=k.identityIds;else{var G,D=yield(0,l.s)(r),x=[],F=[],B=new Set;if(R.forEach((e,t)=>{if(e)F.push(t);else if(x.push(t),(0,m.r)(t)){var n=(0,m.h)(t);B.add(n)}}),x.length>0){var j={senderKeyDistributionMessage:{groupId:r,axolotlSenderKeyDistributionMessage:D}};d=(k=yield(0,A.b)(f.m(x),j)).nodes}if(P=yield(0,l.t)(t),r===v.h&&F.length>0){var V=d||[];F.forEach(e=>{var t=(0,m.h)(e);if(!B.has(t)){B.add(t);var n=(0,m.e)(t);V.push((0,c.v)("to",{jid:(0,c.g)(n)}))}}),d=V}G=(0,O.k)(n)?yield(0,S.a)(n,a):yield(0,y.b)(n,a,null!=e.quote?e.quote:null);var K=(0,A.d)(G),H=yield(0,l.n)(r,K),Y=H.type,Z=H.ciphertext;(0,M.b)({type:Y,destination:{type:"multicast",to:r},messageMediaType:(0,C.e)(G),e2eSuccessful:!0}),s=(0,A.c)(Y,Z,b)}var Q=null;d&&d.length&&(Q=(0,c.v)("participants",null,[...d]));var X,ee=n.expiration,te=yield w,ne=(0,c.v)("message",{id:(0,c.b)(n.externalId),to:(0,c.g)(r),phash:(0,c.b)(te),type:(0,I.b)(n),edit:J(n),expiration:null!=ee?(0,c.f)(ee):p.a},$(n),q(n),z(n),Q,s),re=yield(0,u.k)(ne,{id:n.externalId,class:"message",from:r,participant:null}),ae=L.parse(re);if(ae.success&&ae.success.phash&&ae.success.phash!==te){var ie=n.type===i.f.REVOKED,se=r===v.h?3:2;if(WAM.log("regular",2180,void 0,[2,1,ie,1,0,se]),ie)return(0,g.b)().waitUntilPersisted(_.e.resendWrittenRevokeMsg(n.rowId,r,t,te)).then(()=>"skip-revoke");var oe=yield U(P,t);(0,g.b)().waitUntilPersisted(_.e.senderBackfill(n.rowId,r,t,ae.success.ts,oe)).then(()=>{var e=(0,m.p)(r);e&&(0,g.b)().fireAndForget(_.e.queryGroup(e,"phash",te))})}if(ae.error)__LOG__(4)`sendWrittenMsg: Error ack received ${ae.error}`;else{if(null!=ae.success.errorCode)return yield(0,o.dd)(n.id,i.a.FAILED),"error";X=ae.success.ts}return yield(0,o.Pb)(n.id,T,N,t,ee,X,P),"sent"}))).apply(this,arguments)}function K(e,t,n){var r=(0,A.d)(t);return(0,d.ensureE2eSession)(e).then(()=>(0,l.o)(e,r).then(r=>((0,M.b)({type:r.type,destination:{type:"user",to:e},messageMediaType:(0,C.e)(t),e2eSuccessful:!0,retryCount:n}),r)))}function H(e){var t=e.jid,n=e.proto,r=e.identityId,a=e.retryCount,i=e.checkPrimary,s=(0,A.d)(n);return(0,d.ensureE2eSession)(t).then(()=>(0,l.p)(t,s,r,i).then(e=>(null!=e&&(0,M.b)({type:e.type,destination:{type:"user",to:t},messageMediaType:(0,C.e)(n),e2eSuccessful:!0,retryCount:a}),e)))}function $(e){return e.isMulticast?(0,c.v)("multicast",null):null}function q(e){return e.urlNumber?(0,c.v)("url_number",null):null}function z(e){return e.urlText?(0,c.v)("url_text",null):null}function J(e){return e.type===i.f.REVOKED?(0,c.b)("7"):p.a}var Y=new s.a;function W(e){return Y.enqueue(a()((function*(){var t=yield(0,o.Z)(e);return t?(0,T.b)(t)?(yield(0,l.c)(e),(0,o.mc)(e)):t:null})))}},,,,,function(e,t,n){n.d(t,"b",(function(){return h})),n.d(t,"c",(function(){return f})),n.d(t,"e",(function(){return m})),n.d(t,"a",(function(){return v})),n.d(t,"d",(function(){return g}));var r=n(4),a=n(6),i=n(328),s=n(62),o=n(7),u=n(349),d=n(36),c=n(34),l=n(136),p=n(28);function h(e){var t={deviceId:e,syncStage:"historySync",syncType:i.b.INITIAL_BOOTSTRAP};return a.c.set(t).then(()=>{})}function f(){return a.c.get()}function m(e){var t=a.c.get();return!!t&&t.stanzaId===e}function v(){return a.c.set({})}function g(e,t,n){var h={protocolMessage:t},f=(0,o.A)(a.r.get(),e);return(0,u.e)(f,h).then(o=>{var u=o.type,h=o.ciphertext,m=(0,d.e)((0,c.l)(7)),v=(0,r.v)("message",{id:(0,r.b)(m),to:(0,r.g)(f),type:(0,r.b)("text")},(0,l.c)(u,h));return(0,p.l)(v,{id:m,class:"message",from:f,participant:null}).then(()=>{if(t.type===s.c.HISTORY_SYNC_NOTIFICATION){var r,o=null==(r=t.historySyncNotification)?void 0:r.syncType,u={deviceId:e,stanzaId:m,syncStage:"historySync",syncType:o};return o===i.b.RECENT&&(u=Object.assign({},u,n)),(function(e){var t=a.c.get();return t&&t.deviceId===e.deviceId?a.c.set(Object.assign({},e)):Promise.resolve()})(u).then(()=>{})}})})}},,,,,,function(e,t,n){n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s}));var r=n(6),a=n(2);function i(e,t){var n=e.attrString(t);n!==r.r.get()&&e.throw(`to have "${t}"={me} (${r.r.get()}), but instead has "${n}"`)}function s(e,t){if(!e.hasAttr(t))return a.c;var n=e.attrPhoneUserJid(t);return n===r.r.get()?a.b:n}},,,,,,function(e,t,n){function r(e){return(self.simpleVerifyMp4FileIntegrity?Promise.resolve():n.e(177).then(n.t.bind(null,447,7))).then(()=>self.simpleVerifyMp4FileIntegrity("file.bin",e)).then(e=>{if(null!=e.error)return __LOG__(3)`mp4Check error code: ${e.error}`,{type:"error",error:"format_error"};var t=e.info.video||null;if(t){var n=t.rotation%360;n<0&&(n+=360),t.rotation=n}return t&&t.rotation%90!=0&&(__LOG__(4)`mp4Check video has non-90 rotation ${t.rotation}`,t.rotation=null),{type:"success",info:{video:t,audio:null}}},e=>(__LOG__(3)`mp4Check internal error: ${e}`,{type:"error",error:"format_error"}))}n.d(t,"a",(function(){return r}))},,,,,,,,,function(e,t,n){n.d(t,"a",(function(){return i}));var r=n(0),a={},i={};a.internalSpec={publicKey:[1,r.d.BYTES],identifier:[2,r.d.BYTES]},i.internalSpec={version:[1,r.d.UINT32],localFingerprint:[2,r.d.MESSAGE,a],remoteFingerprint:[3,r.d.MESSAGE,a]}},function(e,t,n){n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s}));var r=n(12),a="unknown";function i(e){a=e}function s(){return"unknown"===a?(0,r.d)():a}},function(e,t,n){n.r(t),n.d(t,"handlePreKeysLow",(function(){return b}));var r=n(9),a=n.n(r),i=n(88),s=n(4),o=n(28),u=n(29),d=n(115),c=n(109),l=n(235),p=n(242),h=n(122),f=new Set,m={error:!1,result:!0},v={algo:{type:"fibonacci",first:1e3,second:2e3},max:61e4},g=new i.b("setPreKeysResult",e=>{e.assertTag("iq"),e.assertFromServer();var t=e.attrEnum("type",m);if(t)return{success:t};var n=e.child("error");return{success:!1,errorCode:n.attrInt("code"),errorMsg:n.maybeAttrString("text")||""}}),_=(0,d.b)(()=>{var e=new l.a({name:"uploadPreKeys",timer:v,code:e=>(__LOG__(2)`uploadPreKeys running`,((0,u.r)(),Promise.all([(0,u.G)(),(0,u.b)()]).then(e=>{var t=a()(e,2),n=t[0],r=n.regId,i=n.staticPublicKey,d=n.signedPreKey,l=t[1],f=l.preKeys,m=l.lastId,v=(0,s.v)("iq",{id:(0,s.t)(),xmlns:"encrypt",type:"set",to:s.k},(0,s.v)("registration",null,(0,s.a)(r)),(0,s.v)("type",null,""),(0,s.v)("identity",null,i),(0,s.v)("list",null,f.map(p.a)),(0,p.b)(d));return(0,o.p)().then(()=>(0,u.D)(m)).then(()=>(0,o.h)(v,g)).then(e=>{if(e.success)return __LOG__(2)`uploadPreKeys success`,!0;var t=e.errorCode;return t>=500?__LOG__(2)`uploadPreKeys server requested backoff ${t}`:406===t?__LOG__(4)`uploadPreKeys uploaded invalid keys`:__LOG__(4)`uploadPreKeys unrecognized error ${t}`,!1}).catch((0,h.a)(c.a,()=>(__LOG__(2)`_uploadPreKeys disconnected, unclear if on server`,!1)))})).then(t=>{t&&e(),__LOG__(2)`uploadPreKeys retrying (after delay)`}))});return e.start(),e.promise()});t.default=_;var E=new i.b("preKeysLow",e=>(e.assertTag("notification"),e.assertAttr("type","encrypt"),e.assertFromServer(),{stanzaId:e.attrString("id"),numRemaining:e.child("count").attrInt("value")})),b=(0,i.c)("handlePreKeysLow",E,(e,t)=>{var n=e.stanzaId,r=(0,s.v)("ack",{to:s.k,id:(0,s.b)(n),class:"notification"});return f.has(t)?r:(f.add(t),_().then(()=>r).finally(()=>{f.delete(t)}))})},,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){function r(e,t){for(var n=[],r=0;e.length>r;)n.push(e.slice(r,r+t)),r+=t;return n}n.d(t,"a",(function(){return r}))},function(e,t,n){n.d(t,"a",(function(){return o}));var r=n(2),a=n(6),i=n(7),s=n(33);function o(e,t){var n=t.text,o=t.senderTimestampMs,u=t.groupingKey,d=t.key;if(o&&d&&d.id){var c=""===n?void 0:n;if(void 0===c||c.length<=30)if(e.edit===s.a||e.edit===s.b)if(e.edit!==s.a||void 0===c){var l=e.jid,p=(0,i.h)(e.author),h=(function(e,t,n){var s=n.remoteJid,o=n.participant,u=n.id,d=n.fromMe;if(s&&u){var c=(0,i.o)(s),l=a.r.get();if("phoneUser"===c.jidType)return c.userJid!==l||t!==e?void __LOG__(4)`Received reaction with invalid info`:{msgAuthor:d?t:r.b,msgExternalId:u};if("group"===c.jidType){if(!o||n.remoteJid!==e||d&&t!==o)return void __LOG__(4)`Received reaction for group with invalid info`;var p=(0,i.o)(o);if("phoneUser"!==p.jidType)return void __LOG__(4)`Received reaction with invalid participant`;var h=p.userJid;return{msgAuthor:h===l?r.b:h,msgExternalId:u}}return c.jidType,void __LOG__(4)`Received reaction with invalid remote jid ${s}`}__LOG__(4)`Received reaction with empty remotejid`})(l,p,d);if(h){var f=h.msgAuthor;return{msgRef:{msgExternalId:h.msgExternalId,msgAuthor:f},content:{externalId:e.externalId,ts:e.ts,chatJid:l,author:p,text:c,groupingKey:u,senderTimestampMs:o}}}}else __LOG__(4)`Received revoked reaction with content`;else __LOG__(4)`Received reaction with invalid edit`;else __LOG__(4)`Invalid reaction content`}else __LOG__(4)`Received reaction without enough data`}},function(e,t,n){n.d(t,"a",(function(){return _}));var r=n(62),a=n(11),i=n(7),s=n(2),o=n(3),u=n(33),d=n(39),c=n(10),l=n(154),p=n(302),h=n(214),f=n(37),m=n(49),v=n(34),g=n(43);function _(e,t,n){var o=e.proto,g=(0,h.b)(o);if(!g)return null;var _,y=(function(e,t){var n=e.ts,r="@psa"===e.author?"@psa":(0,i.h)(e.author),o="@psa"===e.author?a.c:(0,i.f)(e.author),u={externalId:e.externalId,ts:n,author:r,deviceId:o,ack:s.a.RECEIVED,altIndex:"",campaignId:e.campaignId,campaignDuration:e.campaignDuration},d=(0,h.a)(t);if(d){var c=d.actionLink;return c&&c.url&&c.buttonTitle&&(u.actionLink={url:c.url,buttonTitle:c.buttonTitle}),(0,l.c)(u,d)}return u})(e,g),S=null;switch(g.type){case"conversation":_=Object.assign({type:f.c.TEXT,text:g.value},y);break;case"extendedTextMessage":var I=(function(e,t,n){var r=(0,m.i)(t.author),a=(0,l.e)(e,r);if(a){var i,s=a.content,o=a.preview,u=Object.assign({type:f.c.TEXT},s,t,{font:e.font,textColor:e.textArgb,backgroundColor:(i=e.backgroundArgb,i?((0,c.x)(d.e).includes(i)||__LOG__(3)`Unrecognized color value for status ${i}`,i):(__LOG__(4)`Unexpected empty background argb for status`,void SEND_LOGS("empty-background-argb")))});return n&&(u.fromFb=!0),{msg:u,media:o?{preview:o}:void 0}}})(g.value,y,n);I&&(_=I.msg,S=I.media);break;case"imageMessage":var w=(function(e,t,n){var r=(0,l.f)(e,t.ts,b);if(r){var a=Object.assign({},r.content,t,{media:void 0}),i={entry:r.media.mediaEntry,plaintextHash:r.media.plaintextHash,preview:r.preview||null};return n&&(a.text=n),e.interactiveAnnotations&&(a.interactiveAnnotations=e.interactiveAnnotations),E(i,e),{msg:a,media:i}}})(g.value,y,t);w&&(_=w.msg,S=w.media);break;case"videoMessage":var T=g.value;if(T.gifPlayback){var A=(function(e,t,n){var r=(0,l.g)(e,t.ts,u.c.GIF,b);if(r){var a=Object.assign({type:f.c.GIF},r.content,t,{media:void 0}),i={entry:r.media.mediaEntry,plaintextHash:r.media.plaintextHash,preview:r.preview||null};return n&&(a.text=n),e.interactiveAnnotations&&(a.interactiveAnnotations=e.interactiveAnnotations),E(i,e),{msg:a,media:i}}})(T,y,t);A&&(_=A.msg,S=A.media)}else{var O=(function(e,t,n){var r=(0,l.g)(e,t.ts,u.c.VIDEO,b);if(r){var a=Object.assign({type:f.c.VIDEO},r.content,t,{media:void 0}),i={entry:r.media.mediaEntry,plaintextHash:r.media.plaintextHash,preview:r.preview||null};return n&&(a.text=n),e.interactiveAnnotations&&(a.interactiveAnnotations=e.interactiveAnnotations),E(i,e),{msg:a,media:i}}})(T,y,t);O&&(_=O.msg,S=O.media)}break;case"protocolMessage":var M=g.value.key;e.edit===u.a&&g.value.type===r.c.REVOKE&&(null==M?void 0:M.fromMe)&&M.remoteJid===a.h?_=Object.assign({type:f.c.REVOKED},y,{externalId:M.id,revokedExternalId:M.id}):__LOG__(4)`recv'd invalid revoke key ${M} for ${e.author}`;break;default:var C=p.a[g.type]||null;_=Object.assign({type:f.c.FUTUREPROOF,protobuf:(0,v.b)(e.bytes),subtype:C,altIndex:"futureproof-"+(C||"unknown")},y)}return _?{msg:_,media:S,pushname:e.pushname}:null}function E(e,t){var n=e.entry;"mms4"===n.version&&t.thumbnailEncSha256&&t.thumbnailDirectPath&&null!=t.thumbnailSha256&&(n.mmsThumb={directPath:t.thumbnailDirectPath,ciphertextHash:t.thumbnailEncSha256},e.mmsThumbInfo={hash:(0,g.e)(new Uint8Array(t.thumbnailSha256))})}function b(e,t,n,r){if(!e.staticUrl)return(0,l.b)(e,t,n,r);var a=e.staticUrl;if(e.mediaKey&&e.fileEncSha256)return{version:"static",type:t,cryptoKey:e.mediaKey,ciphertextHash:e.fileEncSha256,size:n,creationTs:(0,o.E)(),staticUrl:a,sidecar:e.streamingSidecar||void 0};__LOG__(4)`Expected mediaKey and fileEncSha256 when staticUrl is provided`}},function(e,t,n){n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return m}));var r=n(28),a=n(4),i=n(46),s=n(12),o=n(62),u=n(67),d=n(105),c=n(43),l=n(10),p=n(120);function h(e){e.assertTag("document");var t=(0,u.a)(o.g,e.contentBytes()).documentMessage;return{status:"available",creationDate:e.attrTime("creation"),expirationDate:e.attrTime("expiration"),size:null==t?void 0:t.fileLength,metadata:t}}var f=new i.a("parseGpdrReportStatusResponse",e=>{var t=e.child("gdpr");return t.hasChild("document")?h(t.child("document")):{status:"pending",availabilityDate:t.attrTime("timestamp")}});function m(){return(0,r.e)((0,a.v)("iq",{xmlns:"urn:xmpp:whatsapp:account",to:a.k,type:"get",id:(0,a.t)()},(0,a.v)("gdpr",{action:"status"})),f).then(e=>{if(e.success)"available"===e.result.status?(function(e){if("available"===e.status){var t=(0,c.e)(e.metadata.fileSha256);return(0,d.getChunkTable)().getGdprReportBlob().then(e=>{if(e)return(0,l.h)(e).then(e=>(0,p.a)(e)).then(n=>{if((0,c.e)(n)===t)return e})})}return Promise.resolve()})(e.result).then(t=>{t?"available"===e.result.status&&(0,s.c)("event","gdprReportUpdated",{gdprReport:{status:"downloaded",creationDate:e.result.creationDate,expirationDate:e.result.expirationDate,size:e.result.size,metadata:e.result.metadata,blob:t}}):(0,s.c)("event","gdprReportUpdated",{gdprReport:e.result})}):(0,s.c)("event","gdprReportUpdated",{gdprReport:e.result});else switch(e.errorCode){case 404:return void(0,s.c)("event","gdprReportUpdated",{gdprReport:{status:"none"}});default:return void __LOG__(2)`getGdprReportStatus: unhandled error code ${e.errorCode} : ${e.errorText}`}})}},function(e,t,n){function r(e){if(e.hasChild("parent"))return"parent";var t=e.maybeChild("linked_parent");if(null==t)return null;var n=e.hasChild("default_sub_group"),r=t.attrGroupJid("jid");return Object.assign({},n&&{default:n},{linkedParent:r})}n.d(t,"a",(function(){return r}))},function(e,t,n){n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return i}));var r=null;function a(e){__LOG__(2)`setActivityInProgress: ${e||"activity finished"}`,r=e}function i(){return r}},function(e,t,n){n.d(t,"a",(function(){return i})),n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return o})),n(5),n(3),n(15);var r=n(8),a=(n(14),n(250),n(64),n(68),n(58));function i(e,t){return Promise.resolve()}function s(e,t){return Promise.resolve()}function o(e,t,n){return(0,r.f)("loadChatKeptMessages",e=>Promise.resolve([]).then(e=>({msgs:e.map(a.c)})))}n(51),n(353)},function(e,t,n){n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return m})),n.d(t,"c",(function(){return v}));var r=n(330),a=n(66),i=n(67),s=n(101),o=n(187),u=n(3);function d(e){switch(e){case"success":return a.c.Success;case"malformed":return a.c.Malformed;case"orphan":return a.c.Orphan;case"unsupported":return a.c.Unsupported;case"skipped":return a.c.Skipped;case"failed":return a.c.Failed}}function c(e){var t=a.b.cast(e);if(null==t)throw Error("No corresponding CollectionName for DbCollectionName, this should never happen");return t}function l(e){switch(e){case a.b.Regular:return"regular";case a.b.RegularLow:return"regular_low";case a.b.RegularHigh:return"regular_high";case a.b.CriticalBlock:return"critical_block";case a.b.CriticalUnblockLow:return"critical_unblock_low"}}function p(e){var t=a.a.cast(e);if(null==t)throw Error("No corresponding Actions for DbActions, this should never happen");return t}function h(e){switch(e){case a.a.Star:return"star";case a.a.Contact:return"contact";case a.a.Mute:return"mute";case a.a.PinDEPRECATED:return"pin";case a.a.Pin:return"pin_v1";case a.a.SettingPushName:return"setting_pushName";case a.a.LabelEdit:return"label_edit";case a.a.LabelMessage:return"label_message";case a.a.LabelJid:return"label_jid";case a.a.QuickReply:return"quick_reply";case a.a.LocaleSetting:return"setting_locale";case a.a.Archive:return"archive";case a.a.MarkChatAsRead:return"markChatAsRead";case a.a.ClearChat:return"clearChat";case a.a.DeleteMessageForMe:return"deleteMessageForMe";case a.a.Sentinel:return"sentinel";case a.a.UnarchiveChatsSetting:return"setting_unarchiveChats";case a.a.DeleteChat:return"deleteChat";case a.a.AndroidUnsupportedActions:return"android_unsupported_actions";case a.a.PrimaryFeature:return"primary_feature";case a.a.Subscription:return"subscription";case a.a.Nux:return"nux";case a.a.Agent:return"deviceAgent";case a.a.TimeFormat:return"time_format"}}function f(e){var t=e.index,n=e.binarySyncAction,a=e.actionState,u=e.version,l=e.keyId,h=e.modelId,f=e.modelType,m=e.indexMac,v=e.valueMac,g=e.collection,_=e.timestamp,E=e.action,b=(0,i.a)(r.b,n);return{index:t,binarySyncData:(0,s.a)(r.a,{value:b}).readBuffer(),actionState:d(a),version:u,keyId:l,modelId:h,modelType:f,indexMac:(0,o.c)(m),valueMac:v,collection:c(g),timestamp:_,action:null==E?null:p(E)}}function m(e){var t=e.collection,n=e.index,r=e.binarySyncAction,a=e.version,i=e.operation,s=e.timestamp,o=e.action;return{collection:c(t),index:n,binarySyncAction:r,version:a,operation:i,timestamp:s,action:null==o?null:p(o)}}function v(e){var t=e.collection,n=e.index,r=e.binarySyncAction,a=e.version,i=e.operation,s=e.timestamp,o=e.action,d=e.keyId,c=e.keyData,p=e.indexMac,f=e.indexAndValueCipherText,m=e.valueMac;return Object.assign({},(function(e){var t=e.index,n=e.binarySyncAction,r=e.version,a=e.operation,i=e.timestamp,s=e.action;return{collection:l(e.collection),index:t,binarySyncAction:n,version:r,operation:a,timestamp:(0,u.j)(i),action:null==s?null:h(s)}})({collection:t,index:n,binarySyncAction:r,version:a,operation:i,timestamp:s,action:o}),{keyId:d,keyData:c,indexMac:p,indexAndValueCipherText:f,valueMac:m})}},function(e,t,n){var r=n(27),a=n.n(r),i=n(162),s=n(153),o=n(115),u=n(38),d=n(28),c=(n(25),n(116)),l=n(72),p=(0,u.b)();function h(e,t){return e.tag!==t?E(e,`to be <${t}>`):p}function f(e,t){return b(e,t)?(function(e,t){return t instanceof l.c?(0,u.b)(t.toString()):"string"==typeof t?(0,u.b)(t):E(e,`decodeAsString: attribute is ${typeof t} not a string: ${String(t)}`)})(e,e.attrs[t]):E(e,`to have attribute "${t}"`)}function m(e,t,n,r){var a=(function(e,t){return(function(e,t,n,r){var a=f(e,t);if(!a.success)return a;var i=n(a.value);return null!=i?(0,u.b)(i):E(e,`to have "${t}"={integer}, but instead has "${a.value}"`)})(e,t,y)})(e,t);if(!a.success)return a;var i=a.value;return void 0!==n&&i<n?E(e,`to have "${t}"={at least ${n}} but has value ${i}`):void 0!==r&&i>=r?E(e,`to have "${t}"={below ${r}} but has value ${i}`):(0,u.b)(i)}function v(e,t){var n=(function(e,t){var n=S(e);if(!n.success)return n;var r=n.value;if(null==r)return p;for(var a=null,i=0;i<r.length;i++){var s=r[i];if(s.tag===t){if(null!=a)return E(e,`to have 1 child <${t}>, but found more than 1`);a=s}}return(0,u.b)(a)})(e,t);return n.success?null==n.value?E(e,`to have 1 child <${t}>, but found 0`):(0,u.b)(n.value):n}function g(e,t,n,r,a){return b(t,n)?e(t,n,r,a):p}function _(e,t,n,r){var a=e(t,n);return a.success?a.value===r?(0,u.b)(r):E(t,`to have "${n}"={${r}}, but instead has "${a.value}"`):a}function E(e,t){return(0,u.a)(`expected <${e.tag}>: ${t}`)}function b(e,t){return(0,c.a)(e.attrs,t)}function y(e){var t=parseInt(e,10);return Number.isNaN(t)?null:t}function S(e){var t=e.content;return t instanceof Uint8Array?E(e,"to have children"):(0,u.b)(t)}function I(e,t,n){var r=t.map((e,t)=>`${e}: ${n[t].error}`);return E(e,[`to match any of following mixins: ${t.join(", ")}, but all mixins failed.`,...r].join(" "))}function w(e,t){var n=(function(e,t){for(var n=t.length,r=e,a=0;a<n-1;a++){var i=v(r,t[a]);if(!i.success)return i;r=i.value}return(0,u.b)(r)})(e,t);if(!n.success)return T(n);var r=f(n.value,t[t.length-1]);return r.success?r:T(r)}function T(e){return(0,u.a)("in the reference, "+e.error)}function A(e,t){var n=h(e,"iq");if(!n.success)return n;var r=w(t,["id"]);if(!r.success)return r;var a=_(f,e,"id",r.value);if(!a.success)return a;var i=w(t,["to"]);if(!i.success)return i;var s=_(f,e,"from",i.value);if(!s.success)return s;var o=_(f,e,"type","error");return o.success?(0,u.b)({type:o.value}):o}function O(e,t){var n=h(e,"iq");if(!n.success)return n;var r=v(e,"error");if(!r.success)return r;var a=A(e,t);if(!a.success)return a;var i=(function(e){var t=(function(e){var t=h(e,"error");if(!t.success)return t;var n=_(f,e,"text","bad-request");if(!n.success)return n;var r=_(f,e,"code","400");return r.success?(0,u.b)({text:n.value,code:r.value}):r})(e);if(t.success)return(0,u.b)(Object.assign({},t.value,{isIQErrorBadRequest:!0}));var n=(function(e){var t=h(e,"error");if(!t.success)return t;var n=_(f,e,"text","feature-not-implemented");if(!n.success)return n;var r=_(f,e,"code","501");return r.success?(0,u.b)({text:n.value,code:r.value}):r})(e);return n.success?(0,u.b)(Object.assign({},n.value,{isIQErrorFeatureNotImplemented:!0})):I(e,["IQErrorBadRequest","IQErrorFeatureNotImplemented"],[t,n])})(r.value);return i.success?(0,u.b)({iQErrorResponseMixin:a.value,errorIQErrorBadRequestOrIQErrorFeatureNotImplementedMixinGroup:i.value}):i}function M(e,t){var n=h(e,"iq");if(!n.success)return n;var r=v(e,"error");if(!r.success)return r;var a=(function(e){var t=h(e,"error");if(!t.success)return t;var n=_(f,e,"text","internal-server-error");if(!n.success)return n;var r=_(f,e,"code","500");return r.success?(0,u.b)({text:n.value,code:r.value}):r})(r.value);if(!a.success)return a;var i=A(e,t);return i.success?(0,u.b)({errorIQErrorInternalServerErrorMixin:a.value,iQErrorResponseMixin:i.value}):i}function C(e){var t=h(e,"prop");if(!t.success)return t;var n=(function(e){var t=(function(e){var t=h(e,"prop");if(!t.success)return t;var n=m(e,"config_code",1,void 0);if(!n.success)return n;var r=f(e,"config_value");if(!r.success)return r;var a=g(m,e,"config_expo_key",0,void 0);return a.success?(0,u.b)({configCode:n.value,configValue:r.value,configExpoKey:a.value}):a})(e);if(t.success)return(0,u.b)(Object.assign({},t.value,{isExperimentConfig:!0}));var n=(function(e){var t=h(e,"prop");if(!t.success)return t;var n=m(e,"event_code",1,void 0);if(!n.success)return n;var r=m(e,"sampling_weight",-1e4,1e4);return r.success?(0,u.b)({eventCode:n.value,samplingWeight:r.value}):r})(e);return n.success?(0,u.b)(Object.assign({},n.value,{isSamplingConfig:!0})):I(e,["ExperimentConfig","SamplingConfig"],[t,n])})(e);return n.success?(0,u.b)({experimentConfigOrSamplingConfigMixinGroup:n.value}):n}function R(e,t){var n=h(e,"iq");if(!n.success)return n;var r=v(e,"props");if(!r.success)return r;var a=_(f,r.value,"protocol","1");if(!a.success)return a;var i=g(f,r.value,"ab_key");if(!i.success)return i;var s=g(f,r.value,"hash");if(!s.success)return s;var o=g(m,r.value,"refresh",0,void 0);if(!o.success)return o;var d=g(m,r.value,"refresh_id",0,void 0);if(!d.success)return d;var c=(function(e,t){var n=h(e,"iq");if(!n.success)return n;var r=w(t,["id"]);if(!r.success)return r;var a=_(f,e,"id",r.value);if(!a.success)return a;var i=w(t,["to"]);if(!i.success)return i;var s=_(f,e,"from",i.value);if(!s.success)return s;var o=_(f,e,"type","result");return o.success?(0,u.b)({type:o.value}):o})(e,t);if(!c.success)return c;var l=(function(e,t,n,r,a){var i=(function(e,t,n,r){var a=S(e);if(!a.success)return a;var i=a.value;if(null==i)return(0,u.b)([]);for(var s=[],o=0;o<i.length;o++){var d=i[o];"prop"===d.tag&&s.push(d)}var c=s.length;return c<0?E(e,"to have at least 0 <prop> children, but found "+c):c>r?E(e,`to have at most ${r} <prop> children, but found ${c}`):(0,u.b)(s)})(e,0,0,1/0);if(!i.success)return i;for(var s=[],o=0;o<i.value.length;o++){var d=a(i.value[o]);if(!d.success)return d;s.push(d.value)}return(0,u.b)(s)})(r.value,0,0,0,C);return l.success?(0,u.b)({propsProtocol:a.value,propsAbKey:i.value,propsHash:s.value,propsRefresh:o.value,propsRefreshId:d.value,iQResultResponseMixin:c.value,propsProp:l.value}):l}var N=n(4),k=N.v;function P(e){var t,n,r=e.hash,a=k("iq",{xmlns:"abt",to:N.k},k("props",{protocol:"1",hash:(t=N.b,n=r,null==n?N.d:t(n))}));return(function(e){(function(e,t){if((function(e,t){var n=e.tag,r=t.tag;if(n!==r)throw new Error(`tag mismatch: ${n} != ${r}`)})(e,t),(function(e,t){var n=e.attrs,r=t.attrs;Object.keys(r).forEach(e=>{var t=r[e],a=n[e];if(null!=t&&null!=a)throw new Error("conflict for key: "+e);n[e]=t})})(e,t),null!=t.content)throw new Error("mixins with content (element/children) not yet supported")})(e,k("iq",{id:(0,N.t)(),type:"get"}))})(a),a}var G=class extends Error{constructor(){var e;return e=super(...arguments),this.name="SmaxParsingFailure",e}};function L(e,t){return`Failed to parse the response of <rpc name="${e}">. ${Object.keys(t).map(e=>`Tried <response name="${e}">, but failed with ${t[e].error}.`).join(" ")}`}function D(e){return x.apply(this,arguments)}function x(){return(x=a()((function*(e){var t=P(e),n=yield(0,d.j)(t),r=R(n,t);if(r.success)return{name:"GetExperimentConfigResponseSuccess",value:r.value};var a=O(n,t);if(a.success)return{name:"GetExperimentConfigResponseErrorNoRetry",value:a.value};var i=M(n,t);if(i.success)return{name:"GetExperimentConfigResponseErrorRetry",value:i.value};throw new G(L("GetExperimentConfig",{Success:r,ErrorNoRetry:a,ErrorRetry:i}))}))).apply(this,arguments)}var U=n(3),F=(0,o.a)(()=>"abProps",(function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return null==e||!1===e?B(null):(0,i.c)().then(e=>B(e))}));function B(e){return j.apply(this,arguments)}function j(){return(j=a()((function*(e){var t=yield D({hash:e});if("GetExperimentConfigResponseSuccess"!==t.name)__LOG__(4)`abPropsParser failed ${t.value}`;else{var n=t.value,r=n.propsAbKey,a=n.propsHash,o=n.propsRefresh,u=H(n.propsProp),d=(0,s.g)((0,i.b)(),u),c=yield V(r,a,o,d);!1===c.success&&(c.error,__LOG__(2)`syncAbProps: detected no hash`)}return{seconds:yield(0,i.d)()}}))).apply(this,arguments)}function V(e,t,n,r){return K.apply(this,arguments)}function K(){return(K=a()((function*(e,t,n,r){var a=yield(0,i.a)(),o={abKey:null!=e?e:a.abKey,hash:null!=t?t:a.hash,refresh:(0,s.f)(n),lastSyncTime:(0,U.E)(),propValues:a.propValues,propExpoKeys:a.propExpoKeys,internalExpoKeys:a.internalExpoKeys,expoKeyStr:a.expoKeyStr};if(null==t)return yield(0,i.e)(o),__LOG__(2)`WAAbProps.update: detected no hash`,(0,u.a)("noHash");__LOG__(2)`WAAbProps.update: updating ab configs`;var d,c,l=r.values,p=r.expoKeys,h=(0,s.e)(l,a.propValues,(0,i.b)()),f=(0,s.c)(p,a.propExpoKeys,(0,i.b)()),m=f.propExpoKeys,v=f.expoKeysToDelete,g=(0,s.d)(v,a.internalExpoKeys);return null!=g&&(d=g.internalExpoKeys,c=g.expoKeyStr),yield(0,i.e)(Object.assign({},o,{propValues:h,propExpoKeys:m,internalExpoKeys:d,expoKeyStr:c})),(0,u.b)()}))).apply(this,arguments)}function H(e){var t=[];return e.forEach(e=>{var n,r=e.experimentConfigOrSamplingConfigMixinGroup;r.isExperimentConfig&&t.push({configCode:r.configCode,configValue:r.configValue,configExpoKey:null==(n=r.configExpoKey)?void 0:n.toString()})}),t}var $=n(12),q=n(30),z=n(16),J=n(6);function Y(e,t){(null==e?void 0:e.reactions_receive)&&!(null==t?void 0:t.reactions_receive)&&(0,q.b)().fireAndForget(z.e.processFutureProofMsgs())}t.a=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!(0,$.d)())return __LOG__(2)`syncAbProps: ignoring updates for service worker`,Promise.resolve({seconds:60});var t=J.b.get();return F(e).then(e=>{var n=J.b.get();return Y(t.propValues,n.propValues),e})}},,function(e,t,n){n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return i}));var r=null;function a(e){r=e}function i(){return(function(){if(null==r)throw(function(e){var t=new Error("Trying to access WAGlobals before being set");if(void 0===t.stack)try{throw t}catch(e){}return t})();return r})().db}},function(e,t,n){n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return v}));var r=n(27),a=n.n(r),i=n(43),s=n(184),o=n(3),u=n(169),d=n(216),c=n(60),l=n(303);function p(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t.reduce((e,t)=>e+t.byteLength,0),a=new Uint8Array(r),i=0;return t.forEach(e=>{a.set(new Uint8Array(e),i),i+=e.byteLength}),a.buffer}n(282);var h=new Map;function f(e){return m.apply(this,arguments)}function m(){return(m=a()((function*(e){var t,n=h.get((0,i.d)(e));return n?n.keyData:((n=yield(0,s.o)(e))&&h.set((0,i.d)(e),n),null==(t=n)?void 0:t.keyData)}))).apply(this,arguments)}function v(){return g.apply(this,arguments)}function g(){return(g=a()((function*(){var e=yield _();if(null==e)throw new Error("syncd: no active sync keys found!");var t=yield w(),n=E(e),r=b(e,t);return n||r?(e=y(e,t),__LOG__(2)`syncd: stored key rotation key id`,yield(0,s.w)(e),yield(0,l.b)({type:"key_rotation",keys:[e]}),n&&__LOG__(2)`syncd key rotation due to key expiry`,r&&__LOG__(2)`syncd key rotation due to device removal`,v()):(__LOG__(2)`No key rotation needed using current key...`,Promise.resolve({keyId:e.keyId,keyData:e.keyData}))}))).apply(this,arguments)}function _(){return(0,s.b)().then(e=>{if(0===e.length)return __LOG__(2)`Syncd: No syncd keys found. Generating new key...`,w().then(e=>{var t=S();return{keyId:t.keyId,keyEpoch:t.keyEpoch,keyData:I(),timestampMs:(0,o.F)(),fingerprint:e}}).then(e=>(__LOG__(2)`Syncd: Generate new key successful`,(0,s.w)(e).then(()=>e)));var t=e.map(e=>(0,d.c)(e.keyId)),n=Math.max(...t),r=e.filter(e=>(0,d.c)(e.keyId)===n),a=r.map(e=>(0,d.b)(e.keyId)),i=Math.min(...a),u=a.indexOf(i);return Promise.resolve(r[u])})}function E(e){var t=30*o.a;return(0,o.F)()-e.timestampMs>t}function b(e,t){for(var n=!1,r=e.fingerprint,a=t.rawId,i=t.currentIndex,s=t.deviceIndexes,o=new Set(r.deviceIndexes),u=r.currentIndex+1;u<=i;u++)o.add(u);for(var d=0;d<s.length;d++)if(!o.has(s[d]))return!0;var c=new Set(s);return o.forEach(e=>{c.has(e)||(n=!0)}),n||r.rawId!==a}function y(e,t){__LOG__(2)`syncd: Initializing Key rotation...`;var n=S(e);return{keyId:n.keyId,keyEpoch:n.keyEpoch,keyData:I(),fingerprint:t,timestampMs:(0,o.F)()}}function S(e){var t;if(null==e){var n=new Uint8Array(16);self.crypto.getRandomValues(n),t=(0,d.a)(n.buffer)}else t=(0,d.c)(e.keyId)+1;return{keyId:new Uint8Array(p((0,d.d)(2,c.b).buffer,(0,d.d)(4,t).buffer)).buffer,keyEpoch:t}}function I(){var e=new Uint8Array(32);return self.crypto.getRandomValues(e),e.buffer}function w(){return(0,u.a)().then(e=>{if(null==e)throw new Error("syncd: primary has no companions");var t=e.currentIndex,n=e.devices,r=e.rawId;if(null==n)throw new Error("syncd: devices list is empty");return{currentIndex:t,deviceIndexes:n.map(e=>e.keyIndex),rawId:r}})}},function(e,t,n){n.d(t,"c",(function(){return y})),n.d(t,"a",(function(){return S})),n.d(t,"b",(function(){return w}));var r=n(27),a=n.n(r),i=n(111),s=n(163),o=n(25),u=n(101),d=n(99),c=(n(34),n(137),n(193),n(78));n(44),n(67);var l=n(169),p=n(63),h=n(3),f=n(60),m=n(7),v=n(29),g=n(415),_=n(6),E=n(23),b=n(129);function y(e){var t=Date.now()/1e3;return Math.abs(e-t)<h.b}function S(e,t,n){return(0,l.d)().then(r=>{var a,d,c,l,p,m,v=n||(a=r.timestamp,d=(0,h.j)(Date.now()/1e3),c=(0,h.n)(d,h.b)?(0,h.E)():d,null!=a&&c<=a?(__LOG__(2)`ADV New signing timestamp is lower than last signed timestamp`,SEND_LOGS("adv-low-timestamp"),(0,h.l)(1,a)):c),g=r.rawId,_=r.currentIndex,E={rawId:g,keyIndex:_,timestamp:v};return(l=(function(e,t,n){var r=(0,u.a)(s.a,t).readBuffer();return{details:r,accountSignatureKey:o.a.build((0,i.e)(e.publicKey)).readBuffer(),accountSignature:I(e,o.a.build(i.a,r,n).readByteArray())}})(e,E,t.identityKey),p=t.secretKey,m=(0,u.a)(s.d,l).readBuffer(),(0,b.d)(p,new Uint8Array(m)).then(e=>({details:m,hmac:e}))).then(t=>{var n=(0,u.a)(s.c,t).readBuffer(),a=[f.b];null!=r.devices&&r.devices.forEach(e=>{var t=e.keyIndex;a.push(t)}),a.push(E.keyIndex);var d=(function(e,t){var n=(0,u.a)(s.b,t).readBuffer();return{details:n,accountSignature:I(e,o.a.build(i.b,n).readByteArray())}})(e,{rawId:g,currentIndex:_,validIndexes:a,timestamp:v});return{encodedADVSignedDeviceIdentityHMAC:n,encodedADVSignedKeyIndexList:(0,u.a)(s.e,d).readBuffer(),advDeviceIdentity:E,signingTimestamp:v}})})}function I(e,t){var n=(0,c.e)(64);self.crypto.getRandomValues(n);var r=(function(e,t,n){var r=(function(e,t,n){return(0,d.j)(()=>{var r=t.length,a=e.privateKey,i=new Uint8Array(32);(0,d.k)(i,a);var s=128&i[31],o=new Uint8Array(r+128);o[0]=254,o.fill(255,1,32),o.set(a,32),o.set(t,64),o.set(n,r+64);var u=(0,d.a)(Uint8Array,64);(0,d.c)(u,o,r+128),o.set(i,32);var c=(0,d.a)(Float64Array,64);(0,d.i)(u,c),(0,d.k)(o,u);var l,p,h=(0,d.a)(Uint8Array,64);for((0,d.c)(h,o,r+64),(0,d.i)(h,c),l=0;l<32;++l)c[l]=u[l];for(l=0;l<32;++l)for(p=0;p<32;++p)c[l+p]+=h[l]*a[p];return(0,d.f)(o.subarray(32,64),c),{pubKeyNegative:0!==s,signedMsg:o}})})(e,t,n),a=(0,c.f)(r.signedMsg,0,64);return a[63]=127&a[63]|(r.pubKeyNegative?128:0),a})(e,t,n);return o.a.build(r).readBuffer()}function w(e){return 0===e.size?Promise.resolve(new Map):(0,p.c)(Array.from(e)).then((function(){var e=a()((function*(e){var t=new Map;if(0===e.length)return Promise.resolve(t);for(var n=[],r=function*(r){var a=e[r];if(a.jid===_.r.get())__LOG__(3)`getMetadataKeyHashAndTimestamp: companions not supported`;else if(null==a.devices||a.devices.length<=1){var i,s=null==(i=a.deviceVerification)?void 0:i.timestamp;if(s){var o=(0,h.j)(s);(0,h.n)(o,30*h.b)&&t.set(a.jid,{hash:null,timestamp:s,keyIndexes:null})}}else(0,f.d)(a).forEach(e=>{n.push((0,m.A)(a.jid,e))})},i=0;i<e.length;i++)yield*r(i);if(0===n.length)return t;var s=new Map;return e.forEach(e=>{var t=e.jid,n=e.deviceVerification;s.set(t,null==n?void 0:n.timestamp)}),(0,v.x)(n).then((function(){var e=a()((function*(e){var r=new Set;n.forEach(t=>{e.has(t)||r.add((0,m.h)(t))});for(var a=(function(e){var t=new Map;return e.forEach((e,n)=>{var r=(0,m.h)(n),a=t.get(r);null==a&&(a=[],t.set(r,a)),a.push({deviceId:(0,m.f)(n),identity:e})}),t})(e),i=Array.from(a.keys()),o=0;o<i.length;o++){var u=i[o],d=a.get(u);if(null!=d){var c=yield T(d.map(e=>e.identity)),l=void 0;r.has(u)&&(l=d.map(e=>e.deviceId).sort()),t.set(u,{hash:c,timestamp:s.get(u),keyIndexes:l})}}return t}));return function(t){return e.apply(this,arguments)}})())}));return function(t){return e.apply(this,arguments)}})())}function T(e){var t=e.map(e=>(0,i.e)(e)),n=new o.a;return t.sort(g.PublicKeyComparator).forEach(e=>{n.writeByteArray(e)}),self.crypto.subtle.digest("SHA-256",n.readByteArray()).then(e=>{var t=new Uint8Array(e);return(0,c.f)(t,0,(0,E.a)("md_icdc_hash_length"))})}},,,function(e,t,n){n.r(t),n.d(t,"PublicKeyComparator",(function(){return _}));var r=n(9),a=n.n(r),i=n(25),s=n(101),o=n(375),u=n(11),d=n(7),c=n(6),l=n(29),p=n(115),h=n(63),f=n(60),m=/^([17]|2[07]|3[0123469]|4[013456789]|5[12345678]|6[0123456]|8[1246]|9[0123458]|\d{3})\d*?(\d{4,6})$/;function v(e){var t=m.exec((0,d.u)(e));return i.a.build(t?t[1]+t[2]:e).readByteArray()}function g(e,t){return("00000"+(256*e.getUint32(t,!1)+e.getUint8(t+4))).slice(-5)}function _(e,t){for(var n=0;n<e.length&&n<t.length;++n)if(e[n]!==t[n])return e[n]-t[n];return e.length-t.length}function E(e,t){for(var n=Promise.resolve(i.a.build(0,0,t,e).readByteArray()),r=0;r<5200;r++)n=n.then(e=>self.crypto.subtle.digest("SHA-512",i.a.build(e,t).readByteArray()));return n.then(e=>{var t=new DataView(e.slice(0,30));return[g(t,0),g(t,5),g(t,10),g(t,15),g(t,20),g(t,25)].join("")})}function b(e,t,n,r){return Promise.all([E(e,t),E(n,r)]).then(e=>e.sort().join(""))}function y(e,t,n,r){var a={version:0,localFingerprint:{publicKey:t,identifier:e},remoteFingerprint:{publicKey:r,identifier:n}};return(0,s.a)(o.a,a).readByteArray()}t.default=(0,p.a)(e=>e,(function(e){var t=(0,d.e)(e);return Promise.all([(0,l.w)(t),(0,l.G)()]).then(t=>{var n=a()(t,2),r=n[0],s=n[1];if(null==r)return __LOG__(2)`getIdentityVerificationData returned no remotePrimaryPublicKey`,null;var o=i.a.build(5,s.staticPublicKey).readByteArray(),p=v(c.r.get()),m=v(e);return(function(e,t){return(0,h.b)(e).then(n=>{var r=[];return n&&(0,f.d)(n).forEach(t=>{t!==u.c&&r.push((0,d.A)(e,t))}),0===r.length?t:(0,l.x)(r).then(e=>{var n=new Set(r),a=[t];if(e.forEach((e,t)=>{n.delete(t),a.push(e)}),n.size>0)return null;var s=new i.a;return a.sort(_).forEach(e=>{s.writeByteArray(e)}),s.readByteArray()})})})(e,r).then(e=>e?Promise.all([b(p,o,m,e),y(p,o,m,e),y(m,e,p,o)]):null)}).then(e=>{if(null==e)return null;var t=a()(e,3),n=t[0];return{qrCodeData:t[1],remoteQRCodeData:t[2],digitsCodeData:n}})}))},function(e,t,n){n.r(t),n.d(t,"maybeDownloadPendingStatusThumbnails",(function(){return b}));var r=n(27),a=n.n(r),i=n(59),s=n(75),o=n(17),u=n(107),d=n(7),c=n(3),l=n(177),p=n(94),h=n(293),f=n(104),m=n(24),v=n(86),g=n(14),_=n(252),E=n(131);function b(){return(0,o.hb)().then(e=>{if(e){var t=e.previewMsgIds,n=e.otherMmsThumbnails;return Promise.all(t.map(y)).then(()=>Promise.all(n.map(y)))}})}function y(e){return S.apply(this,arguments)}function S(){return(S=a()((function*(e){var t=yield(0,o.E)(e);if(t){var n=t.dbMsg;if((0,m.e)(n)&&n.media){var r=n.media;if(yield(0,o.Zc)(r),(0,v.c)(n)){var a=yield(0,o.P)(r);if(a)if((0,v.b)(a,e)){var s=a.mediaEntries[e];if(!s)return __LOG__(4)`downloadMsgThumb no entry for media preview ${r}`,void SEND_LOGS("no-entry-for-media-msg");if(!s.validatedTs||(0,c.n)(s.validatedTs,g.B)){if(yield(0,o.pb)(r))return __LOG__(2)`downloadMsgThumb mms preview already downloaded`,void(yield(0,o.Ob)(e));var d=(0,i.t)(r),l=(0,c.u)();return(0,u.i)(d,t=>I(0,e,l).catch(e=>{throw e})).then(()=>{})}__LOG__(3)`downloadMsgThumb: media was downloaded long ago. Thumb probaly no longer in server`}else __LOG__(2)`downloadMsgThumb: Not enough info to download thumb`;else __LOG__(2)`downloadMsgThumb media ${r} is gone`}else __LOG__(2)`downloadMsgThumb: No need to download thumb`}else __LOG__(3)`downloadMsgThumb: msg without media`}else __LOG__(2)`downloadMsgThumb: Msg is gone`}))).apply(this,arguments)}function I(e,t,n){var r=(0,c.v)(n);return(0,o.E)(t).then((function(){var e=a()((function*(e){if(!e)return __LOG__(2)`_doDownloadMsgThumb message ${t} is not a valid media message`,{result:"error",error:"gone"};var n=e.dbMsg;if(!(0,v.c)(n))return __LOG__(2)`_doDownloadMsgThumb no need to download mms thumb`,{result:"skip"};if(!(0,m.e)(n)||!n.media)return __LOG__(2)`_doDownloadMsgThumb message ${t} is not a valid media message`,{result:"error",error:"invalid"};var a=n.media,i=yield(0,o.P)(a);if(!i)return __LOG__(2)`_doDownloadMsgThumb media ${a} is gone`,{result:"error",error:"gone"};if(!(0,v.b)(i,t))return __LOG__(2)`_doDownloadMsgThumb not enough info to download mms thumb`,{result:"skip"};var s=i.mediaEntries[t];if(!s||"mms4"!==s.version)return __LOG__(4)`downloadThumbMedia no valid entry version ${null==s?void 0:s.version} for media preview ${a}`,SEND_LOGS("no-entry-for-media-msg"),{result:"error",error:"failed"};var u={overallMmsVersion:4,overallDownloadOrigin:"status"===e.type?3:(0,d.x)(e.jid,{user:()=>1,group:()=>2}),overallDownloadMode:5,overallMediaType:f.a[n.type],overallIsFinal:!1,overallQueueT:r},c=new h.a({parts:l.b,onUpdate(e){__LOG__(2)`download thumb ${100*e}% finished`},onSuccess:()=>{__LOG__(2)`download thumb finished`},onError:e=>{__LOG__(2)`download thumb failed ${e}`}});return(function(e,t,n,r,a){return w.apply(this,arguments)})(i,s,n.type,c,u)}));return function(t){return e.apply(this,arguments)}})())}function w(){return(w=a()((function*(e,t,n,r,a){var i,s,d,c=e.mediaId;if(__LOG__(2)`downloadThumbMedia for media ${c}, type = ${n}`,null!=t.progressiveJpeg){if(__LOG__(2)`downloadThumbMedia msg got no thumb info, but progressive jpeg info.`,!t.directPath)return __LOG__(3)`downloadThumbMedia had some invalid progressiveJpeg info`,(0,u.k)(Object.assign({},a,{overallDownloadResult:2,overallIsFinal:!0})),{result:"error",error:"failed"};var h=t.ciphertextHash,f=t.directPath,m=t.size,v=t.progressiveJpeg,g=t.cryptoKey,E=t.type,b=(0,_.a)(v,m),y=yield A(h,f,b,g,E,r,a);if("success"!==y.result.status)return T(y.result,y.metric);d=y.result.partialPlaintextHash,i=y.result,s=y.metric}else{if(null==e.mmsThumb||null==t.mmsThumb||null==t.mmsThumb.directPath)return __LOG__(2)`downloadThumbMedia got msg without mms thumb info`,(0,u.k)(Object.assign({},a,{overallDownloadResult:16,overallIsFinal:!0})),{result:"error",error:"failed"};var S=t.mmsThumb,I=S.directPath,w=S.ciphertextHash,O=e.mmsThumb;if(null!=O.hasPreview)return __LOG__(2)`downloadThumbMedia: Thumb already downloaded for media ${c}`,{result:"success"};var M=yield(0,l.c)("auto",{version:"mms4",type:(0,p.i)(n),cryptoKey:t.cryptoKey,directPath:I,ciphertextHash:w,size:"unknown"},O.thumbPlaintextHash,r,a);if("success"!==M.result.status)return T(M.result,M.metric);d=O.thumbPlaintextHash,i=M.result,s=M.metric}return(0,u.k)(Object.assign({},s,{overallIsFinal:!0,overallDownloadResult:1})),yield(0,o.oc)(c,i.plaintext,d),__LOG__(2)`downloadThumbMedia successfully stored full content to storage`,r.parts.processing.finished(),__LOG__(2)`downloadThumbMedia successfully finalized media ${c}`,{result:"success"}}))).apply(this,arguments)}function T(e,t){return"gone"===e.status?((0,u.k)(Object.assign({},t,{overallDownloadResult:6,overallIsFinal:!0})),{result:"error",error:"gone"}):"daemon-disconnected"===e.status?((0,u.k)(Object.assign({},t,{overallDownloadResult:20,overallIsFinal:!0})),{result:"error",error:"disconnected"}):(__LOG__(2)`downloadThumbMedia failed to download media ${e.status}`,(0,u.k)(Object.assign({},t,{overallDownloadResult:l.a[e.status],overallIsFinal:!0})),{result:"error",error:"failed"})}function A(e,t,n,r,a,i,s){return O.apply(this,arguments)}function O(){return(O=a()((function*(e,t,n,r,a,i,s){var o=yield(0,E.c)(r,a),u={cipherKey:o.cipherKey,iv:o.iv,hmacKey:o.hmacKey},d=n.downloadSize,c=(0,_.c)(u,n.partialFetchOptions,d);return(0,l.f)({version:"mms4",ciphertextHash:e,directPath:t,type:a},"auto",void 0,d,l.e,c,i,s).then(e=>{var t=e.result,n=e.metric;if("success"!==t.status)return{result:{status:t.status},metric:n};if(!t.progressiveDownload)return __LOG__(4)`Expected progressiveDownload info when downloading progressive jpeg thumbnail`,{result:{status:"request-error"},metric:n};var r=t.progressiveDownload.partialPlaintextHash;return{result:{status:"success",plaintext:t.result,partialPlaintextHash:r},metric:n}})}))).apply(this,arguments)}t.default=(0,s.c)().finalStep("download",{requirements:[s.d],code:e=>y(e.msgId),stopRetryIf:{timePassedSeconds:c.b,appCrashed:!0,onStopRetry:e=>{e.msgId}}}).end()},function(e,t,n){n.r(t),n.d(t,"extractUserNoticeContent",(function(){return E})),n.d(t,"downloadUserNoticeDeepLinkModal",(function(){return S}));var r=n(9),a=n.n(r),i=n(75),s=n(17),o=n(202),u=n(35),d=n(20),c=n(6),l=n(245),p=n(3),h=.01;function f(e,t){t.forEach(t=>{if(!e[t])throw __LOG__(4)`downloadUserNoticeContent: invalid payload, field [${t}] is missing`,SEND_LOGS("download-user-notice-content-invalid-payload",h),__LOG__(2)`downloadUserNoticeContent: field ${t} is missing in payload: ${JSON.stringify(e)}`,new Error(`downloadUserNoticeContent: Invalid Payload: ${t} is missing`)})}function m(e,t){var n=new Date(e).getTime()/1e3;return"local"===t&&(n+=60*(new Date).getTimezoneOffset()),(0,p.q)(n)&&__LOG__(3)`downloadUserNoticeContent: Tried to use date outside valid range: ${n}.
Date: ${e}, Timezone Offset: ${(new Date).getTimezoneOffset()}`,(0,p.j)(n)}function v(e){if(!e)throw __LOG__(4)`downloadUserNoticeContent: no timing object found`,SEND_LOGS("download-user-notice-content-no-timing",h),new Error("downloadUserNoticeContent: no timing object found");var t,n,r;if(e.start&&(f(e.start,["time","reference"]),t={time:m(e.start.time,e.start.reference),reference:e.start.reference}),e.end&&(f(e.end,["time","reference"]),n={time:m(e.end.time,e.end.reference),reference:e.end.reference}),e.duration){var a=e.duration.repeat&&e.duration.static,i=!e.duration.repeat&&!e.duration.static;if(a||i)throw __LOG__(4)`downloadUserNoticeContent: timing "duration" object must contain either just "repeat" or just "static"`,SEND_LOGS("download-user-notice-content-timing-invalid-duration",h),new Error('downloadUserNoticeContent: timing "duration" object must contain either just "repeat" or just "static"');r=e.duration}return{start:t,end:n,duration:r}}function g(e){if(e)return f(e,["text","icon","timing","action"]),{text:e.text,icon:{url:e.icon.light},actionURL:e.action,timing:v(e.timing)}}function _(e){if(e)return f(e,["icon","title","bullets","buttonText","timing"]),{icon:{url:e.icon.light},title:e.title,body:e.body,bullets:e.bullets.map(e=>e.text),footer:e.footer,acceptLabel:e.buttonText,timing:v(e.timing)}}function E(e,t,n){if(!n.policyVersion)throw __LOG__(4)`Missing "policyVersion" in payload: ${JSON.stringify(n)}`,SEND_LOGS("download-user-notice-content-invalid-policy-version",h),new Error(`User Notice Content Invalid Payload for notice id "${e}". Field is missing: "policyVersion" in payload`);return{version:n.policyVersion,lglc:t,banner:g(n.banner)||void 0,nonBlockingModal:_(n.modal)||void 0,blockingModal:_(n["blocking-modal"])||void 0}}function b(e,t,n){return __LOG__(2)`downloadUserNoticeContent: fetching ${t} ${n}`,(0,u.f)(e).catch(e=>{throw __LOG__(4)`Could not complete user notice request. Max retry attempts reached.`,SEND_LOGS("download-user-notice-content-max-retry"),__LOG__(2)`User notice request retry error: ${e.toString()}`,new Error("Fetch Retry error: "+e.toString())}).then(e=>{if(!e.ok){var t=e.status;return e.text().then(e=>{switch(t){case u.a.NOT_FOUND:case u.a.GONE:case u.a.INTERNAL_SERVER_ERROR:__LOG__(4)`User notice request returned unexpected server error.`,SEND_LOGS("download-user-notice-content-failed-server"),__LOG__(2)`Server returned http status: ${t} response body: ${e}`;break;default:__LOG__(4)`User notice request returned unknown server error.`,SEND_LOGS("download-user-notice-content-failed-unknown"),__LOG__(2)`Server returned http status: ${t} response body: ${e}`}throw new Error("User Notice Request Error "+t)})}return e})}function y(e){if(!(0,o.b)())return __LOG__(2)`downloadUserNoticeContent: User Notice Framework is disabled`,Promise.resolve();var t="https://www.whatsapp.com";__LOG__(2)`downloadUserNoticeContent: downloading User Notice Content for User Notice with id "${e}"`,__LOG__(2)`downloadUserNoticeContent: attempting to fetch from host: "${t}"`;var n=(0,d.d)(),r=n.lg,i=n.lc;return b((0,u.c)(t,"/user-notice/v1/",{id:e,lg:r,lc:null!=i?i:"ZZ",cc:(0,l.a)(c.r.get())||"US",platform:"kaios"}),e,"json").then(e=>e.json()).then(t=>{var n;try{n=E(e,{lg:r,lc:i},t)}catch(t){return __LOG__(4)`Received invalid User Notice content for id ${e}`,__LOG__(2)`downloadUserNoticeContent: validation error ${t.message.toString()}`,void WAM.log("regular",2474,void 0,[3,0,3,1,0,e])}return(function(e,t){var n,r,i,s=[null==(n=t.banner)?void 0:n.icon.url,null==(r=t.nonBlockingModal)?void 0:r.icon.url,null==(i=t.blockingModal)?void 0:i.icon.url].map(t=>t?b((0,u.h)(t),e,"svg").then(e=>e.text()):Promise.resolve(null));return Promise.all(s).then(e=>{var n=a()(e,3),r=n[0],i=n[1],s=n[2],o=t.banner,u=t.nonBlockingModal,d=t.blockingModal;return o&&r&&(o.icon.svg=r),u&&i&&(u.icon.svg=i),d&&s&&(d.icon.svg=s),t})})(e,n).catch(()=>(WAM.log("regular",2474,void 0,[3,0,4,1,0,e]),__LOG__(4)`Could not download user notice content icons`,SEND_LOGS("download-user-notice-icon-failed"),n))}).catch(t=>{throw __LOG__(4)`User notice json fetch request failed: ${t.toString()}`,WAM.log("regular",2474,void 0,[3,0,2,1,0,e]),t})}function S(e){return y(e).then(t=>{if(null==t||null==t.nonBlockingModal)throw __LOG__(4)`downloadUserNoticeDeepLinkModal: Expected payload for ${e} to contain field "nonBlockingModal"`,SEND_LOGS("download-user-notice-deep-link-content-missing-non-blocking-modal-field",h),new Error(`downloadUserNoticeDeepLinkModal: Expected payload for ${e} to contain field "nonBlockingModal"`);var n=t.nonBlockingModal,r=(0,d.f)(t.lglc.lg)?"rtl":"ltr";return{type:"deep-link-modal",id:e,version:t.version,content:{svgIcon:n.icon.svg||void 0,title:n.title,body:n.body,bullets:n.bullets,footer:n.footer,acceptLabel:n.acceptLabel},direction:r}})}t.default=(0,i.c)().finalStep("downloadContent",e=>{var t=e.id;return y(t).then(e=>{if(e)return s.Tc(t,e)})}).end()},function(e,t,n){n.r(t),n.d(t,"getBlocklist",(function(){return c}));var r=n(28),a=n(4),i=n(17),s=n(75),o=n(46),u=n(21),d=new o.a("getBlocklistReplyParser",e=>e.hasChild("error")&&404===e.child("error").attrInt("code")?{jids:[]}:{jids:e.child("query").child("list").mapChildrenWithTag("item",e=>e.attrPhoneUserJid("value"))});function c(){return(0,r.e)((0,a.v)("iq",{xmlns:"jabber:iq:privacy",type:"get",id:(0,a.t)()},(0,a.v)("query",null,(0,a.v)("list",{name:"default"}))),d).then(e=>{__LOG__(2)`getBlocklist from server ${e}`,e.success?(0,i.qc)((0,u.m)(e.result.jids)):404===e.errorCode&&(0,i.qc)((0,u.f)())})}t.default=(0,s.c)().finalStep("requestBlockList",c).end()},function(e,t,n){n.r(t),n.d(t,"getBlocklistV2",(function(){return m}));var r=n(28),a=n(4),i=n(75),s=n(46),o=n(21),u=n(17),d=n(31),c=n.n(d),l=n(6),p=n(83),h={400:(0,p.d)("bad-request"),500:(0,p.d)("internal-server-error")},f=new s.a("getBlocklistV2Parser",e=>{if(e.hasChild("list")){var t=e.child("list");return{type:"list",dhash:t.maybeAttrString("dhash"),list:(0,o.m)(t.mapChildrenWithTag("item",e=>e.attrPhoneUserJid("jid")))}}return{type:"hashMatched"}});function m(){return l.E.get().mdBlocklistV2||(__LOG__(2)`getBlocklistV2 requires md_blocklist_v2 server prop`,Promise.reject({error:{reason:"server-prop-disabled"}})),(0,u.A)().then(e=>{var t=(0,a.v)("iq",{xmlns:"blocklist",type:"get",to:a.k,id:(0,a.t)()},e?(0,a.v)("item",{dhash:(0,a.b)(e)}):null);return(0,r.e)(t,f).then(t=>{if(!t.success)return __LOG__(4)`getBlocklistV2 error with code ${t.errorCode}, text ${t.errorText}`,(0,p.f)(t,h);var n=t.result;switch(n.type){case"list":return(0,u.rc)(n.list,n.dhash,e).then(()=>({result:"success-new-list"}));case"hashMatched":return{result:"success-hash-matched"};default:return(0,c.a)(n.type),{error:{reason:"unknown"}}}})})}t.default=(0,i.c)().finalStep("getBlocklistV2",m).end()},,,,,,,,,,,,,,,,,,function(e,t,n){n.r(t);var r=n(52),a=n(7),i=n(399),s=lib_libsignal.libsignal.SessionStore;t.default=class extends s{constructor(e,t,n){super(e,t),this.FC=n}load(e){var t=(0,r.encodeAddress)(e);return this.FC.stores.sessions.get(t).then(e=>e?e.session:null)}get_sub_device_sessions(e){return this.FC.stores.sessions.where("jid").equals(e).toArray().then(e=>e.map(e=>e.deviceId))}store(e,t){var n=(0,r.encodeAddress)(e);return this.FC.stores.sessions.put({address:n,jid:e.name,deviceId:e.deviceId,session:(0,i.a)(t).session})}contains(e){var t=(0,r.encodeAddress)(e);return this.FC.stores.sessions.get(t).then(e=>!!e)}bulkGetJidsWithSessions(e){var t=e.map(e=>(0,r.encodeAddress)(e));return this.FC.stores.sessions.where("address").anyOf(t).toArray().then(e=>e.map(e=>(0,a.A)(e.jid,e.deviceId)))}delete(e){var t=e.map(e=>(0,r.encodeAddress)(e));return this.FC.stores.sessions.bulkDelete(t)}delete_all_sessions(e){return this.FC.stores.sessions.where("jid").equals(e).delete()}}},function(e,t,n){n.r(t);var r=n(9),a=n.n(r),i=n(52),s=n(5),o=n(71),u=n(3),d=n(157),c=(n(137),lib_libsignal.libsignal.PreKeyStore);function l(e,t){return(0,d.c)(e,t).then(e=>e.map(e=>{var t=e.plainObject,n=e.record;return{id:t.id,keyPair:t.keyPair,record:n}}))}t.default=class extends c{constructor(e,t,n){super(e,t),this.Dz=new o.a,this.Dy=n}EA(){return this.Dy.stores.meta.get(i.LATEST_PREKEY_ID).then(e=>e?e.value+1:1)}EB(){return this.Dy.stores.meta.get(i.EARLIEST_UNUPLOADED_PREKEY_ID).then(e=>e?e.value:null)}EC(){return this.Dy.stores.meta.get(i.LATEST_PREKEY_GENERATION).then(e=>e?e.value:0)}getAllPreKeyGenerations(){return this.Dy.stores.meta.get(i.PREKEY_GENERATIONS).then(e=>e?e.value:[])}generatePreKeys(e){return this.Dz.enqueue(()=>this.Dy.transact("r",["meta"],()=>(0,s.c)([this.EB(),this.EA(),this.EC(),this.getAllPreKeyGenerations()])).then(t=>{var n=a()(t,4),r=n[0],i=n[1],s=n[2],o=n[3],u=e-(null==r?0:i-r);if(!(u<=0))return __LOG__(2)`generatePreKeys must make ${u} keys (from ${i})`,l(i,u).then(e=>this.ED(e,null==r,s,o));__LOG__(2)`generatePreKeys all keys generated earlier`}))}ED(e,t,n,r){__LOG__(2)`PreKeyStore._putAll ${e.length} new keys`;var a=this.Dy;return a.transact("rw",["meta","preKeys"],()=>{if(0===e.length)return __LOG__(4)`_putAll given 0 keys`,(0,s.e)();var o=e.reduce((e,t)=>Math.max(e,t.id),0),d=e.reduce((e,t)=>Math.min(e,t.id),o),c={generation:n+1,firstPreKeyId:d,lastPreKeyId:o,timestamp:(0,u.E)()},l=[a.stores.meta.put({key:i.LATEST_PREKEY_ID,value:o}),a.stores.preKeys.bulkPut(e),a.stores.meta.put({key:i.PREKEY_GENERATIONS,value:r.concat(c)}),a.stores.meta.put({key:i.LATEST_PREKEY_GENERATION,value:c.generation})];if(t){var p=e.reduce((e,t)=>Math.min(e,t.id),e[0].id);l.push(a.stores.meta.put({key:i.EARLIEST_UNUPLOADED_PREKEY_ID,value:p}))}return(0,s.c)(l)})}allRemainingPreKeys(){return this.Dz.enqueue(()=>this.Dy.transact("r",["meta","preKeys"],()=>this.EB().then(e=>{if(null==e)throw new Error("allRemainingPreKeys no keys");return this.Dy.stores.preKeys.where("id").aboveOrEqual(e).toArray()}).then(e=>({preKeys:e,lastId:e.reduce((e,t)=>Math.max(e,t.id),0)}))))}markUploadedUpToKey(e){return this.Dz.enqueue(()=>this.Dy.transact("r",["meta"],()=>(0,s.c)([this.EB(),this.EA()])).then(t=>{var n=a()(t,2),r=n[0],o=n[1],u=e+1;return u>=o?(__LOG__(2)`markUploadedUpToKey all keys uploaded`,(0,s.i)(this.Dy.stores.meta.delete(i.EARLIEST_UNUPLOADED_PREKEY_ID))):null==r||u>=r?(__LOG__(2)`markUploadedUpToKey ${o-u} remaining`,(0,s.i)(this.Dy.stores.meta.put({key:i.EARLIEST_UNUPLOADED_PREKEY_ID,value:u}))):void __LOG__(4)`markUploadedUpToKey outdated id given ${e}`}))}loadFullKeys(e){return __LOG__(2)`PreKeyStore.loadFullKeys`,this.Dy.stores.preKeys.where("id").anyOf(e).toArray()}loadFullKey(e){return __LOG__(2)`PreKeyStore.loadFullKey ${e}`,this.Dy.stores.preKeys.get(e)}load(e){return this.loadFullKey(e).then(t=>t?(__LOG__(2)`PreKeyStore.load success ${e}`,t.record):void __LOG__(3)`PreKeyStore.load failure ${e}`)}contains(e){return __LOG__(2)`PreKeyStore.contains`,this.load(e).then(e=>!!e)}remove(e){return __LOG__(2)`PreKeyStore.remove`,this.Dy.stores.preKeys.delete(e)}unusedPreKey(){return this.Dz.enqueue(()=>this.Dy.transact("r",["meta"],()=>(0,s.c)([this.EB(),this.EA()])).then(e=>{var t=a()(e,2),n=t[0],r=t[1],o=this.Dy,u=["meta","preKeys"];return null!=n?o.transact("rw",u,()=>o.stores.preKeys.get(n).then(e=>{if(!e)throw __LOG__(4)`EARLIEST_UNUPLOADED_PREKEY_ID has incorrect value`,SEND_LOGS("incorrect-earliest-unuploaded-prekey-id"),new Error("EARLIEST_UNUPLOADED_PREKEY_ID has incorrect value");return(n+1<r?o.stores.meta.put({key:i.EARLIEST_UNUPLOADED_PREKEY_ID,value:n+1}):o.stores.meta.delete(i.EARLIEST_UNUPLOADED_PREKEY_ID)).then(()=>e)})):l(r,1).then(e=>{var t=a()(e,1)[0];return o.transact("rw",u,()=>(0,s.c)([o.stores.preKeys.put(t),o.stores.meta.put({key:i.LATEST_PREKEY_ID,value:r})])).then(()=>t)})}))}deletePreKeysBelowOrEqual(e){return this.Dz.enqueue(()=>this.Dy.transact("rw",["meta","preKeys"],()=>(0,s.c)([this.EB(),this.Dy.stores.preKeys.where("id").belowOrEqual(e).delete()]).then(t=>{var n=a()(t,1)[0];if(null!=n)return n<=e?this.Dy.stores.preKeys.orderBy("id").first().then(e=>{e?this.Dy.stores.meta.put({key:i.EARLIEST_UNUPLOADED_PREKEY_ID,value:e.id}):this.Dy.stores.meta.delete(i.EARLIEST_UNUPLOADED_PREKEY_ID)}):void 0})))}}},function(e,t,n){n.r(t);var r=n(52),a=n(5),i=lib_libsignal.libsignal.PreKeyStore;t.default=class extends i{constructor(e,t,n){super(e,t),this.EE=n}nextSignedPreKeyId(){return this.EE.stores.meta.get(r.LATEST_SIGNED_PREKEY_ID).then(e=>e?e.value+1:1)}loadLatestSignedPreKeyInTransaction(){return this.EE.stores.meta.get(r.LATEST_SIGNED_PREKEY_ID).then(e=>{if(!e)throw new Error("No SignedPreKey");var t=e.value;return this.loadFullKey(t).then(e=>{if(!e)throw new Error(`SignedPreKey ${t} gone`);return e})})}loadLatestSignedPreKey(){throw new Error("loadLatestSignedPreKey is not implemented for daemon-based signal")}hasSignedPreKeys(){return this.EE.stores.meta.get(r.LATEST_SIGNED_PREKEY_ID).then(e=>!!e)}putAll(e){var t=this.EE;return t.transact("rw",["meta","signedPreKeys"],()=>{var n=e.reduce((e,t)=>Math.max(e,t.id),0);return(0,a.c)([t.stores.meta.put({key:r.LATEST_SIGNED_PREKEY_ID,value:n}),t.stores.signedPreKeys.bulkPut(e)])})}putInTransaction(e){throw new Error("putInTransaction should only be used with new Signal implementation")}loadFullKey(e){return __LOG__(2)`SignedPreKeyStore.loadFullKey`,this.EE.stores.signedPreKeys.get(e)}load(e){return this.loadFullKey(e).then(e=>e?(__LOG__(2)`SignedPreKeyStore.load success`,e.record):void __LOG__(3)`SignedPreKeyStore.load failure`)}contains(e){return __LOG__(2)`SignedPreKeyStore.contains`,this.load(e).then(e=>!!e)}remove(e){return __LOG__(2)`SignedPreKeyStore.remove`,this.EE.stores.signedPreKeys.delete(e)}}},function(e,t,n){n.r(t);var r=n(52),a=lib_libsignal.libsignal.SenderKeyStore;t.default=class extends a{constructor(e,t,n){super(e,t),this.Dx=n}load(e){return this.Dx.stores.senderKeys.get((0,r.encodeSender)(e)).then(e=>e?(__LOG__(2)`SenderKeyStore.load success`,e.record):(__LOG__(2)`SenderKeyStore.load failure`,null))}store(e,t){return this.Dx.stores.senderKeys.put({id:(0,r.encodeSender)(e),context:e.groupId,sender:e.sender.name,deviceId:e.sender.deviceId,record:t})}delete(e){return this.Dx.stores.senderKeys.delete((0,r.encodeSender)(e))}}},,,function(e,t,n){n.r(t),n.d(t,"startInPageBackend",(function(){return V})),n.d(t,"startInWorkerBackend",(function(){return K}));var r=n(28),a=n(29),i=n(12),s=n(3),o=n(6),u=n(225),d=n(319),c=n(9),l=n.n(c),p=n(292),h=n(25),f=n(43),m=n(264),v=n(95),g=n(14),_=n(35),E=!1,b=n(90),y="https://v-k.whatsapp.net";function S(e,t,n,r,a){var i,u;__LOG__(2)`RegFlow.requestCode(${t})`;var d,c=e.getStore(),p=!1;switch(c.type){case"BAN_APPEAL":case"ENTERING_PHONE_NUMBER":case"CONFIRM_FOUND_PHONE_NUMBER":p=!0;break;case"REQUESTING_CODE":p=null==(d="sms"===a?null==(i=c.state)?void 0:i.smsWait:null==(u=c.state)?void 0:u.voiceWait)||!(0,s.p)(d)}if(p){"sms"===a?e.updateStore({type:"SENDING_SMS",country:t,localNumber:n,maskedPhoneNumber:r}):e.updateStore({type:"SENDING_VOICE"});var h=t.cc;return __LOG__(2)`setUser sending request`,(function(e,t,n,r){var a;a="sms"===r?e.startSmsListener():Promise.resolve();var i=t.cc;return __LOG__(2)`setUser sending request`,Promise.all([e.getToken(n),e.getSlowParams(),a]).then(e=>{var t=l()(e,2),a=t[0],s=t[1],u=o.h.get(),d=null!=u.lc?{lc:u.lc}:null,c=(0,_.c)(y,"/v2/code",Object.assign({cc:i,in:n,mcc:u.mcc,mnc:u.mnc,lg:u.lg,method:r,token:a,"x-whatsapp-ua":u.userAgent},d,s));return(0,_.k)(c).then(e=>e.json()).catch(()=>({status:"network_error"}))})})(e,t,n,a).then(i=>{switch(__LOG__(2)`reg result`,i.status){case"sent":return void(0,v.a)(5e3).then(()=>{var a=e.getStore();if("SENDING_SMS"===a.type||"SENDING_VOICE"===a.type){var o={type:"CODE_PENDING",method:i.method,smsWait:A(i.sms_wait),voiceWait:A(i.voice_wait),requestTime:(0,s.E)()};e.updateStore({type:"REQUESTING_CODE",country:t,localNumber:n,maskedPhoneNumber:r,state:o})}});case"ok":return __LOG__(2)`RegFlow.requestCode already done`,void e.finish(i);case"network_error":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:t,localNumber:n},state:{type:"CODE_REQUEST_ERROR",reason:"network_error",localNumber:n,cc:h}});case"fail":return void(function(e,t,n){var r=t.localNumber,a=t.country,i=t.method,o=t.maskedPhoneNumber,u=n.reason;if((0,b.b)(u))e.updateStore((0,b.a)(e,t,u,"CODE_REQUEST_ERROR",n.param));else switch(u){case"too_many_guesses":case"too_many_all_methods":var d=u;e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:a,localNumber:r},state:{type:"CODE_REQUEST_ERROR",reason:d,localNumber:r,cc:a.cc,retryAfter:A(n.retry_after)||void 0}});break;case"bad_token":return void e.updateStore({type:"BLOCKED",error:{reason:u,localNumber:r,cc:a.cc}});case"too_recent":case"too_many":case"temporarily_unavailable":case"next_method":case"provider_timeout":case"provider_unroutable":case"no_routes":var c={type:"CODE_REQUEST_ERROR",reason:u,retryAfter:A(n.retry_after),smsWait:A(n.sms_wait),voiceWait:A(n.voice_wait),method:i,localNumber:r,cc:a.cc,requestTime:(0,s.E)()};return void e.updateStore({type:"REQUESTING_CODE",country:a,localNumber:r,maskedPhoneNumber:o,state:c});default:__LOG__(4)`requestCode: Unexpected result reason ${u} `,e.updateStore((0,b.c)(r,a,"CODE_REQUEST_ERROR"))}})(e,{method:a,maskedPhoneNumber:r,country:t,localNumber:n},i);default:__LOG__(4)`requestCode: Unexpected result status ${i.status} `,i.status,e.updateStore((0,b.c)(n,t,"CODE_REQUEST_ERROR"))}})}__LOG__(4)`unexpected call to RegFlow.requestCode with store.type ${c.type}`}function I(e,t,n){__LOG__(2)`RegFlow.registerWithCode`;var r=e.getStoreInStates2(["REQUESTING_CODE","SENDING_SMS"]);if(r){var a=r.country,i=r.localNumber,s=r.maskedPhoneNumber,u=r.state,d=a.cc;return e.updateStore({type:"VERIFYING"}),(function(e,t,n,r,a){__LOG__(2)`RegFlow.register`;var i=t.cc;return e.getSlowParams().then(t=>{var s=o.h.get(),u=null!=s.lc?{lc:s.lc}:null,d=(0,_.c)(y,"/v2/register",Object.assign({cc:i,in:n,lg:s.lg,code:r.join(""),entered:a,"x-whatsapp-ua":s.userAgent},u,t));return e.stopSmsListener().then(e=>(0,_.k)(d)).then(e=>e.json()).catch(()=>({status:"network_error"}))})})(e,a,i,t,n).then(n=>{switch(n.status){case"ok":return __LOG__(2)`RegFlow: Registration success, ${n}`,void e.finish(n);case"network_error":return void e.updateStore({type:"REQUESTING_CODE",country:a,localNumber:i,maskedPhoneNumber:s,state:{type:"CODE_VERIFY_ERROR",reason:"network_error",retryAfter:null==u?void 0:u.retryAfter,smsWait:null==u?void 0:u.smsWait,voiceWait:null==u?void 0:u.voiceWait,code:t,localNumber:i,cc:d,requestTime:null==u?void 0:u.requestTime}});case"fail":return __LOG__(3)`RegFlow: Failed to register`,"security_code"===n.reason?void e.updateStore({type:"TWO_FACTOR",country:a,localNumber:i,code:t,state:{type:"TWO_FACTOR_PENDING",guessWait:A(n.guess_wait),emailWait:A(n.email_wait),wipeWait:A(n.wipe_wait),wipeType:n.wipe_type,wipeToken:n.wipe_token,guessesLeft:n.guesses_left}}):void(function(e,t,n){var r=t.code,a=t.localNumber,i=t.country,s=t.maskedPhoneNumber;if((0,b.b)(n.reason))e.updateStore((0,b.a)(e,t,n.reason,"CODE_VERIFY_ERROR",n.param));else{var o=n.reason;switch(o){case"too_many_guesses":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:i,localNumber:a},state:{type:"CODE_VERIFY_ERROR",reason:"too_many_guesses",localNumber:a,cc:i.cc,retryAfter:A(n.retry_after)||void 0}});case"missing":case"stale":case"guessed_too_fast":case"mismatch":case"temporarily_unavailable":var u,d,c,l={type:"CODE_VERIFY_ERROR",reason:o,code:r,localNumber:a,cc:i.cc,retryAfter:A(n.retry_after),smsWait:null==(u=t.prev)?void 0:u.smsWait,voiceWait:null==(d=t.prev)?void 0:d.voiceWait,requestTime:null==(c=t.prev)?void 0:c.requestTime};return void e.updateStore({type:"REQUESTING_CODE",country:i,localNumber:a,maskedPhoneNumber:s,state:l});default:__LOG__(4)`registerWithCode: Unexpected result reason ${o}`,e.updateStore((0,b.c)(a,i,"CODE_VERIFY_ERROR"))}}})(e,{code:t,maskedPhoneNumber:s,localNumber:i,country:a,prev:u},n);default:__LOG__(4)`registerWithCodeCode: Unexpected result status ${n.status}`,n.status,e.updateStore((0,b.c)(i,a,"CODE_VERIFY_ERROR"))}})}}function w(e,t,n,r){__LOG__(2)`RegFlow.security response ${t}`;var a=n.country,i=n.localNumber,s=n.code,o=n.state;switch(t.status){case"ok":return __LOG__(2)`RegFlow: two-factor auth success, ${t}`,r?(0,p.c)(r).then(()=>e.finish(t)):e.finish(t);case"sent":return void e.updateStore({type:"TWO_FACTOR",country:a,localNumber:i,code:s,state:{type:"TWO_FACTOR_ERROR",reason:"email_sent",guessWait:A(t.guess_wait),emailWait:A(t.email_wait),wipeWait:A(t.wipe_wait),wipeType:t.wipe_type,wipeToken:t.wipe_token,guessesLeft:t.guesses_left,localNumber:i,cc:a.cc}});case"network_error":return __LOG__(3)`RegFlow: Network error while verifying two-factor, ${t}`,void e.updateStore({type:"TWO_FACTOR",country:a,localNumber:i,code:s,state:{type:"TWO_FACTOR_ERROR",reason:"network_error",guessWait:o.guessWait,guessesLeft:o.guessesLeft,emailWait:o.emailWait,wipeWait:o.wipeWait,wipeType:o.wipeType,wipeToken:o.wipeToken,localNumber:i,cc:a.cc}});case"fail":var u=t.reason;if((0,b.b)(u))return void e.updateStore((0,b.a)(e,{localNumber:i,country:a},u,"TWO_FACTOR_ERROR",t.param));__LOG__(3)`RegFlow: Failed to verify two-factor`;var d={type:"TWO_FACTOR_ERROR",reason:u,guessWait:A(t.guess_wait),emailWait:A(t.email_wait),wipeWait:A(t.wipe_wait),wipeType:t.wipe_type,wipeToken:t.wipe_token,guessesLeft:t.guesses_left,localNumber:i,cc:a.cc};switch(u){case"guessed_too_fast":case"incorrect":case"mismatch":case"reset_too_soon":case"stale":case"temporarily_unavailable":case"too_many_guesses":return void e.updateStore({type:"TWO_FACTOR",country:a,localNumber:i,code:s,state:d});default:return __LOG__(4)`registerWithCode: Unexpected fail reason ${u}`,void e.updateStore(T(a,i,s,t))}default:__LOG__(4)`registerWithCode: Unexpected fail status ${t.status}`,t.status,e.updateStore(T(a,i,s,t))}}function T(e,t,n,r){return{type:"TWO_FACTOR",country:e,localNumber:t,code:n,state:{type:"TWO_FACTOR_ERROR",reason:"unknown",guessWait:A(r.guess_wait),emailWait:A(r.email_wait),wipeWait:A(r.wipe_wait),wipeType:r.wipe_type,wipeToken:r.wipe_token,guessesLeft:r.guesses_left,localNumber:t,cc:e.cc}}}function A(e){return null==e||-1===e?null:(0,s.l)(e)}var O=n(194),M=n(158);function C(e){return 6===e.filter(e=>null!=e&&e>-1&&e<10).length}var R,N=n(138),k=n(17),P=n(132),G=n(410),L=n(11),D=n(27),x=n.n(D),U=n(407),F=n(184),B=n(411),j={getPrimaryPlatform:()=>{},getSyncAction:(R=x()((function*(e){var t=yield(0,F.l)(e);return null==t?null:(0,U.b)(t)})),function(e){return R.apply(this,arguments)}),getSyncActionsByIndexMac:()=>Promise.resolve([]),getSyncActiveKey:()=>{throw Error("getSyncActiveKey is not implemented")},getSyncCollectionLtHash:()=>Promise.resolve(new ArrayBuffer(0)),getSyncCollectionVersion:()=>Promise.resolve(),getSyncCollectionVersionAndMutations:()=>Promise.resolve([void 0,[]]),getSyncCollectionsWithMutationsAndHash:()=>Promise.resolve([]),getSyncKeyData:e=>(0,B.b)(e)};function V(e,t,n,r){return(0,i.h)(!0),H(e,t,n,r)}function K(e,t){var n=(0,P.makeBridge)();return H(e,n,!1,t).then(()=>n)}function H(e,t,n,c){var p;switch(__LOG__(2)`startBackend invoked`,p={config:{},jidUtils:(0,L.o)({platform:"whatsapp"}),myJids:null,db:j},(0,G.b)(p),(0,i.f)(t),e.mode){case"main":return(0,s.A)(o.f.get()),(0,u.c)(t,n,c).then(()=>{(0,r.n)()});case"reg":(0,a.O)(),(function(e,t){var n=null,r=()=>(0,k.L)().then(N.c).then(t=>{n=null,e.fireAndForget("regPage","regEnded",{appInfo:t})});(0,u.a)(e),e.setHandlers("registration",{initReg(){n||(n=new d.a(e,r))},acceptRegAlert(){if(!n)throw new Error("acceptRegAlert without initReg");o.A.set(null)},goToWelcomeScreen(){if(!n)throw new Error("goToWelcomeScreen without initReg");var e;(e=n).getStoreInState("ENTERING_PHONE_NUMBER")&&e.updateStore({type:"UNINITIALIZED"})},acceptPolicy(e){var t=e.queryJioHeaders;if(!n)throw new Error("acceptPolicy without initReg");(function(e,t){if(e.getStoreInState("UNINITIALIZED")){E=!0;var n=()=>{e.updateStore({type:"ENTERING_PHONE_NUMBER"})};t?e.updateStore({type:"QUERYING_JIO_HEADERS"}).then(()=>{var t,r;"QUERYING_JIO_HEADERS"===e.getStore().type&&(t=(0,_.k)("https://kaios.whatsapp.net/static/v4/conf/prod/jioheaders.json").then(e=>e.json()).catch(()=>null).then(e=>{if(null!=e){var t=e.APIKey,n=e.DecryptionKeyEndpoint,r=e.APIEndpoint,a=e.WaitingTimeMs,i=e.MasterKeyId,s=e.TestMsisdn,o=e.TestMmeIP,u=e.TestImsi;if("string"!=typeof t)return __LOG__(4)`Jio headers configuration call: API key is not a string`,void SEND_LOGS("jio-phone-api-headers");if("string"!=typeof n)return __LOG__(4)`Jio headers configuration call: decryption key endpoint is not a string`,void SEND_LOGS("jio-phone-api-headers");if("string"!=typeof r)return __LOG__(4)`Jio headers configuration call: API endpoint key is not a string`,void SEND_LOGS("jio-phone-api-headers");if("string"!=typeof i)return __LOG__(4)`Jio headers configuration call: master key id is not a string`,void SEND_LOGS("jio-phone-api-headers");if("number"!=typeof a)return __LOG__(4)`Jio headers configuration call: waiting time is not a number`,void SEND_LOGS("jio-phone-api-headers");if(a<0)return __LOG__(4)`Jio headers configuration call: waiting time is lesser than zero`,void SEND_LOGS("jio-phone-api-headers");var d={apiKey:t,decryptionKeyEndpoint:n,apiEndpoint:r,masterKeyId:i,waitingTimeMs:a};return s&&o&&u&&(d.staging={msisdn:s,mmeIP:o,imsi:u}),d}__LOG__(4)`Jio headers configuration call failed`}),r=(0,v.a)(1500),Promise.race([t,r])).then(t=>{if("QUERYING_JIO_HEADERS"===e.getStore().type&&t)return(function(e){if(!E)return __LOG__(4)`findUserPhoneNumberViaJioHeaders called without accepting the terms`,SEND_LOGS("jio-headers-terms-not-accepted"),Promise.resolve();var t=(0,s.E)().toString(),n={"x-api-key":e.apiKey,version:"2",info:t},r=e.staging;r&&(n["x-msisdn"]=r.msisdn,n["x-mme-ip"]=r.mmeIP,n["x-imsi"]=r.imsi);var a=(0,_.j)(e.apiEndpoint,{responseType:"json",headers:n}).catch(()=>null).then(n=>{if(null!=n){var r=n.response,a=r.msisdn,i=r.unique1,s=r.unique2,o=r.unique3,u=r.unique4,d=r.signature1,c=r.signature2,l=r.info,p=r.maskedPhoneNumber;if(l===t)if("string"==typeof i)if("string"==typeof o)if(o.length>100)__LOG__(4)`Jio headers API call: sensitive mac salt is suspiciously long`;else if("string"==typeof s)if(s.length>100)__LOG__(4)`Jio headers API call: insensitive mac salt is suspiciously long`;else if("string"==typeof c)if(c.length>100)__LOG__(4)`Jio headers API call: sensitive mac is suspiciously long`;else if("string"==typeof a)if("string"==typeof p)if("string"==typeof d)if(d.length>100)__LOG__(4)`Jio headers API call: insensitive mac is suspiciously long`;else{var h;try{h=(0,f.b)(a)}catch(e){return void __LOG__(4)`Jio headers API call: msisdn is not a valid base64 string`}var m=h.byteLength;if(m<16)__LOG__(4)`Jio headers API call: msisdn is too short (${m})`;else{var v;try{v=(0,f.b)(u)}catch(e){return void __LOG__(4)`Jio headers API call: iv is not a valid base64 string`}var g=v.byteLength;if(!(g<16)){var E=new FormData;return E.append("pcdex",(function(e,t,n,r,a,i,s,o,u,d){return["pcdex",e,t,n,r,a,i,s,o,u,d].join("|")})(e.masterKeyId,i,t,p,s,d,u,a,o,c)),(0,_.k)(e.decryptionKeyEndpoint,{method:"POST",body:E}).then(e=>e.json()).then(e=>[e,h,v,p]).catch(()=>null)}__LOG__(4)`Jio headers API call: iv is too short (${g})`}}else __LOG__(4)`Jio headers API call: insensitive mac is not a string`;else __LOG__(4)`Jio headers API call: masked phone number is not a string`;else __LOG__(4)`Jio headers API call: msisdn is not a string`;else __LOG__(4)`Jio headers API call: sensitive mac is not a string`;else __LOG__(4)`Jio headers API call: insensitive mac salt is not a string`;else __LOG__(4)`Jio headers API call: sensitive mac salt is not a string`;else __LOG__(4)`Jio headers API call: encryption salt is not a string`;else __LOG__(4)`Jio headers API call: incorrect device verification info`}else __LOG__(4)`Jio headers API call failed`}).then(e=>{if(null!=e){var n=l()(e,4),r=n[0],a=n[1],i=n[2],s=n[3],o=r.DecryptionKey;if(r.Info===t)if("string"==typeof o){var u;try{u=new Uint8Array((0,f.b)(o))}catch(e){return void __LOG__(4)`Decryption Key API: failed to base64 decode the decryption key`}var d=u.byteLength;if(32===d){var c=new Uint8Array(i.slice(0,16)),p=new Uint8Array(a.slice(0,16));return(0,m.b)(u,c,p).then(e=>[h.a.build(e).readString(e.byteLength),s])}__LOG__(4)`Decryption Key API call: the decryption key has incorrect length: ${d}`}else __LOG__(4)`Decryption Key API call: decryption key is not a string`;else __LOG__(4)`Decryption Key API call: incorrect device verification info`}else __LOG__(4)`Decryption Key API call failed`}).then(e=>{if(null!=e){var t=l()(e,2),n=t[0],r=t[1];if(n.startsWith(g.o.cc))return[n.slice(g.o.cc.length),r];__LOG__(4)`Decrypted phone number does not start with INDIA prefix`}else __LOG__(4)`Decryption of phone number failed`}).catch(()=>{__LOG__(4)`Failed to decrypt phone number from JIO headers response`}),i=(0,v.a)(e.waitingTimeMs);return Promise.race([a,i])})(t)}).then(t=>{if("QUERYING_JIO_HEADERS"===e.getStore().type)if(t){var r=l()(t,2),a=r[0],i=r[1];e.updateStore({type:"CONFIRM_FOUND_PHONE_NUMBER",localNumber:a,maskedPhoneNumber:i,country:g.o})}else n()})}):n()}})(n,t)},rejectFoundPhoneNumber(){if(!n)throw new Error("rejectFoundPhoneNumber without initReg");var e;"CONFIRM_FOUND_PHONE_NUMBER"!==(e=n).getStore().type&&"QUERYING_JIO_HEADERS"!==e.getStore().type||e.updateStore({type:"ENTERING_PHONE_NUMBER"})},acceptFoundPhoneNumber(e){var t=e.country,r=e.localNumber,a=e.maskedPhoneNumber;if(!n)throw new Error("acceptFoundPhoneNumber without initReg");(function(e,t,n,r){"CONFIRM_FOUND_PHONE_NUMBER"===e.getStore().type&&S(e,t,n,r,"sms")})(n,t,r,a)},updateCountry(e){var t=e.country;if(!n)throw new Error("updateCountry without initReg");(function(e,t){var n=e.getStore();"COUNTRY_SELECT"===n.type&&e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:t,localNumber:n.localNumber}})})(n,t)},goToCountrySelect(e){var t,r,a,i,s=e.phoneNumber;if(!n)throw new Error("goToCountrySelect without initReg");r=s,"ENTERING_PHONE_NUMBER"===(i=(t=n).getStore()).type&&t.updateStore({type:"COUNTRY_SELECT",country:null==(a=i.prefill)?void 0:a.country,localNumber:r})},clearPhoneNumberStatus(){if(!n)throw new Error("clearPhoneNumberStatus without initReg");var e,t,r,a;"ENTERING_PHONE_NUMBER"===(a=(e=n).getStore()).type&&e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:null==(t=a.prefill)?void 0:t.country,localNumber:null==(r=a.prefill)?void 0:r.localNumber}})},goToEditPhoneNumber(){if(!n)throw new Error("goToEditPhoneNumber without initReg");(function(e){var t=e.getStore();if("COUNTRY_SELECT"===t.type)e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:t.country,localNumber:t.localNumber}});else if("REQUESTING_CODE"===t.type){var n=t.maskedPhoneNumber?"":t.localNumber;e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:t.country,localNumber:n}})}else if("BLOCKED"===t.type)e.updateStore({type:"ENTERING_PHONE_NUMBER"});else if("REQUESTING_CODE_BAN_APPEAL"===t.type){var r=t.country,a=t.localNumber;e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:r,localNumber:a}})}else"BLOCKED_BAN_APPEAL_PRE"===t.type||"BAN_APPEAL"===t.type||"BLOCKED_BAN_APPEAL"===t.type?e.updateStore({type:"ENTERING_PHONE_NUMBER"}):__LOG__(3)`Tried to go to edit phone number from unexpected screen ${t.type}`})(n)},verifyPhoneExists(e){var t=e.country,r=e.localNumber;if(!n)throw new Error("verifyPhoneExists without initReg");(function(e,t,n){var r=e.getStoreInState("ENTERING_PHONE_NUMBER");r?(function(e,t,n){return e.getSlowParams().then(e=>{__LOG__(2)`verifyPhoneExists sending exists request`;var r=o.h.get(),a=null!=r.lc?{lc:r.lc}:null,i=t.cc,s=(0,_.c)(y,"/v2/exist",Object.assign({cc:i,in:n,lg:r.lg,"x-whatsapp-ua":r.userAgent},a,e));return(0,_.k)(s).then(e=>e.json()).catch(e=>(__LOG__(4)`verifyPhoneExists fetch error`,{status:"network_error"}))})})(e,t,n).then(a=>{switch(a.status){case"ok":e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:t,localNumber:n},regExistResult:{result:"skip"}});break;case"network_error":e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:t,localNumber:n},regExistResult:{result:"error",reason:"network_error"}});break;case"fail":(function(e,t,n){var r=t.country,a=t.localNumber,i=n.reason;if("blocked"===n.reason&&n.in_app_ban_appeal&&n.in_app_ban_appeal>0)e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:r,localNumber:a},regExistResult:{result:"banned"}});else if((0,b.b)(i))e.updateStore((0,b.a)(e,t,i,"EXISTS_ERROR",n.param));else switch(i){case"incorrect":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:r,localNumber:a},regExistResult:{result:"code"}});case"length_long":case"length_short":case"format_wrong":case"temporarily_unavailable":return void e.updateStore({type:"ENTERING_PHONE_NUMBER",prefill:{country:r,localNumber:a},regExistResult:{result:"error",reason:i,retryAfter:A(n.retry_after)||void 0}});default:__LOG__(4)`verifyPhoneExists: Unexpected result reason ${i}`,e.updateStore((0,b.c)(a,r,"EXISTS_ERROR"))}})(e,{country:t,localNumber:n,store:r},a);break;default:__LOG__(4)`verifyPhoneExists: Unexpected result status ${a.status}`,a.status,e.updateStore((0,b.c)(n,t,"EXISTS_ERROR"))}}):Promise.resolve()})(n,t,r)},requestCode(e){var t=e.country,r=e.localNumber,a=e.maskedPhoneNumber,i=e.method;if(!n)throw new Error("requestCode without initReg");S(n,t,r,a,i)},registerWithCode(e){var t=e.code;if(!C(t))throw new Error("registerWithCode called with fewer than 6 single digits");if(!n)throw new Error("registerWithCode without initReg");I(n,t,O.b)},verifyTwoFactor(e){var t=e.pin;if(!n)throw new Error("verifyTwoFactor without initReg");(function(e,t){__LOG__(2)`RegFlow.verifyTwoFactor`;var n=e.getStore();if("TWO_FACTOR"===n.type){var r=n.country,a=n.localNumber;e.updateStore({type:"VERIFYING"}),(function(e,t,n,r){return __LOG__(2)`RegFlow.verifyTwoFactor`,e.getSlowParams().then(e=>{var a=o.h.get(),i=t.cc,s=(0,_.c)(y,"/v2/security",Object.assign({cc:i,in:n,code:r.join(""),"x-whatsapp-ua":a.userAgent},e));return(0,_.k)(s).then(e=>e.json()).catch(()=>({status:"network_error"}))})})(e,r,a,t).then(r=>w(e,r,n,t))}})(n,t)},sendForgotPINEmail(){if(!n)throw new Error("sendForgotPINEmail without initReg");(function(e){__LOG__(2)`RegFlow.sendForgotPINEmail`;var t=e.getStore();if("TWO_FACTOR"===t.type){var n=t.country,r=t.localNumber;e.updateStore({type:"SENDING_EMAIL"}),(function(e,t,n){return __LOG__(2)`RegFlow.sendForgotPINEmail`,e.getSlowParams().then(e=>{var r=t.cc,a=o.h.get(),i=(0,_.c)(y,"/v2/security",Object.assign({cc:r,in:n,reset:"email","x-whatsapp-ua":a.userAgent},e));return(0,_.k)(i).then(e=>e.json()).catch(()=>({status:"network_error"}))})})(e,n,r).then(n=>w(e,n,t))}})(n)},resetAccount(e){var t=e.token;if(!n)throw new Error("sendForgotPINEmail without initReg");(function(e,t){__LOG__(2)`RegFlow.resetAccount`;var n=e.getStoreInState("TWO_FACTOR");if(n){var r=n.country,a=n.localNumber;e.updateStore({type:"RESETTING"}),(function(e,t,n,r){return e.getSlowParams().then(e=>{var a=o.h.get(),i=t.cc,s=(0,_.c)(y,"/v2/security",Object.assign({cc:i,in:n,reset:"wipe",wipe_token:r,"x-whatsapp-ua":a.userAgent},e));return(0,_.k)(s).then(e=>e.json()).catch(()=>({status:"network_error"}))})})(e,r,a,t).then(t=>w(e,t,n))}})(n,t)},smsCodeDetected(e){var t=e.code;if(n){var r=n,a=r.getStore();"REQUESTING_CODE_BAN_APPEAL"===a.type||"SENDING_SMS_BAN_APPEAL"===a.type?(0,M.g)(r,t,O.a):I(r,t,O.a)}},requestCodeBanAppeal(e){var t=e.country,r=e.localNumber,a=e.method,i=e.banInfo;n&&(0,M.e)(n,t,r,a,i)},registerWithCodeBanAppeal(e){var t=e.code;if(!C(t))throw new Error("registerWithCodeBanAppeal called with fewer than 6 single digits");n&&(0,M.g)(n,t,O.b)},fetchBanAppealStatus(){n&&(0,M.b)(n)},submitBanAppeal(e){var t=e.content;if(n)return(0,M.f)(n,t)},goToBanAppealBlocked(e){var t=e.content;if(n)return(0,M.d)(n,t)},goToBanAppeal(){if(n)return(0,M.c)(n)},clearBanAppealErrorStatus(){if(n)return(0,M.a)(n)}}),e.fireAndForget("regPage","initPushEndpoint",{}),e.setNamespaceHandler("backend",(e,t,r)=>{var a;n&&"receivedPush"===e&&(a=(0,M.b)(n)),r&&r(a)})})(t);break;case"deleting":(0,u.b)(t);break;default:e.mode}return Promise.resolve()}},,,function(e,t,n){n.r(t);var r=n(52),a=n(12),i=n(124),s=n(30),o=n(16),u=n(71),d=n(5),c=n(6),l=n(11),p=n(25),h=lib_libsignal.libsignal.IdentityKeyStore;t.default=class extends h{constructor(e,t,n){super(e,t),this.FE=new u.a,this.FD=n}get_key_pair(){return this.FD.getMyStaticKeyPair()}get_local_registration_id(){return this.FD.getMyRegId()}FF(){return this.FD.stores.meta.get(r.LATEST_IDENTITY_ID).then(e=>e?e.value+1:1)}save_identity(e,t,n){var u=33===t.length;u&&5!==t[0]&&(__LOG__(4)`IdentityKeyStore unknown key type ${t[0]}`,SEND_LOGS("signal-unknown-key-type"));var h=u?t:p.a.build(5,t).readByteArray(),f=e.deviceId===l.c;return this.FE.enqueue(()=>{var t=(0,r.encodeAddress)(e);return(0,d.i)(this.FD.stores.identities.get(t)).then(t=>{if(!f){if(n)return!t||!(0,i.c)(t.identity,h);if(t&&(0,i.c)(t.identity,h))return!1;throw new Error("Signal tried to override existing identity for companion device")}return t&&!(0,i.c)(t.identity,h)?((0,a.c)("event","identityVerificationChanged",{jid:e.name}),(0,s.b)().waitUntilPersisted(o.e.saveKeyChange(e.name,h,c.M.get())).then(()=>!0)):!t}).then(a=>{if(a)return this.FD.transact("rw",["meta","identities"],()=>this.FF().then(a=>{var i={address:t,jid:e.name,deviceId:e.deviceId,identityId:a,identity:h};if(n){var s=n.rawId,o=n.keyIndex;i=Object.assign({},i,{rawId:s,keyIndex:o})}return(0,d.c)([this.FD.stores.identities.put(i),this.FD.stores.meta.put({key:r.LATEST_IDENTITY_ID,value:a})])}))})}).then(()=>{})}is_trusted_identity(e,t){return Promise.resolve(!0)}getPublicKey(e){return this.FE.enqueue(()=>{var t=(0,r.encodeAddress)(e);return(0,d.i)(this.FD.stores.identities.get(t)).then(e=>e?e.identity:null)})}getPublicKeys(e){return this.FE.enqueue(()=>{var t=e.map(r.encodeAddress);return(0,d.i)(this.FD.stores.identities.where("address").anyOf(t).toArray()).then(e=>e.map(e=>({jid:e.jid,deviceId:e.deviceId,publicKey:e.identity})))})}getIdentityId(e){return this.FE.enqueue(()=>{var t=(0,r.encodeAddress)(e);return(0,d.i)(this.FD.stores.identities.get(t)).then(e=>e?e.identityId:null)})}getKnownIdentityIds(e){return this.FE.enqueue(()=>{var t=e.map(r.encodeAddress);return(0,d.i)(this.FD.stores.identities.where("address").anyOf(t).toArray()).then(e=>{var t=[];return e.forEach(e=>{var n=e.jid,r=e.deviceId,a=e.identityId;null!=a&&t.push({jid:n,deviceId:r,identityId:a})}),t})})}}}]]);